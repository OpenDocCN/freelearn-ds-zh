<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="en-US">
<head>
<meta charset="utf-8"/>
<meta name="generator" content="packt"/>
<title>2 Configuring R with Power BI</title>



</head>
<body>


<h1 data-number="3">2 Configuring R with Power BI</h1>
<p>Power BI Desktop is not equipped with the analytical language engines presented in the previous chapter by default. Therefore, it is necessary to install these engines and properly configure Power BI Desktop to correctly interface with them. It is also recommended to install an <strong>Integrated Development Environment</strong> (<strong>IDE</strong>), enabling you to work in the way you are most comfortable.</p>
<p>We’ll look at how to get those engines up and running and give you some general guidelines on how to pick the most appropriate one for your needs. After that, we'll look at how to make these engines interface with both Power BI Desktop and the Power BI service.</p>
<p>Finally, we will give some important tips on how to overcome some stringent limitations of R visuals on the Power BI service.</p>
<p>In particular, this chapter will deal in detail with the following topics:</p>
<ul>
<li>The available R engines</li>
<li>Choosing an R engine to install</li>
<li>Installing an IDE for R development</li>
<li>Configuring Power BI Desktop to work with R</li>
<li>Configuring the Power BI service to work with R</li>
<li>Limitations of R visuals</li>
</ul>

<h2 data-number="3.1">Technical requirements</h2>
<p>This chapter requires you to have a working internet connection and <strong>Power BI Desktop</strong> already installed on your machine. It also requires you to have signed up for the Power BI service in the last part of the chapter (here’s a how-to: <a href="http://bit.ly/signup-powerbiservice">http://bit.ly/signup-powerbiservice</a>). A <strong>Power BI free</strong> license is enough to test all the code in this book, as you will share reports only in your personal <strong>workspace</strong>.</p>


<h2 data-number="3.2">The available R engines</h2>
<p>There is more than one R distribution available on the market that you can use for free for your advanced analytics projects. In this section, we'll explore the main details of each of them.</p>

<h3 data-number="3.2.1">The CRAN R distribution</h3>
<p>When it comes to installing the R engine, we almost always think of the open source software environment <em>par excellence</em>, developed by a collective of contributors over the years, known as <strong>CRAN R</strong>, also called <strong>base R</strong> (<a href="https://cran.r-project.org">https://cran.r-project.org</a>). To be exact, the <strong>Comprehensive R Archive Network</strong> (<strong>CRAN</strong>) is a network of web servers and FTP servers around the world, whose goal is to preserve multiple identical and up-to-date versions of the R source code and the entire ecosystem of R packages developed by the community, along with all the R documentation.</p>
<p>One of the biggest advantages of CRAN R is its very active community of developers. Their contribution to the creation of new packages on CRAN is invaluable. That's why if you think you need a particular feature to process your data, it's almost certain that it has already been developed by the R community and released as a free usable R package.</p>
<p>However, not everyone knows that CRAN R is not the only R distribution available on the market.</p>


<h3 data-number="3.2.2">The Microsoft R Open distribution and MRAN</h3>
<p>Even Microsoft has contributed to the community by releasing its own open source R "distro" for both Windows and Linux, under the terms of the <em>General Public License version 2</em>. Starting from 2016, Microsoft has released its own distributions of R, called <strong>Microsoft R Open</strong> (<strong>MRO</strong>) and sometimes referred to simply as <strong>Microsoft R</strong>, which reflects the same versions released by CRAN R and is 100% compatible with it.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>If you take any code written in CRAN R, using any CRAN package, and run it with the same version of the MRO engine, everything will work fine.</p>
</blockquote>
<p>In addition, there are only a few Microsoft-owned functions (including <strong>RevoUtils</strong> and <strong>RevoUtilsMath</strong>) that return information about the engine installation (such as path and memory usage) and the maximum number of threads that the <strong>Math Kernel Library</strong> (<strong>MKL</strong>) can run.</p>
<p>The benefit of the MRO release was that it brought important improvements for the R community:</p>
<ul>
<li>The multi-threaded <strong>Intel MKL</strong> included out of the box</li>
<li>A high-performance mirror of the CRAN repository, called <strong>Microsoft R Application Network</strong> (<strong>MRAN</strong>, <a href="https://mran.microsoft.com">https://mran.microsoft.com</a>), that gives you a “time machine” tool to get a snapshot of CRAN packages at the selected time</li>
</ul>
<p>Let's see in detail what they are.</p>

<h4 data-number="3.2.2.1">Multi-threading in MRO</h4>
<p>Although CRAN R was created as single-threaded, it has the ability to link to the multi-threaded <strong>Basic Linear Algebra Subprograms</strong> (<strong>BLAS</strong>) and <strong>Linear Algebra Package</strong> (<strong>LAPACK</strong>) libraries too, but these are not straightforward activities to do manually.</p>
<p>Installing MRO offers the advantage of having the engine already preconfigured and optimized for Intel processors thanks to MKL, with the purpose of performing mathematical calculations in parallel. To get an idea of the gain in computational time, take a look at the benchmark results obtained comparing R-3.4.1 and MRO 3.4.1 in <em>Figure 2.1</em> (source:<a href="http://bit.ly/msropen-bnchmrk">http://bit.ly/msropen-bnchmrk</a>):</p>
<figure>
<img src="img/file16.png" alt="Figure 2.1 – Total elapsed time for each of the benchmark tests on the same machine" /><figcaption aria-hidden="true">Figure 2.1 – Total elapsed time for each of the benchmark tests on the same machine</figcaption>
</figure>
<p>As you can easily see, the time taken by CRAN R (installed as-is without linking the BLAS libraries) in the matrix calculation is significantly higher than that taken by MRO. It is therefore strongly recommended to use MRO if you make heavy use of math routines for data science, engineering, financial analysis, and so on.</p>


<h4 data-number="3.2.2.2">Reproducing results with checkpoints</h4>
<p>When performing complex analyses using R, it is very likely that the resulting script is based on one or more CRAN packages. One of the most common problems in R is the reproducibility of results, because packages on CRAN change every day. So, it can happen that suddenly a script that was working fine a few weeks ago strarts to generate errors never seen before after you update the packages, or when you run it on another machine. Even more insidious is the possibility of getting incorrect results without realizing it, again due to a package update.</p>
<p>For this reason, starting in September 2014, Microsoft put up its own distribution of CRAN's R packages organized into daily snapshots of the entire repository, taken by the <strong>checkpoint server</strong> at midnight UTC and persisted on MRAN:</p>
<figure>
<img src="img/file17.png" alt="Figure 2.2 – The process of persisting a daily snapshot of CRAN in MRAN" /><figcaption aria-hidden="true">Figure 2.2 – The process of persisting a daily snapshot of CRAN in MRAN</figcaption>
</figure>
<p>From that point on, the R community had the ability to access a specific snapshot of CRAN packages with their versions frozen to a specific date.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>It is not necessary to use MRO to benefit from the free service offered by the checkpoint server. CRAN R users can also use it.</p>
</blockquote>
<p>Usually, when you invoke <code>install.packages</code> to install one or more packages in R, the latest CRAN version of each specified package is installed. Using the <code>checkpoint</code> package, you have the ability to reference a specific snapshot of the CRAN repository on a specific day in the past, as follows:</p>
<pre><code>library(checkpoint)
checkpoint(&quot;YYYY-MM-DD&quot;) # Replace the data you want here
install.packages(&quot;dplyr&quot;)</code></pre>
<p>With the preceding code example, both you and any other user are sure to always use the same version of the <code>dplyr</code> package downloaded from the CRAN repository snapshot you want to use.</p>
<p>The MRO installation includes the <code>checkpoint</code> package and by default sets the snapshot date as equal to the release date of the MRO version you are installing. You can easily verify the snapshot date that is set by the specific version of MRO in the <strong>CRAN Time Machine</strong> tool available on the MRAN portal (<a href="https://mran.microsoft.com/timemachine">https://mran.microsoft.com/timemachine</a>):</p>
<figure>
<img src="img/file18.png" alt="Figure 2.3 – The process of persisting a daily snapshot of CRAN in MRAN" /><figcaption aria-hidden="true">Figure 2.3 – The process of persisting a daily snapshot of CRAN in MRAN</figcaption>
</figure>
<p>You can also check the default package repository programmatically in the following way:</p>
<pre><code>getOption(&quot;repos&quot;)</code></pre>
<p>And you’ll get something like this as output:</p>
<pre><code>                                            CRAN 
&quot;https://mran.microsoft.com/snapshot/2020-07-16&quot;</code></pre>
<p>With this example code, if you install any R package, the versions installed will be those that were present in CRAN at midnight on July 16, 2020.</p>



<h3 data-number="3.2.3">Microsoft R Client</h3>
<p>Microsoft has also released another distribution of R, available for free for Windows and Linux, called <strong>Microsoft R Client</strong>. This distribution is entirely based on MRO, allowing you to run any code that works on CRAN R. In addition, there are some of Microsoft's R function libraries (<a href="http://bit.ly/ml-r-funcions">http://bit.ly/ml-r-funcions</a>) that are not open sourced. These functions are multi-threaded and allow you to work even with datasets that normally could not be contained in the memory of the machine with Microsoft’s on-premises products (<strong>SQL Server</strong> and <strong>Machine Learning Server</strong>). Yes, that’s right: in case you didn't know, Microsoft's <strong>Relational Database Management System</strong> (<strong>RDBMS</strong>), SQL Server, lets you use R, Python, and Java code in its stored procedures. So, if your data source is SQL Server itself and you need to extract insights from the data that are persisted there, consider also the possibility of applying Advanced Analytics algorithms directly using stored procedures in SQL Server, embedding R and Python code within them.</p>
<p>Using Microsoft R Client, it is possible to delegate algorithms that require non-trivial computational complexity to SQL Server or Machine Learning Server thanks to the performant <strong>MicrosoftML</strong> and <strong>RevoScale</strong> packages mentioned previously.</p>
<p>Unlike MRO, Microsoft R Client is not updated in parallel with each individual CRAN R release, but follows the MRO releases included at the time of Machine Learning Server releases. For example, as of today, CRAN R is at version 4.0.2, and MRO is at version 4.0.2 too, whereas Microsoft R Client is at version 3.5.2, which is the one supported by Machine Learning Server 9.4.</p>
<p>Having described the main features of the most popular R distributions, let's move on to the selection of the engine to be installed on your machine.</p>



<h2 data-number="3.3">Choosing an R engine to install</h2>
<p>The first question when installing an R engine is, <em>"Which distribution should I install? Do I choose the standard CRAN R, or do I opt for any Microsoft R distribution?"</em> The usual answer to these kinds of questions is, <em>"It depends!"</em> In our case, the goal is to use the R engine within Power BI, so we need to understand which engines are used by the different products that permit the use of R within them.</p>

<h3 data-number="3.3.1">The R engines used by Power BI</h3>
<p>We saw in <em>Chapter 1,</em> <em>Where and How to Use R and Python Scripts in Power BI,</em> that only two Power BI products are allowed to use scripts in R and Python: Power BI Desktop and the Power BI service (remember that Power BI Embedded is implicitly included when talking about the Power BI service). So, the answer <em>"It depends!"</em> takes on a clearer connotation now: if you need to share your reports with people inside your organization, then you have to install the engines that work well with the Power BI service; if, instead, you need to create reports for your own use, without even publishing it on <strong>My Workspace</strong>, you can install the engines suitable for Power BI Desktop.</p>
<p>There is a substantial difference in the use of analytic engines by these two products. <strong>Power BI Desktop</strong> relies on the R engine installed by the user on the same machine on which Power BI Desktop is running. It is the user who chooses which version of the engines and which packages to install. Power BI Desktop simply ensures that any R code entered through its interface runs directly on that engine.</p>
<p>The <strong>Power BI service</strong> is the <strong>Software-as-a-Service</strong> (<strong>SaaS</strong>) product among those covered by Power BI. The user doesn’t have to take on the maintenance of its underlying IT infrastructure, and nor can the user decide to install components on it at will.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>The R engine and the packages used by the Power BI service for <strong>R visuals</strong> are preinstalled on the cloud and therefore the user must adapt to the versions adopted by the service.</p>
</blockquote>
<p>It is also important to know exactly which R distribution is used by the R visuals in the Power BI service.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>To date, the Power BI service relies on the <strong>MRO 3.4.4</strong> runtime when implementing an R visual. It is important to always keep an eye on the version of the R engine and the packages provided by the Power BI service with each release to ensure that the reports to be published work properly. See the following link for more information: <a href="http://bit.ly/powerbi-r-limits">http://bit.ly/powerbi-r-limits</a>.</p>
</blockquote>
<p>If, instead, you have to do data ingestion or data transformation using R scripts and you need to refresh your data, the Power BI service does not use the same engine for R visuals in this case.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>The R engine used by the Power BI service during the data refresh phase for <em>R scripts in Power Query</em> has to be installed on any machine of your choice outside the service, and on that same machine you have to install the <strong>on-premises data gateway</strong> in <strong>personal mode</strong>. Note that you must use external engines even if the data to be refreshed does not flow through the gateway, but comes from data sources not referenced by the gateway itself.</p>
</blockquote>
<p>As long as the R engine to be referenced via the data gateway is only one, it is sufficient that both are installed on the same machine. Otherwise, the following note applies.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>If you need to <em>use multiple R engines</em> installed on the machine for your Power Query transformations, you must <em>also install Power BI Desktop</em>. It allows you to switch the routing of the data gateway to the selected engine through its options, updating the configuration file <code>C:\Users\&lt;your-username&gt;\AppData\Local\PowerBIScripting\RSettings.xml</code>. This file allows the override of the R engine referenced by the data gateway by default.</p>
</blockquote>
<p>If you need to learn more about the on-premises data gateway (<em>Enterprise</em> and <em>personal</em> modes), we suggest reading the Microsoft Docs page at this link: <a href="http://bit.ly/onprem-data-gateway">http://bit.ly/onprem-data-gateway</a>.</p>
<p>In summary, with the preceding scenarios in mind, if you need to do reports for personal use on your desktop, you have no limitations on which R engine to use, so you can install the R versions and packages that suit you best. If, however, you know in advance that the reports you are going to create contain R visuals and are intended to be shared with colleagues on the Power BI service, there are stringent limitations on both the version and the packages to be pre-installed in the service.</p>
<p>Let's now move on to the installation of the engines.</p>


<h3 data-number="3.3.2">Installing the suggested R engines</h3>
<p>Managing dependencies of R scripts injected within reports developed for the Power BI service can be complex in the long run. Keeping in mind that it is possible to install more than one R engine on the same machine, we suggest the following tip.</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>We recommend that you <em>dedicate a machine</em> to run only the R engines used by Power BI reports. Our suggestion is to install an R engine for each possible need that may arise when developing R scripts in Power Query or in R visuals.</p>
</blockquote>

<h4 data-number="3.3.2.1">The R engine for data transformation</h4>
<p>You have seen that R scripts used in Power Query to make changes to the data model must necessarily use an external R engine through the on-premises data gateway in personal mode, even if you use the Power BI service.</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>We recommend installing the latest available version of either CRAN R or MRO. Since both distributions are interchangeable in terms of code operation given the same version, in our opinion it is better to install <em>MRO</em> to benefit from the performance advantages of the MKL library.</p>
</blockquote>
<p>Installing MRO is very simple:</p>
<ol>
<li>Go to <a href="https://mran.microsoft.com/download">https://mran.microsoft.com/download</a>.</li>
<li><p>Click on the <strong>Download</strong> button corresponding to your OS. In my case, this is Windows:</p>
<figure>
<img src="img/file19.png" alt="Figure 2.4 – Downloading MRO for Windows" /><figcaption aria-hidden="true">Figure 2.4 – Downloading MRO for Windows</figcaption>
</figure></li>
<li>Once the <code>microsoft-r-open-x.x.x.exe</code> file (where <code>x.x.x</code> corresponds to the actual version chosen) is downloaded, double-click on it and then click on <strong>Continue</strong> on the <strong>Let’s get started</strong> window that pops up.</li>
<li><p>The next screen, <strong>Configure the installation</strong>, asks you to confirm or change the installation path, as well as select some installation options:</p>
<figure>
<img src="img/file20.png" alt="Figure 2.5 – MRO installation options" /><figcaption aria-hidden="true">Figure 2.5 – MRO installation options</figcaption>
</figure>
<p>The only optional choice is to install <strong>MKL</strong>. For reasons you know well by now, we suggest installing it. Then click on <strong>Continue</strong>.</p></li>
<li>In the next window, you can read the Microsoft license agreement to install MRO. After checking <strong>I acknowledge the above licensing information</strong>, <strong></strong> click on <strong>Continue</strong>.</li>
<li>Similarly, in the next window you can read the license agreement for MKL. After ticking <strong>I accept these terms</strong>, click on <strong>Continue</strong>.</li>
<li>A summary window now appears asking you to click on <strong>Install</strong> to begin installing MRO.</li>
<li>At the end of the installation, an <strong>All done</strong> window will inform you that the installation was completed successfully.</li>
</ol>
<p>And that’s it! You are now ready to be able to write and run your R code on MRO.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>Usually, the Power BI Desktop installation on which you develop reports is located on a separate machine from the one selected as the Power BI service’s R engine machine, where the data gateway is also often installed. In that case, you must also install the R engine on the machine on which your Power BI Desktop instance is installed.</p>
</blockquote>
<p>If you want, you can already write code on the very rudimentary GUI installed by default with MRO:</p>
<figure>
<img src="img/file21.png" alt="Figure 2.6 – The rGUI installed by MRO" /><figcaption aria-hidden="true">Figure 2.6 – The rGUI installed by MRO</figcaption>
</figure>
<p>We’ll see later in this chapter how to install the IDE preferred by all R developers: <strong>RStudio</strong>.</p>


<h4 data-number="3.3.2.2">The R engine for R visuals on the Power BI service</h4>
<p>As previously mentioned, R visual scripts published on the Power BI service run on a pre-installed R engine on the cloud, the version of which may change based on new releases of the Power BI service itself. Should you need to share a report containing an R visual with colleagues, you need to be sure that your R code works correctly on the pre-installed engine.</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>We strongly recommend that you also install on your machine the <em>same version</em> of MRO as that used for R visuals by the Power BI service.</p>
</blockquote>
<p>In order to install the same version of MRO provided by the Power BI service, the process is very simple:</p>
<ol>
<li><p>Go to <a href="http://bit.ly/powerbi-r-limits">http://bit.ly/powerbi-r-limits</a> and check the actual version of MRO used by the Power BI service:</p>
<figure>
<img src="img/file22.png" alt="Figure 2.7 – The actual MRO version used by the Power BI service" /><figcaption aria-hidden="true">Figure 2.7 – The actual MRO version used by the Power BI service</figcaption>
</figure></li>
<li><p>Then go to <a href="https://mran.microsoft.com/release-history">https://mran.microsoft.com/release-history</a> and check for the same MRO version you saw in <em>step 1</em> (in our case, <strong>3.4.4</strong>):</p>
<figure>
<img src="img/file23.png" alt="Figure 2.8 – Downloading the selected MRO version" /><figcaption aria-hidden="true">Figure 2.8 – Downloading the selected MRO version</figcaption>
</figure></li>
<li>After downloading the executable, simply follow the steps outlined in the previous section to install this specific version of the MRO engine.</li>
</ol>


<h4 data-number="3.3.2.3">What to do when the Power BI service upgrades the R engine</h4>
<p>It may happen that you have already installed a version of MRO specifically to be aligned with the R visual engine on the Power BI service at a certain date, and after a while Microsoft updates the Power BI service, also upgrading the pre-installed R engine. This scenario causes two separate events:</p>
<ul>
<li>The R engine is more up to date than its predecessor and may contain breaking changes that could make previously developed reports unusable. This is a very rare eventuality, since very often such changes are mitigated by the introduction of “deprecated” functions or parameters, thus ensuring backward compatibility.</li>
<li>Many of the packages installed on the release date of the previous R engine will be updated to a later version, corresponding to the release date of the new version of the R engine. Updating a package to a newer version is one of the most frequent causes of errors due to the incompatibility of a script written for the previous version of the package.</li>
</ul>
<p>In this case, you should verify that all of your reports that have R visuals and are published to the Power BI service also work with the updates made to the service.</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>In light of the preceding observations, and considering the fact that the pre-installed R engine of the Power BI service is very rarely updated, it is better to directly install the new version of MRO on your machine and test your reports making sure that Power BI Desktop references the new version of the engine. You need to fix any code issue in those R visuals that have some problems, after which you can publish those reports back to the Power BI service.</p>
</blockquote>
<p>Once you’ve made sure that all of the preceding reports are working properly, it’s up to you to decide whether you want to uninstall the previous version of MRO to free up disk space and to avoid confusion in handling these particular reports.</p>
<p>At this point we can move on to install an IDE that has more features than the rGUI installed by default by MRO.</p>




<h2 data-number="3.4">Installing an IDE for R development</h2>
<p>The need to install a state-of-the-art IDE for the development of code in Power BI comes from the need to have all the tools necessary to identify any bugs and to quickly test the results of code chunks on the fly.</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>It is strongly suggested to test your R code in the IDE and verify the results before using it in Power BI.</p>
</blockquote>
<p>There are many IDEs for R development on the market. Some examples are <strong>R-Brain IDE</strong> (<strong>RIDE</strong>), <strong>IntelliJ IDEA</strong>, and <strong>Jupyter Lab</strong>, but it is estimated that over 90% of R programmers use <strong>RStudio</strong> as their primary IDE. That’s why we suggest you also use this IDE to test the code you’ll encounter throughout this book.</p>

<h3 data-number="3.4.1">Installing RStudio</h3>
<p>Installing RStudio on your machine is very simple:</p>
<ol>
<li><p>Go to <a href="https://rstudio.com/products/rstudio/download/">https://rstudio.com/products/rstudio/download/</a> and click on <strong>Download</strong> under the <strong>RStudio Desktop</strong> column:</p>
<figure>
<img src="img/file24.png" alt="Figure 2.9 – Go to the Download page of RStudio" /><figcaption aria-hidden="true">Figure 2.9 – Go to the Download page of RStudio</figcaption>
</figure></li>
<li><p>Then click on the <strong>Download RStudio for Windows</strong> button:</p>
<figure>
<img src="img/file25.png" alt="Figure 2.10 – Download RStudio for Windows" /><figcaption aria-hidden="true">Figure 2.10 – Download RStudio for Windows</figcaption>
</figure></li>
<li>After the download completes successfully, double-click on the executable and click on the <strong>Next</strong> button on the RStudio setup welcome window.</li>
<li>In the next window, you are asked for the folder in which to install RStudio. Leave the default one and click on <strong>Next</strong>.</li>
<li>The following window asks you to select the Start menu folder in which to create the shortcuts. Leave the default one and click on <strong>Install</strong>.</li>
<li>When the installation is complete, click on <strong>Finish</strong>.</li>
</ol>
<p>Just to make sure you installed everything smoothly, check that you have the option to select one of the two newly installed R engines from the RStudio options:</p>
<ol>
<li><p>Open the newly installed RStudio from the <strong>Start</strong> menu:</p>
<figure>
<img src="img/file26.png" alt="Figure 2.11 – Run RStudio from the Start menu" /><figcaption aria-hidden="true">Figure 2.11 – Run RStudio from the Start menu</figcaption>
</figure></li>
<li>Once opened, you may be asked if you want to anonymously send any crash reports to RStudio to improve the product. Select <strong>Yes</strong> or <strong>No</strong> as your choice.</li>
<li><p>As you can see, RStudio has already selected an R engine by default. In our case, it is the latest version installed on our machine. Also, note that MKL is up and running:</p>
<figure>
<img src="img/file27.png" alt="Figure 2.12 – The default R engine selected in RStudio and Global Options" /><figcaption aria-hidden="true">Figure 2.12 – The default R engine selected in RStudio and Global Options</figcaption>
</figure>
<p>Now, click on the <strong>Tools</strong> menu and then <strong>Global Options…</strong> to see the available engines.</p></li>
<li><p>In the <strong>General</strong> menu of the <strong>Options</strong> window, you have the possibility to select the engine you want to use in RStudio by clicking on <strong>Change...</strong> and then selecting one of the available engines:</p>
<figure>
<img src="img/file28.png" alt="Figure 2.13 – Choose your preferred R engine to use with RStudio" /><figcaption aria-hidden="true">Figure 2.13 – Choose your preferred R engine to use with RStudio</figcaption>
</figure>
<p>Usually, we would not advise considering the engine containing <code>“C:\PROGRA~1\...”</code> as the root of the path. It is simply the engine that is currently selected in RStudio. Just select one of the other engines from the list.</p></li>
<li>For now, select the most recent version of R (in our case, 4.0.2) and click <strong>OK</strong> on the <strong>Choose R Installation</strong> window. You will be notified that you will need to restart RStudio for the selected changes to take effect.</li>
<li>Click <strong>OK</strong> on the <strong>Change R Version</strong> window, and then <strong>OK</strong> on the <strong>Options</strong> window. Sometimes you’ll have the option to restart by selecting <strong>Yes</strong> in a dialog box that is shown immediately afterward. If not, just exit from RStudio and open it again.</li>
</ol>
<p>Well done! Now you're ready to properly configure an R engine in Power BI Desktop and set up what you need to publish to the Power BI service.</p>



<h2 data-number="3.5">Configuring Power BI Desktop to work with R</h2>
<p>Once you have installed the R engines necessary for the development of your reports and the RStudio IDE, you must configure Power BI Desktop so that it properly references these tools. This is really a very simple task:</p>
<ol>
<li><p>In Power BI Desktop, go to the <strong>File</strong> menu, click on the <strong>Options and settings</strong> tab, and then click on <strong>Options</strong>:</p>
<figure>
<img src="img/file29.png" alt="Figure 2.14 – Opening the Power BI Desktop Options and settings window" /><figcaption aria-hidden="true">Figure 2.14 – Opening the Power BI Desktop Options and settings window</figcaption>
</figure></li>
<li><p>In the <strong>Options</strong> window, click on the <strong>R scripting</strong> tab on the left. The contents of the panel on the right will update, giving you the option to select the R engine to reference and the R IDE to use for R visuals:</p>
<figure>
<img src="img/file30.png" alt="Figure 2.15 – Choosing the engine and the IDE to work with in Power BI Desktop" /><figcaption aria-hidden="true">Figure 2.15 – Choosing the engine and the IDE to work with in Power BI Desktop</figcaption>
</figure></li>
<li>As you can see, Power BI Desktop automatically identifies the installed R engines and IDEs. For the moment, select the latest version of the engine (in our case, it is 4.0.2), in order to be aligned with the one already selected in RStudio.</li>
</ol>
<p>You will see how to interact with the IDE from Power BI Desktop when we introduce the R and Python script visuals in <em>Chapter 12, Exploratory Data Analysis</em>.</p>


<h2 data-number="3.6">Configuring the Power BI service to work with R</h2>
<p>As you learned in the <em>The R engines used by Power BI</em> section of this chapter, the Power BI service uses different R engines depending on whether the scripts are used in R visuals or in Power Query for data transformation. In the first case, the engine is pre-installed on the cloud; in the second case, you need to install the <strong>on-premises data gateway</strong> in <strong>personal mode</strong> on any machine of your choice in order to make the Power BI service communicate with the R engine you installed on that machine.</p>

<h3 data-number="3.6.1">Installing the on-premises data gateway in personal mode</h3>
<p>We have emphasized the fact that you will need to install the data gateway in personal mode for an important reason: R scripts are <em>not supported</em> for the on-premises data gateway in <em>Enterprise mode</em>.</p>
<p>In your case, you will install the data gateway on the same laptop on which you have installed the R engines and Power BI Desktop. The steps to do this are as follows:</p>
<ol>
<li><p>Make sure you can log in to the Power BI service (<a href="https://app.powerbi.com">https://app.powerbi.com</a>). You will see a home page like the following, customized with your company logo:</p>
<figure>
<img src="img/file31.png" alt="Figure 2.16 – The Power BI service home page" /><figcaption aria-hidden="true">Figure 2.16 – The Power BI service home page</figcaption>
</figure></li>
<li><p>On the top right-hand side of the home page, you'll notice a downward-pointing arrow that allows you to access the download menu. Click on this, and then select <strong>Data Gateway</strong>:</p>
<figure>
<img src="img/file32.png" alt="Figure 2.17 – The Download menu on your the Power BI service home page" /><figcaption aria-hidden="true">Figure 2.17 – The Download menu on your the Power BI service home page</figcaption>
</figure></li>
<li><p>You will be redirected to a web page from which you can download the data gateway. Be sure to download the <strong>personal mode</strong> version:</p>
<figure>
<img src="img/file33.png" alt="Figure 2.18: Download the personal mode version of the data gateway" /><figcaption aria-hidden="true">Figure 2.18: Download the personal mode version of the data gateway</figcaption>
</figure></li>
<li><p>Running the newly downloaded executable immediately opens an initial window that asks you to check the minimum installation requirements given in a link, set the installation folder of the software, and accept the terms of use for the software:</p>
<figure>
<img src="img/file34.png" alt="Figure 2.19 – The data gateway installation window" /><figcaption aria-hidden="true">Figure 2.19 – The data gateway installation window</figcaption>
</figure>
<p>You can leave the default folder selected, click on the terms of use acceptance check box, and click <strong>Install</strong> to move on.</p></li>
<li><p>Once the data gateway installation is complete, a sign-in window will open where you will need to enter the email address with which you registered with the Power BI service, and then your password:</p>
<figure>
<img src="img/file35.png" alt="Figure 2.20 – The data gateway sign-in window" /><figcaption aria-hidden="true">Figure 2.20 – The data gateway sign-in window</figcaption>
</figure></li>
<li><p>When the sign-in operation is successful, a green tick will appear with the words <strong>The gateway is online and ready to be used</strong>:</p>
<figure>
<img src="img/file36.png" alt="Figure 2.21 – The data gateway up and running" /><figcaption aria-hidden="true">Figure 2.21 – The data gateway up and running</figcaption>
</figure></li>
<li>You can close the on-premises data gateway window.</li>
</ol>
<p>At this moment, the Power BI service is directly connected to your machine and can access it whenever there is a need to refresh a published dataset with which your newly installed data gateway is associated.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>Keep in mind that a Power BI user can <em>only have one</em> data gateway associated. If you try to install multiple on-premises data gateways in personal mode on several different machines, logging in on one of them will force a disconnect on all other data gateways.</p>
</blockquote>


<h3 data-number="3.6.2">Sharing reports that use R scripts in the Power BI service</h3>
<p>In the previous sections you learned that, thanks to the data gateway newly installed in personal mode, you can publish a report that uses R scripts in the Power BI service to your personal workspace for sure. But, assuming you have a Pro license, can you also publish this report to shared workspaces? There is often a lot of confusion about this.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>No one forbids you from publishing your report on shared workspaces as well! Although you have used a data gateway in personal mode, other users can view your report. But not only that! Other users can also refresh the dataset behind the report. They will do this "on your behalf," pointing to the machine referenced by your data gateway. The important thing is that your machine is turned on!</p>
</blockquote>
<p>But then, if you can still share your reports with others using a data gateway in personal mode, what is the advantage of using a data gateway in Enterprise mode?</p>
<p>Using <em>just one</em> data gateway in Enterprise mode, <em>multiple users</em> in your organization can access on-premises data to which they already have access permission. It goes without saying that other users can view and refresh your report, but they cannot develop their own reports using R code by referencing your machine with R engines through your personal data gateway. This one is the true limitation.</p>
<p>In light of the preceding, there is an <strong>unofficial architecture</strong>, frequently used in companies, that allows <em>all reports</em> that make use of R code in Power Query to reference a <em>single machine</em> on which the R engine has been installed using a personal data gateway.</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>This unofficial architecture makes use of a personal data gateway associated not with a physical person, but with a <em>fictitious "service" user</em>. The credentials of this user are shared between all those analysts who use R code to transform data into their reports. Also, since the machine with the R engine referenced by the data gateway is shared, it must remain on during periods of scheduled activity. For this reason, an Azure Windows Virtual Machine on which both the R engine and the data gateway run is often used in this architecture.</p>
</blockquote>
<p>Since a picture is worth a thousand words, <em>Figure 2.22</em> summarizes this architecture:</p>
<figure>
<img src="img/file37.png" alt="Figure 2.22 – Enterprise architecture to use R for data transformations" /><figcaption aria-hidden="true">Figure 2.22 – Enterprise architecture to use R for data transformations</figcaption>
</figure>
<p>Thanks to this architecture it is possible to allow a group of analysts to use R scripts in their reports, despite the limitations imposed by the on-premises data gateway in personal mode.</p>
<p>That said, in addition to the limitations seen for R scripts in Power Query, there are some important ones to be aware of for R visuals as well.</p>



<h2 data-number="3.7">R visuals limitations</h2>
<p>R visuals have some important limitations regarding the data they can handle, both as input and output:</p>
<ul>
<li>An R visual can handle a <em>dataframe with only 150,000 rows</em>. If there are more than 150,000 rows, only the first 150,000 rows are used and a relevant message is displayed on the image.</li>
<li>R visuals have an <em>output size limit of 2MB</em>.</li>
</ul>
<p>You must also be careful not to exceed the <em>5 minutes of runtime calculation</em> for an R visual in order to avoid a time-out error. Moreover, in order not to run into performance problems, note that <em>the resolution of the R visual plots is fixed at 72 DPI</em>.</p>
<p>As you can imagine, some limitations of R visuals are different depending on whether you run the visual on Power BI Desktop or the Power BI service.</p>
<p>To create reports in <em>Power BI Desktop</em>, you can do any of the following:</p>
<ul>
<li>Install any kind of package (CRAN, GitHub, or custom) in your engine for R visuals.</li>
<li>Install only CRAN packages in your engine for custom R visuals (you will see an example in <em>Chapter 14, Interactive Custom Visuals in R</em>).</li>
<li>Access the internet from both an R visual and a custom R visual.</li>
</ul>
<p>When creating reports in <em>the Power BI service</em>, note the following:</p>
<ul>
<li>For both R visuals and custom R visuals, you can use <em>only the CRAN packages listed at this link</em>: <a href="https://bit.ly/powerbi-r-limits">https://bit.ly/powerbi-r-limits</a>.</li>
<li>You cannot access the internet from either R visuals or custom R visuals.</li>
</ul>
<p>As you may have noticed, although the CRAN packages that can be used in an R visual on the Power BI service are limited, you can still count more than 900 packages in that list! In addition to the fact that R was the first analytical language introduced into Power BI, this shows that R is de facto considered one of the most versatile and professional languages for creating engaging visualizations.</p>
<p>As you probably already know, once one of your reports is published on the Power BI service, you can decide to share it on your blog, on one of your websites, or on social media via the <strong>Publish to web</strong> option. R visuals are not allowed to be published to the web.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>Custom R visual overcomes the limitation on punlishing to the web.</p>
</blockquote>
<p>So, if you have to publish a report to the web, and that report contains a visualization created using R code, you must necessarily develop a custom R visual.</p>


<h2 data-number="3.8">Summary</h2>
<p>In this chapter, you learned about the most popular free R engines in the community. In particular, you learned what advantages have been introduced by Microsoft releasing its distribution of R to the market.</p>
<p>Taking note of the unique features of Power BI Desktop and the Power BI service, you have learned how to properly choose the engines and how to install them.</p>
<p>You have also learned about the most popular IDE in the R community and how to install it.</p>
<p>In addition, you were introduced to all of the best practices for properly configuring both Power BI Desktop and the Power BI service with R, whether in a development or enterprise environment.</p>
<p>Finally, you've learned some of the limitations on using R with Power BI, knowledge of which is critical to avoid making mistakes in developing and deploying reports.</p>
<p>In the next chapter, we'll see which Python engines and IDEs to install and configure in Power BI in order to develop and test Python scripts in comfort.</p>


</body>
</html>
