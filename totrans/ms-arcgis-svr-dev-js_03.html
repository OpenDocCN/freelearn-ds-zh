<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><div class="chapter" title="Chapter 3. The Dojo Widget System"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. The Dojo Widget System</h1></div></div></div><p>The developers at Esri created the ArcGIS JavaScript API using the Dojo framework. Dojo provides a large assortment of tools, libraries, and UI controls that work across multiple browsers. Any developer can create custom applications with UI elements that work well together using Dojo and the ArcGIS JavaScript API. Also, Dojo provides the AMD tools necessary to develop your own custom widgets, libraries, and controls.</p><p>In the previous chapters, we've reviewed the ArcGIS API for JavaScript, and we've written a small application using the API. We've even incorporated some basic principles of AMD into a single page application. What we've done so far would work great with a smaller application.</p><p>But what happens when applications get larger? Are we going to implement a single script to load all the components we need for a larger application? How are we going to extend the functionality of our website? What if we update our libraries and something breaks? Are we going to hunt through several thousand lines of code in one monolithic JavaScript file to find the parts that need to be changed?</p><p>In this chapter, we'll take advantage of the Dojo framework and create a custom widget for our application. Through that process, we'll cover the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The background of the Dojo framework</li><li class="listitem" style="list-style-type: disc">What the <code class="literal">dojo</code>, <code class="literal">dijit</code>, and <code class="literal">dojox</code> module packages have to offer</li><li class="listitem" style="list-style-type: disc">How to create and use our own custom modules</li><li class="listitem" style="list-style-type: disc">How to create widgets (modules with UI components), and how to extend them</li></ul></div><div class="section" title="A brief history of the Dojo framework"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec31"/>A brief history of the Dojo framework</h1></div></div></div><p>The Dojo framework <a id="id275" class="indexterm"/>began<a id="id276" class="indexterm"/> in 2004 with initial work at Informatica. Alex Russell, David Schontzler, and Dylan Schiemann contributed the first lines of code for the project. As work on the code continued, other developers were brought in and lent their input into the direction of the framework. The project grew so large that the founders created the Dojo Foundation to oversee the codebase and its intellectual properties. Since then, over 60 developers have contributed to the framework, and companies such as IBM and SitePen continue to use it today. For more information, visit at <a class="ulink" href="http://dojotoolkit.org/reference-guide/1.10/quickstart/introduction/history.html">http://dojotoolkit.org/reference-guide/1.10/quickstart/introduction/history.html</a>.</p><p>So what makes Dojo a framework, as opposed to a library? When this question was posed to the people at stack overflow (<a class="ulink" href="http://stackoverflow.com/questions/3057526/framework-vs-toolkit-vs-library">http://stackoverflow.com/questions/3057526/framework-vs-toolkit-vs-library</a>), the most agreed upon answer centered on an inversion of control. When we use tools in a library, our <a id="id277" class="indexterm"/>code controls the flow of logic and activity. When we calculate a value, we update that value in each location that it's needed through our code. In a framework, however, the framework controls the behavior of the application. When a value is updated in a framework, it is the framework that updates that value wherever it is bound on the web page.</p><p>The Dojo framework provides a number of HTML-based controls that we can load and use. Much in the way of CSS appearances and JavaScript behavior, is prewired into the control. After initial setup, our code instructs the framework where to send data when specific control events occur. We have no control when our functions are called, only what happens after they're called.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note07"/>Note</h3><p>If you want to read more about frameworks and the inversion of control, Martin Fowler provides a good explanation of the subject on his blog at <a class="ulink" href="http://martinfowler.com/bliki/InversionOfControl.html">http://martinfowler.com/bliki/InversionOfControl.html</a>.</p></div></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Introducing dojo, dijit, and dojox"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec32"/>Introducing dojo, dijit, and dojox</h1></div></div></div><p>Great care has been taken to organize the Dojo framework. When Dojo incorporated the AMD style of modules, many of the objects, methods, and properties were reorganized into logical folders and modules. Dojo is broken down into three main packages: <span class="strong"><strong>dojo</strong></span>, <span class="strong"><strong>dijit</strong></span>, and <span class="strong"><strong>dojox</strong></span>. Let's get an idea of what these three packages bring to the framework.</p><div class="section" title="The dojo package"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec46"/>The dojo package</h2></div></div></div><p>The <code class="literal">dojo</code> package <a id="id278" class="indexterm"/>provides much of the base functionality needed to load, run, and tear down the various modules in our applications. The modules provide functions and tools that work across multiple browsers, including the dreaded older versions of Internet Explorer. For example, the developer doesn't have to handle events by trying <code class="literal">addEventListener()</code> for Chrome and <code class="literal">attachEvent()</code> for older IE, because it's handled behind the scenes by <code class="literal">dojo/on</code>. With the framework, you can get away from all the browser hacks, and focus on creating a good application.</p><p>The <code class="literal">dojo</code> package does not contain widgets, but it does contain the tools necessary to manipulate things within the widgets. Do you need to handle mouse clicks and touch events? Use the <code class="literal">dojo/mouse</code> and <code class="literal">dojo/touch</code> modules. Do you need a jQuery-like selector for your HTML? Load the <code class="literal">dojo/query</code> module. The dojo package provides modules for HTML DOM manipulation, arrays, AJAX, dates, event, and i18n, just to name a few.</p></div><div class="section" title="The dijit package"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec47"/>The dijit package</h2></div></div></div><p>The <code class="literal">dijit</code> package <a id="id279" class="indexterm"/>provides visual elements (referred to as <span class="strong"><strong>dijits</strong></span>) that integrate well with the <code class="literal">dojo</code> package. The elements created with the <code class="literal">dijit</code> package have been tested across multiple browsers. They provide a consistent user interface based on the CSS stylesheets loaded with the library.</p><p>As the Dojo framework is used and contributed to by many companies and developers, there are plenty of user controls available. Whether you're creating a submission form, a calendar of events, or an executive dashboard, you can combine the dijits in this package in a way that suits your needs. Some of the more popular packages include:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">dijit/Calendar</code>: This provides<a id="id280" class="indexterm"/> an interactive HTML calendar control that works on both desktops and tablets.</li><li class="listitem" style="list-style-type: disc"><code class="literal">dijit/form</code>: A<a id="id281" class="indexterm"/> package containing stylized form elements such as buttons, checkboxes, dropdown menus, textboxes, and sliders. The form elements have a consistent look across older and newer browsers.</li><li class="listitem" style="list-style-type: disc"><code class="literal">dijit/layout</code>: A <a id="id282" class="indexterm"/>package containing controls that handle layouts. You can create simple containers, tab containers, accordion containers, and even containers that control the positions of other containers.</li><li class="listitem" style="list-style-type: disc"><code class="literal">dijit/Tree</code>: A<a id="id283" class="indexterm"/> module that creates a collapsible tree menu which could be used, for instance, to show folder layouts.</li></ul></div><p>The <code class="literal">dijit</code> package contains more than user controls. It also provides the tools necessary to create your own custom dijits. Using the <code class="literal">dijit/_WidgetBase</code> module and assorted mixins, you can incorporate both HTML elements and existing dijits into your own custom <code class="literal">dijit</code>. Working with the <code class="literal">dijit</code> components can give the user a consistent experience throughout the entire application.</p></div><div class="section" title="The dojox package"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec48"/>The dojox package</h2></div></div></div><p>According<a id="id284" class="indexterm"/> to documentation on the Dojo framework (<a class="ulink" href="http://dojotoolkit.org/reference-guide/1.10/dojox/info.html">http://dojotoolkit.org/reference-guide/1.10/dojox/info.html</a>), <code class="literal">dojox</code> provides extensions to Dojo. This part of the library deals with more experimental functionality, user interfaces, and testing features. Many parts of the library have matured due to extensive use, while other parts have been depreciated and are not under active development.</p><p>One of the <a id="id285" class="indexterm"/>useful subpackages in the <code class="literal">dojox</code> package is <code class="literal">dojox/mobile</code>. The <code class="literal">Dojox/mobile</code> package provides UI elements and controls that you can use in mobile applications. They have been tested on a wide variety of mobile browsers, and their styling can even mimic the style of native smartphone and tablet applications.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>For more information regarding the <code class="literal">dojo</code>, <code class="literal">dijit</code>, and <code class="literal">dojox</code> packages in the Dojo framework, you can view tutorial documentation by going to: <a class="ulink" href="http://dojotoolkit.org/documentation/tutorials/1.10/beyond_dojo/">http://dojotoolkit.org/documentation/tutorials/1.10/beyond_dojo/</a>.</p></div></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="The dojoConfig packages"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec33"/>The dojoConfig packages</h1></div></div></div><p>Using<a id="id286" class="indexterm"/> the built-in Dojo packages is great and all, but what about making your own custom package? You can create custom packages in your local folders, and reference them through your <code class="literal">dojoConfig</code> object. In the <code class="literal">dojoConfig</code> object, you can add a packages parameter that contains an array of JavaScript objects. Those package objects should contain a name attribute, which is a reference to your package, and a location attribute, which references the folder location. Here's an example of a <code class="literal">dojoConfig</code> object with a reference to a custom package:</p><div class="informalexample"><pre class="programlisting">&lt;script&gt;
  dojoConfig = {
    async: true,
    isDebug: true,
    <span class="strong"><strong>packages: [</strong></span>
<span class="strong"><strong>      {</strong></span>
<span class="strong"><strong>        name: "myapp",</strong></span>
<span class="strong"><strong>        location: location.pathname.replace(/\/[^/]+$/, '') + "/myapp"</strong></span>
<span class="strong"><strong>      }</strong></span>
<span class="strong"><strong>    ]</strong></span>
  };
&lt;/script&gt;</pre></div><p>In the preceding sample, the package <code class="literal">myapp</code> is referenced, and all the files for that package are loaded into the <code class="literal">myapp</code> folder under the current page. So, if this page was shown at <code class="literal">http://www.example.com/testmap/</code>, the <code class="literal">myapp</code> package could be found at <code class="literal">http://www.example.com/testmap/myapp</code>. When referencing the <code class="literal">Something</code> module in your <code class="literal">myapp</code> package, you <a id="id287" class="indexterm"/>would load the module like this:</p><div class="informalexample"><pre class="programlisting">require(["myapp/Something", "dojo/domReady!"], function (Something) { … });</pre></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Defining your widget"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec34"/>Defining your widget</h1></div></div></div><p>With Dojo's AMD style, there <a id="id288" class="indexterm"/>are two main ways to use AMD components. Using the <code class="literal">require()</code> function plays the script once, and then it's done. But if you want to create a module that can be used over and over again, you would want to <code class="literal">define()</code> the module, instead. The <code class="literal">define()</code> function creates one or more custom modules to be used by an application.</p><p>The <code class="literal">define()</code> function takes a single argument, which could be any JavaScript object. Even <code class="literal">define("Hello World!")</code> is a valid module definition, though not that useful. You can create more useful ones by passing in objects or object constructors that perform tasks for your application. Review the following example:</p><div class="informalexample"><pre class="programlisting">define(function () {
  var mysteryNumber = Math.floor((Math.random() * 10) + 1);
  return {
    guess: function (num) {
      if (num === mysteryNumber) {
        alert("You guessed the mystery number!");
      } else if (num &lt; mysteryNumber) {
        alert("Guess higher.");
      } else {
        alert("Guess lower.");
      }
    }
  };
});</pre></div><p>In the preceding example, the module picks a random number from one to ten, It then returns a module with a <code class="literal">guess()</code> method that accepts a numeric value. Upon calling the <code class="literal">guess()</code> method, it alerts the user as to whether the guess was correct or not.</p><div class="section" title="Declaring modules"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec49"/>Declaring modules</h2></div></div></div><p>Developers <a id="id289" class="indexterm"/>entering JavaScript from more classical <span class="strong"><strong>Object-oriented</strong></span> (<span class="strong"><strong>OO</strong></span>) languages<a id="id290" class="indexterm"/> may have a difficult time embracing the language's prototype-based inheritance. In most OO languages, classes are defined at compilation, and sometimes inherit properties and methods from other base classes. In JavaScript objects, class-type objects are stored within the object's prototype, which holds the same shared properties and methods for multiple related objects.</p><p>Dojo can ease the transition for these developers when they use the <code class="literal">dojo/_base/declare</code> module. The module creates Dojo-based classes, which can be used by other applications. Behind the scenes, it takes a class-like JavaScript object and converts it to a prototype-based constructor. This module couples well with the <code class="literal">define()</code> function to create custom <code class="literal">dojo</code> modules, like the following:</p><div class="informalexample"><pre class="programlisting">define(["dojo/_base/declare", …], function (declare, …) {
  <span class="strong"><strong>return declare(null, {…});</strong></span>
});</pre></div><p>The <code class="literal">declare()</code> function<a id="id291" class="indexterm"/> takes three arguments: the class name, the parent class, and the class properties object. The class name is an optional string that can be used to reference the class. The <code class="literal">declare()</code> function will turn the name into a global variable, so that the <code class="literal">dojo/parser</code> can write it into HTML when you reference the <code class="literal">dijit</code> package with a <code class="literal">data-dojo-type</code> attribute. If you do not plan to use the <code class="literal">dojo/parser</code> to write your widget into HTML, it's highly recommended that you don't use the first argument.</p><div class="section" title="Class Inheritance through Dojo"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec42"/>Class Inheritance through Dojo</h3></div></div></div><p>The<a id="id292" class="indexterm"/> second argument in the <code class="literal">declare()</code> function refers to the parent class. There are three possible ways to define the parent class. If the class you are creating does not have a parent class, it is said to have no inheritance. In that case, the parent class argument is null, as in the following statement:</p><div class="informalexample"><pre class="programlisting">define(["dojo/_base/declare", …], function (declare, …) {
  return declare(<span class="strong"><strong>null</strong></span>, {…});
});</pre></div><p>In the second scenario, there is a parent class for the class you are creating. The parent could be another AMD module, or another declared item. The following example shows this by extending the <code class="literal">dijit/form/Button</code> module:</p><div class="informalexample"><pre class="programlisting">define(["dojo/_base/declare", "dijit/form/Button", …],
  function (declare, Button, …) {
    return declare(<span class="strong"><strong>Button</strong></span>, {…});
  }
);</pre></div><p>The third possible scenario involves multiple inheritance, where your class inherits properties and methods from multiple classes. For that, the parent class parameter will also accept an array of objects. The first item in the array is considered the base class, which provides the main construction parameters. The rest of the items in the list are referred to as "mixins". They don't necessarily provide object construction functionality, but they add properties and methods that either complement, or override the existing base class. The following example shows multiple inheritance using a few libraries we'll talk about later:</p><div class="informalexample"><pre class="programlisting">define(["dojo/_base/declare", "dijit/_WidgetBase", "dijit/_OnDijitClickMixin, "dijit/_TemplatedMixin"], 
  function (declare, _WidgetBase, _OnDijitClickMixin, _TemplatedMixin) {
    return declare([_WidgetBase, _OnDijitClickMixin, _TemplatedMixin], {…});
});</pre></div></div><div class="section" title="Dealing with classes and inheritance"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec43"/>Dealing with classes and inheritance</h3></div></div></div><p>In the<a id="id293" class="indexterm"/> final<a id="id294" class="indexterm"/> argument of the <code class="literal">declare()</code> statement, the developer defines the different properties and methods contained in the class. The object properties can be anything from strings and numbers to lists, objects, and functions. Please review the following code example:</p><div class="informalexample"><pre class="programlisting">declare("myApp/Fibonacci", null, {
  list: [],
  contructor: function () {
    var len = this.list.length;
    if (len &lt; 2) {
      this.myNumber = 1;
    } else {
      this.myNumber = this.list[len – 1] + this.list[len-2];
    }
    this.list.push(this.myNumber);
  },
  showNumber: function () { alert(this.myNumber); }
});</pre></div><p>In objects created with the <code class="literal">declare()</code> statement, you have both static and instance properties. <span class="strong"><strong>Static</strong></span> properties <a id="id295" class="indexterm"/>are properties that are shared by all objects that were created in the same way. <span class="strong"><strong>Instance</strong></span> properties<a id="id296" class="indexterm"/> are properties that are unique to the object created. Properties defined within the class object are considered static, but every property initially assigned either within the constructor, or within another method, is considered an instance property.</p><p>In the preceding example, the <code class="literal">showNumber()</code> method and the <code class="literal">list</code> properties are static, while the <code class="literal">myNumber</code> property is an instance. That means every <code class="literal">myapp/Fibonacci</code> object will share the <code class="literal">showNumber()</code> method and the <code class="literal">list</code> array, but will have unique <code class="literal">myNumber</code> properties. For example, if five <code class="literal">myapp/Fibonacci</code> objects are created, each should contain the list value of <code class="literal">[1, 1, 2, 3, 5]</code>. Adding one more to the list will add to every Fibonacci list. The <code class="literal">myNumber</code> property is created in the constructor, therefore each object will have a unique value for that property.</p><p>When a class is created from a parent class, it has access to its parent's properties and methods. The new class can also overwrite those methods by having a new method with the same name in its constructor. For example, let's say a <code class="literal">HouseCat</code> object inherits from a <code class="literal">Feline</code> object, and they have their own versions of the <code class="literal">pounce()</code> method, If you call <code class="literal">HouseCat.pounce()</code>, it will only run the method described in <code class="literal">HouseCat</code>, and not in <code class="literal">Feline</code>. If you want to run the <code class="literal">Feline.pounce()</code> method within the call to <code class="literal">HouseCat.pounce()</code>, you would add <code class="literal">this.inherited(arguments)</code> within the <code class="literal">HouseCat.pounce()</code> method, to show <a id="id297" class="indexterm"/>when you want to run the parent<a id="id298" class="indexterm"/> class method.</p></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Working with Evented modules"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec35"/>Working with Evented modules</h1></div></div></div><p>The<a id="id299" class="indexterm"/> <code class="literal">Evented</code> module<a id="id300" class="indexterm"/> lets your widgets publish events. When your module is declared with <code class="literal">Evented</code> as the parent class, it provides an <code class="literal">emit()</code> method for broadcasting that the event has occurred, and an <code class="literal">on()</code> method for listening to events. One example that can be found in the ArcGIS API would be the drawing toolbar. It doesn't display information, but it has the tools necessary to publish events.</p><p>The <code class="literal">emit()</code> method takes two arguments. The first is a string name that describes the event, such as <code class="literal">map-loaded</code> or <code class="literal">records-received</code>. The second is an object created and passed along with the event. The object could be anything you can create in JavaScript, but remember to keep the returned content similar, so that the methods listening for the event to occur don't miss it.</p></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="An overview of the _WidgetBase module"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec36"/>An overview of the _WidgetBase module</h1></div></div></div><p>The <code class="literal">_WidgetBase</code> module <a id="id301" class="indexterm"/>provides the base class necessary to create a <code class="literal">dijit</code> module. In itself, it's not a widget, but you can easily build a widget on top of it. The widget created with the <code class="literal">_WidgetBase</code> module is bound to an element in the HTML DOM, which can be referred to with its <code class="literal">domNode</code> attribute.</p><p>The <code class="literal">_WidgetBase</code> module also introduces a lifecycle to the widget. The lifecycle refers to how the widget is created, built up, used, and torn down. This module loads the following methods<a id="id302" class="indexterm"/> and events that occur within the lifecycle of the widget:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">constructor</code>: This <a id="id303" class="indexterm"/>method is called on widget creation. There is no access to the template, but values can be assigned and arrays can be accessed.</li><li class="listitem" style="list-style-type: disc"><code class="literal">parameters mixed into widget instance</code>: The parameters you passed into the object constructor, such <a id="id304" class="indexterm"/>as button labels, are added to the widget to overwrite any pre-existing values.</li><li class="listitem" style="list-style-type: disc"><code class="literal">postMixinProperties</code>: This<a id="id305" class="indexterm"/> is a step prior to rendering the widget HTML. If you need to change or correct any values passed into the parameters or something, this would be the time to do so.</li><li class="listitem" style="list-style-type: disc"><code class="literal">buildRendering</code>: This is<a id="id306" class="indexterm"/> where the HTML templates are added in place of the existing node, if templating is being used. If you're using the <code class="literal">_TemplatedMixin</code> module, the template string is loaded into the browser, rendered into HTML, and inserted in place of the existing <code class="literal">domNode</code>. Events bound in the HTML data-* attributes are assigned here, as well.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Custom setters are called</code>: If you<a id="id307" class="indexterm"/> have added custom setter functions, these will be called at this point.</li><li class="listitem" style="list-style-type: disc"><code class="literal">postCreate</code>: Now <a id="id308" class="indexterm"/>that the HTML has been rendered, this function can do more with it. Just be warned, the widget HTML may not be connected to the document yet. Also, if this widget contains child widgets, they may not have rendered yet.</li><li class="listitem" style="list-style-type: disc"><code class="literal">startup</code>: This<a id="id309" class="indexterm"/> function can be called after all parsing and child-widget rendering has finished. It is usually used when the widget needs to resize itself through the <code class="literal">resize()</code> method.</li><li class="listitem" style="list-style-type: disc"><code class="literal">destroy</code>: This <a id="id310" class="indexterm"/>function is called when this widget is torn down and removed, either by closing the application, or whenever this function is called. The parent classes typically handle the tear down events on their own, but if you need to do anything unique before destroying the widget, this would be the function to extend.</li></ul></div><p>The <code class="literal">_WidgetBase</code> module <a id="id311" class="indexterm"/>has specialized getter and setter functions that allow you to perform specific tasks when you set a widget property. You can retrieve the values with the <code class="literal">get()</code> function and set these properties using the <code class="literal">set()</code> function. The first argument of both <code class="literal">get()</code> and <code class="literal">set()</code> is the name of the property, and the second argument in the <code class="literal">set()</code> method is the value. So, if you want to set the <code class="literal">name</code> of a widget, you would call <code class="literal">widget.set("name", "New Name")</code>. There is also a <code class="literal">watch()</code> method that can perform functions when a value changes through <code class="literal">set()</code>.</p></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Working with other _Mixins"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec37"/>Working with other _Mixins</h1></div></div></div><p>The <code class="literal">_WidgetBase</code> module may<a id="id312" class="indexterm"/> not provide all the widget functionality your application will need. The <code class="literal">dijit</code> package provides mixins, or JavaScript object extensions, for your widget. These mixins can provide HTML templates, event handling for clicks, touches, focus, and a lack thereof, for example. Loading the right mixin with your application can save you a lot of behavior coding. Let's take a look at some of the ones we may use.</p><div class="section" title="Adding _TemplatedMixin"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec50"/>Adding _TemplatedMixin</h2></div></div></div><p>The <code class="literal">_TemplatedMixin</code> module <a id="id313" class="indexterm"/>lets the module replace its existing HTML content with either a string template, or HTML from another source. The widget's template string is assigned through the <code class="literal">templateString</code> property. This allows the widget to skip a possibly complicated <code class="literal">buildRendering</code> step. You can see an example of a <code class="literal">_TemplatedMixin</code> module call in the following code snippet:</p><div class="informalexample"><pre class="programlisting">require(["dojo/_base/declare", "dijit/_WidgetBase", "dijit/_TemplatedMixin"], 
function (declare, _WidgetBase, _TemplatedMixin) {
  declare("ShoutingWidget, [_WidgetBase, _TemplatedMixin], {
    <span class="strong"><strong>templateString: "&lt;strong&gt;I AM NOT SHOUTING!&lt;/strong&gt;"</strong></span>
  });
});</pre></div><p>As the <code class="literal">templateString</code> property is being rendered, properties can pass back and forth between template and widget. Widget properties can be written to the template during the <code class="literal">buildRendering</code> phase by referencing the property name in the widget, and surrounding it with the <code class="literal">${}</code> wrapper. You can also assign node references and attach widget events using the HTML data attributes. The <code class="literal">data-dojo-attach-point</code> attribute lets the widget have a named property that connects to the template. The <code class="literal">data-dojo-attach-event</code> attribute attaches a <code class="literal">callback</code> method in the widget that is triggered when the event is occurs. You can view the following example:</p><div class="informalexample"><pre class="programlisting">&lt;div class="<span class="strong"><strong>${baseClass}</strong></span>"&gt;
  &lt;span <span class="strong"><strong>data-dojo-attach-point="messageNode"</strong></span>&gt;&lt;/span&gt;
  &lt;button <span class="strong"><strong>data-dojo-attach-event="onclick:doSomething</strong></span>"&gt;
    <span class="strong"><strong>${label}</strong></span>
  &lt;/button&gt;
&lt;/div&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip11"/>Tip</h3><p>How should a developer lay out a template widget? The widget's template HTML should all be contained in a single HTML element. You can use a <code class="literal">&lt;div&gt;</code> tags, a <code class="literal">&lt;table&gt;</code> tags, or element tags you plan to enclose the template in. If the template contains more than one element at the base layer, the widget will not render and throw an error.</p></div></div></div><div class="section" title="Adding _OnDijitClickMixin"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec51"/>Adding _OnDijitClickMixin</h2></div></div></div><p>The <code class="literal">_OnDijitClickMixin</code> module <a id="id314" class="indexterm"/>provides the ability for elements within your template to be "clicked". This works, not only with click events using the mouse, but through touch and keyboard events as well. Besides clicking and touching an element, the user can tab until the element is highlighted, then press the <span class="emphasis"><em>Enter</em></span> or spacebar key to activate it.</p><p>If the <code class="literal">_OnDijitClickMixin</code> module is loaded, the developer can add event handlers to the <code class="literal">dijit</code> template through the <code class="literal">data-dojo-attach-event</code> attribute. Within this data attribute text value, add <code class="literal">ondijitclick:</code> followed by the name of your click event handler. You <a id="id315" class="indexterm"/>must have this event handler pointing to a valid function, or else the whole widget will fail to load. An example of a <code class="literal">dijit</code> template using the <code class="literal">clickMe(event) {}</code> function is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;div class="clickable" <span class="strong"><strong>data-dojo-attach- event="ondijitclick:clickMe"&gt;</strong></span> I like to be clicked.&lt;/div&gt;</pre></div><p>As a side note, the function within the click event handler should be ready to accept a one click event argument, and nothing else.</p></div><div class="section" title="Adding _FocusMixin"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec52"/>Adding _FocusMixin</h2></div></div></div><p>The <code class="literal">_FocusMixin</code> module <a id="id316" class="indexterm"/>provides focus and blur events for your widget and its components. For instance, if you have a widget that takes up more room when it's focused, you could add an <code class="literal">_onFocus()</code> event handler to the object like this:</p><div class="informalexample"><pre class="programlisting">_onFocus: function () { domClass.add(this.domNode, "i-am-huge");}</pre></div><p>On the other hand, when you want your widget to shrink back to its normal size, you would add an <code class="literal">_onBlur()</code> event handler:</p><div class="informalexample"><pre class="programlisting">_onBlur: function() { domClass.remove(this.domNode, "i-am-huge");}</pre></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="The event system"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec38"/>The event system</h1></div></div></div><p>The<a id="id317" class="indexterm"/> event system within JavaScript is an important part of the language. JavaScript was designed to respond to events in the browser and events caused by users. A website may need to respond to the click of a user, or an AJAX response from a server. With the language, you can attach functions called event handlers to listen for events from certain elements in the page and the browser.</p><p>In the Dojo framework, events are listened to using the <code class="literal">dojo/on</code> module. When assigning an event listener, the module function call returns an object that lets you discontinue listening by calling the object's <code class="literal">remove()</code> method. Also, <code class="literal">dojo/on</code> has a <code class="literal">once()</code> method that fires the event once, when the event occurs, then automatically removes the event.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip12"/>Tip</h3><p>Some older ArcGIS API samples still use Dojo's old event handler, <code class="literal">dojo.connect()</code>. Events handlers would be attached with <code class="literal">dojo.connect()</code>, and removed with <code class="literal">dojo.disconnect()</code>. The Dojo Foundation is currently depreciating <code class="literal">dojo.connect()</code>, and will drop it from their code when Dojo moves to version 2.0. If you are maintaining old code, please start migrating all <code class="literal">dojo.connect()</code> to <code class="literal">dojo/on</code>. With the ArcGIS API, please pay attention to event names and results returned. Names may change from CamelCase to dash-separated, and while <code class="literal">dojo.connect()</code> can return more than one item in its callback, <code class="literal">dojo/on</code> only returns a single JavaScript object.</p></div></div><p>Events <a id="id318" class="indexterm"/>are created using <code class="literal">emit()</code>. This function takes in a string name of the event, and a JavaScript object you would want to pass to an event listener. The <code class="literal">emit()</code> method is available for widgets using the <code class="literal">dojo/Evented</code> module, and those built using the <code class="literal">dijit/_WidgetBase</code> module. It is also available through the <code class="literal">dojo/on</code> module, but <code class="literal">dojo/on.emit()</code> requires an HTML DOM before the event name.</p><p>Now that we have a grasp of the Dojo framework, let's build something with it.</p></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Creating our own widget"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec39"/>Creating our own widget</h1></div></div></div><p>Now that we know<a id="id319" class="indexterm"/> the basics of creating custom widgets, that is to say, dijits for our web applications, let's put our knowledge into practice. In this part of the chapter, we will transform the single-page application code we wrote in <a class="link" href="ch01.html" title="Chapter 1. Your First Mapping Application">Chapter 1</a>, <span class="emphasis"><em>Your First Mapping Application</em></span> into a dijit that can be used with any map. We'll then use that <code class="literal">dijit</code> in a map application that can be expanded to include other dijits as well.</p><div class="section" title="Picking up where we left off…"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec53"/>Picking up where we left off…</h2></div></div></div><p>We finally received feedback from the Y2K Society about the census map we created in <a class="link" href="ch01.html" title="Chapter 1. Your First Mapping Application">Chapter 1</a>, <span class="emphasis"><em>Your First Mapping Application</em></span>. They liked how the map worked, but felt it could use more polish. After a meeting with some group members, here is a list of their feedback:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The application should have sections at the top and the bottom to show titles and a little bit about the society</li><li class="listitem" style="list-style-type: disc">The colors should be warm and cheery, such as yellows</li><li class="listitem" style="list-style-type: disc">Get rid of the plain black line work of the census layer data</li><li class="listitem" style="list-style-type: disc">The application should let us do more than simply look at census data. It should let us click on other buttons to do other things</li><li class="listitem" style="list-style-type: disc">The census information needs to be more organized and grouped logically in tables</li></ul></div><p>In order to comply with their requests, we will need to reorganize our application from <a class="link" href="ch01.html" title="Chapter 1. Your First Mapping Application">Chapter 1</a>, <span class="emphasis"><em>Your First Mapping Application</em></span>. To<a id="id320" class="indexterm"/> fix the issue, we'll need to do the following:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We will create a new full page app with a header and footer.</li><li class="listitem">We will modify the style of the application.</li><li class="listitem">We will represent the census map service using custom symbology.</li><li class="listitem">We will add buttons to the header to launch the census popups.</li><li class="listitem">We will move the <code class="literal">infoTemplate</code> data into separate HTML files.</li></ol></div><div class="section" title="The file structure for our application"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec44"/>The file structure for our application</h3></div></div></div><p>In order<a id="id321" class="indexterm"/> to deliver a map that can do more than just show census data, we're going to use the tools provided by the Dojo framework. We'll use elements of Dojo to lay out the application, and turn our previous census map tool into its own widget. Instead of a single page application, where the HTML, CSS, and JavaScript are mashed together in the same file, we're going to separate the files into distinct components.</p><p>Let's start by organizing the project folder. It's a good idea to separate the styling and scripts into separate folders. In our project folder, we'll add two subfolders to the project folder. We'll name them <code class="literal">css</code> and <code class="literal">js</code>, for the stylesheet and script files, respectively. Inside the <code class="literal">js</code> folder, we'll add another folder and name it <code class="literal">templates</code>. This is where our widget templates will go.</p><p>In the main project folder, we'll create an HTML page called <code class="literal">index.html</code>. Next, In the <code class="literal">css</code> folder, we'll create a file called <code class="literal">y2k.css</code>, which will be our application stylesheet. We'll create two JavaScript files in our <code class="literal">js</code> folder: one called <code class="literal">app.js</code> for our application, and another called <code class="literal">Census.js</code> for our widget. We'll stub out template files in the <code class="literal">js</code>/<code class="literal">templates</code> folder for the census widget (<code class="literal">Census.html</code>), plus some templates for our popups. The files should look something like the following folder structure:</p><div class="mediaobject"><img src="graphics/6459OT_03_01.jpg" alt="The file structure for our application" width="240" height="241"/></div></div></div><div class="section" title="Defining the layout with Dojo"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec54"/>Defining the layout with Dojo</h2></div></div></div><p>To handle the<a id="id322" class="indexterm"/> layout of the application, we'll use a couple of the modules within the <code class="literal">dijit/layout</code> package. This package has a number of UI containers <a id="id323" class="indexterm"/>with styled looks and built-in UI behavior that we don't have to reinvent. We'll add the layout elements and restyle them to fit our client's wishes. Let's look at the layout module found within the <code class="literal">dijit</code> package.</p><div class="section" title="Framing the page with BorderContainer"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec45"/>Framing the page with BorderContainer</h3></div></div></div><p>The <a id="id324" class="indexterm"/><code class="literal">BorderContainer</code> container provides <a id="id325" class="indexterm"/>a common layout tool used with Dojo. The <code class="literal">BorderContainer</code> container is extended from the <code class="literal">LayoutContainer</code> module, which creates a layout that fills up the entire browser window without scrolling. The <code class="literal">LayoutContainer</code> module (and by extension, the <code class="literal">BorderContainer</code> module) allows content elements to be placed with a region attribute. The <code class="literal">BorderContainer</code> container adds borders, spacing, and resizing elements called splitters, which can be dragged to resize the content items.</p><p>The regions that can be<a id="id326" class="indexterm"/> assigned to content dijits inside the <code class="literal">BorderContainer</code> container are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Center</strong></span>: This positions the element at the center of the page, relative to the other items. One element must be assigned this value.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Top</strong></span>: This positions the element above the center element.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Bottom</strong></span>: This positions the element below the center element.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Right</strong></span>: This positions the element to the right of the center element.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Left</strong></span>: This positions the element to the left of the center element.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Leading</strong></span>: If the <code class="literal">dir</code> attribute of the page is set to "ltr" (left-to-right), the leading element is placed to the left of the center element. If the <code class="literal">dir</code> attribute is "rtl" (right-to-left), the leading element is placed on the right.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Trailing</strong></span>: Layout <a id="id327" class="indexterm"/>is the opposite of the leading element, with "ltr" on the right, and "rtl" on the left.</li></ul></div><p>The <code class="literal">BorderContainer</code> module, and its parent <code class="literal">LayoutContainer</code> module, have a design parameter that affects the containers surrounding the center element. When the <code class="literal">design</code> parameter is set to its default value of <code class="literal">headline</code>, the top and bottom panels take up the entire width of the container. The right, left, leading, and trailing panels shrink to fit between the top and bottom panels. Alternatively, you can set the <code class="literal">design</code> parameter to <code class="literal">sidebar</code>, and the panels on the sides will take up the entire height, while the top and bottom panels are squeezed in between them. The following figure shows example pages made with headline and sidebar designs. The <code class="literal">design</code> parameter was the only parameter changed in the examples:</p><div class="mediaobject"><img src="graphics/6459OT_03_02.jpg" alt="Framing the page with BorderContainer" width="700" height="176"/><div class="caption"><p>BorderContainer with 'headline' (left) and 'sidebar' (right) design attributes with ContentPanes</p></div></div></div><div class="section" title="Inserting ContentPane"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec46"/>Inserting ContentPane</h3></div></div></div><p>The <a id="id328" class="indexterm"/><code class="literal">ContentPane</code><a id="id329" class="indexterm"/> tile provides the general container used in most desktop Dojo pages. <code class="literal">ContentPane</code> tiles can adjust to fit within their assigned places, and can expand and shrink as the user resizes the browser. <code class="literal">ContentPane</code> tiles can house HTML elements, such as other Dojo widgets and controls. They also have an <code class="literal">href</code> attribute which, when set, will load and render the content of another HTML page. The pages are loaded via <a id="id330" class="indexterm"/><span class="strong"><strong>XMLHttpRequest</strong></span> (<span class="strong"><strong>XHR</strong></span>), therefore the loaded HTML should be on the same domain, due to cross-origin issues.</p></div><div class="section" title="Modifying the layout of our application"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec47"/>Modifying the layout of our application</h3></div></div></div><p>Looking at the <a id="id331" class="indexterm"/>requirements, we're going to use the <code class="literal">BorderContainer</code> containers and some <code class="literal">ContentPane</code> tiles to create the header, footer, and the content of the application. We'll take a standard HTML template pulling the necessary libraries, then add the <code class="literal">dijit</code> content.</p><p>In your<a id="id332" class="indexterm"/> application's folder, start by creating an HTML file called <code class="literal">index.html</code>. We'll title it <code class="literal">Y2K Map</code>, and add the necessary meta tags and scripts to load the ArcGIS API for JavaScript. We'll also load the dojo CSS stylesheet <code class="literal">nihilo.css</code>, to handle the styling of the base styling of the dojo elements in the application. In order to apply the style to our application, we'll also add a class of <code class="literal">nihilo</code> to the body element of our HTML document. Finally, we'll add a link to our <code class="literal">y2k.css</code> file, which we'll create soon. Your HTML document should look like the following:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE HTML&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;
    &lt;meta http-equiv="X-UA-Compatible" content="IE=Edge" /&gt;
    &lt;meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" /&gt;
    &lt;title&gt;Y2K Map&lt;/title&gt;
    <span class="strong"><strong>&lt;link rel="stylesheet" href="http://js.arcgis.com/3.13/dijit/themes/nihilo/nihilo.css"&gt;</strong></span>
    &lt;link rel="stylesheet" href="https://js.arcgis.com/3.13/esri/css/esri.css" /&gt;
    <span class="strong"><strong>&lt;link rel="stylesheet" href="css/y2k.css" /&gt;</strong></span>
    &lt;script src="https://js.arcgis.com/3.13/"&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body <span class="strong"><strong>class="nihilo"&gt;</strong></span>
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>Next, we'll add the <code class="literal">BorderContainer</code> container and the <code class="literal">ContentPane</code> tiles inside the body tag. These will be built on basic <code class="literal">&lt;div&gt;</code> elements. We'll give the <code class="literal">BorderContainer</code> container an <code class="literal">id</code> of <code class="literal">mainwindow</code>, a <code class="literal">ContentPane</code> tile at the top with an <code class="literal">id</code> of <code class="literal">header</code>, another <code class="literal">ContentPane</code> tile with an <code class="literal">id</code> of <code class="literal">map</code> where our map will go, and a <code class="literal">ContentPane</code> tile at the bottom with an <code class="literal">id</code> of <code class="literal">footer</code>. We'll also add a little content to the header and footer, just to make it look nice. Here is an example:</p><div class="informalexample"><pre class="programlisting">&lt;body class="nihilo"&gt;
<span class="strong"><strong>  &lt;div id="mainwindow" data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline',gutter:false,liveSplitters: true" style="width: 100%; height: 100%; margin: 0;"&gt;</strong></span>
    <span class="strong"><strong>&lt;div id="header" data-dojo-type="dijit/layout/ContentPane"</strong></span>
<span class="strong"><strong>      data-dojo-props="region:'top',splitter:true"&gt;</strong></span>
      &lt;h1&gt;Year 2000 Map&lt;/h1&gt;
<span class="strong"><strong>    &lt;/div&gt;</strong></span>
    <span class="strong"><strong>&lt;div id="map" data-dojo-type="dijit/layout/ContentPane" </strong></span>
<span class="strong"><strong>       data-dojo-props="region:'center',splitter:true"&gt;</strong></span>
<span class="strong"><strong>    &lt;/div&gt;</strong></span>
    <span class="strong"><strong>&lt;div id="footer" data-dojo-type="dijit/layout/ContentPane" </strong></span>
<span class="strong"><strong>      data-dojo-props="region:'bottom',splitter:true"</strong></span>
<span class="strong"><strong>         style="height:21px;"&gt;</strong></span>
      &lt;span&gt;Courtesy of the Y2K Society&lt;/span&gt;
    <span class="strong"><strong>&lt;/div&gt;</strong></span>
  <span class="strong"><strong>&lt;/div&gt;</strong></span>
&lt;/body&gt;</pre></div><p>Since the <a id="id333" class="indexterm"/>client wanted a place to add multiple functions, including our census search, we'll add a location for buttons in the upperright-handcorner. We'll create a button containing <code class="literal">&lt;div&gt;</code>, and insert our census button as a <code class="literal">dijit/form/Button</code> module. Using the <code class="literal">dijit</code> button will ensure that the styling of the part will go along with the styling of the widget. Here is an example:</p><div class="informalexample"><pre class="programlisting">&lt;div id="header" 
  data-dojo-type="dijit/layout/ContentPane"
  data-dojo-props="region:'top',splitter:true"&gt;
    &lt;h1&gt;Year 2000 Map&lt;/h1&gt;
    <span class="strong"><strong>&lt;div id="buttonbar"&gt;</strong></span>
<span class="strong"><strong>      &lt;button data-dojo-type="dijit/form/Button"</strong></span>
<span class="strong"><strong>        id="census-btn" &gt;Census&lt;/button&gt;</strong></span>
<span class="strong"><strong>    &lt;/div&gt;</strong></span>
&lt;/div&gt;</pre></div><p>To make the files work, we'll need to add a link to the main script file we'll run for our app. We'll insert the <code class="literal">app.js</code> file as the last element inside the <code class="literal">&lt;body&gt;</code> tag, so that loading the file doesn't cause the browser to block other downloads. In the following code, you can see where we insert this:</p><div class="informalexample"><pre class="programlisting">      &lt;span&gt;Courtesy of the Y2K Society&lt;/span&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  <span class="strong"><strong>&lt;script type="text/javascript" src="js/app.js"&gt;&lt;/script&gt;</strong></span>
&lt;/body&gt;</pre></div><p>Within the <code class="literal">app.js</code> file, we're going to do just enough to get the visuals. We'll add to this file as we go. We'll start with our normal <code class="literal">require()</code> statement, loading the modules for the <code class="literal">BorderContainer</code>, <code class="literal">ContentPane</code>, and <code class="literal">Button</code> elements. We'll also pull in a module called <code class="literal">dojo/parser</code>, which will parse the Dojo data-markup in the HTML and turn it into application widgets. The code will be as follows:</p><div class="informalexample"><pre class="programlisting">require([
  "dojo/parser",
  "dijit/layout/ContentPane", 
  "dijit/layout/BorderContainer", 
  "dijit/form/Button",
  "dojo/domReady!"
], function(
  parser
) {
  parser.parse();
});</pre></div><p>After all <a id="id334" class="indexterm"/>that work, our HTML should look something like the following:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE HTML&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;
    &lt;meta http-equiv="X-UA-Compatible" content="IE=Edge" /&gt;
    &lt;meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" /&gt;
    &lt;title&gt;Y2K Map&lt;/title&gt;
    &lt;link rel="stylesheet" href="http://js.arcgis.com/3.13/dijit/themes/nihilo/nihilo.css"&gt;
    &lt;link rel="stylesheet" href="https://js.arcgis.com/3.13/esri/css/esri.css" /&gt;
    &lt;link rel="stylesheet" href="css/y2k.css" /&gt;
    &lt;script src="https://js.arcgis.com/3.13/"&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body class="nihilo"&gt;
    &lt;div id="mainwindow" data-dojo-type="dijit/layout/BorderContainer"
      data-dojo-props="design:'headline',gutter:false, liveSplitters: true"
      style="width: 100%; height: 100%; margin: 0;"&gt;
        &lt;div id="header" 
          data-dojo-type="dijit/layout/ContentPane"
          data-dojo-props="region:'top',splitter:true"&gt;
          &lt;h1&gt;Year 2000 Map&lt;/h1&gt;
          &lt;div id="buttonbar"&gt;
            &lt;button id="census-btn" data-dojo-type="dijit/form/Button"&gt;Census&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div id="map" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center',splitter:true"&gt;
          &lt;div id="census-widget"&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div id="footer"
          data-dojo-type="dijit/layout/ContentPane" 
          data-dojo-props="region:'bottom',splitter:true"
             style="height:21px;"&gt;
        &lt;span&gt;Courtesy of the Y2K Society&lt;/span&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;script type="text/javascript" src="js/app.js"&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div></div></div><div class="section" title="Styling our application"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec55"/>Styling our application</h2></div></div></div><p>If we run <a id="id335" class="indexterm"/>the application at this point, it won't look quite as expected. In fact, it'll look a lot like a white screen. That is because we haven't assigned a size to our page yet. In this case, the <code class="literal">ContentPane</code> tile styling creates positioned-looking panels, and absolute positioning takes the content out of the calculated page flow. Since there was nothing else to fill the height of the body, it collapsed to zero height.</p><p>A quick remedy to this issue is to update the styling of the HTML and the body tag. Open up <code class="literal">y2k.css</code> in your text editor and add the following lines of CSS:</p><div class="informalexample"><pre class="programlisting">html, body {
  border: 0;
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  font-size: 14px;
}</pre></div><p>This CSS we applied makes the page fill up 100 percent of our browser window. Adding the border, margin, and padding takes away any possible formatting that different browsers may insert into the page. We added the font size because it's good practice to set the font size in pixels at the body level. Further font size assignments can be made relative to this, using the <code class="literal">em</code> unit.</p><p>If you play your page now, you should see the following output:</p><div class="mediaobject"><img src="graphics/6459OT_03_03.jpg" alt="Styling our application" width="449" height="372"/></div><p>It's <a id="id336" class="indexterm"/>definitely progress, but we need to fulfil the other requirements of the application. First, the <code class="literal">#buttonbar</code> element would look better if we positioned it precisely in the top-right, and left a little gap for the <span class="strong"><strong>Census</strong></span> button to be centered vertically. Next, we'll add some yellow hues to the different panels, and round off the corners of the header and footer. We'll end up with the following stylized shell for our application:</p><div class="mediaobject"><img src="graphics/6459OT_03_04.jpg" alt="Styling our application" width="447" height="370"/></div><p>To<a id="id337" class="indexterm"/> make this happen, here's the CSS we'll add to our <code class="literal">y2k.css</code>:</p><div class="informalexample"><pre class="programlisting">h1 {
  margin: 2px 8px;
  display: inline-block;
  *display: inline; /* IE 7 compatible */
  zoom: 1; /* IE 7 compatible */
}

#buttonbar {
  position: absolute;
  top: 10px;
  right: 15px;
  width: auto;
  height: auto;
}

#mainwindow,
#mainwindow .dijitSplitter {
  background: #fffaa9; /* paler yellow */
}

#header, #footer {
  -moz-border-radius: 5px;
  -webkit-border-radius: 5px;
  border-radius: 5px;
  border: 1px solid #6f6222; 
}

#header { background: #ffec50; /* bold yellow */ }

#footer { background: #d0a921; /* darker yellow */ }</pre></div></div><div class="section" title="Adding our custom package"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec56"/>Adding our custom package</h2></div></div></div><p>Before we<a id="id338" class="indexterm"/> can use our custom package, we need to tell Dojo where it is. To do that, we'll need to add a <code class="literal">dojoConfig</code> object before we load the ArcGIS JavaScript API. In the <code class="literal">dojoConfig</code> object, we'll add a package array object, and tell it that the <code class="literal">y2k</code> modules are in the <code class="literal">js</code> folder. The script should look something like this:</p><div class="informalexample"><pre class="programlisting">&lt;link rel="stylesheet" href="css/y2k.css" /&gt;
&lt;script type="text/javascript"&gt;
  dojoConfig = {
    packages: [
      {
        name: 'y2k',
        location: location.pathname.replace(/\/[^\/]*$/, '') + 
          '/js'
      }
    ]
  };
&lt;/script&gt;
&lt;script src="https://js.arcgis.com/3.13/"&gt;&lt;/script&gt;</pre></div></div><div class="section" title="Setting up our app"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec57"/>Setting up our app</h2></div></div></div><p>Now we need to<a id="id339" class="indexterm"/> set up our application script and get things moving. We'll open our <code class="literal">app.js</code> file and add the functionality for our map and our upcoming <code class="literal">Census</code> widget. We'll start by adding references to the <code class="literal">esri/map</code> module and our <code class="literal">y2k/Census</code> widget. We'll initialize our map just as we did in <a class="link" href="ch01.html" title="Chapter 1. Your First Mapping Application">Chapter 1</a>, <span class="emphasis"><em>Your First Mapping Application</em></span>, and we'll create a new <code class="literal">Census</code> widget. Following the pattern of many dojo widgets, the <code class="literal">Census</code> widget constructor will take an options object for the first parameter, and a string reference to an HTML node within the <code class="literal">&lt;div&gt;</code> map as the second argument. We'll fill in the options later:</p><div class="informalexample"><pre class="programlisting">require([
  "dojo/parser",
<span class="strong"><strong>  "esri/map", "y2k/Census",</strong></span>
  "dijit/layout/ContentPane", 
   …
], function(
  parser, <span class="strong"><strong>Map, Census</strong></span>
) {
  parser.parse();

  <span class="strong"><strong>var map = new Map("map", {</strong></span>
<span class="strong"><strong>    basemap: "national-geographic",</strong></span>
<span class="strong"><strong>    center: [-95, 45],</strong></span>
<span class="strong"><strong>    zoom: 3</strong></span>
<span class="strong"><strong>  });</strong></span>

<span class="strong"><strong>  var census = new Census({ }, "census-widget");</strong></span>

});</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>Perhaps you<a id="id340" class="indexterm"/> are wondering why some of the modules in our code start with capital letters, while others do not. Common JavaScript coding convention states that object constructors start with capital letters. The <code class="literal">Map</code> and <code class="literal">Census</code> modules make maps and census widgets, therefore they should be capitalized. Why the reference to the <code class="literal">esri/map</code> module isn't capitalized is a mystery, and a source of errors if you get it wrong.</p></div></div></div><div class="section" title="Coding our widget"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec58"/>Coding our widget</h2></div></div></div><p>We need to start <a id="id341" class="indexterm"/>piecing together our Census widget. To do that, we'll use what we've learned about creating custom widgets from earlier in the chapter. Within the <code class="literal">Census.js</code> file, we'll create a shell widget using the <code class="literal">define()</code>, <code class="literal">declare()</code>, and <code class="literal">_WidgetBase</code> modules. It should look something like the following code:</p><div class="informalexample"><pre class="programlisting">define([
  "dojo/_base/declare", 
  "dijit/_WidgetBase"
], function ( declare, _WidgetBase ) {
  return declare([_WidgetBase], { });
});</pre></div><p>For our widget, we'll want a template that instructs the user how to use the tool. It might also be a good idea to let the user close the tool, since we don't want the map to be cluttered with multiple tools:</p><div class="informalexample"><pre class="programlisting">define([
  "dojo/_base/declare", 
  "dijit/_WidgetBase", <span class="strong"><strong>"dijit/_TemplatedMixin", </strong></span>
<span class="strong"><strong>  "dijit/_OnDijitClickMixin"</strong></span>], 
function (declare, _WidgetBase<span class="strong"><strong>, _TemplatedMixin, </strong></span>
<span class="strong"><strong>  _OnDijitClickMixin</strong></span>) {
  return declare([_WidgetBase, <span class="strong"><strong>_TemplatedMixin, _OnDijitClickMixin</strong></span>], { });
});</pre></div><p>At this<a id="id342" class="indexterm"/> point, we need to load our template into our widget. To do that, we're going to implement another dojo module called <code class="literal">dojo/text</code>.</p><div class="section" title="Adding some dojo/text!"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec48"/>Adding some dojo/text!</h3></div></div></div><p>The <code class="literal">dojo/text</code> module lets <a id="id343" class="indexterm"/>the module download any sort of text file as a string. The contents can be HTML, text, CSV, or any related text-based file. When loading the file using AMD, the format is as follows:</p><div class="informalexample"><pre class="programlisting">require([…, "dojo/text!<span class="strong"><strong>path/filename.extension</strong></span>", …], 
function (…, <span class="strong"><strong>textString</strong></span>, …) {…});</pre></div><p>In the preceding example, the <code class="literal">filename.extension</code> describes the file name, such as <code class="literal">report.txt</code>. The path shows the location of the file in relationship to the script. So a path of <code class="literal">./templates/file.txt</code> means that the file is located in the <code class="literal">templates</code> folder, which is a subfolder of the folder where this widget script has been located.</p><p>The exclamation point in our declaration means that the module has a plugin attribute that can automatically be called on load time. Otherwise, we would have to wait and call it after the module loaded in our script. Another module where we see this is <code class="literal">dojo/domReady</code>. The exclamation point activates that module, pausing our application until the HTML DOM is ready as well.</p><p>Getting back to our application, it's time to load our dijit template. The <code class="literal">_TemplatedMixin</code> module provides a property called <code class="literal">templateString</code>, which it reads from to build the HTML portion of the <code class="literal">dijit</code> package. We'll use the <code class="literal">dojo/text</code> module to load HTML from our <code class="literal">Census.html</code> template, then insert the string created from that into the <code class="literal">templateString</code> property. It should look something like this:</p><div class="informalexample"><pre class="programlisting">define([
  …
  "dijit/_OnDijitClickMixin",
  <span class="strong"><strong>"dojo/text!./templates/Census.html"</strong></span>
], function (…, _OnDijitClickMixin, <span class="strong"><strong>dijitTemplate</strong></span>) {
  return declare([…], {
    <span class="strong"><strong>templateString: dijitTemplate </strong></span>
  });
});</pre></div></div><div class="section" title="Our dijit template"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec49"/>Our dijit template</h3></div></div></div><p>For our<a id="id344" class="indexterm"/> template, we're going to take advantage of a few cool tricks in Dojo. The first trick is that we can mix property values into our widget through the same substitute templating we learned about in <a class="link" href="ch01.html" title="Chapter 1. Your First Mapping Application">Chapter 1</a>, <span class="emphasis"><em>Your First Mapping Application</em></span>. Second, we're going to take advantage of the <code class="literal">_OnDijitClickMixin</code> module to handle click events.</p><p>For our template, we're looking at creating something with a title (such as "Census"), some instructions, and a <code class="literal">close</code> button. We'll assign a close button event handler through the <code class="literal">data-dojo-attach-event</code> attribute using <code class="literal">ondijitclick</code>. We'll also assign a <code class="literal">baseClass</code> attribute from the widget to the CSS classes in the widget. If you haven't created the <code class="literal">Census.html</code> file in your <code class="literal">template</code> folder, do so now. Then, enter the following HTML content:</p><div class="informalexample"><pre class="programlisting">&lt;div class="<span class="strong"><strong>${baseClass}</strong></span>" style="display: none;"&gt;
  &lt;span class="<span class="strong"><strong>${baseClass}</strong></span>-close" 
    <span class="strong"><strong>data-dojo-attach-event="ondijitclick:hide"</strong></span>&gt;X&lt;/span&gt;
  &lt;b&gt;Census Data&lt;/b&gt;&lt;br /&gt;
  &lt;p&gt;
    Click on a location in the United States to view the census 
    data for that region.
  &lt;/p&gt;
&lt;/div&gt;</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip13"/>Tip</h3><p>What errors in the template could possibly cause the widget not to load? If you are incorporating events, through the <code class="literal">data-dojo-attach-event</code> parameter, make sure the callback function in the template matches the name of the callback function in your dijit. Otherwise, the dijit will fail to load.</p></div></div><p>Back in <a id="id345" class="indexterm"/>our code, we'll assign a <code class="literal">baseClass</code> property, as well as functions for <code class="literal">hide()</code> and <code class="literal">show()</code>. Many dijits use those functions to control their visibility. Through those functions, we'll set the display style attribute to either <code class="literal">none</code> or <code class="literal">block</code>, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">define([…, "dojo/dom-style"], 
function (…, domStyle) { …
{
  baseClass: "y2k-census",

  show: function () {
    domStyle.set(this.domNode, "display", "block");
  },

  hide: function () {
    domStyle.set(this.domNode, "display", "none");
  }
});</pre></div></div><div class="section" title="Working with the dijit constructors"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec50"/>Working with the dijit constructors</h3></div></div></div><p>We'll need to<a id="id346" class="indexterm"/> add onto the <code class="literal">dijit</code> constructor function, but first we need to think about what this dijit needs. Our original purpose for the dijit was to let the user click on the map and identify census locations. So, we'll need a map, and since we're identifying something, we'll need to supply a map service URL to the constructor of the <code class="literal">IdentifyTask</code> object.</p><p>Following the trends of most <code class="literal">dijit</code> constructors, our <code class="literal">dijit</code> constructor will accept an options object, and either an HTML DOM node, or a string <code class="literal">id</code> for that node. In the options object, we'll look for a map, and a <code class="literal">mapService</code> URL. The second argument in the constructor will be assigned as the dijit's <code class="literal">domNode</code>, or if it's a string, the appropriate node will be found based off the string.</p><p>For our constructor, we'll incorporate the map into the widget, and turn the <code class="literal">mapService</code> into an <code class="literal">IdentifyTask</code>. We'll also add the <code class="literal">dojo/dom</code> module to provide a shortcut for the common JavaScript operation <code class="literal">document.getElementById()</code>, and use that to transform a string <code class="literal">id</code> into a DOM element:</p><div class="informalexample"><pre class="programlisting">define([…, <span class="strong"><strong>"dojo/dom"</strong></span>, "esri/tasks/IdentifyTask", …], 
function (…, <span class="strong"><strong>dom</strong></span>, IdentifyTask, …) {
  …
  constructor: function (options, srcRefNode) {

      if (typeof srcRefNode === "string") {
        srcRefNode = dom.byId(srcRefNode)
      }

      This.identifyTask = new IdentifyTask(options.mapService);
      this.map = options.map || null;
      this.domNode = srcRefNode;
    },
  …
});</pre></div></div><div class="section" title="Reusing our old code"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec51"/>Reusing our old code</h3></div></div></div><p>Looking <a id="id347" class="indexterm"/>back at <a class="link" href="ch01.html" title="Chapter 1. Your First Mapping Application">Chapter 1</a>, <span class="emphasis"><em>Your First Mapping Application</em></span>, we were able to check out the map, click on it, and get some results. Wouldn't it be great if we could reuse some of that code? Well, with a few changes, we can reuse a lot of our code.</p><p>The first thing we need to tackle is assigning our map click event. Since we don't get to do it all the time, the most logical time to assign the map click event is when our dijit is visible. We'll modify our show and hide functions so that they assign and remove the click handler, respectively. We'll name the map-click event handler <code class="literal">_onMapClick()</code>. We're also going to load the module <code class="literal">dojo/_base/lang</code>, which helps us with objects. We'll use the <code class="literal">lang.hitch()</code> function to reassign a function's <code class="literal">this</code> statement:</p><div class="informalexample"><pre class="programlisting">define([…, <span class="strong"><strong>"dojo/on"</strong></span>, <span class="strong"><strong>"dojo/_base/lang"</strong></span>, …], 
function (…, <span class="strong"><strong>dojoOn</strong></span>, <span class="strong"><strong>lang</strong></span>, …) {
  …
    show: function () {
      domStyle.set(this.domNode, "display", "block");
      <span class="strong"><strong>this._mapClickHandler = this.map.on("click", lang.hitch(this, this._onMapClick));</strong></span>
    },

    hide: function () {
      domStyle.set(this.domNode, "display", "none");
      <span class="strong"><strong>if (this._mapClickHandler &amp;&amp; this._mapClickHandler.remove) {</strong></span>
<span class="strong"><strong>        this._mapClickHandler.remove();</strong></span>
<span class="strong"><strong>      }</strong></span>
    },

    _mapOnClick: function () {}
  …</pre></div><p>As a side note, while JavaScript doesn't support private variables, the typical naming convention for JavaScript objects states that, if a property or method starts with an underscore (<code class="literal">_</code>) character, it's considered private by the developer.</p><p>In our<code class="literal">_onMapClick()</code> method, we'll <a id="id348" class="indexterm"/>reuse the click event code from <a class="link" href="ch01.html" title="Chapter 1. Your First Mapping Application">Chapter 1</a>, <span class="emphasis"><em>Your First Mapping Application</em></span>, with a few notable exceptions. Remember now that we're not referencing the map as a variable, but as a property of the widget. The same thing is true for the <code class="literal">IdentifyTask</code>, and any other methods we may call in this dijit. To refer to properties and methods within a method, the variable must be preceded by <code class="literal">this</code>. In this case, this will refer to the widget, which we made sure of when we used the <code class="literal">dojo/_base/lang</code> library on the <code class="literal">_onMapClick()</code> call. If your application fails at the map click event, it's probably because you didn't properly assign the variable with the correct <code class="literal">this</code> context:</p><div class="informalexample"><pre class="programlisting">define([…, <span class="strong"><strong>"esri/tasks/IdentifyParameters"</strong></span>, …], 
function (…,<span class="strong"><strong>IdentifyParameters</strong></span>, …) {
  …
    _onMapClick: function (event) {
      var params = new IdentifyParameters(),
        defResults;

      params.geometry = event.mapPoint;
      params.layerOption = IdentifyParameters.LAYER_OPTION_ALL;
      params.mapExtent = <span class="strong"><strong>this</strong></span>.map.extent;
      params.returnGeometry = true;
      params.width = <span class="strong"><strong>this</strong></span>.map.width;
      params.height= <span class="strong"><strong>this</strong></span>.map.height;
      params.spatialReference = this.map.spatialReference;
      params.tolerance = 3;

      <span class="strong"><strong>this</strong></span>.map.graphics.clear();
      defResults = <span class="strong"><strong>this</strong></span>.identifyTask.execute(params).addCallback (lang.hitch(this, <span class="strong"><strong>this</strong></span>._onIdentifyComplete));
      <span class="strong"><strong>this</strong></span>.map.infoWindow.setFeatures([defResults]);
      <span class="strong"><strong>this</strong></span>.map.infoWindow.show(event.mapPoint);
    },
  …</pre></div></div><div class="section" title="Loading more templates"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec52"/>Loading more templates</h3></div></div></div><p>The Y2K society <a id="id349" class="indexterm"/>had requested that we display the popups as something more organized and logical. In our web developer minds, nothing screams organized data more than a table. We can set up and organize tables for our templates, but creating those long strings to organize a long list of results would be daunting. Having HTML strings in our JavaScript code would be a pain to edit, since most IDEs and syntax-highlighting text editors don't highlight HTML in our JavaScript.</p><p>But then we remember that we can load HTML into our JavaScript using the <code class="literal">dojo/text</code> module. If we define the content of our <code class="literal">InfoTemplates</code> using little HTML snippets, and load them using <code class="literal">dojo/text</code>, the process will be much more streamlined:</p><div class="informalexample"><pre class="programlisting">define([…, 
  <span class="strong"><strong>"dojo/_base/array", </strong></span>
<span class="strong"><strong>  "esri/InfoTemplate",</strong></span>
<span class="strong"><strong>  "dojo/text!./templates/StateCensus.html",</strong></span>
<span class="strong"><strong>  "dojo/text!./templates/CountyCensus.html",</strong></span>
<span class="strong"><strong>  "dojo/text!./templates/BlockGroupCensus.html",</strong></span>
<span class="strong"><strong>  "dojo/text!./templates/BlockCensus.html"</strong></span>
], 
function (…,
  <span class="strong"><strong>arrayUtils, InfoTemplate, StateTemplate, CountyTemplate, BlockGroupTemplate, BlockTemplate</strong></span>) {

    _onIdentifyComplete: function (results) {

      return arrayUtils.map(results, function (result) {
        var feature = result.feature,
          title = result.layerName,
          content;

        switch(title) {
          case "Census Block Points":
            content = BlockTemplate;
            break;
          case "Census Block Group":
            content = BlockGroupTemplate;
            break;
          case "Detailed Counties":
            content = CountyTemplate;
            break;
          case "states":
            content = StateTemplate;
            break;
          default:
            content = "${*}";
        }

        feature.infoTemplate = new InfoTemplate(title, content);
        return feature;
      });
    }
  });
});</pre></div><p>I'll leave the <a id="id350" class="indexterm"/>contents of the HTML <code class="literal">infoTemplates</code> up to you as an exercise.</p></div><div class="section" title="Back to our app.js"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec53"/>Back to our app.js</h3></div></div></div><p>We didn't forget <a id="id351" class="indexterm"/>about our <code class="literal">app.js</code> file. We stubbed out the code for loading the map and the <code class="literal">Census</code> dijit, but we didn't assign anything else. We need to assign a click event handler for <code class="literal">Census</code> button to toggle the visibility of the <code class="literal">Census</code> widget. For that, we'll use the <code class="literal">dijit/registry</code> module to load the <code class="literal">dijit</code> button from its <code class="literal">id</code>. We'll load the map and the <code class="literal">mapService</code> for the <code class="literal">Census</code> dijit, and add an event listener to the <code class="literal">Census</code> button click event that will show the <code class="literal">Census</code> widget. We'll use the <code class="literal">dojo/_base/lang</code> module again to make sure the <code class="literal">Census.show()</code> function is properly applied to the <code class="literal">Census</code> dijit:</p><div class="informalexample"><pre class="programlisting">require([
  …
<span class="strong"><strong>  "dojo/_base/lang",</strong></span>
<span class="strong"><strong>  "dijit/registry",</strong></span>
   …
], function(
   … <span class="strong"><strong>lang, registry</strong></span>, …
) {
  …
  var census = new Census({
   <span class="strong"><strong> map: map,</strong></span>
<span class="strong"><strong>    mapService: "http://sampleserver6.arcgisonline.com/arcgis/rest/services/Census/MapServer/"</strong></span>
  }, "census-widget");
  
  <span class="strong"><strong>var censusBtn = registry.byId("census-btn");</strong></span>
<span class="strong"><strong>  </strong></span>
<span class="strong"><strong>  censusBtn.on("click", lang.hitch(census, census.show));</strong></span>

});</pre></div><p>When we run <a id="id352" class="indexterm"/>our code, it should look something like the following:</p><div class="mediaobject"><img src="graphics/6459OT_03_05.jpg" alt="Back to our app.js" width="667" height="499"/></div></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec40"/>Summary</h1></div></div></div><p>Over the course of this chapter, we have learned about many of the features offered by the Dojo framework, which is packaged with the ArcGIS API for JavaScript. We've learned about the three major packages in Dojo, and how to use them to create applications. We learned how to create our own modules, and we modified an existing application to make a module that could be imported into any application.</p><p>In the next chapter, we will learn how the ArcGIS API for JavaScript communicates with ArcGIS Server through REST services.</p></div></div></div></body></html>