# 第六章. 使用可视性分析回答问题

可视性分析是 GIS 分析中的一个宝贵部分，它回答了诸如“从这个位置点可以看到什么？”等问题。在本章中，您将通过定义提供该区域最佳景观视角的屋顶以及潜在观景平台的位置，接触到可视性分析的基本知识。在整个章节中，您将学习以下内容：

+   准备数据以表示城市景观特征

+   选择潜在的观测点

+   计算可视域以找到最美丽的点

+   在 3D 场景中展示结果

在我们开始之前，我们将探讨一些可视性分析的基本原则。

# 可视性分析的基本原理

可视性分析的目标是从指定位置生成一个可见区域的覆盖。这个覆盖称为**可视域**，这就是为什么使用**可视性分析**和**可视域分析**这两个术语可以互换的原因。要执行简单的可视性分析，您至少需要定义以下两个组件：

+   **观测点**：代表观察者位置且正在分析可视性的点

+   **DEM**：这代表地球表面的不规则性，并用于检查视线方向上的可视性

这种分析背后的思想是将观测点的海拔高度与给定视线方向上的地球表面点的海拔高度进行比较。如果表面点的海拔低于观测点，则从当前位置可以看到它；如果它更高，则可视线路径将被阻挡。同样，所有在一定半径内的点都与观测点进行比较，并分为以下两类：

+   可见，高度低于观测高度且位于可视线下方

+   不可见，高度高于观测高度且位于可视线上方

可视性分析的主要输出是一个二元真/假可视域覆盖，通常包括可见点并排除不可见点。根据所使用的算法和 GIS 的能力，可以通过以下特性和输出修改和改进这种基本分析方法：

+   与单一观测点不同，可以使用多个点甚至线条

+   可以分析几个物体之间的可视关系，然后生成互视覆盖作为输出

+   相反，对于当前观测点的可视域评估，可以分析地球表面以提供有关可以从特定位置看到某些物体的点和区域的信息

+   地平线线可以建模为可视区域累积边缘

+   视野可以由水平或垂直视角或方位值限制，这些值限制了可视线的延伸

+   地球的曲率和大气折射可以考虑到模拟更真实的结果

可视性分析最典型的实际应用是在通信塔的放置中，而不是可视性，而是模拟信号穿透。视域在领土和城市规划中也非常有用。例如，一些特征，如工厂或垃圾填埋场，由于外观不雅，预计将不会被人眼看到。在这种情况下，该区域将进行可视性分析，以找到无法看到这类物体的地方。与某个点相关的盲点越多，对物体的位置就越有利。此外，除了隐藏某些物体外，视域还用于检测提供该区域最壮观景观的景观点。然后，这种知识被用于最佳放置观景点，这正是我们将在本章中要做的。

# 第 1 步 – 将建筑矢量图层转换为栅格

我们将处理一个高度城市化的景观，其主要特征已经受到人类的极大改造。在可视性分析的情况下，这意味着视线主要被建筑物阻挡，而原始的地形特征只扮演了较小的角色。在我们的数据集中，我们有两个图层描述感兴趣的区域、外观和特征：

+   `lidar_dem`：这仅代表裸地，并提供了地形的一般描述

+   `building_footprints`：这些是多边形，描绘了所有建筑物，并且它们还包含有关建筑物在裸地表面以上英尺高度的信息，这些信息存储在 `height_roo` 属性字段中

我们需要添加它们的值以获得有意义的结果，但这些图层使用不同的数据模型：DEM 是栅格覆盖，而建筑足迹是矢量多边形图层。这就是为什么在添加之前，我们应该首先将图层转换为单一的共同数据模型。在 GIS 中，覆盖物的计算通常使用栅格代数进行，这意味着 `building_footprints` 矢量图层应该转换为栅格，或者进行栅格化。此外，如果我们想使这个栅格层包含有关建筑高度的数据，应使用 `height_roo` 属性字段作为 *Z* 值的提供者。

同样重要的是，新建建筑足迹的栅格应该与 `lidar_dem` 具有相同的范围和分辨率。要获取有关 `lidar_dem` 的这些信息，请转到 **图层属性** | **元数据**。在窗口底部，您将看到 **属性** 滚动窗口部分，其中包含所有重要的信息，以便与栅格一起工作，即 **波段 1**（统计数据）、**维度**（行数和列数）、**原点**（左下角的坐标）等等。对我们特别感兴趣的参数如下：

+   **像素大小**：这包含像素边的垂直和水平长度。通常，这些值相等，这意味着像素是正方形；但有时，它可以是矩形，具有不等的值。

+   **图层范围（图层原始源投影）**：这表示栅格范围的水平和垂直（*x*）和垂直（*y*）的最小和最大值，即栅格边界框在图层原始坐标参考系统中的北部、南部、东部和西部限制。

下面的截图显示了`lidar_dem`层所描述的参数：

![步骤 1 – 将建筑矢量图层转换为栅格](img/image00442.jpeg)

要将图层栅格化，请转到**栅格** | **转换** | **栅格化（矢量到栅格）**。在对话框窗口中，调整以下参数：

1.  **输入文件（shapefile）**：这是一个要栅格化的 shapefile。从下拉列表中选择`building_footprints`。

1.  **属性字段**：这定义了一个要烧录到输出栅格中的值属性字段。从下拉列表中选择`HEIGHT_ROO`。

1.  **输出栅格化矢量文件（栅格）**：在此字段中有两个可能的选项。您可以选择一个已存在的文件，并且具有所选值的矢量几何足迹补丁将被烧录到其中。如果您例如有一些原始栅格层中的空隙，并希望用矢量层中的某些值（如水体的高程和水面）填充它们，这将非常方便。但我们必须处理建筑物相对于裸地面的相对高度。这意味着，为了与 DEM 汇总，建筑物足迹应作为单独的图层进行栅格化。导航到您的工作目录，并输入`building.tif`作为新的图层名称。您将看到此消息：**输出文件不存在。您必须设置输出大小或分辨率才能创建它**。单击**确定**并继续到下一阶段：![步骤 1 – 将建筑矢量图层转换为栅格](img/image00443.jpeg)

1.  在前面的步骤中，您定义了一些主要选项。由于我们需要创建一个与`lidar_dem.tif`具有完全相同范围和分辨率的栅格，我们将通过编辑`gdal_rasterize`命令行参数使用高级选项：

    1.  单击**编辑**![步骤 1 – 将建筑矢量图层转换为栅格](img/image00444.jpeg)按钮以使线条可编辑。所有先前的选项都将被禁用并变灰。

    1.  删除`–ts 3000 3000`选项，因为我们将指定一个分辨率参数，这使得由`–ts`定义的栅格宽度和高度参数变得没有意义。

    1.  `–init 0`参数定义了输出栅格的初始值。它创建一个具有预先定义值的空栅格，然后矢量值被烧录到其中。在我们的情况下，这意味着无建筑区域将被分配为零值。

    1.  目标范围由`–te`参数定义，该参数使用地理参照单位中的空格分隔的边界框值（**Xmin**、**Ymin**、**Xmax**和**Ymax**）描述。如果您想使用预定义的范围，只需从相应的栅格元数据中复制其值。别忘了将逗号和分号替换为空格。

    1.  目标分辨率（`–tr`）参数定义了以图层 CRS 指定的单位表示的垂直和水平像素大小。

    1.  输出数据类型由`–ot`参数定义，其默认值为`Float64`，但我们将其替换为`Float32`，这与`lidar_dem.tif`相同。

生成的行将如下所示：

```py
gdal_rasterize -a HEIGHT_ROO -l building_footprints -init 0 -te 982199.3000000000465661 188224.6749999999883585 991709.3000000000465661 196484.6749999999883585 -tr 10 10 -ot Float32 fullpath/building_footprints.shp fullpath/building.tif

```

### 注意

要将矢量转换为栅格，我们使用了来自**地理空间数据抽象库**（**GDAL**）的名为`gdal_rasterize`的工具。您可以从[`www.gdal.org/gdal_rasterize.html`](http://www.gdal.org/gdal_rasterize.html)阅读`gdal_rasterize`参数及其值的扩展说明。

点击**确定**后，生成的栅格将被创建并添加到地图画布上。如果您选择**识别特征**工具并点击任何像素，将显示建筑的高度值；如果您点击空白区域，将显示`0`。该图层看起来将与以下截图相似：

![步骤 1 – 将建筑矢量图层转换为栅格](img/image00445.jpeg)

# 步骤 2 – 合并 DEM 和建筑图层

现在，我们需要通过添加它们的值将两个图层合并为单个图层。**栅格代数**是叠加栅格层（或多个层）的常用方法，通过代数运算（加法、减法、乘法、除法等）组合它们的值，并计算新栅格层的值。现代 GIS 软件使用所谓的栅格计算器，有助于创建、验证和应用栅格代数表达式到栅格数据集中。

QGIS 还有一个位于**栅格** | **栅格计算器**的自己的栅格计算器。**计算器**对话框窗口由以下部分组成：

+   **栅格波段**：在窗口的左上角，您可以查看项目中所有可用栅格的列表。栅格波段号通过`@`符号与其名称分开。如果图层是单波段栅格，则列表中只出现`name@1`，但如果它是多波段栅格，则对于每个波段将分别显示`name@1`、`name@2`，等等，直到`name@n`（其中*n*是多波段栅格中的波段总数）。

+   **结果图层**：在计算器窗口的右上角，您可以调整输出栅格属性。**当前图层范围**按钮从左侧**栅格波段**列表中当前选定的栅格图层设置输出范围。当您处理具有不同范围的图层时，这非常有用，并允许您决定使用哪个范围。

+   **运算符**：在窗口的中央部分，有各种运算符按钮，可以用来构建表达式。点击相关按钮添加运算符，或者手动输入。

+   **栅格计算器表达式**：在计算器的底部部分，有一个表达式窗口，其中显示了要使用的计算公式。双击相关图层将其添加到表达式中（它将以双引号显示）。请注意，对于表达式，我们只输入计算公式的右侧，即等于号之后的部分。在表达式下方，您将看到**表达式有效/无效**消息动态更改，这有助于您控制构建公式的正确性。

在以下屏幕截图中，您可以看到我们应用了一个简单的加法公式（`"building@1" + "liadar_dem@1"`）来合并栅格化的建筑高度和 DEM 图层：

![步骤 2 – 合并 DEM 和建筑图层](img/image00446.jpeg)

点击**确定**按钮后，计算将被执行，并在**图层**面板中显示一个新的`urban_surface`栅格图层。现在，我们可以使用**识别特征**工具检查其值 ![步骤 2 – 合并 DEM 和建筑图层](img/image00447.jpeg)：

1.  除了`urban_surface`、`building`和`lidar_dem`之外，取消选中所有不必要的图层。保持它们的顺序简化了**识别结果**的解释。

1.  转到**识别结果**选项卡。从**模式**下拉列表中选择**自上而下**。识别的值将按顺序显示在所有活动图层中，从上到下。

1.  从**视图**下拉列表中选择**表格**。识别的值将被组织成一个简单的表格，如图所示：![步骤 2 – 合并 DEM 和建筑图层](img/image00448.jpeg)

现在，通过点击地图画布上的任何一点，您可以探索值并确保它们已被正确添加。

# 第 3 步 – 定义观测点

观察点在现代城市景观的视觉探索中起着重要作用。通常，它们由一个区域内最高的点表示，提供最壮观的视野。因此，城市中的观景平台通常位于屋顶上。在本节中，我们将通过以下步骤创建一个包含几个潜在观景平台的图层：

1.  创建一个空矢量图层

1.  用代表最高建筑的点填充它

1.  从`buildings_footprint`图层提供高度信息

## 创建一个空矢量图层

要创建一个矢量图层，转到**图层** | **创建图层**。这里有三种选项可用：

+   **新 Shapefile 图层**：也可以通过*Ctrl* + *Shift* + *N*键盘快捷键访问，这会创建一个新的空 shapefile 图层。

+   **新建 SpatiaLite 图层**：也可以通过*Ctrl* + *Shift* + *A*键盘快捷键访问，这将在指定的 SpatiaLite 数据库（默认情况下为当前连接的数据库）内创建一个空的 SpatiaLite 图层。

+   **新建临时擦除图层**：这创建了一个临时图层，可以在工作会话中像任何其他图层一样使用和分析，但如果在关闭项目之前未保存，该图层将消失。这些图层旨在作为草稿，用于测试目的可以防止项目变得杂乱。我们将使用此选项创建一个空图层。

类似地，您可以使用**管理图层**工具栏中的相关按钮以及其旁边的小三角形来访问选项，如图所示：

![创建空矢量图层](img/image00449.jpeg)

在选择**新建临时擦除图层**后，您将看到此对话框：

![创建空矢量图层](img/image00450.jpeg)

考虑**新建临时擦除图层**窗口中的选项，如下所示：

+   **图层名称**：输入一个名称或保留默认设置，因为我们打算将图层用于临时工作，其名称实际上并不重要。

+   **类型**：这定义了几何类型。由于我们将设置观测点，因此默认的**点**选项是合适的。

+   **所选 CRS**：已选择默认投影，但您需要设置项目投影，以便正确处理图层。为此，从下拉组合框中选择**项目 CRS**选项。

点击**确定**后，将在**图层**面板中添加一个**新擦除图层**。默认情况下，图层的编辑模式被激活（您可以在图层名称旁边的标记符号上方看到一个小铅笔，如图所示）。现在我们可以继续到下一阶段，并向其添加一些点。

![创建空矢量图层](img/image00451.jpeg)

## 用点填充图层

如果尚未激活，请激活**数字化**工具栏。您可以通过转到**视图** | **工具栏** | **数字化**，或者简单地通过在工具栏面板上的某处右键单击并激活相关切换来完成此操作。该工具栏包含主要的数字化工具，外观如下：

![用点填充图层](img/image00452.jpeg)

此面板的按钮提供以下选项的访问权限（从左到右）：

+   **当前编辑**：这将在所选图层（或图层组）的当前编辑会话中保持编辑。点击按钮右下角的小黑三角形以访问**保存**、**回滚**或**取消**选项。请注意，这些选项在点击**保存图层编辑**按钮之前都是可用的。

+   **切换编辑**：此按钮激活/停用编辑模式。

+   **保存图层编辑**：此按钮用于保存所有当前编辑而不退出编辑会话。点击此按钮后，无法撤销编辑。如果没有要保存的编辑，则此按钮不可用。

+   **添加要素**：使用此按钮在图层上绘制新的要素。其外观取决于图层的几何类型。目前，它显示为点，因为你正在编辑一个点图层。

+   **移动要素**：当选择此按钮时，你可以移动一个或多个要素。重要的是要注意，如果你打算移动多个要素，它们应该事先被选中。

+   **节点工具**：此工具用于添加、删除或移动几何要素（如线和多边形）的顶点。对于点图层来说是不必要的，因此不可访问。

+   **删除选中项**：这将删除之前选中的要素（或要素）。在保存编辑之前，可以通过**当前编辑**按钮选项撤销这些编辑。

+   **剪切/复制/粘贴要素**：与其他类型的软件类似，你可以使用这些按钮将要素剪切或复制到剪贴板，然后粘贴。如果你想要应用这些选项，要素必须事先被选中。虽然**剪切**和**粘贴**仅在编辑模式下可用，但**复制**可以在任何其他图层中使用，当在图层之间移动要素时非常有用。

    ### 小贴士

    你还可以使用更复杂的数字化工具和选项，例如要素旋转、简化、添加部分和环等。这些工具在**高级数字化**面板中可用，如下面的截图所示：

    ![用点填充图层](img/image00453.jpeg)

    此外，面板还提供了类似于在**计算机辅助设计**（**CAD**）系统中使用的输入工具。这些工具允许使用精确的坐标、距离和角度数值进行数字化；控制线段；平行性和垂直性，如下面的截图所示：

    ![用点填充图层](img/image00454.jpeg)

现在你已经熟悉了**数字化**工具栏、**切换编辑**以及使用**添加要素**，点击不同的地方以定位一些观测点。请记住，这些点应该放在最高建筑的底部。建议使用之前创建的`urban_surface`栅格作为背景，因为它有助于正确定位这些点。现在，通过点击地图画布添加几个点（五到七个就足够了）。点击**切换编辑**按钮退出编辑模式。当被询问编辑时，点击**保存**按钮。结果，你的地图将类似于以下截图：

![用点填充图层](img/image00455.jpeg)

## 提供具有高度值的点

由于我们将在屋顶上定位观测平台，考虑到建筑的高度对于获得逼真的建模结果非常重要。我们不会寻找必要的建筑及其高度并手动将高度值添加到可见性点，而是将自动连接属性，考虑到点的位置。这种操作——当你基于两个不同图层之间的空间关系合并属性时——在 GIS 中非常常见，被称为**空间连接**。

前往**矢量** | **数据管理工具** | **通过位置连接属性**。在对话框窗口中，有以下选项：

+   **目标矢量图层**：将连接属性的图层；在我们的案例中，它是**新临时图层**。

+   **连接矢量图层**：从中提取属性的图层；在我们的案例中，它是`building_footprints`。![提供具有高度值的点](img/image00456.jpeg)

+   **属性摘要**处理可用于连接的多个属性值。**取第一个定位特征的属性**选项连接单个值，这是我们默认选择的行为。可选地，您可以激活**取交集特征的摘要**并选择一个或多个汇总函数（**平均值**、**最小值**、**最大值**等）。

+   **输出 Shapefile**提供了结果矢量图层的路径。点击**浏览**按钮选择必要的目录并输入名称，例如，`观测点`。

+   **输出表**负责结果属性表中的记录数量。我们保留默认选中的**仅保留匹配记录**选项，因为我们只需要与观测点匹配的建筑记录。

点击**确定**并完成空间连接后，您将被告知已创建了一个新图层，并被询问：“您想将新图层添加到目录中吗？”点击**是**，图层将被加载并显示在地图画布上。点击**关闭**按钮退出**通过位置连接属性**对话框。

现在，如果您打开`观测点`属性表，您将看到所有来自`building_footprint`图层中匹配建筑的属性都已连接到这些点。当处理大量实体时，此工具可能非常有用。

# 第 4 步 – 创建视域覆盖

在本节中，我们将应用**视域分析**插件提供的先进可见性分析工具。按照第一章中*通过插件扩展功能*部分所述进行安装，*处理您的数据*。

安装插件后，您可以通过转到**插件** | **视域分析**来访问其功能。**高级视域分析**对话框包含三个选项卡。**常规**选项卡提供对所有可用分析和输出选项的访问。**参考**选项卡包含选项的简要描述以及到项目主页的链接，您可以在那里阅读有关插件中实现的算法的详细信息，并在必要时报告错误。**关于**选项卡包含有关作者和插件主页的简要信息。

在**常规**选项卡下使用以下选项来创建视域覆盖，如图中所示：

+   **高程栅格**：选择`urban_surface`栅格来表示地球表面及其上的建筑物。

+   **观测点**：选择`observ_points`点层。

+   **输出文件**：点击**浏览**按钮，导航到工作目录，并为输出栅格图层输入一个名称。请注意，每个观测点将创建一个输出栅格文件，输入的文件名将用作模板，该模板将与输出覆盖类型（视域、互视、不可视和地平线）和索引号一起使用。因此，我们称输出层为`coverage`，假设解释参数（覆盖类型和点数）将自动添加。

    我们的目标是找到风景最美的点（或多个点），因此没有必要分析点的互视性。因此，省略了**目标点**（互视性）字段。

+   **搜索半径**：这是在图层测量单位（在我们的例子中是英尺）中围绕图层中的点观测的区域大小。值越高，生成覆盖所需的时间越长。接受默认值 5000。

+   **观测者高度**：这定义了观测点相对于地球表面的高度。通常，点越高，观测效果越好。而不是选择预定义的高度，从字段下拉列表中选择`HEIGHT_ROO`。

+   **目标高度**：当您想知道从当前位置是否可以看到特定高度的目标物体时，这是必要的。我们省略了这个选项，因为我们更感兴趣的是一般可见性，而不是特定物体的可见性。

+   **适应距离内的最高点**：此选项在定义的像素区域内找到观测者或目标附近的最高点。当您的观测点提供近似位置，并且需要将它们的高度值调整到周围区域内的最高点时，这可能非常有用。因为我们已经有了精确的高度值，所以此选项将被省略。

+   **输出**：这可以通过以下覆盖表示：

    +   **二值视域**：这是一个简单的栅格覆盖，其中所有像素值都被分配为`0`（不可见）或`1`（可见）。激活此选项以创建视域。

    +   **不可见深度**：这衡量了一个物体在放置在一个看不见的区域时应该达到的大小，以便变得可见。换句话说，它定义了物体在给定半径内变得可见所需的高度单位数。输出栅格是一种倒置的可见性栅格，其中所有可见像素都被分配为 0 值，所有不可见像素都被分配为负高度值（值越低，物体越不可见）。![步骤 4 – 创建视域覆盖](img/image00457.jpeg)

    +   **互视性**：输出将是一个代表观测点之间视觉关系的网络形状文件。在输出网络中，可以相互看见的点被连接起来。

    +   **地平线**：输出栅格覆盖表示地平线或可见区域的边缘。

    可选地，而不是创建多个覆盖，可以创建一个单一的**累积**栅格，该栅格总结了栅格覆盖以概括分析结果。然后，将`0`值分配给不可见像素，将正值分配给可见像素（值越高，表示从多个观测点可见的像素）。

+   **使用地球曲率选项**：这考虑了地球的曲率和光在穿过大气层时的折射效应。激活此选项并接受默认的`0.13`折射值。调整完所有选项后，点击**确定**按钮，等待结果加载到地图画布上。

同样，您可以创建**地平线**单独的覆盖。结果，总共将添加 18 个栅格覆盖到地图画布上：

+   `coverage_N_Binary`：一个二进制可见性栅格，其中*N*是观测点的数量

+   `coverage_N_Horizon`：一个表示点*N*的地平线的栅格

在以下屏幕截图中，您可以查看同一观测点的二进制可见性（在左侧）和地平线（在右侧）覆盖的示例组合：

![步骤 4 – 创建视域覆盖](img/image00458.jpeg)

# 步骤 5 – 寻找景观点

现在，我们应该遍历所有观测点和相应的覆盖，调整它们的可视化选项，并选择提供最佳区域视图的点（或多个点）。

首先，我们需要适当地列举这些点，以便能够区分它们。按照以下步骤进行：

1.  通过右键单击上下文快捷方式从`observ_points`中选择**打开属性表**，或者点击**属性**工具栏中的对应按钮 ![步骤 5 – 寻找景观点](img/image00459.jpeg)。

1.  从表工具栏中选择**打开字段计算器**![步骤 5 – 寻找景观点](img/image00460.jpeg)，或者使用*Ctrl* + *I*键盘快捷键。

1.  在**字段计算器**对话框窗口中，激活**更新现有字段**选项，并确保从下拉列表中选择`OBJECTID`属性字段，如以下截图所示。此字段已包含从`building_footprints`图层合并的值。这些值与点数无关，这就是我们使用更新选项将现有值更改为一致值的原因。

1.  在**表达式**选项卡中，展开包含对记录标识符进行操作的函数的**记录**组。选择并双击要添加到**表达式**窗口的**$id**函数。此函数返回当前行的要素 ID，这将帮助我们正确识别点和相应的覆盖范围。

    点击**确定**按钮。**编辑模式**将自动开启，并更新记录的值。

    ![步骤 5 – 寻找景观点](img/image00461.jpeg)

1.  从**表格**工具栏切换到**编辑模式**![步骤 5 – 寻找景观点](img/image00462.jpeg)或使用*Ctrl* + *E*快捷键退出编辑模式。系统会询问您是否要保存对`observ_points`图层所做的更改。点击**保存**按钮并关闭属性表。

1.  双击`observ_points`图层以打开其**图层属性**对话框窗口。在**标签**部分，激活**使用以下选项标签此图层**选项，并选择`OBJECTID`字段进行标签。如有需要，调整任何其他标签选项，然后点击**确定**以退出窗口。当观测点被标签化后，分析它们及其视域将变得更加容易。

现在，我们将调整可见图层符号以简化其解释。让我们从最基本的地方开始——点号`0`。按照以下步骤以获得有意义的结果：

1.  激活`coverage_0_Horizon`和`coverage_0_Binary`图层，并关闭所有其他可见图层。确保这些图层位于`observ_points`之下。激活在分析可见性时可能感兴趣的任何其他图层（例如，`urban_surface`、`roads`等），并确保它们位于可见栅格之下。

1.  调整`coverage_0_Horizon`图层样式。此图层只包含两个值：`1`代表地平线（即可见区域的边缘），`0`代表所有其他区域。在**图层**面板中双击其名称以打开**图层属性**对话框，转到**样式**部分，并调整以下参数：

    +   从**渲染类型**下拉列表中选择**单波段伪彩色**。

    +   将**颜色插值**设置为**精确**，因为我们只有两个值，希望它们被分配到所选颜色。

    +   使用![步骤 5 – 寻找风景点](img/image00463.jpeg)按钮手动添加必要的值。输入`0`并双击其**颜色**样本。在**更改颜色**窗口中，从**标准颜色**中选择黑色，并使用**不透明度滑块**将透明度设置为`25%`。点击**确定**按钮返回到主要样式选项。

    +   再次添加一行，值为`1`，并为其分配一个明亮、对比度高的颜色，以便在地图上区分地平线线。在**标签**字段中输入值的解释性名称。你的颜色表应该类似于以下截图：

    ![步骤 5 – 寻找风景点](img/image00464.jpeg)

1.  通过双击**图层**面板中的图层名称打开`coverage_0_Binary`属性对话框，并转到**透明度**部分。我们将使用**自定义透明度**选项和**透明像素列表**来根据它们的值调整像素的透明度属性。二值可见性栅格只包含两个值：`1`表示可见区域，`0`表示不可见区域。要将这些值添加到列表中，点击![步骤 5 – 寻找风景点](img/image00463.jpeg)，**手动添加值**按钮。列表中会出现新的一行。在那里，你应该手动输入**从**和**到**的值，并调整或接受默认设置为`100`的**百分比透明度**值。由于我们将使用值而不是范围来设置透明度，**从**和**到**的条目将是相同的：

    +   在第一行，输入`1`并接受 100%的透明度。

    +   再次点击![步骤 5 – 寻找风景点](img/image00463.jpeg)以添加下一行，在**从**和**到**中输入`0`，并将透明度设置为`25%`。结果，你的**透明像素列表**将看起来像这样：

    ![步骤 5 – 寻找风景点](img/image00465.jpeg)在完成所有必要的调整后，点击**确定**按钮以应用它们。

1.  为其他点的图层应用相同的样式选项。而不是逐个处理每个栅格，右键单击并导航到**样式** | **复制样式**以复制从`coverage_0_Horizon`和`coverage_0_Horizon`预先配置的视觉选项。然后，转到**样式** | **粘贴样式**以将它们插入适当的图层。

如果覆盖范围被正确可视化，我们只需要在考虑几个标准后，通过视觉解释它们并做出关于最佳点的决定。首先，一个点应该为广阔的区域提供视野，这可以通过二值覆盖来分析；对观察者开放的面积越多，越好。其次，地平线线应该清晰、坚固，尽可能不被伪影破坏。可见边缘的完整性确保了全景视图，这可以通过地平线覆盖来分析；线条越直、越简单，越好。

最后，您始终应考虑由景点、开放空间和其他可能的兴趣点所代表的本地特征。关于纽约市的布鲁克林区，有几个您可能听说过的显著特征：布鲁克林大桥和布鲁克林大桥公园所在的水域。这个区域以其美丽的日落和令人敬畏的曼哈顿和东河景观而闻名。考虑到所有这些标准，第 7 点可能是最佳选择。它不仅提供了该区域南部和东北部的景观，而且几乎完全包括了水域，如图所示：

![第 5 步 – 寻找风景点](img/image00466.jpeg)

当选择最佳视图的获胜者后，我们可以进行下一步，并可视化分析结果。我们不会以传统的制图方式表示它们，而是将利用三维可视化的力量，这在处理城市景观时非常有用。

# 第 6 步 – 在 3D 中设置结果

在本节中，我们将利用**Qgis2threejs**插件的强大功能，将我们的数据以 3D 场景的形式呈现。按照第一章中“通过插件扩展功能”部分所述，安装此插件，即“处理您的数据”。此插件依赖于`three.js`库。它允许我们直接将地形数据、地图画布图像和矢量数据导出到网页浏览器中。因此，您可以在支持 WebGL 的网页浏览器中查看和探索导出的对象，就像 3D 场景一样。

安装完成后，该插件可在**Web**菜单下的**Qgis2threejs**菜单中找到。有两个可用的子菜单：

+   **设置**：这负责定义一个将用于打开生成的 3D 场景的浏览器。如果您想使用默认浏览器，则不应更改这些设置。

+   **Qgis2threejs**：这是插件的主窗口，它提供了对其一般功能的访问。在窗口的左侧，您可以查看所有可用控制参数和项目图层列表。窗口的右侧提供了对它们的设置和更改的访问，这取决于左侧选中的项目。

首先，您需要调整将用于生成覆盖地形的图像的地图图层。在这个例子中，我们激活以下从下到上的图层：`water_area`、`parks`、`roads`和`coverage_7_Binary`。您始终可以添加更多图层，甚至可以使用预定义的 WMS/WFS 或 OpenLayers 插件覆盖，例如 OpenStreetMap。这些活动图层将被用于提供背景地形。

### 注意

在以下部分，我们将仅探索插件的基本设置，这些设置对于从训练数据生成有意义的结果是必要的。有关参数的扩展帮助和描述可在[`github.com/minorua/Qgis2threejs/wiki/ExportSettings`](https://github.com/minorua/Qgis2threejs/wiki/ExportSettings)找到。

## 在 3D 场景的一般设置上工作

一旦所有必要的图层都处于活动状态，请通过以下选项调整场景的一般设置：

+   **模板文件**：在此，您可以从下拉列表中选择不同的输出模板。使用默认的**3DViewer(dat-gui).html**选项，因为它不仅生成 3D 场景，还添加了一个控件参数面板来调节图层可见性和不透明度以及自定义水平平面的垂直移动。

+   **世界**：此项目负责 3D 世界中场景的一般外观。我们特别感兴趣的是**垂直放大**参数，因为它定义了地形外观的复杂性。值越大，地形反映的地形特征就越明显。此外，此值还影响所有矢量 3D 对象的*Z*位置以及某些具有体积（点和挤出多边形）的对象类型的 3D 对象高度。默认值设置为`1.5`，但我们的兴趣区域有一个平面地形，其值变化平滑，因此我们输入`2`以使高度变化更加明显。

+   **控件**：有两个可用的控件选项，附有描述。保持默认的`OrbitControl.js`不变。

+   **DEM**：从可用的栅格**DEM**层下拉列表中选择`lidar_dem`，它将用于提供关于该区域高度的实际信息并生成具有预定义垂直放大的地形。有几个部分提供参数来调节 DEM 外观：

    +   **重采样**块负责生成的表面分辨率，并提供各种调整选项。在本教程的目的下，我们将简单地将滑块移动到第四个刻度，这将输出分辨率接近 400 x 400 像素，并将原始 DEM 重采样到大约 26.8 英尺。这种方法速度快，生成的输出轻量，但重采样值会影响 DEM 的分辨率，而不是覆盖其上的纹理。如果您想生成更复杂和高分辨率的成果，请阅读有关高级设置的说明，但请记住，高分辨率输出需要更多时间来导出，而且场景本身也需要更多的计算机资源来保持响应和快速渲染。

    +   **显示类型**：接受所有默认设置，假设使用**地图画布图像**作为纹理。

    +   **边框和框架**：接受默认的**构建边框**选项。它为 DEM 添加侧面和底部。

+   **附加 DEM**：如果您想结合包含某些*Z*值（例如，绝对高度和坡度，热图等）的两个栅格，此选项可能非常有用。由于我们主要对建筑和二值可见性栅格感兴趣，此选项被省略。

## 调整观测点的 3D 可视化

展开窗口左侧的**点**项，以查看所有可用的点层，并激活`observ_point`。在窗口的右侧部分，调整以下设置：

1.  对于**对象类型**，接受默认的**球体**值。观测点将在 3D 空间中以球体表示。

1.  将**Z 坐标模式**设置为**+"HEIGHT_ROO"**，这意味着点的海拔高度将根据以下公式获得：*z = 顶点海拔 + 字段值 + 加数* *= DEM + HEIGHT_ROO*。换句话说，我们只总结了地形的海拔和某一点的建筑高度，没有其他值（加数设置为 0，并排除在公式的第二部分）。因此，该点将考虑局部地形并代表观察者的真实垂直位置。

1.  **样式**部分负责符号的视觉属性：

    +   从下拉列表中将**颜色**设置为**随机**，球体将被随机分配颜色。

    +   在**透明度**下接受默认的**特征样式**选项。这将使点变得实心，而不是透明的。

    +   由于我们希望所有球体具有相同的大小，我们在**半径**下接受**固定值**。在**值**字段中输入`50`。

1.  现在，让我们考虑**与地图画布范围相交的特征**。使用此默认选项，只有显示在地图画布上的特征将被导出。

1.  **属性和标签**部分提供了访问标签选项的权限：

    +   激活**导出**属性以启用标签。所有属性将在您在 3D 场景中单击相关对象时导出并显示。

    +   从**标签**字段下拉列表中，选择用于标签的`OBJECTID`字段。

    +   **标签高度**选项定义了标签从球体的高度。在此处，我们从下拉列表中选择**从点高度**选项，并将**值**设置为`100`。

以下截图显示了定义所有参数后窗口的外观：

![调整观测点的 3D 可视化](img/image00467.jpeg)

## 调整建筑轮廓的 3D 可视化

展开窗口左侧的**多边形**项，以查看所有可用的多边形层，并激活`building_footprints`。在窗口的右侧，将设置更改为以下截图所示：

+   **对象类型**：将其设置为**拉伸**。这意味着二维多边形足迹将被表示为三维平行六面体。

+   **模式**: 将此设置为 **相对于 DEM**。这意味着建筑的高度将通过以下公式获得 *z = 顶点高程 + 加数* *= DEM*。换句话说，因为我们没有使用任何额外的值，并且高度设置为 0，所以建筑物的相对高度将仅依赖于 DEM。

+   **高度**: 将此设置为 `HEIGHT_ROO`。与之前的设置一起，此设置使得显示建筑物时能够展示其真实高度，相对于从数字高程模型（DEM）获得的绝对高度。![调整建筑物足迹的 3D 可视化](img/image00468.jpeg)

完成所有这些设置后，点击 **浏览** 按钮以指定输出场景的路径和名称。然后点击 **运行**。当场景生成后，它将自动加载并在你的默认网络浏览器中打开，你可以使用之前定义的控件来可视化地探索分析结果，如图所示：

![调整建筑物足迹的 3D 可视化](img/image00469.jpeg)

# 摘要

在本章中，你接触到了可见性分析的基础，包括输入数据准备、可见点创建以及生成和解释可见性覆盖，以便找到最佳的观测点。此外，你还学习了如何通过逼真的 3D 模型来展示你的结果，这在城市数据的视觉探索及其分析结果中非常有用。

在下一章中，你将学习如何通过空间分析来定义一个完美的位置。
