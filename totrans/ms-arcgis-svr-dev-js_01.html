<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><div class="chapter" title="Chapter 1. Your First Mapping Application"><div class="titlepage"><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Your First Mapping Application</h1></div></div></div><p>Let's say you have a map. You've digitized it using ArcGIS Desktop, a sort of desktop mapping and analysis software provided by ESRI. You've gone through the painstaking process of plotting points, connecting lines, and checking the boundaries of polygons. You've added nice background aerial imagery, and you've applied all the parts that make a map readable.</p><p>How are you going to share this map with the general public? You could post it in the public information office, but citizens have complained about that location being too remote, and down too many flights of stairs underground. You could make a thousand printed copies, but that would be terribly expensive.</p><p>If you<a id="id0" class="indexterm"/> have the <span class="strong"><strong>ArcGIS Server</strong></span> software running and connected to a web server, you can publish your map online, and serve it through a website running <a id="id1" class="indexterm"/>with the <span class="strong"><strong>ArcGIS JavaScript API</strong></span> (<a class="ulink" href="http://developers.arcgis.com/javascript">http://developers.arcgis.com/javascript</a>).</p><p>The ArcGIS JavaScript API is a JavaScript library that works with ArcGIS Server to connect <a id="id2" class="indexterm"/>the map maker with the general public. The map maker can use an ESRI product, such as ArcMap, to generate a map document. That map maker can then publish the map document through ArcGIS Server. From there, a web page that has been loaded with the ArcGIS JavaScript API can draw the map in the browser, and let the general public pan, identify, and interact with the map.</p><p>In this chapter, we'll be covering the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The requirements for creating a web mapping application using ArcGIS Server and the ArcGIS API for JavaScript</li><li class="listitem" style="list-style-type: disc">The HTML head and body content necessary to serve maps with the JavaScript API</li><li class="listitem" style="list-style-type: disc">How to create a map with the ArcGIS JavaScript API and add content</li><li class="listitem" style="list-style-type: disc">How to make a map interactive</li></ul></div><div class="section" title="Features of the API"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Features of the API</h1></div></div></div><p>The ArcGIS JavaScript API provides many of the tools necessary to build robust web map applications. It can generate <span class="strong"><strong>slippy</strong></span> maps, interactive maps that let the user pan and zoom in. The <a id="id3" class="indexterm"/>behavior is similar to Google or Bing Maps, but with your <a id="id4" class="indexterm"/>data. You're in control of the content, from background imagery to markers and popup content. With ArcGIS Server, you have control over how the maps are laid out, and which colors, styles, and fonts you use. The API also comes with custom elements that let you do everything from drawing on the map, searching for data, measuring things on the map, and printing the map in multiple formats.</p><p>The ArcGIS<a id="id5" class="indexterm"/> JavaScript API is built on top of the <span class="strong"><strong>Dojo</strong></span> framework (<a class="ulink" href="http://www.dojotoolkit.org">www.dojotoolkit.org</a>).You also have access to an extensive package of free HTML form elements, controls, and layout elements for your web applications because Dojo comes packaged with the API. These Dojo user controls have been tested in multiple browsers, and include an entire library of items that can be used to make a mobile application. While the ArcGIS JavaScript API is built with Dojo, it also works well with other libraries such as jQuery and AngularJS.</p><p>The ArcGIS JavaScript API was designed and built, along with an ArcGIS API, for Flash and Silverlight. Unlike other APIs which require specialized compilers, plugins, and related software, the ArcGIS JavaScript API can be written with a simple text editor and viewed on most common browsers without any special plugins. Since mobile browsers, such as Safari for iPad and Chrome for Android, do not support third party plugins, the ArcGIS JavaScript API is the preferred choice for creating interactive map websites for the mobile platform.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip02"/>Tip</h3><p>Now, it <a id="id6" class="indexterm"/>is possible to code a website using Windows <a id="id7" class="indexterm"/>Notepad, just like it's possible to hike up Mount <a id="id8" class="indexterm"/>Everest without a guide. But when things go <a id="id9" class="indexterm"/>wrong, you <a id="id10" class="indexterm"/>will probably want to<a id="id11" class="indexterm"/> use a free text editor with syntax highlighting and other<a id="id12" class="indexterm"/> features, such as NotePad++ (<a class="ulink" href="http://notepad-plus-plus.org/">http://notepad-plus-plus.org/</a>), Aptana Studio 3 (<a class="ulink" href="http://www.aptana.com/products/studio3.html">http://www.aptana.com/products/studio3.html</a>), or Visual Studio Code (<a class="ulink" href="http://code.visualstudio.com">http://code.visualstudio.com</a>) for Windows, Brackets (<a class="ulink" href="http://brackets.io">http://brackets.io</a>) or<a id="id13" class="indexterm"/> Textmate (<a class="ulink" href="http://macromates.com/">http://macromates.com/</a>) for Mac, or Kate (<a class="ulink" href="http://kate-editor.org/">http://kate-editor.org/</a>), Emacs (<a class="ulink" href="http://www.gnu.org/software/emacs/">http://www.gnu.org/software/emacs/</a>), or vim (<a class="ulink" href="http://www.vim.org/">http://www.vim.org/</a>) for Linux. If you want text editors that aren't free, but offer<a id="id14" class="indexterm"/> more features and support, you can check out Sublime Text (<a class="ulink" href="http://www.sublimetext.com/">http://www.sublimetext.com/</a>) or <a id="id15" class="indexterm"/>Webstorm (<a class="ulink" href="http://www.jetbrains.com/webstorm/">http://www.jetbrains.com/webstorm/</a>).</p></div></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="The ArcGIS JavaScript API community"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec09"/>The ArcGIS JavaScript API community</h1></div></div></div><p>The <a id="id16" class="indexterm"/>ArcGIS JavaScript API has an active community of developers who are willing to help you along the way. ESRI has blogs where they post updates, and host meetups in various cities across the country and around the globe. Many ArcGIS JavaScript developers, both inside and outside of ESRI, are active on Twitter and other social media outlets.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note02"/>Note</h3><p>You can find many resources to help you learn about the ArcGIS JavaScript API through books and the web. For books, you can check out <span class="emphasis"><em>Building Web and Mobile ArcGIS Server Applications with JavaScript</em></span> by Eric Pimpler, <span class="emphasis"><em>Building Web Applications with ArcGIS</em></span> by Hussein Nasser, and <span class="emphasis"><em>ArcGIS Web Development</em></span> by<a id="id17" class="indexterm"/> Rene Rubalcava. For online resources, you can visit ESRI GeoNet (<a class="ulink" href="https://geonet.esri.com/community/developers/content">https://geonet.esri.com/community/developers/content</a>), view<a id="id18" class="indexterm"/> the arcgis-javascript-api tag on GIS StackExchange (<a class="ulink" href="http://gis.stackexchange.com/questions/tagged/arcgis-javascript-api">http://gis.stackexchange.com/questions/tagged/arcgis-javascript-api</a>), or <a id="id19" class="indexterm"/>visit the ESRI GitHub page (<a class="ulink" href="https://github.com/esri">https://github.com/esri</a>).</p></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Our first Web Map"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Our first Web Map</h1></div></div></div><p>Now<a id="id20" class="indexterm"/> that the introductions are out of the way, we should begin working with the API. In this chapter, we're going to look at some code that will make a simple, interactive map. The example will be a single-page application, with all the styling and coding on the same page. In the real world, we would want to separate those into separate files. For this example, this is what the project is comprised of:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting up an HTML5 web page</li><li class="listitem" style="list-style-type: disc">Adding the necessary styling and the ArcGIS JavaScript library</li><li class="listitem" style="list-style-type: disc">Framing out our HTML content</li><li class="listitem" style="list-style-type: disc">Setting up a script to create a map</li><li class="listitem" style="list-style-type: disc">Loading a layer file</li><li class="listitem" style="list-style-type: disc">Adding a click event that collects data from the map service</li><li class="listitem" style="list-style-type: disc">Displaying that data on the map</li></ul></div><div class="section" title="Our assignment"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Our assignment</h2></div></div></div><p>We've just been<a id="id21" class="indexterm"/> asked by the Y2K historical society to make an interactive map application of the United States around the year 2000. They want the application to show the U.S. demographics including gender, age, and ethnicity, during that year. After reviewing the request from the client, we determined that the 2000 census data would provide all the mapping and demographics data we were looking for.</p><p>After a bit of research, we found an ArcGIS Server map service that serves the 2000 census data. We can use the ArcGIS JavaScript API to show that data on an HTML document. The user will be able to click on the map, and the application will display census data by state, census tract, and census block group.</p></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Setting up the HTML document"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Setting up the HTML document</h1></div></div></div><p>Let's open <a id="id22" class="indexterm"/>our favorite text editor and create an HTML document. Since we're working with census data, let's call it <code class="literal">census.html</code>. We'll start with an HTML5 template. Browsers will recognize it as HTML5 by the appropriate document type at the top of the page. Our HTML5 page starts out as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&lt;!DOCTYPE html&gt;</strong></span>
<span class="strong"><strong>&lt;html&gt;</strong></span>
<span class="strong"><strong>&lt;head&gt;&lt;/head&gt;</strong></span>
<span class="strong"><strong>&lt;body&gt;&lt;/body&gt;</strong></span>
<span class="strong"><strong>&lt;/html&gt;</strong></span>
</pre></div><div class="section" title="Starting from the head"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec09"/>Starting from the head</h2></div></div></div><p>The head<a id="id23" class="indexterm"/> of an HTML document contains information <a id="id24" class="indexterm"/>about the page including the title, metadata about the page content, <span class="strong"><strong>Cascading Style Sheet</strong></span> (<span class="strong"><strong>CSS</strong></span>) links to tell the browser how to render the output, and any scripts that the developer needs the browser to run before it reads the rest of the page. Here is an example of a simple webpage:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
<span class="strong"><strong>  &lt;meta http-equiv="Content-Type" content="text/html;charset=utf-8"/&gt;</strong></span>
<span class="strong"><strong>  &lt;meta http-equiv="X-UA-Compatible" content="IE=Edge" /&gt;</strong></span>
<span class="strong"><strong>  &lt;meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/&gt;</strong></span>
<span class="strong"><strong>  &lt;title&gt;Census Map&lt;/title&gt;</strong></span>
<span class="strong"><strong>  &lt;link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css" /&gt;</strong></span>
<span class="strong"><strong>  &lt;style&gt;</strong></span>
<span class="strong"><strong>    html, body {</strong></span>
<span class="strong"><strong>      border: 0;</strong></span>
<span class="strong"><strong>      margin: 0;</strong></span>
<span class="strong"><strong>      padding: 0;</strong></span>
<span class="strong"><strong>      height: 100%;</strong></span>
<span class="strong"><strong>      width: 100%;</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>  &lt;/style&gt;</strong></span>
<span class="strong"><strong>  &lt;script type="text/javascript"&gt;</strong></span>
<span class="strong"><strong>    dojoConfig = {parseOnLoad: true, debug: true};</strong></span>
<span class="strong"><strong>  &lt;/script&gt;</strong></span>
<span class="strong"><strong>  &lt;script type="text/javascript" src="http://js.arcgis.com/3.13/" &gt;&lt;/script&gt;</strong></span>
&lt;/head&gt;
…</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p>
<span class="strong"><strong>Downloading the example code</strong></span>
</p><p>You <a id="id25" class="indexterm"/>can download the example code files from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a> for all the Packt Publishing books you have purchased. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div><p>Let's take a look at each of the items separately.</p><div class="section" title="Meta tags and title tags"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec01"/>Meta tags and title tags</h3></div></div></div><p>The title and meta tags in the head of the document tell browsers and search engines more about the <a id="id26" class="indexterm"/>page. See the following code for an example:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&lt;meta http-equiv="Content-Type" content="text/html;charset=utf-8"/&gt;</strong></span>
<span class="strong"><strong>  &lt;meta http-equiv="X-UA-Compatible" content="IE=Edge" /&gt;</strong></span>
<span class="strong"><strong>  &lt;meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/&gt;</strong></span>
<span class="strong"><strong>  &lt;title&gt;Census Map&lt;/title&gt;</strong></span>
</pre></div><p>Some tags tell search engines how to read and categorize the content of your website. Others, like the meta tags in this file, tell the browser how to display and manipulate the page. In the preceding code the first meta tag, we're establishing the character set used to render text. The second meta tag tells Internet Explorer browsers to load the page using the latest version available. The third meta tag tells mobile browsers that the content is scaled to the correct size, disabling the ability to pinch or spread your fingers on the screen in order to zoom the text in and out. This is different from zooming the map scale in and out, and this tag is required in most mobile browsers to zoom in and out of the map.</p></div><div class="section" title="Cascading style sheets"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec02"/>Cascading style sheets</h3></div></div></div><p>The <a id="id27" class="indexterm"/>look of a website is determined by the CSS. These style sheets tell the browser how to lay elements on the page, what colors to make each element, how to space them out, and so on. You can see how they are arranged in the current document:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&lt;link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css" /&gt;</strong></span>
<span class="strong"><strong>  &lt;style&gt;</strong></span>
<span class="strong"><strong>    html, body {</strong></span>
<span class="strong"><strong>      border: 0;</strong></span>
<span class="strong"><strong>      margin: 0;</strong></span>
<span class="strong"><strong>      padding: 0;</strong></span>
<span class="strong"><strong>      height: 100%;</strong></span>
<span class="strong"><strong>      width: 100%;</strong></span>
<span class="strong"><strong>    }</strong></span>
<span class="strong"><strong>  &lt;/style&gt;</strong></span>
</pre></div><p>Here are three ways to organize and control the styling of elements by using CSS:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">First, we can apply styles to individual elements on the page with inline styling, by adding a style attribute to the HTML element (<code class="literal">&lt;div style="..."&gt;&lt;/div&gt;</code> for instance).</li><li class="listitem" style="list-style-type: disc">Second, we can apply styling to the whole page by using an internal style sheet, denoted by the <code class="literal">&lt;style&gt;&lt;/style&gt;</code> tags.</li><li class="listitem" style="list-style-type: disc">Third, we can apply styles to multiple sheets by referring to an external style sheet, denoted by <code class="literal">&lt;link rel="stylesheet" … /&gt;</code>. For our single page application, we'll use both our own internal style sheet, and an external one provided by ESRI.</li></ul></div><p>The ArcGIS JavaScript library requires its own style sheet to properly position the maps on the screen. Without this file, the map will not render correctly, and thus show the expected results. To load the required style sheet for the library, add a <code class="literal">link</code> tag and set the <code class="literal">href</code> attribute to point to the <code class="literal">esri.css</code> file.</p><p>If you're using version 3.2 or later, and your map appears on the page in a checkerboard pattern with the map tiles showing on every other square, the most likely problem is that the <code class="literal">esri.css</code> style sheet did not load. Make sure you reference the correct <code class="literal">esri.css</code> style sheet for the library version you're using. The following image shows an example of this behavior:</p><div class="mediaobject"><img src="graphics/6459OT_01_01.jpg" alt="Cascading style sheets" width="815" height="538"/></div></div><div class="section" title="The Dojo configuration script"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec03"/>The Dojo configuration script</h3></div></div></div><p>Our JavaScript <a id="id28" class="indexterm"/>code adds a variable that tells Dojo how it should load, in the first script tags. From this script, we can tell the browser how to interpret specially defined HTML elements in our document, whether we want the browser to cache all files, and even how to load packages and other libraries into the Dojo build system:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>  &lt;script type="text/javascript"&gt;</strong></span>
<span class="strong"><strong>    dojoConfig = {</strong></span>
<span class="strong"><strong>      parseOnLoad: true, </strong></span>
<span class="strong"><strong>      cacheBust: true</strong></span>
<span class="strong"><strong>    };</strong></span>
<span class="strong"><strong>  &lt;/script&gt;</strong></span>
</pre></div><p>In this case, we're telling Dojo to parse any specially decorated HTML elements in the body, and replace them with the appropriate Dojo widgets as the page is loaded. Using the <code class="literal">cacheBust</code> parameter, we are also asking the browser to use a timestamp when it loads the files, so that the files aren't cached in the browser. Adding timestamps forces the browser to load a fresh copy of the JavaScript file, rather than relying on a cached copy. Cached scripts under active development may not show the most recent changes you made, slowing <a id="id29" class="indexterm"/>development and increasing troubleshooting time.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>The script that loads the <code class="literal">dojoConfig</code> object must come before you load the ArcGIS JavaScript API. If the <code class="literal">dojoConfig</code> object is created after the API script reference, the <code class="literal">dojoConfig</code> contents will be ignored.</p></div></div></div><div class="section" title="The ArcGIS JavaScript API script"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec04"/>The ArcGIS JavaScript API script</h3></div></div></div><p>The <a id="id30" class="indexterm"/>ArcGIS JavaScript library is the main tool you'll use to render, manipulate, and interact with geographic data from the ArcGIS Server:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&lt;script type="text/javascript" src="http://js.arcgis.com/3.13/" &gt;&lt;/script&gt;</strong></span>
</pre></div><p>This application, as well as other applications in the book, use version 3.13 of the ArcGIS JavaScript API. It was the most current version available at the time the book was written. As you maintain these applications, be aware of version number updates. ESRI often releases new versions to add new features, fix bugs in previous versions, and to keep the API compliant with the latest browsers.</p></div></div><div class="section" title="Moving from the head to the body"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec10"/>Moving from the head to the body</h2></div></div></div><p>With our HTML head set up, we can focus on the body of the application. We'll add HTML <a id="id31" class="indexterm"/>elements to the body where the map and other information should go. We'll style those features from an inline style sheet. Finally, we'll write a script to handle the map creation, census data retrieval, and reacting to map events.</p><div class="section" title="Framing the HTML body"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec05"/>Framing the HTML body</h3></div></div></div><p>Our client specified that they would like the app to show two panels, a main map panel, and a <a id="id32" class="indexterm"/>separate panel that explains what the user is supposed to do. We're going to fulfill the request by blocking off the sections using HTML <code class="literal">div</code> elements. The <code class="literal">div</code> elements are generic blocks of content in HTML. In the first <code class="literal">div</code>, we'll add a styling class of <code class="literal">instructions</code>, and fill it with the appropriate instructions. In the second <code class="literal">div</code>, we'll apply the specific element <code class="literal">id</code> of <code class="literal">map</code>, to tell ourselves and the ArcGIS JavaScript API where to put the map:</p><div class="informalexample"><pre class="programlisting">&lt;body&gt;
<span class="strong"><strong>  &lt;div class="instructions"&gt;</strong></span>
<span class="strong"><strong>    &lt;h1&gt;U.S. Census for 2000&lt;/h1&gt;</strong></span>
<span class="strong"><strong>    &lt;p&gt;Click on the map to view census data for the state, census tract, and block.&lt;/p&gt;</strong></span>
<span class="strong"><strong>  &lt;/div&gt;</strong></span>
<span class="strong"><strong>  &lt;div id="map"&gt;&lt;/div&gt;</strong></span>
&lt;/body&gt;</pre></div></div><div class="section" title="Adding a little style"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec06"/>Adding a little style</h3></div></div></div><p>We need to add some style to the new elements we added. To do this, we'll modify the original internal <a id="id33" class="indexterm"/>style sheet in the head portion of the application. Our client wants the map to take up the whole screen, with a little space in the upper right-hand corner for the map title and the instructions. The client hasn't decided on colors yet, but they have requested the rounded corners that everybody's putting on their websites today.</p><p>So, after reviewing the requirements, and looking up how to style the elements, let's add the following within the <code class="literal">&lt;style&gt;&lt;/style&gt;</code> element. The changes have been highlighted to help you see what has changed in the following code snippet:</p><div class="informalexample"><pre class="programlisting">&lt;style&gt;
  html, body,<span class="strong"><strong> #map {</strong></span>
 border: 0;
 margin: 0;
 padding: 0;
 width: 100%;
 height: 100%;
  }
<span class="strong"><strong>  .instructions {</strong></span>
<span class="strong"><strong>      position: absolute;</strong></span>
<span class="strong"><strong>      top: 0;</strong></span>
<span class="strong"><strong>      right: 0;</strong></span>
<span class="strong"><strong>      width: 25%;</strong></span>
<span class="strong"><strong>      height: auto;</strong></span>
<span class="strong"><strong>      z-index: 100;</strong></span>
<span class="strong"><strong>      border-radius: 0 0 0 8px;</strong></span>
<span class="strong"><strong>      background: white;</strong></span>
<span class="strong"><strong>      padding: 0 5px;</strong></span>
<span class="strong"><strong>  }</strong></span>
<span class="strong"><strong>  h1 {</strong></span>
<span class="strong"><strong>      text-align: center;</strong></span>
<span class="strong"><strong>      margin: 4px 0;</strong></span>
<span class="strong"><strong>  }</strong></span>
&lt;/style&gt;</pre></div><p>Here's an explanation of the style we've added. We want the HTML document, the map <code class="literal">&lt;div&gt;</code> to have no margin, border, or padding, and take up the full height of the page. We also want the <code class="literal">&lt;div&gt;</code> elements with the instructions class to be precisely positioned in the top right corner, taking up twenty-five percent of the page's width, and then its height will be determined automatically. The instructions block will be floating 100 z-index units towards the user (putting it in front of our map), and its bottom-left corner will have an 8 pixel radius curve in the lower left corner. It will have a white background, and a little padding on the right and left side. Finally, the title <code class="literal">&lt;h1&gt;</code> will be centered horizontally, with a little padding <a id="id34" class="indexterm"/>above and below it.</p></div><div class="section" title="Adding a script at the end"><div class="titlepage"><div><div><h3 class="title"><a id="ch01lvl3sec07"/>Adding a script at the end</h3></div></div></div><p>If we<a id="id35" class="indexterm"/> look at our web page now, we won't see much. Just a title and instructions in the upper right-hand corner. We need to turn this plain page into a fully powered map application. To do that, we'll need to instruct the browser, by using JavaScript, on how to transform our map <code class="literal">&lt;div&gt;</code> into a map.</p><p>Just before the end of our body tag, we'll add a script tag where we'll write our JavaScript code. We put our script near the end of our HTML document because, unlike images and style sheets, browsers load script tags one at a time. While the browser is loading the script, it doesn't load anything else. If you put it at the beginning of the page, the user might notice a bit of latency, or a delay before the page loads. When we put a script at the end, the user is too distracted by the images and other elements on the page to notice when your script loads. This gives it the appearance of loading faster:</p><div class="informalexample"><pre class="programlisting">  &lt;div id="map"&gt;&lt;/div&gt;
<span class="strong"><strong>  &lt;script type="text/javascript"&gt;&lt;/script&gt;</strong></span>
&lt;/body&gt;</pre></div><p>So, why didn't we load the ArcGIS JavaScript library at the end of the page? There will be times, especially if you are using other parts of Dojo, when we'll need the library to manipulate the page as it loads in the browser. In that case, we put the library reference at the head of the HTML document.</p><p>Now that we have a script tag to write some JavaScript, we can code up an interactive map. But, before we start writing code, we need to understand how to use the ArcGIS JavaScript API and Dojo. We'll start with a quick history lesson.</p><p>Back in the good old days of web development, and even continuing today, JavaScript libraries tried to avoid colliding into one another by creating a single global object (such as JQuery's <code class="literal">$</code> or Yahoo's YUI). All of the library's features would be built into that object. If you've used the Google Maps API, you've probably used <code class="literal">google.maps.Map()</code> to create a map, and <code class="literal">google.maps.LatLng()</code> to load a point on that map. Each subpart of the library is separated by a dot (<code class="literal">.</code>).</p><p>Older versions of the ArcGIS JavaScript library were no different. All of ESRI's mapping libraries were loaded into the main "esri" object. You could create a map using <code class="literal">esri.map</code>, and load it with an <code class="literal">esri.layer.FeatureLayer</code> to show some data, for instance. The Dojo framework was similar, using the <code class="literal">dojo</code>, <code class="literal">dijit</code>, and <code class="literal">dojox</code> global objects.</p><p>But this tree-like approach to JavaScript library design has its downsides. As the library expands and matures, it builds up a lot of parts that developers didn't always use. We might use a library for one or two specific features, but we may not use every single tool and function the library offers. The parts of the library we don't use waste client bandwidth, bloat<a id="id36" class="indexterm"/> the memory, and make our app appear slower to load.</p></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Asynchronous Module Definition"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Asynchronous Module Definition</h1></div></div></div><p>Both the ArcGIS JavaScript API and Dojo decided to handle the bloated library crisis by incorporating<a id="id37" class="indexterm"/> the concept of <span class="strong"><strong>Asynchronous Module Definition</strong></span> (<span class="strong"><strong>AMD</strong></span>). In AMD, a library is broken down into modular components. The developer can pick and choose which parts of library they want to include in the application. By loading only the parts we need, we reduce download times, free the browser memory of unused functionality, and improve performance.</p><p>Another<a id="id38" class="indexterm"/> advantage of AMD is name collision avoidance or the names of the variables where the libraries load are controlled by the developer. Also, the scope of the loaded libraries is limited to within the calling function, much like a self-executing statement.</p><p>In an AMD based application, we make a list of the library modules we want to use, usually in an array of strings that the library knows how to interpret. We then follow it up with a function that loads most or all of those modules into JavaScript objects. We can then use those modules within the function to get the results we want.</p></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Loading required modules"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec13"/>Loading required modules</h1></div></div></div><p>To take<a id="id39" class="indexterm"/> advantage of the Dojo's AMD style, we're going to use Dojo's <code class="literal">require</code> function. In older examples, we would create multiple <code class="literal">dojo.require("")</code> statements that would load the parts of the ArcGIS JavaScript library we needed (and hopefully by the time we wanted to use them). But with AMD style, we use a single <code class="literal">require</code> function that requests the list of libraries we ask for, and loads them within a function that runs after all the libraries are loaded in the browser:</p><div class="informalexample"><pre class="programlisting">  &lt;div id="map"&gt;&lt;/div&gt;
  &lt;script type="text/javascript"&gt;
    <span class="strong"><strong>require([], function () {});</strong></span>
  &lt;/script&gt;
&lt;/body&gt;</pre></div><p>The <code class="literal">require</code> function takes two arguments, an array of strings that corresponds to folder locations in our library, and a function that runs after those libraries load. In the second function, we add arguments (variables within the parentheses after functions) that correspond to the libraries loaded in the list.</p><p>So, for this application, we'll need a few modules from the ArcGIS JavaScript API. We'll need to create an empty map and add data to the map in a form we call layers. We'll need to identify things on the map, retrieve the census data we need from the place we clicked on<a id="id40" class="indexterm"/> the map, and then display it:</p><div class="informalexample"><pre class="programlisting">&lt;div id="map"&gt;&lt;/div&gt;
&lt;script type="text/javascript"&gt;
  <span class="strong"><strong>require([</strong></span>
<span class="strong"><strong>    "esri/map",</strong></span>
<span class="strong"><strong>    "esri/layers/ArcGISDynamicMapServiceLayer",</strong></span>
<span class="strong"><strong>    "esri/tasks/IdentifyParameters",</strong></span>
<span class="strong"><strong>    "esri/tasks/IdentifyTask",</strong></span>
<span class="strong"><strong>    "esri/InfoTemplate",</strong></span>
<span class="strong"><strong>    "dojo/_base/array",</strong></span>
<span class="strong"><strong>    "dojo/domReady!"</strong></span>
<span class="strong"><strong>  ], function (</strong></span>
<span class="strong"><strong>    Map, ArcGISDynamicMapServiceLayer,</strong></span>
<span class="strong"><strong>    IdentifyParameters, IdentifyTask, InfoTemplate,</strong></span>
<span class="strong"><strong>    arrayUtils</strong></span>
<span class="strong"><strong>  ) {</strong></span>
<span class="strong"><strong>    // code goes here</strong></span>
<span class="strong"><strong>  });</strong></span>
&lt;/script&gt;</pre></div><p>Notice the order of the libraries loaded in the require statement, and the arguments in the following function. The first item in the list corresponds to the first argument in the function. It is a common error when creating more complex applications to mix up the order of the elements, especially if it has been revised multiple times. Make sure the items correspond as you go down the list.</p><p>You may have noticed that, while there are seven libraries loaded, there are only six arguments. The last library that loaded, the <code class="literal">dojo/domReady!</code> library, tells the require statement's second function not to run until all the HTML elements have loaded and are rendered in the browser.</p></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="The map object"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec14"/>The map object</h1></div></div></div><p>Now that <a id="id41" class="indexterm"/>we have the components, we need to create an interactive map; let's put them together. We'll start by constructing a <code class="literal">map</code> object, which provides the basis and interaction platform that we'll need to work with. The map constructor takes two arguments. The first parameter, either the HTML node or the <code class="literal">id</code> string of a node, indicates where we want to put our map. The second parameter of the map constructor is an <code class="literal">options</code> object, where we add the configurable options that make our map work as expected:</p><div class="informalexample"><pre class="programlisting">function (
    Map, ArcGISDynamicMapServiceLayer,
    IdentifyParameters, IdentifyTask, InfoTemplate,
    arrayUtils
  ) {
<span class="strong"><strong>    var map = new Map("map", {</strong></span>
<span class="strong"><strong>      basemap: "national-geographic",</strong></span>
<span class="strong"><strong>      center: [-95, 45],</strong></span>
<span class="strong"><strong>      zoom: 3</strong></span>
<span class="strong"><strong>    });</strong></span>
  });</pre></div><p>In the<a id="id42" class="indexterm"/> preceding code, we're creating a map in the <code class="literal">div</code> element with <a id="id43" class="indexterm"/>an <code class="literal">id</code> of <code class="literal">map</code>. In the map, we're adding a <span class="strong"><strong>basemap</strong></span>, or a background reference map, in the style of National Geographic. We're centering the map at 45°N and 95°W, at a zoom level of three. We'll go into greater depth concerning these configurations in later chapters. If you're using a desktop browser to view the results, you should see the United States, including Alaska, and Hawaii, as in the following image:</p><div class="mediaobject"><img src="graphics/6459OT_01_02.jpg" alt="The map object" width="723" height="555"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>If you have experience working with Dojo, most element constructors have the options <a id="id44" class="indexterm"/>first, followed by the node or the <code class="literal">id</code> of the node. This is the reverse of how we construct a map. Remember, order is important.</p></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="The layers"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec15"/>The layers</h1></div></div></div><p>Years ago, mapping <a id="id45" class="indexterm"/>departments drew maps on transparent Mylar sheets. Painstaking work went into drawing those sheets at the same scale. When the Mylar sheets were stacked on top of each other, and corresponding points on each layer were lined up, they would provide a visual mashup of overlapping map layers.</p><p>Today, the same effect can be created with a browser-based map application. Instead of clear Mylar sheets, the application takes advantage of layering image files and vector graphics to create the same effect. In the ArcGIS JavaScript API, we refer to these stackable <a id="id46" class="indexterm"/>map data sources as <span class="strong"><strong>layers</strong></span>.</p><p>The ArcGIS JavaScript API can accept multiple types of layer files from different sources. Some layers are very flexible, and can be realigned and reprojected to line up with other <a id="id47" class="indexterm"/>map sources. These are commonly referred to as <span class="strong"><strong>dynamic layers</strong></span>. Other<a id="id48" class="indexterm"/> layers are made up of images drawn at specific scales, and are not designed to be so flexible. These are commonly referred to as <span class="strong"><strong>tiled layers</strong></span>.</p><p>In our current application, the National Geographic background we added is considered a tiled layer. Its pre-rendered content loads quickly in the browser, which is one of the advantages of using a tiled layer. On the other hand, our data source for the census data is a dynamic layer provided by an ArcGIS Server map service. Its dynamic nature helps it to stretch and line up with our tiled background. Here's the code we'll use to add the layer:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>var censusUrl = "http://sampleserver6.arcgisonline.com/arcgis/rest/services/Census/MapServer/";</strong></span>
var map = new Map("map", {
      basemap: "national-geographic",
      center: [-95, 45],
      zoom: 3
    });

<span class="strong"><strong>var layer = new ArcGISDynamicMapServiceLayer(censusUrl);</strong></span>

<span class="strong"><strong>map.addLayer(layer);</strong></span>
</pre></div><p>So, if we take a look at the page at this point, we should see a map of the world with black lines surrounding each state, census tract, and block. We can zoom in to see more detail in<a id="id49" class="indexterm"/> the map. Your map should look something like the following image:</p><div class="mediaobject"><img src="graphics/6459OT_01_03.jpg" alt="The layers" width="721" height="556"/></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Adding some action"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec16"/>Adding some action</h1></div></div></div><p>At this point, we have a map that draws all the state and census block and track data. We need<a id="id50" class="indexterm"/> more than that. We need a way for the user to interact with the site. The ArcGIS JavaScript API incorporates many tools provided by the native JavaScript language, plus new tools provided by Dojo.</p><div class="section" title="Events"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec11"/>Events</h2></div></div></div><p>When<a id="id51" class="indexterm"/> many of us learned traditional programming, we learned that programs followed a linear design. They started on the first line and ended on the last line. The computer performed each computation in an ordered fashion, and would not go on to the next line until the current line had finished.</p><p>But JavaScript adds something different. JavaScript adds an event loop that monitors for specific website interactions, such as a change in a text blank. We can attach a function, commonly<a id="id52" class="indexterm"/> called an <span class="strong"><strong>event listener</strong></span>, to a known element event. When that event is triggered, the event listener runs.</p><p>For example, buttons have a click event, and if we attach an event listener to the button's click event, that function will respond every time that button is clicked. We can also get information about the button through the data passed through the click event.</p><p>For our application, we want the map to do something when we click on it. If we look up the list of supported map events, we can attach an event listener using the <code class="literal">.on()</code> method. The <code class="literal">.on()</code> method takes two parameters, a string description of the event, and the event listener function we want to be called when the event occurs. A list of supported events can be found in the ArcGIS JavaScript API documentation:</p><div class="informalexample"><pre class="programlisting">map.addLayer(layer);
<span class="strong"><strong>function onMapClick (event) {</strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong>map.on("click", onMapClick);</strong></span>
</pre></div><p>Before we can do anything with the map, we need to know if it has loaded yet. If we're running an updated browser on our fastest computer with a high-speed internet connection, the map may load immediately, but if we're testing from a mobile browser on an older smartphone, with less than stellar internet download speeds, the map may not load very quickly.</p><p>Before we assign the click event, we're going to test whether the map has loaded. If so, we'll add the <code class="literal">onMapClick</code> function as an event listener to the map's <code class="literal">click</code> event. If not, we'll wait until the map fires its <code class="literal">load</code> event to set the <code class="literal">click</code> event. Just so we don't have to repeat ourselves when adding the map click event, we'll enclose that assignment in another function:</p><div class="informalexample"><pre class="programlisting">function onMapClick(event) {
}
<span class="strong"><strong>function onMapLoad() {</strong></span>
  map.on("click", onMapClick);
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong>if (map.loaded) {</strong></span>
<span class="strong"><strong>  onMapLoad();</strong></span>
<span class="strong"><strong>} else {</strong></span>
<span class="strong"><strong>  map.on("load", onMapLoad);</strong></span>
<span class="strong"><strong>}</strong></span>
</pre></div></div><div class="section" title="Tasks"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec12"/>Tasks</h2></div></div></div><p>While developers can write code that does a lot with JavaScript, there are some tasks that are best left <a id="id53" class="indexterm"/>to a server. The ArcGIS JavaScript API sends <a id="id54" class="indexterm"/>requests to the server through <span class="strong"><strong>task</strong></span> objects. There are tasks for calculating the area and perimeter of complex shapes, tasks for querying and returning spatial and non-spatial data on features in a map, and tasks for creating <code class="literal">.pdf</code> documents containing the map we're looking at, among many others. These tasks take the burden off the browser to perform complex calculations that could be very slow on mobile devices. They also allow the library to be lighter in weight, so the library doesn't have to load every single set of conversion factors between one coordinate system and another, for example.</p><p>Most tasks have three parts: the task object, the task parameters, and the task results. The task object lets us send requests to the ArcGIS Server for specific tasks, and includes the constants that may need to be referenced for some tasks. The task object typically takes in a URL string parameter that tells the task to which ArcGIS Server service endpoint to send its requests. The task parameters object defines what information we need to get information from the task. Finally, after we execute the task with the task parameters, and we receive the response from the server, we get a structured object, or a list of objects known as the task's result. Formats for the task, task parameters, and task results can be found in<a id="id55" class="indexterm"/> the ArcGIS JavaScript API documentation at <a class="ulink" href="https://developers.arcgis.com/javascript/jsapi/">https://developers.arcgis.com/javascript/jsapi/</a>.</p><p>In our code, we're going to use a task called an <code class="literal">IdentifyTask</code> method. We'll tell the <code class="literal">IdentifyTask</code> method to contact ArcGIS Server through our census URL. Inside the map click event handler, we'll create a task parameter object called an <code class="literal">IdentifyParameter</code> object. We'll configure it with the data about the point we clicked, and data on the map. Finally, we'll execute the <code class="literal">IdentifyTask</code> method, passing in the <code class="literal">IdentifyParameters</code> object, to retrieve census data from the location we clicked:</p><div class="informalexample"><pre class="programlisting">layer = new ArcGISDynamicMapServiceLayer(censusUrl),
<span class="strong"><strong>   iTask = new IdentifyTask(censusUrl);</strong></span>

function onMapClick (event) {
  <span class="strong"><strong>var params = new IdentifyParameters();</strong></span>
<span class="strong"><strong>  params.geometry = event.mapPoint;</strong></span>
<span class="strong"><strong>  params.layerOption = IdentifyParameters.LAYER_OPTION_ALL;</strong></span>
<span class="strong"><strong>  params.mapExtent = map.extent;</strong></span>
<span class="strong"><strong>  params.returnGeometry = true;</strong></span>
<span class="strong"><strong>  params.width = map.width;</strong></span>
<span class="strong"><strong>  params.height= map.height;</strong></span>
<span class="strong"><strong>  params.spatialReference = map.spatialReference;</strong></span>
<span class="strong"><strong>  params.tolerance = 3;</strong></span>
<span class="strong"><strong>  iTask.execute(params);</strong></span>
}</pre></div></div><div class="section" title="Deferreds and promises"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec13"/>Deferreds and promises</h2></div></div></div><p>Years ago, when FORTRAN ruled the computer programming world, there was one statement <a id="id56" class="indexterm"/>that drove developers crazy when it came time<a id="id57" class="indexterm"/> to troubleshoot their code: <code class="literal">GOTO</code>. With this line of code, disrupting the flow of the application, the application would jump to another line of code. Jumping from one section of code to another made following the application's logic difficult at best.</p><p>With modern JavaScript and asynchronous development, following the logic of some asynchronous applications can be difficult, too. The app fires one event when the user clicks a button, which triggers an AJAX request for data. On the successful return of that data, another event fires, which makes the map do something that takes a little time. After the map finishes, it fires off another event, and so on and so forth.</p><p>Dojo responded<a id="id58" class="indexterm"/> to this by creating <span class="strong"><strong>Deferreds</strong></span> objects. Deferred objects return a promise that a result from an asynchronous process will be coming soon. The function waiting for the result will not be called until that promise is fulfilled. With functions returning Deferred results, the developer can chain functions together using a <code class="literal">.then()</code> statement. The <code class="literal">.then()</code> statement launches the first function in its parameters only after the result is fulfilled. Multiple <code class="literal">.then()</code> statements can be chained together with functions that return Deferred objects, leading to an orderly, and more easily readable coding logic.</p><p>In our <code class="literal">onMapClick</code> function, the <code class="literal">IdentifyTask</code> object's execute method returns a Deferred object. We'll store that deferred result in a variable, so that it can be used by another tool later:</p><div class="informalexample"><pre class="programlisting">function onMapClick (event) {
  var params = new IdentifyParameters(),
<span class="strong"><strong>      defResults;</strong></span>
  …
<span class="strong"><strong>  defResults = </strong></span>iTask.execute(params);
}</pre></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Showing the results"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec17"/>Showing the results</h1></div></div></div><p>Once we<a id="id59" class="indexterm"/> have received our data, we should show the results to the user. If we look at the format of the data passed over the network, we'll see a list of complicated<a id="id60" class="indexterm"/> <span class="strong"><strong>JavaScript Object Notation</strong></span> (<span class="strong"><strong>JSON</strong></span>) objects. That data, in its raw form, would be useless in the hands of the average user. Thankfully, the ArcGIS JavaScript API provides tools and methods for turning this data into something more user-friendly.</p><div class="section" title="The Map's infoWindow"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec14"/>The Map's infoWindow</h2></div></div></div><p>In the day <a id="id61" class="indexterm"/>of modern map applications such as Google Maps, Bing Maps, and OpenStreetmaps, users have been taught that if you click on something important on a map, a little box should pop up and tell you more about that item. The ArcGIS JavaScript API provides a similar popup control for the map called an <code class="literal">infoWindow</code> control. The <code class="literal">infoWindow</code> highlights feature shapes on the map, and overlays a popup window to show the features-related attributes.</p><p>The <code class="literal">infoWindow</code> can be accessed as a property of the map (for example, <code class="literal">map.infoWindow</code>). From this point, we can hide or show the popup. We can tell the <code class="literal">infoWindow</code> which features to highlight. The <code class="literal">infoWindow</code> provides a number of configurable and control points to help create a better user experience.</p><p>In our application's map click handler, we will need to convert the search results into a form that can be used by the <code class="literal">infoWindow</code>. We'll do that by adding an <code class="literal">.addCallback()</code> call to the <code class="literal">IdentifyTask</code> object's execute function. We'll pull out the features from <code class="literal">IdentifyResults</code>, and make a list of them. From that point, we can pass the processed results into the <code class="literal">infoWindow</code> object's list of selected features. We'll also prompt the <code class="literal">infoWindow</code> to show where the user clicked:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>function onIdentifyComplete (results) {</strong></span>
<span class="strong"><strong>  // takes in a list of results and return the feature parameter </strong></span>
<span class="strong"><strong>  // of each result.</strong></span>
<span class="strong"><strong>  return arrayUtils.map(results, function (result) {</strong></span>
<span class="strong"><strong>    return result.feature;</strong></span>
<span class="strong"><strong>  });</strong></span>
<span class="strong"><strong>}</strong></span>

function onMapClick (event) {
…
  defResults = iTask.execute(params).<span class="strong"><strong>addCallback(onIdentifyComplete);</strong></span>
  <span class="strong"><strong>map.infoWindow.setFeatures([defResults]);</strong></span>
<span class="strong"><strong>  map.infoWindow.show(event.mapPoint);</strong></span>
}</pre></div><p>You can run the application now from your browser, and try clicking on one of the black-outlined features on the map. You should see a shape outlined in cyan (light blue), and a popup pointing to where you clicked. The popup will tell you that there is at least one record there (probably more). You can click the small back and forward arrows on the popup to flip through the selected results (if there is more than one).</p></div><div class="section" title="The InfoTemplate object"><div class="titlepage"><div><div><h2 class="title"><a id="ch01lvl2sec15"/>The InfoTemplate object</h2></div></div></div><p>As of this point, we can see the shape of our data. The problem is, we can't see what's inside. There is<a id="id62" class="indexterm"/> important tabular data associated with the shapes we're seeing in the results, but the popup hasn't been told how to show the information. For that, we can use an <code class="literal">InfoTemplate</code> object. An <code class="literal">InfoTemplate</code> object tells the popup how to format the data for display, including what title to use, and how we want the search results displayed. An <code class="literal">InfoTemplate</code> object is connected to the feature data, along with the feature's geometry and attributes.</p><p>An <code class="literal">InfoTemplate</code> object can be constructed in different ways, but most commonly with a string to describe the title, and another string to show the content. The content can contain any valid HTML, including tables, links, and images. Since the title and content are templates, you can insert feature attributes within the template string. Surround the field names from your results with <code class="literal">${fieldname}</code>, where "fieldname" is the name of the field you want to use. If you want to show all the field names and values in the content, without any special formatting, set the content value of the <code class="literal">InfoTemplate</code> object to <code class="literal">${*}</code>.</p><p>For our application, we'll need to add <code class="literal">InfoTemplates</code> to the <code class="literal">IdentifyTask</code> results. We'll work with the <code class="literal">onIdentifyComplete</code> callback and insert them there. We'll start by inserting the following code:</p><div class="informalexample"><pre class="programlisting">function onIdentifyComplete (results) {
  return arrayUtils.map(results, function (result) {
    <span class="strong"><strong>var feature = result.feature,</strong></span>
        <span class="strong"><strong>title = result.layerName;</strong></span>
    <span class="strong"><strong>feature.infoTemplate = new InfoTemplate(title, "${*}");</strong></span>
    return feature;
  });
}</pre></div><p>In this bit of code, we're extracting the layer name of the results, and using that for the title. For the content, we're using the "show everything" template to show all fields and values. If you run the web page in your browser now, and click on a feature, you should see something like the following image:</p><div class="mediaobject"><img src="graphics/6459OT_01_04.jpg" alt="The InfoTemplate object" width="723" height="555"/></div><p>Now, there<a id="id63" class="indexterm"/> are a lot of unreadable field names, and field values we may not be able to understand. We could apply different content formats, based on the layer names of the features. Looking at the preceding example, we're mostly interested in the population, the number of households, and the number of housing units:</p><div class="informalexample"><pre class="programlisting">function onIdentifyComplete (results) {
  return arrayUtils.map(results, function (result) {
    var feature = result.feature,
        title = result.layerName,
        <span class="strong"><strong>content;</strong></span>
<span class="strong"><strong>    </strong></span>
<span class="strong"><strong>    switch(title) {</strong></span>
<span class="strong"><strong>      case "Census Block Points":</strong></span>
<span class="strong"><strong>        content = "Population: ${POP2000}&lt;br /&gt;Households: ${HOUSEHOLDS}&lt;br /&gt;Housing Units: ${HSE_UNITS}";</strong></span>
<span class="strong"><strong>        break;</strong></span>
<span class="strong"><strong>      default:</strong></span>
<span class="strong"><strong>        content = "${*}";</strong></span>
<span class="strong"><strong>    }</strong></span>
    feature.infoTemplate = new InfoTemplate(title, <span class="strong"><strong>content</strong></span>);
    return feature;
  });
}</pre></div><p>If you<a id="id64" class="indexterm"/> run the page again in your browser, you should see more readable results, at least for the census block points. Other features, such as the states, counties, and block groups, will show a list of field names and their corresponding values, separated by a colon (<code class="literal">:</code>). I'll leave the templates for the other fields as a homework exercise for you.</p><p>In the end, your code should read as follows:</p><div class="informalexample"><pre class="programlisting">&lt;!DOCTYPE HTML&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;
  &lt;meta http-equiv="X-UA-Compatible" content="IE=Edge" /&gt;
  &lt;meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/&gt;
  &lt;title&gt;Census Map&lt;/title&gt;
  &lt;link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css"&gt;
  &lt;style&gt;
    html, body, #map {
      border: 0;
      margin: 0;
      padding: 0;
      height: 100%;
    }
    .instructions {
      position: absolute;
      top: 0;
      right: 0;
      width: 25%;
      height: auto;
      z-index: 100;
      border-radius: 0 0 0 8px;
      background: white;
      padding: 0 5px;
    }
    h1 {
      text-align: center;
      margin: 4px 0;
    }
  &lt;/style&gt;
  &lt;script type="text/javascript"&gt;
    dojoConfig = { parseOnLoad: true, isDebug: true };
  &lt;/script&gt;
  &lt;script src="http://js.arcgis.com/3.13/"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class="instructions"&gt;
    &lt;h1&gt;U.S. Census for 2000&lt;/h1&gt;
    &lt;p&gt;Click on the map to view census data for the state, census tract, and block.&lt;/p&gt;
  &lt;/div&gt;
  &lt;div id="map"&gt;&lt;/div&gt;
  &lt;script type="text/javascript"&gt;
    require([
      "esri/map",
      "esri/layers/ArcGISDynamicMapServiceLayer",
      "esri/tasks/IdentifyParameters",
      "esri/tasks/IdentifyTask",
      "esri/InfoTemplate",
      "dojo/_base/array",
      "dojo/domReady!"
    ], function (
      Map, ArcGISDynamicMapServiceLayer,
      IdentifyParameters, IdentifyTask, InfoTemplate,
      arrayUtils
    ) {
      var censusUrl = "http://sampleserver6.arcgisonline.com/arcgis/rest/services/Census/MapServer/",
          map = new Map("map", { 
            basemap: "national-geographic",
            center: [-95, 45],
            zoom: 3
          }),
          layer = new ArcGISDynamicMapServiceLayer(censusUrl),
          iTask = new IdentifyTask(censusUrl);

      function onIdentifyComplete (results) {
        return arrayUtils.map(results, function (result) {
          var feature = result.feature,
              title = result.layerName,
              content;
          switch(title) {
            case "Census Block Points":
              content = "Population: ${POP2000}&lt;br /&gt;Households: ${HOUSEHOLDS}&lt;br /&gt;Housing Units: ${HSE_UNITS}";
              break;
            default:
              content = "${*}";
          }
          feature.infoTemplate = new InfoTemplate(title, content);
          return feature;
        });
      }

      function onMapClick (event) {
        var params = new IdentifyParameters(),
            defResults;
        params.geometry = event.mapPoint;
        params.layerOption = IdentifyParameters.LAYER_OPTION_ALL;
        params.mapExtent = map.extent;
        params.returnGeometry = true;
        params.width = map.width;
        params.height= map.height;
        params.spatialReference = map.spatialReference;
        params.tolerance = 3;

        defResults = iTask.execute(params).addCallback(onIdentifyComplete);
        map.infoWindow.setFeatures([defResults]);
        map.infoWindow.show(event.mapPoint);
      }

      function onMapLoad() {
        map.on("click", onMapClick);
      }

     map.addLayer(layer);

      if (map.loaded) {
        onMapLoad();
      } else {
        map.on("load", onMapLoad);
      }

    });
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div><p>Congratulations, if this is your first web map application using ArcGIS Server and JavaScript. You've worked through multiple steps to produce a working, interactive map application. This<a id="id65" class="indexterm"/> application should look great on all the latest browsers. However, older browsers may not connect with the server properly, and may require a proxy.</p></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="A note on proxies"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec18"/>A note on proxies</h1></div></div></div><p>If you've<a id="id66" class="indexterm"/> worked with the ArcGIS JavaScript API for any length of time, or had to support older browsers like Internet Explorer 9 or less, then you've probably come across proxies. Proxies are server-side applications that make web requests on behalf of the web browser, often transmitting and receiving data the browser could not collect on its own. There are three primary reasons why a browser would require a proxy to communicate with a server. They are as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The<a id="id67" class="indexterm"/> browser is an older browser that does not support <span class="strong"><strong>Cross Origin Resource Sharing</strong></span> (<span class="strong"><strong>CORS</strong></span>), and the server requests will be made to a different server from the one the application sits on.</li><li class="listitem">The proxy provides additional security keys to access specific data, which might include secured tokens the developer doesn't want to release to the public.</li><li class="listitem">The web request is much longer than the 2048+ character maximum for <code class="literal">GET</code> requests.</li></ol></div><p>The first example is common with older browsers, including Internet Explorer 9 or lower. They can't grab data from third party servers that are separate from the web server, because of a security restraint. With the HTML5 specification for CORS, newer browsers can check to see if an application is allowed to be requested from a script not on the server.</p><p>The second example is common in large secure environments, with many security hoops to jump through. Department portal websites could access proxies with tokens unique to the department, providing an extra layer of security.</p><p>The third example is common when the user is passing large geometries with many irregular vertices. For instance, if you were to use a drawing tool to draw an irregular shape with the free-handed drawer, its vertices are added as you move around on the map. With so many points, and those points requiring a lot of characters to show their latitude and longitude, it's no wonder a shape request might exceed the browser's maximum character length.</p><p>The ArcGIS <a id="id68" class="indexterm"/>Server proxy is free to download from GitHub (<a class="ulink" href="https://github.com/Esri/resource-proxy">https://github.com/Esri/resource-proxy</a>). They have versions that work with Java, .NET, and PHP. Please use the most recent version, and make sure it's properly configured for all <a id="id69" class="indexterm"/>the services you'll be using.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip06"/>Tip</h3><p>If both your computer and your ArcGIS Server are behind a network firewall, and the ArcGIS Server has unique public and private IP addresses, your network firewall may block proxy connections to your ArcGIS Server. If you see network traffic failing only on older browsers, such as Internet Explorer 8, and only for internal requests, the firewall might be the issue. Contact your network administrator to work out the issue.</p></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch01lvl1sec19"/>Summary</h1></div></div></div><p>In this chapter, we have learnt the basics of writing a simple web application using the ArcGIS JavaScript API, and put together a map-based application. We learned how to set up the application in the head of the HTML document. We learned how to create a map on a page and how to add layers so that we can view the data. We learned how to retrieve feature shapes and attributes through a task, and how to show that data to the user.</p><p>In the next chapter, we'll look more in depth at the tools available in the ArcGIS JavaScript API.</p></div></div></div></body></html>