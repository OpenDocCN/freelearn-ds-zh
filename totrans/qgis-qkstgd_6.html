<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Spatial Processing</h1>
                </header>
            
            <article>
                
<p>In this chapter, we'll be performing spatial analysis using QGIS. We'll use the data from the GeoPackage that we used in the previous data chapters. Firstly, we'll look at the Processing Toolbox and then <span>move</span><span> </span><span>on to some individual tools and spatially query our data.</span></p>
<p><span>The following topics will be covered in this chapter:</span><br/></p>
<ul>
<li>The Processing Toolbox</li>
<li>Spatial queries</li>
<li>Analyzing data</li>
<li>Raster-based analysis</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The Processing Toolbox</h1>
                </header>
            
            <article>
                
<p>From the <span class="packt_screen">Processing</span> <span>menu,</span><span> </span><span>select</span> <span class="packt_screen">Toolbox</span><span>.</span> The <span class="packt_screen">Processing Toolbox</span> <span>is</span> shown <span>as follows:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/da1188e1-58a0-4907-87ac-a15821410a0f.png" style=""/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Processing Toolbox</div>
<p>At the top of the <span class="packt_screen">Processing Toolbox, </span> there is a toolbar. In this toolbar, the first button is used to call the model builder and the second button opens the Python scripting tools, both of which we'll come to later. The next four buttons, in order, show <span class="packt_screen">H</span><span class="packt_screen">istory</span>, <span class="packt_screen">Results Viewer</span>, <span class="packt_screen">Edit Features In-Place</span> (this button shows tools that <em>filters to display only algorithms that allow in-place modification of the geometries</em>), and processing settings. Under this toolbar is the search feature; using this feature, you can quickly find processing tools and run them.</p>
<p>In this chapter, we'll use these tools to analyze and work with our data. We'll use some of the tools in the Processing Toolbox to answer some spatial or GIS-type questions.</p>
<p>Create a new empty QGIS project. Load in the following layers from the GeoPackage:</p>
<ul>
<li><kbd>regions</kbd></li>
<li><kbd>pipelines</kbd></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">What regions intersect pipelines?</h1>
                </header>
            
            <article>
                
<p>We can answer this with a spatial query. In QGIS, this tool is called <span class="packt_screen">Select by Location</span>; search for this term in the <span class="packt_screen">Processing Toolbox</span>, then double-click on the tool to open the dialog box. We want to use this tool to select all of the features from the <kbd>regions</kbd> layer that <span class="packt_screen">intersect</span> with <kbd>pipelines</kbd>. The input will look like this:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/6b884b19-e69b-48f4-88a9-e1b73739c464.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Select by Location tool</div>
<p>The output in QGIS will look like this:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/ceba0746-6e33-4d56-a034-b26d641175ae.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Selected regions highlighted</div>
<p>Open the attribute table by right-clicking on the layer and choosing <span class="packt_screen">Open Attribute</span> <span class="packt_screen">Table</span>. You will see the selected regions in the table. It is possible to expand on this query and create a field in the <kbd>regions</kbd> layer that notes whether the pipeline intersected the region or not. To do this, we can use the field calculator.</p>
<p>Let's add a field called <kbd>Pipeline</kbd> and assign the value one if the pipeline runs through the region and zero if it doesn't. In the attribute table, click on the open field calculator button (the icon is an abacus). Fill in the <span class="packt_screen">Field Calculator</span> as follows. Make sure the checkbox next to <span class="packt_screen">Only update 5 selected features</span> is selected:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/eff21d99-6254-44a0-a9a4-38910634a119.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">The field calculator</div>
<p>Click on <span class="packt_screen">OK</span> and then open the attribute table; you will see a new field called <kbd>Pipeline</kbd>. This is shown as follows:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/023b7c9f-ce9a-465f-a39c-fcf79fbd82cd.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Attribute table with selected feature(s)</div>
<p>We need to add the value zero now to all of the other fields. Invert the selection (the button looks like a yellow triangle underneath a grey triangle). Choose the <kbd>Pipeline</kbd> field from the drop-down menu and set the value equal to 0. Click on <span class="packt_screen">Update Selected</span>. The value to change is shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/650ebb75-ea3f-429e-9fba-56d070825d4c.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Update existing field in the field calculator</div>
<p>Click on <span class="packt_screen">OK</span>. Now, the <kbd>Pipeline</kbd> field has either zero (not impacted) or one (impacted). Clear the selection and untoggle the editing. We could use the styling skills from <a href="e8289aa4-8eb7-4d2d-9662-4c17889a53e3.xhtml"/><a href="e8289aa4-8eb7-4d2d-9662-4c17889a53e3.xhtml">Chapter 4</a>, <em>Styling Data</em>, to symbolize the region layer based on the newly created <kbd>Pipeline</kbd> field.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">What buildings and settlements are within 15,000 feet of the pipeline?</h1>
                </header>
            
            <article>
                
<p>To answer this question, we need to perform a buffer on the pipeline and then select the points in the <span class="packt_screen">popp</span> layer that fall inside this buffer. This is a common GIS query, and the method shown here should be applicable to any similar query you might have about your data. Load<span> </span><span>the</span><span> </span><span class="packt_screen">popp</span><span> </span><span>layer</span><span> into the map</span><span>. </span></p>
<p>Search in the <span class="packt_screen">Processing Toolbox</span> for <span class="packt_screen">Buffer</span>. Double-click to open the tool. Select the <kbd>pipelines</kbd> layer and set the buffer <span class="packt_screen">Distance</span> to <kbd>15000</kbd> feet. Check the box next to <span class="packt_screen">Dissolve result</span>; this will merge any adjacent or overlapping features into one feature. For the output, choose the GeoPackage that we supplied with this book containing this <kbd>alaska</kbd> layers. The <span class="packt_screen">Buffer</span> dialog should look as follows:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/0627bafa-9b8b-4dbe-9d89-758c12971f4d.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">The Buffer tool</div>
<p>Click on <span class="packt_screen">Run</span>. Click on <span class="packt_screen">Close</span> when the tool has finished. On the map, we should now have a buffer of the pipelines. Use the <span class="packt_screen">Select by Location</span> tool as before, but this time select the points in the <span class="packt_screen">popp</span> layer that are within this newly created buffer. The dialog should look similar to the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/6b295ff1-4627-45c0-854f-a237f34953de.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Select by Location tool</div>
<p>After clicking <span class="packt_screen">Run</span>, close the tool and inspect the map. This query results in 49 features being selected. To write these out to a new layer, right-click on the <span class="packt_screen">popp</span> layer in the layer panel and select <span class="packt_screen">Export</span> | <span class="packt_screen">Save Selected Features As</span>. Save the selected features to a new layer in the GeoPackage called <kbd>Popp_in_pipeline_corridor</kbd>. This is shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/6cd740d6-25f5-43cb-8fa0-c72efef001c0.png" style=""/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Saving the layer</div>
<p>Click on <span class="packt_screen">OK</span> and, in the layer panel, turn off all of the layers apart from this one and the regions. Your map should look like the following:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/a96b810c-5a9a-4e00-85f8-8456e5dce949.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">All of the popp points 15,000 feet from the pipeline</div>
<p>Similar to the first question, this query is common in GIS. Instead of settlements and buildings in a pipeline corridor, you might be dealing with address points for customers within <em>x</em> distance of a new shop that you might wish to contact to let them know about a new offer.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">What is the distribution landcover types inside the buffered pipeline?</h1>
                </header>
            
            <article>
                
<p>This question is one where we combine both raster and vector data to provide an answer. We might want to know whether the pipeline is going through a protected area and how much of that area is impacted.</p>
<p>Load<span> </span><span>the</span><span> </span><kbd>landcover.img</kbd><span> </span><span>dataset</span><span> into the <span class="packt_screen">Layers</span> panel</span><span>. To answer this question, we'll use a</span> tool <span>call</span> <span class="packt_screen">Zonal Histogram</span><span>. Search for it in the toolbox. Set </span><span class="packt_screen">Raster layer</span> <span>as the</span> <kbd>landcover</kbd> <span>layer, set</span> <span class="packt_screen">Vector layer containing zones</span> <span>as the</span> <span class="packt_screen">Buffered</span> <span>pipelines, and choose to prefix the zones with the word</span> <kbd>Terrain_</kbd><span>. Save your changes to the GeoPackage. This is shown in the following screenshot:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/b95555ea-f499-459c-a9f8-3e9bd2c45db6.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Zonal histogram tool</div>
<p>Click on <span class="packt_screen">Run in Background</span> and close when finished. A new layer with one feature will have been added to the <span class="packt_screen">Layers</span> panel. Right-click on this layer and open the attribute table. The table only has one feature because we dissolved the buffer when we created it. The resulting table looks like the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/c32f9623-f121-4df5-b183-eed87d1d12f2.png"/></div>
<div class="packt_figref CDPAlignCenter CDPAlign">The attribute table generated by the zonal stats tool</div>
<p>We can see the field with <kbd>Terrain_x</kbd>, where <kbd>x</kbd> corresponds to the value in the <kbd>landcover</kbd> raster. The most impacted terrain of the pipeline was <kbd>Terrain_9</kbd>.</p>
<p>In <a href="bab7139e-9f38-4dff-b1eb-c5056be9c960.xhtml"/><a href="bab7139e-9f38-4dff-b1eb-c5056be9c960.xhtml">Chapter 7</a>, <em><span>Expanding QGIS 3</span></em>, we'll look at how we can combine the tools in questions 2 and 3 into a model to automate these processes. This would allow us to just run one tool.</p>
<p>Let's now move on to terrain modeling with raster data.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Raster analysis</h1>
                </header>
            
            <article>
                
<p>Create a new QGIS project and load into the map the <kbd>landcover.img</kbd> file. We'll use this layer to demonstrate a couple of the many raster processing tools in QGIS. On load, we have landcover classes with values ranging from 0 to 13. The value zero appears to correspond to water. In this example, we're going to set all of the values that are equal to zero to nodata. In GIS we would set raster data to no data when we have data that we don't want to use or display.</p>
<p class="mce-root"/>
<p class="mce-root"/>
<p>To change the 0 values in the <kbd>Landcover</kbd> dataset to nodata, select <span class="packt_screen">Raster</span> | <span class="packt_screen">Conversion</span> | <span class="packt_screen">Translate (Convert Format)</span> as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/b0ea5f6f-bfa4-4f39-b606-63d562fa6ba3.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Calling the Translate tool</div>
<p>The <span><span class="packt_screen">Translate</span></span> tool is very helpful to convert rasters into different data types and formats. It's built on the GDAL translate tool; you can read about the options with <kbd>gdal_translate</kbd> here: <a href="https://www.gdal.org/gdal_translate.html">https://www.gdal.org/gdal_translate.html</a>. With the <span class="packt_screen">Translate</span> tool open in QGIS, select the <kbd>landcover</kbd> layer as <span class="packt_screen">Input layer</span> and set <span class="packt_screen">Assign a specific nodata value to the output bands</span> to <kbd>0</kbd>. Save the output box labeled <span class="packt_screen">Converted</span> as <kbd>Landcover_Null.tif</kbd>. This is shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/093b7ca0-ae96-4678-889e-b391d452daac.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Using the Translate tool to set a no data value</div>
<p>The resulting raster will look like this:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/f4e1a064-adf7-48d8-aeda-d4c2c8899413.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Landcover with the values 0 set to no data</div>
<p>Using this newly created layer, we'll reclassify this raster dataset based on a conditional statement in <span class="packt_screen">Raster Calculator</span>. We'll set every terrain will a value greater than or equal to five to zero and everything else to one. Open <span class="packt_screen">Raster Calculator</span> and enter the following in the <span class="packt_screen">Raster Calculator Expression</span> window: <kbd>"Converted@1" &gt;= 5</kbd>, and save as <kbd>Landcover_Null_reclassified.tif</kbd> as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/42e9a1b8-4644-4a06-9ddb-95c739e8d21d.png" style=""/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Conditional statements in the Raster Calculator</div>
<p>The resulting binary raster will look like the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/413e49ac-4d61-4c13-b403-2eef522214a7.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Conditional raster generated from the Raster Calculator</div>
<p>You might not have expected this result as the values <kbd>0</kbd> are in black and <kbd>1</kbd> are displayed in white. We could alter this; to do so, we need to change the rendering for the values of <kbd>1</kbd> to be shaded and everything else to be transparent (or white). Right-click on the <kbd>Landcover_Null_reclassed</kbd> layer and select <span class="packt_screen">Properties</span>. Set <span class="packt_screen">Render type</span> to <span class="packt_screen">Paletted/Unique values</span>, click on <span class="packt_screen">Classify</span> and adjust the values of <kbd>1</kbd> to red and <kbd>0</kbd> to transparent, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/b021c4b1-c258-4243-bf34-b7ac1add9ba1.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Changing the raster rendering</div>
<p>In the next section, we'll look at converting this raster into a vector dataset.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Converting into vectors</h1>
                </header>
            
            <article>
                
<p>Reclassifying rasters is useful for many visualization and processing workflows but also useful for converting data into vectors. From the <span class="packt_screen">Raster</span> menu, select <span class="packt_screen">Conversion</span> | <span class="packt_screen">Polygonize (Raster to Vector)</span>, which will open the<span class="packt_screen"> Raster to Vector</span> tool. Save the <span class="packt_screen">Vectorized</span> layer as a new GeoPackage layer called <kbd>vectorised_terrains.gpkg</kbd> as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/3dfd5b02-b534-413f-9404-4c4b6ca5fe00.png" style=""/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Polygonize tool</div>
<p>This will take a little while to run as the raster is quite complex. Once finished, you'll have a vector layer that will look similar to the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/a4dc26dd-126d-49d8-8f3d-849e1b93596a.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">The resulting vector layer created from the conditional raster</div>
<p>The newly created vector dataset will have features with a <kbd>DN</kbd> <span>field </span>equal to either <kbd>1</kbd> or <kbd>0</kbd>. In this case, we aren't interested in any of the <kbd>DN</kbd> values equal to <kbd>0</kbd>. Open the attribute table of the layer and select the values in the <kbd>DN</kbd> field that are equal to <kbd>0</kbd> using the select features. Using an expression (click on the tenth button from the left in the attribute table). Click on <span class="packt_screen">Select features</span> and then <span class="packt_screen">Close</span>, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/c717f440-229a-40e3-bfbf-88fc6c014d85.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Editing the vectorized layer</div>
<p>Click on the Toggle editing mode button in the attribute table (first button on the left) and then click on the red trashcan to delete the selected values. Click on the Toggle editing mode to turn off editing and save the edits. The final data should now look similar to the following:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/6fde5516-75c9-40da-8be0-69765e5839df.png"/></div>
<div class="CDPAlignCenter CDPAlign packt_figref">Final vectorized terrain layer</div>
<p>There are many raster analysis tools in the QGIS processing toolbox that we could use. For example, if you have access to a DEM, you could create slope maps and other types of terrain analysis; search for <span class="packt_screen">Raster Terrain Analysis</span> in the <span class="packt_screen">Processing Toolbox</span>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we've dipped our toes into the Processing Toolbox in QGIS. We asked questions about our data. We used simple GIS processes and tools in QGIS to derive answers from our data. The power of GIS lies in its data. We also looked at both vector- and raster-based queries.</p>
<p>In the next chapter, we'<span>ll</span><span> </span><span>look at extending this by using the model builder to chain common processing tools together, before looking at Plugins and the Python Console.</span></p>


            </article>

            
        </section>
    </body></html>