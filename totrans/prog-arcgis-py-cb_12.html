<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch12"/>Chapter 12. Using Python for Advanced ArcGIS</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Getting started with the ArcGIS REST API</li><li class="listitem" style="list-style-type: disc">Making HTTP requests and parsing the response with Python</li><li class="listitem" style="list-style-type: disc">Getting layer information with the ArcGIS REST API and Python</li><li class="listitem" style="list-style-type: disc">Exporting a map with the ArcGIS REST API and Python</li><li class="listitem" style="list-style-type: disc">Querying a map service with the ArcGIS REST API and Python</li><li class="listitem" style="list-style-type: disc">Geocoding with the Esri World Geocoding Service</li><li class="listitem" style="list-style-type: disc">Using FieldMap and FieldMappings</li><li class="listitem" style="list-style-type: disc">Using a ValueTable to provide multivalue input to a tool</li></ul></div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec83"/>Introduction</h1></div></div></div><p>In this chapter, we will cover some topics that are of a more advanced nature. Specifically, you will learn how to access the ArcGIS REST API using the Python <code class="literal">requests</code> module. In doing so, you will learn how to access data and services published by ArcGIS Server and ArcGIS Online. The Python <code class="literal">requests</code> module includes capabilities <a id="id631" class="indexterm"/>that allow your script to submit requests to a URL endpoint and receive responses in various formats, including the popular JSON format. Toward the end of the chapter, we will also over a couple of miscellaneous ArcPy topics, including the use of the <code class="literal">FieldMap</code> and <code class="literal">FieldMappings</code> objects to merge datasets and also working with <code class="literal">ValueTables</code> for situations where a tool has the capability of accepting multiple inputs.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec84"/>Getting started with the ArcGIS REST API</h1></div></div></div><p>Before we<a id="id632" class="indexterm"/> dive too far into the coding, you need to understand some basic concepts of the ArcGIS REST API. You need to specifically know how to construct a URL and interpret the response that is returned.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec218"/>Getting ready</h2></div></div></div><p>All the<a id="id633" class="indexterm"/> resources and operations of the ArcGIS REST API are exposed through a hierarchy of endpoints, which we'll examine as we move through the course of this book. For now, let's examine the specific steps that you need to understand to submit a request to the API through Python. In this recipe, you will learn how to use the ArcGIS Server Services directory to construct URL requests.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec219"/>How to do it…</h2></div></div></div><p>We're going to use a publicly available ArcGIS Server instance to learn how to use the tools provided by the <code class="literal">Services</code> directory to construct a URL request:</p><div><ol class="orderedlist arabic"><li class="listitem">Open a web browser (preferably Google Chrome or Firefox). </li><li class="listitem">Go to <a class="ulink" href="http://sampleserver1.arcgisonline.com/arcgis/rest/services">http://sampleserver1.arcgisonline.com/arcgis/rest/services</a>:<div><img src="img/B04314_12_01.jpg" alt="How to do it…"/></div></li><li class="listitem">Next, we<a id="id634" class="indexterm"/> need to determine the well-known endpoint. This represents a server catalog that is a set of operations that ArcGIS Server can perform along with specific services. Navigate to <strong>Demographics</strong> | <strong>ESRI_Census_USA</strong>. This is a well-known endpoint. If you look at the address bar in your browser you should see this:<p>
<a class="ulink" href="http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer">http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer</a>.</p><p>Notice that this follows the pattern seen here:</p><p>
<code class="literal">http://&lt;host&gt;/&lt;site&gt;/rest/services/&lt;folder&gt;/&lt;serviceName&gt;/&lt;serviceType&gt;</code>
</p></li><li class="listitem">Spend some time clicking on the various links. As you do this, notice how the URL changes in the address bar. This URL is very important because it provides you with the content that will be submitted through a Python request:<div><img src="img/B04314_12_02.jpg" alt="How to do it…"/></div></li><li class="listitem">Next, you'll learn how to further construct URLs that can be submitted as requests <a id="id635" class="indexterm"/>to the ArcGIS REST API. This is a very important step. The syntax for the request includes the path to the resource along with an operation name followed by a list of parameters. The operation name indicates the kind of operation that will be performed against the resource. For example, you might want to export a map to an image file.</li><li class="listitem">The question mark begins the list of parameters. Each parameter is then provided as a set of key/value pairs separated by an ampersand. All of this information is combined into a single URL string. This is illustrated in the following URL:<p>
<code class="literal">http://&lt;resource-url&gt;/&lt;operation&gt;?&lt;parameter1=value1&gt;&amp;&lt;parameter2=value2&gt;</code>
</p><p>For now, we're going to just enter the URL into the address bar of the browser.  Copy and paste <code class="literal">http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/3/query?text=&amp;geometry=&amp;geometryType=esriGeometryPoint&amp;inSR=&amp;spatialRel=esriSpatialRelIntersects&amp;relationParam=&amp;objectIds=&amp;where=name+%3D+%27Bexar%27&amp;time=&amp;returnCountOnly=false&amp;returnIdsOnly=false&amp;returnGeometry=true&amp;maxAllowableOffset=&amp;outSR=&amp;outFields=&amp;f=json</code> into the address bar in your browser. You may want to use the digital version of this book to copy and paste this URL, rather than trying to type this into the address bar. Hit return to see this output:</p><div><img src="img/B04314_12_03.jpg" alt="How to do it…"/></div><p>You<a id="id636" class="indexterm"/> can use the Python <code class="literal">requests</code> module to simplify this process and access the response information directly from within your geoprocessing script. The <code class="literal">requests</code> module allows you to define the list of parameters as a Python dictionary and then it handles the creation of the URL query string, including URL encoding. You'll learn how to do that at the end of this exercise.</p></li><li class="listitem">The Services Directory contains dialog boxes that you can use to generate parameter values. You can find links to these dialog boxes at the bottom of the services page. In your browser, navigate to <a class="ulink" href="http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/1">http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/1</a>.</li><li class="listitem">Go to the bottom of the page and click on the <strong>Query</strong> link to display the dialog box, as seen in this screenshot:<div><img src="img/B04314_12_04.jpg" alt="How to do it…"/></div></li><li class="listitem">Add a <code class="literal">where</code> clause, as <a id="id637" class="indexterm"/>seen in the following screenshot. Set the <strong>Return Fields (Comma Seperated)</strong> to <code class="literal">POP2000, POP2007</code>, and <code class="literal">BLKGRP</code>. Change <strong>Format:</strong> to <code class="literal">JSON</code> and <strong>Return Geometry:</strong> to <code class="literal">False</code>. Then, click on <strong>Query (GET)</strong>:<div><img src="img/B04314_12_05.jpg" alt="How to do it…"/></div></li><li class="listitem">The<a id="id638" class="indexterm"/> query will run and these results will be returned:<div><img src="img/B04314_12_06.jpg" alt="How to do it…"/></div></li><li class="listitem">Examine <a id="id639" class="indexterm"/>the address bar in your browser to see the URL that was generated: <code class="literal">http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/1/query?text=&amp;geometry=&amp;geometryType=esriGeometryPolygon&amp;inSR=&amp;spatialRel=esriSpatialRelIntersects&amp;relationParam=&amp;objectIds=&amp;where=STATE_FIPS+%3D+%2748%27+and+CNTY_FIPS+%3D+%27021%27&amp;time=&amp;returnCountOnly=false&amp;returnIdsOnly=false&amp;returnGeometry=false&amp;maxAllowableOffset=&amp;outSR=&amp;outFields=POP2000%2CPOP2007%2CBLKGRP&amp;f=pjson</code>.</li><li class="listitem">In an upcoming recipe, you'll take this same URL, submit the request, and process the results using Python.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec220"/>How it works…</h2></div></div></div><p>The Services Directory of an ArcGIS Server instance provides a variety of tools that you can use <a id="id640" class="indexterm"/>to generate URL requests and examine the responses those requests produce. In this recipe, you learned how to use the query task to construct an attribute query. In doing so, you learned how a URL request is constructed.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec85"/>Making HTTP requests and parsing the response with Python</h1></div></div></div><p>There are a number of Python modules that you can use to make REST requests. There are really too <a id="id641" class="indexterm"/>many! Modules include <code class="literal">urllib2</code>, <code class="literal">httplib2</code>, <code class="literal">pycurl</code>, and <code class="literal">requests</code>. <code class="literal">requests</code> is definitely the best of the bunch in my opinion. It is <a id="id642" class="indexterm"/>cleaner and easier to use for repeated interaction <a id="id643" class="indexterm"/>with RESTful APIs. Once <a id="id644" class="indexterm"/>you've made the request, you can then parse the JSON response with the Python <code class="literal">json</code> module. In this recipe, you will learn how to do this.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec221"/>Getting ready</h2></div></div></div><p>The Python <code class="literal">requests</code> module can be used to submit <code class="literal">requests</code> to an ArcGIS Server resource and process the returned response. Follow these steps to learn the basic steps involved in submitting <code class="literal">requests</code> and processing the response using the <code class="literal">requests</code> module:</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec222"/>How to do it…</h2></div></div></div><p>Before we get started, make sure that you have downloaded and installed the <code class="literal">requests</code> module, using <code class="literal">pip</code>. If you haven't already done so, I have provided the following instructions to install both <code class="literal">pip</code> and the <code class="literal">requests</code> module:</p><div><div><h3 class="title"><a id="note12"/>Note</h3><p>This recipe and all subsequent recipes in this chapter use the Python <code class="literal">requests</code> module. If you don't already have this module installed on your computer, you will need to do so at this time. The <code class="literal">requests</code> module is installed using <code class="literal">pip</code>, which needs to be installed on your computer before the <code class="literal">requests</code> module is installed. Later versions of Python including 2.7.9 (on the Python2 series) and Python 3.4 include <code class="literal">pip</code> by default, so you may have it already. To test to see if you already have <code class="literal">pip</code> installed, you can enter the following from a DOS prompt:</p><div><pre class="programlisting">
<strong>pip install requests</strong>
</pre></div><p>If you don't have <code class="literal">pip</code> installed, you'll get an error message and you'll need to <code class="literal">install pip</code> (<a class="ulink" href="https://pip.pypa.io/en/latest/installing.html">https://pip.pypa.io/en/latest/installing.html</a>). Once installed, you<a id="id645" class="indexterm"/> can download and install the <code class="literal">requests</code> module by using the preceding install command.</p></div></div><div><ol class="orderedlist arabic"><li class="listitem">Open <strong>IDLE</strong> (or another Python development environment) and select <strong>File</strong> | <strong>New Window</strong>. Save the file under the name <code class="literal">C:\ArcpyBook\Ch12\ReqJSON.py</code>.</li><li class="listitem">Import the <code class="literal">requests</code> and <code class="literal">json</code> modules:<div><pre class="programlisting">import requests
import json</pre></div></li><li class="listitem">Create <a id="id646" class="indexterm"/>a new variable<a id="id647" class="indexterm"/> that contains a URL to a list of services provided by ArcGIS Online. This URL contains an output format of <code class="literal">pjson</code>, a JSON format contained in a pretty format to provide easy readability:<div><pre class="programlisting">import requests
import json
<strong>agisurl = "http://server.arcgisonline.com/arcgis/rest/services?f=pjson"</strong>
</pre></div></li><li class="listitem">Use the <code class="literal">get()</code> method in the <code class="literal">requests</code> module to submit an HTTP request to the ArcGIS REST API. You'll store the response in a variable called <code class="literal">r</code>:<div><pre class="programlisting">import requests
import json
agisurl = "http://server.arcgisonline.com/arcgis/rest/services?f=pjson"
<strong>r = requests.get(agisurl)</strong>
</pre></div></li><li class="listitem">Now, let's print out the response that is returned:<div><pre class="programlisting">import requests
import json
agisurl = "http://server.arcgisonline.com/arcgis/rest/services?f=pjson"
r = requests.get(agisurl)
<strong>print(r.text)</strong>
</pre></div></li><li class="listitem">Save your script.</li><li class="listitem">Run your script and you will see the following output. This is the JSON response that has been returned by the ArcGIS REST API:<div><img src="img/B04314_12_07.jpg" alt="How to do it…"/></div></li><li class="listitem">Use<a id="id648" class="indexterm"/> the <code class="literal">json.loads()</code> method to parse the returned <code class="literal">json</code> into a Python dictionary object. Go <a id="id649" class="indexterm"/>ahead and remove the previous print statement as well:<div><pre class="programlisting">import requests
import json
agisurl = "http://server.arcgisonline.com/arcgis/rest/services?f=pjson"
r = requests.get(agisurl)
<strong>decoded = json.loads(r.text)</strong>
<strong>print(decoded)</strong>
</pre></div></li><li class="listitem">You can check your work by examining the <code class="literal">C:\ArcpyBook\code\Ch12\ReqJSON.py</code> solution file.</li><li class="listitem">Save and run your script to see the output. The <code class="literal">loads()</code> method has converted the <code class="literal">json</code> output into a Python dictionary:<div><pre class="programlisting">
<strong>{u'folders': [u'Canvas', u'Demographics', u'Elevation', u'Ocean', u'Reference', u'Specialty', u'Utilities'], u'services': [{u'type': u'MapServer', u'name': u'ESRI_Imagery_World_2D'}, {u'type': u'MapServer', u'name': u'ESRI_StreetMap_World_2D'}, {u'type': u'GlobeServer', u'name': u'I3_Imagery_Prime_World'}, {u'type': u'GlobeServer', u'name': u'NASA_CloudCover_World'}, {u'type': u'MapServer', u'name': u'NatGeo_World_Map'}, {u'type': u'MapServer', u'name': u'NGS_Topo_US_2D'}, {u'type': u'MapServer', u'name': u'Ocean_Basemap'}, {u'type': u'MapServer', u'name': u'USA_Topo_Maps'}, {u'type': u'MapServer', u'name': u'World_Imagery'}, {u'type': u'MapServer', u'name': u'World_Physical_Map'}, {u'type': u'MapServer', u'name': u'World_Shaded_Relief'}, {u'type': u'MapServer', u'name': u'World_Street_Map'}, {u'type': u'MapServer', u'name': u'World_Terrain_Base'}, {u'type': u'MapServer', u'name': u'World_Topo_Map'}], u'currentVersion': 10.2}</strong>
</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec223"/>How it works…</h2></div></div></div><p>In this<a id="id650" class="indexterm"/> simple recipe, you learned <a id="id651" class="indexterm"/>how to use the Python <code class="literal">requests</code> module to submit a request to an ArcGIS Server instance by using the <code class="literal">requests.get()</code> method, and then process the response from the server. The <code class="literal">json.loads()</code> method was used to convert the response to a Python dictionary object for easier processing. The response contains basic data about the ArcGIS Server instance, including folders, services, and versions. We'll look at more complex examples in the coming recipes.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec86"/>Getting layer information with the ArcGIS REST API and Python</h1></div></div></div><p>A map <a id="id652" class="indexterm"/>service resource<a id="id653" class="indexterm"/> contains <a id="id654" class="indexterm"/>datasets that can include tables or layers. It contains basic information about a service, including feature layers, tables, and service descriptions. In this recipe, you will learn how to return layer information from a map service, using Python and the ArcGIS REST API.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec224"/>Getting ready</h2></div></div></div><p>To get information about a specific layer in a map service, you will need to reference the index number that is associated with the layer. When you examine the Services Directory page for a service, you will find a list of layers that are part of the map service along with index numbers for each layer. The index numbers are used instead of the layer name when requesting information about a layer. As we've done in the past few recipes, we'll use the Python <code class="literal">requests</code> module to make the request and process the response.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec225"/>How to do it…</h2></div></div></div><p>Follow these steps to learn how to get information about a layer from a map service:</p><div><ol class="orderedlist arabic"><li class="listitem">In IDLE or another Python development environment, create a new Python script called <code class="literal">GetLayerInformation.py</code> and save it to the <code class="literal">C:\ArcpyBook\Ch12</code> folder.</li><li class="listitem">Import<a id="id655" class="indexterm"/> the <code class="literal">requests</code> and <code class="literal">json</code> modules:<div><pre class="programlisting">import requests
import json</pre></div></li><li class="listitem">Create <a id="id656" class="indexterm"/>the following <code class="literal">agisurl</code> variable. This will serve as the base URL <a id="id657" class="indexterm"/>that references a specific layer in the <code class="literal">ESRI_CENSUS_USA</code> map service. Here, we are referring to a layer with an index number of <code class="literal">1</code>. Also, include an output format of <code class="literal">pjson</code>:<div><pre class="programlisting">import requests
import json
<strong>agisurl = "http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/1?f=pjson"</strong>
</pre></div></li><li class="listitem">Create a <code class="literal">payload</code> variable. This variable will hold a Python dictionary object containing the parameters that will be passed as part of the request. We'll include a <code class="literal">where</code> clause and set a few other properties:<div><pre class="programlisting">import requests
import json

agisurl = "http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/1"
<strong>payload = { 'where': 'STATE_FIPS = \'48\' and CNTY_FIPS = \'021\'','returnCountyOnly': 'false', </strong>
<strong>'returnIdsOnly': 'false', 'returnGeometry': 'false', </strong>
<strong>'f': 'pjson'}</strong>
</pre></div></li><li class="listitem">Call the <code class="literal">requests.get()</code> method and pass the <code class="literal">agisurl</code> variable. The response will be stored in a variable called <code class="literal">r</code>: <div><pre class="programlisting">import requests
import json
agisurl = http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/1?f=pjson
payload = { 'where': 'STATE_FIPS = \'48\' and CNTY_FIPS = \'021\'','returnCountyOnly': 'false', \
            'returnIdsOnly': 'false', 'returnGeometry': 'false', \
            'f': 'pjson'}

<strong>r = requests.get(agisurl, params=payload)</strong>
</pre></div></li><li class="listitem">Convert <a id="id658" class="indexterm"/>the JSON to a Python dictionary:<div><pre class="programlisting">r = requests.get(agisurl, params=payload)
decoded = json.loads(r.text)</pre></div></li><li class="listitem">Print<a id="id659" class="indexterm"/> out<a id="id660" class="indexterm"/> the name, geographic extent, and fields of the layer:<div><pre class="programlisting">r = requests.get(agisurl, params=payload)

decoded = json.loads(r.text)

<strong>print("The layer name is: " + decoded['name'])</strong>
<strong>print("The xmin: " + str(decoded['extent']['xmin']))</strong>
<strong>print("The xmax: " + str(decoded['extent']['xmax']))</strong>
<strong>print("The ymin: " + str(decoded['extent']['ymin']))</strong>
<strong>print("The ymax: " + str(decoded['extent']['ymax']))</strong>
<strong>print("The fields in this layer: ")</strong>
<strong>for rslt in decoded['fields']:</strong>
<strong>     print(rslt['name'])</strong>
</pre></div></li><li class="listitem">You can check your work by examining the <code class="literal">C:\ArcpyBook\code\Ch12\GetLayerInformation.py</code> solution file.</li><li class="listitem">Save the script and run it to see this output:<div><img src="img/B04314_12_12.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec226"/>How it works…</h2></div></div></div><p>In this <a id="id661" class="indexterm"/>recipe, we <a id="id662" class="indexterm"/>passed a <a id="id663" class="indexterm"/>reference to a URL that contains the path to a specific layer within a map service. The layer was specified through the use of an index number (<code class="literal">1</code>, in this case). This URL was passed to the Python <code class="literal">requests.get()</code> method. The response was returned in <code class="literal">json</code> format and we then converted this to a Python dictionary. The dictionary included key/value pairs for the name, extent, and fields of the layer. That information was printed to the console.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec87"/>Exporting a map with the ArcGIS REST API and Python</h1></div></div></div><p>The <a id="id664" class="indexterm"/>ArcGIS REST API has a large <a id="id665" class="indexterm"/>set of operations<a id="id666" class="indexterm"/> that you can use when requesting information from an ArcGIS Server instance. For example, you can export maps, query layers, geocode addresses, and much more. In this recipe, you will learn how to export a map image from a map service.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec227"/>Getting ready</h2></div></div></div><p>The <code class="literal">export</code> operation can be used to create a map image from a map service. The response <a id="id667" class="indexterm"/>to this request includes<a id="id668" class="indexterm"/> the URL of the image, width, height, extent, and scale. In this recipe, you'll use the export operation to export a <a id="id669" class="indexterm"/>map as an image file.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec228"/>How to do it…</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">In your Python development environment, create a new script, save it as <code class="literal">C:\ArcpyBook\Ch12\ExportMapToImage.py</code>.</li><li class="listitem">Import the <code class="literal">requests</code> and <code class="literal">json</code> modules:<div><pre class="programlisting">import requests
import json</pre></div></li><li class="listitem">Create a new variable called <code class="literal">agisurl</code>, assign the URL, and export the operation, as seen here:<div><pre class="programlisting">import requests
import json
<strong>agisurl = "http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer/export"</strong>
</pre></div></li><li class="listitem">Create a new dictionary object that will hold the key/value pairs that help define the query string. These are the parameters that will be passed to the export operation:<div><pre class="programlisting">import requests
import json
agisurl = "http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer/export"
<strong>payload = { 'bbox':'-115.8,30.4, 85.5,50.5', </strong>
<strong>            'size':'800,600', </strong>
<strong>            'imageSR': '102004', </strong>
<strong>            'format':'gif', </strong>
<strong>            'transparent':'false', </strong>
<strong>            'f': 'pjson'}</strong>
</pre></div></li><li class="listitem">Call the <code class="literal">requests.get()</code> method, passing the URL and the Python dictionary of parameters. The response will be stored in a variable called <code class="literal">r</code>:<div><pre class="programlisting">import requests
import json
agisurl = "http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer/export"
payload = { 'bbox':'-115.8,30.4, 85.5,50.5', 'size':'800,600', 'imageSR': '102004', 'format':'gif', 'transparent':'false', 'f': 'pjson'}
<strong>r = requests.get(agisurl, params=payload)</strong>
</pre></div></li><li class="listitem">Print <a id="id670" class="indexterm"/>out the contents<a id="id671" class="indexterm"/> of the <code class="literal">response</code> object:<div><pre class="programlisting">import requests
import json
agisurl = "http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer/export"
payload = { 'bbox':'-115.8,30.4, 85.5,50.5', 
            'size':'800,600', 
            'imageSR': '102004', 
            'format':'gif', 
            'transparent':'false', 
                  'f': 'pjson'}
r = requests.get(agisurl, params=payload)
<strong>print(r.text)</strong>
</pre></div></li><li class="listitem">You <a id="id672" class="indexterm"/>can check your work by examining the <code class="literal">C:\ArcpyBook\code\Ch12\ExportMapToImage.py</code> solution file.</li><li class="listitem">Save and run the script to see an output similar to this:<div><img src="img/B04314_12_08.jpg" alt="How to do it…"/></div></li><li class="listitem">Copy and paste the URL for the <code class="literal">.gif</code> file that was generated into your browser address bar, and click on return on your keyboard to see the file:<div><img src="img/B04314_12_09.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec229"/>How it works…</h2></div></div></div><p>The <a id="id673" class="indexterm"/>export operation in the <a id="id674" class="indexterm"/>ArcGIS REST API can be used to <a id="id675" class="indexterm"/>export an image file from a map service. If you examine <a class="ulink" href="http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer/export">http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Specialty/ESRI_StateCityHighway_USA/MapServer/export</a>, which we used to generate the map image in this recipe, you'll see the term <code class="literal">export</code> at the end of the URL. This is what triggers the execution of the <code class="literal">export</code> operation. In addition to this, we also appended a bounding box (map extent), size, spatial reference for the image, and format through the payload variable. The request is sent to the server through the <code class="literal">requests.get()</code> method which accepts both the URL and payload variable.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec88"/>Querying a map service with the ArcGIS REST API and Python</h1></div></div></div><p>The <code class="literal">query</code> operation in the ArcGIS REST API performs a query against a map service and<a id="id676" class="indexterm"/> returns a feature set. The<a id="id677" class="indexterm"/> feature set includes <a id="id678" class="indexterm"/>values for fields requested by the user and can also return geometry, if requested.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec230"/>Getting ready</h2></div></div></div><p>In this recipe, you will build on the first recipe, in which you generated a URL using the ArcGIS Services page dialog box to generate results. In this recipe, you will use the ArcGIS Server Services page dialog box to generate a URL request that queried a map service layer and returned results. You may recall that the URL was <code class="literal">http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/1/query?text=&amp;geometry=&amp;geometryType=esriGeometryPolygon&amp;inSR=&amp;spatialRel=esriSpatialRelIntersects&amp;relationParam=&amp;objectIds=&amp;where=STATE_FIPS+%3D+%2748%27+and+CNTY_FIPS+%3D+%27021%27&amp;time=&amp;returnCountOnly=false&amp;returnIdsOnly=false&amp;returnGeometry=false&amp;maxAllowableOffset=&amp;outSR=&amp;outFields=POP2000%2CPOP2007%2CBLKGRP&amp;f=pjson</code>.</p><p>Now, let's learn how to submit this request using Python.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec231"/>How to do it…</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">In IDLE or another Python development environment, create a new Python script called <code class="literal">QueryMapService.py</code> and save it to the <code class="literal">C:\ArcpyBook\Ch12</code> folder.</li><li class="listitem">In your browser, navigate to: <a class="ulink" href="http://resources.arcgis.com/en/help/arcgis-rest-api/index.html#//02r3000000p1000000">http://resources.arcgis.com/en/help/arcgis-rest-api/index.html#//02r3000000p1000000</a>. This is the REST API page for the <code class="literal">query</code> operation against a layer in a map service. As you scroll down the <code class="literal">help</code> page, you should see the same parameters as were generated using the dialog box, such as <code class="literal">geometry</code>, <code class="literal">geometryType</code>, <code class="literal">inSR</code>, <code class="literal">spatialRel</code>, <code class="literal">where</code>, and others.</li><li class="listitem">In your script, import the <code class="literal">requests</code> and <code class="literal">json</code> modules:<div><pre class="programlisting">import requests
import json</pre></div></li><li class="listitem">Create the following <code class="literal">agisurl</code> variable. This will serve as the base URL that references the <code class="literal">query</code> operation on the <code class="literal">census block group</code> layer (identified by an identifier of <code class="literal">1</code> in the URL) in the <code class="literal">ESRI_Census_USA</code> map service:<div><pre class="programlisting">import requests
import json
<strong>agisurl = "http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/1/query"</strong>
</pre></div></li><li class="listitem">Now, create a Python dictionary object, as shown in the following code. We're going<a id="id679" class="indexterm"/> to leave <a id="id680" class="indexterm"/>out <a id="id681" class="indexterm"/>some of the parameters that were not defined or used in the dialog box. We're just creating an attribute query in this instance so that all the geometry parameters can be removed:<div><pre class="programlisting">import requests
import json
agisurl = "http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/1/query"
<strong>payload = { 'where':'STATE_FIPS = \'48\' and CNTY_FIPS =       \'021\'','returnCountOnly':'false',</strong>
<strong>'returnIdsOnly': 'false', 'returnGeometry':'false', </strong>
<strong>'outFields':'POP2000,POP2007,BLKGRP',</strong>
<strong>'f': 'pjson'}</strong>
</pre></div></li><li class="listitem">The <code class="literal">requests.get()</code> method can accept a Python dictionary object as the second parameter. This dictionary defines the set of key/value pairs that help define the query string. Add the <code class="literal">requests.get()</code> method:<div><pre class="programlisting">import requests
import json
agisurl = "http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/1/query"
payload = { 'where':'STATE_FIPS = \'48\' and CNTY_FIPS =       \'021\'','returnCountOnly':'false', \
'returnIdsOnly': 'false', 'returnGeometry':'false', \
'outFields':'POP2000,POP2007,BLKGRP', \
'f': 'pjson'}
<strong>r = requests.get(agisurl, params=payload)</strong>
</pre></div></li><li class="listitem">Include a <code class="literal">print</code> statement in order to print the response that is returned.<div><pre class="programlisting">import requests, json
agisurl = "http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Demographics/ESRI_Census_USA/MapServer/1/query"
payload = { 'where':'STATE_FIPS = \'48\' and CNTY_FIPS =       \'021\'','returnCountOnly':'false', \
'returnIdsOnly': 'false', 'returnGeometry':'false', \
'outFields':'POP2000,POP2007,BLKGRP', \
'f': 'pjson'}
r = requests.get(agisurl, params=payload)
<strong>print(r.text)</strong>
</pre></div></li><li class="listitem">Save<a id="id682" class="indexterm"/> the script<a id="id683" class="indexterm"/> and <a id="id684" class="indexterm"/>run it to see this output:<div><img src="img/B04314_12_10.jpg" alt="How to do it…"/></div></li><li class="listitem">Now, convert this JSON object to a Python dictionary. Also, comment out the <code class="literal">print</code> statement that you added in the last step:<div><pre class="programlisting">r = requests.get(agisurl, params=payload)
#print(r.text)
decoded = json.loads(r.text)</pre></div></li><li class="listitem">The Python dictionary object returned by the <code class="literal">json.loads()</code> method will contain the contents of the JSON object. You can then pull the individual data <a id="id685" class="indexterm"/>elements <a id="id686" class="indexterm"/>out of the dictionary. In this case, we want to pull out the attributes of each <a id="id687" class="indexterm"/>of the feature returned <code class="literal">(BLKGRP</code>, <code class="literal">POP2007</code>, and <code class="literal">POP2000</code>). We can do so by using the following code, which you'll need to add to your script:<div><pre class="programlisting">r = requests.get(agisurl, params=payload)
#print(r.text)
decoded = json.loads(r.text)
<strong>for rslt in decoded['features']:</strong>
<strong>    print("Block Group: " + str(rslt['attributes']['BLKGRP']))</strong>
<strong>    print("Population 2000: " + str(rslt['attributes']['POP2000']))</strong>
<strong>    print("Population 2007: " + str(rslt['attributes']['POP2007']))</strong>
</pre></div></li><li class="listitem">You can check your work by examining the <code class="literal">C:\ArcpyBook\code\Ch12\QueryMapService.py</code> solution file.</li><li class="listitem">Save and execute your script to see these results:<div><img src="img/B04314_12_11.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec232"/>How it works…</h2></div></div></div><p>The <code class="literal">query</code> operation in the ArcGIS REST API can be used to perform spatial and attribute <a id="id688" class="indexterm"/>queries against <a id="id689" class="indexterm"/>a layer in an <a id="id690" class="indexterm"/>ArcGIS Server map service. We used the <code class="literal">requests.get()</code> method to perform an attribute query against the <code class="literal">census block groups</code> layer. We included various parameters, including a where clause that will only return records where the <code class="literal">ST_FIPS</code> code is <code class="literal">48</code> and the <code class="literal">CNTY_FIPS</code> code is <code class="literal">021</code> (Bexar County, Texas). The <code class="literal">response</code> object was then converted to a Python dictionary and we included a <code class="literal">for</code> loop to iterate through each of the returned records and print out the block group name, and the population for the years 2000 and 2007.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec89"/>Geocoding with the Esri World Geocoding Service</h1></div></div></div><p>The<a id="id691" class="indexterm"/> Esri World Geocoding Service can <a id="id692" class="indexterm"/>be used to find addresses and places in supported countries. This service contains both free and paid operations. The <code class="literal">find</code> operation, which finds one address per request, is always a free service. The <code class="literal">geocodeAddresses</code> operation accepts a list of addresses for geocoding and is a paid service only. The other operations can be free or paid. If you are using the operations in a temporary capacity, they are free. Temporary simply means that you aren't storing the results for later use. If this is the case, then it is a paid service. In this recipe, you will use the Esri World Geocoding service to geocode an address.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec233"/>Getting ready</h2></div></div></div><p>The <a id="id693" class="indexterm"/>ArcGIS REST API <code class="literal">find</code> operation<a id="id694" class="indexterm"/> can be used to find the geographic coordinates of a single address. As we've done in the past few recipes, we'll use the Python <code class="literal">requests</code> module to make the request and process the response.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec234"/>How to do it…</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">In IDLE or another Python development environment, create a new Python script called <code class="literal">GeocodeAddress.py</code> and save it to the <code class="literal">C:\ArcpyBook\Ch12</code> folder.</li><li class="listitem">Import the <code class="literal">requests</code> and <code class="literal">json</code> modules:<div><pre class="programlisting">import requests
import json</pre></div></li><li class="listitem">Create the following <code class="literal">agisurl</code> variable. This will point to the Esri World Geocoding Service and the <code class="literal">find</code> operation for a particular service. Also, define a Python dictionary that will hold the address to be submitted and the output format. You can change the address, if you wish:<div><pre class="programlisting">import requests
import json
<strong>agisurl = "http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/find"</strong>
<strong>payload = { 'text': '1202 Sand Wedge, San Antonio, TX, 78258','f':'pjson'}</strong>
</pre></div></li><li class="listitem">Call the <code class="literal">requests.get()</code> method and pass the URL and parameters. The response will be stored in a variable called <code class="literal">r</code>. Then, convert the returned JSON object to a Python dictionary:<div><pre class="programlisting">import requests
import json
agisurl = "http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/find"
payload = { 'text': '1202 Sand Wedge, San Antonio, TX, 78258','f':'pjson'}

<strong>r = requests.get(agisurl, params=payload)</strong>

<strong>decoded = json.loads(r.text)</strong>
</pre></div></li><li class="listitem">Print out some of the results:<div><pre class="programlisting">import requests
import json
agisurl = "http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/find"
payload = { 'text': '1202 Sand Wedge, San Antonio, TX, 78258','f':'pjson'}

r = requests.get(agisurl, params=payload)

decoded = json.loads(r.text)

<strong>print("The geocoded address: " + decoded['locations'][0]['name'])</strong>
<strong>print("The longitude: " + str(decoded['locations'][0]['feature']['geometry']['x']))</strong>
<strong>print("The lattitude: " + str(decoded['locations'][0]['feature']['geometry']['y']))</strong>
<strong>print("The geocode score: " + str(decoded['locations'][0]['feature']['attributes']['Score']))</strong>
<strong>print("The address type: " + str(decoded['locations'][0]['feature']['attributes']['Addr_Type']))</strong>
</pre></div></li><li class="listitem">You <a id="id695" class="indexterm"/>can check your work <a id="id696" class="indexterm"/>by examining the <code class="literal">C:\ArcpyBook\code\Ch12\GeocodeAddress.py</code> solution file.</li><li class="listitem">Save the script and run it to see the following output:<div><pre class="programlisting">
<strong>The geocoded address: 1202 Sand Wedge, San Antonio, Texas, 78258</strong>
<strong>The longitude: -98.4744442811</strong>
<strong>The lattitude: 29.6618639681</strong>
<strong>The geocode score: 100</strong>
<strong>The address type: PointAddress</strong>
</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec235"/>How it works…</h2></div></div></div><p>The <code class="literal">find</code> operation in the ArcGIS REST API can be used to perform geocoding operations for a single address. As we've done in the past few recipes, we used the Python <code class="literal">requests.get()</code> method to submit an operation request (find, in this case) along parameters that include the address to be geocoded. The response that was returned included <a id="id697" class="indexterm"/>the latitude and longitude <a id="id698" class="indexterm"/>of the address, geocoded score, and the address type.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec90"/>Using FieldMap and FieldMappings</h1></div></div></div><p>Up until this <a id="id699" class="indexterm"/>point in the chapter, we've covered how to use Python with the<a id="id700" class="indexterm"/> ArcGIS REST API to access ArcGIS Server services. Now, we're going to switch gears and go back into the ArcPy module and discuss the <code class="literal">FieldMap</code> and <code class="literal">FieldMappings</code> classes.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec236"/>Getting ready</h2></div></div></div><p>A common GIS operation is to merge several disparate datasets into a single dataset of a larger area. Often, the fields in the datasets to be merged will be the same and there won't be any problems. However, there will be times when the fields of the various datasets do not match. In this case, you will need to map the relationship between fields in one dataset to fields in another dataset.</p><div><img src="img/B04314_12_13.jpg" alt="Getting ready"/></div><p>The preceding diagram displays the relationship between the various ArcPy classes that are used to <a id="id701" class="indexterm"/>define field mapping. A <code class="literal">FieldMap</code> object contains a field definition <a id="id702" class="indexterm"/>and a list of input fields from one or more tables, or feature classes that provide the values for the field. Each <code class="literal">FieldMap</code> object that you create is then added to a <code class="literal">FieldMappings</code> object, which serves as a container for these objects. Finally, the <code class="literal">FieldMappings</code> object can then be sent as input to various geoprocessing tools, such as the <code class="literal">Merge</code> tool.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec237"/>How to do it…</h2></div></div></div><p>In this exercise, you'll learn how to use the FieldMap and FieldMappings objects:</p><div><ol class="orderedlist arabic"><li class="listitem">In IDLE or another Python development environment, create a new Python script called <code class="literal">UsingFieldMap.py</code> and save it to your <code class="literal">C:\ArcpyBook\Ch12</code> folder.</li><li class="listitem">Import <code class="literal">arcpy</code>:<div><pre class="programlisting">import arcpy</pre></div></li><li class="listitem">Set the workspace environment variable and a variable that will point to the output feature class:<div><pre class="programlisting">import arcpy

arcpy.env.workspace = r"c:\ArcpyBook\data"
outFeatureClass = r"c:\ArcpyBook\data\AllTracts.shp"</pre></div></li><li class="listitem">Create a <code class="literal">FieldMappings</code> object and three <code class="literal">FieldMap</code> objects. The <code class="literal">FieldMap</code> objects <a id="id703" class="indexterm"/>will hold references to fields for a state <strong>Federal Information Processing Standard</strong> (<strong>FIPS</strong>) code, county FIPS code, and a tract:<div><pre class="programlisting">arcpy.env.workspace = r"c:\ArcyBook\data"
outFeatureClass = r"c:\ArcpyBook\data\AllTracts.shp"

<strong>fieldmappings = arcpy.FieldMappings()</strong>
<strong>fldmap_STFIPS = arcpy.FieldMap()</strong>
<strong>fldmap_COFIPS = arcpy.FieldMap()</strong>
<strong>fldmap_TRACT = arcpy.FieldMap()</strong>
</pre></div></li><li class="listitem">Get a list of all the County polygon feature classes in the current workspace. Each County feature class has a field called <code class="literal">STFID</code>, which contains the state FIPS code, county FIPS code, and a tract for each feature. This information is stored as one long string (<code class="literal">48491020301</code>, for example), where the first two characters are the state code, the third through fifth characters are the county code, and the remaining characters are the tract. As part of the merge operation, we're going to pull each of the individual elements out and store them in separate fields:<div><pre class="programlisting">fieldmappings = arcpy.FieldMappings()
fieldmap_STFIPS = arcpy.FieldMap()
fieldmap_COFIPS = arcpy.FieldMap()
<strong>fieldmap_TRACT = arcpy.FieldMap()</strong>

<strong>#List all feature classes that start with 'County' and type Polygon</strong>
<strong>fclss = arcpy.ListFeatureClasses("County*", "Polygon")</strong>
</pre></div></li><li class="listitem">Create<a id="id704" class="indexterm"/> a <code class="literal">ValueTable</code> object to hold the feature classes<a id="id705" class="indexterm"/> that are to be merged. <code class="literal">ValueTable</code> functions as a container object. It will hold the mapping information for each of the feature classes in the workspace. All the information is pulled from a single field (<code class="literal">STFID</code>), but we need to create separate <code class="literal">FieldMap</code> input fields for <code class="literal">STFIPS</code>, <code class="literal">COFIPS</code>, and <code class="literal">TRACT</code>:<div><pre class="programlisting">fclss = arcpy.ListFeatureClasses("County*", "Polygon")

<strong>vTab = arcpy.ValueTable()</strong>
<strong>for fc in fclss:</strong>
<strong>  fieldmappings.addTable(fc)</strong>
<strong>  fldmap_STFIPS.addInputField(fc, "STFID")</strong>
<strong>  fldmap_COFIPS.addInputField(fc, "STFID")</strong>
<strong>  fldmap_TRACT.addInputField(fc, "STFID")</strong>
<strong>  vTab.addRow(fc)</strong>
</pre></div></li><li class="listitem">Add the content for the <code class="literal">STFIPS</code> field. We use the <code class="literal">startTextPosition()</code> function to pull out the first two characters from the <code class="literal">STFID</code> column. The first position is <code class="literal">0</code>, so we need to use <code class="literal">setStartTextPosition(x,0)</code>. In this step, we also define the output field for the <code class="literal">STFIPS FieldMap</code> object, name the field, and define the output field name:<div><pre class="programlisting">vTab = arcpy.ValueTable()
for fc in fclss:
  fieldmappings.addTable(fc)
  fldmap_STFIPS.addInputField(fc, "STFID")
  fldmap_COFIPS.addInputField(fc, "STFID")
  fldmap_TRACT.addInputField(fc, "STFID")
  vTab.addRow(fc)

<strong># STFIPS field</strong>
<strong>for x in range(0, fldmap_STFIPS.inputFieldCount):</strong>
<strong>  fldmap_STFIPS.setStartTextPosition(x, 0)</strong>
<strong>  fldmap_STFIPS.setEndTextPosition(x, 1)</strong>

<strong>fld_STFIPS = fldmap_STFIPS.outputField</strong>
<strong>fld_STFIPS.name = "STFIPS"</strong>
<strong>fldmap_STFIPS.outputField = fld_STFIPS</strong>
</pre></div></li><li class="listitem">Add <a id="id706" class="indexterm"/>content for the <code class="literal">COFIPS</code> field. The position of these<a id="id707" class="indexterm"/> three characters is <code class="literal">2</code>-<code class="literal">4</code> from the string pulled out of the <code class="literal">STFID</code> column:<div><pre class="programlisting"># STFIPS field
for x in range(0, fldmap_STFIPS.inputFieldCount):
  fldmap_STFIPS.setStartTextPosition(x, 0)
  fldmap_STFIPS.setEndTextPosition(x, 1)

fld_STFIPS = fldmap_STFIPS.outputField
fld_STFIPS.name = "STFIPS"
fldmap_STFIPS.outputField = fld_STFIPS

<strong># COFIPS field</strong>
<strong>for x in range(0, fldmap_COFIPS.inputFieldCount):</strong>
<strong>  fldmap_COFIPS.setStartTextPosition(x, 2)</strong>
<strong>  fldmap_COFIPS.setEndTextPosition(x, 4)</strong>

<strong>fld_COFIPS = fldmap_COFIPS.outputField</strong>
<strong>fld_COFIPS.name = "COFIPS"</strong>
<strong>fldmap_COFIPS.outputField = fld_COFIPS</strong>
</pre></div></li><li class="listitem">Add content for the <strong>TRACT</strong> field:<div><pre class="programlisting"># COFIPS field
for x in range(0, fldmap_COFIPS.inputFieldCount):
	fldmap_COFIPS.setStartTextPosition(x, 2)
	fldmap_COFIPS.setEndTextPosition(x, 4)

fld_COFIPS = fldmap_COFIPS.outputField
fld_STFIPS.name = "COFIPS"
fldmap_COFIPS.outputField = fld_COFIPS

<strong># TRACT field</strong>
<strong>for x in range(0, fldmap_TRACT.inputFieldCount):</strong>
<strong>  fldmap_TRACT.setStartTextPosition(x, 5)</strong>
<strong>  fldmap_TRACT.setEndTextPosition(x, 12)</strong>

<strong>fld_TRACT = fldmap_TRACT.outputField</strong>
<strong>fld_TRACT.name = "TRACT"</strong>
<strong>fldmap_TRACT.outputField = fld_TRACT</strong>
</pre></div></li><li class="listitem">Add the <code class="literal">FieldMap</code> objects to the <code class="literal">FieldMappings</code> object:<div><pre class="programlisting"># TRACT field
for x in range(0, fldmap_TRACT.inputFieldCount):
	fldmap_TRACT.setStartTextPosition(x, 5)
	fldmap_TRACT.setEndTextPosition(x, 12)

fld_TRACT = fldmap_TRACT.outputField
fld_TRACT.name = "TRACT"
fldmap_TRACT.outputField = fld_TRACT

<strong>#Add fieldmaps into the fieldmappings objec</strong>
<strong>fieldmappings.addFieldMap(fldmap_STFIPS)</strong>
<strong>fieldmappings.addFieldMap(fldmap_COFIPS)</strong>
<strong>fieldmappings.addFieldMap(fldmap_TRACT)</strong>
</pre></div></li><li class="listitem">Run<a id="id708" class="indexterm"/> the <code class="literal">Merge</code> tool, passing in the <code class="literal">vTab</code>, output feature <a id="id709" class="indexterm"/>class, and <code class="literal">fieldmappings</code> object:<div><pre class="programlisting">#Add fieldmaps into the fieldmappings objec
fieldmappings.addFieldMap(fldmap_STFIPS)
fieldmappings.addFieldMap(fldmap_COFIPS)
fieldmappings.addFieldMap(fldmap_TRACT)

<strong>arcpy.Merge_management(vTab, outFeatureClass,fieldmappings)</strong>
<strong>print("Merge completed")</strong>
</pre></div></li><li class="listitem">The entire script should appear as follows:<div><pre class="programlisting">import arcpy

Arcpy.env.workspace = r"c:\ArcyBook\data"
outFeatureClass = r"c:\ArcpyBook\data\AllTracts.shp"

fieldmappings = arcpy.FieldMappings()
fldmap_STFIPS = arcpy.FieldMap()
fldmap_COFIPS = arcpy.FieldMap()
fldmap_TRACT = arcpy.FieldMap()

#List all feature classes that start with 'County' and type Polygon
fclss = arcpy.ListFeatureClasses("County*", "Polygon")

vTab = arcpy.ValueTable()
for fc in fclss:
  fieldmappings.addTable(fc)
  fldmap_STFIPS.addInputField(fc, "STFID")
  fldmap_COFIPS.addInputField(fc, "STFID")
  fldmap_TRACT.addInputField(fc, "STFID")
  vTab.addRow(fc)

# STFIPS field
for x in range(0, fldmap_STFIPS.inputFieldCount):
  fldmap_STFIPS.setStartTextPosition(x, 0)
  fldmap_STFIPS.setEndTextPosition(x, 1)

fld_STFIPS = fldmap_STFIPS.outputField
fld_STFIPS.name = "STFIPS"
fldmap_STFIPS.outputField = fld_STFIPS

# COFIPS field
for x in range(0, fldmap_COFIPS.inputFieldCount):
  fldmap_COFIPS.setStartTextPosition(x, 2)
  fldmap_COFIPS.setEndTextPosition(x, 4)

fld_COFIPS = fldmap_COFIPS.outputField
fld_COFIPS.name = "COFIPS"
fldmap_COFIPS.outputField = fld_COFIPS

# TRACT field
for x in range(0, fldmap_TRACT.inputFieldCount):
	fldmap_TRACT.setStartTextPosition(x, 5)
	fldmap_TRACT.setEndTextPosition(x, 12)

fld_TRACT = fldmap_TRACT.outputField
fld_TRACT.name = "TRACT"
fldmap_TRACT.outputField = fld_TRACT

#Add fieldmaps into the fieldmappings objec
fieldmappings.addFieldMap(fldmap_STFIPS)
fieldmappings.addFieldMap(fldmap_COFIPS)
fieldmappings.addFieldMap(fldmap_TRACT)

arcpy.Merge_management(vTab, outFeatureClass,fieldmappings)
print("Merge completed")</pre></div></li><li class="listitem">You <a id="id710" class="indexterm"/>can <a id="id711" class="indexterm"/>check your work by examining the <code class="literal">C:\ArcpyBook\code\Ch12\UsingFieldMap.py</code> solution file.</li><li class="listitem">Save the script and run it.</li><li class="listitem">In ArcMap, add the <code class="literal">All_Tracts.shp</code> file that was created as a result of the script. You should see a merged set of counties and if you open the attribute table, you'll see the new fields that were created as well as the original fields:<div><img src="img/B04314_12_14.jpg" alt="How to do it…"/></div></li><li class="listitem">In the <a id="id712" class="indexterm"/>data view for the <code class="literal">All_Tracts.shp</code> file, you should <a id="id713" class="indexterm"/>now see a single merged polygon layer, as seen in the screenshot below.<div><img src="img/B04314_12_15.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec238"/>How it works…</h2></div></div></div><p>The <code class="literal">FieldMap</code> and <code class="literal">FieldMappings</code> objects in the ArcPy module along with the <code class="literal">Merge</code> tool, can<a id="id714" class="indexterm"/> be used for GIS operations that need to merge datasets that have <a id="id715" class="indexterm"/>fields that do not match. The <code class="literal">FieldMap</code> object can also be used when you need to pull out a contiguous sequence of string values from a longer set of string values. In this recipe, you learned how to use the <code class="literal">FieldMap</code> object to pull state, county, and census information from a single field. We created individual <code class="literal">FieldMap</code> objects to hold this information and then added them to a <code class="literal">FieldMappings</code> object that was then passed into the <code class="literal">Merge</code> tool to create a new layer, which contains three distinct fields that hold this information.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec91"/>Using a ValueTable to provide multivalue input to a tool</h1></div></div></div><p>Many<a id="id716" class="indexterm"/> geoprocessing tools have input <a id="id717" class="indexterm"/>parameters that accept more than one <a id="id718" class="indexterm"/>value. For example, the multiring buffer tool accepts multiple buffer distances, the delete field tool accepts multiple fields that can be deleted, and there are many other examples. In this recipe, you will learn how to create a <code class="literal">ValueTable</code> object that serves as multivalue input to a tool.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec239"/>Getting ready</h2></div></div></div><p>There are three ways to specify a multivalue parameter: as a Python list, a string with each value separated by semicolons, or an ArcPy <code class="literal">ValueTable</code> object. In this recipe, we're going to take a look at how to specify mutlivalue input parameters by using <code class="literal">ValueTable</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec240"/>How to do it…</h2></div></div></div><p>Follow these steps to learn how to use a <code class="literal">ValueTable</code> to submit multiple values to a tool:</p><div><ol class="orderedlist arabic"><li class="listitem">Open <strong>IDLE</strong> (or your favorite Python development environment) and create a new script called <code class="literal">ValueTable.py</code>.</li><li class="listitem">Import <code class="literal">arcpy</code> and set the workspace:<div><pre class="programlisting">import arcpy

arcpy.env.workspace = r"c:\ArcyBook\data"</pre></div></li><li class="listitem">Create a new <code class="literal">ValueTable</code> object:<div><pre class="programlisting">import arcpy

arcpy.env.workspace = r"c:\ArcyBook\data"
vTab = arcpy.ValueTable()</pre></div></li><li class="listitem">Create <a id="id719" class="indexterm"/>three rows for <a id="id720" class="indexterm"/>the<a id="id721" class="indexterm"/> table and assign them distances of <code class="literal">5</code>, <code class="literal">10</code>, and <code class="literal">20</code>:<div><pre class="programlisting">vTab = arcpy.ValueTable()
vTab.setRow(0, "5")
vTab.setRow(1, "10")
vTab.setRow(2, "20")</pre></div></li><li class="listitem">Define variables for the input feature class, output feature class, distance, and buffer units. The distance variable (<code class="literal">dist</code>) is created as a reference to the <code class="literal">ValueTable</code>, which you have already created:<div><pre class="programlisting">vTab = arcpy.ValueTable()
vTab.setRow(0, "5")
vTab.setRow(1, "10")
vTab.setRow(2, "20")

inFeature = 'Hospitals.shp'
outFeature = 'HospitalMBuff.shp'
dist = vTab
bufferUnit = "meters"</pre></div></li><li class="listitem">Call the <code class="literal">MultipleRingBuffer</code> tool and pass the variables as parameters:<div><pre class="programlisting">inFeature = 'Hospitals.shp'
outFeature = 'HospitalMBuff.shp'
dist = vTab
bufferUnit = "meters"

arcpy.MultipleRingBuffer_analysis(inFeature, outFeature, dist, bufferUnit, '', 'ALL')
print("Multi-Ring Buffer Complete")</pre></div></li><li class="listitem">You can check your work by examining the <code class="literal">C:\ArcpyBook\code\Ch12\ValueTable.py</code> solution file.</li><li class="listitem">Save and run the script. Examine the output to see the multiple buffer rings.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec241"/>How it works…</h2></div></div></div><p>
<code class="literal">ValueTable</code> is a simple virtual table that you can use as input to tools that accept multiple values. In this recipe, we created a <code class="literal">ValueTable</code> object, added three values, and then passed this object into the <code class="literal">MultipleRingBuffer</code> tool. The <code class="literal">MultipleRingBuffer</code> tool <a id="id722" class="indexterm"/>used this information to create <a id="id723" class="indexterm"/>new polygon <a id="id724" class="indexterm"/>layers based on the buffer distances provided in the <code class="literal">ValueTable</code> object.</p></div></div></div>
</body></html>