- en: Chapter 2. GIS Analysis – Mapping Climate Change
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第二章：GIS分析 – 气候变化制图
- en: One area of data analysis that's gotten a lot of attention is **Geographic Information
    Systems** (**GIS**). GIS is a system that is designed to store, manage, manipulate,
    and analyze geographic data. As such, GIS sits at the intersection of cartography,
    computers, statistics, and information science.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 数据分析的一个领域受到了很多关注，那就是**地理信息系统**（**GIS**）。GIS是一个旨在存储、管理、操作和分析地理数据的系统。因此，GIS位于制图学、计算机科学、统计学和信息科学的交汇点。
- en: GIS is applied to fields as diverse as military planning, epidemiology, architecture,
    urban planning, archaeology, and many other fields. Basically, any domain or problem
    that involves location or topology can use GIS techniques or methods.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: GIS应用于军事规划、流行病学、建筑、城市规划、考古学和其他许多领域。基本上，任何涉及位置或拓扑的领域或问题都可以使用GIS技术或方法。
- en: As you can imagine from this very brief description, we won't even scratch the
    surface of GIS in this chapter. However, we'll apply it to a small problem to
    see how it can help us understand the way climate change affects the continental
    **United States** in a better manner.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 如您从这非常简短的描述中可以想象到的，我们在这章中甚至不会触及GIS的表面。然而，我们将将其应用于一个小问题，以了解它如何帮助我们更好地理解气候变化对大陆**美国**的影响。
- en: Understanding GIS
  id: totrans-4
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 理解GIS
- en: While the preceding description is accurate, it doesn't really help us much.
    As befits a field concerned with the lay of the land, GIS really begins in the
    field. Data is gathered using aerial and satellite photography, and it is also
    gathered from people on the ground using GPS, laser range finders, and surveying
    tools. GIS can also make use of existing maps, especially for historical research
    and to compare time periods. For example, this may involve studying how a city
    has evolved over time or national boundaries have changed. A lot of time and energy
    in GIS goes into gathering this data and entering it into the computer.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管前面的描述是准确的，但它并没有真正帮助我们多少。作为一个关注地形布局的领域，GIS实际上是从野外开始的。数据是通过航空和卫星摄影收集的，也是通过地面人员使用GPS、激光测距仪和测量工具收集的。GIS还可以利用现有的地图，特别是用于历史研究和比较时期。例如，这可能涉及研究一个城市如何随着时间的推移而演变，或者国家边界如何发生变化。GIS在收集这些数据并将其输入计算机方面投入了大量的时间和精力。
- en: 'Once the data is in the computer, GIS can perform a wide range and variety
    of analyses on the data, depending on the questions being asked and the task at
    hand. For example, the following are some of the many things you can do with GIS:'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦数据进入计算机，GIS就可以根据提出的问题和手头的任务，对数据进行广泛和多样的分析。例如，以下是一些你可以用GIS做的许多事情之一：
- en: '**View-shed analysis**: This attempts to answer the question, "What can someone
    standing right here at this elevation (and perhaps at a second story window) see?".
    This takes into account the elevation and slope of the terrain around the viewer.'
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**视域分析**：这试图回答问题：“站在这里这个高度（也许是在二楼窗户）的人能看到什么？”这考虑了观众周围地形的高度和坡度。'
- en: '**Topological modeling**: This combines the GIS data with other data in the
    data mining and modeling to add a geospatial component to more mainstream data
    mining and modeling. This allows the models to account for the geographical proximity.'
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**拓扑建模**：这结合了GIS数据与数据挖掘和建模中的其他数据，为更主流的数据挖掘和建模添加了地理空间组件。这使得模型能够考虑地理邻近性。'
- en: '**Hydrological modeling**: This models the way in which water interacts with
    the environment through rainfall, watershed, runoff, and catchment.'
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**水文建模**：这模拟了水通过降雨、流域、径流和集水区与环境的相互作用方式。'
- en: '**Geocoding**: This involves associating human-readable addresses with their
    geospatial coordinates. When you click on a **Google Map** or **Bing Map** and
    get the business or address of a location, it''s because it''s been geocoded for
    the coordinates you tapped on.'
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**地理编码**：这涉及将可读地址与其地理坐标关联起来。当你点击**谷歌地图**或**必应地图**并获取某个地点的业务或地址时，那是因为它已经为你的点击坐标进行了地理编码。'
- en: The primary tool for most GIS specialists is **ArcGIS** by **ESRI** ([http://www.esri.com/](http://www.esri.com/)).
    This is a powerful, full-featured GIS workbench. It interoperates with most data
    sources and performs most of the analyses. It also has an **API** for **Python**
    and APIs in **Java** and **.NET** to interact with ArcGIS servers. We'll use ArcGIS
    at the end of this chapter to generate the visualization.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: However, there are other options as well. Most databases have some GIS capabilities,
    and **Quantum GIS** ([http://www.qgis.org/](http://www.qgis.org/)) is an open
    source alternative to ArcGIS. It isn't as polished or as fully featured, but it's
    still powerful in its own right and is freely available. **GeoServer** ([http://geoserver.org/](http://geoserver.org/))
    is an enterprise-level server and management system for the GIS data. There are
    also libraries in a number of programming languages; **Geospatial Data Abstraction
    Layer**, also known as **GDAL**, ([http://www.gdal.org/](http://www.gdal.org/))
    deserves special mention here, both in its own right and because it serves as
    the foundation for libraries in a number of other programming languages. One of
    the libraries for Java is **GeoTools** ([http://www.geotools.org/](http://www.geotools.org/)),
    and part of it calls GDAL under the table.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
- en: Mapping the climate change
  id: totrans-13
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: So, let's roll up our sleeves and perform some geospatially informed data analysis.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
- en: For our problem, we'll look at how the climate change affects the continental
    United States over the last century or so. Specifically, we'll look at how the
    average maximum temperature for July has changed. For North America, this should
    give us a good snapshot of the hottest temperatures.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
- en: One nice thing about working with the weather data is that there's a lot of
    it, and it's easily available. **US National Oceanic and Atmospheric Administration**
    (**NOAA**) collects it and maintains archives of it.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
- en: For this project, we'll use the **Global Summary of the Day** ([http://www.ncdc.noaa.gov/cgi-bin/res40.pl](http://www.ncdc.noaa.gov/cgi-bin/res40.pl)).
    This includes daily summaries from each active weather station. We'll filter out
    any weather stations that aren't in the US, and we'll filter out any data that
    is not in use for the month of July.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
- en: Climate is typically defined on thirty-year periods. For example, the climate
    for a location would be the average temperature of thirty years, not the temperature
    for the year. However, there won't be that many thirty-year periods for the time
    span that we're covering, so instead, we'll look at the maximum temperature for
    July from each weather station in ten-year rolling averages.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
- en: To find out how much the maximum temperature has changed, we'll find the rolling
    average for these ten-year periods. Then, for each station, we'll find the difference
    between the first ten year period's average and the last one's.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
- en: Unfortunately, the stations aren't evenly or closely spaced; as we'll see, they
    also open and close over the years. So we'll do the best we can with this data,
    and we'll fill in the geospatial gaps in the data.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally, we''ll graph this data over a map of the US. This will make it easy
    to see how temperatures have changed in different places. What will this process
    look like? Let''s outline the steps for the rest of this chapter:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: Download the data from NOAA's FTP servers. Extract it from the files.
  id: totrans-22
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Filter out the data that we won't need for this analysis. We'll only hang onto
    places and the month that we're interested in (the US for July).
  id: totrans-23
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Average the maximum temperatures for each month.
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Calculate the ten-year rolling averages of the averages from step three.
  id: totrans-25
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Get the difference between the first and last ten-year averages for each weather
    station.
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Interpolate the temperature differences for the areas between the stations.
  id: totrans-27
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Create a heat map of the differences.
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Review the results.
  id: totrans-29
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Downloading and extracting the data
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: As mentioned above, NOAA maintains an archive of GSOD. For each weather station
    around the world, these daily summaries track a wide variety of weather data for
    all active weather stations around the globe. We'll use the data from here as
    the basis of our analysis.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
- en: 'The data is available at [ftp://ftp.ncdc.noaa.gov/pub/data/gsod/](ftp://ftp.ncdc.noaa.gov/pub/data/gsod/).
    Let''s look at how this data is stored and structured:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
- en: '![Downloading and extracting the data](img/4139OS_02_01.jpg)'
  id: totrans-33
  prefs: []
  type: TYPE_IMG
- en: So, the main directory on the FTP site (`/pub/data/gsod/`) has a directory for
    each year that has the weather data. There's also a file called `ish-history.csv`.
    This contains information about the weather stations, when they were operational,
    and where they were located. (Also, the text files and `README` files are always
    important for more specific, detailed information about what's in each file.)
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
- en: Now let's check out one of the data directories; this is for 2013.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
- en: The data directories contain a large number of data files. Each of the files
    that ends in `.op.gz` has three components for its file name. The first two parts
    are identifiers for the weather station and the third is the year.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: Each data directory also has a tarball that contains all of the `*.op.gz` data
    files. That file will be the easiest to download, and then we can extract the
    `*.op.gz` files from it. Afterwards, we'll need to decompress these files to get
    the `*.op` data files. Let's do that, and then we can look at the data that we
    have.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: Downloading the files
  id: totrans-38
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Before we actually get into any of the code to do this, let's take a look at
    the dependencies that we'll need.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: 'Before we get started, let''s set up our project. For this chapter, our Leiningen
    2 ([http://leiningen.org/](http://leiningen.org/)) `project.clj` file should look
    something like the following code:'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-41
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Now for this section of code, let''s open the `src/clj_gis/download.clj` file.
    We''ll use this namespace declaration for this code as follows:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-43
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Now, the next two functions together download the GSOD data files. The main
    function is `download-data`. It walks the directory tree on the FTP server, and
    whenever it identifies a file to be downloaded, it hands it off to `download-file`.
    This function figures out where to put the file and downloads it to that location.
    I''ve left out the source code for some of the utilities and secondary functions
    listed here, such as `download-src`, so that we can focus on the larger issues.
    You can find these functions in the file in this chapter''s code download. The
    following code snippet is part of the code that is available for download:'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: Extracting the files
  id: totrans-46
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Now, we've downloaded the files from the NOAA FTP server onto the local hard
    drive. However, we still need to use the `tar` utility to extract the files we've
    downloaded and then decompress them.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
- en: 'We''ll use the **FS** library to extract the downloaded files. Currently, the
    individual data files are in a common Unix file format called `tar`, which collects
    multiple files into one larger file. These files are also compressed using the
    utility **gzip**. We''ll use Java''s `GZIPOutputStream` to decompress `gz`. Let''s
    see how this works:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'We can put these functions together with the download functions that we just
    looked at. This function, `download-all`, will download all the data and then
    decompress all of the data files into a directory specified by `clj-gis.locations/*data-dir*`:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Now, what do these files look like? The header line of one of them is as follows:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'The following is one of the data rows:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: So, there are some identification fields, some for temperature, dew point, wind,
    and other weather data. Next, let's see how to winnow the data down to just the
    information that we plan to use.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
- en: Transforming the data – filtering
  id: totrans-57
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'As we just noticed, there''s a lot of data in the GSOD files that we don''t
    plan to use. This includes the following:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
- en: Too many files with data for places that we aren't interested in
  id: totrans-59
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Too many rows with data for months that we aren't interested in
  id: totrans-60
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Too many columns with weather data that we aren't interested in (dew points,
    for instance)
  id: totrans-61
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: At this point, we'll only worry about the first problem. Just filtering out
    the places we're not looking at will dramatically reduce the amount of data that
    we're dealing with from approximately 20 GB of data to just 3 GB.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
- en: 'The code for this section will be in the `src/clj_gis/filter_data.clj` file.
    Give it the following namespace declaration:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-64
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Now it's time for the code that is to be put in the rest of the file.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
- en: 'To filter out the data that we won''t use, we''ll copy files for stations in
    the United States into their own directory. We can create a set of these stations
    from the `ish-history.csv` file that we noticed earlier, so our first task will
    be parsing that file. This code will read the CSV file and put the data from each
    line into a new data record, `IshHistory`. Having its own data type for this information
    isn''t necessary, but it makes the rest of the code much more readable. For example,
    we can reference the country field using `(:country h)` instead of `(nth h 3)`
    later. This type can also reflect the column order from the input file, which
    makes reading the data easier:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'The stations are identified by the combination of the USAF and WBAN fields.
    Some stations use USAF, some use WBAN, and some use both. So we''ll need to track
    both to uniquely identify the stations. This function will create a set of the
    stations in a given country:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Finally, we need to tie these functions together. This function, `filter-data-files`,
    reads the history and creates the set of stations that we want to keep. Then,
    it walks through the data directory and parses the file names to get the station
    identifiers for each file. Files from the stations in the set are then copied
    to a directory with the same name as the country code, as follows:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: This set of functions will filter out most of the data and leave us with only
    the observations from the stations we're interested in.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
- en: Rolling averages
  id: totrans-73
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We aren''t plotting the raw data. Instead, we want to filter it further and
    summarize it. This transformation can be described in the following steps:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
- en: Process only the observations for the month of July.
  id: totrans-75
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Find the mean temperature for the observations for the month of July for each
    year, so we'll have an average for July 2013, July 2012, July 2011, and so on.
  id: totrans-76
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Group these monthly averages into rolling ten-year windows. For example, one
    window will have the observations for 1950 to 1960, another window will have observations
    for 1951 to 1961, and so on.
  id: totrans-77
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Find the mean temperature for each of these windows for a climatic average temperature
    for July for that period.
  id: totrans-78
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Calculate the change in the maximum temperature by subtracting the climatic
    average for the last window for a station from the average of its first window.
  id: totrans-79
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: This breaks down the rest of the transformation process pretty well. We can
    use this to help us structure and write the functions that we'll need to implement
    the process. However, before we can get into that, we need to read the data.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
- en: Reading the data
  id: totrans-81
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'We''ll read the data from the space-delimited data files and store the rows
    in a new record type. For this section, let''s create the `src/clj_gis/rolling_avg.clj`
    file. It will begin with the following namespace declaration:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-83
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Now, we can define a data type for the weather data. We''ll read the data into
    an instance of `WeatherRow`, and then we''ll need to normalize the data to make
    sure that the values are ones that we can use. This will involve converting strings
    to numbers and dates, for instance:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-85
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Now that we have the weather data, we can work it through the pipeline as outlined
    in the preceding code snippet. This series of functions will construct a sequence
    of reducers.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
- en: '**Reducers**, introduced in Clojure 1.5, are a relatively new addition to the
    language. They refine traditional functional-style programming. Instead of `map`
    taking a function and a sequence and constructing a new sequence, the reducers''
    version of `map` takes a function and a sequence or folder (the core reducer data
    type) and constructs a new folder that will apply the function to the elements
    of the input when required. So, instead of constructing a series of sequences,
    it composes the functions into a larger function that performs the same processing,
    but only produces the final output. This saves on allocating the memory, and if
    the input data types are structured correctly, the processing can also be automatically
    parallelized as follows:'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
- en: 'For the first step, we want to return only the rows that fall in the month
    we''re interested in. This looks almost exactly like a regular call to `filter`,
    but instead of returning a new, lazy sequence, it returns a folder that has the
    same effect; it produces a sequence with only the data rows we want. Or, we can
    compose this with other folders to further modify the output. This is what we
    will do in the next few steps:'
  id: totrans-88
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-89
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'This function takes the reducer from the first step and passes it through a
    few more steps. The `group-by` function finally reifies the sequence into a hash
    map. However, it''s immediately fed into another reducer chain that averages the
    accumulated temperatures for each month:'
  id: totrans-90
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE14]'
  id: totrans-91
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'For step three, we create a series of moving windows across the monthly averages.
    If there aren''t enough averages to create a full window, or if there are only
    enough to create one window, then we throw those extra observations out:'
  id: totrans-92
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE15]'
  id: totrans-93
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'This step uses a utility function, `mean`, to get the average temperature for
    each window. We saw this defined in step two. This keeps hold of the starting
    year for that window so they can be properly ordered:'
  id: totrans-94
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE16]'
  id: totrans-95
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'After this, we do a little more filtering to only pass the averages through,and
    then we replace the list of averages with the difference between the initial and
    the final averages:'
  id: totrans-96
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE17]'
  id: totrans-97
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE17]'
- en: There's more to this, of course. We have to get a list of the files to be processed,
    and we need to do something with the output; either send it to a vector or to
    a file.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
- en: Now that we've made it this far, we're done transforming our data, and we're
    ready to start our analysis.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
- en: Interpolating sample points and generating heat maps using inverse distance
    weighting (IDW)
  id: totrans-100
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In the end, we're going to feed the data we've just created to ArcGIS in order
    to create the heat map, but before we do that, let's try to understand what will
    happen under the covers.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
- en: 'For this code, let''s open up the `src/clj_gis/idw.clj` file. The namespace
    for this should be like the following code:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: To generate a **heat map**, we first start with a sample of points for the space
    we're looking at. Often, this space is geographical, but it doesn't have to be.
    Values for a complex, computationally-expensive, two-dimensional function are
    another example where a heat map would be useful. It would take too long to completely
    cover the input domain, and inverse distance weighting could be used to fill in
    the gaps.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
- en: The sample data points each have a value, often labeled *z* to imply a third
    dimension. We want a way to interpolate the *z* value from the sample points onto
    the spaces between them. The heat map visualization is just the result of assigning
    colors to ranges of *z* and plotting these values.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
- en: One common technique to interpolate the value of *z* to points between the sample
    points is called **inverse distance weighting (IDW)**. To find the interpolated
    value of *z* for a point *x, y*, IDW sees how much the value of each sample point
    influences that location, given each sample's distance away and a value *p* that
    determines how far each sample point's influence carries. Low values of *p* don't
    project much beyond their immediate vicinity. High values of *p* can be projected
    too far. We'll see some examples of this in a minute.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
- en: There are a variety of ways to calculate the IDW. One general form is to sum
    the weighted difference between the data point in question and all others, and
    divide it by the non-weighted sum.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
- en: '![Interpolating sample points and generating heat maps using inverse distance
    weighting (IDW)](img/4139OS_02_02.jpg)'
  id: totrans-108
  prefs: []
  type: TYPE_IMG
- en: 'There are several variations of IDW, but here, we''ll just describe the base
    version, as outlined by Donald Shepard in 1968\. First, we have to determine the
    inverse distance function. It''s given here as `w`. Also, `x_i` is the sample
    point, and `x` is the point to estimate the interpolation for, just as given in
    the preceding formula:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'With this in place, IDW is the sum of `w` for each point in the sample, multiplied
    by that sample point''s value and divided by the sum of `w` for all the samples.
    It''s probably easier to parse the code than it is to describe it verbosely:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE20]'
  id: totrans-112
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: The highlighted part of the function is the part to pay attention to. The rest
    makes it easier to call `idw` in different contexts. I precompute the denominator
    in the `let` form, as it won't change for each sample point that is considered.
    Then, the distances of each sample point and the target point are multiplied by
    the value of each sample point and divided by the denominator, and this is summed
    together.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
- en: 'This function is easy to call with the charting library that **Incanter** provides,
    which has a very nice heat map function. Incanter is a library used to perform
    data analysis and visualization in Clojure by interfacing with high-performance
    Java libraries. This function first gets the bounding box around the data and
    pads it a little. It then uses Incanter''s `heat-map` function to generate the
    heat map. To make it more useful, however, we then make the heat map transparent
    and plot the points from the sample onto the chart. This is found in `src/clj_gis/heatmap.clj`:'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE21]'
  id: totrans-115
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Let's take a random data sample and use it to see what different values of `p`
    do.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
- en: 'For the first experiment, let''s look at *p=1*:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE22]'
  id: totrans-118
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'The graph it produces looks like the following figure:'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
- en: '![Interpolating sample points and generating heat maps using inverse distance
    weighting (IDW)](img/4139OS_02_03.jpg)'
  id: totrans-120
  prefs: []
  type: TYPE_IMG
- en: We can see that the influence for each sample point is tightly bound to its
    immediate neighborhood. More moderate values, around 4 and 5, dominate.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
- en: 'For *p=8*, the picture is a bit different, as shown in the following screenshot:'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: '![Interpolating sample points and generating heat maps using inverse distance
    weighting (IDW)](img/4139OS_02_04.jpg)'
  id: totrans-123
  prefs: []
  type: TYPE_IMG
- en: In the preceding figure, each interpolated point is more heavily influenced
    by the data points closest to it, and further points are less influential. More
    extreme regions have great influence over larger distances, except around sample
    points with moderate values.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally, we''ll look at an interpolated point that''s more balanced. The following
    is the chart for when *p=3*:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
- en: '![Interpolating sample points and generating heat maps using inverse distance
    weighting (IDW)](img/4139OS_02_05.jpg)'
  id: totrans-126
  prefs: []
  type: TYPE_IMG
- en: This seems much more balanced. Each sample point clearly exerts its influence
    across its own neighborhood. However, no point, and no range of values, appears
    to dominate. A more meaningful graph with real data would probably look quite
    good.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
- en: So far, we've been playing with the toy data. Before we can apply this to the
    climate data that we prepared earlier, there are several things we need to take
    into consideration.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
- en: Working with map projections
  id: totrans-129
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Have you looked at a world wall map and noticed how big Greenland is? It's huge.
    It's larger than China, the United States, and Australia, and is about as big
    as Africa. Too bad it's so cold, or we could fit a lot of people up there. Or
    could we?
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
- en: Actually, Australia is about three and a half times as big as Greenland, China
    is almost four and a half times as big, and Africa is almost fourteen times as
    large!
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
- en: What's going on? The **Mercator projection** is what's going on. It was developed
    by the Flemish cartographer Gerardus Mercator in 1569\. Over time, it's become
    very popular, at least partially so because it fits nicely onto a rectangular
    page without wasting a lot of space around the edges, the way some projections
    do.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
- en: A map projection is a transformation of locations on a sphere or ellipsoid onto
    locations on a plane. You can think of it as a function that transforms latitudes
    and longitudes of the earth into the x and y coordinates on a sheet of paper.
    This allows us to take a point on a map and find it on the earth, take a point
    on the earth and find it on the map, or take a point on one map and find it on
    another.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
- en: Mercator is a common projection. It's created by wrapping a cylindrical sheet
    of paper around the globe, only touching along the equator. Then, the shapes on
    the globe are cast out onto the paper roll like beams of light spreading out.
    This was developed for navigation, and if you chart a course with a constant bearing,
    it plots on a Mercator map as a straight line. However, its major problem is that
    it distorts shapes around the edges, for example, Greenland or Antarctica.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
- en: 'There are a number of other common projections, such as the following:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
- en: The **Gall-Peters** projection accurately shows the area but distorts the shape.
  id: totrans-136
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The **Eckert IV** projection distorts the outer shape of the map onto an ovoid
    to minimize the area distortions of the Mercator projection, although it still
    distorts the shapes of things near the poles.
  id: totrans-137
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The **Goode homolosine** projection attempts to accurately portray both the
    area and shape by cutting the *skin* off the globe into some awkward shapes. It's
    sometimes called the *orange peel map* because the outlines of the map look like
    you peeled an orange by hand and flattened it on the table top.
  id: totrans-138
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: So how does this apply to our project?
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
- en: On the one hand, we need some way to accurately measure the distances between
    points in the real world. For example, as we're working in the northern hemisphere,
    the points near the top of the map, to the north, will be closer together than
    the points near the bottom. We need to know the projection in order to measure
    these distances correctly and correctly calculate the interpolations.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
- en: To put it another way, the distance between two points that are a degree of
    longitude apart would be different, depending on their latitude. In Grand Forks,
    North Dakota, the distance between longitude -97 and -96 is approximately 46 miles
    (74.5 km). On the other hand, the distance between longitudes -97 and -96, just
    west of Houston, Texas, is almost 60 miles (96.52 km). Think of the way in which
    two lines that are parallel on the equator have to curve towards each other as
    they converge at the poles.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
- en: On the other hand, we also need to then be able to know which pixel a set of
    latitude and longitude correspond to. In order to actually plot the heat map on
    the screen, we have to be able to determine which pixel gets which color, depending
    on the interpolated points on the map.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
- en: Finding a base map
  id: totrans-143
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Related to the projections, we also need to have a base layer to display the
    heat map on top of it. Without being able to see the context of the underlying
    geography, a heat map is more confusing than it is illuminating.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
- en: There are maps available that have their locations encoded in their metadata.
    **GeoTIFF** is one such format. GIS packages can layer the data and information
    on top of these base maps to provide more complex, interesting, and useful visualizations
    and analyses.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
- en: Working with ArcGIS
  id: totrans-146
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Working with projections and base maps can be fiddly and prone to errors. While
    there are Java libraries that can help us with this, let's use the major software
    package in this domain, **ArcGIS**, for the purposes of this demonstration. While
    it's awesome to be able to program solutions in a powerful, flexible language
    like Clojure, sometimes, it's nicer to get pretty pictures quickly.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
- en: 'We''re going to start this by getting the base layer. ESRI maintains a set
    of topological maps, and this map of the United States is perfect for this:'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
- en: Navigate to [http://www.arcgis.com/home/item.html?id=99cd5fbd98934028802b4f797c4b1732](http://www.arcgis.com/home/item.html?id=99cd5fbd98934028802b4f797c4b1732)
    to view ESRI's page on the **US Topo Maps**.
  id: totrans-149
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on the **Open** dropdown.
  id: totrans-150
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Select the option that allows you to get **ArcGIS Desktop** to open the layer.
  id: totrans-151
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![Working with ArcGIS](img/4139OS_02_07.jpg)'
  id: totrans-152
  prefs: []
  type: TYPE_IMG
- en: 'Now we''ll add our data. This was created using the functions that we defined
    earlier as well as a few more that are available in this chapter''s code download:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
- en: The data is available at [http://www.ericrochester.com/clj-data-master/temp-diffs.csv](http://www.ericrochester.com/clj-data-master/temp-diffs.csv).
    Point your web browser there and download the file. Don't forget where you put
    it!
  id: totrans-154
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In ArcGIS, navigate to **File** | **Add Data** | **Add XY Data**.
  id: totrans-155
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Select the `temp-diffs.csv` file, and specify `z` for the **z** field.
  id: totrans-156
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We'll also need to change the projection of the input data. To do this, click
    on **Edit...** to edit the projection.
  id: totrans-157
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the new dialog box, **Select** a predefined coordinate system. Navigate to
    **Coordinate Systems** | **Geographic Coordinate Systems** | **North America**
    | **NAD 1983**.
  id: totrans-158
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: When the file is ready to load, the dialog should look like what is shown in
    the following screenshot:![Working with ArcGIS](img/4139OS_02_08.jpg)
  id: totrans-159
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once the data is in place, we need to set the color scheme for the **z** field.
    Right-click on the new layer and select **Properties**. Select the **Symbology**
    tab and get the graduated colors the way you like them.
  id: totrans-160
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: After I was done playing, the dialog box looked like what is shown in the following
    screenshot:![Working with ArcGIS](img/4139OS_02_09.jpg)
  id: totrans-161
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Now we get to the good part. Open up **Catalog** and select **IDW tool**. It
    is done by navigating to **System Toolboxes** | **Geostatistical Analyst Tools**
    | **Interpolation**. Generate the heat map into a new layer.
  id: totrans-162
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Once ArcGIS is done, the heat map will be too opaque to see the underlying geography.
    Right-click on the heat map layer and select **Properties**. In the **Display**
    tab, change the opacity to something reasonable. I used `0.40`.
  id: totrans-163
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'The final results are shown as follows:'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
- en: '![Working with ArcGIS](img/4139OS_02_10.jpg)'
  id: totrans-165
  prefs: []
  type: TYPE_IMG
  zh: '![使用 ArcGIS](img/4139OS_02_10.jpg)'
- en: We can see that for a large part of the nation, things have heated up. The west
    part of the great lakes have cooled a bit, but the Rocky Mountains have especially
    gotten warmer.
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以看到，在全国的大部分地区，情况已经变得很热。五大湖的西部有所降温，但落基山脉特别变暖了。
- en: Summary
  id: totrans-167
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: This has been a fun little experiment. Looking at the data, however, suggests
    caution. Some of the stations have been in operation long enough to have only
    a few of the sliding windows defined. Others have been operational for much longer.
    This makes it difficult to compare the aggregated numbers from the different different
    stations, which is what we're doing by creating the heat map.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一次有趣的实验。然而，观察数据时却需要谨慎。一些站点运行时间足够长，以至于只有少数滑动窗口被定义。其他站点则运行了更长的时间。这使得比较不同站点的汇总数据变得困难，这正是我们通过创建热图所做的事情。
- en: Nevertheless, this does point to some interesting areas of future enquiry, and
    it provides a brief glimpse of what geographical information systems can provide
    and how to use them. They can add a geospatially informed edge to the modeling
    and analysis, which isn't possible with the data, tools, and techniques they bring
    to the table.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管如此，这确实指向了一些有趣的未来研究方向，并简要展示了地理信息系统可以提供什么以及如何使用它们。它们可以为建模和分析增添地理空间信息的有益视角，这是他们带来的数据、工具和技术所无法实现的。
- en: In this next chapter, we'll turn our attention to sifting through free-form
    textual data using topic modeling.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将把注意力转向使用主题模型筛选自由形式的文本数据。
