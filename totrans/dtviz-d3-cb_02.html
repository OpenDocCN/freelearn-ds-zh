<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Be Selective</h1></div></div></div><p>In this chapter we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Selecting a single element</li><li class="listitem" style="list-style-type: disc">Selecting multiple elements</li><li class="listitem" style="list-style-type: disc">Iterating through a selection</li><li class="listitem" style="list-style-type: disc">Performing subselection</li><li class="listitem" style="list-style-type: disc">Function chaining</li><li class="listitem" style="list-style-type: disc">Manipulating raw selection</li></ul></div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec12"/>Introduction</h1></div></div></div><p>One of the most fundamental tasks that you need to perform with any data visualization project using D3 is <a id="id86" class="indexterm"/>selection. Selection helps you target certain visual elements on the page. If you are already familiar with the W3C standardized CSS selector or other similar selector APIs provided by popular JavaScript libraries, such as jQuery<a id="id87" class="indexterm"/> and <a id="id88" class="indexterm"/>Zepto.js, then you will find yourself right at home with D3's selection API. Don't worry if you haven't used selector API before, this chapter is designed to cover this topic in steps with the help of some very visual recipes; it will cover pretty much all common use cases for your data visualization needs.</p><p>
<strong>Introducing selection</strong>: Selector <a id="id89" class="indexterm"/>support has been standardized by W3C<a id="id90" class="indexterm"/> so all modern web browsers have built-in support for the selector API. However the basic W3C selector API has its limitations when it comes to web development, especially in the data visualization realm. The standard W3C selector API<a id="id91" class="indexterm"/> only provides selector but not selection. What this means is that the selector API helps you to select element(s) in your document, however, to manipulate the selected element(s) you still need to loop through each element, in order to manipulate the selected element(s). Consider the following code snippet using the standard selector API:</p><div><pre class="programlisting">var i = document.querySelectorAll("p").iterator();
var e;
while(e = i.next()){
  // do something with each element selected
  console.log(e);
}</pre></div><p>The preceding code essentially selects all <code class="literal">&lt;p&gt;</code> elements in the document and then iterates through each element to perform some task. This can obviously get tedious quickly, especially when you have to manipulate many different elements on the page constantly, which is what we usually do in data visualization projects. This is why D3 introduced its own selection API, making development less of a chore. For the rest of this chapter we will cover how D3's selection API works as well as some of its powerful features.</p><p>
<strong>CSS3 selector basics</strong>: Before we dive<a id="id92" class="indexterm"/> into D3's selection API, some basic introduction on the W3C level-3 selector API is required. If you are already comfortable with CSS3 selectors, feel free to skip this section. D3's selection API is built based on the level-3 selector or more commonly known as the CSS3 selector support. In this section, we plan to go through some of the most common CSS3 selector syntax that are required to understand D3 selection API.</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">#foo</code>: select element with <code class="literal">foo</code> as the value of <code class="literal">id</code><div><pre class="programlisting">&lt;div id="foo"&gt;</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">foo</code>: select element <code class="literal">foo</code><div><pre class="programlisting">&lt;foo&gt;</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">.foo</code>: select elements with <code class="literal">foo</code> as the value of <code class="literal">class</code><div><pre class="programlisting">&lt;div class="foo"&gt;</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">[foo=goo]</code>: select elements with the <code class="literal">foo</code> attribute value and set it to <code class="literal">goo</code><div><pre class="programlisting">&lt;div foo="goo"&gt;</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">foo goo</code>: select the <code class="literal">goo</code> element inside the <code class="literal">foo</code> element<div><pre class="programlisting">&lt;foo&gt;&lt;goo&gt;&lt;/foo&gt;</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">foo#goo</code>: select the <code class="literal">foo</code> element set <code class="literal">goo</code> as the value of <code class="literal">id</code><div><pre class="programlisting">&lt;foo id="goo"&gt;</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">foo.goo</code>: select the <code class="literal">foo</code> element with <code class="literal">goo</code> as the value of <code class="literal">class</code><div><pre class="programlisting">&lt;foo class="goo"&gt;</pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">foo:first-child</code>: select the first child of the <code class="literal">foo</code> elements<div><pre class="programlisting">&lt;foo&gt; // &lt;-- this one
&lt;foo&gt;
&lt;foo&gt; </pre></div></li><li class="listitem" style="list-style-type: disc"><code class="literal">foo:nth-child(n)</code>: select the nth child of the <code class="literal">foo</code> elements<div><pre class="programlisting">&lt;foo&gt;
&lt;foo&gt; // &lt;-- foo:nth-child(2)
&lt;foo&gt; // &lt;-- foo:nth-child(3)</pre></div></li></ul></div><p>CSS3 selector<a id="id93" class="indexterm"/> is a pretty complex topic. Here we have only listed some of the most common selectors that you will need to understand and to be effective when working with D3. For more information on this topic please visit the W3C level-3 selector API <a id="id94" class="indexterm"/>document <a class="ulink" href="http://www.w3.org/TR/css3-selectors/">http://www.w3.org/TR/css3-selectors/</a>.</p><div><div><h3 class="title"><a id="tip13"/>Tip</h3><p>If you are targeting an older browser that does not support selector natively, you can include Sizzle<a id="id95" class="indexterm"/> before D3 for backwards-compatibility. You can find Sizzle at <a class="ulink" href="http://sizzlejs.com/">http://sizzlejs.com/</a>.</p><p>Currently the next generation selector API level-4 is in draft stage with W3C. You can have a peek at what it has to offer and its current draft here at <a class="ulink" href="http://dev.w3.org/csswg/selectors4/">http://dev.w3.org/csswg/selectors4/</a></p><p>Major browser vendors have already started implementing some of the level-4 selectors if you are interested to find out the level of support in your browser, try out this handy website <a class="ulink" href="http://css4-selectors.com/browser-selector-test/">http://css4-selectors.com/browser-selector-test/</a>.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec13"/>Selecting a single element</h1></div></div></div><p>It is very common that sometimes you need to select a single element on a page to perform some visual manipulation. This recipe will show you how to perform a targeted <a id="id96" class="indexterm"/>single <a id="id97" class="indexterm"/>element selection in D3 using CSS selector.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec19"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter2/single-selection.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter2/single-selection.html</a>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec20"/>How to do it...</h2></div></div></div><p>Let's select something (a paragraph element perhaps) and produce the classic "hello world" on screen.</p><div><pre class="programlisting">
<strong>&lt;p id="target"&gt;&lt;/p&gt; &lt;!-- A --&gt;</strong>

&lt;script type="text/javascript"&gt;
<strong>    d3.select("p#target") // &lt;-- B</strong>
<strong>    .text("Hello world!"); // &lt;-- C</strong>
&lt;/script&gt;</pre></div><p>This recipe simply produces a <strong>Hello world!</strong> on your screen.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec21"/>How it works...</h2></div></div></div><p>The <code class="literal">d3.select</code> command<a id="id98" class="indexterm"/> is used to perform a single element selection in D3. This method<a id="id99" class="indexterm"/> accepts a string representing a valid CSS3 selector<a id="id100" class="indexterm"/> or an element object if you already have a reference to the element you want to select. The <code class="literal">d3.select</code> command returns a D3 selection object on which you can chain modifier functions to manipulate the attribute, content or inner HTML of this element.</p><div><div><h3 class="title"><a id="tip14"/>Tip</h3><p>More than one element can be selected using the selector provided only the first element is returned in the selection.</p></div></div><p>In this example, we simply select the paragraph element with <code class="literal">target</code> as the value of <code class="literal">id</code> at line B, and then set its textual content to <code class="literal">Hello world!</code> on line C. All D3 selections support a set of standard modifier functions. The <code class="literal">text</code> function we have shown here is one of them. The following are some of the most common modifier functions you will encounter throughout this book:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">selection.attr</code> function: This <a id="id101" class="indexterm"/>function allows you to retrieve or modify a given attribute on the selected element(s)<div><pre class="programlisting">// set foo attribute to goo on p element
d3.select("p").attr("foo", "goo"); 
// get foo attribute on p element
d3.select("p").attr("foo");</pre></div></li><li class="listitem" style="list-style-type: disc">The <code class="literal">selection.classed</code> function: This <a id="id102" class="indexterm"/>function allows you to add or remove CSS classes on the selected element(s).<div><pre class="programlisting">// test to see if p element has CSS class goo
d3.select("p").classed("goo");
// add CSS class goo to p element
d3.select("p").classed("goo", true);
// remove CSS class goo from p element. classed function
// also accepts a function as the value so the decision 
// of adding and removing can be made dynamically
d3.select("p").classed("goo", function(){return false;});</pre></div></li><li class="listitem" style="list-style-type: disc">The <code class="literal">selection.style</code> function: This <a id="id103" class="indexterm"/>function lets you set the CSS style with a specific name to the specific value on the selected element(s).<div><pre class="programlisting">// get p element's style for font-size
d3.select("p").style("font-size");
// set font-size style for p to 10px
d3.select("p").style("font-size", "10px");
// set font-size style for p to the result of some 
// calculation. style function also accepts a function as // the value can be produced dynamically
d3.select("p"). style("font-size", function(){return normalFontSize + 10;});</pre></div></li><li class="listitem" style="list-style-type: disc">The <code class="literal">selection.text</code> function: This function <a id="id104" class="indexterm"/>allows <a id="id105" class="indexterm"/>you access and<a id="id106" class="indexterm"/> set the text content of the selected element(s).<div><pre class="programlisting">// get p element's text content
d3.select("p").text();
// set p element's text content to "Hello"
d3.select("p").text("Hello");
// text function also accepts a function as the value, 
// thus allowing setting text content to some dynamically 
// produced message
d3.select("p").text(function(){
  var model = retrieveModel();
  return model.message;
});</pre></div></li><li class="listitem" style="list-style-type: disc">The <code class="literal">selection.html</code> function: This<a id="id107" class="indexterm"/> function lets you modify the element's inner HTML content.<div><pre class="programlisting">// get p element's inner html content
d3.select("p").html();
// set p element's inner html content to "&lt;b&gt;Hello&lt;/b&gt;"
d3.select("p").text("&lt;b&gt;Hello&lt;/b&gt;");
// html function also accepts a function as the value, 
// thus allowing setting html content to some dynamically 
// produced message
d3.select("p").text(function(){
  var template = compileTemplate();
  return template();
});</pre></div><p>These modifier functions work on both single-element and multi-element selection results. When applied to multi-element selections, these modifications will be applied to each and every selected element. We will see them in action in other, more complex recipes <a id="id108" class="indexterm"/>covered<a id="id109" class="indexterm"/> in the rest of this chapter.</p><div><div><h3 class="title"><a id="note10"/>Note</h3><p>When a function is used as a value in these modifier functions, there are actually some built-in parameters being passed to these functions to enable data-driven calculation. This data-driven approach is what gives D3 its power and its name (Data-Driven Document) and will be discussed in detail in the next chapter.</p></div></div></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec14"/>Selecting multiple elements</h1></div></div></div><p>Often selecting a single element is not good enough, but rather you want to apply certain change to a set of elements on the page simultaneously. In this recipe, we will play with D3 multi-element selector and <a id="id110" class="indexterm"/>its selection API.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec22"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter2/multiple-selection.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter2/multiple-selection.html</a></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec23"/>How to do it...</h2></div></div></div><p>This is what the <code class="literal">d3.selectAll</code> function<a id="id111" class="indexterm"/> is designed for. In this code snippet, we will select three different <code class="literal">div</code> elements and enhance them with some CSS classes.</p><div><pre class="programlisting">&lt;div&gt;&lt;/div&gt;
&lt;div&gt;&lt;/div&gt;
&lt;div&gt;&lt;/div&gt;

&lt;script type="text/javascript"&gt;
<strong>    d3.selectAll("div") // &lt;-- A</strong>
<strong>    .attr("class", "red box"); // &lt;-- B</strong>
&lt;/script&gt;</pre></div><p>This code snippet produces the following visual:</p><div><img src="img/2162OS_02_01.jpg" alt="How to do it..."/><div><p>Multi-element selection</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec24"/>How it works...</h2></div></div></div><p>First thing you<a id="id112" class="indexterm"/> probably would notice in this example is how similar the usage of D3 selection API is when compared to the single-element version. This is one of the powerful design choices of the D3 selection API. No matter how many elements you are targeting, whether one or many, the modifier functions are exactly the same. All modifier functions we mentioned in the previous section can be applied directly to multi-element selection, in other words D3 selection is set-based.</p><p>Now with that being said, let's take a closer look at the code example shown in this section, though it is generally pretty simple and self-descriptive. At line A, the <code class="literal">d3.selectAll</code> function is used to select all the <code class="literal">div</code> elements on the page. The return of this function call is a D3 selection object that contains all three <code class="literal">div</code> elements. Immediately after that, on line B, the <code class="literal">attr</code> function was called on this selection to set the <code class="literal">class</code> attribute to <code class="literal">red box</code> for all three <code class="literal">div</code> elements. As shown in this example, the selection and manipulation code is very generic, and will not change if now we have more than three <code class="literal">div</code> elements on the page. This seems to be an insignificant convenience for now, but in later chapters we will show how this convenience can make your visualization code simpler and easier to maintain.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec15"/>Iterating through a selection</h1></div></div></div><p>Sometimes it is handy to be able to<a id="id113" class="indexterm"/> iterate through each element within a selection and modify each element differently according to their position. In this recipe, we will show you how this can be achieved using D3 selection iteration API.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec25"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter2/selection-iteration.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter2/selection-iteration.html</a>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec26"/>How to do it...</h2></div></div></div><p>D3 selection object <a id="id114" class="indexterm"/>provides simple iterator interface to perform iteration in a similar fashion as how you will iterate through a JavaScript array. In this example we will iterate through three selected <code class="literal">div</code> elements we worked with in the previous recipe and annotate them with an index number.</p><div><pre class="programlisting">&lt;div&gt;&lt;/div&gt;
&lt;div&gt;&lt;/div&gt;
&lt;div&gt;&lt;/div&gt;

&lt;script type="text/javascript"&gt;
<strong>d3.selectAll("div") // &lt;-- A</strong>
<strong>            .attr("class", "red box") // &lt;-- B</strong>
<strong>            .each(function (d, i) { // &lt;-- C</strong>
<strong>            d3.select(this).append("h1").text(i); // &lt;-- D</strong>
<strong>         });</strong>
&lt;/script&gt;</pre></div><div><div><h3 class="title"><a id="tip15"/>Tip</h3><p>Selections are essentially arrays albeit with some enhancement. We will explore raw selection in its array form and how to work with it in later sections.</p></div></div><p>The preceding code snippet produces the following visual:</p><div><img src="img/2162OS_02_02.jpg" alt="How to do it..."/><div><p>Selection iteration</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec27"/>How it works...</h2></div></div></div><p>This example is built<a id="id115" class="indexterm"/> on top of what we have already seen in the previous section. Additional to selecting all the <code class="literal">div</code> elements on the page at line A and setting their class attributes at line B, in this example we call the <code class="literal">each</code> function on the selection to demonstrate how you can iterate through a multi-element selection and process each element respectively.</p><div><div><h3 class="title"><a id="note11"/>Note</h3><p>This form of calling a function on another function's return is called <a id="id116" class="indexterm"/>
<strong>Function Chaining</strong>. If you are unfamiliar with this kind of invocation pattern, please review <a class="link" href="ch01.html" title="Chapter 1. Getting Started with D3.js">Chapter 1, </a>
<em>Getting Started with D3.js</em>, where the topic was explained.</p></div></div><p>
<strong>The selection.each(function) function</strong>: The <code class="literal">each</code> function<a id="id117" class="indexterm"/> takes an iterator function as its parameter. The given iterator function can receive two optional parameters <code class="literal">d</code> and <code class="literal">i</code> with one more hidden parameter passed in as the <code class="literal">this</code> reference which points to the current DOM element object. The first parameter <code class="literal">d</code> represents the datum bound to this particular element (if this sounds confusing to you, don't worry we will cover data binding in depth in the next chapter). The second parameter <code class="literal">i</code> is the index number for the current element object being iterated through. This index is zero-based meaning it starts from zero and increments each time a new element is encountered.</p><p>
<strong>The selection.append(name) function</strong>: Another <a id="id118" class="indexterm"/>new function introduced in this example is the <code class="literal">append</code> function. This function creates a new element with the given name and appends it as the last child of each element in the current selection. It returns a new selection containing the newly appended element. Now with this knowledge, let's take a closer look at the code example in this recipe.</p><div><pre class="programlisting">d3.selectAll("div") // &lt;-- A
    .attr("class", "red box") // &lt;-- B
    .each(function (d, i) { // &lt;-- C
        d3.select(this).append("h1").text(i); // &lt;-- D
    });</pre></div><p>The iterator function is defined on line C with both <code class="literal">d</code> and <code class="literal">i</code> parameters. Line D is a little bit more interesting. At the beginning of line D, the <code class="literal">this</code> reference is wrapped by the <code class="literal">d3.select</code> function. This wrapping essentially produces a single element selection containing the current DOM Element. Once wrapped, the standard D3 selection manipulation API can then be used on <code class="literal">d3.select(this)</code>. After that the <code class="literal">append("h1")</code> function is called on the current element selection which appends a newly created <code class="literal">h1</code> element to the current element. Then it simply sets the textual content of this newly created <code class="literal">h1</code> element to the index number of the current element. This produces the visual of numbered boxes as shown in this recipe. Again you should notice that the index starts from 0 and increments 1 for <a id="id119" class="indexterm"/>each element.</p><div><div><h3 class="title"><a id="tip16"/>Tip</h3><p>The DOM element object itself has a very rich interface. If you are interested to know more about what it can do in an iterator function, please refer to the DOM element API at <a class="ulink" href="https://developer.mozilla.org/en-US/docs/DOM/element">https://developer.mozilla.org/en-US/docs/DOM/element</a>.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec16"/>Performing subselection</h1></div></div></div><p>It is quite common<a id="id120" class="indexterm"/> that you will need to perform scoped selection when working on visualization. For example, selecting all <code class="literal">div</code> elements within a particular <code class="literal">section</code> element is one use case of such scoped selection. In this recipe, we will demonstrate how this can be achieved with different approaches and their advantages and disadvantages.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec28"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter2/sub-selection.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter2/sub-selection.html</a>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec29"/>How to do it...</h2></div></div></div><p>The following code example selects two different <code class="literal">div</code> elements using two different styles of subselection supported by D3.</p><div><pre class="programlisting">&lt;section id="section1"&gt;
    &lt;div&gt;
        &lt;p&gt;blue box&lt;/p&gt;
    &lt;/div&gt;
&lt;/section&gt;
&lt;section id="section2"&gt;
    &lt;div&gt;
        &lt;p&gt;red box&lt;/p&gt;
    &lt;/div&gt;
&lt;/section&gt;

&lt;script type="text/javascript"&gt;
<strong>    d3.select("#section1 &gt; div") // &lt;-- A</strong>
            .attr("class", "blue box");

<strong>    d3.select("#section2") // &lt;-- B</strong>
<strong>            .select("div") // &lt;-- C</strong>
            .attr("class", "red box"); 
&lt;/script&gt;</pre></div><p>This code generates the following visual output:</p><div><img src="img/2162OS_02_03.jpg" alt="How to do it..."/><div><p>Subselection</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec30"/>How it works...</h2></div></div></div><p>Though<a id="id121" class="indexterm"/> producing the same visual effect, this example demonstrates two very different subselection techniques. We will discuss them separately here so you can understand their pros and cons as well as when to use one versus the other.</p><p>
<strong>Selector level-3 combinators</strong>: On line A, <code class="literal">d3.select</code> is used with a special looking string which consists of one tag name connected with another one using a greater-than sign (U+003E, &gt;). This syntax is called <a id="id122" class="indexterm"/>
<strong>combinators</strong> (the greater-than sign here indicates it is a child combinator). Level-3 selector supports a few different kinds of structural combinators. Here we are going to give a quick introduction to the most common ones.</p><p>
<strong>The descendant combinator:</strong> This <a id="id123" class="indexterm"/>combinator has the syntax like <code class="literal">selector selector</code>.</p><p>The descendant combinator, as suggested by its name, is used to describe a loose parent-child relationship between two selections. The reason why it is called loose parent-child relationship is that the descendant combinatory does not care if the second selection is a child or a grandchild or a great-grandchild of the parent selection. Let's look at some examples to illustrate <a id="id124" class="indexterm"/>this loose relationship concept.</p><div><pre class="programlisting">&lt;div&gt;
&lt;span&gt;
The quick &lt;em&gt;red&lt;/em&gt; fox jumps over the lazy brown dog
   &lt;/span&gt;
&lt;/div&gt;</pre></div><p>Using the following selector:</p><div><pre class="programlisting">div em</pre></div><p>It will select the <code class="literal">em</code> element since <code class="literal">div</code> is the ancestor of the <code class="literal">em</code> element and <code class="literal">em</code> is a descendent of the <code class="literal">div</code> element.</p><p>
<strong>Child combinator</strong>: This combinator has the syntax like <code class="literal">selector &gt; selector</code>.</p><p>The child combinator<a id="id125" class="indexterm"/> offers a more restrictive way to describe a parent-child relationship between two elements. A child combinator is defined using a greater-than sign (U+003E, &gt;) <a id="id126" class="indexterm"/>character separating two selectors.</p><p>The following selector:</p><div><pre class="programlisting">span &gt; em</pre></div><p>It will select the <code class="literal">em</code> element since <code class="literal">em</code> is a direct child of the <code class="literal">span</code> element in our example. While the selector <code class="literal">div &gt; em</code> will not produce any valid selection since <code class="literal">em</code> is not a direct child of the <code class="literal">div</code> element.</p><div><div><h3 class="title"><a id="note12"/>Note</h3><p>The level-3 selector also supports sibling combinators however since it is less common we are not going to cover it here; interested readers can refer to W3C level-3 selector documentation <a class="ulink" href="http://www.w3.org/TR/css3-selectors/#sibling-combinators">http://www.w3.org/TR/css3-selectors/#sibling-combinators</a>
</p><p>The W3C level-4 selector offers some interesting additional combinators, that is, following-sibling and reference combinators that can yield some very powerful target selection capability; see <a class="ulink" href="http://dev.w3.org/csswg/selectors4/#combinators">http://dev.w3.org/csswg/selectors4/#combinators</a> for more details.</p></div></div><p>
<strong>The D3 subselection</strong>: On line B and C, a <a id="id127" class="indexterm"/>different kind of subselection technique was used. In this case a simple D3 selection was made first on line B selecting <code class="literal">section #section2</code> element. Immediately afterwards another <code class="literal">select</code> was chained to select a <code class="literal">div</code> element on line C. This kind of chained selection defines a scoped selection. In plain English, this basically means to select a <code class="literal">div</code> element that is nested under <code class="literal">#section2</code>. In semantics, this is essentially similar to using a descendant combinator <code class="literal">#section2 div</code>. However, the <a id="id128" class="indexterm"/>advantage of this form of subselection is that since the parent element is separately selected therefore it allows you to handle the parent element before selecting the<a id="id129" class="indexterm"/> child element. To demonstrate this, let's take a look at the following code snippet:</p><div><pre class="programlisting">d3.select("#section2") // &lt;-- B
    .style("font-size", "2em") // &lt;-- B-1
    .select("div") // &lt;-- C
    .attr("class", "red box");</pre></div><p>As shown in the preceding code snippet, now you can see before we select the <code class="literal">div</code> element, we can apply a modifier function to <code class="literal">#section2</code> on line B-1. This flexibility will be further explored in the next section.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Function chaining</h1></div></div></div><p>As we have seen so far, the D3 API is<a id="id130" class="indexterm"/> completely designed around the idea of function chaining. Therefore it almost forms a Domain Specific Language (DSL)<a id="id131" class="indexterm"/> for building HTML/SVG elements dynamically. In this code example, we will take a look at how the entire body structure of the previous example can be constructed using D3 alone.</p><div><div><h3 class="title"><a id="note13"/>Note</h3><p>If DSL is a new concept for you, I highly recommend checking out this excellent explanation on DSL by Martin Fowler in the form of an excerpt from his book <em>Domain-Specific Languages</em>. The excerpt can be found at <a class="ulink" href="http://www.informit.com/articles/article.aspx?p=1592379">http://www.informit.com/articles/article.aspx?p=1592379</a>.</p></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec31"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter2/function-chain.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter2/function-chain.html</a>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec32"/>How to do it...</h2></div></div></div><p>Let's see how function chain can be used to produce concise and readable code that produces dynamic visual content.</p><div><pre class="programlisting">&lt;script type="text/javascript"&gt;
<strong>  var body = d3.select("body"); // &lt;-- A</strong>

<strong>  body.append("section") // &lt;-- B</strong>
<strong>      .attr("id", "section1") // &lt;-- C</strong>
<strong>    .append("div") // &lt;-- D</strong>
<strong>      .attr("class", "blue box") // &lt;-- E</strong>
<strong>    .append("p") // &lt;-- F</strong>
<strong>      .text("dynamic blue box"); // &lt;-- G</strong>

  body.append("section")
      .attr("id", "section2")
    .append("div")
      .attr("class", "red box")
    .append("p")
      .text("dynamic red box");
&lt;/script&gt;</pre></div><p>This code generates the <a id="id132" class="indexterm"/>following visual output (similar to what we saw in the previous chapter):</p><div><img src="img/2162OS_02_04.jpg" alt="How to do it..."/><div><p>Function chain</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec33"/>How it works...</h2></div></div></div><p>Despite the visual similarity to the previous example, the construction process of the DOM elements is significantly different in this example. As demonstrated by the code example there is no static HTML element on the page contrary to the previous recipe where both the <code class="literal">section</code> and <code class="literal">div</code> elements existed.</p><p>Let's examine closely how these elements were dynamically created. On line A, a general selection was made to the top level <code class="literal">body</code> element. The <code class="literal">body</code> selection result was cached using a local variable called <code class="literal">body</code>. Then at line B, a new element <code class="literal">section</code> was appended to the body. Remember that the <code class="literal">append</code> function returns a new selection that contains the newly appended element therefore on line C the <code class="literal">id</code> attribute can then be set on a newly created section element to <code class="literal">section1</code>. Afterwards on line D a new <code class="literal">div</code> element was created and appended to <code class="literal">#section1</code> with its CSS class set to <code class="literal">blue box</code> on line E. Next step, similarly on line F a <code class="literal">paragraph</code> element was appended to the <code class="literal">div</code> element with its textual content set to <code class="literal">dynamic blue box</code> on line G.</p><p>As illustrated by this<a id="id133" class="indexterm"/> example, this chaining process can continue to create any structure of arbitrary complexity. As a matter of fact, this is how typically D3 based data visualization structure was created. Many visualization projects simply contain only a HTML skeleton while relying on D3 to create the rest. Getting comfortable with this way of function chaining is critical if you want to become efficient with the D3 library.</p><div><div><h3 class="title"><a id="tip17"/>Tip</h3><p>Some of D3's modifier functions return a new selection, such as the <code class="literal">select</code>, <code class="literal">append</code>, and <code class="literal">insert</code> functions. It is a good practice to use different levels of indentation to differentiate which selection your function chain is being applied on.</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Manipulating the raw selection</h1></div></div></div><p>Sometimes, though not very often, having access to D3 raw selection array might be beneficial in development whether it's for debugging purposes or for integrating with other JavaScript libraries which require access to raw DOM elements; in this recipe, we will show you ways to do that. We <a id="id134" class="indexterm"/>will also see some internal structure of a D3 selection object.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec34"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter2/raw-selection.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter2/raw-selection.html</a>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec35"/>How to do it...</h2></div></div></div><p>Of course you can achieve this by using the <code class="literal">nth-child</code> selector or selection iterator function via <code class="literal">each</code>, but there are cases where these options are just too cumbersome and inconvenient. This is when you might find dealing with raw selection array as a more convenient approach. In this <a id="id135" class="indexterm"/>example, we will see how raw selection array can be accessed and leveraged.</p><div><pre class="programlisting">&lt;table class="table"&gt;
    &lt;thead&gt;
    &lt;tr&gt;
        &lt;th&gt;Time&lt;/th&gt;
        &lt;th&gt;Type&lt;/th&gt;
        &lt;th&gt;Amount&lt;/th&gt;
    &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
    &lt;tr&gt;
        &lt;td&gt;10:22&lt;/td&gt;
        &lt;td&gt;Purchase&lt;/td&gt;
        &lt;td&gt;$10.00&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;td&gt;12:12&lt;/td&gt;
        &lt;td&gt;Purchase&lt;/td&gt;
        &lt;td&gt;$12.50&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;td&gt;14:11&lt;/td&gt;
        &lt;td&gt;Expense&lt;/td&gt;
        &lt;td&gt;$9.70&lt;/td&gt;
    &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;

&lt;script type="text/javascript"&gt;
<strong>    var rows = d3.selectAll("tr");// &lt;-- A</strong>

<strong>    var headerElement = rows[0][0];// &lt;-- B</strong>

<strong>    d3.select(headerElement).attr("class","table-header");// &lt;--C</strong>

<strong>    d3.select(rows[0][1]).attr("class","table-row-odd"); //&lt;-- D</strong>
<strong>    d3.select(rows[0][2]).attr("class","table-row-even"); //&lt;-- E</strong>
<strong>    d3.select(rows[0][3]).attr("class","table-row-odd"); //&lt;-- F</strong>
&lt;/script&gt;</pre></div><p>This recipe generates the following visual output:</p><div><img src="img/2162OS_02_05.jpg" alt="How to do it..."/><div><p>Raw selection manipulation</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec36"/>How it works...</h2></div></div></div><p>In this example, we<a id="id136" class="indexterm"/> went through an existing HTML table to color the table. This is not intended to be a good example of how you would color odd versus even rows in a table using D3. Instead, this example is designed to show how raw selection array can be accessed.</p><div><div><h3 class="title"><a id="tip18"/>Tip</h3><p>A much better way to color odd and even rows in a table would be using the <code class="literal">each</code> function and then relying on the index parameter <code class="literal">i</code> to do the job.</p></div></div><p>On line A, we select all rows and store the selection in the <code class="literal">rows</code> variable. D3 selection is stored in a two-dimensional JavaScript array. The selected elements are stored in an array then wrapped in a single element array. Thus in order to access the first selected element, you need to use <code class="literal">rows[0][0]</code> and the second element can be accessed with <code class="literal">rows[0][1]</code>. As we can see on line B, the table header element can be accessed using <code class="literal">rows[0][0]</code> and this will return a DOM element object. Again as we have demonstrated in previous sections, any DOM element can then be selected directly using <code class="literal">d3.select</code> as shown on line C. Line D, E, and F demonstrate how each element in selection can be directly indexed and accessed.</p><p>Raw selection access could be handy in some cases; however since it relies on direct access to D3 selection array it creates a structural dependency in your code. In other words, if in future releases of D3 this structure ever changes, it will break your code that relies on it. Hence, it is advised to avoid raw selection manipulation unless absolutely <a id="id137" class="indexterm"/>necessary.</p><div><div><h3 class="title"><a id="tip19"/>Tip</h3><p>This approach is usually not necessary however it might become handy under certain circumstances such as in your unit-test cases when knowing the absolute index for each element quickly and gaining a reference to them could be convenient. We will cover unit-tests in a later chapter in more details.</p></div></div></div></div></body></html>