<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;1.&#xA0;Getting Started with QGIS"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch01" class="calibre1"/>Chapter 1. Getting Started with QGIS</h1></div></div></div><p class="calibre8">This chapter provides an overview of the QGIS system and how you can work with it using the Python programming language. In particular, this chapter will cover the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Downloading, installing, and running QGIS</li><li class="listitem">Becoming familiar with the QGIS application</li><li class="listitem">Using Python within QGIS</li><li class="listitem">Using the Python Console as a window into the QGIS environment</li><li class="listitem">Working of a QGIS Python plugin</li><li class="listitem">Interacting with the QGIS Python API from an external Python program</li></ul></div></div>

<div class="book" title="Chapter&#xA0;1.&#xA0;Getting Started with QGIS">
<div class="book" title="About QGIS"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch01lvl1sec08" class="calibre1"/>About QGIS</h1></div></div></div><p class="calibre8">QGIS is a popular, free, and open source<a id="id0" class="calibre1"/> <span class="strong"><strong class="calibre9">Geographic Information System</strong></span> (<span class="strong"><strong class="calibre9">GIS</strong></span>), which runs on all major operating systems. People often use QGIS to view, edit, and analyze geospatial data. For<a id="id1" class="calibre1"/> our purposes, however, QGIS is more than just a GIS system; it is also a geospatial programming environment, which we can use to build our own geospatial applications using Python.</p><p class="calibre8">QGIS has a comprehensive<a id="id2" class="calibre1"/> website (<a class="calibre1" href="http://qgis.org">http://qgis.org</a>), which makes it easy to download, install, and use.</p><p class="calibre8">Before reading further, you should spend 15 minutes looking through the website and getting familiar with the application and the documentation available online. In particular, you should check out the <span class="strong"><strong class="calibre9">Documentation</strong></span> page, where three important manuals are available: <span class="strong"><em class="calibre10">QGIS User guide/Manual</em></span>, <span class="strong"><em class="calibre10">QGIS Training manual</em></span>, and <span class="strong"><em class="calibre10">PyQGIS cookbook</em></span>.</p><p class="calibre8">
<span class="strong"><em class="calibre10">QGIS User guide/Manual</em></span> provides in-depth user documentation, which you might find useful. <span class="strong"><em class="calibre10">QGIS Training manual</em></span> is a detailed introduction to GIS systems and concepts based on QGIS; you might find it useful to work through this course if you aren't already familiar with geospatial data and techniques. Finally, <span class="strong"><em class="calibre10">PyQGIS cookbook</em></span> will be an essential reference to<a id="id3" class="calibre1"/> use as you develop your own mapping applications built on top of QGIS.</p></div></div>

<div class="book" title="Chapter&#xA0;1.&#xA0;Getting Started with QGIS">
<div class="book" title="About QGIS">
<div class="book" title="Installing and running QGIS"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec08" class="calibre1"/>Installing and running QGIS</h2></div></div></div><p class="calibre8">If you haven't already installed QGIS, click on the <span class="strong"><strong class="calibre9">Download Now</strong></span> button on the main QGIS web page to download the QGIS software. What you do next depends on which operating system you <a id="id4" class="calibre1"/>are running on your computer:</p><div class="book"><ul class="itemizedlist"><li class="listitem">For MS Windows, you can download a double-clickable installer that installs QGIS and all the<a id="id5" class="calibre1"/> required libraries in one go. Make sure you use the OSGeo4W installer, which includes the Python interpreter, QGIS itself, and all the required libraries.</li><li class="listitem">For Mac OS X, you'll need to <a id="id6" class="calibre1"/>visit the Kyngchaos website (<a class="calibre1" href="http://www.kyngchaos.com/software/qgis">http://www.kyngchaos.com/software/qgis</a>) to download and install the GDAL and matplotlib libraries before installing a version of QGIS specially built for your operating system. All the required packages are available from the Kyngchaos site.</li><li class="listitem">For Unix-like systems, you'll use a package manager to download, compile, and install QGIS and the required libraries from an appropriate package repository. More information about installing on <a id="id7" class="calibre1"/>a Unix-like system can be found at <a class="calibre1" href="http://qgis.org/en/site/forusers/alldownloads.html#linux">http://qgis.org/en/site/forusers/alldownloads.html#linux</a>.</li></ul></div><p class="calibre8">Once you have installed the QGIS system, you can run it just like any other application on your computer, for example, by double-clicking on the QGIS icon in your <code class="email">Applications</code> folder.</p><p class="calibre8">If everything goes well, the QGIS application will start up and you will be greeted with the following window:</p><div class="mediaobject"><img src="../images/00002.jpeg" alt="Installing and running QGIS" class="calibre11"/></div><p class="calibre12"> </p><div class="informalexample" title="Note"><h3 class="title2"><a id="note02" class="calibre1"/>Note</h3><p class="calibre8">The exact appearance<a id="id8" class="calibre1"/> of the window might vary depending on your operating system. Don't worry, as long as a window appears, which looks something like the one shown in the previous screenshot, you are running QGIS.</p></div><p class="calibre8">You don't need to <a id="id9" class="calibre1"/>worry too much about the QGIS user interface right now; the QGIS User Guide describes the interface and various options in great detail. Rather than duplicating this information, let's take a look under the hood to see how QGIS works.</p></div></div></div>

<div class="book" title="Chapter&#xA0;1.&#xA0;Getting Started with QGIS">
<div class="book" title="About QGIS">
<div class="book" title="Understanding QGIS concepts"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch01lvl2sec09" class="calibre1"/>Understanding QGIS concepts</h2></div></div></div><p class="calibre8">To understand QGIS, you will have<a id="id10" class="calibre1"/> to become familiar with the following basic terms and concepts:</p><div class="book"><ul class="itemizedlist"><li class="listitem">QGIS works with geospatial information loaded from a variety <a id="id11" class="calibre1"/>of <span class="strong"><strong class="calibre9">data sources</strong></span>. These data sources can include vector and raster data files on a disk, a variety of spatial databases, and even web services such as <span class="strong"><strong class="calibre9">Web Map Service</strong></span> (<span class="strong"><strong class="calibre9">WMS</strong></span>) servers<a id="id12" class="calibre1"/> that provide geospatial data from the Internet.</li><li class="listitem">Wherever the data comes from, it is retrieved by QGIS and displayed as a <span class="strong"><strong class="calibre9">map layer</strong></span>. Map<a id="id13" class="calibre1"/> layers can be shown or hidden, and also customized in various ways to affect the way the data is displayed on the map.</li><li class="listitem">The map layers are then combined and displayed on a <a id="id14" class="calibre1"/><span class="strong"><strong class="calibre9">map</strong></span>.</li><li class="listitem">Finally, the various map layers, the map, and the other settings, all make up a project. QGIS always has<a id="id15" class="calibre1"/> one and only one project that it is working with. The project consists of all the map layers, the map display options, and the various settings that are currently loaded into QGIS.</li></ul></div><p class="calibre8">These concepts are related in the following manner:</p><div class="mediaobject"><img src="../images/00003.jpeg" alt="Understanding QGIS concepts" class="calibre11"/></div><p class="calibre12"> </p><div class="informalexample" title="Note"><h3 class="title2"><a id="note03" class="calibre1"/>Note</h3><p class="calibre8">Note that the data sources are outside QGIS. While the map layer refers to a data source, the data itself is stored somewhere else, for example, in a file on a disk or within a database.</p></div><p class="calibre8">Whenever you are working <a id="id16" class="calibre1"/>with QGIS, you are always working within the current project. You can save projects and reload them later, or start a new project to reset QGIS back to its original state.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Linking QGIS and Python"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec09" class="calibre1"/>Linking QGIS and Python</h1></div></div></div><p class="calibre8">While QGIS itself is written in C++, it includes extensive support for Python programming. A<a id="id17" class="calibre1"/> Python interpreter is built in, and can be used interactively via the Python Console, or to run plugins written in Python. There is also a comprehensive API for querying and controlling the QGIS application using Python code.</p><p class="calibre8">There are three ways in which you can use Python to work with the QGIS system:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre9">Python Console</strong></span>: You can<a id="id18" class="calibre1"/> open this console, which runs the interactive Python interpreter built into QGIS, allowing you to type in commands and see the results immediately.</li><li class="listitem"><span class="strong"><strong class="calibre9">Python plugin</strong></span>: These<a id="id19" class="calibre1"/> are Python packages designed to be run within the QGIS environment.</li><li class="listitem">E<span class="strong"><strong class="calibre9">xternal applications</strong></span>: You can<a id="id20" class="calibre1"/> use the QGIS Python API in your own applications. This lets you use QGIS as a geospatial processing engine, or even build your own interactive applications based on QGIS.</li></ul></div><p class="calibre8">No matter how you use Python and QGIS, you will make extensive use of the QGIS Python libraries, which are often referred to as <a id="id21" class="calibre1"/>
<span class="strong"><strong class="calibre9">PyQGIS</strong></span>. They provide a complete programmatic interface to the QGIS system, including calls to load data sources into layers, manipulate the map, export map visualizations, and build custom applications using the QGIS user interface. While an in-depth examination of the PyQGIS library will have to wait until <a class="calibre1" title="Chapter 3. Learning the QGIS Python API" href="part0021_split_000.html#page">Chapter 3</a>, <span class="strong"><em class="calibre10">Learning the QGIS Python API</em></span>, we will start dabbling with it right away in the next section on the Python Console.</p><p class="calibre8">For the remainder of this chapter, we will examine each of the three ways in which you can work with QGIS and Python.</p></div>

<div class="book" title="Linking QGIS and Python">
<div class="book" title="Exploring the Python Console"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec10" class="calibre1"/>Exploring the Python Console</h2></div></div></div><p class="calibre8">The QGIS Python Console window can be accessed by using the <span class="strong"><strong class="calibre9">Python Console</strong></span> item in the <span class="strong"><strong class="calibre9">Plugins</strong></span> menu. When <a id="id22" class="calibre1"/>you select this command, the Python Console will appear in the lower-right corner of the QGIS window. Here's what the<a id="id23" class="calibre1"/> Python Console looks like when you first open it:</p><div class="mediaobject"><img src="../images/00004.jpeg" alt="Exploring the Python Console" class="calibre11"/></div><p class="calibre12"> </p><p class="calibre8">While the Python Console is an excellent tool for interacting with an existing QGIS project, we are going to use it to create a new project from scratch. Before we can do this, though, we'll need to download some geospatial data sources for our QGIS project.</p><p class="calibre8">We are going to need a suitable<a id="id24" class="calibre1"/> <span class="strong"><strong class="calibre9">base map</strong></span> for our project, as well as some river and city information to display on top of this base map. Let's use the Natural Earth website<a id="id25" class="calibre1"/> to obtain the information we need. Go to <a class="calibre1" href="http://naturalearthdata.com">http://naturalearthdata.com</a> and click on the <span class="strong"><strong class="calibre9">Downloads</strong></span> tab.</p><p class="calibre8">Firstly, we'll want to download a nice-looking base map for our project. To do this, select the <span class="strong"><strong class="calibre9">Raster</strong></span> link under the <span class="strong"><strong class="calibre9">Medium scale data, 1:50m</strong></span> section, choose the <span class="strong"><strong class="calibre9">Natural Earth 1</strong></span> dataset, and click on the <span class="strong"><strong class="calibre9">Download small size</strong></span> link under the <span class="strong"><em class="calibre10">Natural Earth I with Shaded Relief and Water</em></span> heading.</p><p class="calibre8">Next, we need an overlay, which will show lakes and rivers on top of our base map. To get this information, go back to the <span class="strong"><strong class="calibre9">Downloads</strong></span> tab and select the <span class="strong"><strong class="calibre9">Physical</strong></span> link under the <span class="strong"><strong class="calibre9">Medium scale data, 1:50m</strong></span> section. The dataset you want is called <span class="strong"><em class="calibre10">Rivers, Lake Centerlines</em></span>, so click on the <span class="strong"><strong class="calibre9">Download rivers and lake centerlines</strong></span> link to obtain this file.</p><p class="calibre8">Finally, we'll want to highlight the cities on top of our base map. Go back to the <span class="strong"><strong class="calibre9">Downloads</strong></span> page and select the <span class="strong"><strong class="calibre9">Cultural</strong></span> link under the <span class="strong"><strong class="calibre9">Medium scale data, 1:50m</strong></span> heading. At the bottom is a section labelled <span class="strong"><strong class="calibre9">Urban Areas</strong></span>. Click on the <span class="strong"><strong class="calibre9">Download urban areas</strong></span> link to download this file.</p><p class="calibre8">Once you've done<a id="id26" class="calibre1"/> all this, you should have the following three files:</p><div class="book"><ul class="itemizedlist"><li class="listitem">A raster base map in a file named <code class="email">NE1_50M_SR_W.zip</code></li><li class="listitem">Lake and river vector data in a file named <code class="email">ne_50m_rivers_lake_centerlines.zip</code></li><li class="listitem">Urban area vector data in a file named <code class="email">ne_50m_urban_areas.zip</code></li></ul></div><p class="calibre8">Since these are ZIP archives, you will need to unzip these files and store them somewhere at a convenient location on your hard disk.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip02" class="calibre1"/>Tip</h3><p class="calibre8">You'll need to type in the full path to these datasets, so you might want to put them somewhere convenient, for example, in your home or user directory. In this way, the path you type won't be too long.</p></div><p class="calibre8">Now that we have <a id="id27" class="calibre1"/>our data, let's use the QGIS Python Console to import this data into a project. If you've already loaded some data into QGIS (for example, by following the tutorial in the QGIS User Guide), choose the <span class="strong"><strong class="calibre9">New</strong></span> option from the <span class="strong"><strong class="calibre9">Project</strong></span> menu to start again with a blank project. Then, type the following into the QGIS Python Console:</p><div class="informalexample"><pre class="programlisting">layer1 = iface.addRasterLayer("/path/to/NE1_50M_SR_W/NE1_50M_SR_W.tif", "basemap")</pre></div><p class="calibre8">Make sure you replace <code class="email">/path/to/</code> with the full path to the <code class="email">NE1_50M_SR_W</code> directory you downloaded. Assuming you typed the path correctly, the Natural Earth 1 base map should appear in the QGIS window:</p><div class="mediaobject"><img src="../images/00005.jpeg" alt="Exploring the Python Console" class="calibre11"/></div><p class="calibre12"> </p><p class="calibre8">As you can see, our base map is a bit small right now. You can use the various panning and zooming commands<a id="id28" class="calibre1"/> in the toolbar at the top of the window to make it bigger, but let's use Python to do the same thing:</p><div class="informalexample"><pre class="programlisting">iface.zoomFull()</pre></div><p class="calibre8">This will expand the base map to fill the entire window.</p><p class="calibre8">Now that we have a base map, let's add our two vector layers to the project. To do this, type the following:</p><div class="informalexample"><pre class="programlisting">layer2 = iface.addVectorLayer("/path/to/ne_50m_urban_areas/ne_50m_urban_areas.shp", "urban", "ogr")</pre></div><p class="calibre8">Once again, make sure you replace <code class="email">/path/to/</code> with the full path to the <code class="email">ne_50m_urban_areas</code> directory you downloaded earlier. The urban areas shapefile will be loaded into the QGIS project and will appear as a series of colored areas on top of the base map. Let's zoom in<a id="id29" class="calibre1"/> to an area of California so that we can see what this looks like more clearly. To do this, type the following commands into the Python Console window:</p><div class="informalexample"><pre class="programlisting">iface.mapCanvas().setExtent(QgsRectangle(-125, 31, -113, 38))
iface.mapCanvas().refresh()</pre></div><p class="calibre8">This will zoom in on the map in so that an area of California, including Los Angeles and the southern part of San Francisco, is now shown on the map:</p><div class="mediaobject"><img src="../images/00006.jpeg" alt="Exploring the Python Console" class="calibre11"/></div><p class="calibre12"> </p><p class="calibre8">Finally, let's add our river and<a id="id30" class="calibre1"/> lake data to our project. To do this, enter the following into the Python Console:</p><div class="informalexample"><pre class="programlisting">layer3 = iface.addVectorLayer("/path/to/ne_50m_rivers_lake_centerlines/ne_50m_rivers_lake_centerlines.shp", "water", "ogr")</pre></div><p class="calibre8">If you look at the map, you'll see that the rivers and lakes are now visible. However, they are drawn in a default green color. Let's change this so that the water is now blue:</p><div class="informalexample"><pre class="programlisting">from PyQt4.QtGui import QColor
layer3.rendererV2().symbols()[0].setColor(QColor("#4040FF"))
iface.mapCanvas().refresh()</pre></div><p class="calibre8">This code might be a bit confusing, but don't worry—we'll learn about renderers and symbols in <a class="calibre1" title="Chapter 3. Learning the QGIS Python API" href="part0021_split_000.html#page">Chapter 3</a>, <span class="strong"><em class="calibre10">Learning the QGIS Python API</em></span>.</p><p class="calibre8">Now that we are finished, you can save your project using the <span class="strong"><strong class="calibre9">Save As...</strong></span> item in the <span class="strong"><strong class="calibre9">Project</strong></span> menu. As you can see, it's quite possible to set up and customize your QGIS project using Python.</p></div></div>

<div class="book" title="Linking QGIS and Python">
<div class="book" title="Examining a Python plugin"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec11" class="calibre1"/>Examining a Python plugin</h2></div></div></div><p class="calibre8">While the Python<a id="id31" class="calibre1"/> Console is a<a id="id32" class="calibre1"/> fantastic tool for interactive coding, it isn't all that useful if you want to use Python to extend the functionality of QGIS. This is where QGIS plugins come in; you can create (or download) a plugin that adds new features or changes the way QGIS works.</p><p class="calibre8">Because QGIS is written using the Qt framework, QGIS plugins make use of the Python bindings in Qt, which are called<a id="id33" class="calibre1"/> <span class="strong"><strong class="calibre9">PyQt</strong></span>. We will download and install PyQt and the related tools when we start to build our own plugins in <a class="calibre1" title="Chapter 4. Creating QGIS Plugins" href="part0026_split_000.html#page">Chapter 4</a>, <span class="strong"><em class="calibre10">Creating QGIS Plugins</em></span>.</p><p class="calibre8">To get an idea of how <a id="id34" class="calibre1"/>a Python plugin works, let's take a look at the <span class="strong"><strong class="calibre9">Zoom to Point</strong></span> plugin. As the name suggests, this plugin lets you zoom to display a given coordinate on the map. It's also written in Python, and is a convenient example for learning about plugins in general.</p><p class="calibre8">Before we can use it, we have to install this plugin. Choose the <span class="strong"><strong class="calibre9">Manage and Install Plugins...</strong></span> item from the <span class="strong"><strong class="calibre9">Plugins</strong></span> menu, and click on the <span class="strong"><strong class="calibre9">Not Installed</strong></span> tab. You should see <span class="strong"><strong class="calibre9">Zoom to Point</strong></span> listed<a id="id35" class="calibre1"/> near the bottom of the list of available plugins; click on this plugin, and then click on the <span class="strong"><strong class="calibre9">Install Plugin</strong></span> button to download and install it.</p><p class="calibre8">Let's run this plugin to see how it works; with the project you created earlier still loaded, click on the <span class="strong"><strong class="calibre9">Zoom to Point</strong></span> plugin's icon in the toolbar, which looks like this:</p><div class="mediaobject"><img src="../images/00007.jpeg" alt="Examining a Python plugin" class="calibre11"/></div><p class="calibre12"> </p><p class="calibre8">Try entering the longitude/latitude of your current location (if you don't know it, you might find <a class="calibre1" href="http://itouchmap.com/latlong.html">http://itouchmap.com/latlong.html</a> helpful). You should see the base map, urban areas, and waterways for your current location.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip03" class="calibre1"/>Tip</h3><p class="calibre8">Don't forget that x equals longitude and y equals latitude. It's easy to get them the wrong way around.</p></div><p class="calibre8">Now that we know what the plugin does, let's see how it works. The downloaded plugins are stored in a hidden directory named <code class="email">.qgis2</code> in your user or home directory. Go to this hidden directory using your favorite file manager (for Mac OS X, you can use the <span class="strong"><strong class="calibre9">Go to Folder...</strong></span> item in the Finder's <span class="strong"><strong class="calibre9">Go</strong></span> menu), and find the <code class="email">python/plugins</code> subdirectory. This is where the Python plugins are stored.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip04" class="calibre1"/>Tip</h3><p class="calibre8">Depending on your operating system and the version of QGIS you are using, the name of this hidden directory might be different. If you can't find it, look for a directory named <code class="email">.qgis</code> or <code class="email">.qgis2</code> or something similar.</p></div><p class="calibre8">You should see a<a id="id36" class="calibre1"/> directory named <code class="email">zoomtopoint</code> (the full path to this directory will be <code class="email">~/.qgis2/python/plugins/zoomtopoint</code>). Inside this directory, you<a id="id37" class="calibre1"/> will find the various files that make up the Zoom to Point plugin:</p><div class="mediaobject"><img src="../images/00008.jpeg" alt="Examining a Python plugin" class="calibre11"/></div><p class="calibre12"> </p><p class="calibre8">Let's see what these various files do:</p><div class="informalexample"><table border="1" class="calibre14"><colgroup class="calibre15"><col class="calibre16"/><col class="calibre16"/></colgroup><thead class="calibre17"><tr class="calibre18"><th valign="bottom" class="calibre19">
<p class="calibre20">Filename</p>
</th><th valign="bottom" class="calibre19">
<p class="calibre20">Used for</p>
</th></tr></thead><tbody class="calibre21"><tr class="calibre18"><td valign="top" class="calibre22">
<p class="calibre20">
<code class="literal">__init__.py</code>
</p>
</td><td valign="top" class="calibre22">
<p class="calibre20">This is a <a id="id38" class="indexterm"/>standard Python package initialization file. This file also initializes the plugin and makes it available to the QGIS system.</p>
</td></tr><tr class="calibre18"><td valign="top" class="calibre22">
<p class="calibre20">
<code class="literal">COPYING</code>
</p>
</td><td valign="top" class="calibre22">
<p class="calibre20">This is a copy of the GNU <span><strong class="calibre23">General Public License</strong></span> (<span><strong class="calibre23">GPL</strong></span>). Since the<a id="id39" class="indexterm"/> Zoom to Point plugin is generally <a id="id40" class="indexterm"/>available, this defines the license under which it can be used.</p>
</td></tr><tr class="calibre18"><td valign="top" class="calibre22">
<p class="calibre20">
<code class="literal">icon.png</code>
</p>
</td><td valign="top" class="calibre22">
<p class="calibre20">As the name <a id="id41" class="indexterm"/>suggests, this is the plugin's toolbar icon.</p>
</td></tr><tr class="calibre18"><td valign="top" class="calibre22">
<p class="calibre20">
<code class="literal">Makefile</code>
</p>
</td><td valign="top" class="calibre22">
<p class="calibre20">This is <a id="id42" class="indexterm"/>a standard *nix Makefile used to automate the process of compiling and deploying the plugin.</p>
</td></tr><tr class="calibre18"><td valign="top" class="calibre22">
<p class="calibre20">
<code class="literal">metadata.txt</code>
</p>
</td><td valign="top" class="calibre22">
<p class="calibre20">This file<a id="id43" class="indexterm"/> contains the plugin's metadata, including the full name of the plugin, a description, the current version number, and so on.</p>
</td></tr><tr class="calibre18"><td valign="top" class="calibre22">
<p class="calibre20">
<code class="literal">resources.qrc</code>
</p>
</td><td valign="top" class="calibre22">
<p class="calibre20">This is a Qt resource<a id="id44" class="indexterm"/> file that defines the various resources such as images and sound files used by the plugin.</p>
</td></tr><tr class="calibre18"><td valign="top" class="calibre22">
<p class="calibre20">
<code class="literal">resources.py</code>
</p>
</td><td valign="top" class="calibre22">
<p class="calibre20">This indicates<a id="id45" class="indexterm"/> the contents of the <code class="literal">resources.qrc</code> file, compiled into a Python module.</p>
</td></tr><tr class="calibre18"><td valign="top" class="calibre22">
<p class="calibre20">
<code class="literal">ui_zoomtopoint.ui</code>
</p>
</td><td valign="top" class="calibre22">
<p class="calibre20">This is a<a id="id46" class="indexterm"/> Qt user interface template that defines the main UI for the plugin.</p>
</td></tr><tr class="calibre18"><td valign="top" class="calibre22">
<p class="calibre20">
<code class="literal">ui_zoomtopoint.py</code>
</p>
</td><td valign="top" class="calibre22">
<p class="calibre20">This indicates<a id="id47" class="indexterm"/> the contents of the <code class="literal">ui_zoomtopoint.ui</code> file compiled into a Python module.</p>
</td></tr><tr class="calibre18"><td valign="top" class="calibre22">
<p class="calibre20">
<code class="literal">zoomtopoint.py</code>
</p>
</td><td valign="top" class="calibre22">
<p class="calibre20">This file<a id="id48" class="indexterm"/> contains the main Python code for the plugin.</p>
</td></tr><tr class="calibre18"><td valign="top" class="calibre22">
<p class="calibre20">
<code class="literal">zoomtopointdialog.ui</code>
</p>
</td><td valign="top" class="calibre22">
<p class="calibre20">This is a copy <a id="id49" class="indexterm"/>of the <code class="literal">ui_zoomtopoint.ui</code> file. It looks like this file was included by accident, as the plugin can run without it.</p>
</td></tr><tr class="calibre18"><td valign="top" class="calibre22">
<p class="calibre20">
<code class="literal">zoomtopointdialog.py</code>
</p>
</td><td valign="top" class="calibre22">
<p class="calibre20">This Python <a id="id50" class="indexterm"/>module defines a <code class="literal">QtGui.QDialog</code> subclass that loads the dialog box's contents from <code class="literal">ui_zoomtopoint.py</code>.</p>
</td></tr></tbody></table></div><p class="calibre8">Open the <code class="email">zoomtopoint.py</code> module in your favorite text editor. As you can see, this contains the main Python code for<a id="id51" class="calibre1"/> the plugin, in the form of a <code class="email">ZoomToPoint</code> class. This class has the following<a id="id52" class="calibre1"/> basic structure:</p><div class="informalexample"><pre class="programlisting">class ZoomToPoint:
    def __init__(self, iface):
        self.iface = iface

    def initGui(self):
        ...

    def unload(self):
        ...

    def run(self):
        ...</pre></div><p class="calibre8">If you open the <code class="email">__init__.py</code> module, you'll see how this class is used to define the plugin's behavior:</p><div class="informalexample"><pre class="programlisting">def classFactory(iface): 
      from zoomtopoint import ZoomToPoint 
      return ZoomToPoint(iface) </pre></div><p class="calibre8">When the plugin is loaded, a parameter named <code class="email">iface</code> is passed to the <code class="email">ClassFactory</code> function. This parameter is an instance of <code class="email">QgsInterface</code>, and provides access to the various parts of the running QGIS application. As you can see, the class factory creates a <code class="email">ZoomToPoint</code> object, and passes the <code class="email">iface</code> parameter to the initializer so that <code class="email">ZoomToPoint</code> can<a id="id53" class="calibre1"/> make use of it.</p><p class="calibre8">Notice how <code class="email">ZoomToPoint.__init__()</code>, in the <code class="email">Zoomtopoint.py</code> module, stores a reference to the <code class="email">iface</code> parameter in an instance variable, so that the other methods can refer to the QGIS interface using <code class="email">self.iface</code>. For example:</p><div class="informalexample"><pre class="programlisting">def __init__(self, iface):
    self.iface = iface

def initGui(self):
    ...
    self.iface.addPluginToMenu("&amp;Zoom to point...", self.action)</pre></div><p class="calibre8">This allows the plugin to interact with and manipulate the QGIS user interface.</p><p class="calibre8">The four methods<a id="id54" class="calibre1"/> defined by the <code class="email">ZoomToPoint</code> class<a id="id55" class="calibre1"/> are all quite straightforward:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">__init__()</code>: This method initializes a new <code class="email">ZoomToPoint</code> object.</li><li class="listitem"><code class="email">initGui()</code>: This method initializes the plugin's user interface, preparing it to be used.</li><li class="listitem"><code class="email">unload()</code>: This method removes the plugin from the QGIS user interface.</li><li class="listitem"><code class="email">run()</code>: This method is called when the plugin is activated, that is, when the user clicks on the plugin's icon in the toolbar, or selects the plugin from the Plugins menu.</li></ul></div><p class="calibre8">Don't worry too much about all the details here; we'll look at the process of initializing and unloading a plugin in a later chapter. For now, take a closer look at the <code class="email">run()</code> method. This method essentially looks like the following:</p><div class="informalexample"><pre class="programlisting">def run(self):
    dlg = ZoomToPointDialog()
    ...
    dlg.show()
    result = dlg.exec_()
    if result == 1:
        x = dlg.ui.xCoord.text()
        y = dlg.ui.yCoord.text()
        scale = dlg.ui.spinBoxScale.value()
        rect = QgsRectangle(float(x) – scale,
                            float(y) - scale,
                            float(x) + scale,
                            float(y) + scale)
        mc=self.iface.mapCanvas() 
        mc.setExtent(rect)
        mc.refresh()
        ...</pre></div><p class="calibre8">We've excluded the code that remembers the values the user entered previously, and copies those values back into the dialog when the plugin is run. Looking at the previous code, the logic seems to be fairly straightforward and is explained as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Create a <code class="email">ZoomToPointDialog</code> object.</li><li class="listitem">Display the dialog box to the user.</li><li class="listitem">If the user<a id="id56" class="calibre1"/> clicks on the <span class="strong"><strong class="calibre9">OK</strong></span> button, extract the entered values, use them to create a new bounding rectangle, and set the extent of the map to this rectangle.</li></ul></div><p class="calibre8">While this plugin is quite straightforward and the actual code doesn't do all that much, it is a useful example of what a Python plugin should look like, as well as the various files that are needed by a Python plugin. In particular, you should note that:</p><div class="book"><ul class="itemizedlist"><li class="listitem">A plugin is simply a <a id="id57" class="calibre1"/>directory that contains a Python package initialization file (<code class="email">__init__.py</code>), some Python modules, and other files created using Qt Designer.</li><li class="listitem">The <code class="email">__init__.py</code> module must define a top-level function named <code class="email">ClassFactory</code> that accepts an <code class="email">iface</code> parameter and returns an object that represents the plugin.</li><li class="listitem">The plugin object must define an <code class="email">initGui()</code> method, which is called to initialize the plugin's user interface, and an <code class="email">unload()</code> method, which is called to remove the plugin from the QGIS application.</li><li class="listitem">The plugin can interact with and manipulate the QGIS application via the <code class="email">iface</code> object passed to the class factory.</li><li class="listitem">The <code class="email">resources.qrc</code> file lists various resources such as images, which are used by the plugin.</li><li class="listitem">The <code class="email">resources.qrc</code> file is compiled into a <code class="email">resources.py</code> file using the PyQt command-line tools.</li><li class="listitem">Dialog boxes and other windows are created using a Qt Designer template, which are typically stored in a file with a name of the form <code class="email">ui_Foo.ui</code>.</li><li class="listitem">The UI template files are then compiled into Python code using the PyQt command-line tools. If the template is named <code class="email">ui_foo.ui</code>, then the associated Python module will be named <code class="email">ui_foo.py</code>.</li><li class="listitem">Once the user interface for a dialog box has been defined, you create a subclass of <code class="email">QtGui.QDialog</code>, and load that user interface module into it. This defines the contents of the dialog box based on your template.</li><li class="listitem">Your plugin can<a id="id58" class="calibre1"/> then display the dialog box as required, extracting the entered values and using the results to interact with QGIS via the <code class="email">iface</code> variable.</li></ul></div><p class="calibre8">Plugins are a<a id="id59" class="calibre1"/> useful way of extending and customizing QGIS. We will return to the topic of QGIS plugins in <a class="calibre1" title="Chapter 4. Creating QGIS Plugins" href="part0026_split_000.html#page">Chapter 4</a>, <span class="strong"><em class="calibre10">Creating QGIS Plugins</em></span>, where we will create our own plugin from scratch.</p></div></div>

<div class="book" title="Linking QGIS and Python">
<div class="book" title="Writing an external application"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch01lvl2sec12" class="calibre1"/>Writing an external application</h2></div></div></div><p class="calibre8">The final way to work with Python and QGIS is to write a completely standalone Python program that imports<a id="id60" class="calibre1"/> the QGIS libraries and works with them directly. In many ways, this is an ideal way of writing your own custom mapping applications, because your program doesn't have to run within the existing QGIS user interface. There are, however, a few things you need to be aware of when you attempt to use Python and QGIS in this way:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Your Python program needs to be able to find the QGIS Python libraries before it can be run. Since these are bundled into the QGIS application itself, you will need to add the directory where the PyQGIS libraries are installed in your Python path.</li><li class="listitem" value="2">You also need to tell the PyQGIS libraries where the QGIS application's resources are stored.</li><li class="listitem" value="3">As the application is running outside the QGIS application, you won't have access to the <code class="email">iface</code> variable. You also can't use those parts of the PyQGIS library that assume you are running inside QGIS.</li></ol><div class="calibre24"/></div><p class="calibre8">None of this is too onerous, though it can trip you up the first time you attempt to access PyQGIS from your external Python code. Let's take a look at how we can avoid these traps when writing your own Python programs.</p><p class="calibre8">Firstly, to allow your program to access the PyQGIS libraries, you need to modify your Python path (and possibly some other environment variables) before you can import any of the QGIS packages. For MS Windows, you can do this by running the following in the command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">SET OSGEO4W_ROOT=C:\OSGeo4W</strong></span>
<span class="strong"><strong class="calibre9">SET QGIS_PREFIX=%OSGEO4W_ROOT%\apps\qgis</strong></span>
<span class="strong"><strong class="calibre9">SET PATH=%PATH%;%QGIS_PREFIX%\bin</strong></span>
<span class="strong"><strong class="calibre9">SET PYTHONPATH=%QGIS_PREFIX%\python;%PYTHONPATH%</strong></span>
</pre></div><p class="calibre8">If you are running Mac OS X, the following commands will set up the Python path for you:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">export PYTHONPATH="$PYTHONPATH:/Applications/QGIS.app/Contents/Resources/python"</strong></span>
<span class="strong"><strong class="calibre9">export DYLD_FRAMEWORK_PATH="/Applications/QGIS.app/Contents/Frameworks"</strong></span>
<span class="strong"><strong class="calibre9">export QGIS_PREFIX="/Applications/QGIS.app/Contents/Resources"</strong></span>
</pre></div><p class="calibre8">For computers that run a version of Linux, you can use the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">export PYTHONPATH="/path/to/qgis/build/output/python/"</strong></span>
<span class="strong"><strong class="calibre9">export LD_LIBRARY_PATH="/path/to/qgis/build/output/lib/"</strong></span>
<span class="strong"><strong class="calibre9">export QGIS_PREFIX="/path/to/qgis/build/output/"</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note04" class="calibre1"/>Note</h3><p class="calibre8">Obviously, you will need to replace <code class="email">/path/to/qgis</code> with the actual path of your QGIS installation.</p></div><p class="calibre8">If you have QGIS<a id="id61" class="calibre1"/> installed in a nonstandard location, you might need to modify these commands before they will work. To check if they have worked, start up the Python interpreter and enter the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">&gt;&gt;&gt; import qgis</strong></span>
</pre></div><p class="calibre8">If everything goes well, you'll simply see the Python prompt:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">&gt;&gt;&gt; </strong></span>
</pre></div><p class="calibre8">On the other hand, you might see the following error:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">ImportError: No module named qgis</strong></span>
</pre></div><p class="calibre8">In this case, the <code class="email">PYTHONPATH</code> variable has not been set up correctly, and you will have to check the commands you entered earlier to set this environment variable, and possibly modify it to allow for a nonstandard location of the QGIS libraries.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note05" class="calibre1"/>Note</h3><p class="calibre8">Note that in some cases, this isn't enough because the Python libraries are only wrappers around the underlying C++ libraries; you might also need to tell your computer where to find these C++ libraries. To see if this is a problem, you can try to do the following:</p><div class="informalexample"><pre class="programlisting">import qgis.core</pre></div><p class="calibre8">You might get an error that looks like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre9">ImportError: libqgis_core.so.1.5.0: cannot open shared object file: No such file or directory</strong></span>
</pre></div><p class="calibre8">You will to have to tell your computer where to find the underlying shared libraries. We will return to this later when we look at writing our own external applications; if you want to see the details, skip ahead to <a class="calibre1" title="Chapter 5. Using QGIS in an External Application" href="part0033_split_000.html#page">Chapter 5</a>, <span class="strong"><em class="calibre10">Using QGIS in an External Application</em></span>.</p></div><p class="calibre8">With the path set, you can now import the various parts of the PyQGIS library that you want to use, for example:</p><div class="informalexample"><pre class="programlisting">from qgis.core import *</pre></div><p class="calibre8">Now that we have access to the PyQGIS libraries, our next task is to initialize these libraries. As <a id="id62" class="calibre1"/>mentioned earlier, we have to tell PyQGIS where to find the various QGIS resources. We do this using the <code class="email">QgsApplication.setPrefixPath()</code> function, like this:</p><div class="informalexample"><pre class="programlisting">import os
QgsApplication.setPrefixPath(os.environ['QGIS_PREFIX'], True)</pre></div><p class="calibre8">This uses the <code class="email">QGIS_PREFIX</code> environment variable we set earlier to tell QGIS where to find its resources. With this done, you can then initialize the PyQGIS library by making the following call:</p><div class="informalexample"><pre class="programlisting">QgsApplication.initQgis()</pre></div><p class="calibre8">We can now use PyQGIS to do whatever we want in our application. When our program exits, we also need to inform the PyQGIS library that we are exiting:</p><div class="informalexample"><pre class="programlisting">QgsApplication.exitQgis()</pre></div><p class="calibre8">Putting all this together, our minimal Python application looks like this:</p><div class="informalexample"><pre class="programlisting">import os
from qgis.core import *

QgsApplication.setPrefixPath(os.environ['QGIS_PREFIX'], True)
QgsApplication.initQgis()

# ...

QgsApplication.exitQgis()</pre></div><p class="calibre8">Of course, this application doesn't do anything useful yet—it simply starts up and shuts down the PyQGIS libraries. So let's replace the "<code class="email">...</code>" line with some useful code that displays a basic map widget. To do this, we need to define a <code class="email">QMainWindow</code> subclass, which displays the map widget, and then create and use a <code class="email">QApplication</code> object to display this window and<a id="id63" class="calibre1"/> handle the various user-interface events while the application is running.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note08" class="calibre1"/>Note</h3><p class="calibre8">Both <code class="email">QMainWindow</code> and <code class="email">QApplication</code> are PyQt classes. We will be working extensively with the various PyQt classes as we develop our own external applications using QGIS and Python.</p></div><p class="calibre8">Let's start by replacing the "<code class="email">...</code>" line with the following code, which displays a map viewer and then runs the application's main event loop:</p><div class="informalexample"><pre class="programlisting">app = QApplication(sys.argv)

viewer = MapViewer("/path/to/shapefile.shp")
viewer.show()

app.exec_()</pre></div><p class="calibre8">As you can see, a <code class="email">MapViewer</code> instance (which we will define shortly) is created and displayed, and the <code class="email">QApplication</code> object is run by calling the <code class="email">exec_()</code> method. For simplicity, we pass the name of a shapefile to display within the map viewer.</p><p class="calibre8">Running this code will cause the map viewer to be displayed, and the application will run until the user closes the window or chooses the <span class="strong"><strong class="calibre9">Quit</strong></span> command from the menu.</p><p class="calibre8">Now, let's define the <code class="email">MapViewer</code> class. Here is what the class definition looks like:</p><div class="informalexample"><pre class="programlisting">class MapViewer(QMainWindow):
    def __init__(self, shapefile):
        QMainWindow.__init__(self)
        self.setWindowTitle("Map Viewer")

        canvas = QgsMapCanvas()
        canvas.useImageToRender(False)
        canvas.setCanvasColor(Qt.white)
        canvas.show()

        layer = QgsVectorLayer(shapefile, "layer1", "ogr")
        if not layer.isValid():
            raise IOError("Invalid shapefile")

        QgsMapLayerRegistry.instance().addMapLayer(layer)
        canvas.setExtent(layer.extent())
        canvas.setLayerSet([QgsMapCanvasLayer(layer)])

        layout = QVBoxLayout()
        layout.addWidget(canvas)

        contents = QWidget()
        contents.setLayout(layout)
        self.setCentralWidget(contents)</pre></div><p class="calibre8">Don't worry too much about the details of this class; we basically just create a window and place a <code class="email">QgsMapCanvas</code> object within it. We then create a map layer (an instance of <code class="email">QgsVectorLayer</code>) and add it to the map canvas. Finally, we add the canvas to the window's contents.</p><p class="calibre8">Notice that <a id="id64" class="calibre1"/>
<code class="email">QgsMapCanvas</code> and <code class="email">QgsVectorLayer</code> are both part of PyQGIS, while <code class="email">QMainWindow</code>, <code class="email">QVBoxLayout</code>, and <code class="email">QWidget</code> are all PyQt classes. This application uses the PyQGIS classes within a PyQt application, mixing the classes from both sources. This is possible because QGIS is built using Qt, and the various PyQGIS classes are based on PyQt.</p><p class="calibre8">To turn the preceding code into a working application, all we need to do is add some more <code class="email">import</code> statements to the top of the module:</p><div class="informalexample"><pre class="programlisting">import sys
from PyQt4.QtGui import *
from PyQt4.QtCore import Qt</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="tip05" class="calibre1"/>Tip</h3><p class="calibre8">
<span class="strong"><strong class="calibre9">Downloading the example code</strong></span>
</p><p class="calibre8">You can download the example code files from your account at <a class="calibre1" href="http://www.packtpub.com">http://www.packtpub.com</a> for all the Packt Publishing books you have purchased. If you purchased this book elsewhere, you can visit <a class="calibre1" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div><p class="calibre8">If you run this application, the map viewer will be displayed, showing the contents of the shapefile referred to by the code. For example:</p><div class="mediaobject"><img src="../images/00009.jpeg" alt="Writing an external application" class="calibre11"/></div><p class="calibre12"> </p><p class="calibre8">This application is still a bit ugly—you can see white space at the top and bottom this map because it doesn't take into account the aspect ratio of the map data. There's also no feature of <a id="id65" class="calibre1"/>zooming in or scrolling around the map. However, these can be added quite easily, and as you can see, it's not very difficult to create your own standalone mapping applications built on top of QGIS.</p></div></div>
<div class="book" title="Summary"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec10" class="calibre1"/>Summary</h1></div></div></div><p class="calibre8">In this chapter, we became familiar with QGIS and the various ways in which it can be used as a Python geospatial development system. We installed and explored the QGIS application itself, and then looked at how Python can be used with QGIS. We saw how QGIS uses data sources, map layers, maps, and projects to organize and work with geospatial data. Next, we examined the three ways in which you can use Python and QGIS: by typing commands into the Python Console, by writing a Python plugin or by writing an external application that makes use of the QGIS Python API.</p><p class="calibre8">We then looked at the extensive set of Python libraries that come with QGIS, called PyQGIS, which you can use for geospatial development. We saw how to use the QGIS Python Console to directly manipulate the QGIS project, add layers, zoom in and out, change options, and so on.</p><p class="calibre8">Next up, we downloaded and examined a QGIS Python plugin. In doing this, we learned that QGIS plugins are simply Python packages installed in a hidden directory named <code class="email">.qgis2</code> (or <code class="email">.qgis</code>) within your home or user directory. A plugin makes use of the Qt library to define and build resources such as user interface templates.</p><p class="calibre8">Finally, we saw how we can write external Python applications that load the PyQGIS libraries from within the QGIS system, and then use those libraries within a larger PyQt application.</p><p class="calibre8">In the next chapter, we will explore the QGIS Python Console in more detail, and use it to become more familiar with the PyQGIS library, and also see how we can use it within our own Python geospatial development projects.</p></div></body></html>