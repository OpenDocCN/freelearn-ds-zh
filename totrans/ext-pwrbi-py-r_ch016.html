<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="en-US">
<head>
<meta charset="utf-8"/>
<meta name="generator" content="packt"/>
<title>15 Advanced Visualizations</title>
<link rel="stylesheet" type="text/css" href="../styles/stylesheet1.css"/>
<link rel="stylesheet" type="text/css" href="../styles/stylesheet2.css"/>

</head>
<body>

<section id="advanced-visualizations" class="level1 pkt" data-number="16">
<h1 data-number="16">15 Advanced Visualizations</h1>
<p>As you have already seen in <em>Chapter 14</em>, <em>Exploratory Data Analysis</em>, thanks to the <code>ggplot2</code> package and its extensions, you can create very professional-looking charts. In this chapter, you'll see how you can create a very advanced and attractive custom chart. You will learn about the following topics:</p>
<ul>
<li>Choosing a circular barplot</li>
<li>Implementing a circular barplot in R</li>
<li>Implementing a circular barplot in Power BI</li>
</ul>
<section id="technical-requirements-14" class="level2" data-number="16.1">
<h2 data-number="16.1">Technical requirements</h2>
<p>This chapter requires you to have a working internet connection and <strong>Power BI Desktop</strong> already installed on your machine. You must have properly configured the R and Python engines and IDEs as outlined in <em>Chapter 2</em>, <em>Configuring R with Power BI</em>, and <em>Chapter 3</em>, <em>Configuring Python with Power BI</em>.</p>
</section>
<section id="choosing-a-circular-barplot" class="level2" data-number="16.2">
<h2 data-number="16.2">Choosing a circular barplot</h2>
<p>Very often, it happens that we need to represent the measures associated with various categorical entities using a <strong>bar chart</strong> (or <strong>barplot</strong>). However, when the number of entities to be represented exceeds 15 or 20, the graph starts to become unreadable, even though you arrange it vertically:</p>
<figure>
<img src="../media/file390.png" alt="Figure 15.1 – A barplot of worldwide weapons sellers" /><figcaption aria-hidden="true">Figure 15.1 – A barplot of worldwide weapons sellers</figcaption>
</figure>
<p>In this case, as you have already seen in <em>Chapter 14</em>, <em>Exploratory Data Analysis</em>, it is often a good idea to represent a maximum number of entities, after which the subsequent individual entities are grouped into a single category (in our case, the <em>Others</em> category). In this way, the readability of the graph is preserved, but part of the information you want to represent is lost.</p>
<p>If it is strictly necessary to display all entities with their measure, we often resort to a more eye-catching organization of the space occupied by the barplot, wrapping it in a circular shape, thus obtaining a <strong>circular barplot</strong>:</p>
<figure>
<img src="../media/file391.png" alt="Figure 15.2 – Circular barplot of worldwide weapons sellers" /><figcaption aria-hidden="true">Figure 15.2 – Circular barplot of worldwide weapons sellers</figcaption>
</figure>
<p>The graph becomes more interesting when you need not only to represent all entities but also to group them appropriately. Consider having a list of 24 speakers at an event, each of whom has received feedback (1 to 5) from viewers on some of their characteristics shown during the speech (<em>Expectation</em>, <em>Interesting</em>, <em>Useful</em>, and <em>Oral Presentation</em>). So, in the end, you have <em>24 x 4 = 96</em> entities to show. The grouped circular barplot describing this situation is very illustrative:</p>
<figure>
<img src="../media/file392.png" alt="Figure 15.3 – A circular barplot with groups of speaker feedback" /><figcaption aria-hidden="true">Figure 15.3 – A circular barplot with groups of speaker feedback</figcaption>
</figure>
<p>The circular barplot in <em>Figure 15.3</em> is the one we're going to implement using R and the <code>ggplot2</code> package in the next section.</p>
</section>
<section id="implementing-a-circular-barplot-in-r" class="level2" data-number="16.3">
<h2 data-number="16.3">Implementing a circular barplot in R</h2>
<p>The R code you will find in this section is inspired by the code shared with the entire R community by the <strong>R Graph Gallery</strong> website (<a href="https://www.r-graph-gallery.com/index.html">https://www.r-graph-gallery.com/index.html</a>). In addition to a few very small additions, we refactored and generalized the code into the <code>circular_grouped_barplot()</code> function using the <code>tidy evaluation</code> framework (check the references for further details) so that it can be used with any dataset.</p>
<p>If you remember correctly, in R functions you saw in previous chapters, you passed column names to functions as strings. Thanks to <code>tidy evaluation</code>, you can pass them to functions using <em>tidyverse grammar</em>, that is, passing them directly through a pipeline. Take the following example:</p>
<pre><code>circular_grouped_barplot(data = speakers_tbl,
                         grp_col_name = &#39;Characteristics&#39;,
                         label_col_name = &#39;SpeakerName&#39;,
                         value_col_name = &#39;Value&#39;)</code></pre>
<p>Instead of having that call for the previous function, you will have the following one:</p>
<pre><code>speakers_tbl %&gt;% 
  circular_grouped_barplot(grp_col_name = Characteristics,
                           label_col_name = SpeakerName,
                           value_col_name = Value)</code></pre>
<p>Note how in the last script, the quotes identifying the strings have disappeared.</p>
<p>Let’s take a step-by-step look at what this function does. The code you will find here is excerpted from the <code>01-circular-grouped-barplot.R</code> file you can find in the <code>Chapter15</code> folder. Let’s proceed as follows:</p>
<ol>
<li>First, make sure the <code>scales</code> package is already installed in your CRAN R dedicated to R visuals (in our case, version 3.4.4). Just check whether its name is in the list you can find in the bottom-right <strong>Packages</strong> tab in RStudio. If not, install it as always, using the <code>install.packages('scales')</code> command.</li>
<li><p>The dataset you will use is taken from the <code>Scores.csv</code> file you can find in the <code>Chapter15</code> folder. As mentioned in the previous section, it contains the average feedback obtained by 24 speakers from attendees at a conference on some of their characteristics shown during the speech. The tibble looks like the following:</p>
<figure>
<img src="../media/file393.png" alt="Figure 15.4 – The speakers tibble" /><figcaption aria-hidden="true">Figure 15.4 – The speakers tibble</figcaption>
</figure></li>
<li>Immediately after the call to the <code>circular_grouped_barplot()</code> function, the internal <code>rescale100()</code> function is defined, which is used to rescale the values of the entire dataset (in our case, the votes) on a scale of 0 to 100.</li>
<li><p>The execution of the arguments passed to the function via the <code>enquo()</code> function is then delayed (for more details, see the references):</p>
<pre><code>grp_var &lt;- enquo(grp_col_name)
label_var &lt;- enquo(label_col_name)
value_var &lt;- enquo(value_col_name)</code></pre></li>
<li><p>The categorical variables of the input dataset are transformed into factors, and the values are scaled thanks to the function defined previously, all using <code>tidy evaluation</code>:</p>
<pre><code>data &lt;- data %&gt;% 
  mutate( 
    !!quo_name(grp_var) := as.factor(!!grp_var),
    !!quo_name(label_var) := as.factor(!!label_var),
    !!quo_name(value_var) := rescale100(!!value_var) )</code></pre></li>
<li><p>In order to separate each group of bars, a few empty bars are added at the end of each group. First, an empty bars DataFrame is defined:</p>
<pre><code>empty_bars &lt;- 3
# Create the empty dataframe to add to the source dataframe
data_to_add &lt;- data.frame(matrix(NA, empty_bars * nlevels(data[[quo_name(grp_var)]]), ncol(data)) )
colnames(data_to_add) &lt;- colnames(data)
data_to_add[[quo_name(grp_var)]] &lt;- rep(levels(data[[quo_name(grp_var)]]), each = empty_bars)</code></pre>
<p>It has the following shape:</p>
<figure>
<img src="../media/file394.png" alt="Figure 15.5 – The empty bars DataFrame" /><figcaption aria-hidden="true">Figure 15.5 – The empty bars DataFrame</figcaption>
</figure></li>
<li><p>Then, the empty DataFrame is added to the source DataFrame (the <code>data</code> one). Once the resulting DataFrame is reordered for the grouping variable and values, the rows of the empty bars DataFrame are automatically distributed at the end of each group:</p>
<pre><code>data &lt;- rbind(data, data_to_add)
# Reorder data by groups and values
data &lt;- data %&gt;% arrange(!!grp_var, !!value_var)</code></pre></li>
<li><p>A bar identifier is added:</p>
<pre><code>data$id &lt;- seq(1, nrow(data))</code></pre>
<p>It is used to calculate the angle at which each label has to be displayed:</p>
<pre><code># Get the total number of bars
number_of_bars &lt;- nrow(data)
# Subtract 0.5 from id because the label must have the angle of the center of the bars,
# Not extreme right(1) or extreme left (0)
angles_of_bars &lt;- 90 - 360 * (data$id - 0.5) / number_of_bars</code></pre></li>
<li><p>We define the DataFrame of the labels, starting from the <code>data</code> one, considering the correct alignment of the labels with the bars and the correct angle they must have to be readable:</p>
<pre><code>label_data &lt;- data
label_data$hjust &lt;- ifelse( angles_of_bars &lt; -90, 1, 0)
label_data$angle &lt;- ifelse( angles_of_bars &lt; -90, angles_of_bars + 180, angles_of_bars)</code></pre></li>
<li><p>A DataFrame for base lines of groups is defined. It contains the start and end IDs (bars) of each group, the mean ID of each group (used as a base point for group text labels), and the angle at which each text label has to be rotated:</p>
<pre><code>base_data &lt;- data %&gt;% 
  group_by(!!grp_var) %&gt;% 
  summarize(start = min(id),
            end = max(id) - empty_bars) %&gt;% 
  rowwise() %&gt;% 
  mutate(title = floor(mean(c(start, end)))) %&gt;% 
  inner_join( label_data %&gt;% select(id, angle),
              by = c(&#39;title&#39; = &#39;id&#39;)) %&gt;% 
  mutate( angle = ifelse( (angle &gt; 0 &amp; angle &lt;= 90) |
                         (angle &gt; 180 &amp; angle &lt;= 270),
                          angle-90, angle+90 ) )</code></pre></li>
<li><p>An <code>if</code> clause determines whether to initially define a barplot with only one group or with multiple groups, depending on the content of the source dataset. In our case, since there are four groups, the code is the following:</p>
<pre><code>p &lt;- data %&gt;%
  ggplot(aes_string(x = &#39;id&#39;, y = quo_name(value_var), fill = quo_name(grp_var))) +
  # Add a barplot
  geom_bar(stat = &#39;identity&#39;, alpha=0.5) +
  # Add 100/75/50/25 indicators
  geom_segment(data = grid_data,
      aes(x = end, y = 100, xend = start, yend = 100),
      colour = &#39;grey&#39;, alpha=1, size=0.3 ,
      inherit.aes = FALSE ) +
  geom_segment(data = grid_data,
      aes(x = end, y = 80, xend = start, yend = 80),
      colour = &#39;grey&#39;, alpha=1, size=0.3 ,
      inherit.aes = FALSE ) +
  geom_segment(data = grid_data,
      aes(x = end, y = 60, xend = start, yend = 60),
      colour = &#39;grey&#39;, alpha=1, size=0.3 ,
      inherit.aes = FALSE ) +
  geom_segment(data = grid_data,
      aes(x = end, y = 40, xend = start, yend = 40),
      colour = &#39;grey&#39;, alpha=1, size=0.3 ,
      inherit.aes = FALSE ) +
  geom_segment(data = grid_data,
      aes(x = end, y = 20, xend = start, yend = 20),
      colour = &#39;grey&#39;, alpha=1, size=0.3 ,
      inherit.aes = FALSE ) +
  # Add text showing the value of each 100/75/50/25 lines
  annotate(&#39;text&#39;, x = rep(max(data$id), 5),
           y = c(20, 40, 60, 80, 100),
           label = c(&#39;20&#39;, &#39;40&#39;, &#39;60&#39;, &#39;80&#39;, 100) ,
           color=&#39;grey&#39;, size=3,
           angle=0, fontface=&#39;bold&#39;, hjust=1)</code></pre>
<p>The barplot representation is as follows:</p>
<figure>
<img src="../media/file395.png" alt="Figure 15.6 – The representation of the first draft of the barplot" /><figcaption aria-hidden="true">Figure 15.6 – The representation of the first draft of the barplot</figcaption>
</figure></li>
<li><p>After defining a text justification vector, the previous plot is cleaned of unnecessary graphical frills, and it is magically wrapped into a circular shape simply by using the <code>coord_polar()</code> function:</p>
<pre><code>p &lt;- p +
  # The space between the x-axis and the lower edge of the figure will implicitly define the width of the empty circle inside the plot 
  ylim(-120,120) +
  theme_minimal() +
  theme(
    legend.position = &#39;none&#39;,
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-1,4), &#39;cm&#39;) 
  ) +
  # Wrap all in a circle!
  coord_polar()</code></pre>
<p>What you get is the following first draft:</p>
<figure>
<img src="../media/file396.png" alt="Figure 15.7 – The first draft of the circular barplot" /><figcaption aria-hidden="true">Figure 15.7 – The first draft of the circular barplot</figcaption>
</figure>
<p>Unfortunately, the <code>coord_polar()</code> function does not rotate or curve the labels. So, you have to add them separately, rotating them manually when needed.</p></li>
<li><p>Finally, let’s add bar labels appropriately rotated, base lines of groups, and group text labels appropriately rotated:</p>
<pre><code>p &lt;- p +
  # Add labels
  geom_text(data = label_data %&gt;% mutate( y_pos = !!value_var + 10),
      aes_string(x = &#39;id&#39;, y = &#39;y_pos&#39;,
                 label = quo_name(label_var),
                 hjust = &#39;hjust&#39;),
      color = &#39;black&#39;, fontface = &#39;bold&#39;,
      alpha = 0.6, size = 3,
      angle = label_data$angle,
      inherit.aes = FALSE) +
  
  # Add base lines of groups
  geom_segment(data = base_data,
      aes(x = start, y = -5, xend = end, yend = -5),
      colour = &#39;black&#39;, alpha=0.8,
      size=0.6 , inherit.aes = FALSE ) +
  
  # Add groups text
  geom_text(data = base_data %&gt;% mutate(y = -14),
      aes_string(x = &#39;title&#39;, y = &#39;y&#39;,
                 label=quo_name(grp_var),
                 angle = &#39;angle&#39;),
      hjust = text_horiz_justification,
      colour = &#39;black&#39;, alpha=0.8, size=4,
      fontface=&#39;bold&#39;, inherit.aes = FALSE)</code></pre>
<p>The result can be seen in <em>Figure 15.3</em>.</p></li>
</ol>
<p>This is just one demonstration of how effective it is to make complex graphs with <code>ggplot2</code> by taking advantage of the <em>grammar of graphics</em>. As you have seen, this framework allows you to approach the creation of a complex chart by adding modular logic pieces one at a time, testing the result intuitively.</p>
<blockquote>
<p><strong>Important Note</strong></p>
<p>The code used in this section uses an old version of <code>tidy evaluation</code>, tied to older versions of <code>rlang</code>, <code>dplyr</code>, and <code>ggplot2</code>. This choice is forced by the fact that the Power BI service uses an older version of the R engine (3.4.4) with older versions of the previous packages.</p>
<p>Starting with versions 4.0 of <code>rlang</code>, 3.0.0 of <code>ggplot2</code>, and 1.0.0 of <code>dplyr</code>, the syntaxes used for <code>tidy evaluation</code> have been simplified and standardized. You can find an example of the same function that draws a circular barplot translated for the new versions of the previous packages in the <code>02-circular-grouped-barplot-new-tidy-eval.R</code> file.</p>
</blockquote>
<p>Let’s see now how to implement the circular barplot in Power BI.</p>
</section>
<section id="implementing-a-circular-barplot-in-power-bi" class="level2" data-number="16.4">
<h2 data-number="16.4">Implementing a circular barplot in Power BI</h2>
<p>As you have already seen in the previous chapters, Power BI is capable of rendering graphs developed with <code>ggplot2</code> using R visuals. Therefore, whatever the complexity of the graph created using <code>ggplot2</code>, you can be sure that Power BI handles it well.</p>
<p>To create a circular barplot in Power BI, proceed as follows:</p>
<ol>
<li>Make sure that Power BI Desktop is referencing the version of CRAN R dedicated to R visuals in <strong>Options</strong>.</li>
<li>Click on <strong>Get Data</strong>,  <strong>Text/CSV</strong>, and then  <strong>Connect</strong>.</li>
<li>Select the <code>Scores.csv</code> file found in the <code>Chapter15</code> folder and click <strong>Open</strong>.</li>
<li>You will see a preview of the CSV file. Make sure to select <code>65001: Unicode (UTF-8) </code>as <strong>File Origin</strong>. This way, special characters in speaker names will be displayed correctly. Then, click on <strong>Load</strong>.</li>
<li>Click on the <strong>R Visual</strong> icon in the <strong>Visualizations</strong> panel, enable it, and then resize the visual as all the available canvas.</li>
<li>Keeping the R visual selected, expand the <code>Scores</code> table under the <strong>Fields</strong> panel and check all its fields.</li>
<li>Click on the R visual’s <strong>Format</strong> tab and switch off <strong>Title</strong>.</li>
<li>Copy the code of the <code>01-circular-grouped-barplot.R</code> file into the <code>Chapter15</code> folder and paste it into the R visual script editor. Then, click on the <strong>Run script</strong> arrow icon in the top right of the R script editor (enable the R visual every time it’s requested). You’ll get the circular barplot into it.</li>
<li>Click on an empty spot in the report canvas first and then click on the slicer visual icon. Then, expand the <code>Scores</code> table under the <strong>Fields</strong> panel and check the <code>Characteristic</code> measure.</li>
<li>Click on the downward-pointing arrow at the top right of the slicer to select the <strong>Dropdown</strong> slicer type.</li>
<li>Resize the bottom and right edges of the slicer, move it to the center of the circular barplot, click on its <strong>Format</strong> options, and switch on <strong>Show Select All option</strong> under <strong>Selection controls</strong>.</li>
</ol>
<p>You can now filter multiple characteristics (using the <em>Ctrl</em> key) and the circular barplot will update accordingly:</p>
<figure>
<img src="../media/file397.png" alt="Figure 15.8 – The circular barplot filtered by a slicer in Power BI" /><figcaption aria-hidden="true">Figure 15.8 – The circular barplot filtered by a slicer in Power BI</figcaption>
</figure>
<p>Very impressive, huh? By practicing a little bit with <code>ggplot2</code> and R, you can get as many impressive charts as you want to enrich your analysis.</p>
</section>
<section id="summary-14" class="level2" data-number="16.5">
<h2 data-number="16.5">Summary</h2>
<p>In this chapter, you learned how to implement a circular barplot using R and <code>ggplot2</code>. You also had your first experience with <code>tidy evaluation</code> in refactoring the code that implements the circular barplot into a function.</p>
<p>After that, you implemented a circular barplot in Power BI.</p>
<p>In the next chapter, you'll learn how to develop interactive custom visuals in R and Power BI.</p>
</section>
<section id="references-11" class="level2" data-number="16.6">
<h2 data-number="16.6">References</h2>
<p>For additional reading, check out the following books and articles:</p>
<ol>
<li><em>Who Sells More Weapons?</em> (<a href="https://www.data-to-viz.com/story/OneNumOneCat.html">https://www.data-to-viz.com/story/OneNumOneCat.html</a>)</li>
<li><em>Circular barplot with groups</em> (<a href="https://www.r-graph-gallery.com/297-circular-barplot-with-groups.html">https://www.r-graph-gallery.com/297-circular-barplot-with-groups.html</a>)</li>
<li><em>Down the rabbit hole with tidy eval — Part 1 (the old tidy eval way)</em> (<a href="https://colinfay.me/tidyeval-1/)">https://colinfay.me/tidyeval-1/)</a></li>
<li><em>Tidy evaluation (the new tidy eval way)</em> (<a href="https://tidyeval.tidyverse.org/)">https://tidyeval.tidyverse.org/)</a></li>
</ol>
</section>
</section>
</body>
</html>
