<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="en-US">
<head>
<meta charset="utf-8"/>
<meta name="generator" content="packt"/>
<title>16 Interactive R Custom Visuals</title>
<link rel="stylesheet" type="text/css" href="../styles/stylesheet1.css"/>
<link rel="stylesheet" type="text/css" href="../styles/stylesheet2.css"/>

</head>
<body>

<section id="interactive-r-custom-visuals" class="level1 pkt" data-number="17">
<h1 data-number="17">16 Interactive R Custom Visuals</h1>
<p>In <em>Chapter 15, Advanced Visualizations</em>, you saw that it is possible to make very complex graphs thanks to the flexibility introduced by <strong>ggplot</strong>. Sometimes, however, you have the feeling that you can't take full advantage of the information shown in the graph because of a lack interactivity, such as tooltips. In this chapter, you'll learn how to introduce interactivity into custom graphics created using R and by directly using <em>HTML widgets</em>. Here are the topics we will cover:</p>
<ul>
<li>Why interactive R custom visuals?</li>
<li>Adding a dash of interactivity with Plotly</li>
<li>Exploiting the interactivity provided by HTML widgets</li>
<li>Packaging all into a Power BI custom visual</li>
<li>Importing the custom visual package in Power BI</li>
</ul>
<section id="technical-requirements-15" class="level2" data-number="17.1">
<h2 data-number="17.1">Technical requirements</h2>
<p>This chapter requires you to have a working internet connection and <strong>Power BI Desktop</strong> installed on your machine. You must have properly configured the R and Python engines and IDEs as outlined in <em>Chapter 2, Configuring R with Power BI</em>, and <em>Chapter 3, Configuring Python with Power BI</em>.</p>
</section>
<section id="why-interactive-r-custom-visuals" class="level2" data-number="17.2">
<h2 data-number="17.2">Why interactive R custom visuals?</h2>
<p>Let's start with a graph you've already implemented in R. Consider, for example, the raincloud plot of <code>Fare</code> vs <code>Pclass</code> variables introduced in <em>Chapter 14, Exploratory Data Analysis</em>:</p>
<figure>
<img src="../media/file398.png" alt="Figure 16.1 – Raincloud plot for Fare (transformed) and Pclass variables" /><figcaption aria-hidden="true">Figure 16.1 – Raincloud plot for Fare (transformed) and Pclass variables</figcaption>
</figure>
<p>Focus for a moment only on the boxplots you see in <em>Figure 16.1</em>. Although the <code>Fare</code> variable is already transformed according to Yeo-Johnson to try to reduce skewness, there remain some extreme outliers for each of the passenger classes described by the categorical variable, <code>Pclass</code>. If, for example, you want to know the values of the transformed variable <code>Fare</code> corresponding to the whiskers (fences) of the boxplot on the left so that you can then determine the outliers located beyond those whiskers, it would be convenient that these values appear when you pass the mouse near that boxplot, as in <em>Figure 16.2</em>:</p>
<figure>
<img src="../media/file399.png" alt="Figure 16.2 – Main labels shown in the Fare (transformed) boxplot for the first class" /><figcaption aria-hidden="true">Figure 16.2 – Main labels shown in the Fare (transformed) boxplot for the first class</figcaption>
</figure>
<p>It would be even more interesting to know the actual value of a specific isolated outlier when you hover the mouse over the point representing it, as in <em>Figure 16.3</em>:</p>
<figure>
<img src="../media/file400.png" alt="Figure 16.3 – Values of Fare (transformed) and Pclass for the highlighted outlier" /><figcaption aria-hidden="true">Figure 16.3 – Values of Fare (transformed) and Pclass for the highlighted outlier</figcaption>
</figure>
<p>There is no doubt that these interactivities would be welcomed by the analyst reading the charts if they were introduced.</p>
<p>So, let's see how to add these interactivities to an existing graphic developed using ggplot.</p>
</section>
<section id="adding-a-dash-of-interactivity-with-plotly" class="level2" data-number="17.3">
<h2 data-number="17.3">Adding a dash of interactivity with Plotly</h2>
<p>There is an open source JavaScript library for data visualization, which is declarative and high-level and allows you to create dozens of types of interactive graphs, named <strong>Plotly.js</strong>. This library is the core of other Plotly client libraries, developed for Python, Scala, R, and ggplot. In particular, the library developed for R, named <strong>Plotly.R</strong> (<a href="https://github.com/ropensci/plotly">https://github.com/ropensci/plotly</a>), provides the <code>ggplotly()</code> function, which does all the magic for us: it detects all the basic attributes contained in an existing graph developed with ggplot and transforms them into an interactive web visualization. Let's see an example.</p>
<p>First, you need to install the Plotly.R library (<a href="https://github.com/ropensci/plotly">https://github.com/ropensci/plotly</a>) on your latest CRAN R engine via the <code>install.packages('plotly')</code> script.</p>
<blockquote>
<p><strong>Important Note</strong></p>
<p>For simplicity, we'll make sure to run the custom visual on the latest version of the CRAN R engine, since all the necessary libraries were already installed in the previous chapters. If the goal is to publish a report with the custom visual on Power BI, you have to make sure that the custom visual is correctly rendered on the same R engine present on Power BI (in our case, CRAN R 3.4.4).</p>
</blockquote>
<p>Then run the script you can find in the <code>01-interactive-boxplots.R</code> file in the <code>Chapter16</code> folder. The content of the script is extrapolated from the various scripts used in <em>Chapter 14, Exploratory Data Analysis</em>, so there’s nothing new to you. The only portion of the script you haven't seen before is the following:</p>
<pre><code>plotly::ggplotly(rc, tooltip = c(&#39;x&#39;, &#39;y&#39;))</code></pre>
<p>It is the part of code that transforms a static graph into a dynamic HTML-based one, and as you can see, it's one simple call to the <code>ggplotly()</code> function. The result is as follows:</p>
<figure>
<img src="../media/file401.png" alt="Figure 16.4 – Result of applying the ggplotly() function to the raincloud plot" /><figcaption aria-hidden="true">Figure 16.4 – Result of applying the ggplotly() function to the raincloud plot</figcaption>
</figure>
<p>As you can see, in RStudio the result is no longer shown in the <strong>Plots</strong> tab, but in the <strong>Viewer</strong> tab, dedicated to HTML output. You will also notice the presence of the <strong>Modebar</strong> in the top-right corner, which allows you to set some operations on the chart, such as zoom and hover options.</p>
<p>But the most striking thing is that you no longer see a series of raincloud plots, as you expected, but simple boxplots! If you look at the RStudio console, you will notice that there are three identical warning messages, one for each raincloud plot that should have been represented:</p>
<pre><code>In geom2trace.default(dots[[1L]][[3L]], dots[[2L]][[1L]], dots[[3L]][[1L]]) :
  geom_GeomSlabinterval() has yet to be implemented in plotly.
  If you&#39;d like to see this geom implemented,
  Please open an issue with your example code at
  https://github.com/ropensci/plotly/issues</code></pre>
<p>You may have noticed that only the density plots have disappeared. This means that in the current version of Plotly (4.9.4.1), the objects created by the <code>ggdist</code> library are not yet managed. Moreover, <code>ggplotly()</code> renders fill and color aesthetics as distinct, as opposed to <code>ggplot</code> static graphs. Surely this functionality still needs to be improved and, most likely, these bugs will be handled in future versions. In any case, the graph is still usable and shows how easy it is to add interactivity to a ggplot graph.</p>
<p>At this point, you would think that any chart made in HTML and JavaScript could then be used in Power BI. Obviously, this is not the case.</p>
<blockquote>
<p><strong>Important Note</strong></p>
<p>Every interactive graphic that can be used in Power BI must be an <em>HTML widget</em>.</p>
</blockquote>
<p>In fact, Plotly.R exposes graphs via HTML widgets. Let's see what this is all about.</p>
</section>
<section id="exploiting-the-interactivity-provided-by-html-widgets" class="level2" data-number="17.4">
<h2 data-number="17.4">Exploiting the interactivity provided by HTML widgets</h2>
<p><strong>HTML widgets</strong> are R packages that allow you to build interactive web pages. These packages are generated by a framework used to create a binding between R and JavaScript libraries. This framework is made available by the <code>htmlwidgets</code> package developed by RStudio. HTML widgets are always hosted within an R package, including the source code and dependencies, in order to make sure that the widgets are fully reproducible even without being able to access the internet. For more details on how to develop an HTML widget from scratch, take a look at the references.</p>
<p>In addition to being able to embed HTML widgets in <strong>RMarkdown</strong> files (dynamic documents with R) or <strong>Shiny</strong> applications (interactive web apps built directly from R), the <code>htmlwidgets</code> package allows you to save them also in standalone web page files thanks to the <code>saveWidget()</code> function.</p>
<p>That said, there are hundreds of R packages that expose their functionalities in HTML widgets. You can explore the <strong>htmlwidgets gallery</strong> (<a href="http://gallery.htmlwidgets.org/">http://gallery.htmlwidgets.org/</a>) to search for interactive graphics that may be appropriate for you.</p>
<p>Okay, it is possible to visualize these HTML widgets, both those in the gallery and those made through Plotly, in Power BI. That sounds good. But how do you embed a dynamic graph made in HTML and JavaScript into Power BI? You must compile an R-powered visual via the <em>pbiviz tools</em>.</p>
<p>Let's see how it's done.</p>
</section>
<section id="packaging-it-all-into-a-power-bi-custom-visual" class="level2" data-number="17.5">
<h2 data-number="17.5">Packaging it all into a Power BI Custom Visual</h2>
<p><strong>Power BI Visual Tools</strong> (<strong>pbiviz</strong>) are the easiest way to build custom visuals in Power BI. They are written in <strong>JavaScript</strong> (using <strong>Node.js</strong>) and are used to compile the source code of <strong>.pbiviz packages</strong>. A .pbiviz package is a zipped version of the <strong>Power BI Visual Project</strong>, which in turn is a set of folders, scripts, and assets needed to create the custom visualization you want to implement. Generally, a standard Power BI Visual Project is created from a template thanks to the pbiviz command-line tools. The template contents depend on the method by which you want to create the custom visual (<strong>TypeScript</strong>, <strong>R Visual</strong>, or <strong>R HTML</strong>).</p>
<blockquote>
<p><strong>Important Note</strong></p>
<p>The pbiviz tools do not support any technology that uses Python behind the scenes, such as the <em>ipywidget widgets</em>.</p>
</blockquote>
<p>In the light of this, it is worth learning R and ggplot a little more in order to be able to develop interesting custom visuals using the R Visual and R HTML modes. In addition to this, as mentioned at the end of <em>Chapter 2, Configuring R With Power BI</em>, take the following note into account.</p>
<blockquote>
<p><strong>Important Note</strong></p>
<p>The <em>Publish to web</em> option in Power BI does not allow you to publish reports that contain standard R Visuals. You can work around this limitation by creating R custom visuals, which are allowed to be published with this option.</p>
</blockquote>
<p>Now let's see how to install the pbiviz tools.</p>
<section id="installing-the-pbiviz-package" class="level3" data-number="17.5.1">
<h3 data-number="17.5.1">Installing the pbiviz package</h3>
<p>pbiviz command-line tools provide everything you need to develop visuals and test them in reports and dashboards on Power BI service. For this very last reason, you need to install an SSL certificate too, so that your laptop can interact securely with the Power BI service.</p>
<p>Let's see how to do everything step by step:</p>
<ol>
<li>Go to <a href="https://nodejs.org/en/">https://nodejs.org/en/</a> and install the Node.js version recommended for all users, following the default options set by the installer.</li>
<li>Restart your laptop, as this is mandatory for the <em>Step 4</em> command to work.</li>
<li>Click on the Windows <strong>Start</strong> button and start entering the string <code>“power”</code>, then click on the <strong>Windows PowerShell</strong> app.</li>
<li>Enter the following command in the PowerShell console: <code>npm i -g powerbi-visuals-tools</code>. If you get some deprecation warnings, don’t worry and wait for the installation to complete.</li>
<li>Enter the following command in the PowerShell console: <code>pbiviz --install-cert</code>. It returns a location in which the PFX file is created (it should be <code>C:\Users\&lt;your-username&gt;\AppData\Roaming\npm\node_modules\powerbi-visuals-tools\certs</code>) and a numeric passphrase. Take note of both as you’ll need them later.</li>
<li>Press <strong>Win</strong>+<strong>R</strong> and enter <code>mmc</code> in the <strong>Open</strong> textbox. It will open the <strong>Microsoft Management Console</strong>.</li>
<li>Click on <strong>File</strong>, then click on <strong>Add/Remove Snap-in…</strong>.</li>
<li>Select <strong>Certificates</strong> and click on <strong>Add</strong>, then select <strong>My user account</strong> and click <strong>Finish</strong>.</li>
<li>Press <strong>OK</strong> on the <strong>Add or Remove Snap-in</strong> window.</li>
<li>In the main window, expand the <strong>Certificates</strong> node and the <strong>Trusted Root Certification Authorities</strong> one, select <strong>Certificates</strong> under this node. You’ll see all the certificates listed in the middle panel. On the <strong>Action</strong> panel on the right, click on <strong>More Actions</strong>, select <strong>All Tasks…</strong> and the click on <strong>Import…</strong>.</li>
<li>Click <strong>Next</strong> on the <strong>Certificate Import Wizard</strong> welcome window. Click <strong>Browse</strong> on the next window and navigate to the location you noted in <em>Step 5</em>. Select <strong>Personal Information Exchange (*.pfx, *.p12)</strong> from the file type combobox near the <strong>File name</strong> textbox. Then the <code>PowerBICustomVisualTest_public.pfx</code> file will appear. Select it and click <strong>Open</strong>. Then click <strong>Next</strong>.</li>
<li>Enter the numeric password you noted in <em>Step 5</em>, keep the default <strong>Import options</strong> and click on <strong>Next</strong>.</li>
<li>Keep <strong>Trusted Root Certification Authorities</strong> as <strong>Certificate store</strong>, click <strong>OK</strong>. Click <strong>Next</strong> on the main window, then click <strong>Finish</strong>. You’ll get a <strong>Security Warning</strong> window asking if you want to install the certificate. Click <strong>Yes</strong> and a <strong>The import was successful</strong> dialog box will appear. Click <strong>OK</strong>.</li>
<li>In order to verify that everything went well, go back to the PowerShell console, enter the <code>pbiviz</code> command and press <em>Enter</em>. You should see the following output:</li>
</ol>
<figure>
<img src="../media/file402.png" alt="Figure 16.5 – pbiviz is installed correctly" /><figcaption aria-hidden="true">Figure 16.5 – pbiviz is installed correctly</figcaption>
</figure>
<p>Great! Now you have your pbiviz tools properly configured and ready to compile a custom visual.</p>
<p>Let's put them to the test right now with an R HTML custom visual.</p>
</section>
<section id="developing-your-first-r-html-custom-visual" class="level3" data-number="17.5.2">
<h3 data-number="17.5.2">Developing your first R HTML custom visual</h3>
<p>In order to create an R HTML custom visual, you must first generate a standard Power BI Visual Project of R HTML type starting from the template provided by pbiviz tools. Then it is sufficient to modify the scripts provided by the project in order to create the visual you want to develop.</p>
<p>In this section, you will package the dynamic boxplots graph that you met in a previous section.</p>
<p>Here are the steps to obtain the <code>.pbiviz</code> package:</p>
<ol>
<li>Open the <strong>Windows PowerShell</strong> console from the <strong>Start</strong> menu if you have closed it since the last use. The folder in which the console will start by default is <code>C:\Usersers\&lt;your-username&gt;</code>.</li>
<li>Create a folder dedicated to custom visuals called <code>Power-BI-Custom-Visuals</code> using the <code>md Power-BI-Custom-Visuals</code> command.</li>
<li>Move into the folder you just created using the <code>cd Power-BI-Custom-Visuals</code> command.</li>
<li>Generate a standard R HTML Power BI Visual project from the template by using the <code>pbiviz new interactiveboxplots -t rhtml</code> command.</li>
<li><p>Open the template folder you just created in VS Code. You will see something like this:</p>
<figure>
<img src="../media/file403.png" alt="Figure 16.6 – View of the content of the interactiveboxplots folder in VS Code" /><figcaption aria-hidden="true">Figure 16.6 – View of the content of the interactiveboxplots folder in VS Code</figcaption>
</figure>
<p>You will find a complete project ready to be compiled in the <code>Chapter16\PBI-Visual-Project\interactiveboxplots</code> folder in the GitHub repository. You can use it as a reference for the next steps.</p></li>
<li><p>Open the <code>pbiviz.json</code> file of your just-created template to enter the basic information about the custom visual you are going to compile. Format it properly (right-click on the document and click on <strong>Format Document</strong>). In <em>Figure 16.7</em> and in the following figures you find on the left a part of the template code, and on the right, how it should be modified:</p>
<figure>
<img src="../media/file404.png" alt="Figure 16.7 – Editing of the pbiviz.json file content in VS Code" /><figcaption aria-hidden="true">Figure 16.7 – Editing of the pbiviz.json file content in VS Code</figcaption>
</figure>
<p>Here are the details of attributes to edit for the <code>"visual"</code> node:</p>
<ul>
<li><code>"name"</code>: &lt;name-of-your-custom-visual&gt;</li>
<li><code>"displayName"</code>: &lt;name-to-display-of-your-visual&gt;</li>
<li><code>"description"</code>: &lt;description-of-your-custom-visual&gt;</li>
<li><code>"supportUrl"</code>: &lt;url-to-be-contacted-for-support&gt;</li>
</ul>
<p>Here are the details of attributes to edit for the <code>"author"</code> node:</p>
<ul>
<li><code>"name"</code>: &lt;full-name-of-the-author&gt;</li>
<li><code>"email"</code>: &lt; email-of-the-author &gt;</li>
</ul></li>
<li><p>Now open the <code>capabilities.json</code> file. It is used to declare what data types the visualization accepts, what customizable attributes to put in the properties panel, and other information needed to create the visualization. It contains several root objects. The first one whose contents you need to edit is <code>dataRoles</code> (<a href="https://bit.ly/pbiviz-dataroles">https://bit.ly/pbiviz-dataroles</a>). In this section, you can define the data fields that your visual expects. The default template has just the unique <code>Values</code> field as default, like the standard R Visual. In our case, the multivariate boxplot visual needs three fields:</p>
<figure>
<img src="../media/file405.png" alt="Figure 16.8 – Editing the dataRoles section of the capabilities.json file" /><figcaption aria-hidden="true">Figure 16.8 – Editing the dataRoles section of the capabilities.json file</figcaption>
</figure></li>
<li><p>Based on the items added in the <code>dataRoles</code>, you have to change the <code>capabilities.json</code> file’s <code>dataViewMappings</code> root object content accordingly (<a href="https://bit.ly/pbiviz-dataviewmappings">https://bit.ly/pbiviz-dataviewmappings</a>). They describe how data roles relate to each other and allow you to specify conditional requirements for data visualization. In our case, we need to declare the three fields created in the <code>dataRoles</code> as components of the script's input dataset:</p>
<figure>
<img src="../media/file406.png" alt="Figure 16.9 – Editing the dataViewMappings section of the capabilities.json file" /><figcaption aria-hidden="true">Figure 16.9 – Editing the dataViewMappings section of the capabilities.json file</figcaption>
</figure>
<p>As you can see, the <code>“script”</code> subsection the template refers to the <code>rcv_script</code> object. We will see that it is defined in the next section.</p></li>
<li><p>The <code>capabilities.json</code> file’s <code>objects</code> section describes the customizable properties that are associated with the visual and that appear in the <strong>Format</strong> pane (<a href="https://bit.ly/pbiviz-objects">https://bit.ly/pbiviz-objects</a>). In our case, we want to parameterize the type of transformation we can apply to the variable y. Therefore, we will make sure that the user can select the transformation type from the <strong>Y Transformation Type</strong> combobox present in the <strong>Variables Settings</strong> section just below the <strong>General</strong> section:</p>
<figure>
<img src="../media/file407.png" alt="Figure 16.10 – Custom parameters into the Format panel" /><figcaption aria-hidden="true">Figure 16.10 – Custom parameters into the Format panel</figcaption>
</figure>
<p>The changes to the script needed to achieve what you see in <em>Figure 16.10</em> is as follows:</p>
<figure>
<img src="../media/file408.png" alt="Figure 16.11 – Editing the objects section of the capabilities.json file" /><figcaption aria-hidden="true">Figure 16.11 – Editing the objects section of the capabilities.json file</figcaption>
</figure>
<p>The <code>suppressDefaultTitle</code> parameter allows you to suppress the title that generally appears at the top left of each R Visual. As you can see in <em>Figure 16.11</em>, the <code>rcv_script</code> object referenced in the <code>dataViewMappings</code> section is defined in this section. Contrary to the one you just added, the <code>rcv_script</code> object is not to be displayed in the <strong>Format</strong> pane, but is only used to describe the attributes of the <code>source</code> and <code>provider</code> objects that define the R script. In order to actually declare what parameters are to be displayed in the <strong>Format</strong> pane, you need to make a small change to the <code>settings.ts</code> file. Let's see how.</p></li>
<li><p>Open the <code>settings.ts</code> file found in the <code>src</code> folder of your Power BI Visual project. It contains the settings in TypeScript for the elements to be displayed in your visual. Instead of displaying the <code>rcv_script</code> object, we can display the <code>settings_variables_params</code> object that contains our parameter associated with the type of transformation to be applied to the y variable:</p>
<figure>
<img src="../media/file409.png" alt="Figure 16.12 – Editing the settings.ts file" /><figcaption aria-hidden="true">Figure 16.12 – Editing the settings.ts file</figcaption>
</figure>
<p>For further details about the classes used in this script, take a look at the references.</p></li>
<li>Open the <code>dependencies.json</code> file. It contains a reference to each library used in the R code that generates the visual. In addition to the ones already present (<code>ggplot2</code>, <code>plotly</code>, <code>htmlwidgets</code>, and <code>xml2</code>), you also need to add the following: <code>RColorBrewer</code>, <code>cowplot</code>, <code>dplyr</code>, <code>purrr</code>, <code>forcats</code>, and <code>recipes</code>. Just follow the syntax already used for the existing libraries, keeping in mind that you can put any string in <code>displayName</code>.</li>
<li><p>Finally, you can enter the R code that generates the visual in the <code>script.r</code> file. You can replace its entire content with that of the file of the same name that you find within the Power BI Visual project shared in the GitHub repository.At the beginning of the script, you will find some commented rows used to debug any issues in RStudio. Then there is a <code>source()</code> command that will load the utility functions from the provided <code>flatten_HTML.r</code> file in the <code>r_files</code> folder. They help to convert Plotly or widget objects to self-contained HTML. The next code is very similar to what you've already seen in the previous sections. There are integrated pieces of code to handle the presence of the fields passed to the visual as input data and the parameter that handles the type of transformation of the variable y. Here’s an example:</p>
<pre><code>y_transf_name &lt;- &#39;standard&#39;
if(exists(&quot;settings_variable_params_y_transf_name&quot;)){
  y_transf_name &lt;- as.character(settings_variable_params_y_transf_name)
}</code></pre>
<p>The <code>settings_variable_params_y_transf_name</code> variable name is given by the union of the name of the section containing the parameter and the name of the parameter itself.Finally, there are two pieces of code at the end of the script. One is used to remove some of the icons in the Plotly Modebar:</p>
<pre><code>disabledButtonsList &lt;- list(
    &#39;toImage&#39;, &#39;sendDataToCloud&#39;, &#39;zoom2d&#39;, &#39;pan&#39;,
    &#39;pan2d&#39;, &#39;select2d&#39;, &#39;lasso2d&#39;,
    &#39;hoverClosestCartesian&#39;, &#39;hoverCompareCartesian&#39;)
p$x$config$modeBarButtonsToRemove = disabledButtonsList
p &lt;- config(p, staticPlot = FALSE, editable = FALSE, sendData = FALSE, showLink = FALSE, displaylogo = FALSE,  collaborate = FALSE, cloud=FALSE)</code></pre>
<p>The other is a workaround for a Plotly bug that displays the outliers of a boxplot despite passing the <code>outlier.shape = NA</code> parameter to <code>geom_boxplot()</code>:</p>
<pre><code>hideOutliers &lt;- function(x) {  
  if (x$hoverinfo == &#39;y&#39;) {  
    x$marker = list(opacity = 0)
    x$hoverinfo = NA    
  }  
  return(x)  
}
p[[&quot;x&quot;]][[&quot;data&quot;]] &lt;- purrr::map(p[[&quot;x&quot;]][[&quot;data&quot;]], ~ hideOutliers(.))</code></pre>
<p>Finally, the <code>internalSaveWidget(p, 'out.html')</code> command uses one of the utility functions loaded at the beginning of the script to generate the flattened visual in a self-contained HTML with the standard name <code>out.html</code> properly managed by Power BI.The latest command invokes the <code>ReadFullFileReplaceString()</code> function. It allows you to replace strings inside the <code>out.html</code> file generated by the code in order to modify the default configurations generated by Plotly. Specifically, the command used here corrects a setting on the padding of the generated HTML widget.</p></li>
<li>Now go back to the Windows PowerShell console and make sure you are in the <code>Power-BI-Custom-Visuals\interactiveboxplots</code> folder. If you were in the <code>Power-BI-Custom-Visuals</code> folder, just use the <code>cd interactiveboxplots</code> command. Then, enter the <code>pbiviz package</code> command to compile the <code>.pbiviz</code> package containing your custom visual. At the end of the compiling operations of pbiviz tools, you will see something like this:</li>
</ol>
<figure>
<img src="../media/file410.png" alt="Figure 16.13 – Successful compiling of the custom visual" /><figcaption aria-hidden="true">Figure 16.13 – Successful compiling of the custom visual</figcaption>
</figure>
<p>Very nice job! You compiled your very first R HTML custom visual using the pbiviz tools. Okay, but where is the compiled package? Don't worry, look inside the <code>dist</code> folder of your Power BI Visual Project:</p>
<figure>
<img src="../media/file411.png" alt="Figure 16.14 – Your .pbiviz package just compiled" /><figcaption aria-hidden="true">Figure 16.14 – Your .pbiviz package just compiled</figcaption>
</figure>
<p>There it is! Let's now import it into Power BI.</p>
</section>
</section>
<section id="importing-the-custom-visual-package-into-power-bi" class="level2" data-number="17.6">
<h2 data-number="17.6">Importing the custom visual package into Power BI</h2>
<p>Now that the bulk of the work is done, importing your custom visual into Power BI is a breeze. First of all, you need to install the <code>xml2</code> package in your R engine, as it is used by the provided utility functions:</p>
<ol>
<li>Open RStudio and make sure it is referencing your latest CRAN R (version 4.0.2 in our case).</li>
<li>Click on the <strong>Console</strong> window and enter this command: <code>install.packages('xml2')</code>. If you remember, this library is listed in the dependency file you saw in the previous section. Then, press <em>Enter</em>.</li>
</ol>
<p>Let's now import the custom visual in Power BI:</p>
<ol>
<li>Make sure that Power BI Desktop references the correct R engine (the latest one) in the <strong>Options</strong>.</li>
<li>Click on <strong>Get Data</strong>, search for <code>web</code>, select <strong>Web</strong>, and click on <strong>Connect</strong>.</li>
<li>Enter the following URL as source: <a href="http://bit.ly/titanic-dataset-csv">http://bit.ly/titanic-dataset-csv</a>. Then press <strong>OK</strong>.</li>
<li>Make sure that the <strong>File Origin</strong> is <strong>65001: Unicode (UTF-8)</strong> and press <strong>Load</strong>.</li>
<li><p>Click the ellipses under the <strong>Visuals</strong> pane, then click on <strong>Import a visual from a file</strong>:</p>
<figure>
<img src="../media/file412.png" alt="Figure 16.15 – Import a custom visual from file" /><figcaption aria-hidden="true">Figure 16.15 – Import a custom visual from file</figcaption>
</figure></li>
<li>In the next open windows, move to the following folder: <code>C:\Users\&lt;your-username&gt;\Power-BI-Custom-Visuals\interactiveboxplots\dist</code>. Then select your <code>.pbiviz</code> package and click on <strong>Open</strong>. Click <strong>OK</strong> on the next dialog box.</li>
<li><p>As you can see, a new icon has appeared on the <strong>Visuals</strong> pane:</p>
<figure>
<img src="../media/file413.png" alt="Figure 16.16 – Import a custom visual from file" /><figcaption aria-hidden="true">Figure 16.16 – Import a custom visual from file</figcaption>
</figure>
<p>Keep in mind that if you want to use a custom icon for your visual, just replace it with the <code>icon.png</code> file you find in the <code>assets</code> folder of your Power BI Visual Project before compiling.Click on it to add your custom visual to your report canvas. Then click on <strong>Enable</strong> on the next dialog window.</p></li>
<li><p>Enlarge your custom visual area, then expand the <strong>titanic-dataset-csv</strong> table on the <strong>Fields</strong> pane and check first the <strong>Pclass</strong> field, then the <strong>Fare</strong> field:</p>
<figure>
<img src="../media/file414.png" alt="Figure 16.17 – Select the Pclass and Fare fields as X and Y variables" /><figcaption aria-hidden="true">Figure 16.17 – Select the Pclass and Fare fields as X and Y variables</figcaption>
</figure>
<p>Take a look at your custom visual. You will see something like this:</p>
<figure>
<img src="../media/file415.png" alt="Figure 16.18 – Your custom visual showing boxplots for Fare vs Pclass" /><figcaption aria-hidden="true">Figure 16.18 – Your custom visual showing boxplots for Fare vs Pclass</figcaption>
</figure></li>
<li><p>Now click on the <strong>Format</strong> icon of the visual, expand the <strong>Variables Settings</strong> section, and select <strong>Yeo-Johnson</strong> for <strong>Y Transformation Type</strong>:</p>
<figure>
<img src="../media/file416.png" alt="Figure 16.19 – Select Yeo-Johnson for Y Transformation Type" /><figcaption aria-hidden="true">Figure 16.19 – Select Yeo-Johnson for Y Transformation Type</figcaption>
</figure>
<p>Take now a look at your custom visual. You will see something like this:</p>
<figure>
<img src="../media/file417.png" alt="Figure 16.20 – Your custom visual showing boxplots for Fare (transformed) vs Pclass" /><figcaption aria-hidden="true">Figure 16.20 – Your custom visual showing boxplots for Fare (transformed) vs Pclass</figcaption>
</figure></li>
<li>Now go back to the <strong>titanic-dataset-csv</strong> table on the <strong>Fields</strong> pane, check the <strong>Sex</strong> field (it will be associated to the visual’s <strong>Grouping Variable</strong>), and take a look at the visual again. It will be like the following:</li>
</ol>
<figure>
<img src="../media/file418.png" alt="Figure 16.20 – Your custom visual showing boxplots for Fare (transformed) vs Pclass grouped by Sex" /><figcaption aria-hidden="true">Figure 16.20 – Your custom visual showing boxplots for Fare (transformed) vs Pclass grouped by Sex</figcaption>
</figure>
<p>Really impressive! Your custom interactive visual is awesome and works great!</p>
</section>
<section id="summary-15" class="level2" data-number="17.7">
<h2 data-number="17.7">Summary</h2>
<p>In this chapter, we learned the advantages of using an interactive visual in comparison to a static visual in some cases. We learned how to add some basic interactivity to charts developed with Ggplot via Plotly.</p>
<p>We learned that the key to making interactive visuals on Power BI is that they are based on HTML widgets. We have been therefore guided step by step in the realization of a custom visual compiled through the pbiviz tools.</p>
<p>Finally, we imported the compiled package into Power BI to test its functionality. With this, we’ve come to the end of the book. I hope this journey was fruitful and rewarding!</p>
</section>
<section id="references-12" class="level2" data-number="17.8">
<h2 data-number="17.8">References</h2>
<p>For additional reading, check out the following books and articles:</p>
<ol>
<li><em>Plotly R Open Source Graphing Library</em> (<a href="https://plotly.com/r/">https://plotly.com/r/</a>)</li>
<li><em>[Course] R: Interactive Visualizations with htmlwidgets</em> (<a href="https://www.linkedin.com/learning/r-interactive-visualizations-with-htmlwidgets/welcome">https://www.linkedin.com/learning/r-interactive-visualizations-with-htmlwidgets/welcome</a>)</li>
<li><em>Creating a widget</em> (<a href="http://www.htmlwidgets.org/develop_intro.html">http://www.htmlwidgets.org/develop_intro.html</a>)</li>
<li><em>Power BI Visual Project Structure</em> (<a href="https://docs.microsoft.com/en-us/power-bi/developer/visuals/visual-project-structure">https://docs.microsoft.com/en-us/power-bi/developer/visuals/visual-project-structure</a>)</li>
<li><em>Schema used in the pbiviz.json file</em> (<a href="https://github.com/microsoft/PowerBI-visuals-tools/blob/main/templates/visuals/.api/v1.13.0/schema.pbiviz.json">https://github.com/microsoft/PowerBI-visuals-tools/blob/main/templates/visuals/.api/v1.13.0/schema.pbiviz.json</a>)</li>
<li><em>Schema used in the capabilities.json file</em> (<a href="https://github.com/microsoft/PowerBI-visuals-tools/blob/main/templates/visuals/.api/v1.13.0/schema.capabilities.json">https://github.com/microsoft/PowerBI-visuals-tools/blob/main/templates/visuals/.api/v1.13.0/schema.capabilities.json</a>)</li>
<li><em>Power BI Custom Visual Part 5 – Formatting</em> (<a href="https://shetland.azurewebsites.net/2021/02/18/power-bi-custom-visual-part-5-formatting/">https://shetland.azurewebsites.net/2021/02/18/power-bi-custom-visual-part-5-formatting/</a>)</li>
</ol>
</section>
</section>
</body>
</html>
