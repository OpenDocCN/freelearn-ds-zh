# 第二章 查看空间数据

在本章中，我们将介绍如何从不同的数据源查看空间数据。QGIS支持许多文件和数据库格式以及OGC网络服务。我们将首先了解如何从这些不同的数据源加载图层。然后我们将探讨矢量图层和栅格图层的基本样式，并创建我们的第一个地图，你可以在下面的屏幕截图中看到。我们将以从在线服务加载背景地图的示例结束本章。

![查看空间数据](img/7488_02_01.jpg)

### 注意

对于本章的示例，我们将使用由QGIS项目提供的样本数据，并可以从[download.osgeo.org/qgis/data/qgis_sample_data.zip](http://download.osgeo.org/qgis/data/qgis_sample_data.zip)（20 MB）下载。下载并解压它。

# 从文件加载矢量数据

在本节中，我们将讨论从GIS格式，如Shapefiles以及文本文件中加载矢量数据。

我们可以通过转到**图层** | **添加矢量图层**以及使用**添加矢量图层**工具栏按钮来加载矢量文件。如果你喜欢快捷方式，可以使用*Ctrl* + *Shift* + *V*。在**添加矢量图层**对话框中，我们找到一个下拉列表，允许我们指定输入文件的编码。如果我们处理包含特殊字符的文件，例如德语的重音符号或其他非默认拉丁字母表中的字母，此选项很重要。以下屏幕截图显示了**添加矢量图层**对话框：

![从文件加载矢量数据](img/7488_02_02.jpg)

我们现在最感兴趣的是**浏览**按钮，它打开文件打开对话框。注意对话框右下角的**文件类型过滤器**下拉列表。我们可以打开它，查看支持的矢量文件类型列表。此过滤器通过隐藏不同类型的所有文件，有助于更快地找到特定文件，但请注意，过滤器设置将被存储，并在我们下次打开对话框时再次应用。

如果我们后来试图找到不同的文件，而它恰好被过滤器隐藏，这可能会引起混淆，所以请记住，如果你在查找文件时遇到困难，要检查过滤器设置。

我们可以通过一次选择多个文件来一次性加载多个文件（在Windows/Ubuntu上按住*Ctrl*或在Mac上按住*Cmd*）。让我们试一试。

1.  我们从样本数据文件夹`vmap0_shapefiles`中选择`alaska.shp`和`airports.shp`。

1.  接下来，我们通过点击**打开**来确认我们的选择，然后我们返回到**添加矢量图层**对话框。

1.  再次点击**打开**后，选定的文件将被加载。你会注意到每个矢量层都显示为随机颜色。现在不用担心这个。我们将在本章后面处理图层样式。

    ### 小贴士

    有多种技巧可以使加载数据更快；例如，您可以直接从操作系统文件浏览器中将文件拖放到 QGIS 中。另一种快速访问您的空间数据的方法是使用 QGIS 内置的文件浏览器。如果您按照[第 1 章](ch01.html "第 1 章。QGIS 入门")中所示设置 QGIS，即“QGIS 入门”，您会发现浏览器位于左侧，位于图层列表下方。导航到您的数据文件夹，您可以从浏览器中将文件再次拖放到地图上。此外，您可以通过右键单击文件夹并选择**添加到收藏夹**来标记文件夹为收藏夹。这样，您的数据文件夹将更快地访问，因为它们被添加到浏览器列表顶部的**收藏夹**部分。

另一个流行的空间数据来源是分隔文本（CSV）文件。QGIS 可以通过**添加分隔文本图层**选项加载 CSV 文件，该选项可通过**图层**|**添加分隔文本图层**或相应的工具栏按钮访问。点击**浏览**并从示例数据中选择 `elevp.csv`。CSV 包含各种分隔符。如图所示，插件允许您从最常见的选择中选取（**逗号**、**制表符**等），但您也可以指定任何其他纯文本或正则表达式分隔符。如果您的 CSV 包含引号，如 " 或 '，您可以使用**引号**选项来移除它们。**要丢弃的标题行数**选项允许我们跳过文本文件开头的额外行。以下**字段选项**包括从字段值中删除额外空格或重新定义小数分隔符为逗号的功能。空间信息本身可以由包含点 X 和 Y 坐标的两列提供，或者使用**已知文本 (WKT)**格式。WKT 字段可以包含点、线或多边形。

### 小贴士

WKT 是一个非常有用且灵活的格式。例如，一条线可以通过编写 `LINESTRING (30 10, 10 30, 40 40)` 来指定。如果您不熟悉这个概念，您可以在 [en.wikipedia.org/wiki/Well-known_text](http://en.wikipedia.org/wiki/Well-known_text) 找到带有示例的介绍。

![从文件加载矢量数据](img/7488_02_03.jpg)

点击**确定**后，QGIS 将提示我们指定图层的**坐标参考系统**（**CRS**）。我们将在下一节讨论处理坐标参考系统。

# 处理坐标参考系统

每次我们加载数据源时，QGIS 都会寻找可用的 CRS 信息；例如，在 Shapefile 的 `.prj` 文件中。如果 QGIS 找不到任何可用的信息，它将默认提示您手动指定 CRS。此行为可以通过转到**设置**|**选项**|**CRS**来更改，始终使用项目 CRS 或默认 CRS。

QGIS坐标参考系统选择器提供了一个过滤器，使查找CRS变得更容易。它可以按名称或按ID（例如，EPSG代码）过滤。只需开始输入，看看潜在CRS列表是如何变短的。实际上有两个独立的列表：上面的列表包含我们最近使用的CRS，而下面的列表更长，包含所有可用的CRS。对于`elevp.csv`文件，我们选择**NAD27 / 阿拉斯加阿尔伯斯**。

如果我们想检查一个层的CRS，我们可以在层属性**常规**部分找到这个信息，可以通过转到**图层** | **属性**或通过在图层列表中双击图层名称来访问。如果您认为QGIS选择了错误的CRS或您在指定CRS时犯了错误，您可以使用**指定CRS**来纠正CRS设置。请注意，这不会更改底层数据或重新投影它。我们将在[第3章](ch03.html "第3章。数据创建和编辑")中讨论重新投影矢量和栅格文件，*数据创建和编辑*。

在QGIS中，即使每个数据集存储的CRS不同，我们也可以从多个图层创建地图。QGIS通过启用一个称为即时重投影的机制来自动处理必要的重投影，您可以通过转到**设置** | **项目属性**来访问它，如下面的截图所示：

所有图层都会即时重投影到项目CRS，这意味着QGIS会动态地计算这些重投影，并且只为渲染地图的目的。底层数据不会改变，空间分析也不会受到影响。

![处理坐标参考系统](img/7488_02_04.jpg)

在某些情况下，您可能需要指定QGIS坐标系数据库中不可用的CRS。您可以通过转到**设置** | **自定义坐标系**来添加CRS定义。点击**添加新CRS**按钮创建新条目，为新的CRS输入一个名称，并粘贴`proj4`定义字符串。完成操作后，只需点击**确定**关闭对话框。

# 加载栅格文件

加载栅格文件与加载矢量文件没有太大区别。选择**图层**菜单项，然后点击**添加栅格图层**，点击**添加栅格图层**按钮，或按*Ctrl* + *Shift* + *R*快捷键将直接带您到文件打开对话框。再次提醒，您可以通过检查文件类型过滤器来查看支持的文件类型列表。

让我们试一试，从样本数据`raster`文件夹中加载`landcover.img`。同样，就像矢量文件一样，您可以通过从操作系统或内置文件浏览器拖动它们到QGIS中来加载栅格文件。

### 注意

QGIS中所有这些不同类型的向量和栅格文件类型都由强大的GDAL/OGR包处理。您可以在[www.gdal.org/formats_list.html](http://www.gdal.org/formats_list.html)（栅格）和[www.gdal.org/ogr/ogr_formats.html](http://www.gdal.org/ogr/ogr_formats.html)（向量）查看支持的完整格式列表。

## 地理配准栅格地图

一些栅格数据源，如简单的扫描地图，缺乏适当的空间参考，我们必须在将它们用于GIS之前对其进行地理配准。在QGIS中，我们可以使用地理配准器GDAL插件来地理配准栅格，该插件可以通过转到**栅格** | **地理配准**访问（如果无法在**栅格**菜单中找到，请通过转到**插件** | **管理并安装插件**来启用它）。

地理配准器涵盖了以下用例：

+   我们可以为栅格文件创建一个世界文件，而不会改变原始栅格。

+   如果我们有一个包含已知坐标点的地图图像，我们可以设置**地面控制点**（**GCPs**）并输入已知坐标。

+   最后，如果我们不知道地图上任何点的坐标，我们仍然有机会使用同一区域的第二个已地理配准的地图手动放置GCPs。我们可以使用在两个地图中都可见的对象来选择我们想要地理配准的点，并从参考地图中确定它们的坐标。

通过转到**文件** | **打开栅格**或使用**打开栅格**工具栏按钮，将栅格加载到地理配准器中后，我们会要求指定我们计划添加的地面控制点的CRS。接下来，我们可以通过转到**编辑** | **添加点**来开始添加地面控制点。我们可以使用平移和缩放工具进行导航，并通过在地图上点击来放置GCPs。然后，我们会提示输入新点的坐标或从主QGIS窗口中的参考地图中选择它们。

放置GCPs后，我们可以通过转到**设置** | **变换设置**来定义变换算法。您选择哪种算法取决于您的输入数据和您想要允许的几何畸变程度。最常用的算法是多项式1到3。一阶多项式变换仅允许缩放、平移和旋转。

二阶多项式变换可以处理一些曲率，而三阶多项式变换则允许更高的畸变程度。薄板样条算法可以处理地图中的局部变形，因此在处理非常低质量的地图扫描时非常有用。另一方面，线性选项仅用于创建世界文件，如前所述，这实际上并不变换栅格。

重采样方法取决于您的输入数据和您想要实现的结果。立方重采样创建平滑的结果，但如果您不想更改栅格值，请选择最近邻方法。

在我们开始地理配准过程之前，我们仍然需要指定输出文件名和目标坐标参考系统。确保 **完成时加载到 QGIS 中** 选项处于激活状态。然后，我们可以关闭 **变换设置** 对话框，转到 **文件** | **开始地理配准**。地理配准的栅格将自动加载到 QGIS 主地图窗口中。

# 从数据库加载数据

QGIS 支持 PostGIS、SpatiaLite、MSSQL、SQL Anywhere 和 Oracle Spatial 数据库。我们将介绍两种开源选项：PostGIS 和 SpatiaLite。这两个选项都支持跨平台，就像 QGIS 一样。

**SpatiaLite** 是 Sqlite 数据库的空间扩展。Sqlite 是一个自包含的、无服务器的、零配置的事务性 SQL 数据库引擎 ([www.sqlite.org](http://www.sqlite.org))。这基本上意味着 Sqlite 数据库，因此也是 SpatiaLite 数据库，不需要服务器安装，可以像任何普通文件一样复制和交换。

您可以从 [www.gaia-gis.it/spatialite-2.3.1/test-2.3.zip](http://www.gaia-gis.it/spatialite-2.3.1/test-2.3.zip) 下载示例数据库。解压文件；您可以通过转到 **图层** | **添加 SpatiaLite 图层**，使用 **添加 SpatiaLite 图层** 工具栏按钮，或按 *Ctrl* + *Shift* + *L* 来连接到它。单击 **新建** 选择数据库文件 `test-2.3.sqlite`。QGIS 将保存所有连接并将它们添加到顶部的下拉列表中。在单击 **连接** 后，您将看到数据库中存储的图层列表，如下面的截图所示：

![从数据库加载数据](img/7488_02_05.jpg)

与文件一样，您可以从列表中选择一个或多个表，然后单击 **添加** 将它们加载到地图中。此外，您还可以使用 **设置过滤器** 仅加载特定要素。

### 小贴士

QGIS 中的过滤器使用类似 SQL 的语法；例如，`"Name" = 'EMILIA-ROMAGNA'` 用于仅选择名为 EMILIA-ROMAGNA 的区域，或者 `"Name" LIKE 'ISOLA%'` 用于选择以 ISOLA 开头的所有区域。过滤器查询将传递给底层数据提供者（例如，Spatialite 或 OGR）。基本过滤器查询的提供者语法在不同提供者之间是一致的，但在使用更复杂的函数时可能会变化。您可以在 [http://www.gdal.org/ogr/ogr_sql.html](http://www.gdal.org/ogr/ogr_sql.html) 上查阅 OGR SQL 的详细信息。

**PostGIS** 是 PostgreSQL 数据库系统的空间扩展。安装和配置数据库超出了本书的范围，但提供了 Windows 的安装程序以及许多 Linux 发行版和 Mac 的软件包。要从 PostGIS 数据库加载数据，请转到 **图层** | **添加 PostGIS 图层**，使用 **添加 PostGIS 图层** 工具栏按钮，或按 *Ctrl* + *Shift* + *D*。

当首次使用数据库时，点击**新建**以建立新的数据库连接。在以下对话框中，您可以指定新连接的**名称**。其他需要填写的字段如下：

+   **主机**：服务器的IP地址将插入到此字段。如果PostGIS在本地运行，您可以使用localhost。

+   **端口**：PostGIS默认端口是5432。

+   **数据库**：这是您想要连接的PostGIS数据库名称。

+   **用户名**和**密码**：为了方便，您可以告诉QGIS保存它们。![从数据库加载数据](img/7488_02_06.jpg)

以下截图显示了创建到名为**postgis**的数据库的新连接的对话框：

建立连接后，您可以像我们之前讨论的SpatiaLite那样加载数据和过滤表格。

# 从网络服务加载数据

越来越多的数据提供者通过OGC兼容的Web服务（如WMS、WCS或WFS）提供对他们的数据集的访问。QGIS支持这些服务。

您可以通过转到**图层** | **添加WMS图层**，点击**添加WMS图层**按钮，或按*Ctrl* + *Shift* + *W*来加载WMS图层。如果您知道一个WMS服务器，您可以通过点击**新建**并填写名称和URL来连接到它。所有其他字段都是可选的。如果您不知道任何WMS服务器，请不要担心，因为我们只需点击**添加默认服务器**即可获取与QGIS项目合作的管理员的服务器访问信息。其中有一个服务器称为**Lizardtech服务器**。从下拉框中选择它或任何其他服务器，然后点击**连接**以查看通过服务器可用的图层列表。

从图层列表中，您现在可以选择一个或多个图层进行下载。值得注意的是，您选择图层的顺序很重要，因为图层将在服务器端合并，QGIS只会接收到合并后的图像作为结果图层。如果您想能够单独使用图层，您必须逐个下载它们。点击**添加**后，数据下载开始。对话框将保持打开状态，以便您可以添加来自服务器的其他图层。

许多WMS服务器提供他们的图层以多种不同的CRS。您可以通过点击对话框底部的**更改**按钮来检查可用的CRS列表。这将打开一个CRS选择对话框，该对话框限于WMS服务器的CRS功能。

从WCS或WFS服务器加载数据的方式相同，但公共服务器很少且不可靠，因此在此无法提供推荐。

# 样式栅格图层

在介绍完数据源之后，我们现在可以创建我们的第一个地图。我们将从下往上构建地图，首先加载一些背景栅格（阴影和土地覆盖），然后我们将用点、线和多边形图层叠加它们。

让我们从加载来自`landcover.img`和`SR_50M_alaska_nad.tif`的土地覆盖和阴影层开始，然后打开图层属性的**样式**部分（**图层** | **属性**或通过双击图层名称）。QGIS会尝试选择一个合理的默认渲染类型。如您在以下截图中所见，阴影栅格`SR_50M_alaska_nad.tif`以**单波段灰度**渲染类型加载。如果我们想以彩色而不是灰度渲染阴影栅格，我们可以将渲染类型更改为**单波段伪彩色**。在伪彩色模式下，我们可以手动创建颜色图或选择预制的颜色渐变之一。但为了现在，我们还是坚持使用**单波段灰度**来样式阴影。

在颜色设置下方，我们找到一个包含更多高级选项的部分，这些选项控制栅格重采样、亮度、对比度、饱和度和色调——这些选项您可能从图像处理软件中很熟悉。默认情况下，重采样设置为快速的**最近邻**选项。为了获得更平滑的结果，我们可以将其更改为**双线性**或**立方**方法。

点击**确定**或**应用**以确认。在这两种情况下，地图将使用新的图层样式重新绘制。如果您点击**应用**，则**图层属性**对话框保持打开状态，您可以继续微调图层样式。如果您点击**确定**，则**图层属性**对话框将关闭。

![样式栅格层](img/7488_02_07.jpg)

`landcover.img`栅格是一个调色板栅格的好例子。每个单元格值都映射到特定的颜色。要更改颜色，我们只需双击**颜色**预览，就会打开颜色选择器。

一个调色板栅格的样式部分看起来如下截图所示：

![样式栅格层](img/7488_02_08.jpg)

如果我们想将阴影和土地覆盖组合成一个美观的背景，我们可以使用**混合模式**和图层**透明度**的组合。混合模式是图像处理软件中常见的另一个功能。与透明度相比，混合模式的主要优势是我们可以避免仅使用透明度结合栅格时通常出现的单调、低对比度的外观。如果您没有混合经验，请花些时间尝试不同的效果。在这个例子中，我使用了**变暗**混合模式，如前一个截图所示，以及全局图层透明度**50**%，如下一个截图所示：

![样式栅格层](img/7488_02_09.jpg)

# 样式矢量图层

当我们加载矢量图层时，QGIS使用默认样式和随机颜色进行渲染。当然，我们希望自定义这些样式以更好地反映我们的数据。在以下练习中，我们将样式点、线和多边形图层，并且我们将熟悉最常见的矢量样式选项。

## 创建点样式 – 机场样式的例子

让我们从点图层开始！从我们的样本数据中加载`airport.shp`。无论图层的几何类型如何，我们总是在**样式**对话框的右上角找到一个包含可用样式选项的下拉列表。

向量图层有以下样式选项可用：

+   **单个符号**：这是最简单的选项。当我们使用单个符号样式时，所有点都使用相同的符号显示。

+   **分类**：如果图层包含不同类别的点，则这是首选的样式；例如，包含不同动物观测地点的图层。

+   **渐变样式**：如果我们想可视化数值，这些样式非常好；例如，温度测量。

+   **基于规则的样式**：这是最先进的选项。这些样式非常灵活，因为它们允许我们为单个图层编写多个规则。

+   **点位移样式**：这些样式仅适用于点图层。如果您需要可视化具有相同坐标的多个点图层，这些样式很有用；例如，住在同一地址的学校学生。

在下拉列表下方，我们找到符号预览，再下方是符号层列表，它显示了符号由哪些不同的层组成。在右侧，我们找到用于符号大小和大小单位、颜色和透明度以及旋转的选项。使用**数据定义属性**按钮，我们还可以告诉QGIS使用要素的属性值来定义符号形状、大小、颜色等。最后，右下角包含一个保存符号的预览区域。

点图层默认使用简单的圆形符号显示。我们想使用飞机符号。要更改符号，请选择**符号层**中的**简单标记**条目。注意对话框的右侧如何变化。我们现在可以看到简单标记的选项：**颜色**、**大小**、**旋转**、**形状**等。然而，我们不是在寻找圆形、星星或方形符号——我们想要一个飞机。这就是为什么我们需要将**符号层类型**选项从**简单标记**更改为**SVG标记**。许多选项都是相似的，但在底部我们现在可以找到一组SVG图像供我们选择。滚动列表并选择如图所示的飞机符号：

![创建点样式 – 机场样式的示例](img/7488_02_10.jpg)

点图层符号层类型包括以下几种：

+   **简单标记**：这些包括几何形状，如圆形、星星和方形

+   **字体标记**：这些提供对您的符号字体的访问

+   **SVG标记**：每个QGIS安装都附带一组默认的SVG符号；通过访问**设置** | **选项** | **系统** | **SVG路径**来添加包含SVG图像的自己的文件夹。

+   **椭圆标记器**：这些包括可定制的椭圆、矩形、十字和三角形；特别适用于与我们在数据定义设置选项中设置的内容结合使用

+   **矢量场标记器**：这是一个可定制的矢量场可视化工具

## 创建线样式 – 河流或道路样式的示例

在这个练习中，我们将为我们样本数据中的`majriver.shp`文件创建河流样式。目标是创建一个具有两种颜色的线条样式：线条中心的填充颜色和轮廓颜色。这种技术非常有用，因为它还可以用来创建道路样式。

要创建这样的样式，我们结合了两条简单的线。默认符号是一条简单的线。点击位于**符号层**列表下方的绿色**+**符号以添加另一条简单线。下面的一条将是我们轮廓，上面的一条将是填充。选择上面的简单线，将其颜色更改为蓝色并将宽度更改为0.3毫米。接下来，选择下面的简单线，将其颜色更改为灰色并将宽度更改为0.6毫米，比其他线条略宽。检查预览，并点击**应用**以测试将样式应用于河流层时的外观。

你会注意到样式还不是完美的。这是因为每个线要素都是单独绘制的，一个接一个，这导致了一种相当不连贯的外观。幸运的是，这很容易修复；我们只需要启用所谓的符号级别。为此，在**符号层**列表中选择**线**条目，并在**高级**部分的**符号级别**对话框中勾选复选框（位于样式对话框的右下角按钮），如图下截图所示。点击**应用**以测试结果：

### 小贴士

每当我们创建可能想要在其他地图中重复使用的符号时，我们可以通过转到**符号** | **保存到符号库**（位于底右角的**高级**按钮旁边的按钮）来保存它。我们可以为新符号分配一个名称；保存后，它将被添加到**已保存样式**预览区域。

![创建线样式 – 河流或道路样式的示例](img/7488_02_11.jpg)

线层符号层类型包括以下几种：

+   **简单线**：这些是实线或虚线

+   **标记线**：这些线由位于线顶点或等间隔的点标记组成

## 创建多边形样式 – 一个陆地样式的示例

在这个练习中，我们将为`alaska.shp`文件创建一个样式。目标是创建一个带有蓝色光环的简单填充。就像之前的河流样式示例一样，我们将结合两个符号层来创建这个样式：一个定义主要填充颜色并带有细边框的简单填充层，以及一个额外的简单线条轮廓层用于光环。光环应该有漂亮的圆角。为了实现这一点，将**连接样式**选项更改为**圆形**。类似于之前的示例，我们再次启用符号级别；为了防止这种陆地样式遮挡背景地图，我们选择**乘法**混合模式，如以下截图所示：

![创建多边形样式 - 一个陆地样式的示例](img/7488_02_12.jpg)

多边形层的符号层类型包括以下几种：

+   **简单填充**: 这些定义填充和轮廓颜色以及基本的填充样式

+   **质心填充**: 这些允许我们在多边形的中心放置点标记

+   **线/点图案填充**: 这些支持用户定义的线型和点图案，具有灵活的间距

+   **SVG填充**: 这些使用SVG图案填充多边形

+   **轮廓**: 这些使使用线条样式绘制轮廓区域成为可能

# 加载背景地图

背景地图对于快速检查和提供方向非常有用，尤其是在你无法访问任何其他基础图层的情况下。使用OpenLayers插件添加背景地图非常简单。它提供了通过Google、Yahoo!和Bing访问卫星、街道和混合地图的权限，以及通过OpenStreetMap、Stamen和Apple提供的不同地图类型。

要安装OpenLayers插件，请转到**插件** | **管理和安装插件 | 获取更多**。等待直到可用的插件列表加载完成。使用过滤器查找**OpenLayers插件**选项，如以下截图所示。从列表中选择它，然后点击**安装**。这可能需要一点时间。完成后，您将看到一个简短的确认消息。然后您可以关闭安装程序，**OpenLayers插件**选项应该可以通过**插件**菜单使用。

![加载背景地图](img/7488_02_13.jpg)

注意，您必须在线才能使用这些服务。另一个值得注意的事实是，所有这些服务都只提供伪墨卡托（EPSG:3857）地图。当您使用**OpenLayers插件**选项加载背景地图时，您的项目CRS将自动更改为伪墨卡托。

如果您加载OSM景观层，您的地图将看起来像以下截图：

![加载背景地图](img/7488_02_14.jpg)

# 摘要

在本章中，我们介绍了如何从文件、数据库和Web服务中加载空间数据。我们看到了QGIS如何处理坐标参考系统，并对矢量图层和栅格图层的样式化进行了初步介绍，这个主题我们将在[第5章](ch05.html "第5章。创建优秀的地图")“创建优秀的地图”中更详细地探讨。我们还安装了我们的第一个Python插件，即OpenLayers插件，并使用它将背景地图加载到我们的项目中。
