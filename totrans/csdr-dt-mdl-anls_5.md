# 第5章. 初步设计和实现

基于前几章中解释的Cassandra数据模型组件，现在是时候将它们应用到实际的工作应用中了。我们将开始定义在数据模型中真正想要存储和查询的内容，设置环境，编写程序代码，并最终测试应用。

要构建的应用是一个股票筛选器应用，它将历史股票报价存储在Cassandra数据库中，用于技术分析。该应用从互联网上的免费来源收集股票报价数据，然后应用一些技术分析指标来找出买卖参考信号。为了使您能够轻松理解应用的功能，这里给出技术分析的一个简短快速介绍。尽管在架构上过于简化，功能上也不完整，但它确实为您提供了进一步改进更多高级功能的基础。

### 注意

**免责声明**

应假定本书中讨论的方法、技术或指标将是有利可图的，不会导致损失。不能保证所提出的策略和方法将成功，或者您将成为一个有利可图的交易者。任何交易系统或交易方法的历史表现和结果并不一定预示未来的结果。您不应使用无法承受损失的资金进行交易。本书中讨论和展示的例子仅用于教育目的。这些不是购买或出售任何订单的招揽。我对您的交易结果不承担任何责任。没有表示任何账户将或可能实现与本书中讨论的类似利润或损失。交易风险非常高。在做出任何投资或交易决策之前，鼓励您咨询认证的财务顾问。

# 股票筛选器应用

在本节中，我们将学习一些关于示例应用的背景信息。然后，我们将讨论数据源、初始数据模型以及应用的高级处理逻辑。

## 金融分析简介

股票筛选器是一个使用一定套标准来筛选大量符合您偏好的股票的实用程序。它类似于股票搜索引擎，而不是网站搜索引擎。筛选标准可能基于基本面和/或技术分析方法。

首先，让我们看看什么是基本面分析。

### 注意

**基本面分析**

基本面分析涉及分析一家公司的历史和当前财务报表和健康状况，其管理和竞争优势，以及其竞争对手和市场，以便评估和计算公司股票的价值并预测其可能的价格走势。目标是进行财务预测并找出被低估的股票（换句话说，就是便宜的股票）用于买入并持有。

相比之下，技术分析是一种完全不同的方法。

### 注意

**技术分析**

技术分析是一种股票分析方法，通过研究过去的市场数据（主要是价格和成交量）来预测价格走势。技术分析的基本原理是市场价格反映了所有相关信息，因此分析关注的是交易模式的过去历史，而不是外部驱动因素，如经济、基本面和新闻事件。

在本书中，技术分析仅用于股票筛选器应用。由于技术分析侧重于价格行为，股票筛选器应用需要股票价格数据作为其输入，然后应用技术分析技术来确定股票是否满足买入或卖出条件。每当满足这种条件时，我们就可以说触发了交易信号。

股票筛选器应用程序的概念设计如图所示：

![金融分析简介](img/8884OS_05_01.jpg)

我们将从左到右依次解释前面的图示。**数据提供者**是股票报价数据的来源，这些数据是从互联网上的免费数据提供者收集的，例如雅虎财经。需要注意的是，雅虎财经提供免费的**每日收盘价**（**EOD**）股票报价数据，因此提供每日股票报价。如果您希望**股票筛选器**产生日内信号，您需要寻找其他数据提供者，他们通常提供广泛的付费服务。**历史数据**是一个存储历史股票报价数据的仓库。**股票筛选器**是本章要开发的应用程序。最后，**警报列表**是**股票筛选器**找到的交易信号列表。

在我们继续进行**股票筛选器**的高级设计之前，我想强调建立**历史数据**仓库的原因。主要有三个原因。首先，它可以节省大量网络带宽，避免从数据提供者（实际上，雅虎财经提供了多达10年的历史价格数据）反复下载历史股票报价数据。其次，它作为规范的数据模型，这样**股票筛选器**就不需要适应不同数据提供者的不同数据格式。最后，即使**股票筛选器**与互联网断开连接，它仍然可以对历史数据进行技术分析。

## 股票报价数据

技术分析只关注价格动作。那么，价格动作是什么？价格动作简单地说就是股票价格的运动。它包含在技术分析和图表模式分析中，试图发现价格看似随机运动中的秩序。

在单日，股票的价格动作可以总结为四个重要的价格：

+   **开盘价**：这是当天的起始价格

+   **最高价**：这是当天的最高价格

+   **最低价**：这是当天的最低价格

+   **收盘价**：这是当天的收盘价格

这四个价格通常被缩写为OHLC。除了OHLC之外，衡量在特定时间段内给定股票交易量的另一个指标被称为成交量。对于完整交易日，成交量被称为日成交量。

只有开盘价、最高价、最低价、收盘价和成交量（**OHLC**）这五个属性，就提供了进行股票技术分析所需的所有必要和充分的数据。现在我们知道了技术分析的输入，但我们如何获取它们呢？

许多网站提供免费且易于获取的股票报价数据，特别适合业余或零售交易者。以下是一些供您参考的网站：

+   Yahoo! Finance: [http://finance.yahoo.com](http://finance.yahoo.com)

+   Google Finance: [https://www.google.com/finance](https://www.google.com/finance)

+   EODData: [http://eoddata.com](http://eoddata.com)

然而，有一个需要注意的问题，即股票报价数据可能存在错误，例如，最高价和最低价不正确。在这本书中，我选择了雅虎财经作为主要的数据流提供商。以下截图是名为*GS*的股票的历史价格样本：

![股票报价数据](img/8884OS_05_02.jpg)

当你滚动到网页底部时，你会看到一个链接*下载到电子表格*。当你点击这个链接时，可以下载历史股票报价数据作为**逗号分隔值**（**CSV**）文件。以下截图显示了CSV文件的一个片段：

![股票报价数据](img/8884OS_05_03.jpg)

当然，我们可以从网站上手动下载历史股票报价数据。然而，当我们需要每天下载许多不同股票的数据时，这变得不切实际。因此，我们将开发一个程序来自动收集数据流。

## 初始数据模型

我们现在知道，单个每日价格动作包括股票代码、交易日期、开盘价、最高价、最低价、收盘价和成交量。显然，在连续交易日的价格动作序列是时间序列性质的，Cassandra非常适合存储这种类型的数据。

如前所述，将收集到的股票报价数据本地存储在仓库中是有益的。因此，我们将实现一个Cassandra数据库中的表作为仓库。

我们可以使用CQL定义一个名为`quote`的表来存储历史价格：

[PRE0]

列的数据类型和名称是自解释的。

设计Cassandra数据模型的一个有用技术是想象行内部存储的视觉表示。以下是一个这样的例子：

![初始数据模型](img/8884OS_05_04.jpg)

根据主键的设计，行键是`symbol`，聚类列是`price_time`。预计随着更多历史股票报价数据的添加，行将变成宽行。如果没有内部存储图，在初始数据模型设计阶段可能不容易发现这一点。目前，我们只需注意潜在的宽行问题，并保持现状（一个可能的解决方案是日期桶模式）。

## 处理流程

以下图显示了**股票筛选器**的处理流程，它通过更详细的步骤序列详细阐述了概念设计。每个构建块的解释从顶部开始，如下面的截图所示：

![处理流程](img/8884OS_05_05.jpg)

**数据馈送提供者**由**数据馈送**、**数据馈送适配器**和**数据映射器和归档器**组成。Yahoo! Finance被选为数据馈送。**数据馈送适配器**用于处理如果我们切换到其他数据馈送提供者时的不同连接性和接口方法。**数据映射器和归档器**针对不同的股票报价数据格式，并将它们标准化为`quote`表的相应列。

`quote`表是**历史数据**存储库，之前已经解释过。

我们现在将重点转向核心**股票筛选器**。**股票筛选器**的核心是**股票筛选器引擎**，它使用**筛选规则**在**历史数据**上，这些数据通过**数据范围器**过滤。**筛选规则**被一个或多个**技术分析信号**使用，以便当**技术分析信号**的条件满足时，**股票筛选器引擎**生成警报。

**股票筛选器引擎**生成的警报以**警报列表**的形式呈现，可以保留为记录或通过其他方式分发。

基本上，**数据馈送提供者**和**股票筛选器**不需要在同一个进程中运行。它们以异步模式工作。这意味着**数据馈送提供者**可以收集、映射和归档历史股票报价数据到**历史数据**存储库，而**股票筛选器**可以独立分析和生成警报。

我们已经提出了应用程序的高级设计，接下来要做的事情可能是看看它如何实现。

# 系统设计

在本节中，我们将选择适合各种系统组件的适当软件。

## 操作系统

在考虑实施时，第一个基本选择是操作系统。最重要的限制条件是它必须得到Cassandra的支持。对于这本书，我选择了Ubuntu 14.04 LTS 64位版本，可以在官方Ubuntu网站上获取，[http://www.ubuntu.com/](http://www.ubuntu.com/)。你应该能够通过遵循详细的安装说明轻松地设置你的Linux系统。

然而，使用任何其他由Cassandra支持的操作系统（如Microsoft Windows和Mac OS X）完全取决于你。请遵循相应操作系统的安装说明来设置你的机器。我已经考虑了Stock Screener的可移植性。正如你将在后续章节中看到的，Stock Screener应用程序被设计和开发成与大量操作系统兼容。

## Java运行时环境

由于Cassandra是基于Java的，因此需要一个**Java运行时环境**（**JRE**）作为先决条件。我使用了Oracle Java SE运行时环境7 64位版本1.7.0_65。可以在以下URL获取：[http://www.oracle.com/technetwork/java/javase/downloads/jre7-downloads-1880261.html](http://www.oracle.com/technetwork/java/javase/downloads/jre7-downloads-1880261.html)。

当然，我已经下载了Linux x64二进制文件，并遵循了[http://www.datastax.com/documentation/cassandra/2.0/cassandra/install/installJreDeb.html](http://www.datastax.com/documentation/cassandra/2.0/cassandra/install/installJreDeb.html)上的说明来正确设置JRE。

在撰写本文时，Java SE已更新到版本8。然而，我尚未测试JRE 8，DataStax也建议对于Cassandra 2.0使用JRE 7。因此，在这本书中，我将坚持使用JRE 7。

## Java本地访问

如果你想在Linux平台上将Cassandra用于生产部署，**Java本地访问**（**JNA**）是必需的，以提高Cassandra的内存使用。安装和配置完成后，Linux不会交换**Java虚拟机**（**JVM**），从而避免任何与性能相关的问题。即使要安装的Cassandra不是用于生产用途，这也是一种最佳实践。

要在Ubuntu上安装JNA，只需在终端中使用以下命令通过Aptitude软件包管理器：

[PRE1]

## Cassandra版本

我使用了由DataStax Community分发的Cassandra版本2.0.9，适用于Debian或Ubuntu。安装步骤在[http://www.datastax.com/documentation/getting_started/doc/getting_started/gettingStartedDeb_t.html](http://www.datastax.com/documentation/getting_started/doc/getting_started/gettingStartedDeb_t.html)上有很好的文档说明。

安装过程通常需要几分钟，具体取决于你的网络带宽和机器的性能。

### 注意

**DataStax**

DataStax是一家位于加利福尼亚州圣克拉拉的计算机软件公司，它在DataStax Enterprise产品中提供Apache Cassandra的商业企业级支持。它还为Apache Cassandra社区提供巨大的支持。

## 编程语言

现在是时候将我们的注意力转向用于实现股票筛选器应用程序的编程语言了。对于这本书，我选择了Python。Python是一种为开发速度而设计的面向高级的编程语言。它是开源的、免费的，并且跨平台。它拥有几乎涵盖你所能想象到的几乎所有流行算法的丰富库集。

如果你不太熟悉Python，不必害怕学习Python。Python的设计使得与其他编程语言（如C++）相比，学习起来非常容易。编写Python程序几乎就像编写伪代码，这可以加快开发速度。

此外，还有许多用于数据分析的知名Python库，例如NumPy、SciPy、pandas、scikit-learn和matplotlib。你可以利用它们快速构建一个功能齐全的应用程序，包括所有功能。对于股票筛选器应用程序，你将广泛使用NumPy和pandas。

当谈到高性能时，Python也可以利用Cython，这是一个用于Python程序的优化静态编译器，可以使程序运行得和原生C或C++程序一样快。

Python的最新主要版本是Python 3。然而，仍然有许多程序是用Python 2编写的。这是由于Python 3向后不兼容性造成的，使得许多用Python 2编写的库迁移到Python 3变得非常漫长。因此，预计Python 2和Python 3在未来相当长一段时间内会共存。对于这本书，使用Python 2.7.x。

以下步骤用于在Ubuntu中使用终端安装Python 2.7：

[PRE2]

安装完成后，输入以下命令：

[PRE3]

你应该能看到Python返回的版本字符串，这告诉你安装已经成功。

许多Python初学者面临的一个问题是各种库包的繁琐安装。为了解决这个问题，我建议读者下载Anaconda发行版。Anaconda完全免费，包括近200个最流行的Python科学、数学、工程和数据分析包。尽管它体积相当大，但它让你摆脱了Python包的烦恼。Anaconda可以在[http://continuum.io/downloads](http://continuum.io/downloads)下载，在那里你可以选择合适的Python版本和操作系统。按照安装说明安装Anaconda非常简单，所以这里不会详细说明步骤。

## Cassandra驱动程序

系统环境的最后一个是Python连接到Cassandra数据库的驱动软件。实际上，有几种选择，例如pycassa、Cassandra驱动程序和Thrift。我选择了DataStax分发的Apache Cassandra Python驱动程序2.0。它仅支持CQL 3和Cassandra在1.2版本中引入的新二进制协议。更详细的信息可以在[http://www.datastax.com/documentation/developer/python-driver/2.0/common/drivers/introduction/introArchOverview_c.html](http://www.datastax.com/documentation/developer/python-driver/2.0/common/drivers/introduction/introArchOverview_c.html)找到。

驱动程序可以很容易地在Ubuntu终端中使用pip安装：

[PRE4]

### 注意

**pip**

pip是一个用于安装和管理Python库包的命令行包管理系统。其项目页面可在GitHub上找到，[https://github.com/pypa/pip](https://github.com/pypa/pip)。

## 集成开发环境

Spyder是一个开源的、跨平台的**集成开发环境**（**IDE**），通常用于Python的科学编程。它由Anaconda自动安装，并集成了NumPy、SciPy、matplotlib、IPython和其他开源软件。它也是我最喜欢的Python开发环境。

还有许多其他优秀且流行的Python IDE，如IPython和Eclipse。本书中的代码对这些IDE友好。

## 系统概述

好的，我们已经了解了Stock Screener应用程序的主要系统组件，并决定了它们的实现。以下图展示了应用程序实现的系统概述：

![系统概述](img/8884OS_05_06.jpg)

值得注意的是，系统将首先在单个Ubuntu机器上开发，然后在一个单节点Cassandra集群上开发（在[第7章](ch07.html "第7章。部署和监控")中，我们将集群扩展到双节点集群）。这限制了Cassandra卓越的集群能力。然而，从软件开发的角度来看，最重要的是完全实现所需的功能，而不是将大量精力分散在系统或基础设施组件上，这些组件的优先级较低。

# 代码设计和开发

我们现在进入开发阶段。我将逐步向您展示应用程序构建块的编码。从逻辑上讲，将构建两个核心模块，即数据源提供者和Stock Screener。首先，我们将构建数据源提供者。

## 数据源提供者

数据源提供者实现了以下三个任务：

1.  从Yahoo! Finance收集历史股票报价数据。

1.  将接收到的数据转换为标准格式。

1.  将标准化数据保存到Cassandra数据库中。

Python有一个著名的数据分析库，称为pandas。它是一个开源库，提供高性能、易于使用的数据结构和数据分析工具，特别是针对时间序列数据。您可以访问[http://pandas.pydata.org/](http://pandas.pydata.org/)获取更多详细信息。

### 收集股票报价

pandas在其`pandas.io.data`包中提供了一个`DataReader`函数。`DataReader`从各种互联网来源提取金融数据到称为`DataFrame`的数据结构中。Yahoo! Finance是支持的互联网来源之一，使得收集历史股票报价数据变得轻而易举。参考以下Python代码，`cha` `pter05_001.py`：

[PRE5]

需要简要说明。pandas提供了一个非常实用的数据结构，称为`DataFrame`，它是一个具有不同类型列的二维标签数据结构。您可以将其视为电子表格或SQL表。它通常是pandas中最常用的对象。

以下是一个使用Spyder编写和测试`chapter05_001.py`代码的截图：

![收集股票报价](img/8884OS_05_07.jpg)

Spyder IDE的左侧是您编写Python代码的地方。右侧中间面板是**IPython控制台**，用于运行代码。

### 数据转换

除了`DataFrame`中的数据外，您还可以选择性地传递索引（行标签）和列（列标签）。可以通过访问索引和列属性分别访问行和列标签。例如，您可以回顾`table.csv`的截图，并看到Yahoo! Finance返回的列名分别是**日期**、**开盘价**、**最高价**、**最低价**、**收盘价**、**成交量**和**调整后收盘价**，分别。`DataReader`使用**日期**作为返回的`DataFrame`的索引。其余的列名成为`DataFrame`的列标签。

`chapter05_001.py`中的最后一个for循环也值得注意。`DataFrame`有一个名为`iterrows()`的函数，用于遍历其行作为（索引，列）对。因此，for循环使用`iterrows()`遍历每日股票报价，我们简单地打印出索引（通过`date()`函数转换为字符串），以及通过传递相应的列标签到行的**开盘价**、**最高价**、**最低价**、**收盘价**、**成交量**列。**调整后收盘价**是经过股票分割、合并和股息调整的收盘价。我们不使用它，因为我们想专注于纯价格。

请注意，来自不同来源的股票报价数据可能有不同的格式，不用说，列名也不同。因此，在将它们映射到我们的标准化数据模型时，我们需要注意这种细微的差异。`DataFrame`提供了一个非常方便的方法通过列名检索数据，以及一些有用的函数来操作索引和列。我们可以利用它们来标准化数据格式，如`chapter05_002.py`所示：

[PRE6]

### 在Cassandra中存储数据

在将检索到的数据存储到Cassandra之前，我们需要在Cassandra数据库中创建键空间和表。我们将在`chapter05_003.py`中创建一个名为`packtcdma`的键空间和一个名为`quote`的表来存储历史数据，如下面的代码所示：

[PRE7]

代码注释足以解释它在做什么。现在，我们已经准备好了历史数据存储库，接下来是将接收到的数据存储到其中。这正是`chapter05_004.py`的目的，其中创建了一个Python函数来插入数据，如下面的代码所示：

[PRE8]

虽然`chapter05_004.py`的代码行数不到十行，但它相当复杂，需要一些解释。

我们可以使用`def`关键字在Python中创建一个函数。这必须后跟函数名和括号内的形式参数列表。构成函数主体的代码从下一行开始，缩进一个制表符。因此，在`chapter05_004.py`中，函数名为`insert_quote()`，有三个参数，分别是`ss`、`sym`和`d`。

### 注意

**Python中的缩进**

在Python中，逻辑行开头的空白（空格和制表符）用于计算行的缩进级别，这反过来又用于确定语句的分组。对此要非常小心。大多数Python IDE都有检查缩进的特性。关于Python缩进神话的文章值得一读，可在[http://www.secnetix.de/olli/Python/block_indentation.hawk](http://www.secnetix.de/olli/Python/block_indentation.hawk)找到。

第二个有趣的事情是`prepare()`函数。它用于准备由Cassandra解析并随后保存以供以后使用的CQL语句。当驱动程序使用预定义语句时，它只需要发送绑定参数的值。这避免了每次重新解析语句，从而降低了网络流量和CPU利用率。

预定义语句的占位符是`?`字符，这样参数就可以按顺序传递。这种方法称为位置参数传递。

代码的最后一段是一个for循环，它遍历`DataFrame`并将每一行插入到quote表中。我们还使用`Decimal()`函数将字符串转换为数值。

### 将它们全部放在一起

所有Python代码片段都可以组合起来制作数据馈送提供者。为了使代码更简洁，收集股票报价的代码片段被封装在一个名为`collect_data()`的函数中，而数据转换的代码片段被封装在`transform_yahoo()`函数中。完整的程序`chapter05_005.py`如下所示：

[PRE9]

## 股票筛选器

股票筛选器从Cassandra数据库中检索历史数据，并应用技术分析技术以产生警报。它包含以下四个组件：

1.  在指定时间段内检索历史数据

1.  为时间序列数据编程技术分析指标

1.  将筛选规则应用于历史数据

1.  产生警报信号

### 数据范围

为了利用技术分析技术，需要足够数量的股票报价数据进行计算。我们不需要使用所有存储的数据，因此应该检索数据的一个子集进行处理。以下代码`chapte05_006.py`从指定日期范围内的`quote`表中检索历史数据：

[PRE10]

函数的前一部分应该容易理解。它执行一个针对特定股票符号和指定日期段的`select_cql`查询。聚类列`price_time`使得范围查询成为可能。查询结果集被返回并用于填充两个NumPy数组，`idx`用于索引，`cols`用于列。然后`cols`数组被重塑为一个二维数组，其中包含每天的价格和成交量行。最后，使用`idx`和`cols`数组创建一个`DataFrame`以返回`df`。

### 时间序列数据

作为简单的说明，我们使用10天的**简单移动平均**（**SMA**）作为股票筛选的技术分析信号。pandas提供了一套丰富的函数来处理时间序列数据。SMA可以通过`rolling_mean()`函数轻松计算，如`chapter05_007.py`所示：

[PRE11]

### 筛选规则

当计算简单移动平均（SMA）时，我们可以应用一个筛选规则来寻找交易信号。采用一个非常简单的规则：只要交易日的收盘价高于10日SMA，就生成一个买入并持有的信号。在Python中，这只是一个利用pandas功能的单行代码。太棒了！以下是一个示例：

[PRE12]

### 股票筛选引擎

到目前为止，我们编写了股票筛选器的组件。现在我们将它们组合起来生成警报列表，如下面的代码所示：

[PRE13]

# 测试运行

一个端到端测试包括两个部分。首先，我们测试和验证`chapter05_005.py`，这是完整的数据提供者模块。然后在Spyder中运行`chapter05_005.py`。历史股票报价数据应存储在Cassandra数据库中。然后运行并验证股票筛选模块`chapter05_009.py`，同样在Spyder中。

以下截图显示了测试运行的样本筛选。警报列表应该有七个买入并持有的交易信号：

![测试运行](img/8884OS_05_08.jpg)

# 摘要

本章内容相当紧凑。我们设计了一个简单的股票筛选应用程序，该程序从雅虎财经收集股票报价数据，其存储库使用Cassandra。还介绍了应用程序的系统环境以及简要的设置说明。然后我们使用Python逐步解释开发了这个应用程序。尽管只使用了一个Cassandra表，但基本的行操作逻辑已经得到了演示。

在下一章中，我们将继续增强股票筛选应用程序，以收集一批股票的股票报价数据，并通过几个改进来优化应用程序。
