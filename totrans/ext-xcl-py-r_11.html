<html><head></head><body>
		<div><h1 id="_idParaDest-196" class="chapter-number"><a id="_idTextAnchor215"/>11</h1>
			<h1 id="_idParaDest-197"><a id="_idTextAnchor216"/>Calling R/Python Locally from Excel Directly or via an API</h1>
			<p>In this chapter, we are going to discuss calling R and Python from within Excel. You may ask yourself why you would want to do that when there are many functions inside of Excel that one can use or, if so desired, can write with the VBA portion of the application. One reason why you might want to call R or Python from Excel is to leverage the power and flexibility of these programming languages for data analysis and visualization. Excel is a widely used spreadsheet application that can handle large datasets and perform basic calculations and functions. However, Excel has some limitations when it comes to more advanced or customized tasks, such as statistical modeling, machine learning, web scraping, natural language processing, and so on. By calling R or Python from Excel, you can access the rich libraries and packages that these languages offer and use them to manipulate, transform, and visualize your data in more sophisticated ways. You can also automate your workflows and create reproducible reports and dashboards. Calling R or Python from Excel can enhance your productivity and efficiency, as well as expand your analytical capabilities.</p>
			<p>We will be a bit different here. In this chapter, we will cover two (very) different methods for calling R and Python from Excel: local calls, where R or Python is installed on the same machine, and running and using API calls, where the R or Python functionality is deployed to a server as an API endpoint. For the latter, we will have a look at open-source tools and some of the most popular commercial solutions.</p>
			<h1 id="_idParaDest-198"><a id="_idTextAnchor217"/>Technical requirements</h1>
			<p>In this chapter, you can find all the code on GitHub at the following link: <a href="https://github.com/PacktPublishing/Extending-Excel-with-Python-and-R/tree/main/Chapter%2011">https://github.com/PacktPublishing/Extending-Excel-with-Python-and-R/tree/main/Chapter%2011</a>.</p>
			<p>You will need to install the following external software:</p>
			<ul>
				<li>BERT, which can be found here: <a href="http://bert-toolkit.com/download-bert">http://bert-toolkit.com/download-bert</a></li>
				<li>Python and <code>xlwings</code> (refer to the <em class="italic">Setting up an </em><em class="italic">environment </em>section)</li>
				<li><code>plumber </code>for R</li>
				<li>FastAPI for Python</li>
			</ul>
			<p>Let’s begin with the first part.</p>
			<h1 id="_idParaDest-199"><a id="_idTextAnchor218"/>Calling R and Python from Excel locally</h1>
			<p>In this first part of the<a id="_idIndexMarker897"/> chapter, we are going to learn about<a id="_idIndexMarker898"/> using the +or Excel that can interface with R directly, along with <code>xlwings </code>to interact with Python from Excel. We will also quickly show how one can use a VBA script to call R from Excel. In this chapter, we’re going to cover the following main topics:</p>
			<ul>
				<li>Why you would want to call R/Python from Excel locally</li>
				<li>Setting up an environment</li>
				<li>Calling R/Python directly from Excel</li>
			</ul>
			<p>Let’s begin!</p>
			<h1 id="_idParaDest-200"><a id="_idTextAnchor219"/>Why you would want to call R/Python from Excel locally</h1>
			<p>As we discussed in the opening, it is possible<a id="_idIndexMarker899"/> to do a wide variety of analysis<a id="_idIndexMarker900"/> and programming in Excel via the use of VBA. However, this can be tedious to write and difficult to implement. By harnessing the power of <code>BERT </code>and <code>xlwings</code>, you can use an already rich landscape of functions that are ready to go or write your own in those languages and use them in Excel.</p>
			<p>With <code>BERT</code>, you get the power of R in Excel: R is a powerful statistical programming language with a wide range of capabilities. <code>BERT </code>allows you to use these capabilities directly in Excel without having to switch to a separate R environment. This can be very convenient if you are already working in Excel and don’t want to leave the application.</p>
			<p><code>BERT </code>allows you to write R functions that can be used as custom Excel functions. This can be useful for creating functions that are not available in Excel or for improving the performance of existing Excel functions. For example, you can create a Brownian motion by using <code>BERT </code>to call a function built inside of R, which is going to be much easier to code in R than it would in Excel.</p>
			<p>What <code>BERT </code>is for R, <code>xlwings </code>is for Python. The benefits<a id="_idIndexMarker901"/> are analogous<a id="_idIndexMarker902"/> as well: create your solution in Python and call it from Excel directly.</p>
			<p>Let’s start with setting up your environment so you can get your hands dirty!</p>
			<h1 id="_idParaDest-201"><a id="_idTextAnchor220"/>Setting up an environment</h1>
			<p>Since setting up an environment for <code>BERT</code> and <code>xlwings</code> is non-trivial, we will walk you through the process in detail in the coming subsections.</p>
			<h2 id="_idParaDest-202"><a id="_idTextAnchor221"/>Steps to set up BERT for R</h2>
			<p>In this section, we will cover<a id="_idIndexMarker903"/> the installation<a id="_idIndexMarker904"/> of <code>BERT</code> for Windows so that we can utilize <code>BERT </code>to manipulate Excel from inside of R. The first thing that we will have to do is download the <code>BERT </code>installer, which<a id="_idIndexMarker905"/> can be obtained from here: <a href="https://bert-toolkit.com/download-bert">https://bert-toolkit.com/download-bert</a>.</p>
			<p>Once this is downloaded, you can then install it as you would any other program. Once installed, you can then use the <strong class="bold">Add-ins </strong>ribbon from Excel to open the <strong class="bold">BERT Console</strong>, as shown here:</p>
			<div><div><img src="img/B19142_11_01.jpg" alt="Figure 11.1 – BERT Console from the Add-ins ribbon in Excel"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.1 – BERT Console from the Add-ins ribbon in Excel</p>
			<p>Once you see it, click<a id="_idIndexMarker906"/> the button, and the console<a id="_idIndexMarker907"/> will open, as shown here:</p>
			<div><div><img src="img/B19142_11_02.jpg" alt="Figure 11.2 – The BERT Console"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.2 – The BERT Console</p>
			<p>Now, let’s move to Python.</p>
			<h2 id="_idParaDest-203"><a id="_idTextAnchor222"/>Steps to set up xlwings for Python</h2>
			<p>In this subsection, we will cover<a id="_idIndexMarker908"/> the steps<a id="_idIndexMarker909"/> required to set up <code>xlwings</code>:</p>
			<h3>Installing Python</h3>
			<p>Ensure that Python<a id="_idIndexMarker910"/> is installed on your machine. You can download the latest version<a id="_idIndexMarker911"/> from the official Python website (<a href="https://www.python.org/downloads/">https://www.python.org/downloads/</a>). During installation, you can check the box that says <strong class="bold">Add Python to PATH </strong>for easier access.</p>
			<h4>Installing Excel add-ins:</h4>
			<p>Follow these simple steps<a id="_idIndexMarker912"/> to get started with <code>xlwings</code>:</p>
			<ol>
				<li>Open a command prompt and run the following:<pre class="source-code">
<code>WARNING: The script xlwings.exe is installed in '&lt;folder&gt;' which is not on PATH</code>. If you do, you will have to specify the full path to be able to call <code>xlwings </code>in the next step.</p></li>				<li>To install the add-in, use the command-line client:<pre class="source-code">
<code>xlwings</code> add-in will appear<a id="_idIndexMarker913"/> after the <strong class="bold">Help </strong>menu in the toolbar:</p></li>
			</ol>
			<div><div><img src="img/B19142_11_03.jpg" alt="Figure 11.3 – xlwings in the ribbon in Excel"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.3 – xlwings in the ribbon in Excel</p>
			<h4>Configuring the Excel and Python environment</h4>
			<p>Configure <code>xlwings</code> by specifying the Python<a id="_idIndexMarker914"/> interpreter path in the Excel add-ins settings. However, this is typically done automatically by <code>xlwings</code>.</p>
			<p>To verify the setup, run any of the examples given in the next section.</p>
			<h4>Troubleshooting</h4>
			<p>If you encounter issues, refer<a id="_idIndexMarker915"/> to the documentation for <code>xlwings</code> (<a href="https://docs.xlwings.org/en/stable/">https://docs.xlwings.org/en/stable/</a>). Check for common troubleshooting<a id="_idIndexMarker916"/> tips and solutions.</p>
			<p>This step-by-step guide ensures a smooth setup of your local environment, enabling Excel and Python to work seamlessly together. Following these instructions will provide a solid foundation for the subsequent<a id="_idIndexMarker917"/> chapters, allowing you to harness the combined power of Excel and Python.</p>
			<p>Now that you have set up, let’s get to the meat of how to actually use these tools!</p>
			<h1 id="_idParaDest-204"><a id="_idTextAnchor223"/>Calling R/Python directly from Excel</h1>
			<p>In this section, we will dig<a id="_idIndexMarker918"/> into the ways<a id="_idIndexMarker919"/> you can call R and Python from Excel using the tools set up in the previous section. We will cover several ways of achieving this and give examples so that you can try them out as well.</p>
			<h2 id="_idParaDest-205"><a id="_idTextAnchor224"/>Executing R with VBA and BERT</h2>
			<p>Another great way of calling<a id="_idIndexMarker920"/> R from Excel<a id="_idIndexMarker921"/> is via the VBA<a id="_idIndexMarker922"/> macro. This requires<a id="_idIndexMarker923"/> that a workbook be saved as a macro-enabled workbook. Since BERT is designed to work from Excel to R, the syntax of an R expression can be written in the VBA console and called with the following in VBA:</p>
			<pre class="console">
Application.Run "BERT.Exec", r</pre>			<p>Let’s look at an easy example:</p>
			<pre class="source-code">
Sub PlotNormalDensity()
    r = "plot(density(rnorm(1000)))"
    Application.Run "BERT.Exec", r
End Sub</pre>			<p>This will end up producing a plot<a id="_idIndexMarker924"/> of the density<a id="_idIndexMarker925"/> of a random<a id="_idIndexMarker926"/> normal<a id="_idIndexMarker927"/> distribution. Let’s see the output:</p>
			<div><div><img src="img/B19142_11_04.jpg" alt="Figure 11.4 – Using BERT to call R from VBA"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.4 – Using BERT to call R from VBA</p>
			<h2 id="_idParaDest-206"><a id="_idTextAnchor225"/>Interacting with Excel via BERT</h2>
			<p>It is possible to manipulate<a id="_idIndexMarker928"/> Excel with BERT<a id="_idIndexMarker929"/> using the <strong class="bold">Excel Scripting Interface</strong>. You may ask yourself, “Why would<a id="_idIndexMarker930"/> I want to do such a thing”? Well, remember, with BERT, you have access to not only Excel but R as well. This means that you can use R functions that may not exist in Excel to generate data; let’s see an example. This was done in the left pane.</p>
			<p>First, we will define a range:</p>
			<pre class="source-code">
rng &lt;- EXCEL$Application$get_Range( "A1:B4" )</pre>			<p>This will define a range<a id="_idIndexMarker931"/> in R for the<a id="_idIndexMarker932"/> cells <code>A1:B4 </code>and will place it in the global environment as a variable called <code>rng</code>. This was typed into BERT’s R interface. Now that this range is defined, it is possible to see how many range commands are at your fingertips and what some of them are:</p>
			<pre class="source-code">
&gt; length(ls(rng))
[1] 234
&gt; head(ls(rng))
[1] "Activate"                        "AddComment"
                   "AddCommentThreaded"
[4] "AdvancedFilter"         "AllocateChanges"       "ApplyNames"</pre>			<p>So, we see that there are 234 range commands available. By calling <code>ls(rng)</code>, the R console will print out all of the commands; here, we use <code>head()</code> so that only the first few are shown. Here, we are going to use the <code>RAND()</code> Excel command to place random numbers into the defined range:</p>
			<pre class="source-code">
rng$put_Formula("=RAND()");</pre>			<p>Let’s take a look at the output in the Excel file:</p>
			<div><div><img src="img/B19142_11_05.jpg" alt="Figure 11.5 – Using the RAND() function from BERT in Excel"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.5 – Using the RAND() function from BERT in Excel</p>
			<p>If we want to stay inside of BERT<a id="_idIndexMarker933"/> and see the values that were sent to Excel, we can<a id="_idIndexMarker934"/> do the following:</p>
			<pre class="source-code">
&gt; rng$get_Value()
                        [,1]            [,2]
[1,] 0.63474248 0.7993663
[2,] 0.55409965 0.4134328
[3,] 0.86992109 0.7948257
[4,] 0.07100827 0.9219299</pre>			<p>Now that we have gone over some basics of how to work with Excel via R, it is time to see how we can achieve similar things in Python.</p>
			<h1 id="_idParaDest-207"><a id="_idTextAnchor226"/>Calling Python from Excel using xlwings</h1>
			<p>You have three options<a id="_idIndexMarker935"/> to call Python from Excel using <code>xlwings</code>:</p>
			<ul>
				<li>The <code>Run</code> button under the <code>xlwings </code>tab of the ribbon</li>
				<li>Macros: These call Python from Excel</li>
				<li><strong class="bold">User Defined Functions </strong>(<strong class="bold">UDFs</strong>) (Windows only)</li>
			</ul>
			<p>Let’s have a look at the pros and cons of all three, as well as an example!</p>
			<h2 id="_idParaDest-208"><a id="_idTextAnchor227"/>The Run button</h2>
			<p>The <code>Run</code> button expects<a id="_idIndexMarker936"/> a function called <code>main </code>in a Python<a id="_idIndexMarker937"/> module with the same name as your workbook. This is a quote from the documentation and a hard prerequisite. The main benefit of this method is that there is no VBA and no macros; you can use a normal XLSX file, which can be very useful in security-restricted situations where XLSM files are not allowed.</p>
			<p>To try out the <code>Run </code>button, follow these steps:</p>
			<ol>
				<li>Create a Python module called <code>sumitup.py </code>with the following code:<pre class="source-code">
import xlwings as xw
def main():
            wb = xw.Book.caller()
            a = wb.sheets[0]['A1'].value
            b = wb.sheets[0]['A2'].value
            wb.sheets[0]['A3'].value = a + b
            pass</pre></li>				<li>Open Excel and fill cell A1 with <code>2 </code>and cell A2 with <code>3</code>.</li>
				<li>Save the Excel sheet as <code>sumitup.xlsx</code> in the same folder where <code>sumitup.py</code> is saved.</li>
				<li>Click the <code>Run </code>button in the <code>xlwings</code> menu in the Ribbon.</li>
			</ol>
			<p>The cons of this method are the strict naming convention and file placement, and the lack of flexibility; only the function <code>main()</code> will be called, and the Python code needs to encode which fields will be used as input and where the output will go, meaning you cannot pass on inputs<a id="_idIndexMarker938"/> to the function<a id="_idIndexMarker939"/> from the Excel side.</p>
			<h2 id="_idParaDest-209"><a id="_idTextAnchor228"/>Macros</h2>
			<p>If you require more<a id="_idIndexMarker940"/> flexibility, and you<a id="_idIndexMarker941"/> can use a macro (and save your file as XLSM), you can use <code>RunPython</code> from VBA.</p>
			<p>In this example, <code>RunPython</code> will import the <code>world </code>module and run the <code>helloworld() </code>function from that module. To run this example, try the following steps:</p>
			<ol>
				<li>Create a <code>.xlsm </code>file and save it as <code>world.xlsm</code>.</li>
				<li>Open the VBA editor and try the following:<ol><li class="upper-roman">Open <code>xlwings </code>is checked:</li></ol></li>
			</ol>
			<p class="IMG---Figure">    </p>
			<div><div><img src="img/B19142_11_06.jpg" alt="Figure 11.6 – Adding the xlwings reference to the VBA project"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.6 – Adding the xlwings reference to the VBA project</p>
			<ol>
				<li class="upper-roman" value="2">Create a new macro<a id="_idIndexMarker942"/> in the file<a id="_idIndexMarker943"/> with <code>Sub</code> as follows:<pre class="source-code">
  Sub HelloWorld()
           RunPython "import world; world.helloworld()"
End Sub</pre></li>			</ol>
			<ol>
				<li value="3">Create the <code>hello.py</code> module in the same folder where you saved the <code>.xlsm</code> file with the following content:<pre class="source-code">
import xlwings as xw
def helloworld():
    wb = xw.Book.caller()
    wb.sheets[0]['A1'].value = 'Hello World!'</pre></li>				<li>Now, you can run the macro in <code>world.xlsm</code> and see the results!</li>
			</ol>
			<p>As you can see, using macros addresses one of the cons of the <code>Run </code>button, namely the location and name of the Python module(s) and function(s) used. However, you still cannot pass on inputs directly from the Excel file; the inputs have to be in pre-determined cells in the Excel file, and the output cell(s) have to be pre-determined as well.</p>
			<p>Note that you can change both the name of the module (to not match the name of the Excel file) and the location<a id="_idIndexMarker944"/> of the module (i.e., have it saved in a different folder than the <code>.xlsm</code> file). From the <code>xlwings</code> documentation, it reads<a id="_idIndexMarker945"/> that “<em class="italic">Per default, RunPython expects world.py in the same directory as the Excel file with the same name, but you can change both of these things: if your Python file is in a different folder, add that folder to the PYTHONPATH in the config. If the file has a different name, change the RunPython </em><em class="italic">command accordingly</em>.”</p>
			<h2 id="_idParaDest-210"><a id="_idTextAnchor229"/>UDFs</h2>
			<p>User-defined functions<a id="_idIndexMarker946"/> allow the user to extend Excel<a id="_idIndexMarker947"/> to add custom functions that can be used in the same way as <code>SUM()</code> and <code>IF()</code>.</p>
			<p>Writing a UDF in Python with <code>xlwings</code> is as easy, as seen here:</p>
			<pre class="source-code">
import xlwings as xw
import numpy as np
@xw.func
@xw.arg('x', np.array, ndim=2)
@xw.arg('y', np.array, ndim=2)
def matrix_add(x, y):
    return x + y</pre>			<p>In the preceding example, we specify that the inputs are both <code>numpy</code> array instances and define the function for matrix addition.</p>
			<p>To integrate Python functions into Excel using <code>xlwings</code>, you’ll need to set up your Python source file in a specific way. By default, <code>xlwings</code> expects a Python source file to be located in the same directory as your Excel file and to have the same name as the Excel file but with a <code>.py</code> extension instead of <code>.xlsm</code>.</p>
			<p>Alternatively, you can specify a specific module via the <code>xlwings</code> ribbon.</p>
			<p>Once you’ve prepared your Python<a id="_idIndexMarker948"/> source file, you can import<a id="_idIndexMarker949"/> the functions into Excel by following these steps:</p>
			<ol>
				<li>Save an Excel file with the same name as your Python module and save it as a <code>.xlsm</code> file in the same folder where the Python module is located.</li>
				<li>In Excel, go to the <code>xlwings</code> tab and click on <strong class="bold">Import Python UDFs </strong>to pick up the changes made to your Python module.</li>
				<li>Enter the data into two ranges in your Excel sheet (ensure that the dimensions of the ranges are appropriate for matrix multiplication).</li>
				<li>In a cell, enter the formula <code>=matrix_add([range1]</code>, <code>[range2])</code>, where <code>[range1] </code>and <code>[range2]</code> are the ranges where you have entered data.<p class="list-inset">You should see the correct result displayed in the cell:</p></li>
			</ol>
			<div><div><img src="img/B19142_11_07.jpg" alt="Figure 11.7 – Using the matrix_add function from xlwings to Excel"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.7 – Using the matrix_add function from xlwings to Excel</p>
			<p>The pro of this method is self-evident: the Excel user<a id="_idIndexMarker950"/> can determine what inputs<a id="_idIndexMarker951"/> to use and where the output should go without actually interacting with Python (or you, the Python developer).</p>
			<p>The con of the method is the generic one for <code>xlwings</code> and all similar solutions; for a local Python (or R) installation, all the dependencies must be correctly set up and the correct version must be made available to all users.</p>
			<p>Please be aware that UDFs do not work with Python, which is available from the Microsoft Store.</p>
			<p>It is noteworthy that alternatives exist, particularly PyXLL, which is a popular alternative to <code>xlwings</code>. It provides similar functionality with similar restrictions (including but not limited to not working with Python installed from the Microsoft Store).</p>
			<p>In this chapter, you have learned about why and how to call R and Python directly from Excel using the tools <code>BERT</code> and <code>xlwings</code>.</p>
			<p>In the next part of the chapter, we will look at another way of enacting such integration without the need for a local installation and staying in full control of the code and its version (which can be handy in enterprise settings) but with a need<a id="_idIndexMarker952"/> for a server<a id="_idIndexMarker953"/> environment instead.</p>
			<h1 id="_idParaDest-211"><a id="_idTextAnchor230"/>Calling R and Python from Excel via an API</h1>
			<p>An <strong class="bold">API</strong>, or <strong class="bold">Application Programming Interface</strong>, serves as a bridge between<a id="_idIndexMarker954"/> different software<a id="_idIndexMarker955"/> applications, allowing them to communicate and share data in a standardized way. It’s like a waiter at a restaurant who takes your order and conveys it to the kitchen, bringing back the meal once it’s ready.</p>
			<p>In the digital world, an API specifies how software components should interact. It defines the methods and data formats that applications can use to request and exchange information. APIs can be used for various purposes, such as accessing web services, databases, or even hardware devices.</p>
			<p>One fundamental use of APIs is enabling third-party developers to integrate their applications with existing services or platforms. In the context of your coding interests in R and Python, APIs can be utilized for data retrieval and for exposing your models to other software, including Excel.</p>
			<p>The beauty of APIs lies in their versatility. They abstract the complexity of underlying systems, providing a standardized way for developers to interact with them. This abstraction allows for more straightforward development and integration processes, fostering collaboration and innovation.</p>
			<p>In essence, APIs are the unsung heroes of the digital world, facilitating seamless communication between diverse software components and enabling the creation of more powerful and interconnected applications. Whether you’re working with data, web services, or other software, understanding and effectively using APIs can significantly enhance your capabilities as a programmer.</p>
			<p>In this section, we’re going to cover the following main topics:</p>
			<ul>
				<li>An introduction to APIs</li>
				<li>Open-source solutions for exposing R and Python as API endpoints</li>
				<li>Calling APIs from Excel for integration</li>
			</ul>
			<h1 id="_idParaDest-212"><a id="_idTextAnchor231"/>An introduction to APIs</h1>
			<p>You can think of APIs<a id="_idIndexMarker956"/> as a set of rules that will allow one piece of software to interact with another. A quick example of the usage of an API would be the weather app on a smartphone connecting with the weather system to get the current weather or a forecast of the weather.</p>
			<p>An easy way to think of an API, besides a mechanism for different systems to communicate, is to think of a contract. The documentation of an API will specify how a system can connect with and talk with the system, what it is allowed to do, and how often.</p>
			<p>Systems that maintain an API will often act as a sort of client and server type arrangement. A REST API<a id="_idIndexMarker957"/> is one of the most popular types of API today. <strong class="bold">REST </strong>stands for <strong class="bold">representational state transfer</strong>. The major pro of this type of API is that it is stateless. Statelessness means that servers do not save client data between requests. The requests that are sent to the server will remind you of a URL. A generic REST API call might look like the following:</p>
			<pre class="console">
 GET https://example.com/api/v1/users</pre>			<p>You could think of the preceding as obtaining a list of users, and you might think that you would obtain a list because this was a <code>GET</code> request. Here is a generic <code>POST</code> request:</p>
			<pre class="source-code">
POST https://example.com/api/v1/users
Content-Type: application/json
{
  "name": "John Doe",
  "email": "john.doe@example.com"
}</pre>			<p>Here, you have posted (<code>POST</code>) data to the server. So, with a REST API, think of posting and getting information from and to the server.</p>
			<p>Now that we understand what an API is and some of the types and use cases they have, we can now move on to taking a look at open-source solutions for exposing R/Python as an API endpoint.</p>
			<h1 id="_idParaDest-213"><a id="_idTextAnchor232"/>Open source solutions for exposing R as API endpoints</h1>
			<p>We are going to start off by first<a id="_idIndexMarker958"/> showing how to expose<a id="_idIndexMarker959"/> R as an API endpoint via the plumber package. The plumber package and its associated documentation<a id="_idIndexMarker960"/> can be found at the following URL: <a href="https://www.rplumber.io/index.html">https://www.rplumber.io/index.html</a>.</p>
			<p>The first thing we will do is build out a very simple single-argument API to obtain the histogram of a standard normal distribution. Let’s take a look at the code; we will then discuss what is happening inside of it:</p>
			<pre class="source-code">
#* Plot out data from a random normal distribution
#* @param .mean The mean of the standard normal distribution
#* @get /plot
#* @serializer png
function(.mean) {
  mu &lt;- as.numeric(.mean)
  hist(rnorm(n = 1000, mean = mu, sd = 1))
}</pre>			<p>The lines starting with <code>#* </code>are comments. In the plumber API, these comments are special and are used for documentation. They describe what the API endpoint does and provide information about the parameters. The first comment introduces the purpose of the API endpoint. It states that the API will generate a plot based on data from a random normal distribution. The line <code>#* @param .mean The mean of the standard normal deviation </code>describes a parameter called <code>.mean</code>, representing the mean of the standard normal distribution. Parameters in plumber APIs are like inputs that can be passed to the API when making a request.</p>
			<p>The following <code>#* @get /plot </code>comment specifies that this API endpoint can be accessed using an <code>HTTP GET </code>request, and the endpoint path is <code>/plot</code>. In simpler terms, if you want to use this API, you’d request something like <a href="http://your-api-url/plot">http://your-api-url/plot</a>. The function is defined as follows: <code>function(.mean)</code>; here, the actual R function starts. It takes a parameter, <code>.mean</code>, which is the mean of the standard normal distribution. In order for the argument to be passed to the <code>rnorm() </code>function itself, we must make sure that we declare it as a numeric data type. We do this internally as follows: <code>mu &lt;- as.numeric(.mean)</code>, where the parameter <code>.mean </code>is converted to a numeric value and stored in a variable called <code>mu</code>. After we convert the argument into a numeric, we can pass it off to <code>rnorm() </code>and <code>hist() </code>in order to create the plot.</p>
			<p>Finally, we are at the point where we generate and plot the data. This is done with the following bit of code: <code>hist(rnorm(n = 1000, mean = mu, sd = 1))</code>: This line generates <code>1000 </code>random numbers from a normal distribution with the specified mean (<code>mu</code>) and standard deviation (<code>sd = 1</code>). Then, it creates a histogram of these numbers. Essentially, it’s generating random data and plotting a histogram.</p>
			<p>In summary, this plumber<a id="_idIndexMarker961"/> API, when deployed, creates<a id="_idIndexMarker962"/> an endpoint (<code>/plot</code>) that, when accessed with a mean value, generates a histogram plot based on random data from a normal distribution. The mean is a parameter that you provide when making a request to this API. It’s a simple yet powerful example of how you can use R and plumber to expose data processing capabilities over the web.</p>
			<p>Now that we have generated the code that will produce the API, let’s look at the output once the code is run. To do so, let’s see the following script:</p>
			<pre class="source-code">
# Library Load
library(plumber)
# Set dir and file path
wd &lt;- getwd()
sub_dir &lt;- paste0("/Chapter 11/")
full_dir &lt;- paste0(wd, sub_dir)
f &lt;- "plumber_api.R"
f_path &lt;- paste0(full_dir, f)
# Initiate root
root &lt;- pr(f_path)
root
# Plumber router with 1 endpoint, 4 filters, and 0 sub-routers.
# Use `pr_run()` on this object to start the API.
├──[queryString]
├──[body]
├──[cookieParser]
├──[sharedSecret]
└──/plot (GET)</pre>			<p>Let’s give a line-by-line explanation:</p>
			<pre class="source-code">
# Library Load
library(plumber)</pre>			<p>This line loads the <code>plumber</code> package, which is required to create plumber APIs:</p>
			<pre class="source-code">
# Set dir and file path
wd &lt;- getwd()
sub_dir &lt;- paste0("/Chapter 11/")
full_dir &lt;- paste0(wd, sub_dir)
f &lt;- "plumber_api.R"
f_path &lt;- paste0(full_dir, f)</pre>			<p>These lines set<a id="_idIndexMarker963"/> the directory <a id="_idIndexMarker964"/>and file path of the <code>plumber </code>API file. The <code>getwd() </code>function returns the working directory, which is the current directory that R is using. The <code>paste0(</code>) function is used to concatenate strings, so the <code>sub_dir </code>variable contains the string <code>/Chapter11/</code>, and the <code>full_dir </code>variable contains the path to the <code>/Chapter12/ </code>directory. The <code>f </code>variable contains the filename of the plumber API file, which is <code>plumber_api.R</code>. The <code>f_path </code>variable contains the full path to the plumber API file, which is the combination of the <code>full_dir </code>and <code>f</code> variables:</p>
			<pre class="source-code">
# Initiate root
root &lt;- pr(f_path)</pre>			<p>This line initiates the plumber API by calling the <code>pr() </code>function with the <code>f_path </code>variable as the argument. The <code>pr() </code>function reads the plumber API file and creates a plumber API object:</p>
			<pre class="source-code">
root</pre>			<p>This line simply returns the <code>root </code>variable, which is the plumber API object. The R code provided creates a plumber API from a file called <code>plumber_api.R</code>. The plumber API can then be used to expose R functions as web endpoints.</p>
			<p>Let’s use a simple analogy: Imagine<a id="_idIndexMarker965"/> that you have a restaurant<a id="_idIndexMarker966"/> and want to offer a delivery service. You could create a simple website that allows customers to order food online. The website would need to be able to communicate with your restaurant’s kitchen to place orders. In this analogy, the plumber API is like the website, and the R functions are like the restaurant’s kitchen. The plumber API allows you to expose R functions to the outside world so that other applications can communicate with them. Now let’s run the API and see what happens; we do this with the following code: <code>pr_run(root)</code>:</p>
			<div><div><img src="img/B19142_11_08.jpg" alt="Figure 11.8 – plumber GET API"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.8 – plumber GET API</p>
			<p>We see that when we run<a id="_idIndexMarker967"/> the preceding code, we get a screen<a id="_idIndexMarker968"/> back that will allow us to test out the API; so, let’s do just that.</p>
			<p>To do that, we can click on the <strong class="bold">GET </strong>button, as this is a GET API call. When we do that, we get the following screen:</p>
			<div><div><img src="img/B19142_11_09.jpg" alt="Figure 11.9 – Enter arguments for API"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.9 – Enter arguments for API</p>
			<p>We see that we can enter<a id="_idIndexMarker969"/> an argument<a id="_idIndexMarker970"/> to the parameter of <code>.mean</code>; let’s enter <code>10</code>. First, click the <strong class="bold">Try it out </strong>button, and then you can enter a value; then, you can hit <strong class="bold">Execute</strong>, as shown in the following screenshot:</p>
			<div><div><img src="img/B19142_11_10.jpg" alt="Figure 11.10 – Enter the argument and click Execute"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.10 – Enter the argument and click Execute</p>
			<p>Now, let’s hit that <code>curl</code> request:</p>
			<pre class="console">
curl -X GET "http://127.0.0.1:9220/plot?.mean=10" -H "accept: image/png"</pre>			<p>Next, we get the request URL:</p>
			<pre class="console">
http://127.0.0.1:9220/plot?.mean=10</pre>			<p>Last but not least, we get the histogram:</p>
			<div><div><img src="img/B19142_11_11.jpg" alt="Figure 11.11 – The histogram generated by the API call"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.11 – The histogram generated by the API call</p>
			<p>Now that we have learned<a id="_idIndexMarker973"/> how to build and use<a id="_idIndexMarker974"/> the API for R, we will learn how to do the same for Python in the next section.</p>
			<h1 id="_idParaDest-214"><a id="_idTextAnchor233"/>Open-source solutions for exposing Python as an API endpoint</h1>
			<p><code>FastAPI </code>is a modern, fast (high-performance) web framework<a id="_idIndexMarker975"/> for building APIs<a id="_idIndexMarker976"/> with Python 3.7+ based on standard Python-type hints. It’s easy to use and allows you to create robust APIs quickly.</p>
			<p>You can install FastAPI using <code>pip</code>:</p>
			<pre class="console">
pip install fastapi</pre>			<p>The following is a simplified example of creating a <code>FastAPI </code>endpoint to expose a Python function:</p>
			<pre class="source-code">
from fastapi import FastAPI, Query
app = FastAPI()
@app.get("/api/add")
def add_numbers(
    num1: int = Query(..., description="First number"),
    num2: int = Query(..., description="Second number"),
):
    result = num1 + num2
    return {"result": result}</pre>			<p>In this example, the <code>add_numbers </code>function available at the <code>/api/add </code>endpoint takes two query parameters (<code>num1 </code>and <code>num2</code>), representing the numbers to be added. The <code>Query </code>function from FastAPI is used to define these parameters with optional descriptions. The result is then calculated, and a JSON response containing the result is returned.</p>
			<p>With this example, you can now send a <code>GET </code>request to /<code>api/add?num1=3&amp;num2=4 </code>to get the result. The <code>num1 </code>and <code>num2 </code>parameters are specified in the query string of the URL.</p>
			<p><code>FastAPI </code>automatically generates OpenAPI and JSON Schema documentation, making it convenient for users to understand and interact with your API.</p>
			<p>To run the development server, run the following from the command line:</p>
			<pre class="console">
uvicorn your_app_name:app --reload</pre>			<p>Replace <code>your_app_name </code>with the name of your Python file, keeping in mind that the python file name should be different<a id="_idIndexMarker977"/> than <code>fastapi</code> or similar to the previously<a id="_idIndexMarker978"/> installed module.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">Ensure that your API is secured, especially if it’s accessible over the internet. <code>FastAPI </code>provides features for handling authentication and authorization.</p>
			<p>We have covered creating an API for both R and Python. It is time to call the API we have created from Excel!</p>
			<h1 id="_idParaDest-215"><a id="_idTextAnchor234"/>Calling APIs from Excel VBA</h1>
			<p>Now, we are going<a id="_idIndexMarker979"/> to go over the code<a id="_idIndexMarker980"/> that will allow us to use a <code>curl </code>request to obtain the image from the API that was generated from the <code>plumber_api.R </code>file. In order to do this, you will have to run the code from the previous section: <code>root |&gt; pr_run()</code>; this is the portion that will open up the swagger dialogue and give you the URL that is running from <code>plumber</code>. For me, at the time of this writing, it is as follows: <code>http://127.0.0.1:6855</code>.</p>
			<p>In this section, we are going to specifically execute the <code>GET </code>request via a <code>curl</code> command in VBA. Here is the code that will run, and the explanation will follow:</p>
			<pre class="source-code">
Sub MakeCurlRequestAndInsertImage()
       ' Define the curl command
       Dim curlCommand As String
       curlCommand = "curl -X GET ""http://127.0.0.1:6855/plot?.mean=0"" -H ""accept: image/png"" -o " &amp; Environ("TEMP") &amp; "\temp_image.png"
       ' Run the curl command using Shell
       Shell "cmd /c " &amp; curlCommand, vbHide
       ' Create a new worksheet or refer to an existing one (Sheet1)
       Dim ws As Worksheet
       Set ws = ActiveWorkbook.Worksheets("Sheet1")
       ' Clear previous content in Sheet1
       ws.Cells.Clear
       ' Insert the image into the worksheet
       ws.Pictures.Insert(Environ("TEMP") &amp; "\temp_image.png").Select
End Sub</pre>			<p>Let’s break down<a id="_idIndexMarker981"/> the code step by step<a id="_idIndexMarker982"/> in simple terms:</p>
			<p>Define the <code>curl</code> command:</p>
			<pre class="console">
Dim curlCommand As String
curlCommand = "curl -X GET ""http://127.0.0.1:6855/plot?.mean=0"" -H ""accept: image/png"" -o " &amp; Environ("TEMP") &amp; "\temp_image.png"</pre>			<p>This part creates a variable (<code>curlCommand</code>) to store a command-line instruction. The command is essentially telling the computer to use <code>curl </code>(a command-line tool for making HTTP requests) to get an image<a id="_idIndexMarker983"/> from the specified web<a id="_idIndexMarker984"/> address (<code>http://127.0.0.1:6855/plot?.mean=0</code>). All of this goes on a single line in the VBA editor. The <code>-H </code>flag specifies an HTTP header, in this case, telling the server that we accept an image in PNG format. The <code>-o</code> flag specifies the output file, and it’s set to save the image in the temporary folder with the name <code>temp_image.png</code>.</p>
			<p>Run the <code>curl</code> command using <code>Shell</code>:</p>
			<pre class="console">
Shell "cmd /c " &amp; curlCommand, vbHide</pre>			<p>This line executes the <code>curlCommand</code> using the Windows Command Prompt (<code>cmd /c</code>).  The <code>vbHide</code> at the end means that the command prompt window will not be visible while executing:</p>
			<pre class="source-code">
Create or refer to a worksheet (Sheet1):
Dim ws As Worksheet
Set ws = ActiveWorkbook.Worksheets("Sheet1")</pre>			<p>This part creates a variable (<code>ws</code>) to represent a worksheet in Excel. It either creates a new worksheet named <code>"Sheet1"</code> or refers to an existing one in the active workbook.</p>
			<p>Clear the previous content in <code>Sheet1</code>:</p>
			<pre class="source-code">
ws.Cells.Clear</pre>			<p>This line removes any existing content in the specified worksheet (<code>"Sheet1"</code>).</p>
			<p>Insert the image into the worksheet:</p>
			<pre class="source-code">
ws.Pictures.Insert(Environ("TEMP") &amp; "\temp_image.png").Select</pre>			<p>This line inserts the image downloaded by the <code>curl</code> command into the specified worksheet (<code>"Sheet1"</code>). <code>Environ("TEMP") </code>refers to the system’s temporary folder. <code>"\temp_image.png"</code> is the name of the image file downloaded by the <code>curl</code> command.</p>
			<p>In summary, this VBA code automates the process of using the <code>curl</code> command to download an image from a web address and then inserts that image into an Excel worksheet named <code>Sheet1</code>. The worksheet<a id="_idIndexMarker985"/> is cleared first to ensure<a id="_idIndexMarker986"/> no previous content remains.</p>
			<p>Now, let’s see the output from the VBA script:</p>
			<div><div><img src="img/B19142_11_12.jpg" alt="Figure 11.12 – Histogram generated by R from VBA"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 11.12 – Histogram generated by R from VBA</p>
			<p>In this section, you have learned how to create an API via the plumber package in R. You have also learned how to call this API via a curl request inside of an Excel VBA macro.</p>
			<p>The beauty of an API-based solution is that Excel (and, in turn, your end-user) does not have to know that the code behind the API is written in R. The same macro could call an API written in Python without any changes!</p>
			<p>So, what are the pros and cons of this approach?</p>
			<p>The pros have been spelled out previously: no local installation, no need to maintain the R/Python environment for every user, and full control over the code running behind the API. Should you need to update anything, from the R/Python version via the package dependencies to the code itself, you can do this on the server side without involving your end user.</p>
			<p>One con is general to all API-based solutions: it requires a server to be set up and maintained, which usually is both too difficult and not allowed for data analysts and data scientists. This means dedicated IT resources are needed.</p>
			<p>A con specific to open source solutions for API hosting is one general to all open source solutions: what you save on license fees you pay in having to do more yourself. Open-source API solutions expect you to handle security (see the note at the end of the FastAPI section), the integration with the enterprise landscape (such as user management), and, generally, do everything yourself.</p>
			<p>Finally, a con of both <code>plumber</code> and <code>FastAPI</code> is the need to write custom code to define your API endpoints and functionality. In a single-person team, this is not a big issue other than the hours needed, but in larger teams, this often leads to a fractured landscape where it is difficult<a id="_idIndexMarker987"/> to enforce naming conventions<a id="_idIndexMarker988"/> and standardization.</p>
			<p>In the next section of this chapter, we will have a look at some of the most commonly used commercial solutions for hosting R and Python API endpoints and see how they address these questions.</p>
			<h2 id="_idParaDest-216"><a id="_idTextAnchor235"/>Commercial API solutions for R and Python</h2>
			<p>In this section, we will cover some of the most commonly used commercial API solutions for R and Python.</p>
			<h3>Azure Functions (and similar solutions from the other large cloud providers)</h3>
			<p><strong class="bold">Azure Functions </strong>is a serverless computing service<a id="_idIndexMarker989"/> offered by Microsoft<a id="_idIndexMarker990"/> Azure. It allows you to run event-triggered code without explicitly provisioning or managing infrastructure. You can build APIs, respond to events, and perform various tasks using a wide range of supported languages, including Python and JavaScript:</p>
			<ul>
				<li><strong class="bold">Use cases</strong>: Ideal for building lightweight, event-driven<a id="_idIndexMarker991"/> APIs or microservices. Integration with other Azure services provides scalability and flexibility.</li>
				<li><strong class="bold">Pro</strong>: A “serverless” infrastructure means<a id="_idIndexMarker992"/> minimal need for IT involvement.</li>
				<li><strong class="bold">Con</strong>: Limited flexibility (e.g., choice of R/Python version) and difficulty<a id="_idIndexMarker993"/> in migrating to other<a id="_idIndexMarker994"/> cloud providers.</li>
			</ul>
			<h3>Posit Connect</h3>
			<p><strong class="bold">Posit Connect </strong>is a commercial solution designed<a id="_idIndexMarker995"/> to connect R and Python<a id="_idIndexMarker996"/> to Excel. It facilitates the integration of analytics and data science directly into Excel workbooks, allowing users to leverage the power of R and Python within the familiar Excel interface.</p>
			<ul>
				<li><strong class="bold">Use cases</strong>: Particularly suitable for organizations<a id="_idIndexMarker997"/> where Excel is a primary tool for data analysis, providing a seamless way to enhance Excel’s capabilities with advanced analytics.</li>
				<li><strong class="bold">Pro</strong>: A deeply integrated <a id="_idIndexMarker998"/>ecosystem for Posit solutions, including RStudio, Quarto, and Shiny Pro.</li>
				<li><strong class="bold">Con</strong>: It utilizes plumber and FastAPI/Flask, so<a id="_idIndexMarker999"/> you will need to write custom code to define your API, leading to the drawbacks discussed under the open source API solutions. Only Linux servers are supported, both on-premise and in-cloud.</li>
			</ul>
			<h3>ownR Infinity platform</h3>
			<p><strong class="bold">ownR Infinity </strong>is a versatile platform designed<a id="_idIndexMarker1000"/> to empower R and Python<a id="_idIndexMarker1001"/> functionalities within a user-friendly environment. Enabling the creation of personalized functions and models transforms them into accessible APIs, with a particular focus on seamless integration within Excel.</p>
			<ul>
				<li><strong class="bold">Use cases</strong>: Suited for organizations<a id="_idIndexMarker1002"/> heavily reliant on R and Python for advanced data analytics. Perfect for users seeking to augment Excel’s capabilities with statistical and data analysis features.</li>
				<li><strong class="bold">Pros</strong>: Provides a user-friendly interface<a id="_idIndexMarker1003"/> for leveraging the capabilities of R and Python without extensive programming knowledge. Enables seamless integration of R and Python functionalities across various environments.</li>
				<li><strong class="bold">Con</strong>: Only Linux servers are<a id="_idIndexMarker1004"/> supported, both on-premises and in-cloud.</li>
			</ul>
			<p>For an example of how to use an ownR API from Excel, you can download an example workbook from here: <a href="https://bitbucket.org/functionalanalytics/examples/src/master/ccy%20converter%20Excel%20demo%20button.xlsm">https://bitbucket.org/functionalanalytics/examples/src/master/ccy%20converter%20Excel%20demo%20button.xlsm</a>.</p>
			<p>The example uses a hosted<a id="_idIndexMarker1005"/> API for the following code base: <a href="https://bitbucket.org/functionalanalytics/converter/src/master/">https://bitbucket.org/functionalanalytics/converter/src/master/</a></p>
			<p>Note that there is no need to write custom code beyond the pure Python code (or R code) and no need to add security, deployment, and other considerations manually, as these are automatically added by ownR.</p>
			<p>These commercial solutions provide high levels of integration and features for connecting Python and R with Excel and other frontends, catering to diverse use cases and preferences within the analytics and data science community.</p>
			<p>The pros of commercial solutions compared to open source ones boil down to the level of support and handholding with things such as out-of-the-box security, deeper and easier integration with the wider enterprise landscape, and a dedicated support organization in case of problems.</p>
			<p>The con is an obvious one: these solutions <a id="_idIndexMarker1006"/>have license fees that require a dedicated<a id="_idIndexMarker1007"/> budget. While all these companies aim at pricing in a way that the reduction of manual work and increased added value justify the price tag, a discussion with the budget holders is never easy.</p>
			<h1 id="_idParaDest-217"><a id="_idTextAnchor236"/>Summary</h1>
			<p>In this chapter, you have learned ways to call R and Python from Excel instead of the other way around to empower your end users even further. We have covered the reasons for doing so and two very different approaches: calling R and Python locally and via an API endpoint.</p>
			<p>For locally calling R and Python, we covered <code>BERT</code> and <code>xlwings</code> in detail, from setting up and testing the environment via creating R and Python solutions up to and including how to call those solutions from Excel using the various methods provided by <code>BERT</code> and <code>xlwings</code>, such as VBA code and UDFs.</p>
			<p>Next, you learned about API endpoints and the benefits of using an API endpoint to connect Python and R to Excel. We discussed the pros and cons of such a setup and then delved into the two flavors of API hosting: open source tools and commercial solutions. We have covered the two most used open source setups: plumber for R and FastAPI for Python. Finally, we had a look at commercial solutions for hosting R and Python API endpoints.</p>
			<p>The next (and last) chapter will cover a more domain-oriented topic: data analysis and visualization with Python and R in Excel.</p>
		</div>
	

		<div><h1 id="_idParaDest-218" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor237"/>Part 5: Data Analysis and Visualization with R and Python for Excel Data – A Case Study</h1>
		</div>
		<div><p>Delve into the world of data analysis and visualization within Excel using the power of Python and R. Through a captivating case study, you will discover how to leverage these versatile programming languages to uncover insights, visualize data, and drive informed decision-making directly within Excel.</p>
			<p>This part has the following chapter:</p>
			<ul>
				<li><a href="B19142_12.xhtml#_idTextAnchor238"><em class="italic">Chapter 12</em></a>, <em class="italic">Data Analysis and Visualization with R and Python in Excel – A Case Study</em></li>
			</ul>
		</div>
		<div><div></div>
		</div>
		<div><div></div>
		</div>
	</body></html>