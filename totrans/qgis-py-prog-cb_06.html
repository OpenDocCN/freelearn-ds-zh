<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;6.&#xA0;Composing Static Maps"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06" class="calibre1"/>Chapter 6. Composing Static Maps</h1></div></div></div><p class="calibre9">In this chapter, we will cover the following recipes:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Creating the simplest map renderer</li><li class="listitem">Using the map composer</li><li class="listitem">Adding labels to a map for printing</li><li class="listitem">Adding a scale bar to the map</li><li class="listitem">Adding a north arrow to the map</li><li class="listitem">Adding a logo to the map</li><li class="listitem">Adding a legend to the map</li><li class="listitem">Adding a custom shape to the map</li><li class="listitem">Adding a grid to the map</li><li class="listitem">Adding a table to the map</li><li class="listitem">Saving a map to a PNG image</li><li class="listitem">Adding a world file to a map image</li><li class="listitem">Saving a map to a project</li><li class="listitem">Loading a map from a project</li></ul></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Composing Static Maps">
<div class="book" title="Introduction"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch06lvl1sec106" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre9">In this chapter, we'll create maps using PyQGIS, Qt image objects, and QGIS Map Composer to create map layouts that can be exported as documents or images. The QGIS Map Composer is designed to create static map layouts with decorative and reference elements, for printing or inclusion in another document.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating the simplest map renderer"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec107" class="calibre1"/>Creating the simplest map renderer</h1></div></div></div><p class="calibre9">In order to turn a<a id="id492" class="calibre1"/> dynamic GIS map into a static map image or document, you must create a renderer to <span class="strong"><strong class="calibre2">freeze</strong></span><a id="id493" class="calibre1"/> the map view and create a graphic version of it. In this recipe, we'll render a map to a JPEG image and save it.</p></div>

<div class="book" title="Creating the simplest map renderer">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec305" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">You will need to download the following zipped shapefile and extract it to your <code class="literal">qgis_data</code> directory, to a subdirectory<a id="id494" class="calibre1"/> named <code class="literal">hancock</code>:</p><p class="calibre9">
<a class="calibre1" href="https://geospatialpython.googlecode.com/svn/hancock.zip">https://geospatialpython.googlecode.com/svn/hancock.zip</a>
</p><p class="calibre9">You will also need to open the <span class="strong"><strong class="calibre2">Python Console</strong></span> under the <span class="strong"><strong class="calibre2">Plugins</strong></span> menu in QGIS. You can run these lines of code inside the console.</p></div></div>

<div class="book" title="Creating the simplest map renderer">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec306" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">In this recipe, we will load our shapefile, add it to the map, create a blank image, set up the map view, render the map image, and save it. To do this, we need to perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we need to import the underlying <code class="literal">Qt</code> libraries required for image handling:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtGui import *</strong></span>
<span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
</pre></div></li><li class="listitem" value="2">Next, we load the layer and add it to the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyr = QgsVectorLayer("/qgis_data/hancock/hancock.shp", "Hancock", "ogr")</strong></span>
<span class="strong"><strong class="calibre2">reg = QgsMapLayerRegistry.instance()</strong></span>
<span class="strong"><strong class="calibre2">reg.addMapLayer(lyr)</strong></span>
</pre></div></li><li class="listitem" value="3">Now, we create a blank image to accept the map image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">i = QImage(QSize(600,600), QImage.Format_ARGB32_Premultiplied)</strong></span>
<span class="strong"><strong class="calibre2">c = QColor("white")</strong></span>
<span class="strong"><strong class="calibre2">i.fill(c.rgb())</strong></span>
<span class="strong"><strong class="calibre2">p = QPainter()</strong></span>
<span class="strong"><strong class="calibre2">p.begin(i)</strong></span>
</pre></div></li><li class="listitem" value="4">Then, we access the map renderer:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">r = QgsMapRenderer()</strong></span>
</pre></div></li><li class="listitem" value="5">Now, we get the IDs of the map layers:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyrs = reg.mapLayers().keys()</strong></span>
</pre></div></li><li class="listitem" value="6">Then, we use the newly initialized renderer layers in the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">r.setLayerSet(lyrs)</strong></span>
</pre></div></li><li class="listitem" value="7">Now, we get the full extent of the map as a rectangle:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">rect = QgsRectangle(r.fullExtent())</strong></span>
</pre></div></li><li class="listitem" value="8">Then, we <a id="id495" class="calibre1"/>set a scale for the renderer. Smaller numbers produce a larger map scale, and larger numbers produce a smaller map scale. We can change the map scale to create a buffer around the map image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">rect.scale(1.1)</strong></span>
</pre></div></li><li class="listitem" value="9">Next, we set the extent of the renderer to the rectangle:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">r.setExtent(rect)</strong></span>
</pre></div></li><li class="listitem" value="10">Now we set the output size and resolution of the image. The resolution is automatically calculated:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">r.setOutputSize(i.size(), i.logicalDpiX())</strong></span>
</pre></div></li><li class="listitem" value="11">Now, we can render the map and finalize the image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">r.render(p)</strong></span>
<span class="strong"><strong class="calibre2">p.end()</strong></span>
</pre></div></li><li class="listitem" value="12">Finally, we save the map image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">i.save("/qgis_data/map.jpg","jpg")</strong></span>
</pre></div></li><li class="listitem" value="13">Verify that you have a map image in your <code class="literal">qgis_data</code> directory, similar to the map displayed in QGIS.</li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Creating the simplest map renderer">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec307" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">QGIS uses the underlying Qt GUI library to create common image types. We haven't used any of the QGIS composer objects to render the image; however, this rendering technique is used to save maps created with the QGIS composer.</p></div></div>

<div class="book" title="Creating the simplest map renderer">
<div class="book" title="There's more..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec308" class="calibre1"/>There's more...</h2></div></div></div><p class="calibre9">The <code class="literal">QImage</code> object supports other image formats as well. To save a map image to a PNG, replace the last step in the <span class="strong"><em class="calibre10">How to do it…</em></span> section with the following code:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">i.save("/qgis_data/map.png","png")</strong></span>
</pre></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Using the map composer"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec108" class="calibre1"/>Using the map composer</h1></div></div></div><p class="calibre9">The <a id="id496" class="calibre1"/>QGIS Map Composer<a id="id497" class="calibre1"/> allows you to combine a map with nonspatial elements that help enhance our understanding of the map. In this recipe, we'll create a basic map composition. A composition requires you to define the physical paper size and output format. Even a simple composition example such as this has over 20 lines of configuration options.</p></div>

<div class="book" title="Using the map composer">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec309" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">You will need to download the following zipped shapefile and extract it to your <code class="literal">qgis_data</code> directory, to a subdirectory named <code class="literal">hancock</code>:</p><p class="calibre9">
<a class="calibre1" href="https://geospatialpython.googlecode.com/svn/hancock.zip">https://geospatialpython.googlecode.com/svn/hancock.zip</a>
</p><p class="calibre9">You will also need to open the <span class="strong"><strong class="calibre2">Python Console</strong></span> under the <span class="strong"><strong class="calibre2">Plugins</strong></span> menu in QGIS. You can run this recipe in the console or wrap it in a script for the <span class="strong"><strong class="calibre2">Script Runner</strong></span> plugin, using the template provided with the plugin.</p></div></div>

<div class="book" title="Using the map composer">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec310" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">In this recipe, the major steps are to load the shapefile into a map, build the map composition, and render it to an image, described as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we need to import the <code class="literal">Qt</code> libraries for image handling:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtGui import *</strong></span>
<span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
</pre></div></li><li class="listitem" value="2">Next, we load the layer and add it to the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyr = QgsVectorLayer("/qgis_data/hancock/hancock.shp", "Hancock", "ogr")</strong></span>
<span class="strong"><strong class="calibre2">reg = QgsMapLayerRegistry.instance()</strong></span>
<span class="strong"><strong class="calibre2">reg.addMapLayer(lyr)</strong></span>
</pre></div></li><li class="listitem" value="3">Now, we create a blank image to accept the map image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">i = QImage(QSize(600,600), QImage.Format_ARGB32_Premultiplied)</strong></span>
<span class="strong"><strong class="calibre2">c = QColor("white")</strong></span>
<span class="strong"><strong class="calibre2">i.fill(c.rgb())</strong></span>
<span class="strong"><strong class="calibre2">p = QPainter()</strong></span>
<span class="strong"><strong class="calibre2">p.begin(i)</strong></span>
</pre></div></li><li class="listitem" value="4">Next, we get the IDs of the map layers:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyrs = reg.mapLayers().keys()</strong></span>
</pre></div></li><li class="listitem" value="5">Then, we access the map renderer:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">mr = iface.mapCanvas().mapRenderer()</strong></span>
</pre></div></li><li class="listitem" value="6">We then use the newly initialized renderer layers in the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">mr.setLayerSet(lyrs)</strong></span>
</pre></div></li><li class="listitem" value="7">Now, we get the full extent of the map as a rectangle:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">rect = QgsRectangle(lyr.extent())</strong></span>
</pre></div></li><li class="listitem" value="8">Then, we set<a id="id498" class="calibre1"/> the scale for the renderer. Smaller numbers produce a larger map scale, and larger numbers produce a smaller map scale to add an image buffer around the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">rect.scale(1.2)</strong></span>
</pre></div></li><li class="listitem" value="9">Now, we set the map renderer's extent to the full map's extent:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">mr.setExtent(rect)</strong></span>
</pre></div></li><li class="listitem" value="10">Next, we begin using the QGIS composer by creating a new composition and assigning it the map renderer:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">c = QgsComposition(mr)</strong></span>
</pre></div></li><li class="listitem" value="11">Then, we set the composition style. We will define it as <code class="literal">Print</code>, which will allow us to create both PDF documents and images. The alternative is to define it as a postscript, which is often used for direct output to printer devices:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">c.setPlotStyle(QgsComposition.Print)</strong></span>
</pre></div></li><li class="listitem" value="12">Now, we define our paper size, which is specified in millimeters. In this case, we will use the equivalent of an 8.5 x 11 inch sheet of paper, which is the US letter size:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">c.setPaperSize(215.9, 279.4)</strong></span>
</pre></div></li><li class="listitem" value="13">Next, we'll calculate dimensions for the map so that it takes up approximately half the page and is centered:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">w, h = c.paperWidth() * .50, c.paperHeight() * .50</strong></span>
<span class="strong"><strong class="calibre2">x = (c.paperWidth() - w) / 2</strong></span>
<span class="strong"><strong class="calibre2">y = ((c.paperHeight() - h)) / 2 </strong></span>
</pre></div></li><li class="listitem" value="14">Then, we create the map composer object and set its extent:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">composerMap = QgsComposerMap(c,x,y,w,h)</strong></span>
<span class="strong"><strong class="calibre2">composerMap.setNewExtent(rect)</strong></span>
</pre></div></li><li class="listitem" value="15">Next, we give the map a frame around its border and add it to the page:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">composerMap.setFrameEnabled(True)</strong></span>
<span class="strong"><strong class="calibre2">c.addItem(composerMap)</strong></span>
</pre></div></li><li class="listitem" value="16">Now, we ensure that the resolution of the composition is set. The resolution defines how much detail the output contains. Lower resolutions contain less detail and create smaller files. Higher resolutions provide more image detail but create larger files:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">dpi = c.printResolution()</strong></span>
<span class="strong"><strong class="calibre2">c.setPrintResolution(dpi)</strong></span>
</pre></div></li><li class="listitem" value="17">We now convert <a id="id499" class="calibre1"/>the dots-per-inch resolution to dots-per-millimeter:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">   mm_in_inch = 25.4</strong></span>
<span class="strong"><strong class="calibre2">dpmm = dpi / mm_in_inch</strong></span>
<span class="strong"><strong class="calibre2">width = int(dpmm * c.paperWidth())</strong></span>
<span class="strong"><strong class="calibre2">height = int(dpmm * c.paperHeight())</strong></span>
</pre></div></li><li class="listitem" value="18">Next, we initialize the image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">image = QImage(QSize(width, height), QImage.Format_ARGB32)</strong></span>
<span class="strong"><strong class="calibre2">image.setDotsPerMeterX(dpmm * 1000)</strong></span>
<span class="strong"><strong class="calibre2">image.setDotsPerMeterY(dpmm * 1000)</strong></span>
<span class="strong"><strong class="calibre2">image.fill(0)</strong></span>
</pre></div></li><li class="listitem" value="19">Now, we render the composition:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">imagePainter = QPainter(image)</strong></span>
<span class="strong"><strong class="calibre2">sourceArea = QRectF(0, 0, c.paperWidth(), c.paperHeight())</strong></span>
<span class="strong"><strong class="calibre2">targetArea = QRectF(0, 0, width, height)</strong></span>
<span class="strong"><strong class="calibre2">c.render(imagePainter, targetArea, sourceArea)</strong></span>
<span class="strong"><strong class="calibre2">imagePainter.end()</strong></span>
</pre></div></li><li class="listitem" value="20">Finally, we save the composition as a JPEG image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">image.save("/Users/joellawhead/qgis_data/map.jpg", "jpg")</strong></span>
</pre></div></li></ol><div class="calibre14"/></div><p class="calibre9">Verify that the output image resembles the following sample image:</p><div class="mediaobject"><img src="../images/00047.jpeg" alt="How to do it..." class="calibre11"/></div><p class="calibre12"> </p></div></div>

<div class="book" title="Using the map composer">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec311" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">Map compositions<a id="id500" class="calibre1"/> are very powerful, but they can also be quite complex. You are managing the composition that represents a virtual sheet of paper. On that composition, you place objects, such as the map. Then, you must also manage the rendering of the composition as an image. All these items are independently configurable, which can sometimes lead to unexpected results with the sizing or visibility of items.</p></div></div>

<div class="book" title="Using the map composer">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec312" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre9">In the upcoming versions of QGIS, the map composer class may be renamed as the <code class="literal">print layout</code> class. You can find out more information about this proposed change at <a class="calibre1" href="https://github.com/qgis/QGIS-Enhancement-Proposals/pull/9">https://github.com/qgis/QGIS-Enhancement-Proposals/pull/9</a>
</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding labels to a map for printing"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec109" class="calibre1"/>Adding labels to a map for printing</h1></div></div></div><p class="calibre9">The <code class="literal">QgsComposition</code> object<a id="id501" class="calibre1"/> allows you to place arbitrary <a id="id502" class="calibre1"/>text anywhere<a id="id503" class="calibre1"/> in the composition. In this recipe, we'll demonstrate how to add a label to a map composition.</p></div>

<div class="book" title="Adding labels to a map for printing">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec313" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">You will need to download the following zipped shapefile and extract it to your <code class="literal">qgis_data</code> directory, to a subdirectory named <code class="literal">hancock</code>:</p><p class="calibre9">
<a class="calibre1" href="https://geospatialpython.googlecode.com/svn/hancock.zip">https://geospatialpython.googlecode.com/svn/hancock.zip</a>
</p><p class="calibre9">In addition<a id="id504" class="calibre1"/> to the shapefile, you will also need the <code class="literal">MapComposer</code> class. This<a id="id505" class="calibre1"/> class encapsulates the boilerplate composer code in a reusable way to make adding other elements easier. You can download it from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/MapComposer.py">https://geospatialpython.googlecode.com/svn/MapComposer.py</a>.</p><p class="calibre9">This file must be accessible from the QGIS Python console by ensuring that it is in the Python path directory. Place the file in the <code class="literal">.qgis2/python</code> directory within your home directory.</p></div></div>

<div class="book" title="Adding labels to a map for printing">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec314" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">To add a label to a composition, we'll first build the map composition, create a label, and then save the composition as an image. To do this, we need to perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we need to import the Qt GUI libraries and the <code class="literal">MapComposer</code> class:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtGui import *</strong></span>
<span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
<span class="strong"><strong class="calibre2">import MapComposer</strong></span>
</pre></div></li><li class="listitem" value="2">Next, we create a layer with the shapefile, setting the path to the shapefile in order to match your system:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyr = QgsVectorLayer("/Users/joellawhead/qgis_data/hancock/hancock.shp", "Hancock", "ogr")</strong></span>
</pre></div></li><li class="listitem" value="3">Now, we add this layer to the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">reg = QgsMapLayerRegistry.instance()</strong></span>
<span class="strong"><strong class="calibre2">reg.addMapLayer(lyr)</strong></span>
</pre></div></li><li class="listitem" value="4">Next, we access the map renderer:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">mr = iface.mapCanvas().mapRenderer()</strong></span>
</pre></div></li><li class="listitem" value="5">Then, we create a <code class="literal">MapComposer</code> object, passing in the map layer registry and the map renderer:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc = MapComposer.MapComposer(qmlr=reg, qmr=mr)</strong></span>
</pre></div></li><li class="listitem" value="6">Now, we create a new label object:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.label = QgsComposerLabel(qc.c)</strong></span>
</pre></div></li><li class="listitem" value="7">We can set the label text to any string:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.label.setText("Hancock County")</strong></span>
</pre></div></li><li class="listitem" value="8">We can automatically set the size of the label container to fit the string we used:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.label.adjustSizeToText()</strong></span>
</pre></div></li><li class="listitem" value="9">Now, we add a frame around the label box:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.label.setFrameEnabled(True)</strong></span>
</pre></div></li><li class="listitem" value="10">Then, we <a id="id506" class="calibre1"/>set the position of the label on the page, which is at the top-left corner of the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.label.setItemPosition(qc.x,qc.y-10)</strong></span>
</pre></div></li><li class="listitem" value="11">Next, we add the label the map composition now that it is configured:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.c.addItem(qc.label)</strong></span>
</pre></div></li><li class="listitem" value="12">Finally, we save the composition image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.output("/Users/joellawhead/qgis_data/map.jpg", "jpg")</strong></span>
</pre></div></li><li class="listitem" value="13">Verify that your output image has a text label in a frame at the top-left corner of the map.</li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Adding labels to a map for printing">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec315" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">In this case, we<a id="id507" class="calibre1"/> created a very simple label based on defaults. However, labels can be customized to change the font, size, color, and style for print-quality compositions. Also, note that the <span class="strong"><em class="calibre10">x</em></span>,<span class="strong"><em class="calibre10">y</em></span> values used to place items in a composition start in the upper-left corner of the page. As you move an item down the page, the <span class="strong"><em class="calibre10">y</em></span> value increases.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding a scale bar to the map"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec110" class="calibre1"/>Adding a scale bar to the map</h1></div></div></div><p class="calibre9">A scale bar is<a id="id508" class="calibre1"/> one of the most important elements of a map composition, as<a id="id509" class="calibre1"/> it defines the <a id="id510" class="calibre1"/>scale of the map to determine the ground distance on the map. QGIS composer allows you to create several different types of scale bars from a simple text scale ratio to a graphical, double scale bar with two measurement systems. In this recipe, we'll create a scale bar that measures in kilometres.</p></div>

<div class="book" title="Adding a scale bar to the map">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec316" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">You will need to download the following zipped shapefile and extract it to your <code class="literal">qgis_data</code> directory, to a subdirectory named <code class="literal">ms</code>:</p><p class="calibre9">
<a class="calibre1" href="https://geospatialpython.googlecode.com/svn/mississippi.zip">https://geospatialpython.googlecode.com/svn/mississippi.zip</a>
</p><p class="calibre9">In addition to the shapefile, you will also need the <code class="literal">MapComposer</code> class<a id="id511" class="calibre1"/>. This class encapsulates the boilerplate composer code in a reusable way to make adding other elements easier. You<a id="id512" class="calibre1"/> can download it from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/MapComposer.py">https://geospatialpython.googlecode.com/svn/MapComposer.py</a>.</p><p class="calibre9">This file must<a id="id513" class="calibre1"/> be accessible from the QGIS Python console; ensure that it is in the Python path directory. Place the file in the <code class="literal">.qgis2/python</code> directory within your home directory.</p><p class="calibre9">For the scale bar to <a id="id514" class="calibre1"/>display correctly, you must ensure that QGIS is set to automatically reproject data on the fly. In QGIS, go to the <span class="strong"><strong class="calibre2">Settings</strong></span> menu and select <span class="strong"><strong class="calibre2">Options</strong></span>. In the <span class="strong"><strong class="calibre2">Options</strong></span> dialog, select the <span class="strong"><strong class="calibre2">CRS</strong></span> panel. In the <span class="strong"><strong class="calibre2">Default CRS for new projects</strong></span> section, check the <span class="strong"><strong class="calibre2">Enable 'on the fly' reprojection by default</strong></span> radio button. Click on the <span class="strong"><strong class="calibre2">OK</strong></span> button to confirm the setting.</p></div></div>

<div class="book" title="Adding a scale bar to the map">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec317" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">First, we will generate the map, then we'll generate the composition, and finally we'll create the scale bar and place it in the lower-right corner of the map. To do this, we need to perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we need to import the libraries we'll need:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
<span class="strong"><strong class="calibre2">from PyQt4.QtGui import *</strong></span>
<span class="strong"><strong class="calibre2">from qgis.core import *</strong></span>
<span class="strong"><strong class="calibre2">from qgis.gui import *</strong></span>
<span class="strong"><strong class="calibre2">import MapComposer</strong></span>
</pre></div></li><li class="listitem" value="2">Then, we'll build the map renderer using the shapefile:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyr = QgsVectorLayer("/Users/joellawhead/qgis_data/ms/mmississippi.shp", "Mississippi", "ogr")</strong></span>
<span class="strong"><strong class="calibre2">reg = QgsMapLayerRegistry.instance()</strong></span>
<span class="strong"><strong class="calibre2">reg.addMapLayer(lyr)</strong></span>
<span class="strong"><strong class="calibre2">mr = iface.mapCanvas().mapRenderer()</strong></span>
</pre></div></li><li class="listitem" value="3">Next, we'll create the <code class="literal">MapComposer</code> object using the layer registry and map renderer:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc = MapComposer.MapComposer(qmlr=reg, qmr=mr)</strong></span>
</pre></div></li><li class="listitem" value="4">Now, we'll initialize the scale bar object:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.scalebar = QgsComposerScaleBar(qc.c)</strong></span>
</pre></div></li><li class="listitem" value="5">Then, we <a id="id515" class="calibre1"/>define the scale bar type. The default is a text scale, but we'll create a more traditional box scale bar:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.scalebar.setStyle('Single Box')</strong></span>
</pre></div></li><li class="listitem" value="6">Next, we<a id="id516" class="calibre1"/> apply the scale bar to the map and set the scale bar graphic to the default size:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.scalebar.setComposerMap(qc.composerMap)</strong></span>
<span class="strong"><strong class="calibre2">qc.scalebar.applyDefaultSize()</strong></span>
</pre></div></li><li class="listitem" value="7">We use the scale bar size, map size, and map position to calculate the desired position of the scale bar, in the lower-right corner of the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">sbw = qc.scalebar.rect().width()</strong></span>
<span class="strong"><strong class="calibre2">sbh = qc.scalebar.rect().height()</strong></span>
<span class="strong"><strong class="calibre2">mcw = qc.composerMap.rect().width()</strong></span>
<span class="strong"><strong class="calibre2">mch = qc.composerMap.rect().height()</strong></span>
<span class="strong"><strong class="calibre2">sbx = qc.x + (mcw - sbw)</strong></span>
<span class="strong"><strong class="calibre2">sby = qc.y + mch</strong></span>
</pre></div></li><li class="listitem" value="8">Then, we set the calculated position of the scale bar and add it to the composition:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.scalebar.setItemPosition(sbx, sby)</strong></span>
<span class="strong"><strong class="calibre2">qc.c.addItem(qc.scalebar)</strong></span>
</pre></div></li><li class="listitem" value="9">Finally, we save the composition to an image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.output("/Users/joellawhead/qgis_data/map.jpg", "jpg")</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Adding a scale bar to the map">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec318" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">The scale bar will display in kilometres if the map projection is set correctly, which is why it is important to have automatic reprojection enabled in the QGIS settings. The location of the scale bar within the composition is not important, as long as the <code class="literal">composerMap</code> object is applied to it.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding a north arrow to the map"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec111" class="calibre1"/>Adding a north arrow to the map</h1></div></div></div><p class="calibre9">North arrows <a id="id517" class="calibre1"/>are another <a id="id518" class="calibre1"/>common <a id="id519" class="calibre1"/>cartographic element found even in ancient maps, which show the orientation of the map relative to either true, gird, or magnetic north. Sometimes, these symbols can be quite elaborate. However, QGIS provides a basic line arrow element that we will use in combination with a map label to make a basic north arrow.</p></div>

<div class="book" title="Adding a north arrow to the map">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec319" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">You will need <a id="id520" class="calibre1"/>to download the following zipped shapefile and extract it to your <code class="literal">qgis_data</code> directory, to a subdirectory named <code class="literal">ms</code>:</p><p class="calibre9">
<a class="calibre1" href="https://geospatialpython.googlecode.com/svn/Mississippi.zip">https://geospatialpython.googlecode.com/svn/Mississippi.zip</a>
</p><p class="calibre9">In addition to<a id="id521" class="calibre1"/> the shapefile, you will also need the <code class="literal">MapComposer</code> class to simplify the code needed to add this one element. If you haven't already used it in a previous recipe, you can download it from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/MapComposer.py">https://geospatialpython.googlecode.com/svn/MapComposer.py</a>.</p><p class="calibre9">This file must be accessible from the QGIS Python Console; for this, you need to ensure that it is in the Python path directory. Place the file in the <code class="literal">.qgis2/python</code> directory within your home directory.</p></div></div>

<div class="book" title="Adding a north arrow to the map">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec320" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">In this recipe, we will create a map composition, draw an arrow to the right of the map, and then place a label with a capital letter <code class="literal">N</code> below the arrow. To do this, we need to perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we import the <code class="literal">Qt</code> and <code class="literal">MapComposer</code> Python libraries:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
<span class="strong"><strong class="calibre2">from PyQt4.QtGui import *</strong></span>
<span class="strong"><strong class="calibre2">from qgis.core import *</strong></span>
<span class="strong"><strong class="calibre2">from qgis.gui import *</strong></span>
<span class="strong"><strong class="calibre2">import MapComposer</strong></span>
</pre></div></li><li class="listitem" value="2">Next, we create the map composition object:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyr = QgsVectorLayer("/qgis_data/ms/mississippi.shp", "Mississippi", "ogr")</strong></span>
<span class="strong"><strong class="calibre2">reg = QgsMapLayerRegistry.instance()</strong></span>
<span class="strong"><strong class="calibre2">reg.addMapLayer(lyr)</strong></span>
<span class="strong"><strong class="calibre2">mr = iface.mapCanvas().mapRenderer()  </strong></span>
<span class="strong"><strong class="calibre2">qc = MapComposer.MapComposer(qmlr=reg, qmr=mr)</strong></span>
</pre></div></li><li class="listitem" value="3">Now, we calculate the position of the arrow along the right-hand side of the map, set its position, and then add it to the composition:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">mcw = qc.composerMap.rect().width()</strong></span>
<span class="strong"><strong class="calibre2">mch = qc.composerMap.rect().height()</strong></span>
<span class="strong"><strong class="calibre2">ax =  qc.x + mcw + 10</strong></span>
<span class="strong"><strong class="calibre2">ay =  (qc.y + mch) - 10</strong></span>
<span class="strong"><strong class="calibre2">afy = ay - 20</strong></span>
<span class="strong"><strong class="calibre2">qc.arrow = QgsComposerArrow(QPointF(ax, ay), QPointF(ax,afy), qc.c)</strong></span>
<span class="strong"><strong class="calibre2">qc.c.addItem(qc.arrow)</strong></span>
</pre></div></li><li class="listitem" value="4">Then, we <a id="id522" class="calibre1"/>create a capital letter <code class="literal">N</code> label and add<a id="id523" class="calibre1"/> it to the composition just below the arrow:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">f = QFont()</strong></span>
<span class="strong"><strong class="calibre2">f.setBold(True)</strong></span>
<span class="strong"><strong class="calibre2">f.setFamily("Times New Roman")</strong></span>
<span class="strong"><strong class="calibre2">f.setPointSize(30)</strong></span>
<span class="strong"><strong class="calibre2">qc.labelNorth = QgsComposerLabel(qc.c)</strong></span>
<span class="strong"><strong class="calibre2">qc.labelNorth.setText("N")</strong></span>
<span class="strong"><strong class="calibre2">qc.labelNorth.setFont(f)</strong></span>
<span class="strong"><strong class="calibre2">qc.labelNorth.adjustSizeToText()</strong></span>
<span class="strong"><strong class="calibre2">qc.labelNorth.setFrameEnabled(False)</strong></span>
<span class="strong"><strong class="calibre2">qc.labelNorth.setItemPosition(ax - 5, ay)  </strong></span>
<span class="strong"><strong class="calibre2">qc.c.addItem(qc.labelNorth)</strong></span>
</pre></div></li><li class="listitem" value="5">Finally, we save the composition to an image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.output("/qgis_data/map.jpg", "jpg")  </strong></span>
</pre></div></li></ol><div class="calibre14"/></div><p class="calibre9">Verify that your output image looks similar to the following:</p><div class="mediaobject"><img src="../images/00048.jpeg" alt="How to do it..." class="calibre11"/></div><p class="calibre12"> </p></div></div>

<div class="book" title="Adding a north arrow to the map">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec321" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">The QGIS composer<a id="id524" class="calibre1"/> doesn't <a id="id525" class="calibre1"/>have a dedicated north arrow or compass rose object. However, it is quite simple to construct one, as demonstrated in the preceding section. The arrow is just a graphic. The direction of the arrow is controlled by the location of the start point and the end point listed, respectively, when you create the <code class="literal">QgsComposerArrow</code> object.</p></div></div>

<div class="book" title="Adding a north arrow to the map">
<div class="book" title="There's more..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec322" class="calibre1"/>There's more...</h2></div></div></div><p class="calibre9">You can extend this example to have an arrow point in multiple compass directions. You can also use an image of a more elaborate compass rose added to the composition. We'll demonstrate how to add images in the next recipe. Note that the arrow element can also be used to point to items on the map with an associated label.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding a logo to the map"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec112" class="calibre1"/>Adding a logo to the map</h1></div></div></div><p class="calibre9">An important<a id="id526" class="calibre1"/> part of customizing a map is to add your logo or other graphics to<a id="id527" class="calibre1"/> the composition. In this recipe, we'll add a simple logo to the map.</p></div>

<div class="book" title="Adding a logo to the map">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec323" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">You will need to download the following zipped shapefile and extract it to your <code class="literal">qgis_data</code> directory, to a subdirectory named <code class="literal">ms</code>:</p><p class="calibre9">
<a class="calibre1" href="https://geospatialpython.googlecode.com/svn/Mississippi.zip">https://geospatialpython.googlecode.com/svn/Mississippi.zip</a>
</p><p class="calibre9">You will also need a logo image, which you can download from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/trunk/logo.png">https://geospatialpython.googlecode.com/svn/trunk/logo.png</a>.</p><p class="calibre9">Place the image in your <code class="literal">qgis_data/rasters</code>
 directory.</p><p class="calibre9">If you haven't already done so in the previous recipe, download the<a id="id528" class="calibre1"/> <code class="literal">MapComposer</code> library from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/MapComposer.py">https://geospatialpython.googlecode.com/svn/MapComposer.py</a>, to simplify the creation of the map composition.</p><p class="calibre9">Place the file in the <code class="literal">.qgis2/python</code> directory within your home directory.</p></div></div>

<div class="book" title="Adding a logo to the map">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec324" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">In this recipe, we will create the map composition, add the logo image, and save the map as an image. To do this, we need to perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we need to import the Qt GUI, core QGIS, QGIS GUI, and MapComposer libraries:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
<span class="strong"><strong class="calibre2">from PyQt4.QtGui import *</strong></span>
<span class="strong"><strong class="calibre2">from qgis.core import *</strong></span>
<span class="strong"><strong class="calibre2">from qgis.gui import *</strong></span>
<span class="strong"><strong class="calibre2">import MapComposer</strong></span>
</pre></div></li><li class="listitem" value="2">Next, we will build a basic map composition using the shapefile:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyr = QgsVectorLayer("/qgis_data/ms/mississippi.shp", "Mississippi", "ogr")</strong></span>
<span class="strong"><strong class="calibre2">reg = QgsMapLayerRegistry.instance()</strong></span>
<span class="strong"><strong class="calibre2">reg.addMapLayer(lyr)</strong></span>
<span class="strong"><strong class="calibre2">mr = iface.mapCanvas().mapRenderer()</strong></span>
<span class="strong"><strong class="calibre2">qc = MapComposer.MapComposer(qmlr=reg, qmr=mr)</strong></span>
</pre></div></li><li class="listitem" value="3">Now, we initialize the picture object:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.logo = QgsComposerPicture(qc.c)</strong></span>
</pre></div></li><li class="listitem" value="4">Then, we set <a id="id529" class="calibre1"/>the path of the picture to our image file:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.logo.setPictureFile("/qgis_data/rasters/logo.png")</strong></span>
</pre></div></li><li class="listitem" value="5">We<a id="id530" class="calibre1"/> must set the size of the box or scene rectangle such that it is large enough to contain the logo. Otherwise, the picture will appear cropped:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.logo.setSceneRect(QRectF(0,0,50,70))</strong></span>
</pre></div></li><li class="listitem" value="6">Next, we calculate the position of the logo relative to the map image. We'll place the logo near the top-left corner of the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lx = qc.x + 50</strong></span>
<span class="strong"><strong class="calibre2">ly = qc.y – 120</strong></span>
</pre></div></li><li class="listitem" value="7">Now, we set the logo's position and add it to the map composition:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">      mcw = qc.composerMap.rect().width()</strong></span>
<span class="strong"><strong class="calibre2">      mch = qc.composerMap.rect().height()</strong></span>
<span class="strong"><strong class="calibre2">      lx =  qc.x</strong></span>
<span class="strong"><strong class="calibre2">ly =  qc.y - 20</strong></span>
</pre></div></li><li class="listitem" value="8">Finally, we save the composition as an image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.output("/qgis_data/map.jpg", "jpg")</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Adding a logo to the map">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec325" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">This recipe is very straight forward, as the <code class="literal">QgsComposerPicture</code> is an extremely simple object. You can use JPG, PNG, or SVG images. This technique can be used to add custom north arrows or other cartographic elements as well.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding a legend to the map"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec113" class="calibre1"/>Adding a legend to the map</h1></div></div></div><p class="calibre9">A map legend<a id="id531" class="calibre1"/> decodes <a id="id532" class="calibre1"/>the symbology used in a thematic GIS map for the reader. Legends are tightly integrated into QGIS, and in this recipe, we'll add the default legend from the map to the print composition.</p></div>

<div class="book" title="Adding a legend to the map">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec326" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">Download the shapefile for this map from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/Mississippi.zip">https://geospatialpython.googlecode.com/svn/Mississippi.zip</a> and extract it to your <code class="literal">qgis_data</code> directory in a subdirectory named <code class="literal">ms</code>.</p><p class="calibre9">As with the previous recipes in this chapter, we will use the <code class="literal">MapComposer</code> library from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/MapComposer.py">https://geospatialpython.googlecode.com/svn/MapComposer.py</a> to simplify the creation of the map composition.</p><p class="calibre9">Place the file in the <code class="literal">.qgis2/python</code> directory within your home directory.</p></div></div>

<div class="book" title="Adding a legend to the map">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec327" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">This recipe<a id="id533" class="calibre1"/> is as<a id="id534" class="calibre1"/> simple as creating the map, adding the automatically generated legend, and saving the output to an image. To do this, we need to perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we will need to load the Qt and QGIS GUI libraries followed by the MapComposer library:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
<span class="strong"><strong class="calibre2">from PyQt4.QtGui import *</strong></span>
<span class="strong"><strong class="calibre2">from qgis.core import *</strong></span>
<span class="strong"><strong class="calibre2">from qgis.gui import *</strong></span>
<span class="strong"><strong class="calibre2">import MapComposer</strong></span>
</pre></div></li><li class="listitem" value="2">Next, we will load the shapefile as a layer and create the map composition with the <code class="literal">MapComposer</code> library, passing it the map layer registry and map renderer:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyr = QgsVectorLayer("/qgis_data/ms/mississippi.shp", "Mississippi", "ogr")</strong></span>
<span class="strong"><strong class="calibre2">reg = QgsMapLayerRegistry.instance()</strong></span>
<span class="strong"><strong class="calibre2">reg.addMapLayer(lyr)</strong></span>
<span class="strong"><strong class="calibre2">mr = iface.mapCanvas().mapRenderer()</strong></span>
<span class="strong"><strong class="calibre2">qc = MapComposer.MapComposer(qmlr=reg, qmr=mr)</strong></span>
</pre></div></li><li class="listitem" value="3">Now, we initialize the legend object:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.legend = QgsComposerLegend(qc.c)</strong></span>
</pre></div></li><li class="listitem" value="4">We now tell the legend which layer set we want to use:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.legend.model().setLayerSet(qc.qmr.layerSet())</strong></span>
</pre></div></li><li class="listitem" value="5">Then, we set the legend's position to the left-hand side of the map and add it to the composition:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.legend.setItemPosition(5, qc.y)</strong></span>
<span class="strong"><strong class="calibre2">qc.c.addItem(qc.legend)</strong></span>
</pre></div></li><li class="listitem" value="6">Finally, we output the composition to the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.output("/qgis_data/map.jpg", "jpg")</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Adding a legend to the map">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec328" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">Adding a legend is<a id="id535" class="calibre1"/> quite simple. QGIS will carry over the styling that is autogenerated when the layer is loaded or manually set by the user. Of course, you can also save layer styling, which is <a id="id536" class="calibre1"/>loaded with the layer and used by the legend. However, if you're generating a composition in the background such as in a standalone application, for example, every aspect of the legend is customizable through the PyQGIS API.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding a custom shape to the map"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec114" class="calibre1"/>Adding a custom shape to the map</h1></div></div></div><p class="calibre9">The QGIS composer <a id="id537" class="calibre1"/>has an object for drawing and styling nonspatial shapes, including rectangles, ellipses, and triangles. In this recipe, we'll add some rectangles filled <a id="id538" class="calibre1"/>with different colors, which will resemble a simple bar chart, as an example of using shapes.</p></div>

<div class="book" title="Adding a custom shape to the map">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec329" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">Download the zipped shapefile for this map from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/Mississippi.zip">https://geospatialpython.googlecode.com/svn/Mississippi.zip</a> and extract it to your <code class="literal">qgis_data</code> directory, to in a subdirectory named <code class="literal">ms</code>.</p><p class="calibre9">We will also use the <code class="literal">MapComposer</code> library from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/MapComposer.py">https://geospatialpython.googlecode.com/svn/MapComposer.py</a> to simplify the creation of the map composition.</p><p class="calibre9">Place the file in the <code class="literal">.qgis2/python</code> directory within your home directory.</p></div></div>

<div class="book" title="Adding a custom shape to the map">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec330" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">First, we will create a simple map composition with the shapefile. Then, we will define the style properties for our rectangles. Next, we will draw the rectangles, apply the symbols, and render the composition. To do this, we need to perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we must import the PyQGIS and Qt GUI libraries as well as the MapComposer library, as follows:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
<span class="strong"><strong class="calibre2">from PyQt4.QtGui import *</strong></span>
<span class="strong"><strong class="calibre2">from qgis.core import *</strong></span>
<span class="strong"><strong class="calibre2">from qgis.gui import *</strong></span>
<span class="strong"><strong class="calibre2">import MapComposer</strong></span>
</pre></div></li><li class="listitem" value="2">Next, we<a id="id539" class="calibre1"/> create the map composition by using the shapefile:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyr = QgsVectorLayer("/qgis_data/ms/mississippi.shp", "Mississippi", "ogr")</strong></span>
<span class="strong"><strong class="calibre2">reg = QgsMapLayerRegistry.instance()</strong></span>
<span class="strong"><strong class="calibre2">reg.addMapLayer(lyr)</strong></span>
<span class="strong"><strong class="calibre2">mr = iface.mapCanvas().mapRenderer()</strong></span>
<span class="strong"><strong class="calibre2">qc = MapComposer.MapComposer(qmlr=reg, qmr=mr)</strong></span>
</pre></div></li><li class="listitem" value="3">Now, we<a id="id540" class="calibre1"/> create three basic fill symbols by building Python dictionaries with color properties and initialize the symbols with these dictionaries:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">red = {'color':'255,0,0,255','color_border':'0,0,0,255'}</strong></span>
<span class="strong"><strong class="calibre2">redsym = QgsFillSymbolV2.createSimple(red)</strong></span>
<span class="strong"><strong class="calibre2">blue = {'color':'0,0,255,255','color_border':'0,0,0,255'}</strong></span>
<span class="strong"><strong class="calibre2">bluesym = QgsFillSymbolV2.createSimple(blue)</strong></span>
<span class="strong"><strong class="calibre2">yellow = {'color':'255,255,0,255','color_border':'0,0,0,255'}</strong></span>
<span class="strong"><strong class="calibre2">yellowsym = QgsFillSymbolV2.createSimple(yellow)</strong></span>
</pre></div></li><li class="listitem" value="4">Then, we calculate the y position of the first shape, relative to the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">mch = qc.composerMap.rect().height()</strong></span>
<span class="strong"><strong class="calibre2">sy = qc.y + mch</strong></span>
</pre></div></li><li class="listitem" value="5">We create the first shape and set it to the type 1, which is a rectangle:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.shape1 = QgsComposerShape(10,sy-25,10,25,qc.c)</strong></span>
<span class="strong"><strong class="calibre2">qc.shape1.setShapeType(1)</strong></span>
</pre></div></li><li class="listitem" value="6">Next, we tell the shape to use a symbol, set the symbol for one of our three fill symbols, and add the shape to the composition:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.shape1.setUseSymbolV2(True)</strong></span>
<span class="strong"><strong class="calibre2">qc.shape1.setShapeStyleSymbol(redsym)</strong></span>
<span class="strong"><strong class="calibre2">qc.c.addItem(qc.shape1)</strong></span>
</pre></div></li><li class="listitem" value="7">We repeat the process with two other shapes, changing their position, size, and symbols to make them look different:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.shape2 = QgsComposerShape(22,sy-18,10,18,qc.c)</strong></span>
<span class="strong"><strong class="calibre2">qc.shape2.setShapeType(1)</strong></span>
<span class="strong"><strong class="calibre2">qc.shape2.setUseSymbolV2(True)</strong></span>
<span class="strong"><strong class="calibre2">qc.shape2.setShapeStyleSymbol(bluesym)</strong></span>
<span class="strong"><strong class="calibre2">qc.c.addItem(qc.shape2)</strong></span>
<span class="strong"><strong class="calibre2">qc.shape3 = QgsComposerShape(34,sy-12,10,12,qc.c)</strong></span>
<span class="strong"><strong class="calibre2">qc.shape3.setShapeType(1)</strong></span>
<span class="strong"><strong class="calibre2">qc.shape3.setUseSymbolV2(True)</strong></span>
<span class="strong"><strong class="calibre2">qc.shape3.setShapeStyleSymbol(yellowsym)</strong></span>
<span class="strong"><strong class="calibre2">qc.c.addItem(qc.shape3)</strong></span>
</pre></div></li><li class="listitem" value="8">Finally, we output the composition as an image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.output("/qgis_data/map.jpg", "jpg")</strong></span>
</pre></div></li></ol><div class="calibre14"/></div><p class="calibre9">Verify <a id="id541" class="calibre1"/>that <a id="id542" class="calibre1"/>your output image looks similar to the following:</p><div class="mediaobject"><img src="../images/00049.jpeg" alt="How to do it..." class="calibre11"/></div><p class="calibre12"> </p></div></div>

<div class="book" title="Adding a custom shape to the map">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec331" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">This simple graphical output is nearly 40 lines of code. While there may be some limited uses for dealing with <a id="id543" class="calibre1"/>these shapes, in most cases, the simpler route will be to just import images. However, it provides a good foundation for a richer graphics API, as QGIS continues to evolve.</p></div></div>

<div class="book" title="Adding a custom shape to the map">
<div class="book" title="There's more..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec332" class="calibre1"/>There's more...</h2></div></div></div><p class="calibre9">If you are using fill symbols within a Python plugin in a QGIS version less than 2.6, you must ensure that the symbols are defined in the global scope, or QGIS will crash due to a bug. The easiest way to <a id="id544" class="calibre1"/>include the variables in the global scope is to define them immediately after the import statements. It also affects scripts that are run in the Script Runner plugin. This bug was fixed in version 2.6 and subsequent versions.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding a grid to the map"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec115" class="calibre1"/>Adding a grid to the map</h1></div></div></div><p class="calibre9">An <a id="id545" class="calibre1"/>annotated<a id="id546" class="calibre1"/> reference grid is useful for map products used to locate features. This recipe teaches you how to add both reference lines on a map and annotations for the lines around the edges of the map.</p></div>

<div class="book" title="Adding a grid to the map">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec333" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">You will need a shapefile for this map from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/Mississippi.zip">https://geospatialpython.googlecode.com/svn/Mississippi.zip</a>, and you need to extract it to your <code class="literal">qgis_data</code> directory, to a subdirectory named <code class="literal">ms</code>.</p><p class="calibre9">As with the previous recipes in this chapter, we will use the <code class="literal">MapComposer</code> library from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/MapComposer.py">https://geospatialpython.googlecode.com/svn/MapComposer.py</a> to simplify the creation of the map composition.</p><p class="calibre9">Place the file in the <code class="literal">.qgis2/python</code> directory within your home directory.</p></div></div>

<div class="book" title="Adding a grid to the map">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec334" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">In this recipe, the general steps are to create the map composition, establish the overall grid parameters, define the grid line placement, and then style the grid and annotations. To do this, we need to perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we need to import all the GUI libraries and the MapComposer library:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
<span class="strong"><strong class="calibre2">from PyQt4.QtGui import *</strong></span>
<span class="strong"><strong class="calibre2">from qgis.core import *</strong></span>
<span class="strong"><strong class="calibre2">from qgis.gui import *</strong></span>
<span class="strong"><strong class="calibre2">import MapComposer</strong></span>
</pre></div></li><li class="listitem" value="2">Next, we <a id="id547" class="calibre1"/>create the map composition using the shapefile:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyr = QgsVectorLayer("/qgis_data/ms/mmississippi.shp", "Mississippi", "ogr")</strong></span>
<span class="strong"><strong class="calibre2">reg = QgsMapLayerRegistry.instance()</strong></span>
<span class="strong"><strong class="calibre2">reg.addMapLayer(lyr)</strong></span>
<span class="strong"><strong class="calibre2">mr = iface.mapCanvas().mapRenderer()</strong></span>
<span class="strong"><strong class="calibre2">qc = MapComposer.MapComposer(qmlr=reg, qmr=mr)</strong></span>
</pre></div></li><li class="listitem" value="3">Now, we<a id="id548" class="calibre1"/> are going to create some variables to shorten some unusually long method and object names:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">setGridAnnoPos = qc.composerMap.setGridAnnotationPosition</strong></span>
<span class="strong"><strong class="calibre2">setGridAnnoDir = qc.composerMap.setGridAnnotationDirection</strong></span>
<span class="strong"><strong class="calibre2">qcm = QgsComposerMap</strong></span>
</pre></div></li><li class="listitem" value="4">Then, we enable the grid, set the line spacing, and use solid lines for the grid:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.composerMap.setGridEnabled(True)</strong></span>
<span class="strong"><strong class="calibre2">qc.composerMap.setGridIntervalX(.75)</strong></span>
<span class="strong"><strong class="calibre2">qc.composerMap.setGridIntervalY(.75)</strong></span>
<span class="strong"><strong class="calibre2">qc.composerMap.setGridStyle(qcm.Solid)</strong></span>
</pre></div></li><li class="listitem" value="5">Next, we enable the annotation numbers for coordinates and set the decimal precision to 0 for whole numbers:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.composerMap.setShowGridAnnotation(True)</strong></span>
<span class="strong"><strong class="calibre2">qc.composerMap.setGridAnnotationPrecision(0)</strong></span>
</pre></div></li><li class="listitem" value="6">Now, we go around the map composition frame and define locations and directions for each set of grid lines, using our shorter variable names from the previous steps:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">setGridAnnoPos(qcm.OutsideMapFrame, qcm.Top)</strong></span>
<span class="strong"><strong class="calibre2">setGridAnnoDir(qcm.Horizontal, qcm.Top)</strong></span>
<span class="strong"><strong class="calibre2">setGridAnnoPos(qcm.OutsideMapFrame, qcm.Bottom)</strong></span>
<span class="strong"><strong class="calibre2">setGridAnnoDir(qcm.Horizontal, qcm.Bottom)</strong></span>
<span class="strong"><strong class="calibre2">setGridAnnoPos(qcm.OutsideMapFrame, qcm.Left)</strong></span>
<span class="strong"><strong class="calibre2">setGridAnnoDir(qcm.Vertical, qcm.Left)</strong></span>
<span class="strong"><strong class="calibre2">setGridAnnoPos(qcm.OutsideMapFrame, qcm.Right)</strong></span>
<span class="strong"><strong class="calibre2">setGridAnnoDir(qcm.Vertical, qcm.Right)</strong></span>
</pre></div></li><li class="listitem" value="7">Finally, we set some additional styling for the grid lines and annotations before adding the whole map to the overall composition:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.composerMap.setAnnotationFrameDistance(1)</strong></span>
<span class="strong"><strong class="calibre2">qc.composerMap.setGridPenWidth(.2)</strong></span>
<span class="strong"><strong class="calibre2">qc.composerMap.setGridPenColor(QColor(0, 0, 0))</strong></span>
<span class="strong"><strong class="calibre2">qc.composerMap.setAnnotationFontColor(QColor(0, 0, 0))</strong></span>
<span class="strong"><strong class="calibre2">qc.c.addComposerMap(qc.composerMap)</strong></span>
</pre></div></li><li class="listitem" value="8">We output<a id="id549" class="calibre1"/> the composition to an image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.output("/qgis_data/map.jpg", "jpg")</strong></span>
</pre></div></li></ol><div class="calibre14"/></div><p class="calibre9">Verify that your <a id="id550" class="calibre1"/>output image looks similar to the following:</p><div class="mediaobject"><img src="../images/00050.jpeg" alt="How to do it..." class="calibre11"/></div><p class="calibre12"> </p></div></div>

<div class="book" title="Adding a grid to the map">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec335" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">This recipe has a lot of steps because the grids are customizable. The order of operations is important as well. Notice that we do not add the map to the composition until the very end. Often, you will make what seem to be minor changes and the grid may not render. Hence, modify this recipe carefully.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding a table to the map"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec116" class="calibre1"/>Adding a table to the map</h1></div></div></div><a id="id551" class="calibre1"/><p class="calibre9">QGIS composer <a id="id552" class="calibre1"/>provides an object to add a table to a composition, representing either the attributes of a vector layer or an arbitrary text table you create. In this recipe, we'll add a table to the composition with the attributes of our map layer shapefile.</p></div>

<div class="book" title="Adding a table to the map">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec336" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">Download the shapefile for this map from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/Mississippi.zip">https://geospatialpython.googlecode.com/svn/Mississippi.zip</a> and extract it to your <code class="literal">qgis_data</code> directory, to a subdirectory named <code class="literal">ms</code>.</p><p class="calibre9">As with the previous recipes in this chapter, we will use the <code class="literal">MapComposer</code> library from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/MapComposer.py">https://geospatialpython.googlecode.com/svn/MapComposer.py</a> to simplify the creation of the map composition.</p><p class="calibre9">Place the file in the <code class="literal">.qgis2/python</code> directory within your home directory.</p></div></div>

<div class="book" title="Adding a table to the map">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec337" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">The following <a id="id553" class="calibre1"/>steps will create a map composition, add the table, and output the composition to an image:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we import our GUI libraries and the MapComposer library:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
<span class="strong"><strong class="calibre2">from PyQt4.QtGui import *</strong></span>
<span class="strong"><strong class="calibre2">from qgisfromqgis.core import *</strong></span>
<span class="strong"><strong class="calibre2">from qgisfromqgis.gui import *</strong></span>
<span class="strong"><strong class="calibre2">import MapComposer</strong></span>
</pre></div></li><li class="listitem" value="2">Next, we create the map composition:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyr = QgsVectorLayer("/qgis_data/ms/mississippi.shp", "Mississippi", "ogr")</strong></span>
<span class="strong"><strong class="calibre2">reg = QgsMapLayerRegistry.instance()</strong></span>
<span class="strong"><strong class="calibre2">reg.addMapLayer(lyr)</strong></span>
<span class="strong"><strong class="calibre2">mr = iface.mapCanvas().mapRenderer()</strong></span>
<span class="strong"><strong class="calibre2">qc = MapComposer.MapComposer(qmlr=reg, qmr=mr)</strong></span>
</pre></div></li><li class="listitem" value="3">Now, we can initialize the table object:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.table = QgsComposerAttributeTable(qc.c)</strong></span>
</pre></div></li><li class="listitem" value="4">Then, we reference the related map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.table.setComposerMap(qc.composerMap)</strong></span>
</pre></div></li><li class="listitem" value="5">Next, we<a id="id554" class="calibre1"/> can specify the layer whose attributes we want to display in the table:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.table.setVectorLayer(lyr)</strong></span>
</pre></div></li><li class="listitem" value="6">Now, we can position the table below the map and add it to the composition:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">mch = qc.composerMap.rect().height()  </strong></span>
<span class="strong"><strong class="calibre2">qc.table.setItemPosition(qc.x, qc.y + mch + 20)</strong></span>
<span class="strong"><strong class="calibre2">qc.c.addItem(qc.table)</strong></span>
</pre></div></li><li class="listitem" value="7">Finally, we output the composition to an image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.output("/qgis_data/map.jpg", "jpg")</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Adding a table to the map">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec338" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">The table object <a id="id555" class="calibre1"/>is very straight forward. Using the attributes of a vector layer is automatic. You can also build the table cell by cell if you want to display customized information.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding a world file to a map image"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec117" class="calibre1"/>Adding a world file to a map image</h1></div></div></div><p class="calibre9">Exporting a <a id="id556" class="calibre1"/>map as an<a id="id557" class="calibre1"/> image removes all of its spatial information. However, you can create an external text file called a <span class="strong"><strong class="calibre2">world file</strong></span>, <a id="id558" class="calibre1"/>which provides the georeferencing information for the raster image, so that it can be used by GIS software, including QGIS, as a raster layer. In this recipe, we'll export a map composition as an image and create a world file with it.</p></div>

<div class="book" title="Adding a world file to a map image">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec339" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">You will need to download the zipped shapefile from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/Mississippi.zip">https://geospatialpython.googlecode.com/svn/Mississippi.zip</a> and extract it to your <code class="literal">qgis_data</code> directory, to a subdirectory named <code class="literal">ms</code>.</p><p class="calibre9">In addition to the shapefile, you will also need the <code class="literal">MapComposer</code> class to simplify the code needed to add this one element. If you have not already used it in a previous recipe, you can download it from <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/MapComposer.py">https://geospatialpython.googlecode.com/svn/MapComposer.py</a>.</p><p class="calibre9">This file must be accessible from the QGIS Python console; for this, you need to ensure that it is in the python path directory. Place the file in the <code class="literal">.qgis2/python</code> directory within your home directory.</p></div></div>

<div class="book" title="Adding a world file to a map image">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec340" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">First, we'll <a id="id559" class="calibre1"/>create the map composition, then we'll save it as an image, and finally we'll generate the world file. To do this, we need to perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we need to import the GUI and MapComposer libraries:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
<span class="strong"><strong class="calibre2">from PyQt4.QtGui import *</strong></span>
<span class="strong"><strong class="calibre2">from qgisfromqgis.core import *</strong></span>
<span class="strong"><strong class="calibre2">from qgisfromqgis.gui import *</strong></span>
<span class="strong"><strong class="calibre2">import MapComposer</strong></span>
</pre></div></li><li class="listitem" value="2">Next, we'll <a id="id560" class="calibre1"/>create the map's composition using the MapComposer libraries:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyr = QgsVectorLayer("/qgis_data/ms/mississippi.shp", "Mississippi", "ogr")</strong></span>
<span class="strong"><strong class="calibre2">reg = QgsMapLayerRegistry.instance()</strong></span>
<span class="strong"><strong class="calibre2">reg.addMapLayer(lyr)</strong></span>
<span class="strong"><strong class="calibre2">mr = iface.mapCanvas().mapRenderer()</strong></span>
<span class="strong"><strong class="calibre2">qc = MapComposer.MapComposer(qmlr=reg, qmr=mr)</strong></span>
</pre></div></li><li class="listitem" value="3">Now, we'll define the name of our output file:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">output =  "/qgis_data/map"</strong></span>
</pre></div></li><li class="listitem" value="4">Then, we can export the composition as an image:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.output(output + ".jpg", "jpg")</strong></span>
</pre></div></li><li class="listitem" value="5">Now, we'll create an object that contains the world file's information:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">qc.c.setWorldFileMap(qc.composerMap)</strong></span>
<span class="strong"><strong class="calibre2">qc.c.setGenerateWorldFile(True)</strong></span>
<span class="strong"><strong class="calibre2">wf = qc.c.computeWorldFileParameters()</strong></span>
</pre></div></li><li class="listitem" value="6">Finally, we'll open a text file and write each line of the text file:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">with open(output + ".jgw", "w") as f:</strong></span>
<span class="strong"><strong class="calibre2">  f.write("%s\n" % wf[0])</strong></span>
<span class="strong"><strong class="calibre2">  f.write("%s\n" % wf[1])</strong></span>
<span class="strong"><strong class="calibre2">  f.write("%s\n" % wf[3])</strong></span>
<span class="strong"><strong class="calibre2">  f.write("%s\n" % wf[4])</strong></span>
<span class="strong"><strong class="calibre2">  f.write("%s\n" % wf[2])</strong></span>
<span class="strong"><strong class="calibre2">  f.write("%s\n" % wf[5])</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Adding a world file to a map image">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec341" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">The world file <a id="id561" class="calibre1"/>contains<a id="id562" class="calibre1"/> the ground distance per pixel and the upper-left coordinate of the map image. The QGIS composer automatically generates this information based on the referenced map. The world file's name must be the same as the image with an extension that uses the first and last letter of the image file extension plus the letter <code class="literal">w</code>. For example, a <code class="literal">.TIFF</code> image file will have a world file with the extension <code class="literal">.TFW</code>. You can learn more about what the world file variables in each line mean at <a class="calibre1" href="http://en.wikipedia.org/wiki/World_file">http://en.wikipedia.org/wiki/World_file</a>.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Saving a map to a project"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec118" class="calibre1"/>Saving a map to a project</h1></div></div></div><p class="calibre9">Saving a<a id="id563" class="calibre1"/> project automatically can be useful for autosave features or as<a id="id564" class="calibre1"/> part of a process to autogenerate projects from dynamically updated data. In this recipe, we'll save a QGIS project to a <code class="literal">.qgs</code> project file.</p></div>

<div class="book" title="Saving a map to a project">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec342" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">You will need to download the following zipped shapefile and extract it to your <code class="literal">qgis_data</code> directory, to a subdirectory named <code class="literal">ms</code>:</p><p class="calibre9">
<a class="calibre1" href="https://geospatialpython.googlecode.com/svn/Mississippi.zip">https://geospatialpython.googlecode.com/svn/Mississippi.zip</a>
</p></div></div>

<div class="book" title="Saving a map to a project">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec343" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">We will create a simple QGIS project by loading a shapefile layer, then we'll access the project object, and save the map project to a file, as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we need the Qt core library in the QGIS Python console:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
</pre></div></li><li class="listitem" value="2">Next, we load the shapefile and add it to the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">lyr = QgsVectorLayer("/Users/joellawhead/qgis_data/ms/mississippi.shp", "Mississippi", "ogr")</strong></span>
<span class="strong"><strong class="calibre2">reg = QgsMapLayerRegistry.instance()</strong></span>
<span class="strong"><strong class="calibre2">reg.addMapLayer(lyr)</strong></span>
</pre></div></li><li class="listitem" value="3">Then, we create a <code class="literal">file</code> object to save our project:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">f = QFileInfo("/Users/joellawhead/qgis_data/myProject.qgs")</strong></span>
</pre></div></li><li class="listitem" value="4">Now, we can access the QGIS project object instance:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">p = QgsProject.instance()</strong></span>
</pre></div></li><li class="listitem" value="5">Finally, we <a id="id565" class="calibre1"/>can save the project by writing it to the file object:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">p.write(f)</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Saving a map to a project">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec344" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">QGIS simply<a id="id566" class="calibre1"/> creates and XML document with all the project settings and GIS map settings. You can read and even modify the XML output by hand.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Loading a map from a project"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec119" class="calibre1"/>Loading a map from a project</h1></div></div></div><p class="calibre9">This recipe<a id="id567" class="calibre1"/> demonstrates how to load a project from a <code class="literal">.qgs</code> XML file. Loading<a id="id568" class="calibre1"/> a project will set up the map and project settings for a previously saved project within QGIS.</p></div>

<div class="book" title="Loading a map from a project">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec345" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">You will need to complete the previous recipe, <span class="strong"><em class="calibre10">Saving a map to a project</em></span>, so that you have a project named <code class="literal">myProject.qgs</code> in your <code class="literal">qgis_data</code> folder.</p></div></div>

<div class="book" title="Loading a map from a project">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec346" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre9">For this recipe, you need to set up a file object, set a resource path, and then read the file object that references the project file. To do this, you need to perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, we import the core <code class="literal">Qt</code> library for the file object:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">from PyQt4.QtCore import *</strong></span>
</pre></div></li><li class="listitem" value="2">Next, we initiate the file object with the path to the project file:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">f = QFileInfo("/Users/joellawhead/qgis_data/myProject.qgs")</strong></span>
</pre></div></li><li class="listitem" value="3">Now, we access the project object:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">p = QgsProject.instance()</strong></span>
</pre></div></li><li class="listitem" value="4">Then, we set the resource path for QGIS to find data and other files, in case the project was saved with relative paths instead of absolute paths:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">p.readPath("/Users/joellawhead/qgis_data/")</strong></span>
</pre></div></li><li class="listitem" value="5">Finally, we tell the project object to read the project file in order to load the map:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong class="calibre2">p.read(f)</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Loading a map from a project">
<div class="book" title="How it works..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec347" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre9">QGIS has a setting <a id="id569" class="calibre1"/>to save references to data and other files<a id="id570" class="calibre1"/> either as relative paths, which are relative to the project file, or absolute paths, which contain the full path. If the saved paths are absolute, PyQGIS will be unable to locate data sources. Setting the read path to the full system path of the project file ensures that QGIS can find all the referenced files in the project file, if they are saved as relative paths.</p></div></div></body></html>