<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Querying and Selecting Data</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Constructing proper attribute query syntax</li><li class="listitem" style="list-style-type: disc">Creating feature layers and table views</li><li class="listitem" style="list-style-type: disc">Selecting features and rows with the Select Layer by Attribute tool</li><li class="listitem" style="list-style-type: disc">Selecting features with the Select by Location tool</li><li class="listitem" style="list-style-type: disc">Combining spatial and attribute queries with the Select by Location tool</li></ul></div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec55"/>Introduction</h1></div></div></div><p>Selecting features from a geographic layer or rows from a standalone attribute table is one of the most common <a id="id517" class="indexterm"/>GIS operations. Queries<a id="id518" class="indexterm"/> are created to enable these selections, and can be either attribute or spatial queries. <strong>Attribute queries</strong>
<a id="id519" class="indexterm"/> use SQL statements to select features or rows through the use of one or more fields or columns in a dataset. An example attribute query would be "Select all land parcels with a property value greater than $500,000". <strong>Spatial queries</strong>
<a id="id520" class="indexterm"/> are used to select features based on some type of spatial relationship. An example might be "Select all land parcels that intersect a 100 year floodplain" or perhaps "Select all streets that are completely within Travis County, Texas". It is also possible to combine attribute and spatial queries. An example might be "Select all land parcels that intersect the 100 year floodplain and have a property value greater than $500,000".</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec56"/>Constructing proper attribute query syntax</h1></div></div></div><p>The construction of <a id="id521" class="indexterm"/>property attribute queries is critical to your success in creating geoprocessing scripts that query data from feature classes and tables. All attribute queries that you execute against feature classes and tables will need to have the correct SQL syntax and also follow various rules depending upon the datatype that you execute the queries against.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec138"/>Getting ready</h2></div></div></div><p>Creating the syntax for attribute queries is one of the most difficult and time-consuming tasks that you'll need to master when creating Python scripts that incorporate the use of the <a id="id522" class="indexterm"/>
<strong>Select by Attributes</strong> tool. These queries are basically SQL statements along with a few idiosyncrasies that you'll need to master. If you already have a good understanding of creating queries in ArcMap or perhaps an experience with creating SQL statements in other programming languages, then this will be a little easier for you. In addition to creating valid SQL statements, you also need to be aware of some specific Python syntax requirements and some datatype differences that will result in a slightly altered formatting of your statements for some datatypes. In this recipe, you'll learn how to construct valid query syntax and understand the nuances of how different datatypes alter the syntax as well as some Python-specific constructs.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec139"/>How to do it…</h2></div></div></div><p>Initially, we're going to take a <a id="id523" class="indexterm"/>look at how queries are constructed in <a id="id524" class="indexterm"/>ArcMap, so that you can get a feel of how they are structured. </p><div><ol class="orderedlist arabic"><li class="listitem">In ArcMap, open <code class="literal">C:\ArcpyBook\Ch8\Crime_Ch8.mxd</code>.</li><li class="listitem">Right-click on the <strong>Burglaries in 2009</strong> layer and select <strong>Open Attribute Table</strong>. You should see an attribute table similar to the following screenshot. We're going to be querying the <strong>SVCAREA</strong> field:<div><img src="img/4445_08_1.jpg" alt="How to do it…"/></div></li><li class="listitem">With the <a id="id525" class="indexterm"/>attribute table open, select the <strong>Table Options</strong> button and then <strong>Select by Attributes</strong> to display a dialog box that will allow you to construct an attribute query.<p>Notice the <strong>Select * FROM Burglary WHERE:</strong> statement on the query dialog box (shown in the following screenshot). This is a basic SQL statement that will return all the columns from the attribute table for <strong>Burglary</strong> that meet the condition that we define through the query builder. The asterisk (<strong>*</strong>) simply indicates that all fields will be returned:</p><div><img src="img/4445_08_3.jpg" alt="How to do it…"/></div></li><li class="listitem">Make sure <a id="id526" class="indexterm"/>that <strong>Create a new selection</strong> is the selected item in the <strong>Method</strong> dropdown list. This will create a new selection set.</li><li class="listitem">Double-click on <strong>SVCAREA</strong> from the list of fields to add the field to the SQL statement builder, as follows:<div><img src="img/4445_08_4.jpg" alt="How to do it…"/></div></li><li class="listitem">Click <a id="id527" class="indexterm"/>on the <strong>=</strong> button.</li><li class="listitem">Click on the <strong>Get Unique Values</strong> button.</li><li class="listitem">From the list of values generated, double-click on <strong>'North'</strong> to complete the SQL statement, as shown in the following screenshot:<div><img src="img/4445_08_5.jpg" alt="How to do it…"/></div></li><li class="listitem">Click on<a id="id528" class="indexterm"/> the <strong>Apply</strong> button to execute the query. This should select 7520 records.<p>Many people mistakenly assume that you can simply take a query that has been generated in this fashion and paste it into a Python script. That is not the case. There are some important differences that we'll cover next.</p></li><li class="listitem">Close the <strong>Select by Attributes</strong> window and the <strong>Burglaries in 2009</strong> table.</li><li class="listitem">Clear the selected feature set by clicking on <strong>Selection</strong> | <strong>Clear Selected Features</strong>.</li><li class="listitem">Open the Python window and add the code to import <code class="literal">arcpy</code>.<div><pre class="programlisting">import arcpy</pre></div></li><li class="listitem">Create a new variable to hold the query and add the exact same statement that you created earlier:<div><pre class="programlisting">qry = "SVCAREA" = 'North'</pre></div></li><li class="listitem">Press <em>Enter</em> on your keyboard and you should see an error message similar to the following:<div><pre class="programlisting">
<strong>Runtime error SyntaxError: can't assign to literal (&lt;string&gt;, line 1)</strong>
</pre></div></li></ol></div><p>Python <a id="id529" class="indexterm"/>interprets <strong>SVCAREA</strong> and <strong>North</strong> as strings but the equal to sign between the two is not part of the string used to set the <code class="literal">qry</code> variable. There are several things we need to do to generate a syntactically correct statement for the Python interpreter. </p><p>One important thing has already been taken care of though. Each field name used in a query needs to be surrounded by double quotes. In this case, <strong>SVCAREA</strong> is the only field used in the query and it has already been enclosed by double quotes. This will always be the case when you're working with shapefiles, file geodatabases, or ArcSDE geodatabases. Here is where it gets a little confusing though. If you're working with data from a personal geodatabase, the field names will need to be enclosed by square brackets instead of double quotes as shown in the following code example. This can certainly leads to confusion for script developers.</p><div><pre class="programlisting">
qry = [SVCAREA] = 'North'
</pre></div><p>Now, we need to deal with the single quotes surrounding <strong>'North'</strong>. When querying data from fields that have a <code class="literal">text</code> datatype, the string being evaluated must be enclosed by quotes. If you examine the original query, you'll notice that we have in fact already enclosed the word <code class="literal">North</code> with quotes, so everything should be fine right? Unfortunately, it's not that simple with Python. Quotes, along with a number of other characters, must be escaped with a forward slash followed by the character being escaped. In this case, the escape sequence would be <code class="literal">\'</code>.</p><div><ol class="orderedlist arabic"><li class="listitem">Alter your query syntax to incorporate the escape sequence:<div><pre class="programlisting">qry = "SVCAREA" = \'North\'</pre></div></li><li class="listitem">Finally, the entire query statement should be enclosed with quotes:<div><pre class="programlisting">qry = '"SVCAREA" = \'North\''</pre></div></li></ol></div><p>In addition to the <code class="literal">=</code> sign, which tests for equality, there are a number of additional operators that you can use with strings and numeric data, including not equal (<code class="literal">&lt; &gt;</code>), greater than (<code class="literal">&gt;</code>), greater than or equal to (<code class="literal">&gt;=</code>), less than (<code class="literal">&lt;</code>), and less than or equal to (<code class="literal">&lt;=</code>).</p><p>Wildcard <a id="id530" class="indexterm"/>characters including <code class="literal">%</code> and <code class="literal">_</code> can also be used for shapefiles, file geodatabases, and ArcSDE geodatabases. These include <code class="literal">%</code> for representing any number of characters. The <code class="literal">LIKE</code> operator is often used with wildcard characters to perform partial string matching. For example, the following query would find all records with a service area that begins with <code class="literal">N</code> and has any number of characters after.</p><div><pre class="programlisting">qry = '"SVCAREA" LIKE \'N%\''</pre></div><p>The underscore character (<code class="literal">_</code>) can be used to represent a single character. For personal geodatabases the asterisk (<code class="literal">*</code>) is used to represent a wildcard character for any number of characters, while (<code class="literal">?</code>) represents a single character.</p><p>You can also query for the absence of data, also known as <code class="literal">NULL</code> values. A <code class="literal">NULL</code> value is often mistaken for a value of zero, but that is not the case. <code class="literal">NULL</code> values indicate the absence of data, which is different from a value of zero. Null operators include <strong>IS NULL</strong> and <strong>IS NOT NULL</strong>. The following code example will find all records where the <code class="literal">SVCAREA</code> field contains no data:</p><div><pre class="programlisting">qry = '"SVCAREA" IS NULL'</pre></div><p>The final topic that we'll cover in this section are operators used for combining expressions where multiple query conditions need to be met. The <code class="literal">AND</code> operator requires that both query conditions be met for the query result to be true, resulting in selected records. The <code class="literal">OR</code> operator requires that at least one of the conditions be met.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec140"/>How it works…</h2></div></div></div><p>The creation of syntactically correct queries is one of the most challenging aspects of programming ArcGIS with Python. However, once you understand some basic rules, it gets a little easier. In this section, we'll summarize these rules. One of the more important things to keep in mind is that field names must be enclosed with double quotes for all datasets, with the exception of personal geodatabases, which require braces surrounding field names.</p><p>There is also an <code class="literal">AddFieldDelimiters()</code> function<a id="id531" class="indexterm"/> that you can use to add the correct delimiter to a field based on the datasource supplied as a parameter to the function. The syntax for this function is as follows:</p><div><pre class="programlisting">AddFieldDelimiters(dataSource,field)</pre></div><p>Additionally, most people, especially those new to programming with Python, struggle with the issue of adding single quotes to string values being evaluated by the query. In Python, quotes have to be escaped with a single forward slash followed by the quote. Using this escape sequence will ensure that Python does in fact see that as a quote rather than the end of the string. </p><p>Finally, <a id="id532" class="indexterm"/>take some time to familiarize yourself with the wildcard characters. For datasets other than personal geodatabases, you'll use the (<code class="literal">%)</code> character for multiple characters and an underscore (_) character for a single character. If you're using a personal geodatabase, the (<code class="literal">*)</code> character is used to match multiple characters and the <code class="literal">(?)</code> character is used to match a single character. Obviously, the syntax differences between personal geodatabases and all other types of datasets can lead to some confusion.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec57"/>Creating feature layers and table views</h1></div></div></div><p>Feature layers <a id="id533" class="indexterm"/>and table views <a id="id534" class="indexterm"/>serve as intermediate datasets held in memory for use specifically with tools such as Select by Location and Select Attributes. Although these temporary datasets can be saved, they are not needed in most cases. </p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec141"/>Getting ready</h2></div></div></div><p>Feature classes <a id="id535" class="indexterm"/>are physical representations of geographic data and are stored as files (shapefiles, personal geodatabases, and file geodatabases) or within a geodatabase. ESRI<a id="id536" class="indexterm"/> defines a feature class as "a collection of features that shares a common geometry (point, line, or polygon), attribute table, and spatial reference."</p><p>Feature classes can contain default and user-defined fields. Default fields include the <code class="literal">SHAPE</code> and <code class="literal">OBJECTID</code> fields. These fields are maintained and updated automatically by ArcGIS. The <code class="literal">SHAPE</code> field holds the geometric representation of a geographic feature, while the <code class="literal">OBJECTID</code> field holds a unique identifier for each feature. Additional default fields will also exist depending on the type of feature class. A line feature class will have a <code class="literal">SHAPE_LENGTH</code> field. A polygon feature class will have both, a <code class="literal">SHAPE_LENGTH</code> and a <code class="literal">SHAPE_AREA</code> field. </p><p>Optional fields are created by end users of ArcGIS and are not automatically updated by GIS. These contain attribute information about the features. These fields can also be updated by your scripts.</p><p>Tables are<a id="id537" class="indexterm"/> physically represented as standalone DBF tables or within a geodatabase. Both, tables and feature classes, contain attribute information. However, a table contains only attribute information. There isn't a <code class="literal">SHAPE</code> field associated with a table, and they may or may not contain an <code class="literal">OBJECTID</code> field.</p><p>Standalone Python scripts that use the <strong>Select by Attributes</strong> or <strong>Select by Location</strong> tool require that you create an intermediate dataset rather than using feature classes or tables. These intermediate datasets are temporary in nature and are called <strong>Feature Layers</strong> or <strong>Table Views</strong>. Unlike feature classes and tables, these temporary datasets do not represent actual files on disk or within a geodatabase. Instead, they are "in memory" representations of feature classes and tables. These datasets are active only while a Python script is running. They are removed from memory after the tool has executed. However, if the script is run from within ArcGIS as a script tool, then the temporary layer can be saved either by right-clicking on the layer in the table of contents and selecting <strong>Save As Layer File</strong> or simply by saving the map document file.</p><p>Feature layers <a id="id538" class="indexterm"/>
<a id="id539" class="indexterm"/>and table views must be created as a separate step in your Python scripts, before you can call the <strong>Select by Attributes</strong> or <strong>Select by Location</strong> tools. The <strong>Make Feature Layer</strong> tool generates the "in-memory" representation of a feature class, which can then be used to create queries and selection sets, as well as to join tables. After this step has been completed, you can use the <strong>Select by Attributes</strong> or <strong>Select by Location</strong> tool. Similarly, the <strong>Make Table View</strong> tool is used to create an "in-memory" representation of a table. The function of this tool is the same as <strong>Make Feature Layer</strong>. Both the <strong>Make Feature Layer</strong> and <strong>Make Table View</strong> tools require an input dataset, an output layer name, and an optional query expression, which can be used to limit the features or rows that are a part of the output layer. In addition, both tools can be found in the <strong>Data Management</strong> Tools toolbox.</p><p>The syntax for using the <strong>Make Feature Layer</strong> tool<a id="id540" class="indexterm"/> is as follows:</p><div><pre class="programlisting">arcpy.MakeFeatureLayer_management(&lt;input feature layer&gt;, &lt;output layer name&gt;,{where clause})</pre></div><p>The syntax for using the <strong>Make Table View</strong> tool<a id="id541" class="indexterm"/> is as follows:</p><div><pre class="programlisting">Arcpy.MakeTableView_management(&lt;input table&gt;, &lt;output table name&gt;, {where clause})</pre></div><p>In this recipe, you will learn how to use the <strong>Make Feature Layer</strong> and <strong>Make Table View</strong> tools. These tasks will be done inside ArcGIS, so that you can see the in-memory copy of the layer that is created.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec142"/>How to do it…</h2></div></div></div><p>Follow these steps to learn how to use the <strong>Make Feature Layer</strong>
<a id="id542" class="indexterm"/> and <a id="id543" class="indexterm"/>
<strong>Make Table View</strong> tools:</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">c:\ArcpyBook\Ch8\Crime_Ch8.mxd</code> in ArcMap. </li><li class="listitem">Open the Python window.</li><li class="listitem">Import the <code class="literal">arcpy</code> module:<div><pre class="programlisting">import arcpy</pre></div></li><li class="listitem">Set the workspace:<div><pre class="programlisting">arcpy.env.workspace = "c:/ArcpyBook/data/CityOfSanAntonio.gdb"</pre></div></li><li class="listitem">Start a <code class="literal">try</code> block:<div><pre class="programlisting">try:</pre></div></li><li class="listitem">Make an in-memory copy of the <code class="literal">Burglary</code> feature class using the <strong>Make Feature Layer</strong> tool. Make sure you indent this line of code:<div><pre class="programlisting">flayer = arcpy.MakeFeatureLayer_management("Burglary","Burglary_Layer")</pre></div></li><li class="listitem">Add an <code class="literal">except</code> block and a line of code to print an error message in the event of a problem:<div><pre class="programlisting">except:
  print "An error occurred during creation"</pre></div></li><li class="listitem">The<a id="id544" class="indexterm"/><a id="id545" class="indexterm"/><a id="id546" class="indexterm"/><a id="id547" class="indexterm"/> entire script should appear as follows:<div><pre class="programlisting">import arcpy
arcpy.env.workspace = "c:/ArcpyBook/data/CityOfSanAntonio.gdb"
try:
  flayer = arcpy.MakeFeatureLayer_management("Burglary","Burglary_Layer")
except:
  print "An error occurred during creation"</pre></div></li><li class="listitem">Save the script to <code class="literal">c:\ArcpyBook\Ch8\CreateFeatureLayer.py</code>.</li><li class="listitem">Run the script. The new <code class="literal">Burglary_Layer</code> file will be added to the ArcMap table of contents:<div><img src="img/4445_08_6.jpg" alt="How to do it…"/></div></li><li class="listitem">The <a id="id548" class="indexterm"/><a id="id549" class="indexterm"/><a id="id550" class="indexterm"/><a id="id551" class="indexterm"/><strong>Make Table View</strong> tool functionality is equivalent to the <strong>Make Feature Layer</strong> tool. The difference is that it works against standalone tables instead of feature classes. </li><li class="listitem">Remove the following line of code:<div><pre class="programlisting">flayer = arcpy.MakeFeatureLayer_management("Burglary","Burglary_Layer")</pre></div></li><li class="listitem">Add the following line of code in its place:<div><pre class="programlisting">tView = arcpy.MakeTableView_management("Crime2009Table","Crime2009TView")</pre></div></li><li class="listitem">Run the script to see the table view added to the ArcMap table of contents.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec143"/>How it works...</h2></div></div></div><p>The <strong>Make </strong>
<a id="id552" class="indexterm"/>
<a id="id553" class="indexterm"/>
<a id="id554" class="indexterm"/>
<a id="id555" class="indexterm"/>
<strong>Feature Layer</strong> and <strong>Make Table View</strong> tools create in-memory representations of feature classes and tables respectively. Both the <strong>Select by Attributes</strong> and <strong>Select by Location</strong> tools require that these temporary, in-memory structures be passed in as parameters when called from a Python script. Both tools also require that you pass in a name for the temporary structures. </p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec144"/>There's more...</h2></div></div></div><p>You can also apply a query to either the <strong>Make Feature Layer</strong> or <strong>Make Table View</strong> tools to restrict the records returned in the feature layer or table view. This is done through the addition of a <code class="literal">where</code> clause when calling either of the tools from your script. This query is much the same as if you'd set a definition query on the layer through <strong>Layer Properties</strong> | <strong>Definition Query</strong>.</p><p>The syntax for adding a query is as follows:</p><div><pre class="programlisting">MakeFeatureLayer(in_features, out_layer, where_clause)
MakeTableView(in_table, out_view, where_clause)</pre></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec58"/>Selecting features and rows with the Select Layer by Attribute tool</h1></div></div></div><p>Attribute queries can be executed against a feature class or a table through the use of the <strong>Select Layer by Attribute</strong> tool. A <code class="literal">where</code> clause<a id="id556" class="indexterm"/> can be included to filter the selected records and various selection types can be included.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec145"/>Getting ready</h2></div></div></div><p>The <strong>Select Layer by Attribute</strong> tool <a id="id557" class="indexterm"/>
<a id="id558" class="indexterm"/>
<a id="id559" class="indexterm"/>
<a id="id560" class="indexterm"/>shown in the following screenshot is used to select records from a feature class or table based on a query that you define. We covered the somewhat complex topic of queries in an earlier recipe in this chapter, so hopefully you now understand the basic concepts of creating a query. You have also learned how to create a temporary, in-memory representation of a feature class or table, which is a pre-requisite to using either the <strong>Select by Attributes</strong> or <strong>Select by Location</strong> tool.</p><div><img src="img/4445_08_7.jpg" alt="Getting ready"/></div><p>The <strong>Select by </strong>
<a id="id561" class="indexterm"/>
<a id="id562" class="indexterm"/>
<a id="id563" class="indexterm"/>
<a id="id564" class="indexterm"/>
<strong>Attributes</strong> tool uses a query along with either a feature layer or table view, and a selection method to select records. By default, the selection method will be a new selection set. Other selection methods include "add to selection", "remove from selection", "subset selection", "switch selection", and "clear selection". Each of the selection methods is summarized as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">NEW_SELECTION</code>: It is the default <a id="id565" class="indexterm"/>selection method and creates a new selection set</li><li class="listitem" style="list-style-type: disc"><code class="literal">ADD_TO_SELECTION</code>: It adds a<a id="id566" class="indexterm"/> selection set to the currently selected records, based on a query</li><li class="listitem" style="list-style-type: disc"><code class="literal">REMOVE_FROM_SELECTION</code>: It <a id="id567" class="indexterm"/>removes records from a selection set based on a query</li><li class="listitem" style="list-style-type: disc"><code class="literal">SUBSET_SELECTION</code>: It<a id="id568" class="indexterm"/> combines selected records that are common to the existing selection set</li><li class="listitem" style="list-style-type: disc"><code class="literal">SWITCH_SELECTION</code>: It <a id="id569" class="indexterm"/>selects records that are not selected currently and unselects the existing selection set</li><li class="listitem" style="list-style-type: disc"><code class="literal">CLEAR_SELECTION</code>: It clears<a id="id570" class="indexterm"/> all records that are currently a part of the selected set</li></ul></div><p>The syntax for calling the <a id="id571" class="indexterm"/>
<strong>Select by Attributes</strong> tool is as follows:</p><div><pre class="programlisting">arcpy.SelectLayerByAttribute_management(&lt;input feature layer or table view&gt;, {selection method}, {where clause})</pre></div><p>In this recipe, <a id="id572" class="indexterm"/>
<a id="id573" class="indexterm"/>
<a id="id574" class="indexterm"/>
<a id="id575" class="indexterm"/>you'll learn how to use the <strong>Select by Attributes</strong> tool to select features from a feature class. You'll use the skills you learned in previous recipes to build a query, create a feature layer, and finally call the <strong>Select by Attributes</strong> tool.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec146"/>How to do it…</h2></div></div></div><p>Follow these steps to learn how to select records from a table or feature class using the <strong>Select Layer by Attributes</strong> tool:</p><div><ol class="orderedlist arabic"><li class="listitem">Open IDLE and create a new script window.</li><li class="listitem">Save the script to <code class="literal">c:\ArcpyBook\Ch8\SelectLayerAttribute.py</code>.</li><li class="listitem">Import the <code class="literal">arcpy</code> module:<div><pre class="programlisting">import arcpy</pre></div></li><li class="listitem">Set the workspace to the City of San Antonio geodatabase.<div><pre class="programlisting">arcpy.env.workspace = "c:/ArcpyBook/data/CityOfSanAntonio.gdb"</pre></div></li><li class="listitem">Start a <code class="literal">try</code> block:<div><pre class="programlisting">try:</pre></div></li><li class="listitem">Create the query that we used in the first recipe in this chapter. This will serve as a <code class="literal">where</code> clause that will select all the records with a service area of <code class="literal">North</code>. This line of code and the next four should be indented:<div><pre class="programlisting">qry = '"SVCAREA" = \'North\''</pre></div></li><li class="listitem">Make an in-memory copy of the <code class="literal">Burglary</code> feature class:<div><pre class="programlisting">flayer = arcpy.MakeFeatureLayer_management("Burglary","Burglary_Layer")</pre></div></li><li class="listitem">Call the <strong>Select Layer by Attribute</strong> tool passing in a reference to the feature layer we just created. Define this as a new selection set and pass in a reference to the query:<div><pre class="programlisting">arcpy.SelectLayerByAttribute_management(flayer, "NEW_SELECTION", qry)</pre></div></li><li class="listitem">Print the number of selected records in the layer using the Get Count tool:<div><pre class="programlisting">cnt = arcpy.GetCount_management(flayer)
print "The number of selected records is: " + str(cnt)</pre></div></li><li class="listitem">Add an <code class="literal">except</code> block and a line of code to print an error message in the event of a problem:<div><pre class="programlisting">except:
  print "An error occurred during selection"</pre></div></li><li class="listitem">The entire script should appear as shown in the following code snippet. Please remember to include indentation with the <code class="literal">try</code> and <code class="literal">except</code> blocks:<div><pre class="programlisting">import arcpy
arcpy.env.workspace = "c:/ArcpyBook/data/CityOfSanAntonio.gdb"
try:
  qry = '"SVCAREA" = \'North\''
  flayer =   arcpy.MakeFeatureLayer_management("Burglary","Burglary_Layer")
  arcpy.SelectLayerByAttribute_management(flayer, "NEW_SELECTION", qry)
  cnt = arcpy.GetCount_management(flayer)
  print "The number of selected records is: " + str(cnt)
except:
  print "An error occurred during selection"</pre></div></li><li class="listitem">Save the script.</li><li class="listitem">Run the script. If everything has been done correctly, you should see a message indicating that 7520 records have been selected:<div><pre class="programlisting">
<strong>The total number of selected records is: 7520</strong>
</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec147"/>How it works…</h2></div></div></div><p>The <strong>Select by </strong>
<a id="id576" class="indexterm"/>
<a id="id577" class="indexterm"/>
<a id="id578" class="indexterm"/>
<a id="id579" class="indexterm"/>
<strong>Attributes</strong> tool requires that either a feature layer or table view be passed in as the first parameter. In this recipe, we passed in a feature layer that was created by the Make Feature Layer tool in the line just above. We used <strong>Make Feature Layer</strong> to create a feature layer from the <code class="literal">Burglary</code> feature class. This feature layer was assigned to the variable <code class="literal">flayer</code>, which is then passed into the <strong>Select by Attribute</strong> tool as the first parameter. In this script, we also passed in a parameter indicating that we'd like to create a new selection set along with the <code class="literal">final</code> parameter, which is a <code class="literal">where</code> clause. The <code class="literal">where</code> clause is specified in the <code class="literal">qry</code> variable. This variable holds a query that will select all the features with a service area of <code class="literal">North</code>.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec59"/>Selecting features with the Select by Location tool</h1></div></div></div><p>The <a id="id580" class="indexterm"/>
<strong>Select Layer by Location</strong> tool, as shown in the next screenshot, can be used to select features based on some type of spatial relationship. Since it deals with spatial relationships, this tool only applies to feature classes and their corresponding in-memory feature layers. </p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec148"/>Getting ready</h2></div></div></div><p>There are many different<a id="id581" class="indexterm"/>
<a id="id582" class="indexterm"/> types of spatial relationships that you can apply while selecting features using the <strong>Select by Location</strong> tool, including intersect, contains, within, boundary touches, is identical, and many others. If not specified, the default intersect spatial relationship will be applied. The input feature layer is the only required parameter, but there are a number of optional parameters including the spatial relationship, search distance, a feature layer, or feature class to test against the input layer, and a selection type. In this recipe, you will learn how to use the <strong>Select by Location</strong> tool in a Python script to select features based on a spatial relationship. You'll use the tool to select burglaries that are within the boundaries of the Edgewood school district.</p><div><img src="img/4445_08_8.jpg" alt="Getting ready"/></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec149"/>How to do it…</h2></div></div></div><p>Follow these steps to<a id="id583" class="indexterm"/>
<a id="id584" class="indexterm"/> learn how to perform a spatial query using the <strong>Select by Location</strong> tool:</p><div><ol class="orderedlist arabic"><li class="listitem">Open IDLE and create a new script window.</li><li class="listitem">Save the script to <code class="literal">c:\ArcpyBook\Ch8\SelectByLocation.py</code>.</li><li class="listitem">Import the <code class="literal">arcpy</code> module:<div><pre class="programlisting">import arcpy</pre></div></li><li class="listitem">Set the workspace to the City of San Antonio geodatabase:<div><pre class="programlisting">arcpy.env.workspace = "c:/ArcpyBook/data/CityOfSanAntonio.gdb"</pre></div></li><li class="listitem">Start a <code class="literal">try</code> block:<div><pre class="programlisting">try:</pre></div></li><li class="listitem">Make an in-memory copy of the <code class="literal">Burglary</code> feature class:<div><pre class="programlisting">flayer = arcpy.MakeFeatureLayer_management("Burglary","Burglary_Layer")</pre></div></li><li class="listitem">Call the <strong>Select Layer by Location</strong> tool passing in a reference to the feature layer we just created. The spatial relationship test will be <code class="literal">COMPLETELY_WITHIN</code>, meaning that we want to find all burglaries that are completely within the boundaries of the comparison layer. Define <code class="literal">EdgewoodSD.shp</code> as the comparison layer:<div><pre class="programlisting">arcpy.SelectLayerByLocation_management (flayer, "COMPLETELY_WITHIN", "c:/ArcpyBook/Ch8/EdgewoodSD.shp")</pre></div></li><li class="listitem">Print the number of selected records in the layer using the <strong>Get Count</strong> tool:<div><pre class="programlisting">cnt = arcpy.GetCount_management(flayer)
print "The number of selected records is: " + str(cnt)</pre></div></li><li class="listitem">Add an <code class="literal">except</code> block and a line of code to print an error message in the event of a problem:<div><pre class="programlisting">except:
  print "An error occurred during selection"</pre></div></li><li class="listitem">The entire script should appear as shown in the following code snippet. Please remember to include indentation with the <code class="literal">try</code> and <code class="literal">except</code> blocks:<div><pre class="programlisting">import arcpy
arcpy.env.workspace = "c:/ArcpyBook/data/CityOfSanAntonio.gdb"
try:
  flayer =   arcpy.MakeFeatureLayer_management("Burglary","Burglary_Layer")
  arcpy.SelectLayerByLocation_management (flayer, "COMPLETELY_WITHIN", "c:/ArcpyBook/Ch8/EdgewoodSD.shp")
  cnt = arcpy.GetCount_management(flayer)
  print "The number of selected records is: " + str(cnt)
except:
  print "An error occurred during selection"</pre></div></li><li class="listitem">Save the script.</li><li class="listitem">Run the script. If everything was done correctly, you should see a message indicating that 1470 records have been selected:<div><pre class="programlisting">
<strong>The total number of selected records is: 1470</strong>
</pre></div></li></ol></div><p>In this case, we did<a id="id585" class="indexterm"/>
<a id="id586" class="indexterm"/> not define the optional search distance and selection type parameters. By default, a new selection will be applied as the selection type. We didn't apply a distance parameter in this case, but we'll do that now to illustrate how it works. </p><div><ol class="orderedlist arabic"><li class="listitem">Update the line of code that calls the <strong>Select Layer</strong> by Location tool:<div><pre class="programlisting">arcpy.SelectLayerByLocation_management (flayer, "WITHIN_A_DISTANCE", "c:/ArcpyBook/Ch8/EdgewoodSD.shp","1 MILES")</pre></div></li><li class="listitem">Save the script.</li><li class="listitem">Run the script. If everything was done correctly, you should see a message indicating that 2976 records have been selected. This will select all burglaries within the boundaries of the Edgewood school district along with any burglaries within one mile of the boundary:<div><pre class="programlisting">
<strong>The total number of selected records is: 2976</strong>
</pre></div></li></ol></div><p>The final thing you'll do in this section is use the <strong>Copy Features</strong> tool to write the temporary layer to a new feature class.</p><div><ol class="orderedlist arabic"><li class="listitem">Comment out the two lines of code that get a count of the number of features, and print them to the screen:<div><pre class="programlisting">## cnt = arcpy.GetCount_management(flayer)
## print "The number of selected records is: " + str(cnt)</pre></div></li><li class="listitem">Add a line of code that calls the <strong>Copy Features</strong> tool. This line should be placed just below the line of code that calls the <strong>Select Layer by Location</strong> tool. The <strong>Copy Features</strong> tool accepts a feature layer as the first input parameter and an output feature class, which in this case will be a shapefile called <code class="literal">EdgewoodBurglaries.shp</code>:<div><pre class="programlisting">arcpy.CopyFeatures_management(flayer, 'c:/ArcpyBook/Ch8/EdgewoodBurglaries.shp')</pre></div></li><li class="listitem">The entire<a id="id587" class="indexterm"/><a id="id588" class="indexterm"/> script should now appear as shown in the following code snippet. Please remember to include indentation with the <code class="literal">try</code> and <code class="literal">except</code> blocks:<div><pre class="programlisting">import arcpy
arcpy.env.workspace = "c:/ArcpyBook/data/CityOfSanAntonio.gdb"
try:
  flayer = arcpy.MakeFeatureLayer_management("Burglary","Burglary_Layer")
  arcpy.SelectLayerByLocation_management (flayer, "WITHIN_A_DISTANCE", "c:/ArcpyBook/Ch8/EdgewoodSD.shp","1 MILES")
  arcpy.CopyFeatures_management(flayer, 'c:/ArcpyBook/Ch8/EdgewoodBurglaries.shp')
	#cnt = arcpy.GetCount_management(flayer)
 #print "The total number of selected records is: " + str(cnt)
except:
  print "An error occurred during selection"</pre></div></li><li class="listitem">Save the script.</li><li class="listitem">Run the script. </li><li class="listitem">Examine your <code class="literal">c:\ArcpyBook\Ch8</code> folder to see the output shapefile:<div><img src="img/4445_08_9.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec150"/>How it works…</h2></div></div></div><p>The <strong>Select by</strong>
<a id="id589" class="indexterm"/>
<a id="id590" class="indexterm"/>
<strong> Location</strong> tool requires that a feature layer be passed in as the first parameter. In this recipe, we pass in a feature layer that was created by the <strong>Make Feature Layer</strong> tool in the line just above. We used <strong>Make Feature Layer</strong> to create a feature layer from the <code class="literal">Burglary</code> feature class. This feature layer was assigned to the variable <code class="literal">flayer</code>, which is then passed into the <strong>Select by Location</strong> tool as the first parameter. In this script, we've also passed in a parameter that indicates the spatial relationship that we'd like to apply. Finally, we've also defined a source layer to use for the spatial relationship comparison. Other optional parameters that can be applied include a search distance and a selection type.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec60"/>Combining a spatial and attribute query with the Select by Location tool</h1></div></div></div><p>There may be times when <a id="id591" class="indexterm"/>
<a id="id592" class="indexterm"/>
<a id="id593" class="indexterm"/>you want to select features using a combined attribute and spatial query. For example, you might want to select all burglaries within the Edgewood school district that occurred on a Monday. This can be accomplished by running the <strong>Select by Location</strong> and <strong>Select by Attributes</strong> tools sequentially and applying a <code class="literal">SUBSET SELECTION</code> selection type. </p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec151"/>Getting ready</h2></div></div></div><p>This recipe will require that you create a feature layer that will serve as a temporary layer, which will be used with the <strong>Select by Location</strong> and <strong>Select Layer by Attributes</strong> tools. The <strong>Select by Location</strong> tool will find all burglaries that are within the Edgewood School District and apply a selection set to those features. The <strong>Select Layer by Attributes</strong> tool uses the same temporary feature layer and applies a <code class="literal">where</code> clause that finds all burglaries that occurred on Monday. In addition, the tool also specifies that the selection should be a subset of the currently selected features found by the <strong>Select by Location</strong> tool. Finally, you'll print the total number of records that were selected by the combined spatial and attribute query.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec152"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Open IDLE and create a new script window.</li><li class="listitem">Save the script as <code class="literal">c:\ArcpyBook\Ch8\SpatialAttributeQuery.py</code>.</li><li class="listitem">Import the <code class="literal">arcpy</code> module:<div><pre class="programlisting">import arcpy </pre></div></li><li class="listitem">Set the workspace to the City of San Antonio geodatabase:<div><pre class="programlisting">arcpy.env.workspace = "c:/ArcpyBook/data/CityofSanAntonio.gdb"</pre></div></li><li class="listitem">Start a <code class="literal">try</code> block. You'll have to indent the next lines up to the <code class="literal">except</code> block:<div><pre class="programlisting">try:</pre></div></li><li class="listitem">Create a variable for the query and define the <code class="literal">where</code> clause:<div><pre class="programlisting">qry = '"DOW" = \'Mon\''</pre></div></li><li class="listitem">Create the feature layer:<div><pre class="programlisting">flayer = arcpy.MakeFeatureLayer_management("Burglary","Burglary_Layer")</pre></div></li><li class="listitem">Execute the <strong>Select by Location</strong> tool to find all burglaries within the Edgewood School District.<div><pre class="programlisting">arcpy.SelectLayerByLocation_management (flayer, "COMPLETELY_WITHIN", "c:/ArcpyBook/Ch8/EdgewoodSD.shp")</pre></div></li><li class="listitem">Execute the <strong>Select Layer by Attributes</strong> tool to find all burglaries that match the query we defined previously in the <code class="literal">qry</code> variable. This should be defined as a subset query:<div><pre class="programlisting">arcpy.SelectLayerByAttribute_management(flayer, "SUBSET_SELECTION", qry)</pre></div></li><li class="listitem">Print the number of records that were selected:<div><pre class="programlisting">cnt = arcpy.GetCount_management(flayer)</pre></div></li><li class="listitem">Add<a id="id594" class="indexterm"/><a id="id595" class="indexterm"/><a id="id596" class="indexterm"/> the <code class="literal">except</code> block:<div><pre class="programlisting">except:
  print 'Error in selection'</pre></div><p>The entire script should appear as follows:</p><div><pre class="programlisting">import arcpy
arcpy.env.workspace = "c:/ArcpyBook/data/CityOfSanAntonio.gdb"
try:
  qry = '"DOW" = \'Mon\''
  flayer = arcpy.MakeFeatureLayer_management("Burglary","Burglary_Layer")
  arcpy.SelectLayerByLocation_management (flayer, "COMPLETELY_WITHIN", "c:/ArcpyBook/Ch8/EdgewoodSD.shp")
  arcpy.SelectLayerByAttribute_management(flayer, "SUBSET_SELECTION", qry)
	cnt = arcpy.GetCount_management(flayer)
  print "The total number of selected records is: " + str(cnt)
except:
  print 'Error in selection'</pre></div></li><li class="listitem">Save and run the script.<p>If everything was done correctly, you should see a message indicating that 197 records have been selected. This will select all the burglaries within the boundaries of the Edgewood school district that occurred on a Monday.</p><div><pre class="programlisting">
<strong>The total number of selected records is: 197</strong>
</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec153"/>How it works...</h2></div></div></div><p>A new <a id="id597" class="indexterm"/>
<a id="id598" class="indexterm"/>
<a id="id599" class="indexterm"/>feature layer is created with the <strong>Make Feature Layer</strong> tool, and assigned to the variable <code class="literal">flayer</code>. This temporary layer is then used as an input to the <strong>Select by Location</strong> tool along with a spatial operator <code class="literal">COMPLETELY_WITHIN</code>, to find all the burglaries within the Edgewood School District. This same feature layer, with a selection set already defined, is then used as an input parameter to the <strong>Select Layer by Attributes</strong> tool. In addition to passing a reference to the feature layer, the Select Layer by Attributes tool is also passed a parameter that defines the selection type and a <code class="literal">where</code> clause. The selection type is set to <code class="literal">SUBSET_SELECTION</code>. This selection type creates a new selection that is combined with the existing selection. Only the records that are common to both remain selected. The <code class="literal">where</code> clause passed in as the third parameter is an attribute query to find all the burglaries that occurred on Monday. The query uses the <code class="literal">DOW</code> field and looks for a value of <code class="literal">Mon</code>. Finally, the <strong>Get Count</strong> tool is used against the <code class="literal">flayer</code> variable to get a count of the number of selected records, and this is printed on the screen. </p></div></div></div>
</body></html>