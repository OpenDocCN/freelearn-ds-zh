# 第5章。创建出色地图

在本章中，我们将介绍使我们能够创建出色地图的重要功能。我们首先将深入了解高级矢量样式，基于我们在[第2章](ch02.html "第2章。查看空间数据")，“查看空间数据”中学到的知识。然后，我们将通过点标签的示例以及带有道路标志图形的更高级道路标签来学习如何标注要素。我们还将介绍如何手动调整标签。最后，我们将了解打印作曲家以及如何使用它来创建可打印的地图和地图集。

# 高级矢量样式

本节介绍了更高级的矢量样式功能，基于我们在[第2章](ch02.html "第2章。查看空间数据")，“查看空间数据”中看到的基础知识。我们将看到如何使用渐变样式、分类样式和基于规则的样式。

## 使用尺寸缩放创建渐变风格

渐变风格非常适合在等值图中或类似地图中可视化数值分布。在我们的样本数据中，有一个`climate.shp`文件，其中包含位置和平均温度值，我们可以通过简单地选择**列**字段中的值**T_F_MEAN**并点击**分类**来使用渐变风格进行可视化。我们可以选择现有的**颜色渐变**字段，或者通过滚动列表到**新建颜色渐变…**条目来创建一个新的。渐变风格在不同的分类模式中可用，如下所示：

+   **等间隔**：此模式通过在指定列中找到的最大值和最小值之间的等间隔来创建类

+   **分位数（等计数）**：此模式创建类，使得每个类包含相等数量的要素

+   **自然断点（Jenks）**：此模式使用Jenks自然断点算法，通过考虑值的分布来创建类

+   **标准差**：此模式使用列值的标准差来创建类

+   **漂亮的断点**：此模式是唯一不严格创建指定数量的类的分类，而是试图找到漂亮的类断点

除了使用颜色区分不同的温度值外，我们还可以使用大小。通过在**高级**选项卡中将**尺寸比例****字段**设置为**T_F_MEAN**，如图下截图所示，所有点符号都将按比例缩放，使得平均温度较高的位置以更大的符号显示。

### 小贴士

使用**尺寸比例字段**，我们可以使点符号的大小或线符号的宽度响应于某个属性值。请注意，我们可以根据值的性质选择缩放点符号的面积或直径。同样，还有一个**旋转字段**选项，允许我们旋转点符号。预期的输入是从0到360度的度数，0指向北方。

![使用尺寸缩放创建渐变风格](img/7488_05_01.jpg)

以下截图显示了使用**渐变渲染器**选项的结果，其中包含四个类别，使用**漂亮断点**分类模式和**大小缩放字段**选项，如前一个截图所示：

![创建具有大小缩放的渐变样式](img/7488_05_02.jpg)

## 使用分类样式

正如渐变样式对于可视化数值非常有用一样，分类样式非常适合文本值，或者更普遍地说，对于名义尺度上的所有类型的值。这种数据的良好示例可以在我们的样本数据中的`trees.shp`文件中找到。对于每个区域，都有一个**VEGDESC**值，它描述了那里发现的森林类型。使用分类样式，我们可以非常容易地生成一个样式，其中每个唯一的**VEGDESC**列值都有一个符号，如以下截图所示。

当然，每个符号都是可编辑的，并且可以自定义。只需双击符号预览以打开**符号**选择对话框，它允许我们选择和组合不同的符号。

![使用分类样式](img/7488_05_03.jpg)

一旦我们点击**确定**，样式就会应用到我们的树木层上，以可视化该区域不同树种的分布。地图将看起来像以下截图：

![使用分类样式](img/7488_05_04.jpg)

## 为道路层创建基于规则的样式

使用基于规则的样式，我们可以创建一个具有规则层次结构的层样式。规则可以考虑到任何东西，从属性值到比例和几何属性，如面积或长度。以下截图显示了来自Natural Earth的`ne_10m_roads.shp`文件的一个基于规则的渲染器示例（您可以从[http://www.naturalearthdata.com/downloads/10m-cultural-vectors/roads/](http://www.naturalearthdata.com/downloads/10m-cultural-vectors/roads/)下载它）。在规则的第一个级别上，我们区分了**"type" = 'Major Highway'**的道路和**"type" = 'Secondary Highway'**的道路。下一级别的规则处理比例依赖性。要添加这个第二层规则，我们可以使用**细化当前规则**按钮并选择**向规则添加比例**。我们只需输入一个或多个我们希望规则分割的比例值。

### 小贴士

第一规则级别上没有指定任何符号。如果我们也在第一级别指定了符号，渲染器会在每个符号上绘制两个符号。虽然这在某些情况下可能很有用，但我们现在不希望有这种效果。可以在规则属性中禁用符号，这些属性可以通过双击规则或单击规则树视图下方的编辑按钮（位于加号和减号按钮之间）访问。

![为道路层创建基于规则的样式](img/7488_05_05.jpg)

在以下截图中，我们可以看到比例规则在起作用。左侧显示了一个简化版本，次要公路用细灰色线条表示，而右侧版本显示了更宽的白色道路和灰色轮廓。

![为道路图层创建基于规则的样式](img/7488_05_06.jpg)

### 小贴士

您可以通过访问**设置** | **样式管理器** | **共享** | **导入**来下载此样式使用的符号。URL是[https://raw.github.com/anitagraser/QGIS-resources/master/symbols/osm_symbols.xml](https://raw.github.com/anitagraser/QGIS-resources/master/symbols/osm_symbols.xml)。将URL粘贴到**位置**文本框中，点击**获取符号**，然后点击**全选**，最后点击**导入**。对话框将类似于以下截图：

![为道路图层创建基于规则的样式](img/7488_05_07.jpg)

# 标签

我们可以通过访问**图层属性** | **标签**，勾选**使用以下标签标记此图层**，并选择我们想要用于标签的属性字段来激活标签。这就是我们显示默认设置标签所需做的全部。虽然默认标签对于快速预览很好，但如果我们为报告或独立地图创建可视化，我们通常希望自定义标签。

使用**表达式**（位于属性下拉列表右侧的按钮），我们可以格式化标签文本以满足我们的需求。例如，我们样本`airports.shp`文件中的**NAME**字段包含大写文本。为了以混合大小写显示机场名称，我们可以设置表达式`title(NAME)`，这将重新格式化名称文本为标题大小写。我们还可以使用多个字段来创建标签，例如，使用连接运算符`||`将名称和海拔高度在括号中结合，如下所示：

`title(NAME) || ' (' || "ELEV" || ')'`

注意文本周围的简单引号，如`' ('`，以及字段名周围的双引号，如`"ELEV"`。对话框将类似于以下截图：

![标签](img/7488_05_08a.jpg)

对话框顶部的大预览区域，标题为**文本/缓冲区样本**，显示了当前设置的预览。背景颜色可以调整以测试在不同背景上的可读性。在预览区域下方，我们可以找到以下不同的标签设置：

+   **文本**：除了更改字体样式、大小、颜色和透明度外，我们还可以修改字母和单词间距以及混合模式，这与我们在[第2章](ch02.html "第2章。查看空间数据")中介绍的图层混合模式类似，即**查看空间数据**。注意每个设置右侧的按钮列。点击这些按钮允许我们创建所谓的“数据定义覆盖”。例如，我们可以使用这些覆盖来定义不同的标签颜色或根据单个要素的属性值或表达式来改变标签大小。

+   **Formatting**: 在这里，我们可以通过指定哪些字符要换行来启用多行标签。此外，我们可以控制 **line height** 和 **alignment**。我们还可以将表示线条数字化方向的符号添加到标签中。最后，**Formatted numbers** 选项提供了一个快捷方式，可以将数值格式化为特定的小数位数。

+   **Buffer**: 我们可以调整缓冲区大小、颜色和透明度，以及笔尖连接样式和混合模式。通过透明度和混合，我们可以在不过多遮挡底层地图的情况下提高标签的可读性。

+   **Background**: 这允许我们添加矩形、正方形、圆形、椭球体或 SVG 形式的背景形状。SVG 背景非常适合创建如高速公路标志等效果。

+   **Shadow**: 这使得为标签添加阴影成为可能。我们可以控制从阴影方向到颜色、模糊度、大小和透明度的所有内容。

+   **Placement**: 可用的自动标签放置选项取决于图层几何类型。对于点图层，我们可以选择以下选项：

    +   灵活的 **Around point** 选项试图通过在点周围分布标签来找到最佳位置，避免重叠。正如您在下面的屏幕截图中所见，一些标签被放置在其点符号的右上角，而其他标签则出现在左下角的不同位置（例如，**Anchorage Intl (129)**）或右下角（例如，**Merrill Fld (123)**）。

    +   **Offset from point** 选项强制所有标签到某个位置；例如，所有标签都可以放置在其点符号上方。

    以下屏幕截图显示了使用 **Around point** 和 **Label distance** 为 1 mm 放置的带有 50% 透明 **Buffer** 和 **Drop Shadow** 的机场标签：

    ![Labeling](img/7488_05_08.jpg)

    对于线图层，我们可以选择以下选项：

    +   **Parallel** 用于根据线条方向旋转的直行标签

    +   **Curved** 用于跟随线条形状的标签

    +   **Horizontal** 用于保持水平方向的标签，无论线条方向如何

    为了进一步微调，我们可以定义标签是否应放置在 **Above** **line**、**One line** 或 **Below line**，以及使用 **Label distance** 的上下距离。

    以下示例显示了带有道路标志的标签。您可以从 [http://upload.wikimedia.org/wikipedia/commons/c/c3/Blank_shield.svg](http://upload.wikimedia.org/wikipedia/commons/c/c3/Blank_shield.svg) 下载空白道路标志 SVG。注意只有 Interstate 被标记。这可以通过以下标签表达式实现：

    `CASE WHEN "level" = 'Interstate' THEN name END`

    标签使用**水平**选项进行定位。此外，**合并连接的线以避免重复标签**（在渲染部分）和**抑制小于以下特征大小的标签化**被激活；例如，5毫米有助于避免在当前比例下标签化长度小于5毫米的路段，从而避免杂乱。

    ![标签化](img/7488_05_09.jpg)

    要设置道路标志，请转到**背景**部分，并从您下载到的文件夹中选择空白盾牌SVG。为了确保标签能够很好地位于盾牌内部，我们另外指定了**大小类型**字段为带有**大小**为1毫米的缓冲区，这使得盾牌比包含的标签略大。

    如果您现在点击**应用**，您会注意到标签并没有完美地居中在盾牌内。为了解决这个问题，我们在盾牌位置应用了一个小的**Y方向偏移**，如图下所示。此外，我建议禁用标签**缓冲**，因为它往往会遮挡盾牌的一部分，而我们实际上也不需要它。

    ![标签化](img/7488_05_10.jpg)

    对于多边形图层，选项如下：

    +   **从质心偏移**，它使用多边形质心作为锚点，对于点图层来说，它的工作方式类似于**从点偏移**。

    +   **围绕质心**的工作方式类似于**围绕点**。

    +   **水平**将水平标签放置在多边形内的某个位置，独立于质心。

    +   **自由**选项将自由旋转的标签放置在多边形内。

    +   **使用周长**将标签放置在多边形轮廓上。

    以下截图显示了使用**多行**功能在空格字符上环绕的湖泊标签（`lakes.shp`），并使用**自由**选项定位：

    ![标签化](img/7488_05_11.jpg)

    ### 提示

    默认情况下，QGIS会避免标签重叠，但出于调试目的，使用渲染部分中的选项强制**显示所有标签（包括碰撞的标签）**可能很有用。

    除了自动标签定位外，我们还可以选择使用数据定义定位来精确放置标签。在标签工具栏中，我们可以找到手动移动和旋转标签的工具。它们仅在至少设置了X和Y坐标的数据定义定位的图层上激活和可用。要开始使用这些工具，我们可以在例如`airports.shp`文件中简单地添加三个新列，`label_x`、`label_y`和`label_rot`。然后，我们可以通过按下**偏移X, Y**和**旋转**旁边的按钮来在数据定义设置中指定这些列。现在我们不需要在属性表中输入任何值。标签引擎将检查值，如果它发现属性字段为空，它将简单地自动放置标签。通过指定数据定义定位，标签工具栏的工具现在可用（注意编辑模式必须开启），我们可以使用这些工具来移动和旋转地图上的任何标签。更改将写回属性表。尝试移动一些标签，特别是它们放置得很近的地方，并观察自动放置的标签如何适应你的更改。

+   **渲染**：这允许我们定义基于**比例的可见性**限制，以在特定比例下显示标签，以及基于**像素大小**的可见性来隐藏小特征上的标签。在这里，我们还可以告诉标签引擎**显示冲突标签**，这些标签默认情况下通常会被隐藏。

# 设计打印地图

在QGIS中，打印地图是在打印布局中设计的。一个QGIS项目可以包含多个布局，因此选择描述性的名称是有意义的。布局在保存项目时自动保存。要查看项目中所有可用布局的列表，请转到**项目** | **布局管理器**。

我们可以通过转到**项目** | **新建打印布局**或使用*Ctrl* + *P*来打开一个新的布局。布局窗口包括以下内容：

+   一个用于显示空白页的地图布局预览区域

+   配置**布局**、**项属性**、**图集生成**的面板，以及一个用于快速撤销和重做的**命令历史**面板

+   用于管理、保存和导出布局的工具栏，在预览区域中导航，以及添加和排列不同的布局项

**布局**面板让我们可以访问纸张选项，如大小、方向和页数。这也是配置吸附行为和输出分辨率的地点。

首先，我们通过点击**添加新地图**按钮，或者通过转到**布局** | **添加地图**并在纸上绘制地图矩形来将地图项添加到文档中。点击纸张，按住鼠标按钮，并拖动矩形打开。我们可以使用鼠标和**选择/移动项**工具来移动、调整大小和缩放地图。或者，也可以在**项属性**面板中配置所有地图设置。

**项目属性**面板的内容取决于当前选定的组合项。如果选择了地图项，我们可以调整地图的**比例**和**范围**，以及地图项本身的**位置和大小**工具。在**比例**为10,000,000时，我们可以在A4纸上大致放置阿拉斯加。要移动地图项内显示的区域，我们可以使用**移动项目内容**工具。

在地图看起来符合我们的要求后，我们可以使用**添加新刻度尺**按钮或通过转到**布局** | **添加刻度尺**并点击地图来添加刻度尺。现在，**项目属性**面板显示刻度尺的属性，类似于以下截图所示。由于我们可以将多个地图项添加到一个组合中，因此指定哪个地图属于刻度尺很重要。第二个主要属性是刻度尺样式，它允许我们选择不同的刻度尺类型或用于简单文本表示（如1:10,000,000）的**数值**类型。使用**单位**属性，我们可以将地图单位从英尺或米转换为更易于管理的单位，如英里或千米。

**段**属性控制刻度尺中段落数量和单个段落的尺寸。此外，这些属性还控制刻度尺的颜色、字体、背景等。

可以使用**添加图像**按钮或通过转到**布局** | **添加图像**并点击纸张来向组合中添加北箭头。在QGIS加载SVG文件夹中图像的预览时，**项目属性**面板可能需要一段时间才能更新。从QGIS附带图像列表中选择北箭头或选择自己的SVG。还可以使用适当的工具栏按钮（如**添加箭头**、**添加矩形**等）添加进一步的地图装饰，如箭头或矩形、三角形和椭圆形形状。

![设计打印地图](img/7488_05_12.jpg)

显示近距离区域的地图通常伴随着第二张地图，告诉读者该区域在更大背景中的位置。要创建这样的概览图，我们添加第二个地图项并激活其**概览**选项。通过设置**概览框架**，我们可以定义应该突出显示哪个详细地图的范围。

### 小贴士

组合中的每个地图项都可以显示不同的图层组合。通常，作曲器中的地图项与主QGIS窗口中的地图同步。因此，如果我们关闭主窗口中的图层，它也会从打印作曲器地图中删除。但是，我们可以通过在地图项属性中启用**锁定图层**来停止这种自动同步。

其他常见的地图功能包括网格和坐标框架。可以为任何地图项目启用网格。我们可以在**实心**网格或**十字**之间进行选择。**间隔**和**偏移**值必须以地图单位指定。此外，我们可以激活**条纹**样式和**绘制坐标**在框架内部或外部，如下面的截图所示：

![设计打印地图](img/7488_05_13.jpg)

线条图是地图的另一个重要元素。我们可以使用**添加新线条图**按钮或转到**布局** | **添加线条图**来添加一个包含所有当前可见地图层条目的默认线条图。线条图条目可以在线条图项目属性中进行重新组织、编辑和删除。使用**在**选项，我们可以将长标签拆分为多行，如下面的截图所示。此外，本例中的线条图分为四列。默认情况下，QGIS尝试将一个层的所有条目保持在单列中，但我们可以通过启用**拆分图层**来覆盖此行为。

要向地图添加文本，我们可以使用**添加新标签**按钮或转到**布局** | **添加标签**。简单标签使用相同的字体显示所有文本。通过启用**渲染为HTML**，我们可以创建更复杂的标签，包括标题、列表、不同颜色以及使用正常HTML标记的加粗或斜体突出显示，例如：

[PRE0]

标签还可以包含如下表达式：

+   `[% $now %]` 在组合中插入当前时间戳

+   `[% $page %] of [% $numpages %]` 在多页组合中插入页码

使用**添加HTML框架**按钮可以添加更高级的文本区域。我们可以将项目的URL引用指向我们本地机器或在线上的任何HTML页面，内容将在作曲页面上显示。

![设计打印地图](img/7488_05_14.jpg)

要向地图添加更多详细信息，作曲器还提供了使用**添加属性表**按钮或通过转到**布局** | **添加属性表**来添加属性表的可能性。通过启用**仅显示可见要素**，我们可以过滤表格并仅显示相关结果。通过**属性…**按钮可以进行列排序和重命名。

最后，**图集生成**面板使我们能够使用一个打印组合创建一系列地图。该工具将为图集配置中定义的**覆盖层**下拉列表中的每个要素创建一个地图。覆盖层中的要素可以像常规要素一样显示或通过启用**隐藏覆盖层**来隐藏。**要素排序**和**要素过滤**使我们可以进一步微调结果。

使用**固定比例**选项，所有地图都将使用相同的比例渲染。如果我们需要更灵活的输出，我们可以切换到**边缘周围功能**选项，该选项将缩放到每个覆盖层特征，并在指定的边缘周围区域渲染其外。**输出**字段可以是每个覆盖层特征的图像或PDF，或者通过在进入**作曲家** | **导出为PDF**之前启用**单文件导出**，可以生成多页PDF。

![设计打印地图](img/7488_05_15.jpg)

# 摘要

在本章中，我们更深入地探讨了如何使用高级矢量图层样式，如分类样式或基于规则的样式来创建一些更复杂的地图。我们还介绍了QGIS中可用的自动和手动特征标签选项。本章还展示了如何使用打印作曲家创建可打印的地图，并介绍了用于创建地图集的Atlas功能。恭喜！在之前的章节中，你已经学习了如何安装和使用QGIS来创建、编辑、分析空间数据，以及如何有效地展示它。
