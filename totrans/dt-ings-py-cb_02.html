<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer060">
<h1 class="chapter-number" id="_idParaDest-64"><a id="_idTextAnchor064"/>2</h1>
<h1 id="_idParaDest-65"><a id="_idTextAnchor065"/>Principals of Data Access – Accessing Your Data</h1>
<p><strong class="bold">Data access</strong> is a term that refers to the ability to store, retrieve, transfer, and copy data from one system or application to another. It crucially involves security, legal, and, in some cases, national <a id="_idIndexMarker077"/>matters. In addition to the last two, we will also cover some security topics in <span class="No-Break">this chapter.</span></p>
<p>As data engineers or scientists, knowing how to retrieve data correctly is necessary. Some of it may<a id="_idIndexMarker078"/> require <strong class="bold">encrypted authentication</strong>, and for this, we need to understand how some decrypting libraries work and how to use them without compromising or leaking sensitive data. Data access also refers to the levels of authorization a system or database have, from administration to <span class="No-Break">read-only roles.</span></p>
<p>In this chapter, we will cover how the levels of data access are defined and the most used libraries and authentication methods in the data <span class="No-Break">ingestion process.</span></p>
<p>In this chapter, you will work through the <span class="No-Break">following recipes:</span></p>
<ul>
<li>Implementing governance in a data <span class="No-Break">access workflow</span></li>
<li>Accessing databases and <span class="No-Break">data warehouses</span></li>
<li>Accessing <strong class="bold">SSH File Transfer Protocol</strong> (<span class="No-Break"><strong class="bold">SFTP</strong></span><span class="No-Break">) ﬁles</span></li>
<li>Retrieving data using <span class="No-Break">API authentication</span></li>
<li>Managing <span class="No-Break">encrypted files</span></li>
<li>Accessing data <span class="No-Break">from AWS</span></li>
<li>Accessing data <span class="No-Break">from GCP</span></li>
</ul>
<h1 id="_idParaDest-66"><a id="_idTextAnchor066"/>Technical requirements</h1>
<p>A Google Cloud account<a id="_idIndexMarker079"/> can be easily created if you already have a Gmail account, and most of the resources can be accessed with a free tier. It also provides $300 of credit for resources that are not free. It is a good incentive if you want to make other tests using the other recipes in this book <span class="No-Break">inside GCP.</span></p>
<p>To access and enable a <a id="_idIndexMarker080"/>Google Cloud account, go to the <a href="https://cloud.google.com/">https://cloud.google.com/</a> page and follow the steps provided on <span class="No-Break">the screen.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">All the recipes covered in this chapter are eligible to use the <span class="No-Break">free tier.</span></p>
<p>You can also find the code from this chapter in this GitHub repository <span class="No-Break">here: </span><a href="https://github.com/PacktPublishing/Data-Ingestion-with-Python-Cookbook"><span class="No-Break">https://github.com/PacktPublishing/Data-Ingestion-with-Python-Cookbook</span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-67"><a id="_idTextAnchor067"/>Implementing governance in a data access workflow</h1>
<p>As<a id="_idIndexMarker081"/> we saw previously, <strong class="bold">data access</strong> or <strong class="bold">accessibility</strong> is a <strong class="bold">governance</strong> pillar and is <a id="_idIndexMarker082"/>closely related to security. Data safety is not only a concern for <a id="_idIndexMarker083"/>administrators or managers but also for everyone that is involved with data. Having said that, it is essential to know how to design a base workflow to implement security layers for our data, allowing only authorized people to read or <span class="No-Break">manipulate it.</span></p>
<p>This recipe will <a id="_idIndexMarker084"/>create a workflow with<a id="_idIndexMarker085"/> essential topics to implement data <span class="No-Break">access management.</span></p>
<h2 id="_idParaDest-68"><a id="_idTextAnchor068"/>Getting ready</h2>
<p>Before designing our workflow, we need to identify the vectors interfering with our <span class="No-Break">data access.</span></p>
<p>So, what are <span class="No-Break">data vectors?</span></p>
<p>Vectors <a id="_idIndexMarker086"/>are paths someone can use to gain unauthorized access to a server, network, or database. In this case, we will identify the ones related to <span class="No-Break">data leaks.</span></p>
<p>Let’s explore them in a visual form, as shown in the <span class="No-Break">following diagram:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer032">
<img alt="Figure 2.1 – Data governance vectors" height="375" src="image/Figure_2.1_B19453.jpg" width="1541"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.1 – Data governance vectors</p>
<p>Let us <a id="_idIndexMarker087"/>understand each of these stages in the<a id="_idIndexMarker088"/> <span class="No-Break">path here:</span></p>
<ol>
<li><strong class="bold">Data creation</strong>: In this step, we identify where data is created and by who. With this definition, we can ensure only the <strong class="bold">accountable</strong> can have access to create or <span class="No-Break">update data.</span></li>
<li><strong class="bold">Storage of data</strong>: After creation, it’s important to know where our data is or will be stored. Depending on the answer to this question, the methods to retrieve data will be different and can require <span class="No-Break">additional steps.</span></li>
<li><strong class="bold">Management of users and services</strong>: Data must be used, and people need access. Here, we define the <em class="italic">actors</em> or the roles we might have, and the common types are <strong class="bold">administrator</strong>, <strong class="bold">write</strong>, and <span class="No-Break"><strong class="bold">read-only</strong></span><span class="No-Break"> roles.</span></li>
<li><strong class="bold">Transferring data</strong>: How will our data be transferred? It is essential to decide whether it will be real-time, near real-time, or batch. You can add further questions to your workflows, such as how the data will be available for transfers via API or any <span class="No-Break">other method.</span></li>
</ol>
<h2 id="_idParaDest-69"><a id="_idTextAnchor069"/>How to do it…</h2>
<p>After <a id="_idIndexMarker089"/>identifying our vectors, we can <a id="_idIndexMarker090"/>define the implementation workflow for data <span class="No-Break">access management.</span></p>
<p>To make it easy to understand how to implement it, let’s imagine a hypothetical scenario of a new application where we want to retrieve medical records <span class="No-Break">from patients.</span></p>
<p>Here is how we <span class="No-Break">do it:</span></p>
<ol>
<li>The first step is to document all our data and classify it. If there is confidential data, we need to work out how to <span class="No-Break">identify it.</span></li>
<li>Then, we will start to define who can access the data accordingly with the necessary usage. For example, we determine the data administrators and write or read-only <span class="No-Break">permissions here.</span></li>
<li>Once levels of access to data are implemented, we start observing how users will behave. Implementing logs to a database, data warehouse, or any other system with user activity <span class="No-Break">is crucial.</span></li>
<li>Finally, we examine the whole process to determine whether any change <span class="No-Break">is needed.</span></li>
</ol>
<p>In the end, we will have a flow diagram similar to the <span class="No-Break">following diagram:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer033">
<img alt="Figure 2.2 – A flow diagram to start implementing data governance" height="336" src="image/Figure_2.2_B19453.jpg" width="585"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.2 – A flow diagram to start implementing data governance</p>
<h2 id="_idParaDest-70"><a id="_idTextAnchor070"/>How it works…</h2>
<p>Data <a id="_idIndexMarker091"/>access management is an ongoing<a id="_idIndexMarker092"/> process. Every day, we ingest and create new pipelines to be used by several people on different teams. Here is how <span class="No-Break">it goes:</span></p>
<ol>
<li><strong class="bold">Discovering, classifying, and documenting all your data</strong>: The first thing to organize is our data. Which<a id="_idIndexMarker093"/> patient’s data are we going to retrieve? Does it contain <strong class="bold">Personally Identifiable Information</strong> (<strong class="bold">PII</strong>) or <strong class="bold">Protected/Personal Health Information</strong> (<strong class="bold">PHI</strong>)? Since it’s the first<a id="_idIndexMarker094"/> time we are ingesting this data, we need to catalog it with flags about PII and who is responsible for the <span class="No-Break">source data.</span></li>
<li><strong class="bold">Creating access controls</strong>: Here, we define access based on roles since not everybody needs access to patient history. We allocate permissions to data based on the roles, responsibilities, <span class="No-Break">and classification.</span></li>
<li><strong class="bold">Examining the users’ behaviors</strong>: In this step, we observe how our users behave in their roles. The creation, updates, and deletion actions are logged to be monitored and reviewed if needed. If a medical department no longer uses a report, we can restrict their access or even stop them from ingesting information <span class="No-Break">for them.</span></li>
<li><strong class="bold">Analyzing and reviewing requirements for compliance</strong>: We must ensure our access management follows compliance and local regulations. Legal regulations <a id="_idIndexMarker095"/>apply differently for<a id="_idIndexMarker096"/> different types of data, which needs to <span class="No-Break">be considered.</span></li>
</ol>
<h2 id="_idParaDest-71"><a id="_idTextAnchor071"/>See also</h2>
<ul>
<li><em class="italic">Healthcare Data Breaches </em><span class="No-Break"><em class="italic">Statistics</em></span><span class="No-Break">: </span><a href="https://www.hipaajournal.com/healthcare-data-breach-statistics/"><span class="No-Break">https://www.hipaajournal.com/healthcare-data-breach-statistics/</span></a></li>
<li><em class="italic">European Data Protection Supervisor. Health data in the </em><span class="No-Break"><em class="italic">workspace</em></span><span class="No-Break">: </span><a href="https://edps.europa.eu/data-protection/data-protection/reference-library/health-data-workplace_en"><span class="No-Break">https://edps.europa.eu/data-protection/data-protection/reference-library/health-data-workplace_en</span></a></li>
</ul>
<h1 id="_idParaDest-72"><a id="_idTextAnchor072"/>Accessing databases and data warehouses</h1>
<p><strong class="bold">Databases</strong> are the <a id="_idIndexMarker097"/>foundation of any system or application, no matter your architecture. A database is sometimes needed to store logs, user activities or information, and <span class="No-Break">system stuff.</span></p>
<p>Putting it in a bigger perspective, data warehouses have the <a id="_idIndexMarker098"/>same usage but are related to analytical data. After ingesting and transforming data, we need to load it somewhere where it is easier to retrieve analytic information for use on dashboards, <span class="No-Break">reports, etc.</span></p>
<p>Currently, it is possible to find several types of databases (of the SQL and NoSQL types) and data warehouse architectures. However, this recipe aims to cover how access control is usually done for both relational structures. The goal is to understand how the access levels are defined, even using a <span class="No-Break">generic scenario.</span></p>
<h2 id="_idParaDest-73"><a id="_idTextAnchor073"/>Getting ready</h2>
<p>For this<a id="_idIndexMarker099"/> recipe, we will use MySQL. You can install it following the instructions on the <a id="_idIndexMarker100"/>MySQL official page <span class="No-Break">here: </span><a href="https://dev.mysql.com/downloads/installer/"><span class="No-Break">https://dev.mysql.com/downloads/installer/</span></a><span class="No-Break">.</span></p>
<p>You can use any SQL client you choose to execute the queries here. In my case, I will use <span class="No-Break">MySQL Workbench:</span></p>
<ol>
<li>First, we will create a database using our <strong class="source-inline">root</strong> user. You can name it what you like. My recommendation here is to set the charset <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">UTF-8</strong></span><span class="No-Break">:</span><pre class="source-code">
CREATE SCHEMA `your_schema_name` DEFAULT CHARACTER SET utf8 ;</pre></li>
</ol>
<p>My schema will be <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">cookbook-data</strong></span><span class="No-Break">.</span></p>
<ol>
<li value="2">The next step is creating tables. Still using the root account, we will create a <strong class="source-inline">people_city</strong> table using <a id="_idIndexMarker101"/>the <strong class="bold">Data Definition Language</strong> (<span class="No-Break"><strong class="bold">DDL</strong></span><span class="No-Break">) syntax:</span><pre class="source-code">
<strong class="bold">CREATE TABLE `cookbook-data`.`people_city` (</strong>
  `id` INT NOT NULL,
  `name` VARCHAR(45) NULL,
  `country` VARCHAR(45) NULL,
  `occupation` VARCHAR(45) NULL,
  PRIMARY KEY (`id`));</pre></li>
</ol>
<h2 id="_idParaDest-74"><a id="_idTextAnchor074"/>How to do it…</h2>
<p class="callout-heading">Note</p>
<p class="callout">Since the last update from MySQL 8.0, we can’t create users directly using the <strong class="source-inline">GRANT</strong> command. An error like this <span class="No-Break">will appear:</span></p>
<p class="callout"><strong class="source-inline">ERROR 1410 (42000): You are not allowed to create a user </strong><span class="No-Break"><strong class="source-inline">with GRANT</strong></span></p>
<p class="callout">To solve this issue, we will take some additional steps. We will also need at least two sessions of MySQL open, so keep that in mind if you opt to execute the commands directly on your <span class="No-Break">command line.</span></p>
<p class="callout">I would like to also thank Lefred’s blog for this solution and contribution to the community. You can find more details and other useful information at their blog <span class="No-Break">here: </span><a href="https://lefred.be/content/how-to-grant-privileges-to-users-in-mysql-8-0/"><span class="No-Break">https://lefred.be/content/how-to-grant-privileges-to-users-in-mysql-8-0/</span></a><span class="No-Break">.</span></p>
<p>Let us see <a id="_idIndexMarker102"/>the steps to<a id="_idIndexMarker103"/> perform <span class="No-Break">this recipe:</span></p>
<ol>
<li>First, let’s create the <strong class="source-inline">admin</strong> user. Here, we will start to have problems if we do not follow the following steps correctly. We need to create a user to be our superuser or administrator, using our <span class="No-Break"><strong class="source-inline">root user</strong></span><span class="No-Break">:</span><pre class="source-code">
CREATE user 'admin'@'localhost' identified by 'password';
&gt; Query OK, 0 rows affected</pre></li>
<li>Then, we log in with the <strong class="source-inline">admin</strong> user. Using the password you defined in <em class="italic">step 1</em>, log in to the MySQL console using the <strong class="source-inline">admin</strong> user. We can’t see any databases yet on the SQL software client, but we will fix this in the following step. After logging in to the console, you can see the SQL command ready to <span class="No-Break">be used:</span><pre class="source-code">
$ mysql -u admin -p password -h localhost
Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
mysql&gt;</pre></li>
</ol>
<p>Keep this <span class="No-Break">session open.</span></p>
<ol>
<li value="3">Then, we<a id="_idIndexMarker104"/> grant permissions<a id="_idIndexMarker105"/> to the <strong class="source-inline">admin</strong> user by role. In the root session, let’s create a role called <strong class="source-inline">administration</strong> and grant full access to our database to the <span class="No-Break"><strong class="source-inline">admin</strong></span><span class="No-Break"> user:</span><pre class="source-code">
create ROLE administration;</pre></li>
</ol>
<p>We then grant permissions to <span class="No-Break">the role:</span></p>
<pre class="source-code">
grant alter,create,delete,drop,index,insert,select,update,trigger,alter routine,create routine, execute, create temporary tables on `cookbook_data`.* to 'administration';</pre>
<p>We then grant the role to our <span class="No-Break"><strong class="source-inline">admin</strong></span><span class="No-Break"> user:</span></p>
<pre class="source-code">
grant 'administration' to 'admin';</pre>
<p>We then set this role as <span class="No-Break">the default:</span></p>
<pre class="source-code">
set default role 'administration' to 'admin';</pre>
<ol>
<li value="4">Next, like in <em class="italic">step 2</em>, we create another two users, the <strong class="source-inline">write</strong> and <span class="No-Break"><strong class="source-inline">read-only</strong></span><span class="No-Break"> roles.</span></li>
</ol>
<p>Repeat <em class="italic">step 3</em>, giving the new roles names, and for these two roles, my recommendation is to grant the <span class="No-Break">following privileges:</span></p>
<ul>
<li><strong class="bold">Writing permission</strong>: <strong class="source-inline">alter</strong>, <strong class="source-inline">create</strong>, <strong class="source-inline">index</strong>, <strong class="source-inline">insert</strong>, <strong class="source-inline">select</strong>, <strong class="source-inline">update</strong>, <strong class="source-inline">trigger</strong>, <strong class="source-inline">alter routine</strong>, <strong class="source-inline">create routine</strong>, <strong class="source-inline">execute</strong>, and <strong class="source-inline">create </strong><span class="No-Break"><strong class="source-inline">temporary tables</strong></span></li>
<li><strong class="bold">Read-only permission</strong>: <strong class="source-inline">select</strong> <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">execute</strong></span></li>
</ul>
<ol>
<li value="5">Next, we perform the actions. If we try to perform <strong class="source-inline">INSERT</strong> using our <strong class="source-inline">admin</strong> or <strong class="source-inline">write</strong> roles, we can see it <span class="No-Break">is viable:</span><pre class="source-code">
INSERT INTO `cookbook_data`.`people_city` (id, `name`, country, occupation)
VALUES (1, 'Lin', 'PT', 'developer');
&gt; 1 row(s) affected</pre></li>
</ol>
<p>However, the same can’t be done by the <span class="No-Break"><strong class="source-inline">read-only</strong></span><span class="No-Break"> user:</span></p>
<pre class="source-code">
Error Code: 1142. INSERT command denied to user 'reader'@'localhost' for table 'people_city'</pre>
<h2 id="_idParaDest-75"><a id="_idTextAnchor075"/>How it works…</h2>
<p>In a real-world project, most of the time, there is a dedicated person (or database administrator) to handle and take care of access to databases or data warehouses. Nonetheless, any person who needs to access a relational data source needs to understand the basic concepts of the access levels to ask for its permissions (and <span class="No-Break">justify it).</span></p>
<p>In this recipe, we used a <strong class="bold">Role-Based Access Control</strong> (<strong class="bold">RBAC</strong>) model<a id="_idIndexMarker106"/> to define and attribute the role levels to the users. We created custom roles in our case, even though MySQL already has some built-in models. You can access the built-in models using the <strong class="source-inline">show </strong><span class="No-Break"><strong class="source-inline">privileges</strong></span><span class="No-Break"> command.</span></p>
<p><strong class="source-inline">alter</strong>, <strong class="source-inline">create</strong>, <strong class="source-inline">delete</strong>, <strong class="source-inline">drop</strong>, <strong class="source-inline">index</strong>, <strong class="source-inline">insert</strong>, <strong class="source-inline">select</strong>, <strong class="source-inline">update</strong>, <strong class="source-inline">trigger</strong>, <strong class="source-inline">alter routine</strong>, <strong class="source-inline">create routine</strong>, <strong class="source-inline">execute</strong>, and <strong class="source-inline">create temporary tables</strong> are the common commands used daily, and knowing them makes it easier to identify an error. Let’s take, for example, the <span class="No-Break">earlier error:</span></p>
<pre class="source-code">
<strong class="bold">Error Code: 1142. INSERT command denied to user 'reader'@'localhost' for table 'people_city'</strong></pre>
<p>The <a id="_idIndexMarker107"/>first line shows precisely<a id="_idIndexMarker108"/> the permission we need. The second line shows us which user (<strong class="source-inline">reader</strong>) lacks permission, the connection they are using <strong class="source-inline">(@localhost</strong>), and the table (<strong class="source-inline">people_city</strong>) they want <span class="No-Break">to access.</span></p>
<p>In addition, if you are a system administrator, you can also identify behavior that is not allowed and help to <span class="No-Break">solve it.</span></p>
<h2 id="_idParaDest-76"><a id="_idTextAnchor076"/>There’s more…</h2>
<p>If you<a id="_idIndexMarker109"/> are <a id="_idIndexMarker110"/>interested<a id="_idIndexMarker111"/> to know more, it is <a id="_idIndexMarker112"/>also possible to <a id="_idIndexMarker113"/>find three other types of access<a id="_idIndexMarker114"/> control for databases and<a id="_idIndexMarker115"/> <span class="No-Break">data warehouses:</span></p>
<ul>
<li><strong class="bold">Discretionary Access </strong><span class="No-Break"><strong class="bold">Control</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">DAC</strong></span><span class="No-Break">)</span></li>
<li><strong class="bold">Mandatory Access </strong><span class="No-Break"><strong class="bold">Control</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">MAC</strong></span><span class="No-Break">)</span></li>
<li><strong class="bold">Attribute-Based Access </strong><span class="No-Break"><strong class="bold">Control</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">ABAC</strong></span><span class="No-Break">)</span></li>
</ul>
<p>The following figure illustrates access control in a summarized version, <span class="No-Break">as follows:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer034">
<img alt="Figure 2.3 – A database access control comparison – source: https://www.cloudradius.com/access-control-paradigms-compared-rbac-vs-pbac-vs-abac/" height="532" src="image/Figure_2.3_B19453.jpg" width="1151"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.3 – A database access control comparison – source: https://www.cloudradius.com/access-control-paradigms-compared-rbac-vs-pbac-vs-abac/</p>
<p>Even though it is <a id="_idIndexMarker116"/>not described in the preceding figure, we can also find databases that use <strong class="bold">row and column-based access control</strong>. You can find out more about it <span class="No-Break">here: </span><a href="https://documentation.datavirtuality.com/23/reference-guide/authentication-access-control-and-security/access-control/data-roles/permissions/row-and-column-based-security"><span class="No-Break">https://documentation.datavirtuality.com/23/reference-guide/authentication-access-control-and-security/access-control/data-roles/permissions/row-and-column-based-security</span></a><span class="No-Break">.</span></p>
<h2 id="_idParaDest-77"><a id="_idTextAnchor077"/>See also</h2>
<ul>
<li>Here is an<a id="_idIndexMarker117"/> article by <em class="italic">Raimundas Matulevicius</em> and <em class="italic">Henri Lakk</em> on RBAC that discusses in depth the best approaches in several <span class="No-Break">cases: </span><a href="https://www.researchgate.net/publication/281479020_A_Model-driven_Role-based_Access_Control_for_SQL_Databases"><span class="No-Break">https://www.researchgate.net/publication/281479020_A_Model-driven_Role-based_Access_Control_for_SQL_Databases</span></a></li>
<li>This article by <em class="italic">Arundhati Singh</em> offers a perspective on RBAC mode implementation in enterprise <span class="No-Break">networks: </span><a href="https://dspace.mit.edu/bitstream/handle/1721.1/87870/53700676-MIT.pdf?sequence=2"><span class="No-Break">https://dspace.mit.edu/bitstream/handle/1721.1/87870/53700676-MIT.pdf?sequence=2</span></a></li>
</ul>
<h1 id="_idParaDest-78"><a id="_idTextAnchor078"/>Accessing SSH File Transfer Protocol (SFTP) ﬁles</h1>
<p>The <strong class="bold">File Transfer Protocol</strong> (<strong class="bold">FTP</strong>) was <a id="_idIndexMarker118"/>introduced in the 1970s at<a id="_idIndexMarker119"/> <strong class="bold">Massachusetts Institute of Technology</strong> (<strong class="bold">MIT</strong>) and is based on the <strong class="bold">Transmission Control Protocol/Internet Protocol</strong> (<strong class="bold">TCP/IP</strong>) application layer. Since the 1980s, it has been widely <a id="_idIndexMarker120"/>used to transfer files <span class="No-Break">between computers.</span></p>
<p>Over the years, and with the increase in computer and internet usage, it became necessary to introduce a more secure way to use this<a id="_idIndexMarker121"/> solution. An <strong class="bold">SSH layer</strong> was implemented to improve the security<a id="_idIndexMarker122"/> of <strong class="bold">FTP transactions</strong>, creating the <strong class="bold">SSH File Transfer Protocol</strong> (<span class="No-Break"><strong class="bold">SFTP</strong></span><span class="No-Break">) protocol.</span></p>
<p>Nowadays, it is common to ingest data from SFTP servers, and in this recipe, we will work to retrieve data from a public <span class="No-Break">SFTP server.</span></p>
<h2 id="_idParaDest-79"><a id="_idTextAnchor079"/>Getting ready</h2>
<p>In this recipe, we will create code with Python, using the <strong class="source-inline">pysftp</strong> library, to connect and retrieve sample data from a public <span class="No-Break">SFTP server.</span></p>
<p>If you own an <a id="_idIndexMarker123"/>SFTP server, feel free to test the Python code here to exercise a <span class="No-Break">little more:</span></p>
<ol>
<li>First, we will <a id="_idIndexMarker124"/>get the SFTP credentials. Go to the SFTP.NET address at https://www.sftp.net/public-online-sftp-servers, and save the <strong class="bold">Hostname</strong> and <strong class="bold">Login</strong> (username/password) information on <span class="No-Break">a notepad.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer035">
<img alt="Figure 2.4 – The SFTP.NET main page" height="1832" src="image/Figure_2.4_B19453.jpg" width="1586"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.4 – The SFTP.NET main page</p>
<p class="callout-heading">Note</p>
<p class="callout">This SFTP server is intended to be used only for testing and studying purposes. Because of that, the credentials are insecure and publicly available, and for production purposes, that information needs to be secured in a password vault and never shared <span class="No-Break">through code.</span></p>
<ol>
<li value="2">Then, we<a id="_idIndexMarker125"/> install the Python <strong class="source-inline">pysftp</strong> package using the <span class="No-Break">command line:</span><pre class="source-code">
<strong class="bold">$ pip install pysftp</strong></pre></li>
</ol>
<h2 id="_idParaDest-80"><a id="_idTextAnchor080"/>How to do it…</h2>
<p>Here are the steps to perform <span class="No-Break">this recipe:</span></p>
<ol>
<li>First, let’s create a Python file called <strong class="source-inline">accessing_sftp_files.py</strong>. Then, we insert the following code to create our SFTP connection <span class="No-Break">with Python:</span><pre class="source-code">
<strong class="bold">import pysftp</strong>
host = " test.rebex.net"
username = "demo"
password = "password"
with pysftp.Connection(host=host, username=username, password=password) as sftp:
    print("Connection successfully established ... ")</pre></li>
</ol>
<p>You can call the file using the <span class="No-Break">following command:</span></p>
<pre class="source-code">
$ python accessing_sftp_files.py</pre>
<p>Here is the output <span class="No-Break">for it:</span></p>
<pre class="source-code">
Connection successfully established ...</pre>
<p>Here, a known error might occur – <strong class="source-inline">SSHException: No hostkey for host </strong><span class="No-Break"><strong class="source-inline">test.rebex.net found</strong></span><span class="No-Break">.</span></p>
<p>This happens because pysftp can’t find hostkey in <span class="No-Break">your KnowHosts.</span></p>
<p>If this error occurs, follow the <span class="No-Break">next steps:</span></p>
<ol>
<li value="2">Go to your command line and execute <span class="No-Break"><strong class="source-inline">ssh demo@test.rebex.net</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer036">
<img alt="Figure 2.5 – Adding a host to the known_hosts list" height="175" src="image/Figure_2.5_B19453.jpg" width="1428"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.5 – Adding a host to the known_hosts list</p>
<ol>
<li value="3">Insert the<a id="_idIndexMarker126"/> password for the <strong class="source-inline">demo</strong> user and exit Rebex <span class="No-Break">Virtual Shell:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer037">
<img alt="Figure 2.6 – A welcome message from the Rebex SFTP server" height="172" src="image/Figure_2.6_B19453.jpg" width="694"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.6 – A welcome message from the Rebex SFTP server</p>
<ol>
<li value="4">Then, we list the files in the <span class="No-Break">SFTP server:</span><pre class="source-code">
import pysftp
host = "test.rebex.net"
username = "demo"
password = "password"
with pysftp.Connection(host=host, username=username, password=password) as sftp:
    print("Connection successfully established ... ")
    # Switch to a remote directory
    sftp.cwd('pub/example/')
    # Obtain structure of the remote directory '/pub/example'
    directory_structure = sftp.listdir_attr()
    # Print data
    for attr in directory_structure:
        print(attr.filename, attr)</pre></li>
</ol>
<p>Now, let’s download the <span class="No-Break"><strong class="source-inline">readme.txt</strong></span><span class="No-Break"> file:</span></p>
<p>Let’s change the <a id="_idIndexMarker127"/>last lines of our code to be able to <span class="No-Break">download </span><span class="No-Break"><strong class="source-inline">readme.txt</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
import pysftp
host = "test.rebex.net"
username = "demo"
password = "password"
with pysftp.Connection(host=host, username=username, password=password) as sftp:
    print("Connection successfully established ... ")
    # Switch to a remote directory
    sftp.cwd('pub/example/')
    print("Changing to pub/example directory... ")
    sftp.get('readme.txt', 'readme.txt')
    print("File downloaded ... ")
    sftp.close()</pre>
<p>The output for this is <span class="No-Break">as follows:</span></p>
<pre class="source-code">
Connection successfully established ...
Changing to pub/example directory...
File downloaded ...</pre>
<h2 id="_idParaDest-81"><a id="_idTextAnchor081"/>How it works…</h2>
<p><strong class="source-inline">pysftp</strong> is a Python library<a id="_idIndexMarker128"/> that allows developers to<a id="_idIndexMarker129"/> connect, upload, and download data from SFTP servers. Its use is straightforward, and the library has tons <span class="No-Break">of functionalities.</span></p>
<p>Note that most of our code is indented inside <strong class="source-inline">pysftp.Connection</strong>. This happens because we create a connection session for that particular credential. The <strong class="source-inline">with</strong> statement makes the acquisition and release of the resources, and as you can see, it is widely used in file streams, locks, sockets, and <span class="No-Break">so on.</span></p>
<p>We also used the <strong class="source-inline">sftp.cwd()</strong> method, allowing us to change the directory and avoid specifying the path whenever we need to list or <span class="No-Break">retrieve files.</span></p>
<p>Finally, the download was made using <strong class="source-inline">sftp.get()</strong>, where the first parameter is the path and the name of the file we want to download, and the second is where we will put it. Since we are already inside the file’s directory, we can save it in our local <span class="No-Break"><strong class="source-inline">HOME</strong></span><span class="No-Break"> directory.</span></p>
<p>Last but not least, <strong class="source-inline">sftp.close()</strong> closes the connection. This is excellent practice in ingesting scripts to avoid <a id="_idIndexMarker130"/>network concurrency with other pipelines or the <span class="No-Break">SFTP server.</span></p>
<h2 id="_idParaDest-82"><a id="_idTextAnchor082"/>There’s more…</h2>
<p>If you want to go deeper and make other <a id="_idIndexMarker131"/>tests, you can also create a local <span class="No-Break">SFTP server.</span></p>
<p>For Linux users, it is possible to do this using the <strong class="source-inline">ssh</strong> command line. You can see more <span class="No-Break">here: </span><a href="https://linuxhint.com/setup-sftp-server-ubuntu/"><span class="No-Break">https://linuxhint.com/setup-sftp-server-ubuntu/</span></a><span class="No-Break">.</span></p>
<p>For Windows users, go<a id="_idIndexMarker132"/> to the <strong class="bold">SFTP Servers</strong> section <span class="No-Break">here: </span><a href="https://www.sftp.net/servers"><span class="No-Break">https://www.sftp.net/servers</span></a><span class="No-Break">.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer038">
<img alt="Figure 2.7 – The SFTP.NET page, with a link to a tutorial on how to create a small SFTP server" height="720" src="image/Figure_2.7_B19453.jpg" width="1548"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.7 – The SFTP.NET page, with a link to a tutorial on how to create a small SFTP server</p>
<p>Select <strong class="bold">Rebex Tiny SFTP Server</strong> under <strong class="bold">Minimalist SFTP servers</strong>, download it, and start <span class="No-Break">the program.</span></p>
<h2 id="_idParaDest-83"><a id="_idTextAnchor083"/>See also</h2>
<ul>
<li>Creating a<a id="_idIndexMarker133"/> local SFTP server with <span class="No-Break">Docker: </span><a href="https://hub.docker.com/r/atmoz/sftp"><span class="No-Break">https://hub.docker.com/r/atmoz/sftp</span></a></li>
</ul>
<h1 id="_idParaDest-84"><a id="_idTextAnchor084"/>Retrieving data using API authentication</h1>
<p>An <strong class="bold">Application Programming Interface</strong> (<strong class="bold">API</strong>) is a<a id="_idIndexMarker134"/> set of configurations that allows two systems or applications to communicate or transmit data with each other. Its concept has been improved in recent years, allowing faster<a id="_idIndexMarker135"/> transmissions and more security<a id="_idIndexMarker136"/> with <strong class="bold">OAuth</strong> methods, preventing <strong class="bold">Denial of Service</strong> (<strong class="bold">DoS</strong>) or <strong class="bold">Distributed Denial of Service</strong> (<strong class="bold">DDoS</strong>) attacks, and <span class="No-Break">so </span><span class="No-Break"><a id="_idIndexMarker137"/></span><span class="No-Break">on.</span></p>
<p>Its use is widely applied in data ingesting, whether to retrieve data from an application to retrieve the latest logs for analysis or <a id="_idIndexMarker138"/>from <strong class="bold">BigQuery</strong> using a cloud provider such as Google. Most applications nowadays make their data available through an API service, from which the data world gets a lot of benefits. The critical aspect here is to know <a id="_idIndexMarker139"/>how to retrieve data from an API service using <a id="_idIndexMarker140"/>the most accepted forms <span class="No-Break">of authentication.</span></p>
<p>In this recipe, we will retrieve data from a public API using API key authentication, a standard method to <span class="No-Break">gather data.</span></p>
<h2 id="_idParaDest-85"><a id="_idTextAnchor085"/>Getting ready</h2>
<p>Since we will use two different methods, this section will be split to make it easy to understand how to <span class="No-Break">handle them.</span></p>
<p>For this section, we will use the HolidayAPI, a public and free API that provides information about <span class="No-Break">holidays worldwide:</span></p>
<ol>
<li>Install the Python <span class="No-Break"><strong class="source-inline">requests</strong></span><span class="No-Break"> library:</span><pre class="source-code">
<strong class="bold">$ pip3 install requests</strong></pre></li>
<li>Then, access the Holiday API website. Go to <a href="https://holidayapi.com/">https://holidayapi.com/</a> and click on <strong class="bold">Get Your Free API Key</strong>. You should see the <span class="No-Break">following page:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer039">
<img alt="Figure 2.8 – The Holidays API main web page" height="842" src="image/Figure_2.8_B19453.jpg" width="955"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.8 – The Holidays API main web page</p>
<ol>
<li value="3">Then, we <a id="_idIndexMarker141"/>create an account and get the API <a id="_idIndexMarker142"/>Key. To create an account, you can use an email and password or sign up with your <span class="No-Break">GitHub account:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer040">
<img alt="Figure 2.9 – The Holiday API user authentication page" height="822" src="image/Figure_2.9_B19453.jpg" width="506"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.9 – The Holiday API user authentication page</p>
<p>After the authentication, you can see and copy your API Key. Note that you can also generate a new one at <span class="No-Break">any time.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer041">
<img alt="Figure 2.10 – The user dashboard page on the Holiday API page" height="802" src="image/Figure_2.10_B19453.jpg" width="926"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.10 – The user dashboard page on the Holiday API page</p>
<p class="callout-heading">Note</p>
<p class="callout">We will use the free tier of this API, which has limited requests per month. It is also prohibited from <span class="No-Break">commercial use.</span></p>
<h2 id="_idParaDest-86"><a id="_idTextAnchor086"/>How to do it…</h2>
<p>Here are the<a id="_idIndexMarker143"/> steps to perform<a id="_idIndexMarker144"/> <span class="No-Break">the recipe:</span></p>
<ol>
<li>We create a Python script using the <span class="No-Break"><strong class="source-inline">requests</strong></span><span class="No-Break"> library:</span><pre class="source-code">
<strong class="bold">import requests</strong>
import json
params = { 'key': 'YOUR-API-KEY',
          'country': 'BR',
          'year': 2022
}
url = "https://holidayapi.com/v1/holidays?"
req = requests.get(url, params=params)
<strong class="bold">print(req.json())</strong></pre></li>
</ol>
<p>Ensure <a id="_idIndexMarker145"/>you use a <strong class="source-inline">year</strong> value equal to your<a id="_idIndexMarker146"/> previous year since we are using a free version of the API, which is limited to last year’s <span class="No-Break">historical data.</span></p>
<p>Here is the output for <span class="No-Break">the code:</span></p>
<pre class="source-code">
<strong class="bold">{'status': 200, 'warning': 'These results do not include state and province holidays. For more information, please visit https://holidayapi.com/docs', 'requests': {'used': 7, 'available': 9993, 'resets': '2022-11-01 00:00:00'}, 'holidays': [{'name': "New Year's Day", 'date': '2021-01-01', 'observed': '2021-01-01', 'public': True, 'country': 'BR', 'uuid': 'b58254f9-b38b-42c1-8b30-95a095798b0c',{...}</strong></pre>
<p class="callout-heading">Note</p>
<p class="callout">As a best practice, the API key should never be hardcoded in the script. The definition here is for <span class="No-Break">educational purposes.</span></p>
<ol>
<li value="2">Then, we save our API request as a <span class="No-Break">JSON file:</span><pre class="source-code">
<strong class="bold">import requests</strong>
import json
params = { 'key': 'YOUR-API-KEY',
          'country': 'BR',
          'year': 2022
}
url = "https://holidayapi.com/v1/holidays?"
req = requests.get(url, params=params)
with open("holiday_brazil.json", "w") as f:
<strong class="bold">    json.dump(req.json(), f)</strong></pre></li>
</ol>
<h2 id="_idParaDest-87"><a id="_idTextAnchor087"/>How it works…</h2>
<p>The Python <strong class="source-inline">requests</strong> library<a id="_idIndexMarker147"/> is one of the most downloaded libraries on the PyPi servers. This popularity is not surprising, as we will see when we work with the library and see its power <span class="No-Break">and versatility.</span></p>
<p>In <em class="italic">step 1</em>, we <a id="_idIndexMarker148"/>imported both the <strong class="source-inline">requests</strong> and <strong class="source-inline">json</strong> modules <a id="_idIndexMarker149"/>at the beginning of the Python script. The <strong class="source-inline">params</strong> dictionary is a payload sender to the API, so we inserted the API key and the two other <span class="No-Break">mandatory fields.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">This API authorization key was sent through a payload request; however, it depends on how the API is built. Some request that the authentication is sent via <strong class="source-inline">Header</strong> definitions, for instance. Always check the API documentation or developer to understand how to <span class="No-Break">authenticate correctly.</span></p>
<p>The <strong class="source-inline">print()</strong> function in <em class="italic">step 1</em> served as a test to see whether our calls <span class="No-Break">were authenticated.</span></p>
<p>With the API call <a id="_idIndexMarker150"/>returning a <strong class="source-inline">200</strong> status code, we proceed to save<a id="_idIndexMarker151"/> the <strong class="source-inline">JSON</strong> file, and you should have output <span class="No-Break">like this:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer042">
<img alt="Figure 2.11 – The downloaded JSON file data" height="1305" src="image/Figure_2.11_B19453.jpg" width="1648"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.11 – The downloaded JSON file data</p>
<h2 id="_idParaDest-88"><a id="_idTextAnchor088"/>There’s more…</h2>
<p>API keys<a id="_idIndexMarker152"/> are commonly used to authenticate clients, but other security methods such as OAuth should be considered, depending on the data <span class="No-Break">sensitivity level.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">API key authentication can only be considered secure if associated with other security mechanisms such <span class="No-Break">as HTTPS/SSL.</span></p>
<h3>Authentication using the OAuth method</h3>
<p><strong class="bold">Open Authorization</strong> (<strong class="bold">OAuth</strong>) is an<a id="_idIndexMarker153"/> industry-standard protocol to authorize websites or applications to communicate and access informa<a href="https://oauth.net/2/">tion. You can find<span id="_idIndexMarker154"/> </a>out more about it on the official documentation page <span class="No-Break">here: </span><a href="https://oauth.net/2/"><span class="No-Break">https://oauth.net/2/</span></a><span class="No-Break">.</span></p>
<p>You can also test this type of authentication with<a id="_idIndexMarker155"/> the <strong class="bold">Google Calendar API</strong>. To enable the OAuth met<a href="https://edps.europa.eu/data-protection/data-protection/reference-library/health-data-workplace_en">hod, follow <span class="No-Break">these steps:</span></a></p>
<ol>
<li><a href="https://edps.europa.eu/data-protection/data-protection/reference-library/health-data-workplace_en">Enable the Google<span id="_idIndexMarker156"/> Calendar API by </a>visiting the page at <a href="https://developers.google.com/calendar/api/quickstart/python">https://developers.google.com/calendar/api/quickstart/python</a>, and then go to the <strong class="bold">Enable </strong><span class="No-Break"><strong class="bold">APIs</strong></span><span class="No-Break"> section.</span></li>
</ol>
<p>A new tab will open, and <strong class="bold">Google Cloud</strong> will <a id="_idIndexMarker157"/>ask you to select or create a new project. Select the project you want <span class="No-Break">to use.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">If you opt to create a new project, insert the project name in the <strong class="bold">Project’s Name</strong> field and leave the <strong class="bold">Organization</strong> field with the default value (<span class="No-Break"><strong class="bold">No Organization</strong></span><span class="No-Break">).</span></p>
<p>Select <strong class="bold">Next</strong> to confirm your project, and then click on <strong class="bold">Activate</strong>; you should then see <span class="No-Break">this page:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer043">
<img alt="Figure 2.12 – The GCP page to activate a resource API" height="372" src="image/Figure_2.12_B19453.jpg" width="1047"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.12 – The GCP page to activate a resource API</p>
<p>Now, we are almost ready to get <span class="No-Break">our credentials.</span></p>
<ol>
<li value="2">Enable OAuth authentication by returning to the page at <a href="https://developers.google.com/calendar/api/quickstart/python">https://developers.google.com/calendar/api/quickstart/python</a>, clicking on <strong class="bold">Go to Credentials</strong>, and following the instructions under <strong class="bold">Authorize credentials for a </strong><span class="No-Break"><strong class="bold">desktop application</strong></span><span class="No-Break">.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer044">
<img alt="Figure 2.13 – GCP tutorial page to create the credentials.json file" height="831" src="image/Figure_2.13_B19453.jpg" width="1217"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.13 – GCP tutorial page to create the credentials.json file</p>
<p>At the end of this, you should have a <strong class="source-inline">credentials.json</strong> file for this recipe. Keep this file safe, since all<a id="_idIndexMarker158"/> calls to the Google API will require it to <a id="_idIndexMarker159"/>verify <span class="No-Break">your authenticity.</span></p>
<p>You can use one of the GCP script examples to test this authentication method. Google has a Python script sample to retrieve data from <a id="_idIndexMarker160"/>the <strong class="bold">Google Calendar API</strong>, which can be accessed <span class="No-Break">here: </span><a href="https://github.com/googleworkspace/python-samples/blob/main/calendar/quickstart/quickstart.py"><span class="No-Break">https://github.com/googleworkspace/python-samples/blob/main/calendar/quickstart/quickstart.py</span></a><span class="No-Break">.</span></p>
<h3>Other authentication methods</h3>
<p>Even though we covered the two<a id="_idIndexMarker161"/> most common methods to authenticate to an API, a data ingestion pipeline is not limited to In your day-to-day work, you're likely to find legacy systems or applications that require other forms <span class="No-Break">of authentication.</span></p>
<p>Methods<a id="_idIndexMarker162"/> such as <strong class="bold">HTTP Basic and Bearer</strong>, <strong class="bold">OpenID Connect</strong>, and <strong class="bold">OpenAPI security schemes</strong> are also<a id="_idIndexMarker163"/> widely used. You can find more details about them in<a id="_idIndexMarker164"/> this article written by <em class="italic">Guy </em><span class="No-Break"><em class="italic">Levin</em></span><span class="No-Break">: </span><a href="https://blog.restcase.com/4-most-used-rest-api-authentication-methods/"><span class="No-Break">https://blog.restcase.com/4-most-used-rest-api-authentication-methods/</span></a><span class="No-Break">.</span></p>
<h3>SFTP versus API</h3>
<p>You might be <a id="_idIndexMarker165"/>wondering, what is the difference between ingesting data from an SFTP server and an API? It is clear that they authenticate differently, and the code also behaves distinctly. But when should we implement an SFTP or API to make data available <span class="No-Break">for ingestion?</span></p>
<p>FTP or SFTP <a id="_idIndexMarker166"/>transactions are designed to use <strong class="bold">flat files</strong>, such as <strong class="bold">CSV</strong>, <strong class="bold">XML</strong>, and <strong class="bold">JSON </strong>files. These two types <a id="_idIndexMarker167"/>of transactions also perform well when we need to transfer bulk data, and it <a id="_idIndexMarker168"/>is the only method available for older systems. An <a id="_idIndexMarker169"/>API <a id="_idIndexMarker170"/>provides real-time data delivery and a more secure internet-based connection, and its integration with several cloud applications has made it popular in the data ingestion world. However, API calls are sometimes paid for based on the number <span class="No-Break">of requests.</span></p>
<p>This file transaction architecture discussion is primarily for financial and HR systems, which may use some old programming language versions. The system architecture discussion is based on flat files or real-time data in more recent and <span class="No-Break">cloud-based applications.</span></p>
<h2 id="_idParaDest-89"><a id="_idTextAnchor089"/>See also</h2>
<ul>
<li>You can find a list of public APIs with different types of auth methods<a id="_idIndexMarker171"/> <span class="No-Break">here: </span><a href="https://github.com/public-apis/public-apis"><span class="No-Break">https://github.com/public-apis/public-apis</span></a></li>
<li>The Holiday API <a id="_idIndexMarker172"/>Python <span class="No-Break">Client: </span><a href="https://github.com/holidayapi/holidayapi-python"><span class="No-Break">https://github.com/holidayapi/holidayapi-python</span></a></li>
<li>The Python <strong class="source-inline">requests</strong> library<a id="_idIndexMarker173"/> <span class="No-Break">documentation: </span><a href="https://requests.readthedocs.io/en/latest/user/quickstart/"><span class="No-Break">https://requests.readthedocs.io/en/latest/user/quickstart/</span></a></li>
</ul>
<h1 id="_idParaDest-90"><a id="_idTextAnchor090"/>Managing encrypted ﬁles</h1>
<p>When handling <a id="_idIndexMarker174"/>sensitive data is common, some fields or even the entire file is encrypted. It is comprehensive when this file security measure is implemented since sensitive data can expose the life of users. After all, encryption is the process of converting information into code that hides the <span class="No-Break">original content.</span></p>
<p>Nonetheless, we must still ingest and process these encrypted files in our data pipelines. To be able to do so, we need to understand a bit more about how encryption works and how it <span class="No-Break">is done.</span></p>
<p>In this recipe, we will decrypt a GnuPG-encrypted (where <strong class="bold">GnuPG</strong> stands for <strong class="bold">GNU Privacy Guard</strong>) file using <a id="_idIndexMarker175"/>Python libraries and <span class="No-Break">best practices.</span></p>
<h2 id="_idParaDest-91"><a id="_idTextAnchor091"/>Getting ready</h2>
<p>Before jumping<a id="_idIndexMarker176"/> into the fun part, we must install the GnuPG library on our local machine and download the <span class="No-Break">encrypted dataset.</span></p>
<p>You will need two installations for the GnuPG file – one for the <strong class="bold">operating system</strong> (<strong class="bold">OS</strong>) and another for a Python package. This because the Python package requires internal resources from the installed <span class="No-Break">OS package:</span></p>
<ol>
<li>To use the Python wrapper library, we first need to install the GnuPG on our <span class="No-Break">local machine:</span><pre class="source-code">
<strong class="bold">$ sudo apt-get install gnupg</strong></pre></li>
</ol>
<p>For Windows users, it is recommended to download the executable file <span class="No-Break">here: </span><a href="https://gnupg.org/download/index.xhtml"><span class="No-Break">https://gnupg.org/download/index.xhtml</span></a><span class="No-Break">.</span></p>
<p>Mac users can install it using <span class="No-Break">Homebrew: </span><a href="https://formulae.brew.sh/formula/gnupg"><span class="No-Break">https://formulae.brew.sh/formula/gnupg</span></a><span class="No-Break">.</span></p>
<ol>
<li value="2">Then, we install the Python GnuPG wrapper <span class="No-Break">as follows:</span><pre class="source-code">
$ pip3 install python-gnupg
Collecting python-gnupg
  Downloading python_gnupg-0.5.0-py2.py3-none-any.whl (18 kB)
Installing collected packages: python-gnupg
Successfully installed python-gnupg-0.5.0</pre></li>
<li>Next, we download the <strong class="bold">spotify tracks chart encrypted</strong> dataset. You can use this link to download the <span class="No-Break">file: </span><a href="https://github.com/PacktPublishing/Data-Ingestion-with-Python-Cookbook/tree/main/Chapter_2/managing_encrypted_%EF%AC%81les"><span class="No-Break">https://github.com/PacktPublishing/Data-Ingestion-with-Python-Cookbook/tree/main/Chapter_2/managing_encrypted_%EF%AC%81les</span></a><span class="No-Break">.</span></li>
</ol>
<h2 id="_idParaDest-92"><a id="_idTextAnchor092"/>How to do it…</h2>
<p>We will <a id="_idIndexMarker177"/>need a key to decrypt the file using GnuPG. You can find it in the <strong class="bold">GitHub</strong> repository of this book, inside the <a href="B19453_02.xhtml#_idTextAnchor064"><span class="No-Break"><em class="italic">Chapter 2</em></span></a><strong class="source-inline"> | Managing encrypted ﬁles</strong> folder. The link to access it is in the <em class="italic">Technical requirements</em> section at the beginning of <span class="No-Break">this chapter:</span></p>
<ol>
<li>First, we import <span class="No-Break">our key:</span><pre class="source-code">
import gnupg
# Create gnupg directory
gpg = gnupg.GPG(gnupghome='gpghome')
# Open and import the key
key_data = open('mykeyfile.asc').read()
import_result = gpg.import_keys(key_data)
# Show the fingerprint of our key
print(import_result.results)</pre></li>
<li>Then, we decrypt the <span class="No-Break">ingestion file:</span><pre class="source-code">
with open('spotify_data.csv.gpg', 'rb') as f:
    status = gpg.decrypt_file(f, passphrase='mypassphrase', output='spotify_data.csv')
print(status.ok)
print(status.status)
print('error: ', status.stderr)</pre></li>
</ol>
<h2 id="_idParaDest-93"><a id="_idTextAnchor093"/>How it works…</h2>
<p>Regarding<a id="_idIndexMarker178"/> the best practices for encrypting, GnuPG is a security reference and widely used, and it is documented in <strong class="bold">RFC 4880</strong>. You can find out more <span class="No-Break">here: </span><a href="https://www.rfc-editor.org/rfc/rfc4880"><span class="No-Break">https://www.rfc-editor.org/rfc/rfc4880</span></a><span class="No-Break">.</span></p>
<p class="callout-heading">Note</p>
<p class="callout">A <strong class="bold">Request for Comments</strong> (<strong class="bold">RFC</strong>) is a<a id="_idIndexMarker179"/> technical documentation developed and maintained by the <strong class="bold">Internet Engineering Task Force</strong> (<strong class="bold">IETF</strong>). This <a id="_idIndexMarker180"/>institute specifies the best practices for protocols, services, and patterns on <span class="No-Break">the internet.</span></p>
<p>Here, we saw a real-life example of GnuPG application, even though it seems simple. Let’s pass through some important lines in <span class="No-Break">the code:</span></p>
<p>In the <strong class="source-inline">gpg = gnupg.GPG(gnupghome='gpghome')</strong> line, we instantiated our <strong class="source-inline">GPG</strong> class and passed where it can store temporary files, and you can set any path you want to. In my case, I created a folder in my home directory <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">gpghome</strong></span><span class="No-Break">.</span></p>
<p>In the next lines, the key is imported, and we print its fingerprint just for <span class="No-Break">demonstration purposes.</span></p>
<p>For <em class="italic">step 2</em>, we open the file we want to decrypt using the <strong class="source-inline">with open</strong> statement and decrypt it. You can see that a parameter for <strong class="source-inline">passphrase</strong> was set. This happened because the more recent versions of GnuPG require the file to have a passphrase set when encrypted. Since this recipe is only for educational matters, the passphrase here is simple <span class="No-Break">and hardcoded.</span></p>
<p>After that, you <a id="_idIndexMarker181"/>should be able to open the <strong class="source-inline">.csv</strong> file with <span class="No-Break">no problems.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer045">
<img alt="Figure 2.14 – The decrypted Spotify CSV file" height="793" src="image/Figure_2.14_B19453.jpg" width="1318"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.14 – The decrypted Spotify CSV file</p>
<h2 id="_idParaDest-94"><a id="_idTextAnchor094"/>There’s more…</h2>
<p>Usually, GnuPG is <a id="_idIndexMarker182"/>the tool of choice when it comes to encrypting files, but there are other market solutions such as the Python <strong class="source-inline">cryptography</strong> library, which has a <strong class="source-inline">Fernet</strong> class, a symmetric encryption method. As you can see in the following code, its use is very similar to what we did in <span class="No-Break">this recipe:</span></p>
<pre class="source-code">
from cryptography.fernet import Fernet
# Retrieving key
fernet_key = Fernet(key)
# Getting and opening the encrypted file
with open('spotify_data.csv', 'rb') as enc_file:
    encrypted = enc_file.read()
# Decrypting the file
decrypted = fernet_key.decrypt(encrypted)
# Creating a decrypted file
with open('spotify_data.csv', 'wb') as dec_file:
    dec_file.write(decrypted)</pre>
<p>Still, the <strong class="source-inline">Fernet</strong> method is not widely used in the data world. It happens because an encrypted file with sensitive data often comes from an application or software that uses GnuPG hybrid encryption, which, as we saw in the <em class="italic">How it works…</em> section, complies with <span class="No-Break">RFC 4880.</span></p>
<p>You can find more details in <a id="_idIndexMarker183"/>the <strong class="source-inline">cryptography</strong> library <span class="No-Break">documentation: </span><a href="https://cryptography.io/en/latest/fernet/"><span class="No-Break">https://cryptography.io/en/latest/fernet/</span></a><span class="No-Break">.</span></p>
<h2 id="_idParaDest-95"><a id="_idTextAnchor095"/>See also</h2>
<ul>
<li>How to<a id="_idIndexMarker184"/> create and encrypt files using the <strong class="bold">Python Wrapper for </strong><span class="No-Break"><strong class="bold">GnuPG</strong></span><span class="No-Break">: </span><a href="https://gnupg.readthedocs.io/en/latest/"><span class="No-Break">https://gnupg.readthedocs.io/en/latest/</span></a><span class="No-Break">.</span></li>
<li>GnuPG official <a id="_idIndexMarker185"/>page and <span class="No-Break">documentation: </span><a href="https://gnupg.org/"><span class="No-Break">https://gnupg.org/</span></a><span class="No-Break">.</span></li>
<li>If you are curious about RFC 4880 and want to understand it deeper, a summarized article about it was written by David Steele in his <span class="No-Break">blog: </span><a href="https://davesteele.github.io/gpg/2014/09/20/anatomy-of-a-gpg-key/"><span class="No-Break">https://davesteele.github.io/gpg/2014/09/20/anatomy-of-a-gpg-key/</span></a><span class="No-Break">.</span></li>
<li><em class="italic">Voltage by opentext</em> is a great tool<a id="_idIndexMarker186"/> for data security and recommended by many companies. You can find out more <span class="No-Break">here: </span><a href="https://www.microfocus.com/en-us/cyberres/data-privacy-protection"><span class="No-Break">https://www.microfocus.com/en-us/cyberres/data-privacy-protection</span></a><span class="No-Break">.</span></li>
</ul>
<h1 id="_idParaDest-96"><a id="_idTextAnchor096"/>Accessing data from AWS using S3</h1>
<p>AWS<a id="_idIndexMarker187"/> is one of the most popular cloud providers, mixing different service architectures and allowing easy and <span class="No-Break">fast implementations.</span></p>
<p>While it has various solutions for relational and non-relational databases, in this recipe, we will cover how to manage data access<a id="_idIndexMarker188"/> from <strong class="bold">S3 buckets</strong>, which is an object storage service allowing not only text files to be uploaded, but also media and several other types of files used in the IoT and big <span class="No-Break">data fields.</span></p>
<p>There are two commonly used types of <a id="_idIndexMarker189"/>data access management for S3 buckets, both used on ingest pipelines – <strong class="bold">user control</strong> and <strong class="bold">bucket policies</strong>. In this recipe, we will learn how to manage access by user control, given <a id="_idIndexMarker190"/>that it is the most used method among data <span class="No-Break">ingestion pipelines.</span></p>
<h2 id="_idParaDest-97"><a id="_idTextAnchor097"/>Getting ready</h2>
<p>To do this<a id="_idIndexMarker191"/> recipe, having or creating an AWS account is not <a id="_idIndexMarker192"/>mandatory. The objective is to build a step-by-step <strong class="bold">Identity Access Management</strong> (<strong class="bold">IAM)</strong> policy<a id="_idIndexMarker193"/> to retrieve data from an S3 bucket using good data access practices <span class="No-Break">you understand.</span></p>
<p>However, if you want to create a free AWS account to test it, you can follow the steps provided by the <strong class="bold">AWS official docs</strong> here: <a href="https://docs.aws.amazon.com/accounts/latest/reference/manage-acct-creating">https://docs.aws.amazon.com/accounts/latest/reference/manage-acct-creating</a>.xhtml. After creating your AWS account, follow <span class="No-Break">these steps:</span></p>
<ol>
<li>Let’s create a user to test our S3 policy. To create a user, check out this AWS link: <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.xhtml">https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.xhtml</a>. You don’t need to worry about attaching policies to it, so skip this part of the tutorial. The idea is to explore what a user without any policies attached can do inside the <span class="No-Break">AWS console.</span></li>
<li>Next, let’s create an S3 bucket using our administrator user. On the search bar, type <strong class="source-inline">S3</strong> and click on the <span class="No-Break">first link:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer046">
<img alt="Figure 2.15 – The AWS search bar" height="696" src="image/Figure_2.15_B19453.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.15 – The AWS search bar</p>
<ol>
<li value="3">Then, click<a id="_idIndexMarker194"/> the <strong class="bold">Create bucket</strong> button and a new page will<a id="_idIndexMarker195"/> load <span class="No-Break">as follows:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer047">
<img alt="Figure 2.16 – The AWS S3 main page" height="663" src="image/Figure_2.16_B19453.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.16 – The AWS S3 main page</p>
<p>A new page will load <span class="No-Break">as follows:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer048">
<img alt="Figure 2.17 – The AWS S3 page to create a new bucket" height="960" src="image/Figure_2.17_B19453.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.17 – The AWS S3 page to create a new bucket</p>
<p>On the <strong class="bold">Create Bucket</strong> page, insert the name of your bucket (it must be a unique name) and<a id="_idIndexMarker196"/> select the region you want to use. I will <a id="_idIndexMarker197"/>use <strong class="source-inline">Stockholm</strong> in this recipe since it is the nearest region to where I live. Skip the other fields for now, scroll down, and press the <strong class="bold">Create </strong><span class="No-Break"><strong class="bold">bucket</strong></span><span class="No-Break"> button:</span></p>
<p>On the S3 page, you know should be able to see and select the bucket <span class="No-Break">you created:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer049">
<img alt="Figure 2.18 – The S3 bucket objects page" height="848" src="image/Figure_2.18_B19453.jpg" width="1657"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.18 – The S3 bucket objects page</p>
<p>You can upload any files here for testing if you <span class="No-Break">want to.</span></p>
<p>After completing<a id="_idIndexMarker198"/> the steps, open another window on your browser and <a id="_idIndexMarker199"/>switch to the user you created for testing. If possible, try to keep administrator and testing users logged on in different browsers so that you can see the changes in <span class="No-Break">real time.</span></p>
<p>We are ready to start creating and applying the <span class="No-Break">access policy.</span></p>
<h2 id="_idParaDest-98"><a id="_idTextAnchor098"/>How to do it…</h2>
<p>If we try to list <strong class="bold">S3</strong>, we can see the buckets, but when clicking on any bucket, this error <span class="No-Break">will happen:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer050">
<img alt="Figure 2.19 – Testing the user view of an S3 bucket with an Insufficient permissions message" height="581" src="image/Figure_2.19_B19453.jpg" width="916"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.19 – Testing the user view of an S3 bucket with an Insufficient permissions message</p>
<p>Let’s fix this by creating and attaching a policy with the <span class="No-Break">following steps:</span></p>
<ol>
<li>First, we will <a id="_idIndexMarker200"/>define an access policy for the user. The user will <a id="_idIndexMarker201"/>be capable of listing, retrieving, and deleting any object inside the S3 bucket we created. Let’s start by creating a JSON file with the AWS policy requirements to make it possible. See the <span class="No-Break">following file:</span><pre class="source-code">
{
   "Version":"2012-10-17",
   "Statement":[
      {
         "Effect":"Allow",
         "Action": "s3:ListAllMyBuckets",
         "Resource":"*"
      },
      {
         "Effect":"Allow",
         "Action":["s3:ListBucket","s3:GetBucketLocation"],
         "Resource":"arn:aws:s3:::cookbook-s3-accesspolicies"
      },
      {
         "Effect":"Allow",
         "Action":[
            "s3:PutObject",
            "s3:PutObjectAcl",
            "s3:GetObject",
            "s3:GetObjectAcl",
            "s3:DeleteObject"
         ],
         "Resource":"arn:aws:s3:::cookbook-s3-accesspolicies /*"
      }
   ]
}</pre></li>
<li>Next, we allow the <a id="_idIndexMarker202"/>user to access the bucket via IAM <a id="_idIndexMarker203"/>policies. On the user IAM page, click on <strong class="bold">Add inline policy</strong> <span class="No-Break">as follows:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer051">
<img alt="Figure 2.20 – AWS user Permission policy section" height="979" src="image/Figure_2.20_B19453.jpg" width="863"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.20 – AWS user Permission policy section</p>
<p>Insert the previous code <a id="_idIndexMarker204"/>into the <strong class="bold">JSON</strong> option tab, and click on <strong class="bold">Review policy</strong>. On<a id="_idIndexMarker205"/> the <strong class="bold">Review Policy</strong> page, insert the policy’s name and click <strong class="bold">Create policy</strong> to confirm it, <span class="No-Break">as follows:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer052">
<img alt="Figure 2.21 – The AWS IAM review policy page" height="533" src="image/Figure_2.21_B19453.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.21 – The AWS IAM review policy page</p>
<p>If we check now, we can see that adding but not deleting files <span class="No-Break">is possible.</span></p>
<h2 id="_idParaDest-99"><a id="_idTextAnchor099"/>How it works…</h2>
<p>At the beginning of <a id="_idIndexMarker206"/>this recipe, our testing user had no permission to access <a id="_idIndexMarker207"/>any resources at AWS. For example, when accessing our created bucket, a warning appeared on the page. Then we allowed the user to access and upload files or objects to <span class="No-Break">the bucket.</span></p>
<p>In <em class="italic">step 1</em>, we built an inline IAM policy with the <span class="No-Break">following steps:</span></p>
<ol>
<li>First, we allowed the testing user to list all the buckets inside the respective <span class="No-Break">AWS account:</span><pre class="source-code">
"Statement":[
      {
         "Effect":"Allow",
         "Action": "s3:ListAllMyBuckets",
         "Resource":"*"
      },</pre></li>
<li>The second statement allows the user to list objects and get the bucket’s location. Note that<a id="_idIndexMarker208"/> in the <strong class="bold">Resource</strong> key, we only specified a target S3 bucket <strong class="bold">AWS Resource </strong><span class="No-Break"><strong class="bold">Name</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">ARN</strong></span><span class="No-Break">):</span><pre class="source-code">
{
         "Effect":"Allow",
         "Action":["s3:ListBucket","s3:GetBucketLocation"],
         "Resource":"arn:aws:s3:::cookbook-s3-accesspolicies"
      },</pre></li>
<li>Finally, we <a id="_idIndexMarker209"/>create another statement to allow the <a id="_idIndexMarker210"/>insertion and retrieval of objects. In this case, the resource now also has a <strong class="source-inline">/*</strong> character at the end of the ARN. This represents the policy that is going to affect the respective <span class="No-Break">bucket objects:</span><pre class="source-code">
{
         "Effect":"Allow",
         "Action":[
            "s3:PutObject",
            "s3:PutObjectAcl",
            "s3:GetObject",
            "s3:GetObjectAcl",
         ],
         "Resource":"arn:aws:s3:::cookbook-s3-accesspolicies /*"
      }</pre></li>
</ol>
<p>Depending on the AWS resource you want to manage access, the <strong class="bold">Action</strong> key can be very different and can have different applications. Regarding S3 buckets and objects, you find all possible actions in the AWS <span class="No-Break">documentation: </span><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/using-with-s3-actions.xhtml"><span class="No-Break">https://docs.aws.amazon.com/AmazonS3/latest/userguide/using-with-s3-actions.xhtml</span></a><span class="No-Break">.</span></p>
<h2 id="_idParaDest-100"><a id="_idTextAnchor100"/>There’s more…</h2>
<p>When ingesting data, the user control method is the most used. It happens because an application such use <strong class="bold">Airflow</strong> or <strong class="bold">Elastic MapReduce</strong> (<strong class="bold">EMR</strong>) can usually connect to a bucket. Also, from a <a id="_idIndexMarker211"/>management control <a id="_idIndexMarker212"/>perspective, it is much easier to handle, with just a few programmatic accesses instead of one for each user in <span class="No-Break">a company.</span></p>
<p>Of course, there will be scenarios where each data engineer has a user with permissions set. Still, the scenario usually is (and should be) a development environment with a sample <span class="No-Break">of data.</span></p>
<h3>Bucket policies</h3>
<p>Bucket policies <a id="_idIndexMarker213"/>can add a security layer to control the access of external resources to internal objects. With these<a id="_idIndexMarker214"/> policies, limiting access to specific IP addresses, specific resources such as <strong class="bold">CloudFront</strong>, or types <a id="_idIndexMarker215"/>of <strong class="bold">HTTP</strong> method requests is possible. In the AWS official documentation, you can see a list of practical <span class="No-Break">examples: </span><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/example-bucket-policies.xhtml"><span class="No-Break">https://docs.aws.amazon.com/AmazonS3/latest/userguide/example-bucket-policies.xhtml</span></a><span class="No-Break">.</span></p>
<h2 id="_idParaDest-101"><a id="_idTextAnchor101"/>See also</h2>
<p>In the AWS official <a id="_idIndexMarker216"/>documentation, you can also see other types of<a id="_idIndexMarker217"/> access control, such<a id="_idIndexMarker218"/> as <strong class="bold">Access Control Lists</strong> (<strong class="bold">ACLs</strong>) and <strong class="bold">Cross-Origin Resource Sharing</strong> (<span class="No-Break"><strong class="bold">CORS</strong></span><span class="No-Break">): </span><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/s3-access-control.xhtml"><span class="No-Break">https://docs.aws.amazon.com/AmazonS3/latest/userguide/s3-access-control.xhtml</span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-102"><a id="_idTextAnchor102"/>Accessing data from GCP using Cloud Storage</h1>
<p><strong class="bold">Google Cloud Platform</strong> (<strong class="bold">GCP</strong>) is a<a id="_idIndexMarker219"/> cloud provider that offers<a id="_idIndexMarker220"/> manifold services, from cloud computing to <strong class="bold">Artificial Intelligence</strong> (<strong class="bold">AI</strong>), which can be implemented in only a few steps. It also provides broad-spectrum storage<a id="_idIndexMarker221"/> called <span class="No-Break"><strong class="bold">Cloud Storage</strong></span><span class="No-Break">.</span></p>
<p>In this recipe, we will build step-by-step policies to control <a id="_idIndexMarker222"/>access to data inside our <strong class="bold">Cloud </strong><span class="No-Break"><strong class="bold">Storage buckets</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-103"><a id="_idTextAnchor103"/>Getting ready</h2>
<p>This recipe <a id="_idIndexMarker223"/>will use the <em class="italic">uniform</em> method, as <a id="_idIndexMarker224"/>defined by the Google <span class="No-Break">Cloud team:</span></p>
<ol>
<li>First, we will create a testing user. Go to the <strong class="bold">IAM</strong> page (<a href="https://console.cloud.google.com/iam-admin/iam">https://console.cloud.google.com/iam-admin/iam</a>) and select <strong class="bold">Grant Access</strong>. Add a valid Gmail address in the <strong class="bold">New principals</strong> field. For now, this user will only have the <span class="No-Break"><strong class="bold">Browser</strong></span><span class="No-Break"> role:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer053">
<img alt="Figure 2.22 – The GCP IAM page to attach policies to a user" height="625" src="image/Figure_2.22_B19453.jpg" width="535"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.22 – The GCP IAM page to attach policies to a user</p>
<ol>
<li value="2">Then, we<a id="_idIndexMarker225"/> will create a Cloud Storage <a id="_idIndexMarker226"/>bucket. Go to the <strong class="bold">Cloud Storage</strong> page and select <strong class="bold">Create a </strong><span class="No-Break"><strong class="bold">bucket</strong></span><span class="No-Break">: </span><a href="https://console.cloud.google.com/storage/create-bucket"><span class="No-Break">https://console.cloud.google.com/storage/create-bucket</span></a><span class="No-Break">.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer054">
<img alt="Figure 2.23 – The GCP search bar with Cloud Storage selected" height="832" src="image/Figure_2.23_B19453.jpg" width="355"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.23 – The GCP search bar with Cloud Storage selected</p>
<p>Add a unique name to your bucket and leave the other option as <span class="No-Break">it is:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer055">
<img alt="Figure 2.24 – The GCP page to create a new bucket" height="796" src="image/Figure_2.24_B19453.jpg" width="946"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.24 – The GCP page to create a new bucket</p>
<h2 id="_idParaDest-104"><a id="_idTextAnchor104"/>How to do it…</h2>
<p>Here are the <a id="_idIndexMarker227"/>steps to<a id="_idIndexMarker228"/> perform <span class="No-Break">this recipe:</span></p>
<ol>
<li>We will try to access the Cloud Storage objects. First, let’s try to access the bucket using the user we just created. An error message <span class="No-Break">should appear:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer056">
<img alt="Figure 2.25 – An insufficient permission message for the testing user in the GCP console" height="629" src="image/Figure_2.25_B19453.jpg" width="1014"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.25 – An insufficient permission message for the testing user in the GCP console</p>
<ol>
<li value="2">Then, we<a id="_idIndexMarker229"/> grant <strong class="bold">Editor</strong> permissions in Cloud <a id="_idIndexMarker230"/>Storage. Go to the <strong class="bold">IAM</strong> page and select the testing user you created. On the editing user page, <span class="No-Break">select </span><span class="No-Break"><strong class="bold">Editor</strong></span><span class="No-Break">.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer057">
<img alt="Figure 2.26 – The GCP IAM page – assigning the Editor role to the testing user" height="973" src="image/Figure_2.26_B19453.jpg" width="1192"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.26 – The GCP IAM page – assigning the Editor role to the testing user</p>
<p class="callout-heading">Note</p>
<p class="callout">If you are confused about the roles, use <a id="_idIndexMarker231"/>the Policy Simulator in Google <span class="No-Break">Cloud: </span><a href="https://console.cloud.google.com/iam-admin/simulator"><span class="No-Break">https://console.cloud.google.com/iam-admin/simulator</span></a><span class="No-Break">.</span></p>
<ol>
<li value="3">Next, we<a id="_idIndexMarker232"/> access Cloud Storage with <a id="_idIndexMarker233"/>a proper role. The user should be able to see and upload objects to <span class="No-Break">the bucket:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer058">
<img alt="Figure 2.27 – The testing user view of the GCP bucket" height="304" src="image/Figure_2.27_B19453.jpg" width="1059"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.27 – The testing user view of the GCP bucket</p>
<h2 id="_idParaDest-105"><a id="_idTextAnchor105"/>How it works…</h2>
<p>In <em class="italic">step 1</em>, our testing user had only permission to browse, and an error message appeared when trying to see the bucket list. However, the <strong class="bold">Editor</strong> role for Cloud Storage solves this problem by granting access to the bucket (and most of the other essential Google Cloud resources). At this point, creating a condition to allow only access to this bucket is <span class="No-Break">also possible.</span></p>
<p>The Google Cloud access hierarchy is based on its organization and projects. To provide access to a respective bucket, we need to ensure we also have access to the resources of a project. Refer to the <span class="No-Break">following screenshot:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer059">
<img alt="Figure 2.28 – GCP control access hierarchy – source: https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy#inheritance" height="1147" src="image/Figure_2.28_B19453.jpg" width="842"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.28 – GCP control access hierarchy – source: https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy#inheritance</p>
<p>Once the access<a id="_idIndexMarker234"/> hierarchy is defined, we can select <a id="_idIndexMarker235"/>several built-in user permission groups on the IAM page and add conditions if needed. Unlike AWS, Google Cloud policies are often created as “roles” and grouped to serve a specific area or department. Additional permissions or conditionals can be made for particular cases, but they are <span class="No-Break">not shared.</span></p>
<p>Even though the uniform method seems simple, it can be a powerful way to manage access to Google Cloud when properly grouped and revised and uniformly grant permissions. In our case, the <strong class="bold">Editor</strong> role solved our problem, but a specialist on this topic is recommended when working with larger teams and different types of <span class="No-Break">access policies.</span></p>
<h2 id="_idParaDest-106"><a id="_idTextAnchor106"/>There’s more…</h2>
<p>Like S3, Cloud Storage also has another type of<a id="_idIndexMarker236"/> access control called <strong class="bold">fine-grained</strong>. It consists of a mixture of IAM policies and ACLs and is recommended in cases where storage connects to an S3 bucket, for instance. As its name suggests, the permission is refined to the bucket and individual object levels. It needs to be configured by someone (or a team) with a high level of security knowledge, since the data exposure can be elevated if the <a href="https://davesteele.github.io/gpg/2014/09/20/anatomy-of-a-gpg-key/"><strong class="bold">ACL policy</strong> is not <span id="_idIndexMarker237"/><span class="No-Break">set correctly.</span></a></p>
<p><a href="https://davesteele.github.io/gpg/2014/09/20/anatomy-of-a-gpg-key/">You can read more about <span id="_idIndexMarker238"/>ACLs i</a>n Cloud Storage <span class="No-Break">here: </span><a href="https://cloud.google.com/storage/docs/access-control/lists"><span class="No-Break">https://cloud.google.com/storage/docs/access-control/lists</span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-107"><a id="_idTextAnchor107"/>Further reading</h1>
<ul>
<li><a href="https://www.manageengine.com/device-control/data-replication.xhtml"><span class="No-Break">https://www.manageengine.com/device-control/data-replication.xhtml</span></a></li>
<li><a href="https://www.keboola.com/blog/database-replication-techniques"><span class="No-Break">https://www.keboola.com/blog/database-replication-techniques</span></a></li>
<li><a href="https://satoricyber.com/access-control/access-control-101-a-comprehensive-guide-to-database-access-control/"><span class="No-Break">https://satoricyber.com/access-control/access-control-101-a-comprehensive-guide-to-database-access-control/</span></a></li>
<li><a href="https://stackoverflow.com/questions/190257/best-role-based-access-control-rbac-database-model"><span class="No-Break">https://stackoverflow.com/questions/190257/best-role-based-access-control-rbac-database-model</span></a></li>
<li><a href="https://www.researchgate.net/publication/281479020_A_Model-driven_Role-based_Access_Control_for_SQL_Databases"><span class="No-Break">https://www.researchgate.net/publication/281479020_A_Model-driven_Role-based_Access_Control_for_SQL_Databases</span></a></li>
<li><a href="https://dspace.mit.edu/bitstream/handle/1721.1/87870/53700676-MIT.pdf?sequence=2"><span class="No-Break">https://dspace.mit.edu/bitstream/handle/1721.1/87870/53700676-MIT.pdf?sequence=2</span></a></li>
<li><a href="https://scholarworks.calstate.edu/downloads/sb397840v"><span class="No-Break">https://scholarworks.calstate.edu/downloads/sb397840v</span></a></li>
<li><a href="https://www.sftp.net/public-online-sftp-servers"><span class="No-Break">https://www.sftp.net/public-online-sftp-servers</span></a></li>
<li><a href="https://www.ittsystems.com/how-to-access-sftp-server-in-python/"><span class="No-Break">https://www.ittsystems.com/how-to-access-sftp-server-in-python/</span></a></li>
<li><a href="https://towardsdatascience.com/encrypt-and-decrypt-files-using-python-python-programming-pyshark-a67774bbf9f4"><span class="No-Break">https://towardsdatascience.com/encrypt-and-decrypt-files-using-python-python-programming-pyshark-a67774bbf9f4</span></a></li>
<li><a href="https://www.geeksforgeeks.org/encrypt-and-decrypt-files-using-python/"><span class="No-Break">https://www.geeksforgeeks.org/encrypt-and-decrypt-files-using-python/</span></a></li>
<li><a href="https://www.saltycrane.com/blog/2011/10/python-gnupg-gpg-example/"><span class="No-Break">https://www.saltycrane.com/blog/2011/10/python-gnupg-gpg-example/</span></a></li>
<li><a href="https://www.ekransystem.com/en/blog/data-security-best-practices"><span class="No-Break">https://www.ekransystem.com/en/blog/data-security-best-practices</span></a></li>
<li><a href="https://www.ovaledge.com/blog/data-access-management-basics-implementation-strategy"><span class="No-Break">https://www.ovaledge.com/blog/data-access-management-basics-implementation-strategy</span></a></li>
</ul>
</div>
</div></body></html>