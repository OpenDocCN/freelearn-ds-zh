<html><head></head><body>
<div><div><h1 class="chapter-number" id="_idParaDest-64"><a id="_idTextAnchor064"/>2</h1>
<h1 id="_idParaDest-65"><a id="_idTextAnchor065"/>Principals of Data Access – Accessing Your Data</h1>
<p><strong class="bold">Data access</strong> is a term that refers to the ability to store, retrieve, transfer, and copy data from one system or application to another. It crucially involves security, legal, and, in some cases, national <a id="_idIndexMarker077"/>matters. In addition to the last two, we will also cover some security topics in this chapter.</p>
<p>As data engineers or scientists, knowing how to retrieve data correctly is necessary. Some of it may<a id="_idIndexMarker078"/> require <strong class="bold">encrypted authentication</strong>, and for this, we need to understand how some decrypting libraries work and how to use them without compromising or leaking sensitive data. Data access also refers to the levels of authorization a system or database have, from administration to read-only roles.</p>
<p>In this chapter, we will cover how the levels of data access are defined and the most used libraries and authentication methods in the data ingestion process.</p>
<p>In this chapter, you will work through the following recipes:</p>
<ul>
<li>Implementing governance in a data access workflow</li>
<li>Accessing databases and data warehouses</li>
<li>Accessing <strong class="bold">SSH File Transfer Protocol</strong> (<strong class="bold">SFTP</strong>) ﬁles</li>
<li>Retrieving data using API authentication</li>
<li>Managing encrypted files</li>
<li>Accessing data from AWS</li>
<li>Accessing data from GCP</li>
</ul>
<h1 id="_idParaDest-66"><a id="_idTextAnchor066"/>Technical requirements</h1>
<p>A Google Cloud account<a id="_idIndexMarker079"/> can be easily created if you already have a Gmail account, and most of the resources can be accessed with a free tier. It also provides $300 of credit for resources that are not free. It is a good incentive if you want to make other tests using the other recipes in this book inside GCP.</p>
<p>To access and enable a <a id="_idIndexMarker080"/>Google Cloud account, go to the <a href="https://cloud.google.com/">https://cloud.google.com/</a> page and follow the steps provided on the screen.</p>
<p class="callout-heading">Note</p>
<p class="callout">All the recipes covered in this chapter are eligible to use the free tier.</p>
<p>You can also find the code from this chapter in this GitHub repository here: <a href="https://github.com/PacktPublishing/Data-Ingestion-with-Python-Cookbook">https://github.com/PacktPublishing/Data-Ingestion-with-Python-Cookbook</a>.</p>
<h1 id="_idParaDest-67"><a id="_idTextAnchor067"/>Implementing governance in a data access workflow</h1>
<p>As<a id="_idIndexMarker081"/> we saw previously, <strong class="bold">data access</strong> or <strong class="bold">accessibility</strong> is a <strong class="bold">governance</strong> pillar and is <a id="_idIndexMarker082"/>closely related to security. Data safety is not only a concern for <a id="_idIndexMarker083"/>administrators or managers but also for everyone that is involved with data. Having said that, it is essential to know how to design a base workflow to implement security layers for our data, allowing only authorized people to read or manipulate it.</p>
<p>This recipe will <a id="_idIndexMarker084"/>create a workflow with<a id="_idIndexMarker085"/> essential topics to implement data access management.</p>
<h2 id="_idParaDest-68"><a id="_idTextAnchor068"/>Getting ready</h2>
<p>Before designing our workflow, we need to identify the vectors interfering with our data access.</p>
<p>So, what are data vectors?</p>
<p>Vectors <a id="_idIndexMarker086"/>are paths someone can use to gain unauthorized access to a server, network, or database. In this case, we will identify the ones related to data leaks.</p>
<p>Let’s explore them in a visual form, as shown in the following diagram:</p>
<div><div><img alt="Figure 2.1 – Data governance vectors" height="375" src="img/Figure_2.1_B19453.jpg" width="1541"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.1 – Data governance vectors</p>
<p>Let us <a id="_idIndexMarker087"/>understand each of these stages in the<a id="_idIndexMarker088"/> path here:</p>
<ol>
<li><strong class="bold">Data creation</strong>: In this step, we identify where data is created and by who. With this definition, we can ensure only the <strong class="bold">accountable</strong> can have access to create or update data.</li>
<li><strong class="bold">Storage of data</strong>: After creation, it’s important to know where our data is or will be stored. Depending on the answer to this question, the methods to retrieve data will be different and can require additional steps.</li>
<li><strong class="bold">Management of users and services</strong>: Data must be used, and people need access. Here, we define the <em class="italic">actors</em> or the roles we might have, and the common types are <strong class="bold">administrator</strong>, <strong class="bold">write</strong>, and <strong class="bold">read-only</strong> roles.</li>
<li><strong class="bold">Transferring data</strong>: How will our data be transferred? It is essential to decide whether it will be real-time, near real-time, or batch. You can add further questions to your workflows, such as how the data will be available for transfers via API or any other method.</li>
</ol>
<h2 id="_idParaDest-69"><a id="_idTextAnchor069"/>How to do it…</h2>
<p>After <a id="_idIndexMarker089"/>identifying our vectors, we can <a id="_idIndexMarker090"/>define the implementation workflow for data access management.</p>
<p>To make it easy to understand how to implement it, let’s imagine a hypothetical scenario of a new application where we want to retrieve medical records from patients.</p>
<p>Here is how we do it:</p>
<ol>
<li>The first step is to document all our data and classify it. If there is confidential data, we need to work out how to identify it.</li>
<li>Then, we will start to define who can access the data accordingly with the necessary usage. For example, we determine the data administrators and write or read-only permissions here.</li>
<li>Once levels of access to data are implemented, we start observing how users will behave. Implementing logs to a database, data warehouse, or any other system with user activity is crucial.</li>
<li>Finally, we examine the whole process to determine whether any change is needed.</li>
</ol>
<p>In the end, we will have a flow diagram similar to the following diagram:</p>
<div><div><img alt="Figure 2.2 – A flow diagram to start implementing data governance" height="336" src="img/Figure_2.2_B19453.jpg" width="585"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.2 – A flow diagram to start implementing data governance</p>
<h2 id="_idParaDest-70"><a id="_idTextAnchor070"/>How it works…</h2>
<p>Data <a id="_idIndexMarker091"/>access management is an ongoing<a id="_idIndexMarker092"/> process. Every day, we ingest and create new pipelines to be used by several people on different teams. Here is how it goes:</p>
<ol>
<li><strong class="bold">Discovering, classifying, and documenting all your data</strong>: The first thing to organize is our data. Which<a id="_idIndexMarker093"/> patient’s data are we going to retrieve? Does it contain <strong class="bold">Personally Identifiable Information</strong> (<strong class="bold">PII</strong>) or <strong class="bold">Protected/Personal Health Information</strong> (<strong class="bold">PHI</strong>)? Since it’s the first<a id="_idIndexMarker094"/> time we are ingesting this data, we need to catalog it with flags about PII and who is responsible for the source data.</li>
<li><strong class="bold">Creating access controls</strong>: Here, we define access based on roles since not everybody needs access to patient history. We allocate permissions to data based on the roles, responsibilities, and classification.</li>
<li><strong class="bold">Examining the users’ behaviors</strong>: In this step, we observe how our users behave in their roles. The creation, updates, and deletion actions are logged to be monitored and reviewed if needed. If a medical department no longer uses a report, we can restrict their access or even stop them from ingesting information for them.</li>
<li><strong class="bold">Analyzing and reviewing requirements for compliance</strong>: We must ensure our access management follows compliance and local regulations. Legal regulations <a id="_idIndexMarker095"/>apply differently for<a id="_idIndexMarker096"/> different types of data, which needs to be considered.</li>
</ol>
<h2 id="_idParaDest-71"><a id="_idTextAnchor071"/>See also</h2>
<ul>
<li><em class="italic">Healthcare Data Breaches </em><em class="italic">Statistics</em>: <a href="https://www.hipaajournal.com/healthcare-data-breach-statistics/">https://www.hipaajournal.com/healthcare-data-breach-statistics/</a></li>
<li><em class="italic">European Data Protection Supervisor. Health data in the </em><em class="italic">workspace</em>: <a href="https://edps.europa.eu/data-protection/data-protection/reference-library/health-data-workplace_en">https://edps.europa.eu/data-protection/data-protection/reference-library/health-data-workplace_en</a></li>
</ul>
<h1 id="_idParaDest-72"><a id="_idTextAnchor072"/>Accessing databases and data warehouses</h1>
<p><strong class="bold">Databases</strong> are the <a id="_idIndexMarker097"/>foundation of any system or application, no matter your architecture. A database is sometimes needed to store logs, user activities or information, and system stuff.</p>
<p>Putting it in a bigger perspective, data warehouses have the <a id="_idIndexMarker098"/>same usage but are related to analytical data. After ingesting and transforming data, we need to load it somewhere where it is easier to retrieve analytic information for use on dashboards, reports, etc.</p>
<p>Currently, it is possible to find several types of databases (of the SQL and NoSQL types) and data warehouse architectures. However, this recipe aims to cover how access control is usually done for both relational structures. The goal is to understand how the access levels are defined, even using a generic scenario.</p>
<h2 id="_idParaDest-73"><a id="_idTextAnchor073"/>Getting ready</h2>
<p>For this<a id="_idIndexMarker099"/> recipe, we will use MySQL. You can install it following the instructions on the <a id="_idIndexMarker100"/>MySQL official page here: <a href="https://dev.mysql.com/downloads/installer/">https://dev.mysql.com/downloads/installer/</a>.</p>
<p>You can use any SQL client you choose to execute the queries here. In my case, I will use MySQL Workbench:</p>
<ol>
<li>First, we will create a database using our <code>root</code> user. You can name it what you like. My recommendation here is to set the charset to <code>UTF-8</code>:<pre class="source-code">
CREATE SCHEMA `your_schema_name` DEFAULT CHARACTER SET utf8 ;</pre></li>
</ol>
<p>My schema will be called <code>cookbook-data</code>.</p>
<ol>
<li value="2">The next step is creating tables. Still using the root account, we will create a <code>people_city</code> table using <a id="_idIndexMarker101"/>the <strong class="bold">Data Definition Language</strong> (<strong class="bold">DDL</strong>) syntax:<pre class="source-code">
<strong class="bold">CREATE TABLE `cookbook-data`.`people_city` (</strong>
  `id` INT NOT NULL,
  `name` VARCHAR(45) NULL,
  `country` VARCHAR(45) NULL,
  `occupation` VARCHAR(45) NULL,
  PRIMARY KEY (`id`));</pre></li>
</ol>
<h2 id="_idParaDest-74"><a id="_idTextAnchor074"/>How to do it…</h2>
<p class="callout-heading">Note</p>
<p class="callout">Since the last update from MySQL 8.0, we can’t create users directly using the <code>GRANT</code> command. An error like this will appear:</p>
<p class="callout"><code>ERROR 1410 (42000): You are not allowed to create a user </code><code>with GRANT</code></p>
<p class="callout">To solve this issue, we will take some additional steps. We will also need at least two sessions of MySQL open, so keep that in mind if you opt to execute the commands directly on your command line.</p>
<p class="callout">I would like to also thank Lefred’s blog for this solution and contribution to the community. You can find more details and other useful information at their blog here: <a href="https://lefred.be/content/how-to-grant-privileges-to-users-in-mysql-8-0/">https://lefred.be/content/how-to-grant-privileges-to-users-in-mysql-8-0/</a>.</p>
<p>Let us see <a id="_idIndexMarker102"/>the steps to<a id="_idIndexMarker103"/> perform this recipe:</p>
<ol>
<li>First, let’s create the <code>admin</code> user. Here, we will start to have problems if we do not follow the following steps correctly. We need to create a user to be our superuser or administrator, using our <code>root user</code>:<pre class="source-code">
CREATE user 'admin'@'localhost' identified by 'password';
&gt; Query OK, 0 rows affected</pre></li>
<li>Then, we log in with the <code>admin</code> user. Using the password you defined in <em class="italic">step 1</em>, log in to the MySQL console using the <code>admin</code> user. We can’t see any databases yet on the SQL software client, but we will fix this in the following step. After logging in to the console, you can see the SQL command ready to be used:<pre class="source-code">
$ mysql -u admin -p password -h localhost
Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
mysql&gt;</pre></li>
</ol>
<p>Keep this session open.</p>
<ol>
<li value="3">Then, we<a id="_idIndexMarker104"/> grant permissions<a id="_idIndexMarker105"/> to the <code>admin</code> user by role. In the root session, let’s create a role called <code>administration</code> and grant full access to our database to the <code>admin</code> user:<pre class="source-code">
create ROLE administration;</pre></li>
</ol>
<p>We then grant permissions to the role:</p>
<pre class="source-code">
grant alter,create,delete,drop,index,insert,select,update,trigger,alter routine,create routine, execute, create temporary tables on `cookbook_data`.* to 'administration';</pre>
<p>We then grant the role to our <code>admin</code> user:</p>
<pre class="source-code">
grant 'administration' to 'admin';</pre>
<p>We then set this role as the default:</p>
<pre class="source-code">
set default role 'administration' to 'admin';</pre>
<ol>
<li value="4">Next, like in <em class="italic">step 2</em>, we create another two users, the <code>write</code> and <code>read-only</code> roles.</li>
</ol>
<p>Repeat <em class="italic">step 3</em>, giving the new roles names, and for these two roles, my recommendation is to grant the following privileges:</p>
<ul>
<li><code>alter</code>, <code>create</code>, <code>index</code>, <code>insert</code>, <code>select</code>, <code>update</code>, <code>trigger</code>, <code>alter routine</code>, <code>create routine</code>, <code>execute</code>, and <code>create </code><code>temporary tables</code></li>
<li><code>select</code> and <code>execute</code></li>
</ul>
<ol>
<li value="5">Next, we perform the actions. If we try to perform <code>INSERT</code> using our <code>admin</code> or <code>write</code> roles, we can see it is viable:<pre class="source-code">
INSERT INTO `cookbook_data`.`people_city` (id, `name`, country, occupation)
VALUES (1, 'Lin', 'PT', 'developer');
&gt; 1 row(s) affected</pre></li>
</ol>
<p>However, the same can’t be done by the <code>read-only</code> user:</p>
<pre class="source-code">
Error Code: 1142. INSERT command denied to user 'reader'@'localhost' for table 'people_city'</pre>
<h2 id="_idParaDest-75"><a id="_idTextAnchor075"/>How it works…</h2>
<p>In a real-world project, most of the time, there is a dedicated person (or database administrator) to handle and take care of access to databases or data warehouses. Nonetheless, any person who needs to access a relational data source needs to understand the basic concepts of the access levels to ask for its permissions (and justify it).</p>
<p>In this recipe, we used a <code>show </code><code>privileges</code> command.</p>
<p><code>alter</code>, <code>create</code>, <code>delete</code>, <code>drop</code>, <code>index</code>, <code>insert</code>, <code>select</code>, <code>update</code>, <code>trigger</code>, <code>alter routine</code>, <code>create routine</code>, <code>execute</code>, and <code>create temporary tables</code> are the common commands used daily, and knowing them makes it easier to identify an error. Let’s take, for example, the earlier error:</p>
<pre class="source-code">
<strong class="bold">Error Code: 1142. INSERT command denied to user 'reader'@'localhost' for table 'people_city'</strong></pre>
<p>The <a id="_idIndexMarker107"/>first line shows precisely<a id="_idIndexMarker108"/> the permission we need. The second line shows us which user (<code>reader</code>) lacks permission, the connection they are using <code>(@localhost</code>), and the table (<code>people_city</code>) they want to access.</p>
<p>In addition, if you are a system administrator, you can also identify behavior that is not allowed and help to solve it.</p>
<h2 id="_idParaDest-76"><a id="_idTextAnchor076"/>There’s more…</h2>
<p>If you<a id="_idIndexMarker109"/> are <a id="_idIndexMarker110"/>interested<a id="_idIndexMarker111"/> to know more, it is <a id="_idIndexMarker112"/>also possible to <a id="_idIndexMarker113"/>find three other types of access<a id="_idIndexMarker114"/> control for databases and<a id="_idIndexMarker115"/> data warehouses:</p>
<ul>
<li><strong class="bold">Discretionary Access </strong><strong class="bold">Control</strong> (<strong class="bold">DAC</strong>)</li>
<li><strong class="bold">Mandatory Access </strong><strong class="bold">Control</strong> (<strong class="bold">MAC</strong>)</li>
<li><strong class="bold">Attribute-Based Access </strong><strong class="bold">Control</strong> (<strong class="bold">ABAC</strong>)</li>
</ul>
<p>The following figure illustrates access control in a summarized version, as follows:</p>
<div><div><img alt="Figure 2.3 – A database access control comparison – source: https://www.cloudradius.com/access-control-paradigms-compared-rbac-vs-pbac-vs-abac/" height="532" src="img/Figure_2.3_B19453.jpg" width="1151"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.3 – A database access control comparison – source: https://www.cloudradius.com/access-control-paradigms-compared-rbac-vs-pbac-vs-abac/</p>
<p>Even though it is <a id="_idIndexMarker116"/>not described in the preceding figure, we can also find databases that use <strong class="bold">row and column-based access control</strong>. You can find out more about it here: <a href="https://documentation.datavirtuality.com/23/reference-guide/authentication-access-control-and-security/access-control/data-roles/permissions/row-and-column-based-security">https://documentation.datavirtuality.com/23/reference-guide/authentication-access-control-and-security/access-control/data-roles/permissions/row-and-column-based-security</a>.</p>
<h2 id="_idParaDest-77"><a id="_idTextAnchor077"/>See also</h2>
<ul>
<li>Here is an<a id="_idIndexMarker117"/> article by <em class="italic">Raimundas Matulevicius</em> and <em class="italic">Henri Lakk</em> on RBAC that discusses in depth the best approaches in several cases: <a href="https://www.researchgate.net/publication/281479020_A_Model-driven_Role-based_Access_Control_for_SQL_Databases">https://www.researchgate.net/publication/281479020_A_Model-driven_Role-based_Access_Control_for_SQL_Databases</a></li>
<li>This article by <em class="italic">Arundhati Singh</em> offers a perspective on RBAC mode implementation in enterprise networks: <a href="https://dspace.mit.edu/bitstream/handle/1721.1/87870/53700676-MIT.pdf?sequence=2">https://dspace.mit.edu/bitstream/handle/1721.1/87870/53700676-MIT.pdf?sequence=2</a></li>
</ul>
<h1 id="_idParaDest-78"><a id="_idTextAnchor078"/>Accessing SSH File Transfer Protocol (SFTP) ﬁles</h1>
<p>The <strong class="bold">File Transfer Protocol</strong> (<strong class="bold">FTP</strong>) was <a id="_idIndexMarker118"/>introduced in the 1970s at<a id="_idIndexMarker119"/> <strong class="bold">Massachusetts Institute of Technology</strong> (<strong class="bold">MIT</strong>) and is based on the <strong class="bold">Transmission Control Protocol/Internet Protocol</strong> (<strong class="bold">TCP/IP</strong>) application layer. Since the 1980s, it has been widely <a id="_idIndexMarker120"/>used to transfer files between computers.</p>
<p>Over the years, and with the increase in computer and internet usage, it became necessary to introduce a more secure way to use this<a id="_idIndexMarker121"/> solution. An <strong class="bold">SSH layer</strong> was implemented to improve the security<a id="_idIndexMarker122"/> of <strong class="bold">FTP transactions</strong>, creating the <strong class="bold">SSH File Transfer Protocol</strong> (<strong class="bold">SFTP</strong>) protocol.</p>
<p>Nowadays, it is common to ingest data from SFTP servers, and in this recipe, we will work to retrieve data from a public SFTP server.</p>
<h2 id="_idParaDest-79"><a id="_idTextAnchor079"/>Getting ready</h2>
<p>In this recipe, we will create code with Python, using the <code>pysftp</code> library, to connect and retrieve sample data from a public SFTP server.</p>
<p>If you own an <a id="_idIndexMarker123"/>SFTP server, feel free to test the Python code here to exercise a little more:</p>
<ol>
<li>First, we will <a id="_idIndexMarker124"/>get the SFTP credentials. Go to the SFTP.NET address at https://www.sftp.net/public-online-sftp-servers, and save the <strong class="bold">Hostname</strong> and <strong class="bold">Login</strong> (username/password) information on a notepad.</li>
</ol>
<div><div><img alt="Figure 2.4 – The SFTP.NET main page" height="1832" src="img/Figure_2.4_B19453.jpg" width="1586"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.4 – The SFTP.NET main page</p>
<p class="callout-heading">Note</p>
<p class="callout">This SFTP server is intended to be used only for testing and studying purposes. Because of that, the credentials are insecure and publicly available, and for production purposes, that information needs to be secured in a password vault and never shared through code.</p>
<ol>
<li value="2">Then, we<a id="_idIndexMarker125"/> install the Python <code>pysftp</code> package using the command line:<pre class="source-code">
<strong class="bold">$ pip install pysftp</strong></pre></li>
</ol>
<h2 id="_idParaDest-80"><a id="_idTextAnchor080"/>How to do it…</h2>
<p>Here are the steps to perform this recipe:</p>
<ol>
<li>First, let’s create a Python file called <code>accessing_sftp_files.py</code>. Then, we insert the following code to create our SFTP connection with Python:<pre class="source-code">
<strong class="bold">import pysftp</strong>
host = " test.rebex.net"
username = "demo"
password = "password"
with pysftp.Connection(host=host, username=username, password=password) as sftp:
    print("Connection successfully established ... ")</pre></li>
</ol>
<p>You can call the file using the following command:</p>
<pre class="source-code">
$ python accessing_sftp_files.py</pre>
<p>Here is the output for it:</p>
<pre class="source-code">
Connection successfully established ...</pre>
<p>Here, a known error might occur – <code>SSHException: No hostkey for host </code><code>test.rebex.net found</code>.</p>
<p>This happens because pysftp can’t find hostkey in your KnowHosts.</p>
<p>If this error occurs, follow the next steps:</p>
<ol>
<li value="2">Go to your command line and execute <code>ssh demo@test.rebex.net</code>:</li>
</ol>
<div><div><img alt="Figure 2.5 – Adding a host to the known_hosts list" height="175" src="img/Figure_2.5_B19453.jpg" width="1428"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.5 – Adding a host to the known_hosts list</p>
<ol>
<li value="3">Insert the<a id="_idIndexMarker126"/> password for the <code>demo</code> user and exit Rebex Virtual Shell:</li>
</ol>
<div><div><img alt="Figure 2.6 – A welcome message from the Rebex SFTP server" height="172" src="img/Figure_2.6_B19453.jpg" width="694"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.6 – A welcome message from the Rebex SFTP server</p>
<ol>
<li value="4">Then, we list the files in the SFTP server:<pre class="source-code">
import pysftp
host = "test.rebex.net"
username = "demo"
password = "password"
with pysftp.Connection(host=host, username=username, password=password) as sftp:
    print("Connection successfully established ... ")
    # Switch to a remote directory
    sftp.cwd('pub/example/')
    # Obtain structure of the remote directory '/pub/example'
    directory_structure = sftp.listdir_attr()
    # Print data
    for attr in directory_structure:
        print(attr.filename, attr)</pre></li>
</ol>
<p>Now, let’s download the <code>readme.txt</code> file:</p>
<p>Let’s change the <a id="_idIndexMarker127"/>last lines of our code to be able to download <code>readme.txt</code>:</p>
<pre class="source-code">
import pysftp
host = "test.rebex.net"
username = "demo"
password = "password"
with pysftp.Connection(host=host, username=username, password=password) as sftp:
    print("Connection successfully established ... ")
    # Switch to a remote directory
    sftp.cwd('pub/example/')
    print("Changing to pub/example directory... ")
    sftp.get('readme.txt', 'readme.txt')
    print("File downloaded ... ")
    sftp.close()</pre>
<p>The output for this is as follows:</p>
<pre class="source-code">
Connection successfully established ...
Changing to pub/example directory...
File downloaded ...</pre>
<h2 id="_idParaDest-81"><a id="_idTextAnchor081"/>How it works…</h2>
<p><code>pysftp</code> is a Python library<a id="_idIndexMarker128"/> that allows developers to<a id="_idIndexMarker129"/> connect, upload, and download data from SFTP servers. Its use is straightforward, and the library has tons of functionalities.</p>
<p>Note that most of our code is indented inside <code>pysftp.Connection</code>. This happens because we create a connection session for that particular credential. The <code>with</code> statement makes the acquisition and release of the resources, and as you can see, it is widely used in file streams, locks, sockets, and so on.</p>
<p>We also used the <code>sftp.cwd()</code> method, allowing us to change the directory and avoid specifying the path whenever we need to list or retrieve files.</p>
<p>Finally, the download was made using <code>sftp.get()</code>, where the first parameter is the path and the name of the file we want to download, and the second is where we will put it. Since we are already inside the file’s directory, we can save it in our local <code>HOME</code> directory.</p>
<p>Last but not least, <code>sftp.close()</code> closes the connection. This is excellent practice in ingesting scripts to avoid <a id="_idIndexMarker130"/>network concurrency with other pipelines or the SFTP server.</p>
<h2 id="_idParaDest-82"><a id="_idTextAnchor082"/>There’s more…</h2>
<p>If you want to go deeper and make other <a id="_idIndexMarker131"/>tests, you can also create a local SFTP server.</p>
<p>For Linux users, it is possible to do this using the <code>ssh</code> command line. You can see more here: <a href="https://linuxhint.com/setup-sftp-server-ubuntu/">https://linuxhint.com/setup-sftp-server-ubuntu/</a>.</p>
<p>For Windows users, go<a id="_idIndexMarker132"/> to the <strong class="bold">SFTP Servers</strong> section here: <a href="https://www.sftp.net/servers">https://www.sftp.net/servers</a>.</p>
<div><div><img alt="Figure 2.7 – The SFTP.NET page, with a link to a tutorial on how to create a small SFTP server" height="720" src="img/Figure_2.7_B19453.jpg" width="1548"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.7 – The SFTP.NET page, with a link to a tutorial on how to create a small SFTP server</p>
<p>Select <strong class="bold">Rebex Tiny SFTP Server</strong> under <strong class="bold">Minimalist SFTP servers</strong>, download it, and start the program.</p>
<h2 id="_idParaDest-83"><a id="_idTextAnchor083"/>See also</h2>
<ul>
<li>Creating a<a id="_idIndexMarker133"/> local SFTP server with Docker: <a href="https://hub.docker.com/r/atmoz/sftp">https://hub.docker.com/r/atmoz/sftp</a></li>
</ul>
<h1 id="_idParaDest-84"><a id="_idTextAnchor084"/>Retrieving data using API authentication</h1>
<p>An <strong class="bold">Application Programming Interface</strong> (<strong class="bold">API</strong>) is a<a id="_idIndexMarker134"/> set of configurations that allows two systems or applications to communicate or transmit data with each other. Its concept has been improved in recent years, allowing faster<a id="_idIndexMarker135"/> transmissions and more security<a id="_idIndexMarker136"/> with <strong class="bold">OAuth</strong> methods, preventing <strong class="bold">Denial of Service</strong> (<strong class="bold">DoS</strong>) or <strong class="bold">Distributed Denial of Service</strong> (<strong class="bold">DDoS</strong>) attacks, and so <a id="_idIndexMarker137"/>on.</p>
<p>Its use is widely applied in data ingesting, whether to retrieve data from an application to retrieve the latest logs for analysis or <a id="_idIndexMarker138"/>from <strong class="bold">BigQuery</strong> using a cloud provider such as Google. Most applications nowadays make their data available through an API service, from which the data world gets a lot of benefits. The critical aspect here is to know <a id="_idIndexMarker139"/>how to retrieve data from an API service using <a id="_idIndexMarker140"/>the most accepted forms of authentication.</p>
<p>In this recipe, we will retrieve data from a public API using API key authentication, a standard method to gather data.</p>
<h2 id="_idParaDest-85"><a id="_idTextAnchor085"/>Getting ready</h2>
<p>Since we will use two different methods, this section will be split to make it easy to understand how to handle them.</p>
<p>For this section, we will use the HolidayAPI, a public and free API that provides information about holidays worldwide:</p>
<ol>
<li>Install the Python <code>requests</code> library:<pre class="source-code">
<strong class="bold">$ pip3 install requests</strong></pre></li>
<li>Then, access the Holiday API website. Go to <a href="https://holidayapi.com/">https://holidayapi.com/</a> and click on <strong class="bold">Get Your Free API Key</strong>. You should see the following page:</li>
</ol>
<div><div><img alt="Figure 2.8 – The Holidays API main web page" height="842" src="img/Figure_2.8_B19453.jpg" width="955"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.8 – The Holidays API main web page</p>
<ol>
<li value="3">Then, we <a id="_idIndexMarker141"/>create an account and get the API <a id="_idIndexMarker142"/>Key. To create an account, you can use an email and password or sign up with your GitHub account:</li>
</ol>
<div><div><img alt="Figure 2.9 – The Holiday API user authentication page" height="822" src="img/Figure_2.9_B19453.jpg" width="506"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.9 – The Holiday API user authentication page</p>
<p>After the authentication, you can see and copy your API Key. Note that you can also generate a new one at any time.</p>
<div><div><img alt="Figure 2.10 – The user dashboard page on the Holiday API page" height="802" src="img/Figure_2.10_B19453.jpg" width="926"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.10 – The user dashboard page on the Holiday API page</p>
<p class="callout-heading">Note</p>
<p class="callout">We will use the free tier of this API, which has limited requests per month. It is also prohibited from commercial use.</p>
<h2 id="_idParaDest-86"><a id="_idTextAnchor086"/>How to do it…</h2>
<p>Here are the<a id="_idIndexMarker143"/> steps to perform<a id="_idIndexMarker144"/> the recipe:</p>
<ol>
<li>We create a Python script using the <code>requests</code> library:<pre class="source-code">
<strong class="bold">import requests</strong>
import json
params = { 'key': 'YOUR-API-KEY',
          'country': 'BR',
          'year': 2022
}
url = "https://holidayapi.com/v1/holidays?"
req = requests.get(url, params=params)
<strong class="bold">print(req.json())</strong></pre></li>
</ol>
<p>Ensure <a id="_idIndexMarker145"/>you use a <code>year</code> value equal to your<a id="_idIndexMarker146"/> previous year since we are using a free version of the API, which is limited to last year’s historical data.</p>
<p>Here is the output for the code:</p>
<pre class="source-code">
<strong class="bold">{'status': 200, 'warning': 'These results do not include state and province holidays. For more information, please visit https://holidayapi.com/docs', 'requests': {'used': 7, 'available': 9993, 'resets': '2022-11-01 00:00:00'}, 'holidays': [{'name': "New Year's Day", 'date': '2021-01-01', 'observed': '2021-01-01', 'public': True, 'country': 'BR', 'uuid': 'b58254f9-b38b-42c1-8b30-95a095798b0c',{...}</strong></pre>
<p class="callout-heading">Note</p>
<p class="callout">As a best practice, the API key should never be hardcoded in the script. The definition here is for educational purposes.</p>
<ol>
<li value="2">Then, we save our API request as a JSON file:<pre class="source-code">
<strong class="bold">import requests</strong>
import json
params = { 'key': 'YOUR-API-KEY',
          'country': 'BR',
          'year': 2022
}
url = "https://holidayapi.com/v1/holidays?"
req = requests.get(url, params=params)
with open("holiday_brazil.json", "w") as f:
<strong class="bold">    json.dump(req.json(), f)</strong></pre></li>
</ol>
<h2 id="_idParaDest-87"><a id="_idTextAnchor087"/>How it works…</h2>
<p>The Python <code>requests</code> library<a id="_idIndexMarker147"/> is one of the most downloaded libraries on the PyPi servers. This popularity is not surprising, as we will see when we work with the library and see its power and versatility.</p>
<p>In <em class="italic">step 1</em>, we <a id="_idIndexMarker148"/>imported both the <code>requests</code> and <code>json</code> modules <a id="_idIndexMarker149"/>at the beginning of the Python script. The <code>params</code> dictionary is a payload sender to the API, so we inserted the API key and the two other mandatory fields.</p>
<p class="callout-heading">Note</p>
<p class="callout">This API authorization key was sent through a payload request; however, it depends on how the API is built. Some request that the authentication is sent via <code>Header</code> definitions, for instance. Always check the API documentation or developer to understand how to authenticate correctly.</p>
<p>The <code>print()</code> function in <em class="italic">step 1</em> served as a test to see whether our calls were authenticated.</p>
<p>With the API call <a id="_idIndexMarker150"/>returning a <code>200</code> status code, we proceed to save<a id="_idIndexMarker151"/> the <code>JSON</code> file, and you should have output like this:</p>
<div><div><img alt="Figure 2.11 – The downloaded JSON file data" height="1305" src="img/Figure_2.11_B19453.jpg" width="1648"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.11 – The downloaded JSON file data</p>
<h2 id="_idParaDest-88"><a id="_idTextAnchor088"/>There’s more…</h2>
<p>API keys<a id="_idIndexMarker152"/> are commonly used to authenticate clients, but other security methods such as OAuth should be considered, depending on the data sensitivity level.</p>
<p class="callout-heading">Note</p>
<p class="callout">API key authentication can only be considered secure if associated with other security mechanisms such as HTTPS/SSL.</p>
<h3>Authentication using the OAuth method</h3>
<p><strong class="bold">Open Authorization</strong> (<strong class="bold">OAuth</strong>) is an<a id="_idIndexMarker153"/> industry-standard protocol to authorize websites or applications to communicate and access informa<a href="https://oauth.net/2/">tion. You can find </a>out more about it on the official documentation page here: <a href="https://oauth.net/2/">https://oauth.net/2/</a>.</p>
<p>You can also test this type of authentication with<a id="_idIndexMarker155"/> the <strong class="bold">Google Calendar API</strong>. To enable the OAuth met<a href="https://edps.europa.eu/data-protection/data-protection/reference-library/health-data-workplace_en">hod, follow these steps:</a></p>
<ol>
<li><a href="https://edps.europa.eu/data-protection/data-protection/reference-library/health-data-workplace_en">Enable the Google Calendar API by </a>visiting the page at <a href="https://developers.google.com/calendar/api/quickstart/python">https://developers.google.com/calendar/api/quickstart/python</a>, and then go to the <strong class="bold">Enable </strong><strong class="bold">APIs</strong> section.</li>
</ol>
<p>A new tab will open, and <strong class="bold">Google Cloud</strong> will <a id="_idIndexMarker157"/>ask you to select or create a new project. Select the project you want to use.</p>
<p class="callout-heading">Note</p>
<p class="callout">If you opt to create a new project, insert the project name in the <strong class="bold">Project’s Name</strong> field and leave the <strong class="bold">Organization</strong> field with the default value (<strong class="bold">No Organization</strong>).</p>
<p>Select <strong class="bold">Next</strong> to confirm your project, and then click on <strong class="bold">Activate</strong>; you should then see this page:</p>
<div><div><img alt="Figure 2.12 – The GCP page to activate a resource API" height="372" src="img/Figure_2.12_B19453.jpg" width="1047"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.12 – The GCP page to activate a resource API</p>
<p>Now, we are almost ready to get our credentials.</p>
<ol>
<li value="2">Enable OAuth authentication by returning to the page at <a href="https://developers.google.com/calendar/api/quickstart/python">https://developers.google.com/calendar/api/quickstart/python</a>, clicking on <strong class="bold">Go to Credentials</strong>, and following the instructions under <strong class="bold">Authorize credentials for a </strong><strong class="bold">desktop application</strong>.</li>
</ol>
<div><div><img alt="Figure 2.13 – GCP tutorial page to create the credentials.json file" height="831" src="img/Figure_2.13_B19453.jpg" width="1217"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.13 – GCP tutorial page to create the credentials.json file</p>
<p>At the end of this, you should have a <code>credentials.json</code> file for this recipe. Keep this file safe, since all<a id="_idIndexMarker158"/> calls to the Google API will require it to <a id="_idIndexMarker159"/>verify your authenticity.</p>
<p>You can use one of the GCP script examples to test this authentication method. Google has a Python script sample to retrieve data from <a id="_idIndexMarker160"/>the <strong class="bold">Google Calendar API</strong>, which can be accessed here: <a href="https://github.com/googleworkspace/python-samples/blob/main/calendar/quickstart/quickstart.py">https://github.com/googleworkspace/python-samples/blob/main/calendar/quickstart/quickstart.py</a>.</p>
<h3>Other authentication methods</h3>
<p>Even though we covered the two<a id="_idIndexMarker161"/> most common methods to authenticate to an API, a data ingestion pipeline is not limited to In your day-to-day work, you're likely to find legacy systems or applications that require other forms of authentication.</p>
<p>Methods<a id="_idIndexMarker162"/> such as <strong class="bold">HTTP Basic and Bearer</strong>, <strong class="bold">OpenID Connect</strong>, and <strong class="bold">OpenAPI security schemes</strong> are also<a id="_idIndexMarker163"/> widely used. You can find more details about them in<a id="_idIndexMarker164"/> this article written by <em class="italic">Guy </em><em class="italic">Levin</em>: <a href="https://blog.restcase.com/4-most-used-rest-api-authentication-methods/">https://blog.restcase.com/4-most-used-rest-api-authentication-methods/</a>.</p>
<h3>SFTP versus API</h3>
<p>You might be <a id="_idIndexMarker165"/>wondering, what is the difference between ingesting data from an SFTP server and an API? It is clear that they authenticate differently, and the code also behaves distinctly. But when should we implement an SFTP or API to make data available for ingestion?</p>
<p>FTP or SFTP <a id="_idIndexMarker166"/>transactions are designed to use <strong class="bold">flat files</strong>, such as <strong class="bold">CSV</strong>, <strong class="bold">XML</strong>, and <strong class="bold">JSON </strong>files. These two types <a id="_idIndexMarker167"/>of transactions also perform well when we need to transfer bulk data, and it <a id="_idIndexMarker168"/>is the only method available for older systems. An <a id="_idIndexMarker169"/>API <a id="_idIndexMarker170"/>provides real-time data delivery and a more secure internet-based connection, and its integration with several cloud applications has made it popular in the data ingestion world. However, API calls are sometimes paid for based on the number of requests.</p>
<p>This file transaction architecture discussion is primarily for financial and HR systems, which may use some old programming language versions. The system architecture discussion is based on flat files or real-time data in more recent and cloud-based applications.</p>
<h2 id="_idParaDest-89"><a id="_idTextAnchor089"/>See also</h2>
<ul>
<li>You can find a list of public APIs with different types of auth methods<a id="_idIndexMarker171"/> here: <a href="https://github.com/public-apis/public-apis">https://github.com/public-apis/public-apis</a></li>
<li>The Holiday API <a id="_idIndexMarker172"/>Python Client: <a href="https://github.com/holidayapi/holidayapi-python">https://github.com/holidayapi/holidayapi-python</a></li>
<li>The Python <code>requests</code> library<a id="_idIndexMarker173"/> documentation: <a href="https://requests.readthedocs.io/en/latest/user/quickstart/">https://requests.readthedocs.io/en/latest/user/quickstart/</a></li>
</ul>
<h1 id="_idParaDest-90"><a id="_idTextAnchor090"/>Managing encrypted ﬁles</h1>
<p>When handling <a id="_idIndexMarker174"/>sensitive data is common, some fields or even the entire file is encrypted. It is comprehensive when this file security measure is implemented since sensitive data can expose the life of users. After all, encryption is the process of converting information into code that hides the original content.</p>
<p>Nonetheless, we must still ingest and process these encrypted files in our data pipelines. To be able to do so, we need to understand a bit more about how encryption works and how it is done.</p>
<p>In this recipe, we will decrypt a GnuPG-encrypted (where <strong class="bold">GnuPG</strong> stands for <strong class="bold">GNU Privacy Guard</strong>) file using <a id="_idIndexMarker175"/>Python libraries and best practices.</p>
<h2 id="_idParaDest-91"><a id="_idTextAnchor091"/>Getting ready</h2>
<p>Before jumping<a id="_idIndexMarker176"/> into the fun part, we must install the GnuPG library on our local machine and download the encrypted dataset.</p>
<p>You will need two installations for the GnuPG file – one for the <strong class="bold">operating system</strong> (<strong class="bold">OS</strong>) and another for a Python package. This because the Python package requires internal resources from the installed OS package:</p>
<ol>
<li>To use the Python wrapper library, we first need to install the GnuPG on our local machine:<pre class="source-code">
<strong class="bold">$ sudo apt-get install gnupg</strong></pre></li>
</ol>
<p>For Windows users, it is recommended to download the executable file here: <a href="https://gnupg.org/download/index.xhtml">https://gnupg.org/download/index.xhtml</a>.</p>
<p>Mac users can install it using Homebrew: <a href="https://formulae.brew.sh/formula/gnupg">https://formulae.brew.sh/formula/gnupg</a>.</p>
<ol>
<li value="2">Then, we install the Python GnuPG wrapper as follows:<pre class="source-code">
$ pip3 install python-gnupg
Collecting python-gnupg
  Downloading python_gnupg-0.5.0-py2.py3-none-any.whl (18 kB)
Installing collected packages: python-gnupg
Successfully installed python-gnupg-0.5.0</pre></li>
<li>Next, we download the <strong class="bold">spotify tracks chart encrypted</strong> dataset. You can use this link to download the file: <a href="https://github.com/PacktPublishing/Data-Ingestion-with-Python-Cookbook/tree/main/Chapter_2/managing_encrypted_%EF%AC%81les">https://github.com/PacktPublishing/Data-Ingestion-with-Python-Cookbook/tree/main/Chapter_2/managing_encrypted_%EF%AC%81les</a>.</li>
</ol>
<h2 id="_idParaDest-92"><a id="_idTextAnchor092"/>How to do it…</h2>
<p>We will <a id="_idIndexMarker177"/>need a key to decrypt the file using GnuPG. You can find it in the <code> | Managing encrypted ﬁles</code> folder. The link to access it is in the <em class="italic">Technical requirements</em> section at the beginning of this chapter:</p>
<ol>
<li>First, we import our key:<pre class="source-code">
import gnupg
# Create gnupg directory
gpg = gnupg.GPG(gnupghome='gpghome')
# Open and import the key
key_data = open('mykeyfile.asc').read()
import_result = gpg.import_keys(key_data)
# Show the fingerprint of our key
print(import_result.results)</pre></li>
<li>Then, we decrypt the ingestion file:<pre class="source-code">
with open('spotify_data.csv.gpg', 'rb') as f:
    status = gpg.decrypt_file(f, passphrase='mypassphrase', output='spotify_data.csv')
print(status.ok)
print(status.status)
print('error: ', status.stderr)</pre></li>
</ol>
<h2 id="_idParaDest-93"><a id="_idTextAnchor093"/>How it works…</h2>
<p>Regarding<a id="_idIndexMarker178"/> the best practices for encrypting, GnuPG is a security reference and widely used, and it is documented in <strong class="bold">RFC 4880</strong>. You can find out more here: <a href="https://www.rfc-editor.org/rfc/rfc4880">https://www.rfc-editor.org/rfc/rfc4880</a>.</p>
<p class="callout-heading">Note</p>
<p class="callout">A <strong class="bold">Request for Comments</strong> (<strong class="bold">RFC</strong>) is a<a id="_idIndexMarker179"/> technical documentation developed and maintained by the <strong class="bold">Internet Engineering Task Force</strong> (<strong class="bold">IETF</strong>). This <a id="_idIndexMarker180"/>institute specifies the best practices for protocols, services, and patterns on the internet.</p>
<p>Here, we saw a real-life example of GnuPG application, even though it seems simple. Let’s pass through some important lines in the code:</p>
<p>In the <code>gpg = gnupg.GPG(gnupghome='gpghome')</code> line, we instantiated our <code>GPG</code> class and passed where it can store temporary files, and you can set any path you want to. In my case, I created a folder in my home directory called <code>gpghome</code>.</p>
<p>In the next lines, the key is imported, and we print its fingerprint just for demonstration purposes.</p>
<p>For <em class="italic">step 2</em>, we open the file we want to decrypt using the <code>with open</code> statement and decrypt it. You can see that a parameter for <code>passphrase</code> was set. This happened because the more recent versions of GnuPG require the file to have a passphrase set when encrypted. Since this recipe is only for educational matters, the passphrase here is simple and hardcoded.</p>
<p>After that, you <a id="_idIndexMarker181"/>should be able to open the <code>.csv</code> file with no problems.</p>
<div><div><img alt="Figure 2.14 – The decrypted Spotify CSV file" height="793" src="img/Figure_2.14_B19453.jpg" width="1318"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.14 – The decrypted Spotify CSV file</p>
<h2 id="_idParaDest-94"><a id="_idTextAnchor094"/>There’s more…</h2>
<p>Usually, GnuPG is <a id="_idIndexMarker182"/>the tool of choice when it comes to encrypting files, but there are other market solutions such as the Python <code>cryptography</code> library, which has a <code>Fernet</code> class, a symmetric encryption method. As you can see in the following code, its use is very similar to what we did in this recipe:</p>
<pre class="source-code">
from cryptography.fernet import Fernet
# Retrieving key
fernet_key = Fernet(key)
# Getting and opening the encrypted file
with open('spotify_data.csv', 'rb') as enc_file:
    encrypted = enc_file.read()
# Decrypting the file
decrypted = fernet_key.decrypt(encrypted)
# Creating a decrypted file
with open('spotify_data.csv', 'wb') as dec_file:
    dec_file.write(decrypted)</pre>
<p>Still, the <code>Fernet</code> method is not widely used in the data world. It happens because an encrypted file with sensitive data often comes from an application or software that uses GnuPG hybrid encryption, which, as we saw in the <em class="italic">How it works…</em> section, complies with RFC 4880.</p>
<p>You can find more details in <a id="_idIndexMarker183"/>the <code>cryptography</code> library documentation: <a href="https://cryptography.io/en/latest/fernet/">https://cryptography.io/en/latest/fernet/</a>.</p>
<h2 id="_idParaDest-95"><a id="_idTextAnchor095"/>See also</h2>
<ul>
<li>How to<a id="_idIndexMarker184"/> create and encrypt files using the <strong class="bold">Python Wrapper for </strong><strong class="bold">GnuPG</strong>: <a href="https://gnupg.readthedocs.io/en/latest/">https://gnupg.readthedocs.io/en/latest/</a>.</li>
<li>GnuPG official <a id="_idIndexMarker185"/>page and documentation: <a href="https://gnupg.org/">https://gnupg.org/</a>.</li>
<li>If you are curious about RFC 4880 and want to understand it deeper, a summarized article about it was written by David Steele in his blog: <a href="https://davesteele.github.io/gpg/2014/09/20/anatomy-of-a-gpg-key/">https://davesteele.github.io/gpg/2014/09/20/anatomy-of-a-gpg-key/</a>.</li>
<li><em class="italic">Voltage by opentext</em> is a great tool<a id="_idIndexMarker186"/> for data security and recommended by many companies. You can find out more here: <a href="https://www.microfocus.com/en-us/cyberres/data-privacy-protection">https://www.microfocus.com/en-us/cyberres/data-privacy-protection</a>.</li>
</ul>
<h1 id="_idParaDest-96"><a id="_idTextAnchor096"/>Accessing data from AWS using S3</h1>
<p>AWS<a id="_idIndexMarker187"/> is one of the most popular cloud providers, mixing different service architectures and allowing easy and fast implementations.</p>
<p>While it has various solutions for relational and non-relational databases, in this recipe, we will cover how to manage data access<a id="_idIndexMarker188"/> from <strong class="bold">S3 buckets</strong>, which is an object storage service allowing not only text files to be uploaded, but also media and several other types of files used in the IoT and big data fields.</p>
<p>There are two commonly used types of <a id="_idIndexMarker189"/>data access management for S3 buckets, both used on ingest pipelines – <strong class="bold">user control</strong> and <strong class="bold">bucket policies</strong>. In this recipe, we will learn how to manage access by user control, given <a id="_idIndexMarker190"/>that it is the most used method among data ingestion pipelines.</p>
<h2 id="_idParaDest-97"><a id="_idTextAnchor097"/>Getting ready</h2>
<p>To do this<a id="_idIndexMarker191"/> recipe, having or creating an AWS account is not <a id="_idIndexMarker192"/>mandatory. The objective is to build a step-by-step <strong class="bold">Identity Access Management</strong> (<strong class="bold">IAM)</strong> policy<a id="_idIndexMarker193"/> to retrieve data from an S3 bucket using good data access practices you understand.</p>
<p>However, if you want to create a free AWS account to test it, you can follow the steps provided by the <strong class="bold">AWS official docs</strong> here: <a href="https://docs.aws.amazon.com/accounts/latest/reference/manage-acct-creating">https://docs.aws.amazon.com/accounts/latest/reference/manage-acct-creating</a>.xhtml. After creating your AWS account, follow these steps:</p>
<ol>
<li>Let’s create a user to test our S3 policy. To create a user, check out this AWS link: <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.xhtml">https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.xhtml</a>. You don’t need to worry about attaching policies to it, so skip this part of the tutorial. The idea is to explore what a user without any policies attached can do inside the AWS console.</li>
<li>Next, let’s create an S3 bucket using our administrator user. On the search bar, type <code>S3</code> and click on the first link:</li>
</ol>
<div><div><img alt="Figure 2.15 – The AWS search bar" height="696" src="img/Figure_2.15_B19453.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.15 – The AWS search bar</p>
<ol>
<li value="3">Then, click<a id="_idIndexMarker194"/> the <strong class="bold">Create bucket</strong> button and a new page will<a id="_idIndexMarker195"/> load as follows:</li>
</ol>
<div><div><img alt="Figure 2.16 – The AWS S3 main page" height="663" src="img/Figure_2.16_B19453.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.16 – The AWS S3 main page</p>
<p>A new page will load as follows:</p>
<div><div><img alt="Figure 2.17 – The AWS S3 page to create a new bucket" height="960" src="img/Figure_2.17_B19453.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.17 – The AWS S3 page to create a new bucket</p>
<p>On the <code>Stockholm</code> in this recipe since it is the nearest region to where I live. Skip the other fields for now, scroll down, and press the <strong class="bold">Create </strong><strong class="bold">bucket</strong> button:</p>
<p>On the S3 page, you know should be able to see and select the bucket you created:</p>
<div><div><img alt="Figure 2.18 – The S3 bucket objects page" height="848" src="img/Figure_2.18_B19453.jpg" width="1657"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.18 – The S3 bucket objects page</p>
<p>You can upload any files here for testing if you want to.</p>
<p>After completing<a id="_idIndexMarker198"/> the steps, open another window on your browser and <a id="_idIndexMarker199"/>switch to the user you created for testing. If possible, try to keep administrator and testing users logged on in different browsers so that you can see the changes in real time.</p>
<p>We are ready to start creating and applying the access policy.</p>
<h2 id="_idParaDest-98"><a id="_idTextAnchor098"/>How to do it…</h2>
<p>If we try to list <strong class="bold">S3</strong>, we can see the buckets, but when clicking on any bucket, this error will happen:</p>
<div><div><img alt="Figure 2.19 – Testing the user view of an S3 bucket with an Insufficient permissions message" height="581" src="img/Figure_2.19_B19453.jpg" width="916"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.19 – Testing the user view of an S3 bucket with an Insufficient permissions message</p>
<p>Let’s fix this by creating and attaching a policy with the following steps:</p>
<ol>
<li>First, we will <a id="_idIndexMarker200"/>define an access policy for the user. The user will <a id="_idIndexMarker201"/>be capable of listing, retrieving, and deleting any object inside the S3 bucket we created. Let’s start by creating a JSON file with the AWS policy requirements to make it possible. See the following file:<pre class="source-code">
{
   "Version":"2012-10-17",
   "Statement":[
      {
         "Effect":"Allow",
         "Action": "s3:ListAllMyBuckets",
         "Resource":"*"
      },
      {
         "Effect":"Allow",
         "Action":["s3:ListBucket","s3:GetBucketLocation"],
         "Resource":"arn:aws:s3:::cookbook-s3-accesspolicies"
      },
      {
         "Effect":"Allow",
         "Action":[
            "s3:PutObject",
            "s3:PutObjectAcl",
            "s3:GetObject",
            "s3:GetObjectAcl",
            "s3:DeleteObject"
         ],
         "Resource":"arn:aws:s3:::cookbook-s3-accesspolicies /*"
      }
   ]
}</pre></li>
<li>Next, we allow the <a id="_idIndexMarker202"/>user to access the bucket via IAM <a id="_idIndexMarker203"/>policies. On the user IAM page, click on <strong class="bold">Add inline policy</strong> as follows:</li>
</ol>
<div><div><img alt="Figure 2.20 – AWS user Permission policy section" height="979" src="img/Figure_2.20_B19453.jpg" width="863"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.20 – AWS user Permission policy section</p>
<p>Insert the previous code <a id="_idIndexMarker204"/>into the <strong class="bold">JSON</strong> option tab, and click on <strong class="bold">Review policy</strong>. On<a id="_idIndexMarker205"/> the <strong class="bold">Review Policy</strong> page, insert the policy’s name and click <strong class="bold">Create policy</strong> to confirm it, as follows:</p>
<div><div><img alt="Figure 2.21 – The AWS IAM review policy page" height="533" src="img/Figure_2.21_B19453.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.21 – The AWS IAM review policy page</p>
<p>If we check now, we can see that adding but not deleting files is possible.</p>
<h2 id="_idParaDest-99"><a id="_idTextAnchor099"/>How it works…</h2>
<p>At the beginning of <a id="_idIndexMarker206"/>this recipe, our testing user had no permission to access <a id="_idIndexMarker207"/>any resources at AWS. For example, when accessing our created bucket, a warning appeared on the page. Then we allowed the user to access and upload files or objects to the bucket.</p>
<p>In <em class="italic">step 1</em>, we built an inline IAM policy with the following steps:</p>
<ol>
<li>First, we allowed the testing user to list all the buckets inside the respective AWS account:<pre class="source-code">
"Statement":[
      {
         "Effect":"Allow",
         "Action": "s3:ListAllMyBuckets",
         "Resource":"*"
      },</pre></li>
<li>The second statement allows the user to list objects and get the bucket’s location. Note that<a id="_idIndexMarker208"/> in the <strong class="bold">Resource</strong> key, we only specified a target S3 bucket <strong class="bold">AWS Resource </strong><strong class="bold">Name</strong> (<strong class="bold">ARN</strong>):<pre class="source-code">
{
         "Effect":"Allow",
         "Action":["s3:ListBucket","s3:GetBucketLocation"],
         "Resource":"arn:aws:s3:::cookbook-s3-accesspolicies"
      },</pre></li>
<li>Finally, we <a id="_idIndexMarker209"/>create another statement to allow the <a id="_idIndexMarker210"/>insertion and retrieval of objects. In this case, the resource now also has a <code>/*</code> character at the end of the ARN. This represents the policy that is going to affect the respective bucket objects:<pre class="source-code">
{
         "Effect":"Allow",
         "Action":[
            "s3:PutObject",
            "s3:PutObjectAcl",
            "s3:GetObject",
            "s3:GetObjectAcl",
         ],
         "Resource":"arn:aws:s3:::cookbook-s3-accesspolicies /*"
      }</pre></li>
</ol>
<p>Depending on the AWS resource you want to manage access, the <strong class="bold">Action</strong> key can be very different and can have different applications. Regarding S3 buckets and objects, you find all possible actions in the AWS documentation: <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/using-with-s3-actions.xhtml">https://docs.aws.amazon.com/AmazonS3/latest/userguide/using-with-s3-actions.xhtml</a>.</p>
<h2 id="_idParaDest-100"><a id="_idTextAnchor100"/>There’s more…</h2>
<p>When ingesting data, the user control method is the most used. It happens because an application such use <strong class="bold">Airflow</strong> or <strong class="bold">Elastic MapReduce</strong> (<strong class="bold">EMR</strong>) can usually connect to a bucket. Also, from a <a id="_idIndexMarker211"/>management control <a id="_idIndexMarker212"/>perspective, it is much easier to handle, with just a few programmatic accesses instead of one for each user in a company.</p>
<p>Of course, there will be scenarios where each data engineer has a user with permissions set. Still, the scenario usually is (and should be) a development environment with a sample of data.</p>
<h3>Bucket policies</h3>
<p>Bucket policies <a id="_idIndexMarker213"/>can add a security layer to control the access of external resources to internal objects. With these<a id="_idIndexMarker214"/> policies, limiting access to specific IP addresses, specific resources such as <strong class="bold">CloudFront</strong>, or types <a id="_idIndexMarker215"/>of <strong class="bold">HTTP</strong> method requests is possible. In the AWS official documentation, you can see a list of practical examples: <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/example-bucket-policies.xhtml">https://docs.aws.amazon.com/AmazonS3/latest/userguide/example-bucket-policies.xhtml</a>.</p>
<h2 id="_idParaDest-101"><a id="_idTextAnchor101"/>See also</h2>
<p>In the AWS official <a id="_idIndexMarker216"/>documentation, you can also see other types of<a id="_idIndexMarker217"/> access control, such<a id="_idIndexMarker218"/> as <strong class="bold">Access Control Lists</strong> (<strong class="bold">ACLs</strong>) and <strong class="bold">Cross-Origin Resource Sharing</strong> (<strong class="bold">CORS</strong>): <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/s3-access-control.xhtml">https://docs.aws.amazon.com/AmazonS3/latest/userguide/s3-access-control.xhtml</a>.</p>
<h1 id="_idParaDest-102"><a id="_idTextAnchor102"/>Accessing data from GCP using Cloud Storage</h1>
<p><strong class="bold">Google Cloud Platform</strong> (<strong class="bold">GCP</strong>) is a<a id="_idIndexMarker219"/> cloud provider that offers<a id="_idIndexMarker220"/> manifold services, from cloud computing to <strong class="bold">Artificial Intelligence</strong> (<strong class="bold">AI</strong>), which can be implemented in only a few steps. It also provides broad-spectrum storage<a id="_idIndexMarker221"/> called <strong class="bold">Cloud Storage</strong>.</p>
<p>In this recipe, we will build step-by-step policies to control <a id="_idIndexMarker222"/>access to data inside our <strong class="bold">Cloud </strong><strong class="bold">Storage buckets</strong>.</p>
<h2 id="_idParaDest-103"><a id="_idTextAnchor103"/>Getting ready</h2>
<p>This recipe <a id="_idIndexMarker223"/>will use the <em class="italic">uniform</em> method, as <a id="_idIndexMarker224"/>defined by the Google Cloud team:</p>
<ol>
<li>First, we will create a testing user. Go to the <strong class="bold">IAM</strong> page (<a href="https://console.cloud.google.com/iam-admin/iam">https://console.cloud.google.com/iam-admin/iam</a>) and select <strong class="bold">Grant Access</strong>. Add a valid Gmail address in the <strong class="bold">New principals</strong> field. For now, this user will only have the <strong class="bold">Browser</strong> role:</li>
</ol>
<div><div><img alt="Figure 2.22 – The GCP IAM page to attach policies to a user" height="625" src="img/Figure_2.22_B19453.jpg" width="535"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.22 – The GCP IAM page to attach policies to a user</p>
<ol>
<li value="2">Then, we<a id="_idIndexMarker225"/> will create a Cloud Storage <a id="_idIndexMarker226"/>bucket. Go to the <strong class="bold">Cloud Storage</strong> page and select <strong class="bold">Create a </strong><strong class="bold">bucket</strong>: <a href="https://console.cloud.google.com/storage/create-bucket">https://console.cloud.google.com/storage/create-bucket</a>.</li>
</ol>
<div><div><img alt="Figure 2.23 – The GCP search bar with Cloud Storage selected" height="832" src="img/Figure_2.23_B19453.jpg" width="355"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.23 – The GCP search bar with Cloud Storage selected</p>
<p>Add a unique name to your bucket and leave the other option as it is:</p>
<div><div><img alt="Figure 2.24 – The GCP page to create a new bucket" height="796" src="img/Figure_2.24_B19453.jpg" width="946"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.24 – The GCP page to create a new bucket</p>
<h2 id="_idParaDest-104"><a id="_idTextAnchor104"/>How to do it…</h2>
<p>Here are the <a id="_idIndexMarker227"/>steps to<a id="_idIndexMarker228"/> perform this recipe:</p>
<ol>
<li>We will try to access the Cloud Storage objects. First, let’s try to access the bucket using the user we just created. An error message should appear:</li>
</ol>
<div><div><img alt="Figure 2.25 – An insufficient permission message for the testing user in the GCP console" height="629" src="img/Figure_2.25_B19453.jpg" width="1014"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.25 – An insufficient permission message for the testing user in the GCP console</p>
<ol>
<li value="2">Then, we<a id="_idIndexMarker229"/> grant <strong class="bold">Editor</strong> permissions in Cloud <a id="_idIndexMarker230"/>Storage. Go to the <strong class="bold">IAM</strong> page and select the testing user you created. On the editing user page, select <strong class="bold">Editor</strong>.</li>
</ol>
<div><div><img alt="Figure 2.26 – The GCP IAM page – assigning the Editor role to the testing user" height="973" src="img/Figure_2.26_B19453.jpg" width="1192"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.26 – The GCP IAM page – assigning the Editor role to the testing user</p>
<p class="callout-heading">Note</p>
<p class="callout">If you are confused about the roles, use <a id="_idIndexMarker231"/>the Policy Simulator in Google Cloud: <a href="https://console.cloud.google.com/iam-admin/simulator">https://console.cloud.google.com/iam-admin/simulator</a>.</p>
<ol>
<li value="3">Next, we<a id="_idIndexMarker232"/> access Cloud Storage with <a id="_idIndexMarker233"/>a proper role. The user should be able to see and upload objects to the bucket:</li>
</ol>
<div><div><img alt="Figure 2.27 – The testing user view of the GCP bucket" height="304" src="img/Figure_2.27_B19453.jpg" width="1059"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.27 – The testing user view of the GCP bucket</p>
<h2 id="_idParaDest-105"><a id="_idTextAnchor105"/>How it works…</h2>
<p>In <em class="italic">step 1</em>, our testing user had only permission to browse, and an error message appeared when trying to see the bucket list. However, the <strong class="bold">Editor</strong> role for Cloud Storage solves this problem by granting access to the bucket (and most of the other essential Google Cloud resources). At this point, creating a condition to allow only access to this bucket is also possible.</p>
<p>The Google Cloud access hierarchy is based on its organization and projects. To provide access to a respective bucket, we need to ensure we also have access to the resources of a project. Refer to the following screenshot:</p>
<div><div><img alt="Figure 2.28 – GCP control access hierarchy – source: https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy#inheritance" height="1147" src="img/Figure_2.28_B19453.jpg" width="842"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.28 – GCP control access hierarchy – source: https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy#inheritance</p>
<p>Once the access<a id="_idIndexMarker234"/> hierarchy is defined, we can select <a id="_idIndexMarker235"/>several built-in user permission groups on the IAM page and add conditions if needed. Unlike AWS, Google Cloud policies are often created as “roles” and grouped to serve a specific area or department. Additional permissions or conditionals can be made for particular cases, but they are not shared.</p>
<p>Even though the uniform method seems simple, it can be a powerful way to manage access to Google Cloud when properly grouped and revised and uniformly grant permissions. In our case, the <strong class="bold">Editor</strong> role solved our problem, but a specialist on this topic is recommended when working with larger teams and different types of access policies.</p>
<h2 id="_idParaDest-106"><a id="_idTextAnchor106"/>There’s more…</h2>
<p>Like S3, Cloud Storage also has another type of<a id="_idIndexMarker236"/> access control called <strong class="bold">fine-grained</strong>. It consists of a mixture of IAM policies and ACLs and is recommended in cases where storage connects to an S3 bucket, for instance. As its name suggests, the permission is refined to the bucket and individual object levels. It needs to be configured by someone (or a team) with a high level of security knowledge, since the data exposure can be elevated if the <a href="https://davesteele.github.io/gpg/2014/09/20/anatomy-of-a-gpg-key/"><strong class="bold">ACL policy</strong> is not set correctly.</a></p>
<p><a href="https://davesteele.github.io/gpg/2014/09/20/anatomy-of-a-gpg-key/">You can read more about ACLs i</a>n Cloud Storage here: <a href="https://cloud.google.com/storage/docs/access-control/lists">https://cloud.google.com/storage/docs/access-control/lists</a>.</p>
<h1 id="_idParaDest-107"><a id="_idTextAnchor107"/>Further reading</h1>
<ul>
<li><a href="https://www.manageengine.com/device-control/data-replication.xhtml">https://www.manageengine.com/device-control/data-replication.xhtml</a></li>
<li><a href="https://www.keboola.com/blog/database-replication-techniques">https://www.keboola.com/blog/database-replication-techniques</a></li>
<li><a href="https://satoricyber.com/access-control/access-control-101-a-comprehensive-guide-to-database-access-control/">https://satoricyber.com/access-control/access-control-101-a-comprehensive-guide-to-database-access-control/</a></li>
<li><a href="https://stackoverflow.com/questions/190257/best-role-based-access-control-rbac-database-model">https://stackoverflow.com/questions/190257/best-role-based-access-control-rbac-database-model</a></li>
<li><a href="https://www.researchgate.net/publication/281479020_A_Model-driven_Role-based_Access_Control_for_SQL_Databases">https://www.researchgate.net/publication/281479020_A_Model-driven_Role-based_Access_Control_for_SQL_Databases</a></li>
<li><a href="https://dspace.mit.edu/bitstream/handle/1721.1/87870/53700676-MIT.pdf?sequence=2">https://dspace.mit.edu/bitstream/handle/1721.1/87870/53700676-MIT.pdf?sequence=2</a></li>
<li><a href="https://scholarworks.calstate.edu/downloads/sb397840v">https://scholarworks.calstate.edu/downloads/sb397840v</a></li>
<li><a href="https://www.sftp.net/public-online-sftp-servers">https://www.sftp.net/public-online-sftp-servers</a></li>
<li><a href="https://www.ittsystems.com/how-to-access-sftp-server-in-python/">https://www.ittsystems.com/how-to-access-sftp-server-in-python/</a></li>
<li><a href="https://towardsdatascience.com/encrypt-and-decrypt-files-using-python-python-programming-pyshark-a67774bbf9f4">https://towardsdatascience.com/encrypt-and-decrypt-files-using-python-python-programming-pyshark-a67774bbf9f4</a></li>
<li><a href="https://www.geeksforgeeks.org/encrypt-and-decrypt-files-using-python/">https://www.geeksforgeeks.org/encrypt-and-decrypt-files-using-python/</a></li>
<li><a href="https://www.saltycrane.com/blog/2011/10/python-gnupg-gpg-example/">https://www.saltycrane.com/blog/2011/10/python-gnupg-gpg-example/</a></li>
<li><a href="https://www.ekransystem.com/en/blog/data-security-best-practices">https://www.ekransystem.com/en/blog/data-security-best-practices</a></li>
<li><a href="https://www.ovaledge.com/blog/data-access-management-basics-implementation-strategy">https://www.ovaledge.com/blog/data-access-management-basics-implementation-strategy</a></li>
</ul>
</div>
</div></body></html>