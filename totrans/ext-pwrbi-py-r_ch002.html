<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="en-US">
<head>
<meta charset="utf-8"/>
<meta name="generator" content="packt"/>
<title>1 Where and How to Use R and Python Scripts in Power BI</title>



</head>
<body>


<h1 data-number="2">1 Where and How to Use R and Python Scripts in Power BI</h1>
<p>Power BI is Microsoft's flagship <strong>self-service business intelligence</strong> product. It consists of a set of on-premises applications and cloud-based services that help organizations integrate, transform, and analyze data from a wide variety of source systems through a user-friendly interface.</p>
<p>The platform is not limited to data visualization. Power BI is much more than this, when you consider that its analytics engine (<strong>Vertipaq</strong>) is the same as <strong>SQL Server Analysis Services</strong> (<strong>SSAS</strong>) and <strong>Azure Analysis Services</strong>. It also uses <strong>Power Query</strong> as its data extraction and transformation engine, which we find in both Analysis Services and <strong>Excel</strong>. The engine comes with a very powerful and versatile formula language (<strong>M</strong>) and GUI, thanks to which you can "grind" and shape any type of data into any form.</p>
<p>Moreover, Power BI supports <strong>DAX</strong> as a data analytic formula language, which can be used for advanced calculations and queries on data that has already been loaded into tabular data models.</p>
<p>Such a versatile and powerful tool is a godsend for anyone who needs to do data ingestion and transformation in order to build dashboards and reports to summarize a company's business.</p>
<p>Recently, the availability of huge amounts of data, along with the ability to scale the computational power of machines, has made the area of <strong>advanced analytics</strong> more appealing. So, new mathematical and statistical tools have become necessary in order to provide rich insights. Hence the integration of analytical languages such as <strong>Python</strong> and <strong>R</strong> within Power BI.</p>
<p>R or Python scripts can only be used within Power BI with specific features. Knowing which Power BI tools can be used to inject R or Python scripts into Power BI is key to understanding whether the problem you want to address is achievable with these analytical languages.</p>
<p>This chapter will cover the following topics:</p>
<ul>
<li>Injecting R or Python scripts into Power BI</li>
<li>Using R and Python to interact with your data</li>
<li>R and Python limitations on Power BI products</li>
</ul>

<h2 data-number="2.1">Technical requirements</h2>
<p>This chapter requires you to have <strong>Power BI Desktop</strong> already installed on your machine (you can download it from here: <a href="https://aka.ms/pbiSingleInstaller">https://aka.ms/pbiSingleInstaller</a>).</p>


<h2 data-number="2.2">Injecting R or Python scripts into Power BI</h2>
<p>In this first section, the Power BI Desktop tools that allow you to use Python or R scripts will be presented and described in detail. Specifically, you will see how to add your own code during the <strong>data loading</strong>, <strong>data transforming</strong>, and <strong>data viewing</strong> phases.</p>

<h3 data-number="2.2.1">Data loading</h3>
<p>One of the first steps required to work with data in Power BI Desktop is to <strong>import</strong> it from external sources:</p>
<ol>
<li><p>There are many connectors that allow you to do this, depending on the respective data sources, but you can also do it via scripts in Python and R. In fact, if you click on the <strong>Get data</strong> icon in the ribbon, not only are the most commonly used connectors shown, but you can select other ones from a more complete list by clicking on <strong>More...</strong>:</p>
<figure>
<img src="img/file0.png" alt="Figure 1.1 – Browse more connectors to load your data" /><figcaption aria-hidden="true">Figure 1.1 – Browse more connectors to load your data</figcaption>
</figure></li>
<li><p>In the new <strong>Get Data</strong> window that pops up, simply start typing the string <code>script</code> into the search text box, and immediately the two options for importing data via Python or R appear:</p>
<figure>
<img src="img/file1.png" alt="Figure 1.2 – Showing R script and Python script into the Get Data window" /><figcaption aria-hidden="true">Figure 1.2 – Showing R script and Python script into the Get Data window</figcaption>
</figure></li>
<li>Reading the contents of the tooltip, obtained by hovering the mouse over the <strong>Python script</strong> option, two things should immediately jump out at you:a)A local installation of Python is required.B)What can be imported through Python is a data frame.The same two observations also apply when selecting <strong>R script</strong>. The only difference is that it is possible to import a <strong>pandas DataFrame</strong> when using Python (a DataFrame is a data structure provided by the pandas package), whereas R employs the two-dimensional array-like data structure called <strong>R data frame</strong>, which is provided by default by the language.</li>
<li><p>After clicking on the <strong>Python script</strong> option, a new window will be shown containing a text box for writing the Python code:</p>
<figure>
<img src="img/file2.png" alt="Figure 1.3 – Window showing the Python script editor" /><figcaption aria-hidden="true">Figure 1.3 – Window showing the Python script editor</figcaption>
</figure>
<p>As you can see, it's definitely a very skimpy editor, but in <em>Chapter 3,</em> <em>Configuring Python with Power BI</em>, you'll see how you can use your favorite IDE to develop your own scripts.</p></li>
<li>Taking a look at the warning message, Power BI reminds us that no Python engine has been detected, so it must be installed. Clicking on the <strong>How to install Python</strong> link will cause a Microsoft Docs web page to open, explaining the steps to install Python. Microsoft suggests installing the base Python distribution, but in order to follow some best practices on <strong>environments</strong>, we will install the <code>Miniconda</code> distribution. The details of how to do this and why will be covered in Chapter 3.</li>
<li><p>If you had clicked on <strong>R script</strong> instead, a window for entering code in R, similar to the one shown in <em>Figure 1.4</em>, would have appeared:</p>
<figure>
<img src="img/file3.png" alt="Figure 1.4 – Window showing the R script editor" /><figcaption aria-hidden="true">Figure 1.4 – Window showing the R script editor</figcaption>
</figure>
<p>As with Python, in order to run code in R, you need to install the R engine on your machine. Clicking on the <strong>How to install R</strong> link will open a Docs page where Microsoft suggests installing either <strong>Microsoft R Open</strong> or the classic <strong>CRAN R</strong>. <em>Chapter 2, ​Configuring R With Power BI</em>, will show you which engine to choose and how to configure your favorite IDE to write code in R.</p></li>
</ol>
<p>In order to import data using Python or R, you need to write code in the editors shown in <em>Figure 1.3</em> and <em>Figure 1.4</em> that assigns a pandas DataFrame or an R data frame to a variable, respectively. You will see concrete examples throughout this book.</p>
<p>Next, let’s look at transforming data.</p>


<h3 data-number="2.2.2">Data transformation</h3>
<p>It is possible to apply a transformation to data already imported or being imported, using scripts in R or Python. Should you want to test this on the fly, you can import the following CSV file directly from the web: <a href="http://bit.ly/iriscsv">http://bit.ly/iriscsv</a>. Follow these steps:</p>
<ol>
<li><p>Simply click on <strong>Get data</strong> and then <strong>Web</strong> to import data directly from a web page:</p>
<figure>
<img src="img/file4.png" alt="Figure 1.5 – Select the Web connector to import data from a web page" /><figcaption aria-hidden="true">Figure 1.5 – Select the Web connector to import data from a web page</figcaption>
</figure></li>
<li><p>You can now enter the previously mentioned URL in the window that pops up:</p>
<figure>
<img src="img/file5.png" alt="Figure 1.6 – Import the Iris data from the web" /><figcaption aria-hidden="true">Figure 1.6 – Import the Iris data from the web</figcaption>
</figure>
<p>Right after clicking <strong>OK</strong>, a window will pop up with a preview of the data to be imported.</p></li>
<li><p>In this case, instead of importing the data as-is, click on <strong>Transform Data</strong> in order to access the Power Query data transformation window:</p>
<figure>
<img src="img/file6.png" alt="Figure 1.7 – Imported data preview" /><figcaption aria-hidden="true">Figure 1.7 – Imported data preview</figcaption>
</figure></li>
<li><p>It is at this point that you can add a transformation step using a Python or R script by selecting the <strong>Transform</strong> tab in <strong>Power Query Editor</strong>:</p>
<figure>
<img src="img/file7.png" alt="Figure 1.8 – R and Python script tools into Power Query Editor" /><figcaption aria-hidden="true">Figure 1.8 – R and Python script tools into Power Query Editor</figcaption>
</figure></li>
<li><p>By clicking on <strong>Run Python script</strong>, you’ll cause a window similar to the one you’ve already seen in the data import phase to pop up:</p>
<figure>
<img src="img/file8.png" alt="Figure 1.9 – The Run Python script editor" /><figcaption aria-hidden="true">Figure 1.9 – The Run Python script editor</figcaption>
</figure>
<p>If you carefully read the comment in the text box, you will see that the <code>dataset</code> variable is already initialized and contains the data present at that moment in Power Query Editor, including any transformations already applied. At this point, you can insert your Python code in the text box to transform the data into the desired form.</p></li>
<li><p>A similar window will open if you click on <strong>Run R script</strong>:</p>
<figure>
<img src="img/file9.png" alt="Figure 1.10 – The Run R script editor" /><figcaption aria-hidden="true">Figure 1.10 – The Run R script editor</figcaption>
</figure>
<p>Also, in this case, the <code>dataset</code> variable is already initialized and contains the data present at that moment in Power Query Editor. You can then add your own R code and reference the <code>dataset</code> variable to transform your data in the most appropriate way.</p></li>
</ol>
<p>Next, let’s look at visualizing data.</p>


<h3 data-number="2.2.3">Data visualization</h3>
<p>Finally, your own Python or R scripts can be added to Power BI to create new visualizations, in addition to those already present in the tool out of the box:</p>
<ol>
<li><p>Assuming we resume the data import activity begun in the previous section, once the <code>Iris</code> dataset is loaded, simply click <strong>Cancel</strong> in the <strong>Run R script</strong> window, and then click <strong>Close &amp; Apply</strong> in the <strong>Home</strong> tab of Power Query Editor:</p>
<figure>
<img src="img/file10.png" alt="Figure 1.11 – Click Close &amp; Apply to import the Iris data" /><figcaption aria-hidden="true">Figure 1.11 – Click Close &amp; Apply to import the Iris data</figcaption>
</figure></li>
<li><p>After the data import is complete, you can select either the <strong>R script visual</strong> or <strong>Python script visual</strong> option in the <strong>Visualizations</strong> pane of Power BI:</p>
<figure>
<img src="img/file11.png" alt="Figure 1.12 – The R and Python script visuals" /><figcaption aria-hidden="true">Figure 1.12 – The R and Python script visuals</figcaption>
</figure></li>
<li><p>If you click on <strong>Python script visual</strong>, a window pops up asking for permission to enable script code execution, as there may be security or privacy risks:</p>
<figure>
<img src="img/file12.png" alt="Figure 1.13 – Enable the script code execution" /><figcaption aria-hidden="true">Figure 1.13 – Enable the script code execution</figcaption>
</figure></li>
<li><p>After enabling code execution, in Power BI Desktop you can see a placeholder for the Python visual image on the report canvas and a Python script editor at the bottom:</p>
<figure>
<img src="img/file13.png" alt="Figure 1.14 – The Python visual layout" /><figcaption aria-hidden="true">Figure 1.14 – The Python visual layout</figcaption>
</figure>
<p>You can now write your own custom code in the Python editor and run it via the <strong>Run script</strong> icon highlighted in <em>Figure 1.14</em> to generate a Python visualization.</p></li>
</ol>
<p>A pretty much identical layout occurs when you select <strong>R script visual</strong>.</p>



<h2 data-number="2.3">Using R and Python to interact with your data</h2>
<p>In the previous section, you saw all the ways you can interact with your data in Power BI via R or Python scripts. Beyond knowing how and where to inject your code into Power BI, it is very important to know how your code will interact with that data. It’s here that we see a big difference between the effect of scripts injected via Power Query Editor and scripts used in visuals:</p>
<ul>
<li><strong>Scripts via Power Query Editor</strong>: This type of script will transform the data and <strong>persist</strong> transformations in the model. This means that it will always be possible to retrieve the transformed data from any object within Power BI. Also, once the scripts have been executed and have taken effect, <em>they will not be re-executed unless the data is refreshed</em>. Therefore, it is recommended to inject code in R or Python via Power Query Editor when you intend to use the resulting insights in other visuals, or in the data model.</li>
<li><strong>Scripts in visuals</strong>: The scripts used within the R and Python script visuals extract particular insights from the data and only make them evident to the user through <strong>visualization</strong>. Like all the other visuals on a report page, the R and Python script visuals are also interconnected with the other visuals. This means that the script visuals are subject to <strong>cross-filtering</strong> and therefore <em>they are refreshed every time you interact with other visuals in the report</em>. That said, it is not possible to persist the results obtained from the visuals scripts in the data model.</li>
</ul>
<blockquote>
<p><strong>Tip</strong></p>
<p>Thanks to the interactive nature of R and Python script visuals due to cross-filtering, it is possible to inject code useful to extract <strong>real-time insights</strong> from data, but also from external sources (you'll see how in <em>Chapter 8,</em> <em>Calling External APIs to Enrich Your Data</em>). The important thing to keep in mind is that, as previously stated, it is then only possible to visualize such information, or at the most to write it to external repositories (as you will see in <em>Chapter 7,</em> <em>Log Data from Power BI to External Repositories</em>).</p>
</blockquote>
<p>In the final section of this chapter, let’s look at the limitations of using R and Python when it comes to various Power BI products.</p>


<h2 data-number="2.4">R and Python limitations on Power BI products</h2>
<p>The first question once you are clear on where to inject R and Python scripts in Power BI could be: “<em>Is the use of R and Python code allowed in all Power BI products?</em>” In order to have a brief recap of the various Power BI products and their usage in general, here is a concise list:</p>
<ul>
<li><strong>Power BI Service</strong>: This is sometimes called <strong>Power BI Online</strong>, and it's the <strong>Software as a Service</strong> (<strong>SaaS</strong>) declination of Power BI. It was created to facilitate the sharing of visual analysis between users through Dashboards and Reports.</li>
<li><strong>Power BI Report Server</strong>: This is the on-premises version of Power BI and it extends the capabilities of <strong>SQL Server Reporting Services</strong>, enabling the sharing of reports created in <strong>Power BI Desktop (for Report Server)</strong>.</li>
<li><strong>Power BI Embedded</strong>: A Microsoft Azure service that allows dashboards and reports to be embedded in an application for users who do not have a Power BI account.</li>
<li><strong>Power BI Desktop</strong>: A free desktop application for Windows that allows you to use almost all of the features that Power BI exposes. It is not the right tool for sharing results between users, but it allows you to share them on Power BI Service and Power BI Report Server. The desktop versions that allow publishing on the two mentioned services are distinct.</li>
<li><strong>Power BI Mobile</strong>: A mobile application, available on Windows, Android, and iOS, that allows secure access to Power BI Service and Power BI Report Server, and that allows you to browse and share dashboards and reports, but not edit them.</li>
</ul>
<p>Apart from the licenses, which we will not go into here, a summary figure of the relationships between the products mentioned previous follows:</p>
<figure>
<img src="img/file14.png" alt="Figure 1.15 – Interactions between Power BI products" /><figcaption aria-hidden="true">Figure 1.15 – Interactions between Power BI products</figcaption>
</figure>
<p>Unfortunately, of all these products, only <strong>Power BI Service</strong>, <strong>Power BI Embedded</strong>, and <strong>Power BI Desktop</strong> allow you to enrich data via code in R and Python:</p>
<figure>
<img src="img/file15.png" alt="Figure 1.16 – Power BI products compatibility with R and Python" /><figcaption aria-hidden="true">Figure 1.16 – Power BI products compatibility with R and Python</figcaption>
</figure>
<blockquote>
<p><strong>Important Note</strong></p>
<p>From here on out, when we talk about <em>Power BI Service</em> in terms of compatibility with analytical languages, what we say <em>will also apply to Power BI Embedded</em>.</p>
</blockquote>
<p>So, if you need to develop reports using advanced analytics through R and Python, make sure the target platform supports them.</p>


<h2 data-number="2.5">Summary</h2>
<p>This chapter has given a detailed overview of all the ways by which you can use R and Python scripts in Power BI Desktop. During the data ingestion and data transformation phases, Power Query Editor allows you to add steps containing R or Python code. You can also make use of these analytical languages during the data visualization phase thanks to the R and Python script visuals provided by Power BI Desktop.</p>
<p>It is also very important to know how the R and Python code will interact with the data already loaded or being loaded in Power BI. If you use Power Query Editor, both when loading and transforming data, the result of script processing will be persisted in the data model. Also, if you want to run the same scripts again, you have to refresh the data. On the other hand, if you use the R and Python script visuals, the code results can only be displayed and are not persisted in the data model. In this case, script execution occurs whenever cross-filtering is triggered via the other visuals in the report.</p>
<p>Unfortunately, at the time of writing, you cannot run R and Python scripts in any other Power BI product. The only ones that provide for running analytics scripts are Power BI Desktop and Power BI Service.</p>
<p>In the next chapter, we will see how best to configure the R engine and RStudio to integrate with Power BI Desktop.</p>


</body>
</html>
