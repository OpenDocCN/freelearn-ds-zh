<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch12"/>Chapter 12. Know your Map</h1></div></div></div><p>In this chapter we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Projecting the US map</li><li class="listitem" style="list-style-type: disc">Projecting the world map</li><li class="listitem" style="list-style-type: disc">Building a choropleth map</li></ul></div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec83"/>Introduction</h1></div></div></div><p>The ability to project and correlate data points to geographic regions is crucial in many types of visualizations. Geographic visualization<a id="id655" class="indexterm"/> is a complex topic with many competing standards emerging and maturing for today's web technology. D3 provides few different ways to visualize geographic and cartographic data. In this chapter we will introduce basic D3 cartographic visualization techniques<a id="id656" class="indexterm"/> and how to implement a fully-functional choropleth map (a special purpose colored map) in D3.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec84"/>Projecting the US map</h1></div></div></div><p>In this recipe we are going to <a id="id657" class="indexterm"/>start with projecting the US map using D3 geo API, while also getting familiar with a few different JSON data formats for describing geographic data. Let's first take a look at how geographic data are typically presented and consumed in JavaScript.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec245"/>GeoJSON</h2></div></div></div><p>The first standard JavaScript geographic data format we are going to touch upon is called <strong>GeoJSON</strong>. GeoJSON<a id="id658" class="indexterm"/> format differs from other GIS standards in that it was written and is maintained by an Internet working group of developers.</p><div><blockquote class="blockquote"><p>GeoJSON is a format for encoding a variety of geographic data structure. A GeoJSON object may represent geometry, a feature, or a collection of features. GeoJSON supports the following geometry types: Point, LineString, Polygon, MultiPoint, MultiLineString, MultiPolygon, and GeometryCollection. Features in GeoJSON contain a geometry object and additional properties, and a feature collection represents a list of features.</p><p>Source: <a class="ulink" href="http://www.geojson.org/">http://www.geojson.org/</a></p></blockquote></div><p>GeoJSON format is a <a id="id659" class="indexterm"/>very popular standard for encoding GIS information and is supported by numerous open source as well as commercial softwares. GeoJSON format uses latitude and longitude points as its coordinates, therefore, it requires any software, including D3, to find the proper projection, scale and translation method in order to visualize its data. The <a id="id660" class="indexterm"/>following GeoJSON data describes the state of Alabama in feature coordinates:</p><div><pre class="programlisting">{
  "type":"FeatureCollection",
  "features":[{
    "type":"Feature",
    "id":"01",
    "properties":{"name":"AL"},
    "geometry":{
      "type":"Polygon",
      "coordinates":[[
        [-87.359296,35.00118],
        [-85.606675,34.984749],
        [-85.431413,34.124869],
        [-85.184951,32.859696],
        ...
        [-88.202745,34.995703],
        [-87.359296,35.00118]
      ]]
  }]
}</pre></div><p>GeoJSON is currently the de facto GIS information standard for JavaScript project and is well supported by D3; however, before we jump right into D3 geographic visualization using this data format, we want to also introduce you to another emerging technology closely related to GeoJSON.</p><div><div><div><div><h3 class="title"><a id="ch12lvl3sec22"/>TopoJSON</h3></div></div></div><div><blockquote class="blockquote"><p>TopoJSON <a id="id661" class="indexterm"/>is an extension of GeoJSON that encodes topology. Rather than representing geometries discretely, geometries in TopoJSON files are stitched together from shared line segments called arcs. TopoJSON eliminates redundancy, offering much more compact representations of geometry than with GeoJSON; typical TopoJSON files are 80% smaller than their GeoJSON equivalents. In addition, TopoJSON facilitates applications that use topology, such as topology-preserving shape simplification, automatic map coloring, and cartograms.</p><p>TopoJSON Wiki https://github.com/mbostock/topojson</p></blockquote></div><p>TopoJSON was <a id="id662" class="indexterm"/>created by D3's author <em>Mike Bostock</em> and designed to overcome some of the drawbacks in GeoJSON while providing a similar feature set when describing geographic information. In most cases concerning cartographic visualization TopoJSON can be a drop-in replacement for GeoJSON with much smaller footprint and better performance. Therefore, in this chapter we will use TopoJSON instead of GeoJSON. Nevertheless, all techniques discussed in this chapter will work perfectly fine with GeoJSON as well. We will not list TopoJSON example here since its arcs based format is not very human readable. However, you can easily convert your <strong>shapefiles</strong> (popular open source geographic vector format file) into TopoJSON using <code class="literal">ogr2ogr</code> command line tool provided by GDAL (<a class="ulink" href="http://www.gdal.org/ogr2ogr.html">http://www.gdal.org/ogr2ogr.html</a>).</p><p>Now equipped with this background information let's see how we can make a map in D3.</p></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec246"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser hosted on your local HTTP server:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter12/usa.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter12/usa.html</a>
</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec247"/>How to do it...</h2></div></div></div><p>In this recipe we will load US TopoJSON data and render them using D3 Geo API. Here is the code sample:</p><div><pre class="programlisting">&lt;script type="text/javascript"&gt;
    var width = 960, height = 500;

    // use default USA Albers projection
    var path = d3.geo.path();

    var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

    var g = svg.append('g')
            .call(d3.behavior.zoom()
                  .scaleExtent([1, 10])
                  .on("zoom", zoom));

    d3.json("/data/us.json", function (error, topology) { // &lt;-A
        g.selectAll("path") 
                .data(topojson.feature(topology, 
                   topology.objects.states).features)
                .enter().append("path")
                .attr("d", path);
    });

    function zoom() {
        g.attr("transform", "translate("
                + d3.event.translate
                + ")scale(" + d3.event.scale + ")");
    }
&lt;/script&gt;</pre></div><p>This recipe projects<a id="id663" class="indexterm"/> US map with Albers USA mode:</p><div><img src="img/2162OS_12_01.jpg" alt="How to do it..."/><div><p>US map projected with Albers USA mode</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec248"/>How it works...</h2></div></div></div><p>As you can see, the<a id="id664" class="indexterm"/> code required to project a US map using TopoJSON and D3 is quite short, especially the part concerning map projection. This is because both D3 geographic API and TopoJSON library are built explicitly to make this kind of job as easy as possible for developers. To make a map, first you need to load the TopoJSON data file (line A). The following screenshot shows what the topology data looks like once loaded:</p><div><img src="img/2162OS_12_02.jpg" alt="How it works..."/><div><p>Topology data from TopoJSON</p></div></div><p>Once the topology data is loaded, all we have to do is to use the TopoJSON library <code class="literal">topojson.feature</code> function to convert topology arcs into coordinates similar to what GeoJSON format provides as shown in the following screenshot:</p><div><img src="img/2162OS_12_03.jpg" alt="How it works..."/><div><p>Feature collection converted using topojson.feature function</p></div></div><p>Then <code class="literal">d3.geo.path</code> will automatically recognize and use the coordinates to generate <code class="literal">svg:path</code> highlighted in the following code snippet:</p><div><pre class="programlisting">var path = d3.geo.path();
...
g.selectAll("path") 
                .data(topojson.feature(topology, 
                   topology.objects.states).features)
                .enter().append("path")
                .attr("d", path);</pre></div><p>That's it! This is all you need to do to project a map in D3 using TopoJSON. Additionally, we have also attached a zoom handler to the parent <code class="literal">svg:g</code> element:</p><div><pre class="programlisting">var g = svg.append('g')
            .call(d3.behavior.zoom()
                  .scaleExtent([1, 10])
                  .on("zoom", zoom));</pre></div><p>This allows the user<a id="id665" class="indexterm"/> to perform simple geometric zoom on our map.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec249"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">GeoJSON v1.0 specification: <a class="ulink" href="http://www.geojson.org/geojson-spec.html">http://www.geojson.org/geojson-spec.html</a></li><li class="listitem" style="list-style-type: disc">TopoJSON Wiki: <a class="ulink" href="https://github.com/mbostock/topojson/wiki">https://github.com/mbostock/topojson/wiki</a></li><li class="listitem" style="list-style-type: disc">More on making map from shapefiles to TopoJSON: <a class="ulink" href="http://bost.ocks.org/mike/map/">http://bost.ocks.org/mike/map/</a></li><li class="listitem" style="list-style-type: disc"><a class="link" href="ch03.html" title="Chapter 3. Dealing with Data">Chapter 3</a>, <em>Dealing with Data</em>, for more information on asynchronous data loading</li><li class="listitem" style="list-style-type: disc"><a class="link" href="ch10.html" title="Chapter 10. Interacting with your Visualization">Chapter 10</a>, <em>Interacting with your Visualization</em>, for more information on how to implement zooming</li><li class="listitem" style="list-style-type: disc">Mike Bostock's post on Albers USA projection on which this recipe is based <a class="ulink" href="http://bl.ocks.org/mbostock/4090848">http://bl.ocks.org/mbostock/4090848</a></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec85"/>Projecting the world map</h1></div></div></div><p>What if our visualization <a id="id666" class="indexterm"/>project is not just about US, but rather concerns the whole world? No worries, D3 comes with various built-in projection modes that work well with the world map that we will explore in this recipe.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec250"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser hosted on your local HTTP server:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter12/world.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter12/world.html</a>
</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec251"/>How to do it...</h2></div></div></div><p>In this recipe we will project the world map using various different D3 built-in projection modes. Here is the code <a id="id667" class="indexterm"/>sample:</p><div><pre class="programlisting">&lt;script type="text/javascript"&gt;
    var width = 300, height = 300,
        translate = [width / 2, height / 2];

    var projections = [ // &lt;-A
        {name: 'azimuthalEqualArea', fn: 
          d3.geo.azimuthalEqualArea()
                .scale(50)
                .translate(translate)},
        {name: 'conicEquidistant', fn: d3.geo.conicEquidistant()
             .scale(35)
                .translate(translate)},
        {name: 'equirectangular', fn: d3.geo.equirectangular()
             .scale(50)
                .translate(translate)},
        {name: 'mercator', fn: d3.geo.mercator()
             .scale(50)
                .translate(translate)},
        {name: 'orthographic', fn: d3.geo.orthographic()
                   .scale(90)
                      	.translate(translate)},
        {name: 'stereographic', fn: d3.geo.stereographic()
                                .scale(35)
                                .translate(translate)}
    ];

    d3.json("/data/world-50m.json", function (error, world) {//&lt;-B    
        projections.forEach(function (projection) {
            var path = d3.geo.path() // &lt;-C
                    .projection(projection.fn);

            var div = d3.select("body")
                    .append("div")
                    .attr("class", "map");

            var svg = div
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);

            svg.append("path") // &lt;-D
                    .datum(topojson.feature(world, 
                       world.objects.land))
                    .attr("class", "land")
                    .attr("d", path);

            svg.append("path") // &lt;-E
                    .datum(topojson.mesh(world, 
                       world.objects.countries))
                    .attr("class", "boundary")
                    .attr("d", path);

            div.append("h3").text(projection.name);
        });
    });
&lt;/script&gt;</pre></div><p>This recipe generates <a id="id668" class="indexterm"/>world maps with different projection modes as shown in the following screenshot:</p><div><img src="img/2162OS_12_04.jpg" alt="How to do it..."/><div><p>World Map Projection</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec252"/>How it works...</h2></div></div></div><p>In this recipe we <a id="id669" class="indexterm"/>first define an array containing six different D3 projection modes on line A. A world topology data was loaded on line B. Similar to the previous recipe we have a <code class="literal">d3.geo.path</code> generator defined on line C; however, in this recipe we customized the projection mode for geo path generator calling its <code class="literal">projection</code> function. The rest of the recipe is almost identical to what we have done in the previous recipe. The <code class="literal">topojson.feature</code> function was used to convert topology data into geographic coordinates so <code class="literal">d3.geo.path</code> can generate <code class="literal">svg:path</code> required for map rendering (line D and E).</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec253"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">D3 wiki Geo Projection page (<a class="ulink" href="https://github.com/mbostock/d3/wiki/Geo-Projections">https://github.com/mbostock/d3/wiki/Geo-Projections</a>) for more information on different projection modes as well as on how raw custom projection can be implemented</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec86"/>Building a choropleth map</h1></div></div></div><p>Choropleth map <a id="id670" class="indexterm"/>is a thematic map, in other words, a specially designed map not a general purpose one, which is designed to show measurement of statistical variable on the map using different color shades or patterns; or sometimes referred as geographic heat-map in simpler terms. We have already seen in the previous two recipes that geographic projection in D3 consists of a group of <code class="literal">svg:path</code> elements, therefore, they can be manipulated as any other <code class="literal">svg</code> elements including coloring. We will explore this feature in geo-projection and implement a Choropleth map in this recipe.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec254"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser hosted on your local HTTP server:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter12/choropleth.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter12/choropleth.html</a>
</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec255"/>How to do it...</h2></div></div></div><p>In a choropleth map<a id="id671" class="indexterm"/> different geographic regions are colored according to their corresponding variables, in this case based on 2008 unemployment rate in US by county. Now, let's see how to do it in code:</p><div><pre class="programlisting">&lt;script type="text/javascript"&gt;
    var width = 960, height = 500;

    var color = d3.scale.threshold() // &lt;-A
            .domain([.02, .04, .06, .08, .10])
            .range(["#f2f0f7", "#dadaeb", "#bcbddc", 
             "#9e9ac8", "#756bb1", "#54278f"]);

    var path = d3.geo.path();

    var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

var g = svg.append("g")
...
    d3.json("/data/us.json", function (error, us) {
        d3.tsv("/data/unemployment.tsv", function (error, 
                                            unemployment) {
            var rateById = {};
            unemployment.forEach(function (d) { // &lt;-B
                rateById[d.id] = +d.rate;
            });

            g.append("g")
                    .attr("class", "counties")
                    .selectAll("path")
                    .data(topojson.feature(us, 
                            us.objects.counties).features)
                    .enter().append("path")
                    .attr("d", path)
                    .style("fill", function (d) {
                        return color(rateById[d.id]); // &lt;-C
                    });

            g.append("path")
                    .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
                    .attr("class", "states")
                    .attr("d", path);
        });
});
...
&lt;/script&gt;</pre></div><p>This recipe generates<a id="id672" class="indexterm"/> the following choropleth map:</p><div><img src="img/2162OS_12_05.jpg" alt="How to do it..."/><div><p>Choropleth Map of 2008 Unemployment Rate</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec256"/>How it works...</h2></div></div></div><p>In this recipe we loaded<a id="id673" class="indexterm"/> two different data sets: one for the US topology and the other containing unemployment rate by county in 2008. This technique is generally considered as layering and is not necessarily limited to only two layers. The unemployment data are stitched to counties by their ID (line B and C). Region coloring is achieved by using a threshold scale (line A). One last point worth mentioning is the <code class="literal">topojson.mesh</code> function used to render state borders. <code class="literal">topojson.mesh</code> is useful for rendering strokes in complicated objects efficiently since it only renders shared edge by multiple features once.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec257"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">TopoJSON Wiki for more information on mesh function: <a class="ulink" href="https://github.com/mbostock/topojson/wiki/API-Reference#wiki-mesh">https://github.com/mbostock/topojson/wiki/API-Reference#wiki-mesh</a></li><li class="listitem" style="list-style-type: disc">D3 Wiki for more information on threshold scale: <a class="ulink" href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-threshold">https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-threshold</a></li><li class="listitem" style="list-style-type: disc">Mike Bostock's post on choropleth map which this recipe is based on: <a class="ulink" href="http://bl.ocks.org/mbostock/4090848">http://bl.ocks.org/mbostock/4090848</a></li></ul></div></div></div></body></html>