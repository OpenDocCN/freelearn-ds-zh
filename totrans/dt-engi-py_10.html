<html><head></head><body>
		<div id="_idContainer142">
			<h1 id="_idParaDest-91"><em class="italic"><a id="_idTextAnchor093"/>Chapter 8</em>: Version Control with the NiFi Registry</h1>
			<p>In the previous chapters, you built several data pipelines, but we have left out a very important component—version control. Any good software developer will almost always set up version control on their project before they start writing any code. Building data pipelines for production is no different. Data engineers use many of the same tools and processes as software engineers. Using version control allows you to make changes without the fear of breaking your data pipeline. You will always be able to roll back changes to previous versions. The NiFi registry also allows you to connect new NiFi instances and have full access to all your existing data pipelines. In this chapter, we're going to cover the following main topics:</p>
			<ul>
				<li>Installing and configuring the NiFi Registry</li>
				<li>Using the Registry in NiFi</li>
				<li>Versioning your data pipelines</li>
				<li>Using git-persistence with the NiFi Registry</li>
			</ul>
			<h1 id="_idParaDest-92"><a id="_idTextAnchor094"/>Installing and configuring the NiFi Registry</h1>
			<p>When<a id="_idIndexMarker453"/> you hear <a id="_idIndexMarker454"/>about version control, you are probably used to hearing about Git. Later in this chapter, we will use Git, but Apache NiFi has a sub-project that can handle all of our version control needs—the NiFi Registry:</p>
			<div>
				<div id="_idContainer120" class="IMG---Figure">
					<img src="image/Figure_8.1__B15739.jpg" alt="Figure 8.1 – The NiFi Registry home page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.1 – The NiFi Registry home page</p>
			<p>Let's now install the Registry.</p>
			<h2 id="_idParaDest-93"><a id="_idTextAnchor095"/>Installing the NiFi Registry</h2>
			<p>To <a id="_idIndexMarker455"/>install the NiFi Registry, go to the website at <a href="https://nifi.apache.org/registry">https://nifi.apache.org/registry</a> and scroll to <strong class="bold">Releases</strong>. The following screenshot shows the available releases:</p>
			<div>
				<div id="_idContainer121" class="IMG---Figure">
					<img src="image/Figure_8.2__B15739.jpg" alt="Figure 8.2 – The NiFi Registry&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.2 – The NiFi Registry</p>
			<p>You will<a id="_idIndexMarker456"/> see a source release and two binaries for the current version, which, at the time of writing, is 0.6.0. On Windows, you can download the zip version, but since I am on Linux, I will download the <strong class="source-inline">nifi-registry-0.6.0-bin.tar.gz</strong> file. </p>
			<p>Once the file is downloaded, move it to your home directory, extract the contents, then delete the archive using the following lines:</p>
			<p class="source-code">mv Downloads/nifi-r* ~/</p>
			<p class="source-code">tar -xvzf nifi-registry-0.6.0-bin.tar.gz</p>
			<p class="source-code">rm nifi-registry-0.6.0-bin.tar.gz</p>
			<p>You will now have a folder named <strong class="source-inline">nifi-registry-0.6.0</strong>. To run the Registry using the default settings (HTTP on port <strong class="source-inline">18080</strong>), from the directory, use the following command:</p>
			<p class="source-code">sudo ./bin/nifi-registry.sh start</p>
			<p>Once you have launched the Registry, browse to it at <strong class="source-inline">http://localhost:18080/</strong>nifi-registry. You should see the following screen:</p>
			<div>
				<div id="_idContainer122" class="IMG---Figure">
					<img src="image/Figure_8.3__B15739.jpg" alt="Figure 8.3 – The NiFi Registry&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.3 – The NiFi Registry</p>
			<p>As you can see, it is blank, and the user is anonymous. You have not changed any defaults or added any authentication, and you have not added any data pipelines yet.</p>
			<p>The NiFi <a id="_idIndexMarker457"/>Registry uses buckets to hold your data pipelines. A bucket is similar to a folder. You can either group similar pipelines, or create a folder for each source, or for destinations, or however you see fit to meet your needs and use cases. The next section will walk you through configuring the NiFi Registry.</p>
			<h2 id="_idParaDest-94"><a id="_idTextAnchor096"/>Configuring the NiFi Registry</h2>
			<p>With the <a id="_idIndexMarker458"/>Registry up and running, you will need to create a folder to hold your data pipelines. To create a folder, click the wrench in the top-right corner of the screen. A popup will appear on the screen. Click the <strong class="bold">NEW BUCKET</strong> button. On the next popup, enter the bucket name, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer123" class="IMG---Figure">
					<img src="image/Figure_8.4__B15739.jpg" alt="Figure 8.4 – Creating a new bucket&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.4 – Creating a new bucket</p>
			<p>Once the<a id="_idIndexMarker459"/> bucket is created, you will see it on the main registry screen. Your registry should now look like the following screenshot:</p>
			<div>
				<div id="_idContainer124" class="IMG---Figure">
					<img src="image/Figure_8.5__B15739.jpg" alt="Figure 8.5 – Registry with the new bucket&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.5 – Registry with the new bucket</p>
			<p>Now that <a id="_idIndexMarker460"/>you have the Registry deployed and a bucket created, you are ready to register it with NiFi and start versioning your data pipelines. The next section will walk you through this.</p>
			<h1 id="_idParaDest-95"><a id="_idTextAnchor097"/>Using the Registry in NiFi</h1>
			<p>The <a id="_idIndexMarker461"/>Registry is up and <a id="_idIndexMarker462"/>running, and now you need to tell NiFi about it so that you can start using it to version your data pipelines. The NiFi GUI will handle all of the configuration and versioning. In the next section, you will add the Registry to NiFi.</p>
			<h2 id="_idParaDest-96"><a id="_idTextAnchor098"/>Adding the Registry to NiFi	</h2>
			<p>To add the <a id="_idIndexMarker463"/>Registry to NiFi, click on the waffle menu in the top-right corner<a id="_idIndexMarker464"/> of the window, then select <strong class="bold">Controller Settings</strong> from the drop-down menu, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer125" class="IMG---Figure">
					<img src="image/Figure_8.6__B15739.jpg" alt="Figure 8.6 – Controller Settings in Nifi&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.6 – Controller Settings in Nifi</p>
			<p>In the <strong class="bold">Controller Settings</strong> popup, there are several tabs. You will select the last tab—<strong class="bold">Registry Clients</strong>. Clicking the plus sign at the top right of the window, you will add your Registry as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer126" class="IMG---Figure">
					<img src="image/Figure_8.7__B15739.jpg" alt="Figure 8.7 – Adding the NiFi Registry to NiFi&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.7 – Adding the NiFi Registry to NiFi</p>
			<p>After <a id="_idIndexMarker465"/>clicking the <strong class="bold">ADD</strong> button, you will have your Registry <a id="_idIndexMarker466"/>connected to NiFi. Close the window and you will be in your main NiFi canvas. You are now ready to version your data pipelines.</p>
			<h1 id="_idParaDest-97"><a id="_idTextAnchor099"/>Versioning your data pipelines</h1>
			<p>You can<a id="_idIndexMarker467"/> use the NiFi Registry to version your data pipelines inside of a processor group. I have NiFi running and the canvas zoomed in to the <strong class="source-inline">SeeClickFix</strong> processor group from <a href="B15739_06_ePub_AM.xhtml#_idTextAnchor073"><em class="italic">Chapter 6</em></a><em class="italic">, Building a 311 Data Pipeline</em>. To start versioning this data pipeline, right-click on the title bar of the processor group and select <strong class="bold">Version</strong> | <strong class="bold">Start version control</strong>, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer127" class="IMG---Figure">
					<img src="image/Figure_8.8__B15739.jpg" alt="Figure 8.8 – Starting version control on a processor group&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.8 – Starting version control on a processor group</p>
			<p>Your processor<a id="_idIndexMarker468"/> group is now being tracked by version control. You will see a green checkmark on the left of the processor group title box, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer128" class="IMG---Figure">
					<img src="image/Figure_8.9__B15739.jpg" alt="Figure 8.9 – Processor group using version control&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.9 – Processor group using version control</p>
			<p>If you browse back to the <a id="_idIndexMarker469"/>NiFi Registry, you will see that <strong class="bold">Scf-DataEngineeringPython</strong> is being tracked. You will also see the details by expanding the bar. The details show your description and the version notes (<strong class="bold">First Commit</strong>), as well as some identifiers. The results are shown in the following screenshot:</p>
			<div>
				<div id="_idContainer129" class="IMG---Figure">
					<img src="image/Figure_8.10__B15739.jpg" alt="Figure 8.10 – Details of the data pipeline in the Registry&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.10 – Details of the data pipeline in the Registry</p>
			<p>You are not tracking a data <a id="_idIndexMarker470"/>pipeline in the Registry. In the next section, you will make changes and update the Registry.</p>
			<h3>Editing a versioned pipeline</h3>
			<p>In a normal<a id="_idIndexMarker471"/> workflow, you would create a processor group and add it to the Registry (in other words, start versioning the processor). You would then make changes, and then commit those changes to the Registry and always make sure you were using the appropriate version.</p>
			<p>Let's make a change to the SeeClickFix data pipeline. Your pipeline is running, and everything is working perfectly. Then your supervisor says that there is a new warehouse that needs to start receiving SeeClickFix data. You don't need to build a new data pipeline; you just need to add the warehouse to your current pipeline. Entering the processor group, I have added a <strong class="source-inline">NewDataWarehouse</strong> processor alongside the original. The changes are highlighted in the following screenshot:</p>
			<div>
				<div id="_idContainer130" class="IMG---Figure">
					<img src="image/Figure_8.11__B15739.jpg" alt="Figure 8.11 – Adding a new data warehouse to the data pipeline&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.11 – Adding a new data warehouse to the data pipeline</p>
			<p>Exit the<a id="_idIndexMarker472"/> processor group back to the main canvas. Looking at the title bar of the processor group, you will see the green checkmark is gone and you have an asterisk. Hovering over it will show you local changes made, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer131" class="IMG---Figure">
					<img src="image/Figure_8.12__B15739.jpg" alt="Figure 8.12 – Local changes have been made inside the processor group&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.12 – Local changes have been made inside the processor group</p>
			<p>After<a id="_idIndexMarker473"/> making any changes, you need to commit those changes, and add them to the Registry. Right-click on the title bar and select <strong class="bold">Version</strong>. Before committing the local changes, let's view the changes. Select <strong class="bold">Show Local Changes</strong>. The following screenshot shows the changes:</p>
			<div>
				<div id="_idContainer132" class="IMG---Figure">
					<img src="image/Figure_8.13__B15739.jpg" alt="Figure 8.13 – Displaying the local changes&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.13 – Displaying the local changes</p>
			<p>As you can<a id="_idIndexMarker474"/> see in the preceding screenshot, a processor and a relationship were added. Now you can select <strong class="bold">Version</strong> | <strong class="bold">Commit Local Changes</strong> to add them to the Registry. You will be prompted to add a description. Once saved, you will now have a green checkmark in the title bar. The NiFi Registry will now show that you have two versions and will show the details of the most recent version.</p>
			<p>With multiple versions, you can now right-click on the title bar and select <strong class="bold">Version</strong> | <strong class="bold">Change Version</strong>. Changing to <strong class="bold">Version 1</strong> will result in an orange circle with an upward arrow in it alerting you that you are not using the most current version. </p>
			<p>With the processor group tracked in version control, you can make changes, roll them back, and commit new changes. If you make a mistake, you can roll back your work and start again. But you can also import a processor that other users may have created in their local development copy of NiFi. The next section will show you how.</p>
			<h3>Importing a processor group from the NiFi Registry</h3>
			<p>Let's imagine that <a id="_idIndexMarker475"/>you and another worker are building data pipelines in your own local copies of NiFi. You both commit your changes to the NiFi Registry, just like software developers do with Git. Now you have been tasked with fixing an issue your coworker is struggling with. How can you use their work? You could have them export a template, and you could import it. This was how things used to be done before the Registry. But now, you will use the Registry.</p>
			<p>Drag a processor group to the NiFi canvas. Notice that underneath the textbox for naming the group, there is now an option to import, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer133" class="IMG---Figure">
					<img src="image/Figure_8.14__B15739.jpg" alt="Figure 8.14 – An Import option is now available for processor groups"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.14 – An Import option is now available for processor groups</p>
			<p>Now that NiFi has access to the NiFi Registry, it has added the option to import processor groups. By clicking <strong class="bold">Import</strong>, you will be able to select a registry, a bucket, and a flow. In the following screenshot, I have selected the <strong class="bold">SCf</strong> flow:</p>
			<div>
				<div id="_idContainer134" class="IMG---Figure">
					<img src="image/Figure_8.15__B15739.jpg" alt="Figure 8.15 – Selecting the flow and version&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.15 – Selecting the flow and version</p>
			<p>After importing the<a id="_idIndexMarker476"/> flow, you can see it is now added to the canvas. In the previous section, I changed the processor group back to <strong class="bold">Version 1</strong>, so you can see that I have that version, with the orange circle and arrow, as well as the imported current version with the green check mark.</p>
			<p>When you bring in a new data engineer, or set up a new NiFi instance, you can import all the production pipelines into the new environment. This guarantees everyone is working from the same source, but also that all changes are tracked and shared between development environments.</p>
			<h1 id="_idParaDest-98"><a id="_idTextAnchor100"/>Using git-persistence with the NiFi Registry</h1>
			<p>Just like <a id="_idIndexMarker477"/>software developers, you can also use Git to <a id="_idIndexMarker478"/>version control your data pipelines. The NiFi Registry allows you to use git-persistence with some configuration. To use Git with your data pipelines, you need to first create a repository.</p>
			<p>Log in to GitHub and create a repository for your data pipelines. I have logged in to my account and have created the repository as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer135" class="IMG---Figure">
					<img src="image/Figure_8.16__B15739.jpg" alt="Figure 8.16 – Creating a GitHub repository&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.16 – Creating a GitHub repository</p>
			<p>After creating <a id="_idIndexMarker479"/>a repository, you will need to create an access<a id="_idIndexMarker480"/> token for the registry to use to read and write to the repository. In the GitHub <strong class="bold">Settings</strong>, go to <strong class="bold">Developer settings</strong>, then <strong class="bold">Personal access tokens</strong>, then click the <strong class="bold">Generate a personal access token</strong> hyperlink shown in the following screenshot:</p>
			<div>
				<div id="_idContainer136" class="IMG---Figure">
					<img src="image/Figure_8.17__B15739.jpg" alt="Figure 8.17 – The setting to create an access token&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.17 – The setting to create an access token</p>
			<p>You can then<a id="_idIndexMarker481"/> add a note for the token so you can <a id="_idIndexMarker482"/>remember what service is using it. Then select the scope access—check the repo heading. The following screenshot shows the settings:</p>
			<div>
				<div id="_idContainer137" class="IMG---Figure">
					<img src="image/Figure_8.18__B15739.jpg" alt="Figure 8.18 – Giving the access token scope&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.18 – Giving the access token scope</p>
			<p>Now, clone the <a id="_idIndexMarker483"/>repository to your local filesystem. You can<a id="_idIndexMarker484"/> get the link from the GitHub repository by clicking the <strong class="bold">Clone or Download</strong> button. Then, run the following command in your terminal to clone it:</p>
			<p class="source-code">git clone https://github.com/PaulCrickard/NifiRegistry.git</p>
			<p>You will see some output and should now have the repository as a folder in the current directory. The output of the command is shown in the following screenshot:</p>
			<div>
				<div id="_idContainer138" class="IMG---Figure">
					<img src="image/Figure_8.19__B15739.jpg" alt="Figure 8.19 – Cloning the GitHub repository&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.19 – Cloning the GitHub repository</p>
			<p>You will need to enter the GitHub information into the NiFi Registry. You can do this in the <strong class="source-inline">providers.xml</strong> file in the <strong class="source-inline">conf</strong> directory. You will edit the file towards the top under the header named <strong class="source-inline">flowPersistenceProvider</strong>. The configuration is shown in the following screenshot:</p>
			<div>
				<div id="_idContainer139" class="IMG---Figure">
					<img src="image/Figure_8.20__B15739.jpg" alt="Figure 8.20 – Adding GitHub information to the Registry in providers.xml&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.20 – Adding GitHub information to the Registry in providers.xml</p>
			<p>After <a id="_idIndexMarker485"/>modifying the <strong class="source-inline">providers.xml</strong> file, you will need to<a id="_idIndexMarker486"/> restart the Registry. You can restart it using the following command:</p>
			<p class="source-code">sudo ./bin/nifi-registry.sh start</p>
			<p>When the Registry restarts, go to your NiFi canvas and add a third data warehouse to the <strong class="source-inline">SeeClickFix</strong> processor group. When you exit the group, you will see that there are local changes that have not been committed—the green checkmark is gone and there is an asterisk. Right-click on the title menu and select <strong class="bold">Version</strong> then <strong class="bold">Commit Local Version</strong>. It will take a little longer this time as the files are being sent to your GitHub repository.</p>
			<p>Looking at the NiFi Registry, you can see that I now have three versions, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer140" class="IMG---Figure">
					<img src="image/Figure_8.21__B15739.jpg" alt="Figure 8.21 – Version 3 is in the Registry&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.21 – Version 3 is in the Registry</p>
			<p>Browsing to<a id="_idIndexMarker487"/> the repository, you will see there is a folder<a id="_idIndexMarker488"/> created for the name of the bucket in the Registry, and then the flow data has been added. The following screenshot shows the contents of the folder:</p>
			<div>
				<div id="_idContainer141" class="IMG---Figure">
					<img src="image/Figure_8.22__B15739.jpg" alt="Figure 8.22 – Registry bucket and flows saved to the GitHub repository&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 8.22 – Registry bucket and flows saved to the GitHub repository</p>
			<p>Now your data <a id="_idIndexMarker489"/>pipelines are using version control<a id="_idIndexMarker490"/> through the NiFi Registry and persisted in Git on your local disk and GitHub online. </p>
			<p>Congratulations, you now have a fully functional NiFi registry and have saved your data pipelines to a Git repository. At some point in your career, you will be asked to run a data pipeline like you did several months ago. Instead of looking through your files and trying to remember what you did way back then, you will now be able to browse to your NiFi Registry and select the proper version of the data pipeline. And if your server crashes and everything is lost? You can now reinstall NiFi and connect it to your Git-repository-backed NiFi Registry to recover all of your hard work.</p>
			<h1 id="_idParaDest-99"><a id="_idTextAnchor101"/>Summary</h1>
			<p>In this chapter, you have learned one of the most important features of production data pipelines: version control. A software developer would not write code without using version control and neither should a data engineer. You have learned how to install and configure the Nifi Registry and how to start tracking version on processor groups. Lastly, you are now able to persist the version to GitHub. Any changes to your data pipelines will be saved and if you need to roll back, you can. As your team grows, all the data engineers will be able to manage the data pipelines and be sure they have the latest versions, all while developing locally.</p>
			<p>In the next chapter, you will learn about logging and monitoring your data pipelines. If something goes wrong, and it will, you will need to know about it. Good logging and monitoring of data pipelines will allow you to catch errors when they happen and debug them to restore your data flows.</p>
		</div>
	</body></html>