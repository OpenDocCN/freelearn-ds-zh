- en: Chapter 4. Spatial Analysis
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第4章. 空间分析
- en: In this chapter, we will start with raster processing and analysis tasks such
    as clipping and terrain analysis. We will cover the essentials of converting between
    raster and vector formats, and then continue with common vector geoprocessing
    tasks such as generating heatmaps and calculating area shares within a region.
    We will finish the chapter with an introduction to automating geoprocessing workflows
    using the QGIS Processing modeler.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将从栅格处理和分析任务开始，例如裁剪和地形分析。我们将介绍栅格和矢量格式之间的转换基本知识，然后继续介绍常见的矢量地理处理任务，例如生成热图和计算区域内面积份额。我们将以介绍使用QGIS处理模型器自动地理处理工作流程结束本章。
- en: Clipping rasters
  id: totrans-2
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 裁剪栅格
- en: 'A common task in raster processing is clipping a raster with a polygon. This
    task is well covered by the Clipper tool located in **Raster** | **Extraction**
    | **Clipper**. This tool supports clipping to a specified extent or clipping using
    a polygon mask layer, as follows:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在栅格处理中，一个常见的任务是使用多边形裁剪栅格。这个任务由位于**栅格** | **提取** | **裁剪器**的Clipper工具很好地处理。此工具支持裁剪到指定范围或使用多边形掩膜层裁剪，如下所示：
- en: The extent can be set manually or by selecting it in the map. To do that, we
    just drag open a rectangle in the map area of the main QGIS window.
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 范围可以手动设置，也可以通过在地图中选择来设置。为此，我们只需在QGIS主窗口的地形区域拖动一个矩形即可。
- en: A mask layer can be any polygon layer that is currently loaded in the project
    or any other polygon layer, which can be specified using **Select…**.
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 掩膜层可以是项目中当前加载的任何多边形图层，或者任何其他多边形图层，可以使用**选择…**指定。
- en: Tip
  id: totrans-6
  prefs:
  - PREF_IND
  - PREF_H3
  type: TYPE_NORMAL
  zh: 小贴士
- en: If we only want to clip a raster to a certain extent (the current map view extent
    or any other), we can also use the raster **Save as ...**, as shown in [Chapter
    3](ch03.html "Chapter 3. Data Creation and Editing"), *Data Creation and Editing*.
  id: totrans-7
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果我们只想将栅格裁剪到一定范围（当前地图视图范围或其他），我们也可以使用栅格**另存为...**，如[第3章](ch03.html "第3章. 数据创建和编辑")中所述的*数据创建和编辑*。
- en: For a quick exercise, we will clip the hillshade raster using the Alaska Shapefile
    (both from our sample data) as a mask layer. At the bottom of the window, we can
    see the concrete **gdalwarp** command that QGIS uses to clip the raster. This
    is very useful if you also want to learn how to use GDAL.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 为了快速练习，我们将使用阿拉斯加Shapefile（均来自我们的样本数据）作为掩膜层来裁剪阴影栅格。在窗口底部，我们可以看到QGIS用于裁剪栅格的**gdalwarp**命令。如果你也想学习如何使用GDAL，这将非常有用。
- en: 'The default **No data value** is **0**, but we can override it if necessary.
    Another good option is to **Create an output alpha band**, which will set all
    areas outside the mask to transparent, as shown in the following screenshot:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 默认的**无数据值**是**0**，但在必要时我们可以覆盖它。另一个好选项是**创建输出alpha波段**，这将设置掩膜外的所有区域为透明，如下面的截图所示：
- en: '![Clipping rasters](img/7488_04_01.jpg)'
  id: totrans-10
  prefs: []
  type: TYPE_IMG
  zh: '![裁剪栅格](img/7488_04_01.jpg)'
- en: 'The resulting layer will be loaded automatically since we enabled the **Load
    into canvas when finished** option. QGIS should also automatically recognize the
    alpha layer we created, and the raster areas that fall outside the Alaska land
    mass should be transparent. If, for some reason, QGIS fails to automatically recognize
    the alpha layer, we can enable it manually using the **Transparency band** option
    in the raster layer properties'' **Transparency** section. This dialog is also
    the right place to specify any **No data value** we want to be used, as shown
    in the following screenshot:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 由于我们启用了**完成时加载到画布**选项，结果图层将自动加载。QGIS还应自动识别我们创建的alpha图层，并且位于阿拉斯加陆地之外的区域应该是透明的。如果由于某种原因，QGIS未能自动识别alpha图层，我们可以通过在栅格图层属性的**透明度**部分使用**透明度波段**选项手动启用它。此对话框也是指定任何我们想要使用的**无数据值**的正确位置，如下面的截图所示：
- en: '![Clipping rasters](img/7488_04_02.jpg)'
  id: totrans-12
  prefs: []
  type: TYPE_IMG
  zh: '![裁剪栅格](img/7488_04_02.jpg)'
- en: Analyzing elevation / terrain data
  id: totrans-13
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 分析高程/地形数据
- en: Raster terrain analysis can be used to calculate the slope, aspect, hillshade,
    ruggedness index, and relief from elevation rasters, as shown in the following
    screenshot. These tools are available through the **Raster** | **Terrain analysis**
    plugin, which comes with QGIS by default, but we have to enable it in the Plugin
    Manager.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 栅格地形分析可用于计算坡度、方位、阴影、崎岖度指数和从高程栅格中提取的起伏，如下面的截图所示。这些工具通过**栅格** | **地形分析**插件提供，该插件是QGIS默认提供的，但我们必须在插件管理器中启用它。
- en: '![Analyzing elevation / terrain data](img/7488_04_03.jpg)'
  id: totrans-15
  prefs: []
  type: TYPE_IMG
  zh: '![分析高程/地形数据](img/7488_04_03.jpg)'
- en: 'The Terrain analysis includes the following tools:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 地形分析包括以下工具：
- en: '**Slope**: This tool calculates the slope angle for each cell in degrees (based
    on the first order derivative estimation)'
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**坡度**：此工具计算每个单元格的坡度角度（基于一阶导数估计），单位为度'
- en: '**Aspect**: This tool calculates the exposition (in degrees counter-clockwise,
    starting with 0 for north)'
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**坡向**：此工具计算坡向（逆时针度数，从北方的 0 度开始）'
- en: '**Hillshade**: This tool creates a basic hillshade raster with lighted areas
    and shadows'
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**阴影图**：此工具创建一个基本的阴影图栅格，包含光照区域和阴影'
- en: '**Relief**: This tool creates a shaded relief map with varying colors for different
    elevation ranges'
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**地形图**：此工具创建一个具有不同高程范围不同颜色的阴影地形图'
- en: '**Ruggedness Index**: This tool calculates the ruggedness index for each cell
    by summarizing the elevation changes within a 3 x 3 cell grid'
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**崎岖度指数**：此工具通过总结 3 x 3 单元格网格内的海拔变化来计算每个单元格的崎岖度指数'
- en: Of course, to use any of these terrain analysis tools, we need an elevation
    raster. If you don't have any at hand, you can simply download a dataset from
    the NASA **Shuttle Radar Topography Mission** (**SRTM**)using [http://dwtkns.com/srtm/](http://dwtkns.com/srtm/)
    or any of the other SRTM download services.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，要使用这些地形分析工具之一，我们需要一个高程栅格。如果您手头没有，您可以从 [http://dwtkns.com/srtm/](http://dwtkns.com/srtm/)
    或其他 SRTM 下载服务中简单地下载一个数据集。
- en: Note
  id: totrans-23
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If you want to replicate the results in the following exercise exactly, please
    get the dataset called `srtm_05_01.zip`, which covers a small part of Alaska.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您想精确复制以下练习的结果，请获取名为 `srtm_05_01.zip` 的数据集，它覆盖了阿拉斯加的一小部分。
- en: 'An important element in all terrain analysis tools is the **Z factor**. The
    z factor is used if the x/y units are different from the z (elevation) unit. For
    example, if we tried to create a relief from elevation data where x/y are in degrees
    and z is in meters, the resulting relief would look grossly exaggerated. The values
    for the z factor are as follows:'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 在所有地形分析工具中，**Z 因子**是一个重要元素。当 x/y 单位与 z（高程）单位不同时，会使用 z 因子。例如，如果我们尝试从 x/y 为度数、z
    为米的高程数据创建地形图，结果的地形图看起来会极度夸张。z 因子的值如下：
- en: If x/y and z are either all in meters or all in feet, use the default z factor
    1.0
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果 x/y 和 z 都在米或英尺中，请使用默认的 z 因子 1.0
- en: If x/y are in degrees and z is in feet, use the z factor 370,400
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果 x/y 在度数中，而 z 在英尺中，请使用 z 因子 370,400
- en: If x/y are in degrees and z is in meters, use the z factor 111,120
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果 x/y 在度数中，而 z 在米中，请使用 z 因子 111,120
- en: Since the SRTM rasters are provided in WGS84 EPSG:4326, we need to use a **Z
    factor** of `111120` in our exercise. Let's create a relief! The tool can calculate
    relief color ranges automatically; we just need to click on **Create automatically**,
    as shown in the following screenshot. Of course, we can still edit the elevation
    ranges' upper and lower bounds, as well as the colors.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 由于 SRTM 栅格数据提供的是 WGS84 EPSG:4326，我们在练习中需要使用 **Z 因子** 111120。让我们创建一个地形图！该工具可以自动计算地形颜色范围；我们只需点击
    **自动创建**，如图下所示。当然，我们仍然可以编辑高程范围的上下限以及颜色。
- en: '![Analyzing elevation / terrain data](img/7488_04_04.jpg)'
  id: totrans-30
  prefs: []
  type: TYPE_IMG
  zh: '![分析高程/地形数据](img/7488_04_04.jpg)'
- en: 'While relief maps are three-banded rasters, which are primarily used for visualization
    purposes, slope rasters are a common intermediate step in spatial analysis workflows.
    We will now create a slope raster, which we can use in our example workflow through
    the following sections. The resulting slope raster will be loaded in grayscale
    automatically, as shown in the following screenshot:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然地形图是三色栅格，主要用于可视化目的，但坡度栅格是空间分析工作流程中的常见中间步骤。我们现在将创建一个坡度栅格，我们可以在以下章节的示例工作流程中使用它。生成的坡度栅格将自动以灰度形式加载，如图下所示：
- en: '![Analyzing elevation / terrain data](img/7488_04_05.jpg)'
  id: totrans-32
  prefs: []
  type: TYPE_IMG
  zh: '![分析高程/地形数据](img/7488_04_05.jpg)'
- en: Raster calculator
  id: totrans-33
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 栅格计算器
- en: By going to **Raster** | **Raster Calculator**, we can create a new raster layer
    based on values in one or more rasters that are loaded in the current QGIS project.
    All available raster bands are presented in a list in the top-left corner of the
    dialog in the form `raster_name@band_number` as shown in the following screenshot.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 通过访问 **栅格** | **栅格计算器**，我们可以根据当前 QGIS 项目中加载的一个或多个栅格中的值创建一个新的栅格图层。所有可用的栅格波段以列表形式显示在对话框的左上角，形式为
    `raster_name@band_number`，如图下所示。
- en: 'Continuing from our previous exercise in which we created a slope raster, we
    can, for example, find areas at elevations above 1,000 meters and with a slope
    of less than 5 degrees using the following expression (you might have to adjust
    the values depending on the dataset you are using):'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们之前的练习中，我们创建了一个坡度栅格，我们可以使用以下表达式找到海拔超过1,000米且坡度小于5度的区域（你可能需要根据你使用的数据集调整值）：
- en: '[PRE0]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: Cells that meet both criteria of high elevation and evenness will be assigned
    a value of 1 in the resulting raster, while cells that fail to meet a criterion
    will be set to 0\. The only bigger areas with a value of 1 are found in the southern
    part of the raster layer.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 满足高海拔和均匀性两个条件的单元格将在结果栅格中被赋予值1，而未满足条件的单元格将被设置为0。只有南部较大的区域具有值1。
- en: '![Raster calculator](img/7488_04_06.jpg)'
  id: totrans-38
  prefs: []
  type: TYPE_IMG
  zh: '![栅格计算器](img/7488_04_06.jpg)'
- en: 'Another typical use case is reclassifying a raster. For example, we could want
    to reclassify the landcover raster in our sample data so that all areas with a
    landcover class from 1 to 5 get the value 100, areas from 6 to 10 get 101, and
    areas over 11 get a new value of 102\. We will use the following code for this:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个典型用例是对栅格进行重新分类。例如，我们可能希望将样本数据中的土地覆盖栅格重新分类，使得所有土地覆盖类别从1到5的区域得到值100，从6到10的区域得到值101，而超过11的区域得到新的值102。我们将使用以下代码来完成这项工作：
- en: '[PRE1]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: The preceding raster calculator expression has three parts, consisting of a
    check and a multiplication. For each cell, only one of the three checks can be
    true, and true is represented as 1\. Therefore, if a landcover cell has a value
    of 4, the first check will be true and the expression evaluates to `1*100 + 0*101
    + 0*102 = 100`.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 之前的栅格计算器表达式由三部分组成，包括一个检查和一个乘法。对于每个单元格，只有三个检查中的一个可以是真实的，真实用1表示。因此，如果一个土地覆盖单元格的值为4，第一个检查将是真实的，表达式计算为`1*100
    + 0*101 + 0*102 = 100`。
- en: Converting between rasters and vectors
  id: totrans-42
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在栅格和矢量之间转换
- en: Tools for converting between raster and vector formats are available in **Raster**
    | **Conversion** and are called Rasterize and Polygonize. Like the raster clipper
    tool we used before, this tool is also based on GDAL and displays the command
    at the bottom of the dialog.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 在**栅格** | **转换**中提供了在栅格和矢量格式之间转换的工具，它们被称为**栅格化**和**多边形化**。与之前使用的栅格裁剪工具类似，这个工具也是基于GDAL，并在对话框底部显示命令。
- en: 'Polygonize converts a raster into a polygon layer; depending on the size of
    the raster, the conversion can take some time. When the process is finished, QGIS
    will notify us with a pop up. For a quick test, we can, for example, convert the
    reclassified landcover raster to polygons. The resulting vector polygon layer
    contains multiple polygon features with a single attribute we called `lc`, which
    depends on the original raster value, as shown in the following screenshot:'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: '**多边形化**将栅格转换为多边形图层；根据栅格的大小，转换可能需要一些时间。当过程完成后，QGIS将通过弹出窗口通知我们。例如，为了快速测试，我们可以将重新分类的土地覆盖栅格转换为多边形。结果矢量多边形图层包含多个具有单个属性`lc`的多边形要素，该属性取决于原始栅格值，如下面的屏幕截图所示：'
- en: '![Converting between rasters and vectors](img/7488_04_07.jpg)'
  id: totrans-45
  prefs: []
  type: TYPE_IMG
  zh: '![在栅格和矢量之间转换](img/7488_04_07.jpg)'
- en: 'The Rasterize tool is very similar to the Polygonize tool. The only difference
    is that we get to specify the size of the resulting raster in pixels/cells. We
    can also specify the attribute field, which will provide input for the raster
    cell value. The **cat** attribute of our `alaska.shp` dataset is rather meaningless,
    but you get the idea of how the tool works, as shown in the following screenshot:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: '**栅格化**工具与**多边形化**工具非常相似。唯一的区别是我们可以指定结果栅格的像素/单元格大小。我们还可以指定属性字段，这将提供输入给栅格单元格值。我们`alaska.shp`数据集的**cat**属性相当没有意义，但你可以从下面的屏幕截图中了解工具的工作原理：'
- en: '![Converting between rasters and vectors](img/7488_04_08.jpg)'
  id: totrans-47
  prefs: []
  type: TYPE_IMG
  zh: '![在栅格和矢量之间转换](img/7488_04_08.jpg)'
- en: Accessing raster and vector layer statistics
  id: totrans-48
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 访问栅格和矢量图层统计信息
- en: 'Whenever we get a new dataset, it is useful to examine the layer statistics
    to get a feeling for the data. Raster layer statistics are readily available in
    the **Layer Properties** dialog, specifically in the following tabs:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 每当我们得到一个新的数据集时，检查图层统计信息以了解数据的感觉是有用的。栅格图层统计信息在**图层属性**对话框中很容易获得，特别是在以下标签页中：
- en: '**Metadata** shows the minimum and maximum cell value as well as the mean and
    the standard deviation'
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**元数据**显示了最小和最大单元格值以及平均值和标准差'
- en: '**Histogram** presents the distribution of raster values'
  id: totrans-51
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**直方图**展示了栅格值的分布'
- en: 'For vector layers, we can get summary statistics using two tools in **Vector**
    | **Analysis Tools**:'
  id: totrans-52
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 对于矢量图层，我们可以使用**矢量** | **分析工具**中的两个工具来获取摘要统计信息：
- en: '**Basics statistics** is very useful for numeric fields. It calculates parameters
    such as mean and median, min and max, the feature count *n* and the number of
    unique values, and so on for all the features of a layer or for the selected features
    only.'
  id: totrans-53
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**基本统计**对于数值字段非常有用。它计算诸如平均值和中位数、最小值和最大值、特征计数 *n* 以及唯一值的数量等参数，对于图层上的所有特征或仅对于选定的特征。'
- en: '**List unique values** is useful to get all the unique values of a certain
    field.'
  id: totrans-54
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**列出唯一值**有助于获取某个字段的全部唯一值。'
- en: 'In both the tools, we can easily copy the results using *Ctrl* + *C* and paste
    them into a text file or spreadsheet. The following screenshots show examples
    exploring the contents of our airport sample dataset:'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 在这两个工具中，我们可以轻松地使用 *Ctrl* + *C* 复制结果，并将它们粘贴到文本文件或电子表格中。以下屏幕截图展示了探索我们机场样本数据集内容的示例：
- en: '![Accessing raster and vector layer statistics](img/7488_04_09.jpg)'
  id: totrans-56
  prefs: []
  type: TYPE_IMG
  zh: '![访问栅格和矢量图层统计信息](img/7488_04_09.jpg)'
- en: Creating a heatmap from points
  id: totrans-57
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 从点创建热力图
- en: 'Heatmaps are great for visualizing the distribution of points. To create them,
    QGIS provides a simple to use **Heatmap Plugin** , which we have to activate in
    **Plugin Manager** , and then we can access it by going to **Raster** | **Heatmap**
    | **Heatmap**. The plugin offers different kernel shapes to choose from and allows
    us to control the raster size in cells as well as the cell size. The **Heatmap
    Plugin** looks like the following screenshot:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 热力图非常适合可视化点的分布。要创建它们，QGIS提供了一个简单易用的**热力图插件**，我们需在**插件管理器**中激活它，然后可以通过访问**栅格**
    | **热力图** | **热力图**来使用它。该插件提供了不同的核形状供选择，并允许我们控制栅格大小（以单元格为单位）以及单元格大小。**热力图插件**的外观如下所示：
- en: '![Creating a heatmap from points](img/7488_04_10.jpg)'
  id: totrans-59
  prefs: []
  type: TYPE_IMG
  zh: '![从点创建热力图](img/7488_04_10.jpg)'
- en: Vector geoprocessing with Processing
  id: totrans-60
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用Processing进行矢量地理处理
- en: The most comprehensive set of spatial analysis tools is accessible via the Processing
    plugin, which we can also enable in **Plugin Manager**. When the plugin is enabled,
    we find an **Analysis** menu where we can activate the toolbox, as shown in the
    following screenshot. In the toolbox, it is easy to find spatial analysis tools
    by their name thanks to the dynamic search box at the top. This makes finding
    tools in the toolbox easier than in the vector or raster menu. Another advantage
    of getting accustomed to the Processing tools is that they can be automated in
    Python and in geoprocessing models.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 最全面的空間分析工具集可通过Processing插件访问，我们也可以在**插件管理器**中启用它。当插件启用时，我们会发现一个**分析**菜单，其中我们可以激活工具箱，如下面的屏幕截图所示。在工具箱中，由于顶部动态搜索框的存在，很容易通过名称找到空间分析工具。这使得在工具箱中查找工具比在矢量或栅格菜单中更容易。习惯于Processing工具的另一个优点是，它们可以用Python和地理处理模型自动化。
- en: '![Vector geoprocessing with Processing](img/7488_04_11.jpg)'
  id: totrans-62
  prefs: []
  type: TYPE_IMG
  zh: '![使用Processing进行矢量地理处理](img/7488_04_11.jpg)'
- en: Note that the preceding screenshot shows the advanced interface of the toolbox.
    You can switch from the simplified interface to the advanced interface using the
    drop-down button at the bottom of the toolbox. I prefer using the advanced version
    as it exposes all available algorithms and clearly displays how individual tools
    are related to the different components such as GDAL/OGR or GRASS.
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，前面的屏幕截图显示了工具箱的高级界面。您可以使用工具箱底部的下拉按钮从简化界面切换到高级界面。我更喜欢使用高级版本，因为它显示了所有可用的算法，并清楚地显示了各个工具如何与不同的组件（如GDAL/OGR或GRASS）相关联。
- en: In the following sections, we will cover a selection of the available geoprocessing
    tools and see how we can use the modeler to automate our tasks.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下章节中，我们将介绍一些可用的地理处理工具，并查看我们如何使用模型器来自动化我们的任务。
- en: Identifying features in the proximity of others
  id: totrans-65
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 识别其他特征附近的特征
- en: 'One common spatial analysis task is to identify features in the proximity of
    certain other features. One example would be to find all the airports near rivers.
    Using `airports.shp` and `majrivers.shp` from our sample data, we can find airports
    within 5,000 feet of a river using a combination of the **Fixed distance buffer**
    and **Select by location** tools, as shown in the following screenshot:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 一个常见的空间分析任务是识别某些其他特征附近的特征。一个例子就是找到所有靠近河流的机场。使用我们样本数据中的`airports.shp`和`majrivers.shp`，我们可以使用**固定距离缓冲区**和**按位置选择**工具的组合，在距离河流5,000英尺内的机场进行查找，如下面的屏幕截图所示：
- en: '![Identifying features in the proximity of others](img/7488_04_12.jpg)'
  id: totrans-67
  prefs: []
  type: TYPE_IMG
  zh: '![识别他人附近的特征](img/7488_04_12.jpg)'
- en: 'After buffering the airport point locations, the **Select by location** option
    selects all the airport buffers that intersect a river. As a result, 14 out of
    the 76 airports are selected. This information is displayed in the information
    area at the bottom of the QGIS main window as shown in the following screenshot:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 在缓冲机场点位置后，**按位置选择**选项选择与河流相交的所有机场缓冲区。结果，76个机场中有14个被选中。此信息显示在QGIS主窗口底部的信息区域中，如下面的截图所示：
- en: '![Identifying features in the proximity of others](img/7488_04_13.jpg)'
  id: totrans-69
  prefs: []
  type: TYPE_IMG
  zh: '![识别他人附近的特征](img/7488_04_13.jpg)'
- en: Tip
  id: totrans-70
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 小贴士
- en: 'If you ever forget which settings you used or need to check that you used the
    correct input layer, you can go to **Analysis** | **history and log**. The **ALGORITHM**
    section lists all the algorithms we have been running as well as the used settings.
    This is also the right place to look for error messages in the **WARNING** section,
    as shown in the following screenshot:'
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你忘记了曾经使用的设置，或者需要检查是否使用了正确的输入图层，你可以转到**分析** | **历史和日志**。**算法**部分列出了我们运行的所有算法以及使用的设置。这也是查找**警告**部分错误消息的正确地方，如下面的截图所示：
- en: '![Identifying features in the proximity of others](img/7488_04_14.jpg)'
  id: totrans-72
  prefs: []
  type: TYPE_IMG
  zh: '![识别他人附近的特征](img/7488_04_14.jpg)'
- en: 'The commands listed under **ALGORITHM** can also be used to call Processing
    tools from the QGIS Python console by going to **Plugins** **|** **Python Console**.
    The Python commands shown in the following screenshot run the buffer algorithm
    and load the result into the map:'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: '**算法**下列出的命令也可以通过转到**插件** **|** **Python控制台**从QGIS Python控制台调用Processing工具。以下截图所示的Python命令运行了缓冲区算法并将结果加载到地图中：'
- en: '![Identifying features in the proximity of others](img/7488_04_15.jpg)'
  id: totrans-74
  prefs: []
  type: TYPE_IMG
  zh: '![识别他人附近的特征](img/7488_04_15.jpg)'
- en: Raster sampling at point locations
  id: totrans-75
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在点位置进行栅格采样
- en: 'Another common task is to sample a raster at specific point locations. Using
    Processing, we can solve this problem using a GRASS tool called v.sample. To use
    GRASS tools, make sure GRASS is installed and Processing is configured correctly
    in **Analysis** | **options and configuration**. On an OSGeo4W default system,
    the configuration will look like the following screenshot:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个常见任务是在特定点位置采样栅格。使用Processing，我们可以通过一个名为v.sample的GRASS工具来解决这个问题。要使用GRASS工具，请确保GRASS已安装，并且Processing在**分析**
    | **选项和配置**中配置正确。在OSGeo4W默认系统上，配置将类似于以下截图：
- en: '![Raster sampling at point locations](img/7488_04_16.jpg)'
  id: totrans-77
  prefs: []
  type: TYPE_IMG
  zh: '![在点位置进行栅格采样](img/7488_04_16.jpg)'
- en: For this exercise, let's imagine we want to sample the landcover layer at the
    airport locations of our sample data. All we have to do is specify the vector
    layer containing the sample points and the raster layer that should be sampled.
    For this example, we can leave all other settings to their defaults. The tool
    will not only sample the raster, it also compares point attributes with the sampled
    raster value, but we don't need this comparison in our current example.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这个练习，让我们假设我们想要在我们的样本数据中采样机场位置的覆盖层。我们只需指定包含样本点的矢量图层和应采样的栅格图层。在这个例子中，我们可以将所有其他设置保留为默认值。该工具不仅会采样栅格，还会比较点属性与采样栅格值，但我们在当前示例中不需要这种比较。
- en: 'The dialog will look like the following screenshot:'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 对话框将类似于以下截图：
- en: '![Raster sampling at point locations](img/7488_04_17.jpg)'
  id: totrans-80
  prefs: []
  type: TYPE_IMG
  zh: '![在点位置进行栅格采样](img/7488_04_17.jpg)'
- en: Mapping density with hexagonal grids
  id: totrans-81
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用六边形网格映射密度
- en: 'Mapping the density of points using a hexagonal grid has become a quite popular
    alternative to creating heatmaps. Processing offers us a fast way to create such
    an analysis. There is already a pre-made script called **Hex grid from layer bounds**,
    which we can use to first create a hexagonal grid that covers all points in the
    input layer. The dataset of populated places, `popp.shp`, is a good sample dataset
    for this exercise. Once the grid is ready, we can run **Count points in polygon**
    to calculate the statistics. In case you cannot see the resulting layer, go to
    the **Layer Properties** | **General** tab and make sure the **CRS** field is
    set to **NAD 27 / Alaska Albers**. The tools dialog will look like the following
    screenshot:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 使用六边形网格映射点密度已成为创建热图的一种相当流行的替代方法。处理功能为我们提供了快速创建此类分析的方法。已经有一个预先制作的脚本称为**从图层边界创建六边形网格**，我们可以使用它首先创建一个覆盖输入图层中所有点的六边形网格。人口地点数据集`popp.shp`是本练习的一个很好的示例数据集。一旦网格准备就绪，我们可以运行**在多边形中计数点**来计算统计数据。如果你看不到结果图层，请转到**图层属性**
    | **常规**选项卡，并确保**CRS**字段设置为**NAD 27 / 阿拉斯加阿尔伯斯**。工具对话框将类似于以下截图：
- en: '![Mapping density with hexagonal grids](img/7488_04_18.jpg)'
  id: totrans-83
  prefs: []
  type: TYPE_IMG
  zh: '![使用六边形网格映射密度](img/7488_04_18.jpg)'
- en: Calculating area shares within a region
  id: totrans-84
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 在区域内计算面积份额
- en: Another spatial analysis task we often encounter is calculating area shares
    within a certain region, for example, landcover shares along one specific river.
    Using `majrivers.shp` and `trees.shp`, we can calculate the share of wooded area
    in a 5,000 feet strip of land along the `Susitna River` value parameter. We first
    define the analysis region by selecting the river and buffering it. Note that
    the **Dissolve result** option should be set to **Yes** to ensure that the buffer
    result is one continuous polygon, as shown in the following screenshot.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个我们经常遇到的空间分析任务是计算一定区域内的面积份额，例如，沿特定河流的植被份额。使用`majrivers.shp`和`trees.shp`，我们可以计算沿`Susitna河`的5,000英尺土地带中林地份额。我们首先通过选择河流并对其进行缓冲来定义分析区域。请注意，**溶解结果**选项应设置为**是**，以确保缓冲结果是一个连续的多边形，如图所示。
- en: Note
  id: totrans-86
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: QGIS Processing will only apply buffers to the selected features of the input
    layer. This default behavior can be changed in **Analysis** | **options and configuration**
    by disabling the **Use only selected features** option.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: QGIS处理功能只会将缓冲区应用于输入图层中选定的要素。这种默认行为可以在**分析** | **选项和配置**中通过禁用**仅使用选定要素**选项来更改。
- en: '![Calculating area shares within a region](img/7488_04_19.jpg)'
  id: totrans-88
  prefs: []
  type: TYPE_IMG
  zh: '![在区域内计算面积份额](img/7488_04_19.jpg)'
- en: 'Next, we calculate the size of the strip of land around our river. This can
    be done using the **Export/Add geometry columns** tool, which adds the area and
    parameter to the attribute table. Then we can calculate the **Intersection** field
    between the area along the river and the wooded areas in `trees.shp`, as shown
    in the following screenshot:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们计算河流周围土地带的大小。这可以使用**导出/添加几何列**工具来完成，该工具将面积和参数添加到属性表中。然后我们可以计算河流沿线区域与`trees.shp`中的林地之间的**交集**字段，如图所示：
- en: '![Calculating area shares within a region](img/7488_04_20.jpg)'
  id: totrans-90
  prefs: []
  type: TYPE_IMG
  zh: '![在区域内计算面积份额](img/7488_04_20.jpg)'
- en: 'Using the **Dissolve** tool, we can recombine all areas from the intersection
    results into one big polygon representing the total wooded area around the river.
    Finally, we can calculate the final share of wooded area using **Advanced Python
    field calculator**. The formula `value = $geom.area()/<area>` divides the area
    of the final polygon (`$geom.area()`) by the value in the "area" attribute (`<area>`),
    which we created in a previous step by running **Export/Add geometry columns**.
    The tools will appear as shown in the following screenshot:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 使用**溶解**工具，我们可以将交集中所有区域重新组合成一个大的多边形，代表河流周围的总体林地面积。最后，我们可以使用**高级Python字段计算器**来计算林地面积的最后份额。公式`value
    = $geom.area()/<area>`将最终多边形的面积(`$geom.area()`)除以“面积”属性中的值(`<area>`)，这是我们通过运行**导出/添加几何列**在之前步骤中创建的。工具将显示如下截图：
- en: '![Calculating area shares within a region](img/7488_04_21.jpg)'
  id: totrans-92
  prefs: []
  type: TYPE_IMG
  zh: '![在区域内计算面积份额](img/7488_04_21.jpg)'
- en: This calculation results in a wood share of 0.31601 for **Deciduous** and 0.09666
    for **Mixed** trees. Therefore, we can conclude that in total, 41.27 percent of
    the land along `Susitna River` is wooded.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 此计算结果为**落叶**树木的木材份额为0.31601，**混合**树木为0.09666。因此，我们可以得出结论，在`Susitna河`沿岸，总共41.27%的土地是林地。
- en: Automated geoprocessing with the graphical modeler
  id: totrans-94
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用图形模型器进行自动地理处理
- en: Using the graphical modeler, we can turn whole geoprocessing and analysis workflows
    into automated models. To create a model, we go to **Analysis** | **Graphical
    modeler** to open the modeler where we can select from different **Inputs** and
    **Algorithms** for our model.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 使用图形模型器，我们可以将整个地理处理和分析工作流程转换为自动化模型。要创建模型，我们转到**分析** | **图形模型器**以打开模型器，在那里我们可以为我们的模型选择不同的**输入**和**算法**。
- en: 'Let''s create a model that automates the creation of hexagonal heatmaps! By
    double-clicking on the **Vector layer** entry in the **Inputs** list, we can add
    an input field for the point layer. It''s a good idea to use descriptive parameter
    names so we can recognize which input is first and which is later in the model.
    It is also useful to restrict the **Shape type** field where appropriate. In our
    example, we restrict the input to **Point**. This will enable Processing to prefilter
    the available layers and present us only with layers of the correct type. The
    second input we need is a **Number** field to specify the desired hexagonal cell
    size. The tool will look like the following screenshot:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们创建一个自动化创建六边形热图的模型！通过双击**输入**列表中的**矢量图层**条目，我们可以为点图层添加一个输入字段。使用描述性参数名称是一个好主意，这样我们就可以识别模型中哪个输入是第一个，哪个是后来的。在适当的情况下，限制**形状类型**字段也是有用的。在我们的示例中，我们将输入限制为**点**。这将使处理能够预先过滤可用的图层，并只向我们展示正确类型的图层。我们需要第二个输入是一个**数字**字段，用于指定所需的六边形单元格大小。工具将类似于以下截图：
- en: '![Automated geoprocessing with the graphical modeler](img/7488_04_22.jpg)'
  id: totrans-97
  prefs: []
  type: TYPE_IMG
  zh: '![使用图形模型器进行自动化地理处理](img/7488_04_22.jpg)'
- en: After adding the inputs, we can now continue creating the model by assembling
    the algorithms. In the **Algorithms** section, we can use the filter at the top
    to narrow down our search for the correct algorithm. To add an algorithm to the
    model, we simply double-click on the entry in the list of algorithms. This opens
    the algorithm dialog where we have to specify the inputs and further algorithm-specific
    parameters.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 添加输入后，我们现在可以继续创建模型，通过组装算法。在**算法**部分，我们可以使用顶部的过滤器来缩小我们对正确算法的搜索范围。要将算法添加到模型中，我们只需双击算法列表中的条目。这会打开算法对话框，在那里我们必须指定输入和进一步的算法特定参数。
- en: In our example, we want to use the point vector layer as the **input** layer,
    and the number input **hex cell size** as the **cellsize** parameter. We can access
    the available inputs through the drop-down list. Alternatively, it's also possible
    to hardcode parameters such as the cell size.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们的示例中，我们希望使用点矢量图层作为**输入**图层，并将数字输入**六边形单元格大小**作为**单元格大小**参数。我们可以通过下拉列表访问可用的输入。或者，也可以硬编码参数，如单元格大小。
- en: '![Automated geoprocessing with the graphical modeler](img/7488_04_23.jpg)'
  id: totrans-100
  prefs: []
  type: TYPE_IMG
  zh: '![使用图形模型器进行自动化地理处理](img/7488_04_23.jpg)'
- en: 'While adding the following algorithms, it is important to always choose the
    correct **input** layer based on the previous processing step. We can verify the
    correct workflow using the arrow connections in the model diagram that the **modeler**
    draws automatically. The tool will look like the following screenshot:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 在添加以下算法时，根据前面的处理步骤始终选择正确的**输入**图层非常重要。我们可以使用模型器自动绘制的模型图中的箭头连接来验证正确的流程。工具将类似于以下截图：
- en: '![Automated geoprocessing with the graphical modeler](img/7488_04_24.jpg)'
  id: totrans-102
  prefs: []
  type: TYPE_IMG
  zh: '![使用图形模型器进行自动化地理处理](img/7488_04_24.jpg)'
- en: To finish the model, we should enter a model name (for example, `Create hexagonal
    heatmap`) and a group name (for example, `my models`). Processing will use the
    group name to organize all the models we create. Once we have picked a name and
    group, we can save the model and then run it. After closing the modeler, we can
    run the saved models from the toolbox like any other tool. It is even possible
    to use one model as a building block in another model.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 要完成模型，我们应该输入一个模型名称（例如，`创建六边形热图`）和一个组名称（例如，`我的模型`）。处理过程将使用组名称来组织我们创建的所有模型。一旦我们选择了名称和组，我们就可以保存模型并运行它。关闭模型器后，我们可以像使用任何其他工具一样从工具箱中运行保存的模型。甚至可以将一个模型作为另一个模型的构建块使用。
- en: 'Another useful feature is that we can specify a layer style, which should be
    applied to the processing results automatically. This default style can be set
    using **Edit rendering styles for outputs** in the context menu of the created
    model in the toolbox, as shown in the following screenshot:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 另一个有用的功能是，我们可以指定一个图层样式，该样式将自动应用于处理结果。此默认样式可以通过在工具箱中创建的模型的上下文菜单中的**编辑输出渲染样式**来设置，如下面的截图所示：
- en: '![Automated geoprocessing with the graphical modeler](img/7488_04_25.jpg)'
  id: totrans-105
  prefs: []
  type: TYPE_IMG
  zh: '![使用图形模型器进行自动化地理处理](img/7488_04_25.jpg)'
- en: Summary
  id: totrans-106
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: In this chapter, we covered various raster and vector geoprocessing and analysis
    tools and how to apply them in common tasks. We saw how to use the Processing
    toolbox to run individual tools as well as the modeler to create complex geoprocessing
    models from multiple tools. Using the modeler, we can automate our workflows and
    increase our productivity, especially with respect to reoccurring tasks.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们介绍了各种栅格和矢量地理处理和分析工具，以及如何将它们应用于常见任务。我们看到了如何使用处理工具箱运行单个工具，以及如何使用模型器从多个工具创建复杂的地理处理模型。使用模型器，我们可以自动化我们的工作流程并提高我们的生产力，尤其是在处理重复性任务方面。
- en: In the following chapter, we will learn how to bring all our knowledge together
    to create beautiful maps using advanced styles and map compositioning features.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将学习如何将所有知识结合起来，使用高级样式和地图组合功能创建美丽的地图。
