<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Finding and Fixing Broken Data Links</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Finding broken data sources in your map document and layer files</li><li class="listitem" style="list-style-type: disc">Fixing broken data sources with MapDocument.findAndReplaceWorkspacePaths()</li><li class="listitem" style="list-style-type: disc">Fixing broken data sources with MapDocument.replaceWorkspaces()</li><li class="listitem" style="list-style-type: disc">Fixing individual layer and table objects with replaceDataSource()</li><li class="listitem" style="list-style-type: disc">Finding broken data sources in all map documents in a folder</li></ul></div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec25"/>Introduction</h1></div></div></div><p>It is not uncommon for your GIS data sources to move, migrate to a new data format, or be deleted. The result can be broken data sources in many map documents or layer files. These broken data sources can't be used until they're fixed, which can be an overwhelming process if the same changes need to be made across numerous map documents. You can automate the process of finding and fixing these data sources using <code class="literal">arcpy.mapping</code>, without ever having to open the affected map documents. Finding broken data sources is a simple process requiring the use of the <code class="literal">ListBrokenDataSources()</code> function, which<a id="id158" class="indexterm"/> returns a Python list of all broken data sources in a map document or layer file. Typically, this function is used as the first step in a script that iterates through the list and fixes the data source. Fixing broken data sources can be made in an individual data layer or across all layers in a common workspace.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec26"/>Finding broken data sources in your map document and layer files</h1></div></div></div><p>Broken data sources are a very common problem with map document files. You can use <code class="literal">arcpy.mapping</code> to identify data sources that have moved, been deleted, or changed in their format.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec61"/>Getting ready</h2></div></div></div><p>In ArcMap, a broken data <a id="id159" class="indexterm"/>connection is signified by a red exclamation point just before the layer name. This is illustrated in the following screenshot. The <code class="literal">ListBrokenDataSources()</code> function in <code class="literal">arcpy.mapping</code> <a id="id160" class="indexterm"/>returns a list of layer objects from a map document or layer file that have a broken data connection:</p><div><img src="img/B04314_03_1.jpg" alt="Getting ready"/></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec62"/>How to do it…</h2></div></div></div><p>Follow these steps to learn how to find broken data sources in a map document file.</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">C:\ArcpyBook\Ch3\Crime_BrokenDataLinks.mxd</code> in ArcMap.<p>You will see that each of the data sources have been broken. In this case, the data has been moved to another folder, but you'd see the same indicator if the data had been deleted or migrated to a different format. For example, it is not uncommon to convert data from a personal geodatabase to a file geodatabase:</p><div><img src="img/B04314_03_2.jpg" alt="How to do it…"/></div></li><li class="listitem">Close ArcMap.</li><li class="listitem">Open<a id="id161" class="indexterm"/> <strong>IDLE</strong> and create a new script window.</li><li class="listitem">Import the<a id="id162" class="indexterm"/> <code class="literal">arcpy.mapping</code> module:<div><pre class="programlisting">import arcpy.mapping as mapping</pre></div></li><li class="listitem">Reference the <code class="literal">Crime_BrokenDataLinks.mxd</code> map document file:<div><pre class="programlisting">mxd = mapping.MapDocument(r"c:\ArcpyBook\Ch3\Crime_BrokenDataLinks.mxd")</pre></div></li><li class="listitem">Get a list of the broken data sources:<div><pre class="programlisting">listBrokenDS = mapping.ListBrokenDataSources(mxd)</pre></div></li><li class="listitem">Iterate the list and print out the layer names:<div><pre class="programlisting">for layer in listBrokenDS:
     print(layer.name)</pre></div><p>The output will be printed as follows:</p><div><pre class="programlisting">District_Crime_Join
Bexar_County_Boundary
District_Crime_Join
Bexar_County_Boundary
Bexar_County_Boundary
Texas_Counties_LowRes
School_Districts
Crime_surf
Bexar_County_Boundary
Crime2009Table</pre></div></li><li class="listitem">Save your script as <code class="literal">FindFixBrokenData.py</code> in the <code class="literal">c:\ArcpyBook\Ch3</code> folder.</li><li class="listitem">You can check your work by examining the <code class="literal">c:\ArcpyBook\code\Ch3\FindFixBrokenData.py</code> solution file.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec63"/>How it works…</h2></div></div></div><p>The <code class="literal">ListBrokenDataSources()</code> function returns a Python list of <code class="literal">Layer</code> objects that have a broken data source. We then use a <code class="literal">for</code> loop to iterate this list and perform some sort of action <a id="id163" class="indexterm"/>for each layer. In this case, we printed out the layer names simply to illustrate the data returned by this function. In a<a id="id164" class="indexterm"/> later recipe, we'll build on this code by fixing these broken data sources.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec64"/>There's more…</h2></div></div></div><p>In addition to returning a list of broken data sources from a map document file, the <code class="literal">ListBrokenDataSources()</code> function can also find broken data sources in a (<code class="literal">.lyr</code>) layer file. Simply pass the <a id="id165" class="indexterm"/>path to the layer file to have the function examine the file for broken data sources. Keep in mind that these functions are not needed with <code class="literal">Map</code> or <code class="literal">Layer</code> packages, since the data is bundled with these files unlike a layer file.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec27"/>Fixing broken data sources with MapDocument.findAndReplaceWorkspacePaths()</h1></div></div></div><p>The <code class="literal">MapDocument.findAndReplaceWorkspacePaths()</code> method is used to perform global find and replace workspace paths for all the layers and tables in a map document. You can also replace the<a id="id166" class="indexterm"/> paths to multiple workspace types at once. For example, you might pass<a id="id167" class="indexterm"/> personal and file geodatabase workspace types at the same time.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec65"/>Getting ready</h2></div></div></div><p>We need to cover some definitions before examining the methods used to fix datasets. You'll see these terms used frequently when discussing the methods used to fix broken data sources, so you'll need to understand what they mean in this context. A<a id="id168" class="indexterm"/> <strong>workspace</strong> is simply a container for data. This can be a folder (in the case of shapefiles), personal geodatabase, file geodatabase, or an ArcSDE connection. A workspace provides the system path to the workspace. In the case of file geodatabases, this would include the name of the geodatabase. A <strong>dataset</strong> is simply a feature class or table within a workspace, and finally, a <strong>data</strong>
<a id="id169" class="indexterm"/>
<strong> source</strong> is the combination of the workspace and dataset names. Don't confuse a dataset with a feature dataset. The former is just a generic term for data, while the latter is an object within a geodatabase that serves as a container for feature classes and other datasets.</p><p>There are three <code class="literal">arcpy.mapping</code> classes involved in fixing broken data sources. They are <code class="literal">MapDocument</code>, <code class="literal">Layer</code>, and <code class="literal">TableView</code>. Each class contains methods that can be used to fix data sources. In this recipe, we'll examine how you can use the <code class="literal">findAndReplaceWorkspacePaths()</code> method in the <code class="literal">MapDocument</code> class to perform global find and replace operations in the layers and tables of a map document.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec66"/>How to do it…</h2></div></div></div><p>Follow these steps<a id="id170" class="indexterm"/> to learn how to fix layers and tables in a map document using <code class="literal">findAndReplaceWorkspacePaths()</code>:</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">c:\ArcpyBook\Ch3\Crime_BrokenDataLinks.mxd</code> in ArcMap.</li><li class="listitem">Right-click on any of the layers and select <strong>Properties</strong>.</li><li class="listitem">Go to the <strong>Source</strong> tab and you will notice that the location for the layer is <code class="literal">ArcpyBook\Ch3\Data\OldData\CityOfSanAntonio.gdb</code>. This is a file geodatabase but the location no longer exists. It has moved to the <code class="literal">C:\ArcpyBook\data</code> folder.</li><li class="listitem">Open <strong>IDLE</strong> and create a new script window.</li><li class="listitem">Import the <code class="literal">arcpy.mapping</code> module:<div><pre class="programlisting">import arcpy.mapping as mapping</pre></div></li><li class="listitem">Reference the <code class="literal">Crime_BrokenDataLinks.mxd</code> map document file:<div><pre class="programlisting">mxd = mapping.MapDocument(r"c:\ArcpyBook\Ch3\Crime_BrokenDataLinks.mxd")</pre></div></li><li class="listitem">Use <code class="literal">MapDocument.findAndReplaceWorkspacePaths()</code> to fix the source path for each data source in the map document. The <code class="literal">findAndReplaceWorksapcePaths()</code> method accepts the old path as the first parameter and the new path as the second parameter:<div><pre class="programlisting">mxd.findAndReplaceWorkspacePaths(r" C:\ArcpyBook\Ch3\Data\OldData\CityOfSanAntonio.gdb", r" C:\ArcpyBook\Data\CityOfSanAntonio.gdb")</pre></div></li><li class="listitem">Save the results to a new <code class="literal">.mxd</code> file:<div><pre class="programlisting">mxd.saveACopy(r"C:\ArcpyBook\Ch3\Crime_DataLinksFixed.mxd")</pre></div></li><li class="listitem">Save the script as <code class="literal">C:\ArcpyBook\Ch3\MapDocumentFindReplaceWorkspacePath.py</code>.</li><li class="listitem">You can check your work by examining the <code class="literal">c:\ArcpyBook\code\Ch3\MapDocumentFindReplaceWorkspacePath.py</code> solution file.</li><li class="listitem">Run the script.</li><li class="listitem">In ArcMap, open the <code class="literal">C:\ArcpyBook\Ch3\Crime_DataLinksFixed.mxd</code> file. You <a id="id171" class="indexterm"/>will notice that all the data sources get fixed, as shown<a id="id172" class="indexterm"/> in the following screenshot:<div><img src="img/B04314_03_3.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec67"/>How it works…</h2></div></div></div><p>The <code class="literal">MapDocument.findAndReplaceWorkspacePaths()</code> method performs global find and replace workspace paths for all layers and tables in a map document. You can replace the paths for multiple workspace types at once.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec68"/>There's more…</h2></div></div></div><p>The <code class="literal">Layer</code> and<a id="id173" class="indexterm"/> <code class="literal">TableView</code> objects also have a <code class="literal">findAndReplaceWorkspacePaths()</code> method that performs the same type of operation. The difference is that this method, in the <code class="literal">Layer</code> and <code class="literal">TableView</code> objects, is used to fix an individual broken data source rather than a global find, <a id="id174" class="indexterm"/>along with the replacement of all broken data sources in a map document.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec28"/>Fixing broken data sources with MapDocument.replaceWorkspaces()</h1></div></div></div><p>During the course of normal GIS operations, it is a fairly common practice to migrate data from one file type<a id="id175" class="indexterm"/> to another. For example, many organizations migrate data from older personal geodatabase formats to the new file geodatabase types, or perhaps even enterprise ArcSDE <a id="id176" class="indexterm"/>geodatabases. You can automate the process of updating your datasets to a different format with <code class="literal">MapDocument.replaceWorkspaces()</code>.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec69"/>Getting ready</h2></div></div></div><p>
<code class="literal">MapDocument.replaceWorkspaces()</code> is similar to <code class="literal">MapDocument.findAndReplaceWorkspacePaths()</code>, but it also allows you to switch from one workspace type to another. For example, you can switch from a file geodatabase to a personal geodatabase. However, it only works in one workspace at a time. In this recipe, we'll use <code class="literal">MapDocument.replaceWorkspaces()</code> to switch our data source from a file geodatabase to a personal geodatabase.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec70"/>How to do it…</h2></div></div></div><p>Follow these steps to learn how to fix broken data sources using <code class="literal">MapDocument.replaceWorkspaces()</code>:</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">c:\ArcpyBook\Ch3\Crime_DataLinksFixed.mxd</code> in ArcMap.</li><li class="listitem">Notice that all of the layers and tables are loaded from a file geodatabase called <code class="literal">CityOfSanAntonio.gdb</code>, as shown in the following screenshot:<div><img src="img/B04314_03_4.jpg" alt="How to do it…"/></div></li><li class="listitem">Open <strong>IDLE</strong> and create a new script window.</li><li class="listitem">Import<a id="id177" class="indexterm"/> the <code class="literal">arcpy.mapping</code> module:<div><pre class="programlisting">import arcpy.mapping as mapping</pre></div></li><li class="listitem">Reference<a id="id178" class="indexterm"/> the <code class="literal">Crime_DataLinksFixed.mxd</code> map document file:<div><pre class="programlisting">mxd = mapping.MapDocument(r"c:\ArcpyBook\Ch3\Crime_DataLinksFixed.mxd")</pre></div></li><li class="listitem">Call the <code class="literal">replaceWorkspaces()</code> method, passing a reference to the old geodatabase type as well as the new geodatabase type:<div><pre class="programlisting">mxd.replaceWorkspaces(r"c:\ArcpyBook \data\CityOfSanAntonio.gdb", "FILEGDB_WORKSPACE",r"c:\ArcpyBook \new_data\CityOfSanAntonio_Personal.mdb","ACCESS_WORKSPACE")</pre></div></li><li class="listitem">Save a copy of the map document file:<div><pre class="programlisting">mxd.saveACopy(r"c:\ArcpyBook\Ch3\Crime_DataLinksUpdated.mxd")</pre></div></li><li class="listitem">Save the script as <code class="literal">c:\ArcpyBook\Ch3\MapDocumentReplaceWorkspaces.py</code>.</li><li class="listitem">You can check your work by examining the <code class="literal">c:\ArcpyBook\code\Ch3\MapDocumentReplaceWorkspaces.py</code> solution file.</li><li class="listitem">Run the script.</li><li class="listitem">In ArcMap, open the <code class="literal">c:\ArcpyBook\Ch3\Crime_DataLinksUpdated.mxd</code> file. As shown<a id="id179" class="indexterm"/> in the following screenshot, all data sources now reference a personal <a id="id180" class="indexterm"/>geodatabase (note the <code class="literal">.mdb</code> extension):<p> </p><div><img src="img/B04314_03_5.jpg" alt="How to do it…"/></div><p>
</p></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec71"/>How it works…</h2></div></div></div><p>The <code class="literal">MapDocument.replaceWorkspaces()</code> method accepts several parameters including old and new workspace paths along with the old and new workspace types. Paths to the workspaces are self-explanatory, but some discussion of the workspace types is helpful. The workspace types are passed into the method as string keywords. In this case, the old <a id="id181" class="indexterm"/>workspace type was a file geodatabase so its keyword is <code class="literal">FILEGDB_WORKSPACE</code>. The new workspace type is <code class="literal">ACCESS_WORKSPACE</code>, which indicates a personal geodatabase. Personal geodatabases are stored in Microsoft Access files. There are a number of different workspace types that can store GIS data. Make sure you provide the workspace<a id="id182" class="indexterm"/> type that is appropriate for your dataset. The following is a list of valid workspace types (many people still work with shapefiles so, in this case, the workspace type would be <code class="literal">SHAPEFILE_WORKSPACE</code>):</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">ACCESS_WORKSPACE</code>: This is a personal geodatabase or Access workspace</li><li class="listitem" style="list-style-type: disc"><code class="literal">ARCINFO_WORKSPACE</code>: This is an ArcInfo coverage workspace</li><li class="listitem" style="list-style-type: disc"><code class="literal">CAD_WORKSPACE</code>: This is a CAD file workspace</li><li class="listitem" style="list-style-type: disc"><code class="literal">EXCEL_WORKSPACE</code>: This is an Excel file workspace</li><li class="listitem" style="list-style-type: disc"><code class="literal">FILEGDB_WORKSPACE</code>: This is a file geodatabase workspace</li><li class="listitem" style="list-style-type: disc"><code class="literal">NONE</code>: This is used to skip a parameter</li><li class="listitem" style="list-style-type: disc"><code class="literal">OLEDB_WORKSPACE</code>: This is an OLE database workspace</li><li class="listitem" style="list-style-type: disc"><code class="literal">PCCOVERAGE_WORKSPACE</code>: This is a PC ARC/INFO Coverage workspace</li><li class="listitem" style="list-style-type: disc"><code class="literal">RASTER_WORKSPACE</code>: This is a raster workspace</li><li class="listitem" style="list-style-type: disc"><code class="literal">SDE_WORKSPACE</code>: This is an SDE geodatabase workspace</li><li class="listitem" style="list-style-type: disc"><code class="literal">SHAPEFILE_WORKSPACE</code>: This is a shapefile workspace</li><li class="listitem" style="list-style-type: disc"><code class="literal">TEXT_WORKSPACE</code>: This is a text file workspace</li><li class="listitem" style="list-style-type: disc"><code class="literal">TIN_WORKSPACE</code>: This is a TIN workspace</li><li class="listitem" style="list-style-type: disc"><code class="literal">VPF_WORKSPACE</code>: This is a VPF workspace</li></ul></div><div><div><h3 class="title"><a id="tip04"/>Tip</h3><p>When switching workspaces via the <code class="literal">replaceWorkspaces()</code> method, the dataset names must be identical. For example, a shapefile called <code class="literal">Highways.shp</code> can be redirected to a file geodatabase workspace only if the dataset name in the file geodatabase is also called <code class="literal">Highways</code>. Use the <code class="literal">replaceDataSource()</code> method on the <code class="literal">layer</code> or <code class="literal">TableView</code> objects if the dataset name is different.</p></div></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec29"/>Fixing individual layer and table objects with replaceDataSource()</h1></div></div></div><p>The previous recipes<a id="id183" class="indexterm"/> in this chapter have used various methods on the <code class="literal">MapDocument</code> object to fix broken data links. The <code class="literal">Layer</code> and <code class="literal">TableView</code> objects also have methods that can be used to fix broken<a id="id184" class="indexterm"/> data links at the individual object level rather than working on all datasets in a map document file. This<a id="id185" class="indexterm"/> recipe discusses<a id="id186" class="indexterm"/> the repairing of <code class="literal">Layer</code> and <code class="literal">TableView</code> objects.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec72"/>Getting ready</h2></div></div></div><p>Both the <code class="literal">Layer</code> and <code class="literal">TableView</code> classes have a <code class="literal">replaceDataSource()</code> method. This method changes the workspace path, workspace type, and/or dataset name for a single layer or table. In this recipe, you'll write a script that changes the workspace path and workspace type for a single layer. The <code class="literal">replaceDataSource()</code> method is available for the <code class="literal">Layer</code> and <code class="literal">TableView</code> classes. In the case of a layer, it can either be in a map document or layer file. For a table, it can refer to the map document only, since <code class="literal">TableView</code> objects can't be contained inside a layer file.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec73"/>How to do it…</h2></div></div></div><p>Follow these steps to learn how to fix individual <code class="literal">Layer</code> and <code class="literal">TableView</code> objects in a map document using <code class="literal">replaceDataSource()</code>:</p><p>Open c<code class="literal">:\ArcpyBook\Ch3\Crime_DataLinksLayer.mxd</code> in ArcMap. The Crime data frame contains a layer called <strong>Burglary</strong>, which is a feature class in the <code class="literal">CityOfSanAntonio</code> file geodatabase. You're going to replace this feature class with a shapefile layer containing the same data:</p><div><img src="img/B04314_03_6.jpg" alt="How to do it…"/></div><div><ol class="orderedlist arabic"><li class="listitem">Open <strong>IDLE</strong> and<a id="id187" class="indexterm"/> create a<a id="id188" class="indexterm"/> new script <a id="id189" class="indexterm"/>window.</li><li class="listitem">Import the <code class="literal">arcpy.mapping</code> module:<div><pre class="programlisting">import arcpy.mapping as mapping</pre></div></li><li class="listitem">Reference the <code class="literal">Crime_DataLinksLayer.mxd</code> map document file:<div><pre class="programlisting">mxd = mapping.MapDocument(r"c:\ArcpyBook\Ch3\ Crime_DataLinksLayer.mxd")</pre></div></li><li class="listitem">Get a reference to the <code class="literal">Crime</code> data frame:<div><pre class="programlisting">df = mapping.ListDataFrames(mxd,"Crime")[0]</pre></div></li><li class="listitem">Find the <a id="id190" class="indexterm"/><strong>Burglary</strong> layer and store it in a variable:<div><pre class="programlisting">lyr = mapping.ListLayers(mxd,"Burglary",df)[0]</pre></div></li><li class="listitem">Call the <code class="literal">replaceDataSource()</code> method on the <code class="literal">Layer</code> object and pass the path to the shapefile. A keyword will indicate that this will be a shapefile workspace, and it also indicates the name of the shapefile:<div><pre class="programlisting">lyr.replaceDataSource(r"c:\ArcpyBook\data","SHAPEFILE_WORKSPACE","Burglaries_2009")</pre></div></li><li class="listitem">Save the results to a new map document file:<div><pre class="programlisting">mxd.saveACopy(r"c:\ArcpyBook\Ch3\Crime_DataLinksNewLayer.mxd")</pre></div></li><li class="listitem">Save the<a id="id191" class="indexterm"/> script<a id="id192" class="indexterm"/> as <code class="literal">c:\ArcpyBook\Ch3\LayerReplaceDataSource.py</code>.</li><li class="listitem">You can check your work by examining the <code class="literal">c:\ArcpyBook\code\Ch3\LayerReplaceDataSource.py</code> solution file.</li><li class="listitem">Run the <a id="id193" class="indexterm"/>script.</li><li class="listitem">Open <code class="literal">C:\ArcpyBook\Ch3\Crime_DataLinksNewLayer.mxd</code> in ArcMap. You should <a id="id194" class="indexterm"/>see that the <strong>Burglary</strong> layer now references a new workspace:<div><img src="img/B04314_03_7.jpg" alt="How to do it…"/></div></li><li class="listitem">Right-click on the <strong>Burglary</strong> layer and select <strong>Properties</strong>.</li><li class="listitem">Click on the <strong>Source</strong> tab and note the new workspace, workspace type, and dataset name:<div><img src="img/B04314_03_8.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec74"/>How it works…</h2></div></div></div><p>The <code class="literal">replaceDataSource()</code> method accepts two required parameters and two optional parameters. The first two<a id="id195" class="indexterm"/> parameters define the workspace path and workspace type for the layer that will <a id="id196" class="indexterm"/>be used as the replacement. The third parameter, <code class="literal">dataset_name</code>, is an optional parameter that<a id="id197" class="indexterm"/> defines the name of the dataset that will be used as the replacement layer. This <a id="id198" class="indexterm"/>name must be an exact match. For example, in this recipe, we passed in a <code class="literal">dataset_name</code> attribute as <code class="literal">Burglaries_2009</code>, which is the name of the shapefile that will now be used as the replacement layer in the data frame. If a name is not provided, the method will attempt to replace the dataset by finding a table with the same name as the current layer's dataset property. The final optional parameter is <code class="literal">validate</code>. By default, this value is set to <code class="literal">True</code>. When set to <code class="literal">True</code>, a workspace will only be updated if the <code class="literal">workspace_path</code> value is a valid workspace. If it is not a valid workspace, then the workspace will not be replaced. If it's set to <code class="literal">False</code>, the method will set the source to match <code class="literal">workspace_path</code>, regardless of whether it is a valid match or not. This can result in a broken data source, but can be useful if you are creating or modifying a map document in preparation for data that does not yet exist.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec75"/>There's more…</h2></div></div></div><p>The <code class="literal">Layer</code> and <code class="literal">TableView</code> classes also contain a <code class="literal">findAndReplaceWorkspacePath()</code> method. This method is very similar to the <code class="literal">MapDocument.findAndReplaceWorkspacePaths()</code> method. The only difference is that it works<a id="id199" class="indexterm"/> against a single<a id="id200" class="indexterm"/> <code class="literal">Layer</code> or <code class="literal">TableView</code> class<a id="id201" class="indexterm"/> instead of iterating the<a id="id202" class="indexterm"/> entire map document or layer file.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec30"/>Finding broken data sources in all map documents in a folder</h1></div></div></div><p>A common scenario<a id="id203" class="indexterm"/> in many organizations involves the movement of data from one workspace to another or from one workspace type to another. When this happens, any map documents or layers that reference these data sources become broken. Finding each of these data sources can <a id="id204" class="indexterm"/>be a huge task if undertaken manually. Fortunately, you can create a geoprocessing script that will find all broken data sources in a folder or list of folders.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec76"/>Getting ready</h2></div></div></div><p>In this recipe, you will learn how to recursively search directories for map document files, find any broken data sources within these map documents, and write the names of the broken data layers to a file.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec77"/>How to do it...</h2></div></div></div><p>Follow these steps to learn how to find all broken data sources in all map documents in a folder:</p><div><ol class="orderedlist arabic"><li class="listitem">Open <strong>IDLE</strong> and create a new script window.</li><li class="listitem">Import the <code class="literal">arcpy</code> and <code class="literal">os</code> packages:<div><pre class="programlisting">import arcpy.mapping as mapping, os</pre></div></li><li class="listitem">Open a file that you will use to write the broken layer names:<div><pre class="programlisting">f = open('BrokenDataList.txt', 'w')</pre></div></li><li class="listitem">Pass a path to the <code class="literal">c:\ArcpyBook</code> folder to use in the <code class="literal">os.walk()</code> method along with a <code class="literal">for</code> loop to walk the directory tree:<div><pre class="programlisting">for root,dirs,files in os.walk("C:\ArcpyBook"):</pre></div></li><li class="listitem">Inside the <code class="literal">for</code> loop, create<a id="id205" class="indexterm"/> a second <code class="literal">for</code> loop that loops through all the files returned and create a new <code class="literal">filename</code> variable. Remember to indent the <code class="literal">for</code> loop inside the first <code class="literal">for</code> loop:<div><pre class="programlisting">for name in files:
    filename = os.path.join(root, name)</pre></div></li><li class="listitem">Following the last line of code that you added, test the file extension to see if it is a map document file. If so, create a new map document object instance using the<a id="id206" class="indexterm"/> path, write the map document name, get a list of broken data sources, loop through each of the broken data sources, and write to the file:<div><pre class="programlisting">if ".mxd" in filename:
     mxd = mapping.MapDocument(filename)
     f.write("MXD: " + filename + "\n")
     brknList = mapping.ListBrokenDataSources(mxd)
     for brknItem in brknList:
          print "Broken data item: " + brknItem.name + " in " + filename
          f.write("\t" + brknItem.name + "\n")</pre></div></li><li class="listitem">Add a <code class="literal">print</code> statement to indicate that you are done and close the file:<div><pre class="programlisting">print("All done")
f.close()</pre></div></li><li class="listitem">The entire script should appear as follows:<div><img src="img/B04314_03_10.jpg" alt="How to do it..."/></div></li><li class="listitem">You can check your work by examining the <code class="literal">c:\ArcpyBook\code\Ch3\ListBrokenDataSources.py</code> solution file.</li><li class="listitem">Run the script to generate the file.</li><li class="listitem">Open the file<a id="id207" class="indexterm"/> to see the results. Your <a id="id208" class="indexterm"/>output will vary depending upon the path you've defined. The following screenshot shows my output file:<div><img src="img/B04314_03_9.jpg" alt="How to do it..."/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec78"/>How it works...</h2></div></div></div><p>This script uses a combination of methods from the Python <code class="literal">os</code> package and the <code class="literal">arcpy.mapping</code> package. The <code class="literal">os.walk()</code> method walks a directory tree and returns the path, a list of directories, and a list of files for each directory starting with a root directory that you have defined as the <code class="literal">c:\ArcpyBook</code> directory. This root directory could have been any directory. The <code class="literal">os.walk()</code> method returns a three item tuple consisting of the root directory, a list of<a id="id209" class="indexterm"/> directories immediately contained within that root, as well as a list of files immediately contained within the root. We then loop through this list of files and test each one to see<a id="id210" class="indexterm"/> if it contains the <code class="literal">.mxd</code> string, which indicates a map document file. Files identified as map documents have their filenames written to a text file, and a new <code class="literal">MapDocument</code> object instance is created. The <code class="literal">ListBrokenDataSources()</code> method is then used with a reference to the map document to generate a list of broken data sources within the file, and these broken data sources are written to the file as well.</p></div></div></div>
</body></html>