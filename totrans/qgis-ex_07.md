# 第七章。使用适宜性分析回答问题

我们生活在一个充满各种关系的世界上，这些关系可以在功能、时间或空间背景下进行分析。在 GIS 中，空间关系尤其引人关注，因为在这里，空间中的对象以便于解释和分析其地理关系的方式表示。适宜性分析是 GIS 分析的基本部分，它回答了“某物最佳位置在哪里？”的问题。在本章中，你将通过寻找最佳居住地来了解适宜性分析的基本原理。你将学习如何：

+   解释对象之间的空间关系

+   通过空间数据表达这些关系

+   根据一组预定义的标准分析空间数据

+   叠加图层并解释结果

在开始本章之前，将解释适宜性分析的一些基本原理和对象之间空间关系的类型。

# 适宜性分析基础

适宜性分析被认可为一种多标准决策支持方法。换句话说，其主要目的是根据一组预定义的标准将感兴趣的区域分为两类：适用于某种用途（居住、建筑、保护等）和不适用。用于适宜性评估的一般方法是多层叠加，支持多标准决策。根据表示适宜性标准和叠加的数据，有两种基本方法可用：

1.  使用向量数据的适宜性分析。这主要利用缓冲区等操作，并通过向量叠加操作（如裁剪、交集和并集）的顺序组合。

1.  使用栅格数据的适宜性分析。这主要依赖于栅格代数，它用于重新分类初始栅格覆盖，然后将其组合以产生二进制或排序适宜性栅格。这种方法更灵活，因为它使得产生多个适宜性类别并根据其代表因素的重要性改变栅格权重成为可能。因此，用户能够产生复合结果，但工作流程需要更多与数据预处理和整合决策相关的努力。

以下表格总结了使用向量和栅格数据的适宜性评估的主要地理处理阶段、优点和缺点：

|   | 向量数据 | 栅格数据 |
| --- | --- | --- |
| **主要地理处理和分析操作** |

+   缓冲区

+   裁剪叠加

+   交集叠加

+   并集叠加

|

+   向量数据栅格化

+   临近栅格创建

+   栅格重分类

+   栅格代数加法

+   栅格代数乘法

+   栅格代数减法

|

| **优点** |
| --- |

+   工作流程的快速性

+   工作流程的简单性

+   人工特征的优良表示

|

+   简单数据重分类

+   连续特征的优良表示

+   可能存在清晰和模糊的类别

+   根据其重要性对不同的覆盖范围进行加权

+   可能进行各种评估，如二元、排序和加权

|

| **局限性** |
| --- |

+   只提供清晰的类别

+   通常只提供二元（是/否）评估

|

+   重新分类和排序的主观性

+   工作流程复杂性

|

无论你将遵循哪种方法，一般适宜性分析的工作流程涉及几个共同步骤。我们现在将更深入地探讨它们，以确保更好地理解适宜性分析系统：

1.  **定义分析的目标和目标**：要研究的问题被一般性地表述，并确定其应用意义，这将成为后续的适宜性标准集合。一些流行的适宜性应用包括以下内容：

    +   **农业**：评估特定作物种植区域的适宜性。

    +   **零售**：从市场营销的角度评估区域——它是否会吸引新客户或买家。在选择理想的购物地点时，这种分析需求很大。

    +   **可再生能源**：评估风力发电站或太阳能电站的用地适宜性是地理空间规划领域可持续性方面的一个显著趋势。

    +   **自然保护**：通过栖息地适宜性建模优先考虑保护需求，并将区域划分为对某些物种生存和繁殖或多或少有价值的地点。

    通常来说，适宜性分析的主要应用领域是土地利用规划，旨在对有限空间和自然资源内各种人类活动进行合理优先排序。

1.  **分析可用数据并定义其与目标和目标的相关性**：定义数据与目标和目标的相关性。分析当前数据可用性和未来数据需求，特别是了解当前数据衍生品是否可用于分析。例如，如果我们必须分析农业需求的适宜性，DEM（数字高程模型）可以是一个很好的来源。它不仅提供了关于地形的基本信息，还提供了一些有用的衍生信息，如坡度和方位。这一阶段的主要成果是列出主要数据来源及其潜在衍生品。

1.  **定义分析的标准**：这是最重要的阶段，分析的目标被描述为基于相关数据的清晰数值标准。描述性目标被翻译成 GIS 分析的语言。在这个阶段，分析对象之间各种类型的空间关系被分析，其中一些最流行的关系包括以下内容：

    +   **点对点关系**:

        "在...范围内"：所有距离居住地 1 公里范围内的学校

        "最接近于"：离居住地最近的小学

        ![适宜性分析基础](img/image00470.jpeg)

        “是...点关系”示例

    +   **点到线关系**：

        “最近”：距离地铁站入口最近的街道

        ![适宜性分析基础](img/image00471.jpeg)

        “最近点”点到线关系示例

    +   **点到多边形关系**：

        “包含于”：所有位于一定社区边界内的公立学校

        ![适宜性分析基础](img/image00472.jpeg)

        “包含于”点到多边形关系示例

    +   **线到线关系**：

        “穿越”：特定小径是否穿越道路

        “在...内”：查找距离特定河流 1 公里范围内的所有小径

        “连接到”：查找连接到特定高速公路的所有街道

    +   **线到多边形关系**：

        “相交”：查找被自行车道穿越的所有区域

        “包含”：查找完全位于某个区域内的所有街道

        ![适宜性分析基础](img/image00473.jpeg)

        “相交”线到多边形关系示例

    +   **多边形到多边形** **关系**：

        “完全包含”：查找完全位于危险区域内的所有区域

        “最近”：查找距离公园最近的大楼

    ![适宜性分析基础](img/image00474.jpeg)

    “完全包含”多边形到多边形关系示例

1.  **主要分析和准备数据**：数据根据先前阶段定义的准则进行分析。常见的分析操作包括按位置选择、缓冲区、栅格化、邻近度（栅格距离）等。所有必要的图层准备就绪后，应准备进行叠加，这涉及到（如果需要）重新投影到共同的坐标系，设置各种排名的范围，并在共同的排名系统中进行重新分类。所有图层应包含统一单位的值，否则它们的叠加将没有意义且难以解释。

1.  **叠加数据并解释结果**：根据用户定义的规则，先前准备好的图层基于一组规则合并成一个单一覆盖。根据可用数据和应用的规则，以下适宜性评估是可能的：

    +   **二元适宜性评估**：整个区域被划分为适宜和不适宜的类别。这是从矢量数据叠加中可以获得的最简单类型的评估。

    +   **排序适宜性评估**：根据预定义的全部标准范围，将地点从最不适宜到最适宜进行排序。此类评估可以从矢量和栅格数据中得出。它让您避免简单的是/否评估，这些评估并非现实世界的固有属性。这种优势被数据排名的主观性和各种因素同等重要性的缺点所抵消。然而，在现实世界中，它们对整体评估的贡献可能会有所不同。

    +   **加权适宜性评估**：这与之前类型的评估类似，只有一个显著的不同点：根据某种活动的不同重要性，各种因素可以有不同的权重。这种评估依赖于栅格代数方法，被认为是全面的，但并非没有主观性，尤其是在因素权重和解释最终结果方面。

在接下来的章节中，我们将逐一介绍这些阶段，并对居住进行加权适宜性评估，结合训练数据集中的各种数据类型。

# 第 1 步 – 定义我们分析的目标和目标

在本教程中，我们将假设我们代表一对年轻夫妇及其小孩进行工作。他们正在寻找一个理想的生活地点，位于他们感兴趣的区域之内。我们的目标是利用基于 GIS 的适宜性分析方法，为他们的问题提供客观和可靠的答案。

本分析的目标是找到符合有小孩年轻家庭的区域，考虑到某些因素。他们的许多要求与传统住宅开发公司的要求相似。例如，地铁站、绿化区和公共安全必须全部考虑在内。还有一些家庭特有的要求需要考虑。如前所述，这个家庭有一个小孩，这意味着我们应该考虑附近是否存在早教或小学。此外，他们热衷于运动，如果他们将要居住的区域有发达和活跃的休闲基础设施那就更好了。经过这样的审查，我们可以制定一些更具体的要求和目标：

+   **安全性**：该区域不应暴露于各种自然和犯罪风险

+   **连通性**：应与城市的交通网络良好连接

+   **绿色和开放性**：它应该靠近公园或其他绿色区域

+   **教育潜力**：早教或小学应位于附近

+   **积极休闲机会**：包括自行车网络和体育设施

+   **文化生活**：艺术画廊和博物馆可以被视为文化脉搏跳动的一般标志

现在主要目标和要求已经明确，我们可以进行下一步，研究所有可用数据，以评估其对我们例子的相关性。

# 第 2 步 – 分析可用数据并定义其相关性

一旦我们定义了基本要求，就需要探索对我们分析可能有用和相关的数据层。训练数据集包含大量数据集，其中最相关的是以下表格中列出的：

| 要求 | 图层 | 可能的相关性 |
| --- | --- | --- |
| 安全性 | `hurricane_evacuation_zones` | 飓风疏散区是可能因飓风风暴潮的生命和安全隐患而需要疏散的城市区域。 |
| `hurricane_inundation_zones` | 飓风淹没区是风暴潮淹没最严重的区域。 |
| `noise_heatmap` | 在第五章的*使用 Heatmap 插件创建热图*部分中创建的栅格，*使用密度分析回答问题*，显示了已注册噪音投诉的空间密度，可能有助于对公共安全的潜在评估。 |
| 连通性 | `subway_entrances` | 地铁入口的位置。 |
| 绿色和开放性 | `parks` | 包含开放空间特征（如法院、跑道、公园等）的层。 |
| `tree_density` | 这是一个由树木普查数据创建的栅格层。 |
| 教育潜力 | `elementary_schools` | 这些是基于官方地址的学校点位置。该层包含一些关于学校的基本信息，例如名称、地址、类型和校长的联系方式。 |
| 活动休息机会 | `bike_routes` | 城市中自行车道和路线的位置。 |
| `athletic_facilities` | 该层包含体育设施及其一些基本信息，包括主要运动类型、表面、尺寸等。 |
| 文化生活 | `museumart` | 博物馆和艺术画廊的位置。 |

这些层主要被定义为最适合我们的分析，因为它们与指定的要求直接相关，但其中大部分以简单的几何原语或密度栅格覆盖表示，难以直接解释为适宜性标准。在下一阶段，我们将探索它们的主要属性，包括属性，并尝试根据对象之间各种类型的空间关系制定具体和可衡量的标准。

# 第 3 步 – 定义分析标准

根据`hurricane_evacuation_zones`的描述，有六个区域，按风暴潮影响风险在属性字段区域中排序，区域`1`是最可能被淹没的区域。在飓风或热带风暴的情况下，这些区域的居民可能会被命令疏散。区域值为`X`的区域不在任何疏散区。区域值为`0`的区域包括以下任何一种：水域、小码头或无人居住的岛屿。为了分析目的，这个层应该被栅格化并根据飓风影响风险排序，排名值从不在任何疏散区的区域到最可能被淹没的区域递减。

`hurricane_inundation_zones`多边形层包含有关风暴潮淹没风险的`category`属性字段信息，其中值为英尺单位的海拔高度。最有可能被淹没的区域被分配值为`1`，而排除在淹没建模之外的区域被分配值为`5`。这个层应该被栅格化和排序，以最高潜在适宜性值对应排除区域，最低值对应`1`类区域。

`noise_heatmap`栅格层是一个应该使用几个类别进行排序的栅格，最不适宜的值对应最嘈杂的地方，反之亦然。这里的好事是，我们不需要像之前那些层一样栅格化这个层。同时，确定排名的数量和范围将使我们的评估带有主观性。`tree_density`层，也是一个密度栅格，应类似进行分析。

其他选定的层应首先分析其邻近性。为此，我们首先将它们栅格化，然后创建连续的邻近栅格，最后根据邻近值（物体越近，适宜性值越高）对它们进行分类排序。同样，在用户排名的情况下，我们无法避免评估中的主观性。此外，最终的邻近栅格可以根据其在整体适宜性评估中的重要性进行加权。

# 第 4 步 - 分析和准备数据

原始数据的主要分析方法有三种。这些方法取决于初始数据类型和可用的属性：

+   **栅格化和排序分类矢量层**：这些层已经包含了所有必要的值，在准备阶段，所有这些层都应栅格化到相似的范围和分辨率。同时，它们的类别应正确排序，最高值对应最适宜的区域，反之亦然。这些层的例子包括`hurricane_evacuation_zones`、`hurricane_inundation_zones`等。

+   **排序密度栅格**：这些是从连续覆盖转换为分类值的栅格热图，其中最高值表示最适宜的区域，最低值与最不适宜的区域相关。这些层的例子包括`noise_heatmap`和`tree_density`。

+   **生成和排序邻近栅格**：这是最繁琐的工作流程。首先应将矢量层栅格化，然后创建邻近栅格并正确排序。这一类别包括以下矢量层：`subway_entrances`、`parks`、`public_schools`、`bike_routes`、`athletic_facilities`和`museumart`。

注意，对于最终输出，我们始终会有按顺序排列的唯一值光栅，最高值表示最合适的区域。此外，所有输出光栅共享一个共同的范围也很重要，这对于它们与光栅计算器和整体适宜性评估的正确叠加是必要的。

在接下来的章节中，我们将通过光栅图层示例来介绍之前提到的流程。一旦你掌握了原理，你将能够独立准备其他图层。

## 光栅化和对分类矢量图层进行排序

在这个例子中，我们将处理`hurricane_evacuation_zones`图层。我们特别感兴趣的属性是`zone`。这是因为通过这个属性，区域被优先考虑进行疏散。具有最低值`1`的区域最有可能被疏散，反之亦然。在这种情况下，我们可以直接使用这些值来对光栅进行排序。我们已经在第六章，*使用可见性分析回答问题*，*步骤 1 - 将建筑矢量图层转换为光栅*部分中进行了光栅化。这次，我们将遵循相同的程序。

阻碍我们直接进行光栅化的一个因素是，用于光栅化的属性字段应该是数值型的。如果你查看**属性**下的**字段**部分中的属性字段，你会看到字段区域具有**类型 QString**，并且包含数字 1-6 和字母（X）的值被解释为符号或字符串的序列，而不是数字。这就是为什么这个字段无法用于光栅化，并且首先应该将其转换为数字。这可以通过**字段计算器**轻松完成：

1.  使用右键单击**打开属性表**快捷方式或点击**属性**工具栏中的相关按钮![光栅化和对分类矢量图层进行排序](img/image00475.jpeg)来打开图层的属性表。在属性表工具栏中，要么点击**打开字段计算器**按钮，要么使用*Ctrl* + *I*键盘快捷方式。

1.  首先，我们应该去除无法解释为数字且无法转换为数字的`X`值。由于我们只有一行包含`X`值，我们只需通过点击属性表工具栏中的![光栅化和对分类矢量图层进行排序](img/image00476.jpeg)按钮切换编辑模式。双击单元格并手动输入新的`7`值。如果你有多个值需要更改，你可以在**字段计算器**中使用以下表达式来更改某些区域字段的值：`CASE WHEN "zone" = 'X' THEN '7' ELSE "zone" END`。

1.  点击![光栅化和对分类矢量图层进行排序](img/image00477.jpeg)按钮打开如图所示的**字段计算器**对话框窗口，并进行以下调整：

    +   确保已开启**创建新字段**切换按钮。

    +   手动输入**输出字段**名称，例如，`rank`。

    +   从**输出字段**类型列表中选择**整数（整数）**，因为我们打算使用短整数进行排序。

    +   将**输出字段宽度**减少到`1`。这是因为排序值不超过 10，我们不希望通过产生超过实际数据值的字段长度来创建多余的数据。

1.  在**表达式**字段中，我们需要输入一个函数，该函数将用于创建新字段的值。在**函数**列表中，展开**转换**项，并双击**toint**函数。根据其描述，它将字符串转换为整数。如果值无法转换为整数（例如，`123asd`是无效的），则不会发生任何变化。双击后，函数将以一个开括号添加到表达式中，之后你应该在双引号中输入（或双击从**字段和值**添加项）要转换的字段名称，然后关闭括号。在我们的例子中，生成的表达式将是`toint( "zone" )`。

1.  点击**确定**按钮后，新字段将出现在表格末尾。取消编辑模式，确认保存编辑，并退出属性表窗口。![光栅化和排序分类矢量图层](img/image00478.jpeg)

图层已准备好进行光栅化。通过访问**栅格** | **转换** | **光栅化（矢量到栅格）**打开一个对话框窗口。在此对话框窗口中，如以下截图所示，调整以下设置：

1.  从**输入文件（shapefile）**下拉列表中选择`hurricane_evacuation_zones`。

1.  从**属性**下拉列表中选择`rank`。

1.  在**输出文件**的**栅格化矢量（栅格）**中，点击**选择**按钮。导航到您的当前工作目录，并将新图层名称输入为`hurricane_evacuation_zones.tif`。将显示此消息：**输出文件不存在。您必须设置输出大小或分辨率才能创建它**。点击**确定**并继续下一阶段。

1.  在前面的步骤中，您定义了一些主要选项。为了方便起见，我们将使用`lidar_dem.tif`作为模板，在本教程中使用相同的范围和分辨率创建栅格。点击![光栅化和排序分类矢量图层](img/image00479.jpeg)按钮以使`gdal_rasterize`命令行参数可编辑。修改后，行应类似于以下示例：

    ```py
    gdal_rasterize -a rank -l hurricane_evacuation_zones –a_nodata 0 -te 982199.3000000000465661 188224.6749999999883585 991709.3000000000465661 196484.6749999999883585 -tr 10 10 -ot UInt16 fullpath/hurricane_evacuation_zones.shp fullpath/hurricane_evacuation_zones.tif

    ```

    这意味着输出栅格将包含来自排序属性字段的栅格化值。图层多边形外的区域将被分配一个值为`0`，这将被解释为`nodata`。输出数据类型是 16 位无符号整数。

1.  点击**确定**按钮。光栅化结果将显示在**图层**面板中。![光栅化和排序分类矢量图层](img/image00480.jpeg)

`hurricane_inundation_zones`图层应以类似的方式进行预处理。该图层包含一些`区域`编号。这些可以解释为洪水风险的严重程度；也就是说，数字越高，风险越低。这意味着我们可以直接使用这些值进行排序。对于这个图层，`gdal_rasterize`命令行参数将如下所示：

```py
gdal_rasterize -a category -l hurricane_inundation_zones -a_nodata 0 -te 982199.3000000000465661 188224.6749999999883585 991709.3000000000465661 196484.6749999999883585 -tr 10 10 -ot UInt16 fullpath/hurricane_inundation_zones.shp fullpath/hurricane_inundation_zones.tif

```

当结合使用时，这些图层可以根据自然灾害风险的严重程度提供基于适宜性的累积评估。

## 排名密度栅格

在密度栅格的情况下，我们可以使用在第五章的*使用 Heatmap 插件创建热图*部分中创建的现成的`noise_heatamp.tif`，并在*使用密度分析回答问题*中创建`tree_density.tif`图层。首先，我们将准备一个`noise_heatmap.tif`，其范围比我们在本章中工作的感兴趣区域大得多。要裁剪栅格图层，请转到**栅格** | **提取** | **裁剪器**：

1.  从**输入文件（栅格）**下拉列表中选择**noise-heatmap**，这是要裁剪的栅格。

1.  在**输出文件**中，点击**选择**按钮以设置输出文件的路径和名称，例如，`noise_heatmap_clip.tif`。

1.  在**裁剪模式**部分，有两种可能的模式：

    +   **范围**是您可以手动输入边界框坐标或通过拖动地图画布的地方。使用这种方法设置输出文件的范围。只需记住，范围应超过由`zipcode_bound`形状文件设定的感兴趣区域的边界。

    +   如果**掩膜层**处于活动状态，您可以选择一个多边形形状文件，它将被用作裁剪边界。

    在您点击**确定**按钮后，该图层将被加载到地图画布上。

    ![排名密度栅格](img/image00481.jpeg)

以下步骤应执行以评估其值范围，将其分为类别，并对它们进行排序：

1.  双击`noise_heatmap_clip`图层以打开**图层属性**窗口。在此窗口中，转到**元数据**部分。在对话框下方的**属性**窗口中探索，直到找到带有基本栅格统计信息的**波段 1**高亮行，如图所示：![排名密度栅格](img/image00482.jpeg)

1.  我们将处理密度栅格，其值被解释为每像素面积内的噪声投诉数量。这个连续表面应分为类别，并且应根据投诉数量进行排序。为此，应设置一定的投诉临界值。没有官方认可的限制和要求，但我们可以将平均数据集值解释为某个临界值（它略大于 56，但我们将使用 50 以方便起见）。将值分为类别，并分配以下排名（投诉数量越少，排名越好）：

    | 类别 | 值范围 | 适应性排名 |
    | --- | --- | --- |
    | 1 | 小于 50 | 5 |
    | 2 | 50 到 100 | 4 |
    | 3 | 100 到 150 | 3 |
    | 4 | 150 to 200 | 2 |
    | 5 | 大于 200 | 1 |

1.  对于排名，转到**栅格** | **栅格计算器**，并在其对话框窗口中调整以下选项：

    +   输入**输出层**路径和名称，例如，`noise_ranked`

    +   选择`noise_heatmap_clip @1`栅格波段，并点击**当前图层范围**按钮，以确保输出层将具有相同的分辨率和范围

    +   在**栅格计算器**表达式窗口中，输入以下表达式：

        ```py
        ("noise_heatmap_clip@1" <= 50) *5 + ("noise_heatmap_clip@1" > 50 AND"noise_heatmap_clip@1" <= 100) *4 + ("noise_heatmap_clip@1" > 100 AND "noise_heatmap_clip@1" <= 150) *3 + ("noise_heatmap_clip@1" > 150 AND "noise_heatmap_clip@1" <= 200) *2+ ("noise_heatmap_clip@1" > 200)*1
        ```

    这个表达式意味着在括号中给出的某个范围内每个落在该范围内的像素首先被分配 1 个值，然后它通过括号外的某个乘数值进行排名。点击**确定**按钮后，重新分类的栅格将被加载到**图层**面板中。

    ![排名密度栅格](img/image00483.jpeg)

注意：由于排名，热图被反转；也就是说，最嘈杂的热点获得最低排名，而最安静的地方获得最高排名。

以类似的方式，我们可以为其他对我们适应性分析感兴趣的点对象创建和排名热图，即`trees`和`museumart`。

## 生成和排名邻近度栅格

以下将使用`subway_entrances`点矢量层为例来解释工作流程：

1.  首先，该层应以常见的方式进行栅格化。`gdal_rasterize`行将包含以下参数：

    ```py
    gdal_rasterize -l subway_entrances -burn 1 -a_nodata 0 -te 982199.3000000000465661 188224.6749999999883585 991709.3000000000465661 196484.6749999999883585 -tr 10 10 -ot Byte fullpath/subway_entrances.shp fullpath/subway_entances.tif

    ```

    在输出层中，现有的点位置将通过像素值`1`进行标记，而所有其他区域将被分配`nodata`值的`0`。

1.  转到**栅格** | **分析** | **邻近度（栅格距离）**。此对话框生成一个栅格邻近度图，指示每个像素中心到最近的被识别为目标像素的像素中心的距离。目标像素是源栅格中其栅格像素值在目标像素值集中的像素。如果没有指定，所有非零像素将被视为目标像素。在对话框窗口中，调整以下参数：

    +   从**输入文件**下拉列表中，选择`subway_entrances`层。

    +   在**输出文件**中，点击**选择**按钮并指定输出图层路径和名称，例如，`subway_entances_proximity.tif`。

    +   确保已激活**距离单位**参数并将其设置为**GEO**。在这种情况下，生成的距离将在地理坐标（英尺）中。

    生成的参数行将看起来像这样：

    ```py
    gdal_proximity.bat fullpath/subway_entances.tif Ifullpath/subway_entances_proximity.tif -distunits GEO -of GTiff

    ```

    ### 注意

    将矢量转换为栅格时，我们使用了 GDAL 的一个工具。它被称为`gdal_proximity`。你可以在[`www.gdal.org/gdal_proximity.html`](http://www.gdal.org/gdal_proximity.html)阅读关于`gdal_proximity`参数及其值的详细说明。

    ![生成和排名邻近度栅格](img/image00484.jpeg)

1.  邻近度栅格应分为离散的类别，并且应进行排名。为此操作，我们将使用**栅格计算器**。这里的主要问题是决定数量和正确选择排名的邻近度类别。最佳决策取决于所谓的步行半径，即人们愿意步行到的距离。通常，交通规划者观察到，大多数人似乎能够舒适地覆盖的步行距离——超过这个距离，乘客量会急剧下降——大约是 400 米（约 1300 英尺）。我们将应用这个 400 米规则将层值（最小为零，最大为 4988.71）分类为四个类别，以下排名：

    | 类别 | 邻近度值范围（英尺） | 适宜性排名 |
    | --- | --- | --- |
    | 1 | 小于 1,300 | 4 |
    | 2 | 1,300 到 2,600 | 3 |
    | 3 | 2,600 到 3,900 | 2 |
    | 4 | 大于 3,900 | 1 |

    前往**栅格** | **栅格计算器**并调整主要选项。输入以下表达式以生成一个新的`subway_entrances_proximity_ranks`栅格：

    ```py
    ("subway_entances_proximity@1" <= 1300) *4 + ("subway_entances_proximity@1" > 1300 AND "subway_entances_proximity@1" <= 2600) *3 + ("subway_entances_proximity@1" > 2600 AND "subway_entances_proximity@1" <= 3900) *2 + ("subway_entances_proximity@1" > 3900)*1

    ```

在下面的屏幕截图中，你可以看到连续（在左侧）和排名（在右侧）栅格可能的样子：

![生成和排名邻近度栅格](img/image00485.jpeg)

以类似的方式，你可以预处理其他需要从邻近位置进行分析的矢量图层，即`公园`、`自行车路线`、`体育设施`和`小学`。结果，你将拥有一组根据选定对象的邻近度进行分类的栅格图层。排名越高，对象越接近。一般来说，可以将 400 米（或 1300 英尺）的值应用于正确地排名栅格。

# 第 5 步 – 叠加数据和解释结果

现在我们已经准备好了叠加栅格并生成累积适宜性评估的所有条件。在下面的表格中，你可以看到按其一般适宜性重要性加权的完整图层列表。权重是介于 0 到 1 之间的简单系数，它们被用来正确地修改排名。

| No. | 栅格图层名称 | 栅格图层类型 | 排名最小值 | 排名最大值 | 权重系数 | 最大可能值 = 最大排名 * 权重 |
| --- | --- | --- | --- | --- | --- | --- |
| 1 | `athletic_facilities_proximity_ranks` | Proximity | 1 | 5 | 0.04 | 0.2 |
| 2 | `bike_routes_proximity_ranks` | Proximity | 1 | 3 | 0.06 | 0.18 |
| 3 | `hurricane_evacuation_zones` | Zoning | 1 | 7 | 0.16 | 1.12 |
| 4 | `hurricane_inundation_zones` | Zoning | 1 | 5 | 0.16 | 0.8 |
| 5 | `Museumart_ranked` | Density | 1 | 4 | 0.05 | 0.2 |
| 6 | `Noise_ranked` | Density | 1 | 5 | 0.13 | 0.65 |
| 7 | `Parks_proximity_ranks` | Proximity | 1 | 3 | 0.12 | 0.36 |
| 8 | `Schools_proximity_ranks` | Proximity | 1 | 4 | 0.15 | 0.6 |
| 9 | `subway_entrances_proximity_ranks` | Proximity | 1 | 4 | 0.06 | 0.24 |
| 10 | `Tree_ranked` | Density | 1 | 4 | 0.07 | 0.28 |
| 总计 | 10 | 44 | 1.0 | 4.63 |

用于我们适宜性评估的表达式可以通过以下步骤构建：

1.  所有由栅格图层表示的可用因素都应乘以其权重系数并汇总，如下所示：（factor_1*weight + factor_2*weight + factor_3*weight + … factor_n*weight）。这种评估给出的是总适宜性，由于获得的值没有相对于可能的最小值和最大值进行计算，因此难以解释。

1.  为了便于解释，总适宜性评估可以分成最大可能值的总和。扩展公式将如下所示：（factor_1*weight + factor_2*weight + factor_3*weight + … factor_n*weight）/（factor_1_max*weight + factor_2_max*weight + factor_3_max*weight + … factor_n_max*weight）。结果，输出值范围将从 0 到 1，其中最大适宜性值接近 1。

1.  可选地，结果可以乘以 100。然后输出值将是适宜性的百分比。

前往**栅格** | **栅格计算器**进行评估：

+   设置**输出图层**的路径和名称

+   从**栅格波段**列表中选择一个图层来设置**当前图层范围**，例如，`hurricane_inundataion`

+   在**表达式**窗口中，输入以下公式（如果您不确定值，请查看前面的表格）：

    ```py
    ( ( "athletic_facilities_proximity_ranks@1" * 0.04 + "bike_routes_proximity_ranks@1" * 0.06+"hurricane_evacuation_zones@1" * 0.16+"hurricane_inundation_zones@1" * 0.16+"museumart_ranked@1" * 0.05+"noise_ranked@1" * 0.13+"parks_proximity@1" * 0.12+"schools_proximity@1" * 0.15+"subway_entrances_proximity_ranks@1" * 0.06+"tree_ranked@1"*0.07) / 4.63 ) *1000

    ```

点击**确定**按钮后，生成的图层将被添加到地图画布上。适宜性栅格值的范围从 42% 到 96%。因此，它可以很容易地进行分类和解释。导航到**图层属性** | **样式**并调整渲染属性，如以下截图所示：

![步骤 5 – 对数据进行叠加并解释结果](img/image00486.jpeg)

应用这些设置后，图层将如下所示：

![步骤 5 – 对数据进行叠加并解释结果](img/image00487.jpeg)

我们可以使用这个栅格作为对我们感兴趣区域进行初步视觉适宜性评估的基础，或者进一步将其与其他图层结合，以确定与整个适宜性标准范围最匹配的确切区块。

在那种情况下，我们需要执行步骤的逆序：选择最适宜的区域，矢量化，并将最大适宜性的多边形与住宅生活区域叠加，以识别特别适宜的街区和建筑：

1.  初始适宜性栅格应通过 90%适宜性限制分为仅两个类别。转到**栅格** | **栅格计算器**，定义输出栅格的路径和名称（例如 `max_suitability`）。在**表达式**窗口中，输入 `"suitability, %@1" >= 90`。在下一页，你可以看到生成的图层仅包含两个类别：适宜（值为 1；分配给适宜性大于或等于 90%的区域），和不适宜（值为 0）。

1.  现在我们需要将这些区域矢量化，以便能够使用它们查询矢量图层。通过转到**栅格** | **转换**打开**多边形化（栅格到矢量）**对话框，调整以下参数：![步骤 5 – 对数据叠加并解释结果](img/image00488.jpeg)

    +   从**输入文件（栅格）**中选择`max_suitability`作为要矢量的栅格。

    +   在**输出多边形文件（shapefile）**中提供输出形状文件的路径和名称，例如，`max_suitability_polygons`。

    +   激活**字段名**切换按钮，并接受默认的`DN`值。此选项负责从初始栅格创建并填充具有类别值的字段。

    ![步骤 5 – 对数据叠加并解释结果](img/image00489.jpeg)

1.  点击**确定**按钮后，生成的形状文件将被添加到**图层**面板。最初，该图层包含所有类别的多边形，而我们只对类别 1 感兴趣。为了选择和删除不必要的多边形，我们将使用**使用表达式选择要素**选项：

    +   通过单击**属性**面板中的![步骤 5 – 对数据叠加并解释结果](img/image00475.jpeg)按钮或从右键菜单中选择**打开属性表**快捷方式，打开`max_suitability`属性表。

    +   在属性表工具栏面板中，单击**使用表达式选择要素**按钮，![步骤 5 – 对数据叠加并解释结果](img/image00490.jpeg)，并输入以下表达式：`"DN" = 0`。点击**确定**后，满足条件的所有多边形将在属性表和地图画布上突出显示。

    +   由于我们不需要这些多边形进行进一步分析，我们应该删除它们。在属性表工具栏面板中，单击![步骤 5 – 对数据叠加并解释结果](img/image00476.jpeg)按钮切换编辑模式，或使用*Ctrl* + *E*键盘快捷键。现在我们可以使用![步骤 5 – 对数据叠加并解释结果](img/image00491.jpeg)按钮执行**删除所选要素**，或者直接从键盘按下*Del*键。

    +   在删除不必要的资料后，别忘了保存您的编辑（使用 ![步骤 5 – 对数据叠加并解释结果](img/image00492.jpeg) 或 *Ctrl* + *S*) 并取消编辑模式。在以下屏幕截图中，您可以看到该图层仅包含那些包含最大适宜值的多边形，这些值设置为 90%：

    ![步骤 5 – 对数据叠加并解释结果](img/image00493.jpeg)

1.  现在，这个图层可以用来与其他矢量图层叠加，并分析对象之间的空间关系，正如在*适宜性分析基础*部分所描述的。例如，我们可以根据适宜性标准识别对我们可能感兴趣的主要住宅区的分区区域：

    +   通过访问**向量** | **研究工具** | **按位置选择**来打开一个对话框。在这个对话框中，您首先应从下拉列表中选择要从中选择对象的图层—从**选择特征在：**下拉列表中选择**`residential_zoning`**—如下所示：![步骤 5 – 对数据叠加并解释结果](img/image00494.jpeg)

    +   在**与特征相交的**下拉列表中，选择`max_suitability_polygons`，它将被用作选择器。

    +   有几种叠加选择选项。激活**包括与选择特征相交的输入特征**。只有那些在查询掩码边界内或与之相交的多边形将被添加到选择中。点击**确定**按钮。您将在地图画布上看到以下结果：

    ![步骤 5 – 对数据叠加并解释结果](img/image00495.jpeg)

1.  同样，您可以尝试另一种类型的查询并确定满足适宜条件的确切建筑物。在这种情况下，对话框将如下所示：![步骤 5 – 对数据叠加并解释结果](img/image00496.jpeg)

    点击**确定**按钮后，您将在地图画布上看到以下结果：

    ![步骤 5 – 对数据叠加并解释结果](img/image00497.jpeg)

注意这次，我们选择了完全位于最大适宜区域内的建筑物。因此，我们准备好为问题“哪个地方最适合居住？”提供一个坚实且具体的答案。

# 摘要

在本章中，您跟随了整个空间分析的全过程，从提出问题到提供具体的答案，即找到地图上的特定地点和对象。您探索了适宜性分析的一些基础知识，并了解了它是如何定义和解释对象之间的空间关系的。此外，您还探索了许多与数据预处理相关的操作：栅格化、重新分类、栅格代数性能等。最后，您回顾了基于叠加空间对象和分析它们之间空间关系的空间查询。

在学习时，逐步执行分析操作是好的，但如果您有大量数据且时间有限需要提供答案，那么您应该提高您分析的性能。这可以通过 QGIS 处理框架实现。它提供了访问数百个地理处理工具（从最简单的到最复杂的）。

在下一章中，我们将介绍 QGIS 处理，您将学习如何通过创建自己的仪器链（模型）来自动化空间分析流程。
