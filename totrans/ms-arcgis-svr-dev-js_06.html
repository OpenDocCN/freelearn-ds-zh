<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><div class="chapter" title="Chapter 6. Charting Your Progress"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Charting Your Progress</h1></div></div></div><p>Displaying data geographically provides users with locational awareness, but some want to see more than just dots on a map and some numbers. They want to see how the data in each location compares, both across the map, and within a location. Other methods of displaying data, such as charts and graphs, can provide additional information.</p><p>Charts and graphs are big business. Companies spend millions of dollars creating executive dashboards, which are a mix of charts and graphs connected to company data and metrics. They work because humans aren't as good at processing large, abstract numbers as computers, but they do better at processing data visually. Good charts and graphs provide comparable data at a glance, in a way anyone can understand.</p><p>In this chapter, we shall learn:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to create charts and graphs using tools provided by the ArcGIS JavaScript API and the Dojo framework</li><li class="listitem" style="list-style-type: disc">How to implement the same charts and graphs using <code class="literal">D3.js</code></li><li class="listitem" style="list-style-type: disc">How to add an external library such as <code class="literal">D3.js</code> as an AMD module</li></ul></div><div class="section" title="Mixing graphs into our maps"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec59"/>Mixing graphs into our maps</h1></div></div></div><p>As we have learned before, the <span class="strong"><strong>ArcGIS JavaScript API</strong></span> <a id="id521" class="indexterm"/>contains more than tools to create maps and text. Built on top of the Dojo framework, the ArcGIS API comes with many user controls and widgets to help you present data. We can create dynamic tables, charts, graphs, and other data visualizations.</p><p>But you are not limited to the charting and graph tools provided by API. Using Dojo's AMD style, you can incorporate other libraries outside the framework into your widget's build, and load them as they are needed. If you work with team members who are more familiar with a library like <code class="literal">D3.js</code>, you can load the library asynchronously into your widget and let the other person develop the graphics.</p><p>In this chapter, we'll explore both internal and external graphics libraries to add graphs to our data. We'll use the<a id="id522" class="indexterm"/> <code class="literal">dojox/charting</code> (<a class="ulink" href="http://dojotoolkit.org/reference-guide/1.10/dojox/charting.html">http://dojotoolkit.org/reference-guide/1.10/dojox/charting.html</a>) modules packaged with the ArcGIS JavaScript API, We'll also implement the graphs with <code class="literal">D3.js</code> (<a class="ulink" href="http://d3js.org">http://d3js.org</a>), a <a id="id523" class="indexterm"/>popular data visualization library.</p></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Our story continues"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec60"/>Our story continues</h1></div></div></div><p>Our clients from the Y2K society called with another request. They don't like the tables we've added to our census popups. All the big numbers overwhelm some of the users. They would rather see the data represented in graphs, so that the user can see the relationships within the data.</p><p>The <a id="id524" class="indexterm"/>Y2K society specifically requested pie charts for ethnic and gender data. We can use any color for the ethnic data, but for gender, they made specific color requests. They want to use a horizontal bar chart for the age data because they've seen population data shown that way and they liked the look. They would like some of the other data graphed and charted as well, but they are willing to leave how that's done to our discretion.</p><p>For this round, we're going to try two different approaches and see which one the client prefers. We'll create charts using the two libraries with the same data, add them to the census data popups, and see which one the client prefers.</p></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Using dojox charting"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec61"/>Using dojox charting</h1></div></div></div><p>We should <a id="id525" class="indexterm"/>first look inside the ArcGIS API for JavaScript to see what it has to offer. We can access a host of charting resources with <code class="literal">dojox/charting</code>. The modules allow you to draw line graphs, pie charts, bar charts, and a whole host of other graphs and charts in a browser. It contains numerous canned themes to show your data, and it can be extended with your custom themes as well. The charting libraries can render in <a id="id526" class="indexterm"/><span class="strong"><strong>Scalable Vector Graphics</strong></span> (<span class="strong"><strong>SVG</strong></span>), <span class="strong"><strong>Vector Markup Language</strong></span> (<span class="strong"><strong>VML</strong></span>), Silverlight, and Canvas, making them both progressive <a id="id527" class="indexterm"/>and backwards-compatible for older browsers like IE7.</p><p>Like most Dojo components, <code class="literal">dojox/charting</code> can render charts either declaratively within your HTML, or programmatically through JavaScript. Declarative charting takes advantage of the <code class="literal">data-dojo</code> attributes. In the exercises that follow, we'll explore the programmatic examples, since they are more dynamic and easier to troubleshoot when things go wrong.</p><div class="section" title="Creating a chart in JavaScript"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec82"/>Creating a chart in JavaScript</h2></div></div></div><p>There<a id="id528" class="indexterm"/> is no one module for <code class="literal">dojox/charting</code> that will take care of all your graphing needs. These four major classes of modules within <code class="literal">dojox/charting</code> can be loaded to create a unique chart or graph, and add new looks and functionality:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The chart object</li><li class="listitem" style="list-style-type: disc">The chart style</li><li class="listitem" style="list-style-type: disc">The chart theme</li><li class="listitem" style="list-style-type: disc">The chart actions and effects</li></ul></div><p>The following is a sample loading of each of the four module types, in order:</p><div class="informalexample"><pre class="programlisting">require([
<span class="strong"><strong>"dojox/charting/Chart"</strong></span>,  // object
<span class="strong"><strong>"dojox/charting/plot2d/Pie"</strong></span>,   // style
<span class="strong"><strong>"dojox/charting/themes/MiamiNice"</strong></span>,   // theme
<span class="strong"><strong>"dojox/charting/action2d/Highlight"</strong></span>,  // action
<span class="strong"><strong>"dojox/charting/action2d/Tooltip"</strong></span>,  // action
"dojo/ready"],
  function(Chart, Pie, MiamiNice, Highlight, Tooltip, ready){
  ready(function(){
    var myChart = new Chart("myChart ");
    myChart.setTheme(MiamiNice)
     .addPlot("default", {
        type: Pie,
        font: "normal normal 11pt Tahoma",
        fontColor: "black",
        labelOffset: -30,
        radius: 80
    }).addSeries("Series A", [
      {y: 3, text: "Red", stroke: "black", tooltip: "Red Alert"},
      {y: 5, text: "Green", stroke: "black", tooltip: "Green Day"},
      {y: 8, text: "Blue",  stroke: "black", tooltip: "I'm Blue!"},
      {y: 13, text: "Other", stroke: "black", tooltip: "A bit different"}
    ]);
    var anim_a = new Highlight(myChart, "default");
    var anim_b = new Tooltip(myChart, "default");
    myChart.render();
  });
});</pre></div></div><div class="section" title="The chart object"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec83"/>The chart object</h2></div></div></div><p>The <a id="id529" class="indexterm"/>chart object, loaded <a id="id530" class="indexterm"/>with the <code class="literal">dojox/charting/Chart</code> module, is the main object you'll use to create and modify your chart. Almost all of your your customizations will be run through this object. The chart object is created with a reference to an HTML element on the page, either by a node or by a string matching the id of a node. In the following code, you can see an example that shows the creation of a simple chart:</p><div class="informalexample"><pre class="programlisting">require<span class="strong"><strong>(["dojox/charting/Chart"</strong></span>, "dojox/charting/axis2d/Default", "dojox/charting/plot2d/Lines", "dojo/ready"],
  function(<span class="strong"><strong>Chart</strong></span>, Default, Lines, ready){
  ready(function(){
    <span class="strong"><strong>var chart1 = new Chart("fibonacci");</strong></span>
    chart1.addPlot("default", {type: Lines});
    chart1.addAxis("x");
    chart1.addAxis("y", {vertical: true});
    chart1.addSeries("Series 1", [1, 1, 2, 3, 5, 8, 13, 21]);
    chart1.render();
  });
});</pre></div><p>In the preceding code, a line graph is produced with values in a series that increase from <code class="literal">1</code> to <code class="literal">21</code>.</p><p>The construction of the chart object can also accept an options object. In these options, you can add the map title, and control elements, such as the title text, position, font, color, and the gap between the title and the graph.</p><p>The <code class="literal">dojox/charting</code> library also includes a 3D charting library, called <code class="literal">dojox/charting/Chart3D</code>. The object can render three dimensional charts and graphs, which can be rotated and panned to get a good perspective on your data. In the following code, you can see an example of a 3D plotted bar chart:</p><div class="informalexample"><pre class="programlisting">require(["dojox/charting/Chart3D", "dojox/charting/plot3d/Bars", "dojox/gfx3d/matrix", "dojo/ready"
], function(Chart3D, Bars, m, ready){
  ready(function(){
    var chart3d = new Chart3D("chart3d", {
       lights: [{direction: {x: 6, y: 6, z: -6}, color: "white"}],
       ambient:  {color:"white", intensity: 3},
       specular: "white"
     },
    [m.cameraRotateXg(10), m.cameraRotateYg(-10), m.scale(0.8), m.cameraTranslate(-50, -50, 0)]),
      bars3d_a = new Bars(500, 500, {gap: 8, material: "red"}), 
      bars3d_b = new Bars(500, 500, {gap: 8, material: "#0F0"}), 
      bars3d_c = new Bars(500, 500, {gap: 8, material: "blue"});
    bars3d_a.setData([3, 5, 2, 4, 6, 3, 2, 1]);
    chart3d.addPlot(bars3d_a);

    bars3d_b.setData([5, 6, 4, 2, 3, 1, 5, 4]);
    chart3d.addPlot(bars3d_b);

    bars3d_c.setData([4, 2, 5, 1, 2, 4, 6, 3]);
    chart3d.addPlot(bars3d_c);

    chart3d.generate().render();
  });
});</pre></div><p>In the <a id="id531" class="indexterm"/>preceding code, a 3D bar graph has been produced with three sets of data <a id="id532" class="indexterm"/>colored red, green, and blue. These values are then viewed through a camera that is rotated somewhat to add perspective to the images.</p></div><div class="section" title="The chart style"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec84"/>The chart style</h2></div></div></div><p>The <a id="id533" class="indexterm"/>chart style<a id="id534" class="indexterm"/> describes what kind of chart we're creating. It defines whether we're loading the data as a line chart or a bar chart, a pie chart or a scatter plot. For two dimensional charts, you'll find these styles in the <code class="literal">dojox/charting/plot2d</code> folder. Chart styles can be grouped into five main categories, as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Lines</strong></span>: These <a id="id535" class="indexterm"/>are the typical line charts that may or may not show the individual data points.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Stacked Lines</strong></span>: Similar <a id="id536" class="indexterm"/>to line charts, but the heights are stacked on top of each other. These allow the user to compare the combined effect of plotted data over time, as well as changes in ratios.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Bars</strong></span>: Compare <a id="id537" class="indexterm"/>values by the width of rows on a graph.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Columns</strong></span>: Compare<a id="id538" class="indexterm"/> quantities by their related column heights.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Miscellaneous</strong></span>: When <a id="id539" class="indexterm"/>other charts cannot be grouped together in a category like the previous ones, they fall into this category. This group includes pie charts, scatter plots, and bubble plots.</li></ul></div><p>If you are using the 3D charts, the styles for these charts can be found in the <code class="literal">dojox/charting/plot3d</code> folder. To take full advantage of the 3D styles, it is best to load the <code class="literal">dojox/gfx3d/matrix</code> module for 3D graphic effects. The <code class="literal">matrix</code> module allows you to rotate the 3D graph in order to get a good perspective of the 3D charts.</p></div><div class="section" title="The chart theme"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec85"/>The chart theme</h2></div></div></div><p>Chart themes <a id="id540" class="indexterm"/>describe<a id="id541" class="indexterm"/> the colors, shading, and text formatting of text elements within your charts and graphs. The Dojo framework comes with a large number of predefined themes that you can choose from, in <code class="literal">dojox/charting/themes</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note12"/>Note</h3><p>You can see what the different themes look like by going to <a class="ulink" href="http://archive.dojotoolkit.org/nightly/checkout/dojox/charting/tests/test_themes.html">http://archive.dojotoolkit.org/nightly/checkout/dojox/charting/tests/test_themes.html</a>.</p></div></div><p>The following example is code which loads a chart with a <code class="literal">MiamiNice</code> theme. In this example, we have loaded a line chart with an <code class="literal">x</code> and <code class="literal">y</code> axis. We set the theme to <code class="literal">MiamiNice</code> using the <code class="literal">setTheme()</code> method. Then, we added the series of numbers to plot and render the chart:</p><div class="informalexample"><pre class="programlisting">require(["dojox/charting/Chart", "dojox/charting/axis2d/Default", "dojox/charting/plot2d/Lines", <span class="strong"><strong>"dojox/charting/themes/MiamiNice",</strong></span> "dojo/ready"],
  function(Chart, Default, Lines, <span class="strong"><strong>MiamiNice</strong></span>, ready){
  ready(function(){
    var chart1 = new Chart("simplechart");
    chart1.addPlot("default", {type: Lines});
    chart1.addAxis("x");
    chart1.addAxis("y", {vertical: true});
<span class="strong"><strong>    chart1.setTheme(MiamiNice);</strong></span>
    chart1.addSeries("Fibonacci", [1, 1, 2, 3, 5, 8, 13, 21]);
    chart1.render();
  });
});</pre></div><p>If you don't find a theme that works for you, or if you have specific colors and styling that you need to adhere to in your application design, you can use the <code class="literal">SimpleTheme</code> object to help define your custom theme. <code class="literal">SimpleTheme</code> is based on the <code class="literal">GreySkies</code> theme, but can be extended with other colors and any formatting you choose. You do not need to define every attribute of your theme, since <code class="literal">SimpleTheme</code> applies whatever defaults you haven't overridden with your custom style. You can see a sample of the code that implements <code class="literal">SimpleTheme</code> here:</p><div class="informalexample"><pre class="programlisting">var BaseballBlues = new SimpleTheme({
  colors: [ "#0040C0", "#4080e0", "#c0e0f0", "#4060a0", "#c0c0e0"]
});
myChart.setTheme(BaseballBlues);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip17"/>Tip</h3><p>Themes typically use no more than five colors in their palette. If you need to add more colors for a set of data, <code class="literal">push()</code> a color hex string into the theme's <code class="literal">.color</code> array, but do it prior to setting the theme of the chart.</p></div></div></div><div class="section" title="Chart actions and effects"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec86"/>Chart actions and effects</h2></div></div></div><p>Creating appealing<a id="id542" class="indexterm"/> charts and graphs might be fun for you, but users in the modern web era expect to interact with the data. They expect chart elements to glow, grow, and change color when they hover over them. They expect things to happen when they click on a pie chart.</p><p>The <code class="literal">dojox/charting/action2d</code> contains chart actions and effects that make charts more educational and<a id="id543" class="indexterm"/> interactive. You don't have to overdo the actions and make your graph do everything. You can simply apply the events you need to get the effect across to the users. The following is a list of the basic actions and effects, along with descriptions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Highlight</code>: This adds<a id="id544" class="indexterm"/> a highlight to the chart or graph element you select.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Magnify</code>: This lets you<a id="id545" class="indexterm"/> magnify a portion of the chart or graph for easier viewing.</li><li class="listitem" style="list-style-type: disc"><code class="literal">MouseIndicator</code>: You<a id="id546" class="indexterm"/> can drag your mouse over features on the graph to show more data.</li><li class="listitem" style="list-style-type: disc"><code class="literal">MouseZoomAndPan</code>: This lets <a id="id547" class="indexterm"/>you zoom and pan over your graph using the mouse. The scroll wheel zooms in and out, while click and drag lets you pan around the graph.</li><li class="listitem" style="list-style-type: disc"><code class="literal">MoveSlice</code>: When<a id="id548" class="indexterm"/> using a pie chart, clicking on a slice can move it out from the rest of the chart.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Shake</code>: This creates <a id="id549" class="indexterm"/>a shaking action on an element on the chart.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Tooltip</code>: Hovering<a id="id550" class="indexterm"/> the mouse cursor over a chart element shows more information.</li><li class="listitem" style="list-style-type: disc"><code class="literal">TouchIndicator</code>: This provides<a id="id551" class="indexterm"/> touch actions that display data on charts.</li><li class="listitem" style="list-style-type: disc"><code class="literal">TouchZoomAndPan</code>: This gives<a id="id552" class="indexterm"/> you zoom and pan ability using touch gestures.</li></ul></div><p>Unlike chart styles and themes, where you attach the chart component to the chart object, chart actions are called separately. The chart action constructor loads the new chart as the first argument, and optional parameters for the second argument. Note that the actions are created before the chart is rendered. You can see an example in the following code:</p><div class="informalexample"><pre class="programlisting">require(["dojox/charting/Chart", 
  …,
  <span class="strong"><strong>"dojox/charting/action2d/Tooltip"],</strong></span>
  function(Chart, …, <span class="strong"><strong>Tooltip</strong></span>){
    var chart = new Chart("test");
    …
    <span class="strong"><strong>new Tooltip(chart, "default", {</strong></span>
<span class="strong"><strong>       text: function(o){</strong></span>
<span class="strong"><strong>          return "Population: "+o.y;</strong></span>
<span class="strong"><strong>       }</strong></span>
<span class="strong"><strong>    });</strong></span>
    chart.render();
});</pre></div><p>In the preceding example, a chart was created, and a tooltip was added showing the population as you hovered over a graph feature.</p></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Using Dojox Charts in popups"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec62"/>Using Dojox Charts in popups</h1></div></div></div><p>Combining the dojox/charting modules with the ArcGIS API for JavaScript provides many ways to display data. One way to deliver feature data through charts is through the map's <code class="literal">infoWindow</code>. The infoWindow uses an HTML template for its content, and that can provide the hooks we need to attach our graphs.</p><p>One issue when adding graphs to the infoWindow is determining when to draw the graph. Thankfully, there's an event for that. The map's <code class="literal">infoWindow</code> fires a <code class="literal">selection-changed</code> event whenever the selected feature graphic is changed, either by clicking on another graphic, or by clicking on the next and previous buttons. We can assign an event listener to that event, look at the selected graphic and, if it has the data we need, we can draw the graphs.</p></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Using Dojo Charts in our application"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec63"/>Using Dojo Charts in our application</h1></div></div></div><p>Our census <a id="id553" class="indexterm"/>application from previous chapters could use some visual appeal when it comes to presenting data. We'll make our first attempt at adding charts and graphs using the <code class="literal">dojox/charting</code> library. We'll apply the graphs to the map popup whenever the user clicks on a census block group, county, or state. The census blocks don't have enough information for us to graph.</p><div class="section" title="Loading the modules"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec87"/>Loading the modules</h2></div></div></div><p>Since our <a id="id554" class="indexterm"/>graphs are currently limited to our census application, we need to update the modules in our custom <code class="literal">y2k/Census</code> module definition:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We'll start by adding <code class="literal">dojo/on</code> to handle the map popup events.</li><li class="listitem">We'll add the default chart object along with a pie chart and a bar chart module.</li><li class="listitem">We'll add the <code class="literal">PrimaryColors</code> theme and <code class="literal">SimpleTheme</code> to create our own custom color template.</li><li class="listitem">Finally, we'll add a highlight and a tooltip action to let the user read the results when they hover over parts of the graphs.</li><li class="listitem">It should look a bit like the following:<div class="informalexample"><pre class="programlisting">define([…
  "dojo/on",
  "dojox/charting/Chart", 
  "dojox/charting/plot2d/Pie",
  "dojox/charting/plot2d/Bars",
  "dojox/charting/action2d/Highlight",
  "dojox/charting/action2d/Tooltip",
  "dojox/charting/themes/PrimaryColors",
  "dojox/charting/SimpleTheme",.
], function (…, dojoOn, Chart, Pie, Bars, Highlight, Tooltip, PrimaryColors, SimpleTheme, …) { … });</pre></div></li></ol></div></div><div class="section" title="Preparing the popup"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec88"/>Preparing the popup</h2></div></div></div><p>As part of <a id="id555" class="indexterm"/>our plan, we want the charts and graphs to render in the map's <code class="literal">infowindow</code> when the features are clicked. We're only interested in showing the<a id="id556" class="indexterm"/> charts and graphs for the currently selected feature, so we'll add an event handler to run every time the <code class="literal">infoWindow</code> object's <code class="literal">selection-change</code> event fires. We'll call it <code class="literal">_onInfoWindowSelect()</code>. After we write a stub function for that in our <code class="literal">Census.js</code> module, we'll add the event handler in the <code class="literal">_onMapLoad()</code> method. We then know the map and its popup are available. It should look something like the following code:</p><div class="informalexample"><pre class="programlisting">_onMapLoad: function () {
  …
  dojoOn(this.map.infoWindow, "selection-change", lang.hitch(this, 
    this._onInfoWindowSelect));
}, 
  …
_onInfoWindowSelect: function () {
  //content goes here
}</pre></div><p>The <code class="literal">infoWindow</code> object's <code class="literal">selection-change</code> event fires when features are both added and removed from the selection. When we examine the <code class="literal">infoWindow</code> object's selected feature, we <a id="id557" class="indexterm"/>must test to find out if it contains a feature. If one is present, we can process that<a id="id558" class="indexterm"/> feature's attributes and add the related graphics to the popup. The <code class="literal">infoWindow</code> function should look like the following:</p><div class="informalexample"><pre class="programlisting">_onInfoWindowSelect: function () {
  var graphic = this.map.infoWindow.getSelectedFeature(),
    ethnicData, genderData, ageData;
  <span class="strong"><strong>if (graphic &amp;&amp; graphic.attributes) {</strong></span>
<span class="strong"><strong>    // load and render the ethnic data</strong></span>
<span class="strong"><strong>    ethnicData = this.ethnicData(graphic.attributes);</strong></span>
<span class="strong"><strong>    this.ethnicGraph(ethnicData);</strong></span>
<span class="strong"><strong>    // load and render the gender data</strong></span>
<span class="strong"><strong>    genderData = this.genderData(graphic.attributes);</strong></span>
<span class="strong"><strong>    this.genderGraph(genderData);</strong></span>
<span class="strong"><strong>    // load and render the age data</strong></span>
<span class="strong"><strong>    ageData = this.ageData(graphic.attributes);</strong></span>
<span class="strong"><strong>    this.ageGraph(ageData);</strong></span>
<span class="strong"><strong>  }</strong></span>
},
…
ethnicData: function (attributes) { },
ethnicGraph: function (data) { },
genderData: function (attributes) { },
genderGraph: function (data) { },
ageData: function (attributes) { },
ageGraph: function (data) { }</pre></div><div class="section" title="Updating the HTML template"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec76"/>Updating the HTML template</h3></div></div></div><p>In order to <a id="id559" class="indexterm"/>add graphs to our popups, we need to update the HTML templates to include element IDs. The JavaScript code then looks for a place to render the graph and we can tell it to render it in the element where the <code class="literal">id</code> is added. Open <code class="literal">CensusBlockGroup.html</code> to look at the popup template. Find the <span class="emphasis"><em>Ethnic groups</em></span> section and delete the entire table underneath. You can comment it out for testing purposes, but we don't want everybody to download all that wasted content when we put this application into production. Replace the table with a <code class="literal">div</code> that has an <code class="literal">id</code> equal to <code class="literal">ethnicgraph</code>. It should look like the following:</p><div class="informalexample"><pre class="programlisting">…
&lt;b&gt;Ethnic Groups&lt;/b&gt;
&lt;div id="ethnicgraph"&gt;&lt;/div&gt; 
…</pre></div><p>Repeat the same under the <code class="literal">Males/Females</code> and the <code class="literal">Ages</code> sections, replacing those tables with <code class="literal">div</code> elements identified as <code class="literal">gendergraph</code> and <code class="literal">agegraph</code> respectively. If you choose to show other graphs, follow the same guidelines. Repeat with the <code class="literal">CountyCensus.html</code> and the <code class="literal">StateCensus.html</code> templates as well.</p></div></div><div class="section" title="Processing the data"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec89"/>Processing the data</h2></div></div></div><p>If you<a id="id560" class="indexterm"/> look <a id="id561" class="indexterm"/>back through the examples from other <code class="literal">dojox/charting</code> operations, you'll notice how data is added to the chart in an array. However, the data we get from the map service isn't in that format. We need to process the attribute data into a format that the <code class="literal">dojox/charting</code> modules can use.</p><p>When passing data objects into <code class="literal">dojox/charting</code> charts and graphs, the graphs expect data to be plottable with <code class="literal">x</code> and <code class="literal">y</code> properties. Since we're not comparing value changes over time or some other independent variable, we will add the numeric populations to our dependent variable <code class="literal">y</code>. The value of the tooltip text can be assigned to the JSON tooltip data property. You can see the resulting function in the following code:</p><div class="informalexample"><pre class="programlisting">…
formatAttributesForGraph: function (attributes, fieldLabels) {
  var data = [], field;
  for (field in fieldLabels) {
    <span class="strong"><strong>data.push({ </strong></span>
<span class="strong"><strong>      tooltip: fieldLabels[field], </strong></span>
<span class="strong"><strong>      y: +attributes[field] </strong></span>
<span class="strong"><strong>    });</strong></span>
  }
  return data;
},
…</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note13"/>Note</h3><p>The <code class="literal">+</code> symbol in front of the attribute in the population objects is a shortcut to convert a value into a number, if it isn't one already. You get the same effect using the <code class="literal">parseInt()</code> or <code class="literal">parseFloat()</code> methods.</p></div></div><p>Now that we're able to transform our data into a format useable for our graph widget, we can call our <code class="literal">ethnicData()</code>, <code class="literal">genderData()</code>, and <code class="literal">ageData()</code> methods. We'll extract the data we need from the feature attributes and put it in an array format to be used by the <code class="literal">chart</code> module.</p><div class="section" title="Parsing the ethnic data"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec77"/>Parsing the ethnic data</h3></div></div></div><p>We're<a id="id562" class="indexterm"/> interested in extracting the ethnic makeup of the population in the census area. We're interested in the <code class="literal">WHITE</code>, <code class="literal">BLACK</code>, <code class="literal">AMER_ES</code>, <code class="literal">ASIAN</code>, <code class="literal">HAWN_PI</code>, <code class="literal">HISPANIC</code>, <code class="literal">OTHER</code>, and <code class="literal">MULT_RACE</code> fields that are present in the state, county, and block group feature classes. Since we have a lot of fields that may or may not be in the feature class, and we'll be adding them the same way, we'll create an array of field names and the corresponding labels we want to add. See the following code:</p><div class="informalexample"><pre class="programlisting">…
ethnicData: function (attributes) {
  <span class="strong"><strong>var data = [],</strong></span>
<span class="strong"><strong>      fields = ["WHITE", "BLACK", "AMERI_ES", "ASIAN", "HAWN_PI", "HISPANIC", "OTHER", "MULT_RACE"],</strong></span>
<span class="strong"><strong>      labels = ["Caucasian", "African-American", "Native American /&lt;br&gt; Alaskan Native", "Asian", "Hawaiian /&lt;br&gt; Pacific Islander", "Hispanic", "Other", "Multiracial"];</strong></span>
},
…</pre></div><p>Now that we<a id="id563" class="indexterm"/> have the fields and labels, let's add the information we need to the data array. The <code class="literal">dojox/charting</code> library expects graphical data in either a numerical list or in a JSON object with a specific format. Since we want to add labels to our data in a pie chart, we'll create the complex objects:</p><div class="informalexample"><pre class="programlisting">…
ethnicData: function (attributes) {
  var fieldLabels = {
    "WHITE": "Caucasian", 
    "BLACK": "African-American", 
    "AMERI_ES":"Native American /&lt;br&gt; Alaskan Native", 
    "ASIAN": "Asian", 
    "HAWN_PI":"Hawaiian /&lt;br&gt; Pacific Islander", 
    "HISPANIC": "Hispanic", "OTHER": "Other", 
    "MULT_RACE": "Multi-racial"
  }
<span class="strong"><strong>  return this.formatAttributesForGraph(attributes, fieldLabels);</strong></span>
},
…</pre></div></div><div class="section" title="Parsing the gender data"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec78"/>Parsing the gender data</h3></div></div></div><p>We'll calculate the gender data<a id="id564" class="indexterm"/> in a similar way. We are only interested in the <code class="literal">MALES</code> and <code class="literal">FEMALES</code> fields in the feature attributes. We're going to add them to the list of JSON objects with the same format as shown in the preceding code. It should look like the following:</p><div class="informalexample"><pre class="programlisting">genderData: function (attributes) {
  var fieldLabels = {
    "MALES": "Males", "FEMALES", "Females"
  }
<span class="strong"><strong>  return this.formatAttributesForGraph(attributes, fieldLabels);</strong></span>
},
…</pre></div></div><div class="section" title="Parsing the age data"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec79"/>Parsing the age data</h3></div></div></div><p>We'll <a id="id565" class="indexterm"/>perform the same style of data manipulation for our <code class="literal">ageData()</code> method as we did with the <code class="literal">ethnicData()</code> method. We'll collect the census data if it's available for ages less than <code class="literal">5</code>, <code class="literal">5-17</code>, <code class="literal">18-21</code>, <code class="literal">22-29</code>, <code class="literal">30-39</code>, <code class="literal">40-49</code>, <code class="literal">50-64</code>, and <code class="literal">65</code> and up. We'll then add the appropriate tooltip labels and return the resulting formatted data array. It should look as follows:</p><div class="informalexample"><pre class="programlisting">ageData: function (attributes) {
  var fieldLabels = {
    <span class="strong"><strong>"AGE_UNDER5": "&amp;lt; 5", "AGE_5_17": "5-17", "AGE_18_21": "18-21", </strong></span>
<span class="strong"><strong>    "AGE_22_29": "22-29", "AGE_30_39": "30-39", "AGE_40_49": "40-49", </strong></span>
<span class="strong"><strong>    "AGE_50_64": "50-64", "AGE_65_UP": "65+"</strong></span>
<span class="strong"><strong>  };</strong></span>
<span class="strong"><strong>  return this.formatAttributesForGraph(attributes, fieldLabels);</strong></span>
},</pre></div></div></div><div class="section" title="Showing the results"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec90"/>Showing the results</h2></div></div></div><p>Now that we <a id="id566" class="indexterm"/>have the results in a format that we can use for the charts, we can load them into our charts. Our ethnic and gender graphs are both pie graphs, while the <a id="id567" class="indexterm"/>age graph is a horizontal bar graph. Let's look at what it takes to construct each. Any extra graphs you want to create with the rest of the data can be done in your own time.</p><div class="section" title="Ethnic graph"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec80"/>Ethnic graph</h3></div></div></div><p>We <a id="id568" class="indexterm"/>want a pie chart that fits within the popup for the ethnic graph. A radius of 90 pixels should fit nicely within the popup. We're going to set the theme of the graph using <code class="literal">PrimaryColors</code>, one of the default themes in <code class="literal">dojox/charting</code>. We'll also add the pie charting ability to the chart, and add the tooltip and highlight animations when the user hovers over the data. Finally, we'll render the ethnic pie chart:</p><div class="informalexample"><pre class="programlisting">ethnicGraph: function (data) {
  var ethnicChart = new Chart("ethnicgraph");
  ethnicChart.setTheme(PrimaryColors)
    .addPlot("default", {
      type: Pie,
      font: "normal normal 11pt Tahoma",
      fontColor: "black",
      radius: 90
  }).addSeries("Series A", data);
  var anim_a = new Tooltip(ethnicChart, "default");
  var anim_b = new Highlight(ethnicChart, "default");
  ethnicChart.render();
},</pre></div><p>When the application draws the ethnic graph, it should look like the following image:</p><div class="mediaobject"><img src="graphics/6459OT_06_01.jpg" alt="Ethnic graph" width="263" height="269"/><div class="caption"><p>Ethnic groups</p></div></div></div><div class="section" title="Gender graph"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec81"/>Gender graph</h3></div></div></div><p>For the <a id="id569" class="indexterm"/>gender graph, we're going to set up a similar pie graph to the ethnic graph. But, before we do, we'll load a new theme to work with. We'll create a <code class="literal">genderTheme</code> constructor from the <code class="literal">SimpleTheme</code> constructor, and add light pink for females, and light blue for males. We'll then create the chart, add the new theme, and add everything else like we did in the ethnic graph. You can see this in the following code:</p><div class="informalexample"><pre class="programlisting">genderGraph: function (data) {
<span class="strong"><strong>  var genderTheme = new SimpleTheme({</strong></span>
<span class="strong"><strong>    colors: ["#8888ff", "#ff8888"]</strong></span>
<span class="strong"><strong>  }),</strong></span>
  genderChart = new Chart("gendergraph");

  genderChart<span class="strong"><strong>.setTheme(genderTheme)</strong></span>
    .addPlot("default", {
      type: Pie,
      font: "normal normal 11pt Tahoma",
      fontColor: "black",
      radius: 90
  }).addSeries("Series A", data);
  var anim_a = new Tooltip(genderChart, "default");
  var anim_b = new Highlight(genderChart, "default");
  genderChart.render();
},</pre></div><p>When the application <a id="id570" class="indexterm"/>draws the gender graph, it should look something like the following image:</p><div class="mediaobject"><img src="graphics/6459OT_06_02.jpg" alt="Gender graph" width="265" height="290"/></div></div><div class="section" title="Age graph"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec82"/>Age graph</h3></div></div></div><p>We'll <a id="id571" class="indexterm"/>create a bar chart graph for the age graph to show the age demographics. Unlike the pie chart, the bar chart doesn't care about the radius, but prefers to know how long the bars can grow (<code class="literal">maxBarSize</code>), and how far to set them apart (gap). We'll go ahead and use the <code class="literal">PrimaryColors</code> theme again for this object:</p><div class="informalexample"><pre class="programlisting">ageGraph: function (data) {
  var ageChart = new Chart("agegraph");
  ageChart.setTheme(PrimaryColors)
   .addPlot("default", {
     type: Bars,
      font: "normal normal 11pt Tahoma",
      fontColor: "black",
      gap: 2,
      maxBarSize: 220
  }).addSeries("Series A", data);
  var anim_a = new Tooltip(ageChart, "default");
  var anim_b = new Highlight(ageChart, "default");
  ageChart.render();
}</pre></div><p>When you <a id="id572" class="indexterm"/>draw the <code class="literal">ageChart</code>, it should look something like the following image:</p><div class="mediaobject"><img src="graphics/6459OT_06_03.jpg" alt="Age graph" width="269" height="300"/></div></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Introducing D3.js"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec64"/>Introducing D3.js</h1></div></div></div><p>You can <a id="id573" class="indexterm"/>branch out beyond the ArcGIS JavaScript API and Dojo if you want to create jaw-dropping graphics. One popular JavaScript library you could use to create charts, graphs, and other data-driven visualizations is <code class="literal">D3.js</code>. <code class="literal">D3.js</code> was created by Mike Bostock of the New York Times to use HTML, SVG, CSS, and JavaScript to create interactive data-driven graphics. It reads data from HTML and renders it in the way you decide.</p><p>
<code class="literal">D3.js</code> development has taken off since it was first released to the public. The library is very versatile in that it doesn't render just charts and graphs. It provides the building blocks to create charts, graphs, and other interactive graphics that can move and be styled like any HTML element. Even GIS maps in different projections can be shown on a webpage using <code class="literal">D3.js</code> and a file format called GeoJSON.</p><p>For anyone with experience with jQuery, scripts written with <code class="literal">D3.js</code> behave in the same way. You can select HTML elements with the <code class="literal">d3.select()</code> or <code class="literal">d3.selectAll()</code> methods, which are similar to the jQuery base method. D3 commands can be chained one after another, which is also a favorite feature with many jQuery developers. In the following example, we're using D3 to find elements with the class <code class="literal">addflair</code> using the <code class="literal">select()</code> method. We then add spans to the elements with related text content:</p><div class="informalexample"><pre class="programlisting">d3.select(".addflair").append("span").text("I've got flair!");</pre></div><div class="section" title="Adding the D3.js library with Dojo's AMD"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec91"/>Adding the D3.js library with Dojo's AMD</h2></div></div></div><p>Let's say <a id="id574" class="indexterm"/>you want to add <code class="literal">D3.js</code> to your mapping application. You find the link to the <code class="literal">d3</code> library, and copy and paste it into your application like so:</p><div class="informalexample"><pre class="programlisting">…
  &lt;link rel="stylesheet" 
  href="https://js.arcgis.com/3.13/esri/css/esri.css" /&gt;
  &lt;script src="https://js.arcgis.com/3.13/"&gt;&lt;/script&gt;
  &lt;script src=https://d3js.org/d3.v3.js"&gt;&lt;/script&gt;
&lt;/head&gt;
…</pre></div><p>You cut and paste an example to test if it's going to work. You crank up your browser, and load your page. You wait patiently for everything to load, and it breaks. What happened?</p><p>It turns out that the extra libraries loaded after the ArcGIS JavaScript API and interfered with the AMD library references. Let's look at a couple of solutions to load external libraries into an AMD-based application.</p><div class="section" title="Loading another library outside an AMD module"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec83"/>Loading another library outside an AMD module</h3></div></div></div><p>If you are <a id="id575" class="indexterm"/>going to work with a JavaScript library outside an AMD module, it's best to load that library before you load the ArcGIS JavaScript API. You would use this if you're adding a map on top of an existing application previously written in another framework.</p></div><div class="section" title="Loading another library within an AMD module"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec84"/>Loading another library within an AMD module</h3></div></div></div><p>The other<a id="id576" class="indexterm"/> way to handle D3 and other external libraries in your AMD applications is to load them as AMD modules. You can treat them like any other Dojo-based module, and load them into memory only when necessary. This works well with libraries that you use sporadically and don't need at startup. It also works well with libraries that load all the functionality of the library into a single JavaScript object, such as <code class="literal">D3.js</code> or jQuery.</p><p>To load an external library as an AMD module, you must first reference it in <code class="literal">dojoConfig</code> as a package, just like you did with your custom <code class="literal">Dojo</code> module in <a class="link" href="ch03.html" title="Chapter 3. The Dojo Widget System">Chapter 3</a>, <span class="emphasis"><em>The Dojo Widget System</em></span>. Adding your external library to the packages will tell Dojo's <code class="literal">require()</code> and <code class="literal">define()</code> functions where to look for the libraries. Remember that, when listing the location of the library in the package, you reference the file folder of the JavaScript library, not<a id="id577" class="indexterm"/> the library directly. For D3, the <code class="literal">dojoConfig</code> script may look something like the following:</p><div class="informalexample"><pre class="programlisting">dojoConfig = {
  async: true,
  packages: [
    {
      name: "d3",
      location: "http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.12/"
    }
  ]
};</pre></div><p>Once the library folder reference has been added to your <code class="literal">dojoConfig</code> variable, you can add it to any <code class="literal">require()</code> or <code class="literal">define()</code> statement. Loading the library into an AMD <code class="literal">require()</code> statement would look like the following:</p><div class="informalexample"><pre class="programlisting">require([…, "d3/d3", …], function (…, d3, …) { … });</pre></div></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Using D3.js in our application"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec65"/>Using D3.js in our application</h1></div></div></div><p>In our <a id="id578" class="indexterm"/>application, we will explore using D3 to add graphs to our application. We'll <a id="id579" class="indexterm"/>use it to replace parts of the <code class="literal">dojox/charting</code> code where we add the graphs to our map popup. Many of the steps will be similar, but some will be different.</p><div class="section" title="Adding D3.js to the configuration"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec92"/>Adding D3.js to the configuration</h2></div></div></div><p>Since <a id="id580" class="indexterm"/>our application relies heavily on the Dojo framework, we will add our <code class="literal">D3.js</code> library with AMD. We'll add the reference to D3 in our <code class="literal">dojoConfig.packages</code> list. The new <code class="literal">dojoConfig</code> script should look like the following:</p><div class="informalexample"><pre class="programlisting">dojoConfig = {
  async: true,
  packages: [
    {
      name: 'y2k',
      location: location.pathname.replace(/\/[^\/]*$/, '') +'/js'
    },
    <span class="strong"><strong>{</strong></span>
<span class="strong"><strong>      name: "d3",</strong></span>
<span class="strong"><strong>      location: "http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.12/"</strong></span>
<span class="strong"><strong>    }</strong></span>
  ]
};</pre></div><p>Now that our <a id="id581" class="indexterm"/>AMD code knows where to look for the <code class="literal">D3</code> library, we can add a reference to it in our census application. The <code class="literal">D3</code> library will then be available to our census widget, but it will not interfere with other applications that may have their own <code class="literal">d3</code> variable. Our <code class="literal">Census.js</code> code should look like the following:</p><div class="informalexample"><pre class="programlisting">define([
  …,
  "esri/config", "d3/d3"
], function (
  …,
  esriConfig, d3
) {
…
});</pre></div></div><div class="section" title="Preparing the popup"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec93"/>Preparing the popup</h2></div></div></div><p>
<code class="literal">D3.js</code> should<a id="id582" class="indexterm"/> now be accessible in our widget, and we can prepare the popup to load the data. We're going to set up our code in the same way we did when we loaded the <code class="literal">dojox/charting</code> modules. We'll attach the same event to the map.<code class="literal">infoWindow</code> object's <code class="literal">selection-change</code> event, and on that, we'll run functions to manipulate and render our data.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note14"/>Note</h3><p>Refer to the <span class="emphasis"><em>Preparing the popup</em></span> section in the dojox/charting portion of the chapter to get the code.</p></div></div><p>As for the HTML popup templates for the block groups, counties, and states, we can make the same changes we made to the ones in the <code class="literal">dojox/charting</code> example. In keeping with best practices on the Internet, we will replace the <code class="literal">id</code> tags on the graphing <code class="literal">div</code> elements with class tags of the same name (ethnic groups get <code class="literal">class="ethnicgraph"</code>, for instance). This will cut down on the possibility of HTML <code class="literal">id</code> collision. Also, while Dojo widgets require either an HTML element or an <code class="literal">id</code> string, <code class="literal">D3.js</code> graphs can be added to elements found with any CSS selector.</p></div><div class="section" title="Processing our data"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec94"/>Processing our data</h2></div></div></div><p>When we <a id="id583" class="indexterm"/>collected the attribute data for the <code class="literal">dojox/Charting</code> modules, we had to arrange the attribute data into arrays so they could be consumed by the graphing modules. The same is true for <code class="literal">D3.js</code>. We will format the attributes into a list that can be read by the graphs.</p><p>Unlike <a id="id584" class="indexterm"/>the <code class="literal">dojox/charting</code> library, <code class="literal">D3.js</code> doesn't have name restrictions on the properties used by the graphing parts. You can give the properties more reasonable names. Functions in <code class="literal">D3.js</code> will be added to calculate graph values. Since much of our ethnic, gender, and age data is based on population and sorted by name, it makes sense to name those properties population and name, respectively:</p><div class="informalexample"><pre class="programlisting">…
formatAttributesForGraph: function (attributes, fieldLabels) {
  var data = [], field;
  for (field in fieldLabels) {
    <span class="strong"><strong>data.push({ </strong></span>
<span class="strong"><strong>      name: fieldLabels[field], </strong></span>
<span class="strong"><strong>      population: +attributes[field] </strong></span>
<span class="strong"><strong>    });</strong></span>
  }
  return data;
},
…</pre></div><p>We add the property names and the population values to a list in the <code class="literal">formatAttributesForGraph()</code> method. That list will be graphed at a later time. We don't need to change any of the code because we're using the same function to process the attribute data in the <code class="literal">ethnicData()</code>, <code class="literal">genderData()</code>, and <code class="literal">ageData()</code> function.</p></div><div class="section" title="Displaying the results"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec95"/>Displaying the results</h2></div></div></div><p>Now that <a id="id585" class="indexterm"/>we've created our lists of data, we can display them in the graphs on our popups.</p><div class="section" title="Displaying the ethnic graph"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec85"/>Displaying the ethnic graph</h3></div></div></div><p>For our<a id="id586" class="indexterm"/> ethnic graph, we're going to create a pie chart:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We'll scale it to fit within a <code class="literal">240</code> pixel by <code class="literal">210</code> pixel area in our popup window.</li><li class="listitem">We'll add our own color scale with a list of CSS colors.</li><li class="listitem">We'll look for the HTML DOM element where we want to put our graph (<code class="literal">class="ethnicgraph"</code>), and then attach the pie chart graphic.</li><li class="listitem">We'll apply the color, size it with our population data, and then label it with the names of the ethnic groups:<div class="informalexample"><pre class="programlisting">ethnicGraph: function (data) {
      var width = 240,
        height = 210,
        radius = Math.min(width, height) / 2;

      var color = d3.scale.ordinal()
        .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00", "#c7d223"]);
      var arc = d3.svg.arc()
        .outerRadius(radius - 10)
        .innerRadius(0);

      var pie = d3.layout.pie()
        .sort(null)
        .value(function(d) { return d.population; });

      var svg = d3.select(".censusethnic").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(" + width/2 + "," + height/2 + ")");

      if (!data || !data.length) {
        return;
      }
      
      var g = svg.selectAll(".arc")
        .data(pie(data))
        .enter().append("g")
        .attr("class", "arc");

      g.append("path")
        .attr("d", arc)
        .style("fill", function(d) { return color(d.data.name); });

      g.append("text")
        .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
        .attr("dy", ".35em")
        .style("text-anchor", "middle")
        .text(function(d) { return d.data.name; });
    },</pre></div></li></ol></div><p>When the <a id="id587" class="indexterm"/>application draws the graph, it should look something like the following graph:</p><div class="mediaobject"><img src="graphics/6459OT_06_04.jpg" alt="Displaying the ethnic graph" width="241" height="227"/></div></div><div class="section" title="Displaying the gender graph"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec86"/>Displaying the gender graph</h3></div></div></div><p>For the<a id="id588" class="indexterm"/> gender graph, we'll start by copying and pasting the code from the ethnic graph. The code is similar, except for two minor changes:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">For our first change, we'll add custom colors for the male and female populations. Look for where the color variable is assigned, and insert the two color hexadecimal numbers into the color range:<div class="informalexample"><pre class="programlisting">genderGraph: function (data) {
…
  var color = d3.scale.ordinal().range(["#8888ff", "#ff8888"]);
…
}, </pre></div></li><li class="listitem">Next, we would like to make the labels show both the gender in question, and the actual population. To make a two-line label, we need to add another <code class="literal">tspan</code> to fill in with the population. We also need to move that label so that it is under the other label, and doesn't cross over it:<div class="informalexample"><pre class="programlisting">g.append("text")
  .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
  .attr("dy", ".35em")
  .style("text-anchor", "middle")
  .text(function(d) { return d.data.name; })
  .append("tspan")
  .text(function(d) { return d.data.population;})
  .attr("x", "0").attr("dy", '15');</pre></div></li><li class="listitem">Once we run the application and test it with some data, the graph should look like the<a id="id589" class="indexterm"/> following image, pending data:<div class="mediaobject"><img src="graphics/6459OT_06_05.jpg" alt="Displaying the gender graph" width="234" height="231"/></div></li></ol></div></div><div class="section" title="Displaying the age graph"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec87"/>Displaying the age graph</h3></div></div></div><p>The age graph<a id="id590" class="indexterm"/> creates bar graphs from simple html <code class="literal">div</code> elements. It resizes them according to the data we've provided. We need to calculate a maximum value for the data, so that we can fit the data values within a maximum width. From there, we can draw and label our graphs with the data provided:</p><div class="informalexample"><pre class="programlisting">ageGraph: function (data) {
  // calculate max data value
  var maxData = d3.max(arrayUtils.map(data, function (item) {return item.population;}));
  // create a scale to convert data value to bar width
  var x = d3.scale.linear()
            .domain([0, maxData])
            .range([0, 240]);
  // draw bar graph and label it.
  d3.select(".censusages")
    .selectAll("div")
    .data(data)
      .enter().append("div")
      .style("width", function(d) { return x(d.population) + "px"; })
      .text(function(d) { return d.age + ": " + d.population; });
}</pre></div><p>Using CSS styling, we can transform the appearance of the data however we wish. In this example, we decided <a id="id591" class="indexterm"/>to go with an alternating color theme, using the CSS3 <code class="literal">nth-child(even)</code> pseudo class selector. You can add your own CSS hover effects to match what we did with <code class="literal">dojox/charting</code>:</p><div class="informalexample"><pre class="programlisting">.censusages &gt; div {
  background: #12af12;
  color: white;
  font-size: 0.9em;
  line-height: 1.5;
}
.censusages &gt; div:nth-child(even) {
  background: #64ff64;
  color: #222;
  margin: 1px 0;
}</pre></div><p>Using CSS and our data, we were able to create the following graph:</p><div class="mediaobject"><img src="graphics/6459OT_06_06.jpg" alt="Displaying the age graph" width="248" height="192"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note15"/>Note</h3><p>If you would like more information on the <code class="literal">D3.js</code> library, there is a wealth of information available. The official <a id="id592" class="indexterm"/><code class="literal">D3.js</code> website is at <a class="ulink" href="http://d3js.org/">http://d3js.org/</a>. You can go there to find examples, tutorials, and other eye-popping graphics. You can also check out <span class="emphasis"><em>Data Visualization with d3.js</em></span> by Swizec Tellor, <span class="emphasis"><em>Data Visualization with D3.js Cookbook</em></span> by Nick Qi Zhu, and <span class="emphasis"><em>Mastering D3.js</em></span> by Pablo Navarro Castillo.</p></div></div></div></div></div></div></div>
<div id="book-content"><div id="sbo-rt-content"><div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec66"/>Summary</h1></div></div></div><p>Both <code class="literal">dojox/charting</code> and <code class="literal">D3.js</code> have their advantages and disadvantages in our web mapping applications. The <code class="literal">dojox/charting</code> library comes with the ArcGIS JavaScript API, and is easily integrated with existing applications. It provides many themes that can be added quickly. On the other hand, <code class="literal">D3.js</code> works with HTML elements and CSS styling to create eye-popping effects. It offers more data visualization techniques than <code class="literal">dojox/charting</code> and offers customizable appearances using CSS styling. Your final choice may come down to your comfort level with these tools and your imagination.</p><p>In this chapter, we have learned how to incorporate graphs and charts in to our ArcGIS JavaScript API applications. We used graphics libraries provided by the Dojo framework, which created graphics based on data from map features. We also used <code class="literal">D3.js</code> to render charts and graphs in our application. In the process, we learned how to load and access other libraries in Dojo's AMD-based applications.</p><p>In the next chapter, we'll explore how to mix our ArcGIS JavaScript API applications with other popular JavaScript frameworks.</p></div></div></div></body></html>