<html><head></head><body><div class="chapter" title="Chapter&#xA0;5.&#xA0;Answering Questions with Density Analysis" id="aid-190861"><div class="titlepage"><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Answering Questions with Density Analysis</h1></div></div></div><p>We often need to work with large and dense datasets in which there is a lot of overplotting and features experience significant overlap. Such datasets may be very slow at rendering because they contain thousands, or even millions, of features, and very difficult to interpret because overlaps make it difficult to detect any clusters or distribution patterns. In this chapter, you will learn the techniques that allow you to visualize such datasets in a more readable and faster way by displaying feature density instead of the features themselves. By the end of this chapter, you will be able to perform density analysis of your data and extract information from density maps.</p><p>In this chapter, we will go through the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Density analysis and heat maps</li><li class="listitem">Creating heat maps with the Heatmap plugin</li><li class="listitem">Mapping density with a hexagonal grid</li></ul></div><div class="section" title="Density analysis and heatmaps"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec37"/>Density analysis and heatmaps</h1></div></div></div><p>Density maps allow visual estimation of object or event concentration over the study area. Such maps <a id="id329" class="indexterm"/>are very useful for assessment of the distribution patterns of the<a id="id330" class="indexterm"/> features over the study area. When we simply add locations of the features or events (for example, as points) to the map, we cannot see the changes in their concentration in different areas. Density analysis gives us such functionality by using uniform area characteristics, such as feature count per acre or square kilometer.</p><p>A density map gives us<a id="id331" class="indexterm"/> the ability to estimate the concentration of some features within an area. This helps us find areas where an urgent reaction is required or which match your criteria. Heatmaps also help control conditions and their changes.</p><p>Density maps are also extremely useful when mapped regions (for example, districts) have different sizes. For <a id="id332" class="indexterm"/>example, if we want to know how many people live in each district, we just need an ordinal map with the population data. According to this map, a large district may have a higher population than a smaller district. But if we want to identify the<a id="id333" class="indexterm"/> districts with a higher concentration of population, then we need a density map to see the number of people per square kilometer. And a density map will show us that, in fact, small regions with a high population density may have more people per square kilometer than larger districts.</p><p>Generally, we can show on a map the density distributions of the features themselves (for example, schools), as well as distributions of some numerical characteristics of these features (for example, the number of pupils in schools). The results will be completely different in these cases. A density map of schools can help an education department find areas where more schools are needed, while a density map created from information about the number of pupils in each school may help a transportation company to plan bus routes and to decide where to place bus stops.</p><p>The most common use case is the creation of density maps to display the density of point features. Such maps<a id="id334" class="indexterm"/> are often called <span class="strong"><strong>heat maps</strong></span>. What is a heat map? It is a raster layer. Each cell of it contains a representation of the density of features in its vicinity (for example, the number of people per square kilometer), which depends on the number of features within some area.</p><p>To create a heat map, in the<a id="id335" class="indexterm"/> simplest case, GIS looks at the features around a cell center, using a given search radius. Then the number of features that fall within the given radius is calculated and divided by the area of the region. This value will be a cell value. Then next cell will be analyzed, and so on. As a result, we will get a combination of values, which creates a smooth surface. To understand this better, refer to the following diagram:</p><div class="mediaobject"><img src="../Images/image00420.jpeg" alt="Density analysis and heatmaps"/></div><p style="clear:both; height: 1em;"> </p><p>This diagram shows the general principle of creating heat maps. The green dots depict the features used for density map generation, the blue square is a current raster cell, and the red dotted circle marks the search radius, for example, 1 km. In this case, the area covered will be about 3.14 sq. km. As we can see in the diagram to the left, four features are within the <a id="id336" class="indexterm"/>search radius. So, the raster cell will get a value of <span class="emphasis"><em>4/3.14 = 1.27</em></span>. On the right side, we notice that the next cell will get a value of 1.59 because now there are five features inside the search radius.</p><p>This is the simplest<a id="id337" class="indexterm"/> approach. In real-world applications, more complex algorithms are used, where each point has some impact on the values of the neighboring cells, depending on its distance from those cells.</p></div></div>
<div class="section" title="Creating heat maps with the Heatmap plugin"><div class="titlepage" id="aid-19UOO2"><div><div><h1 class="title"><a id="ch05lvl1sec38"/>Creating heat maps with the Heatmap plugin</h1></div></div></div><p>With the help of the QGIS core plugin called Heatmap, we can easily create heat maps from vector point data and use it for further analysis. First, we need to activate this plugin, if it has not yet been<a id="id338" class="indexterm"/> activated. After activation, it creates a submenu under the <span class="strong"><strong>Raster</strong></span> menu and places its button on the <span class="strong"><strong>Raster</strong></span> toolbar.</p><p>Let's create a density <a id="id339" class="indexterm"/>map for the <code class="literal">noise</code> layer, which contains information about complaints regarding high noise levels. This layer contains 44,397 features, and it is difficult to know which places are noisy.</p><p>Information about such places may be useful for a police department or other agencies to plan some activities for noise reduction, or for those who are looking for apartments and don't want neighbors who like playing loud music:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Start the plugin by clicking on the <span class="strong"><strong>Heatmap</strong></span> button on the <span class="strong"><strong>Raster</strong></span> panel, or by navigating to <span class="strong"><strong>Raster</strong></span> | <span class="strong"><strong>Heatmap</strong></span> | <span class="strong"><strong>Heatmap...</strong></span>.<div class="mediaobject"><img src="../Images/image00421.jpeg" alt="Creating heat maps with the Heatmap plugin"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Select the <code class="literal">noise</code> layer from the <span class="strong"><strong>Input point layer</strong></span> combobox.</li><li class="listitem">Using the <span class="strong"><strong>…</strong></span> button <a id="id340" class="indexterm"/>on the right side of the <span class="strong"><strong>Output raster</strong></span> field, specify the location in which the resulting heat map needs to be saved. Note that there is no need to<a id="id341" class="indexterm"/> specify the file extension; it will be picked up automatically, based on the output file format.</li><li class="listitem">Use the <span class="strong"><strong>Output format</strong></span> combobox to select the desired format for the heat map. The most common choice here is <span class="strong"><strong>GeoTIFF</strong></span>, but for very large maps, it is better to use something different, for example, <span class="strong"><strong>Erdas Imagine</strong></span>.</li><li class="listitem">The last thing we need to specify is <span class="strong"><strong>Radius</strong></span>. This value defines the distance from each cell up to which QGIS will look for neighbor features and take their presence into account. Generally, a bigger search radius gives a more generalized result, as the number of features found will be divided by a bigger area. A smaller radius gives more precise results, but if this value is too small, we may not find any distribution patterns. The search radius can be defined in meters or map units.</li></ol><div style="height:10px; width: 1px"/></div><p>To determine the <a id="id342" class="indexterm"/>search radius from a known area, we can use a very simple formula derived from formula for the area of a circle:</p><div class="mediaobject"><img src="../Images/image00422.jpeg" alt="Creating heat maps with the Heatmap plugin"/></div><p style="clear:both; height: 1em;"> </p><p>For example, if we <a id="id343" class="indexterm"/>need to calculate density per square kilometer, then the search radius will be as follows:</p><div class="mediaobject"><img src="../Images/image00423.jpeg" alt="Creating heat maps with the Heatmap plugin"/></div><p style="clear:both; height: 1em;"> </p><p>For more fine-grained control over the result, we can check the <span class="strong"><strong>Advanced</strong></span> box and define some additional parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>Rows</strong></span> and <span class="strong"><strong>Columns</strong></span>: These allow us to define dimensions of the output raster. Larger dimensions will result in a bigger output file size, while smaller dimensions will result in a rough and pixelated output. Input fields are linked to each other, so changing the value in the <span class="strong"><strong>Rows</strong></span> field (for example, halving it) will also cause the corresponding change to the value in the <span class="strong"><strong>Columns</strong></span> field, and vice versa. Furthermore, these values have a direct influence on the raster cell size (see the next point). It is worth mentioning that the extent of the raster preserved when changing raster dimensions.</li><li class="listitem"><span class="strong"><strong>Cell size X</strong></span> and <span class="strong"><strong>Cell size Y</strong></span>: The raster cell size determines how coarse or detailed the display of the distribution patterns will be. A smaller cell size will give smoother results, but the processing time and memory required for the analysis will increase. Large cells will be processed faster, but the resulting raster will be pixelated. If the cells are really big, some patterns will become invisible, so you may need to run the analysis several times, trying different cell sizes to get results that satisfy your requirements.<p>The cell size depends on and is linked to the raster dimensions. Increasing it will decrease the number of rows and columns, and vice versa.</p></li><li class="listitem"><span class="strong"><strong>Kernel shape</strong></span>: This<a id="id344" class="indexterm"/> controls how the point influence changes with changes in distance from this point. The QGIS Heatmap plugin currently supports the following <a id="id345" class="indexterm"/>kernels:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">quartic (also known as biweight)</li><li class="listitem">triangular</li><li class="listitem">uniform</li><li class="listitem">triweight</li><li class="listitem">Epanechnikov</li></ul></div><p>The following diagram shows the distribution of the point influence for different kernels:</p><div class="mediaobject"><img src="../Images/image00424.jpeg" alt="Creating heat maps with the Heatmap plugin"/></div><p style="clear:both; height: 1em;"> </p></li></ul></div><div class="note" title="Note"><h3 class="title"><a id="note28"/>Note</h3><p>For more details <a id="id346" class="indexterm"/>about kernel shapes, refer to the Wikipedia article at <a class="ulink" href="http://en.wikipedia.org/wiki/Kernel_(statistics)#Kernel_functions_in_common_use">http://en.wikipedia.org/wiki/Kernel_(statistics)#Kernel_functions_in_common_use</a>, and books about statistics, for example, <span class="emphasis"><em>Density Estimation for Statistics</em></span> and <span class="emphasis"><em>Data Analysis</em></span> by B. W. Silverman.</p></div><p>Depending on the kernel shape, we will get a smoother heat map, or more clearly exposed hotspots. For example, the triweight kernel will give clearer, sharper hotspots than the Epanechnikov<a id="id347" class="indexterm"/> kernel, because the Epanechnikov kernel has lower influence near the hotspot center. Also, in different scientific fields, different kernels are preferred; for example, in<a id="id348" class="indexterm"/> crime analysis, the quartic kernel is typically used.</p><p> It is also possible to use a variable search radius for each point by selecting the <span class="strong"><strong>Use radius from field</strong></span> checkbox and selecting the attribute field with radius value from the combobox. If you need to weight points (in other words, increase or decrease their influence) by some numeric attribute, activate the <span class="strong"><strong>Use weight from field</strong></span> checkbox and select the corresponding field. In our example, we will not use this functionality, but you can try it yourself.</p><p>As we said before, cell size has a direct influence on the quality of the resulting heat map, so it is important to select it carefully. In most cases, the cell size is chosen in such a way that we get 10 to 100 cells per unit area (which in turn is defined by the search radius). To calculate the cell size, we need to align area units with distance units; for example, if we calculate the density using square kilometers and define the search radius in meters, then it is necessary to convert the square kilometers to square meters. The next step is to divide the area by the desired number of cells. Finally, as the cell size is defined by its width or height (because raster cells usually have a square shape), we need to extract the square root of this value.</p><p>In our example, we will create a heat map with a search radius of 1000 m, so the lookup area will be approximately 3.14 square kilometers. When expressed in meters, this will be as follows:</p><div class="mediaobject"><img src="../Images/image00425.jpeg" alt="Creating heat maps with the Heatmap plugin"/></div><p style="clear:both; height: 1em;"> </p><p>As we want a smooth heat map, we will use a relatively large number of cells per unit area; let's say 100 cells per 3.14 square kilometers. So, we divide the area in square meters by the desired cell count:</p><div class="mediaobject"><img src="../Images/image00426.jpeg" alt="Creating heat maps with the Heatmap plugin"/></div><p style="clear:both; height: 1em;"> </p><p>Finally, we calculate the square root of this value to get the cell size that allows us to have 100 cells per 3.14 square kilometers:</p><div class="mediaobject"><img src="../Images/image00427.jpeg" alt="Creating heat maps with the Heatmap plugin"/></div><p style="clear:both; height: 1em;"> </p><p>Of course this is not a strict rule but just a recommendation. You can safely use another cell size, depending on your data and the desired results. Just remember that smaller values lead to smoother heat maps, but at the same time increase the analysis time and output raster size.</p><p>When all the<a id="id349" class="indexterm"/> inputs and parameters are set, press the <span class="strong"><strong>OK</strong></span> button to start the process of the heat map generation. The progress of the heat map formation will be displayed in a small progress dialog. If this process is taking too long time to complete, you can interrupt it by pressing the <span class="strong"><strong>Abort</strong></span> button. Note that after aborting heat map generation, you still get the output, but it will be incomplete and not useful for further analysis.</p><p>When the process <a id="id350" class="indexterm"/>completes, the generated heat map will be added to QGIS as a grayscale raster, where lighter regions correspond to higher density values and darker regions correspond to lower density values, like this:</p><div class="mediaobject"><img src="../Images/image00428.jpeg" alt="Creating heat maps with the Heatmap plugin"/></div><p style="clear:both; height: 1em;"> </p><p>To improve<a id="id351" class="indexterm"/> readability and make it look like real heat map, we need to change its style. To do this, follow the next steps. For more detailed information about styling raster layers, refer to the <span class="emphasis"><em>Developing styles for raster layers</em></span> section of <a class="link" title="Chapter 2. Visualizing and Styling the Data" href="part0021.xhtml#aid-K0RQ1">Chapter 2</a>, <span class="emphasis"><em>Visualizing and Styling the Data</em></span>:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Right-click<a id="id352" class="indexterm"/> on the <code class="literal">heatmap</code> layer in the QGIS layer tree. In the context menu, select <span class="strong"><strong>Properties</strong></span>.</li><li class="listitem">Go to the <span class="strong"><strong>Style</strong></span> tab and select <span class="strong"><strong>Singleband pseudocolor</strong></span> as <span class="strong"><strong>Render type</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>Load min/max values</strong></span> group, activate the <span class="strong"><strong>Min/max</strong></span> options. Set <span class="strong"><strong>Extent</strong></span> to <span class="strong"><strong>Full</strong></span> and <span class="strong"><strong>Accuracy</strong></span> to <span class="strong"><strong>Actual (slower)</strong></span>. Press the <span class="strong"><strong>Load</strong></span> button to get raster statistics. This will be used for further classification.</li><li class="listitem">Select a suitable color ramp in the <span class="strong"><strong>Generate new color map</strong></span> group, for example, <code class="literal">YlOrBr</code> (which changes colors from yellow to orange and then brown), or <code class="literal">Reds</code> (which uses different shades of red). If necessary, change the number of classes and click on the <span class="strong"><strong>Classify</strong></span> button.</li><li class="listitem">Click on <span class="strong"><strong>OK</strong></span> to apply the changes and close the properties dialog.</li></ol><div style="height:10px; width: 1px"/></div><p>Now we can easily locate the hottest points (displayed in colors closer to red if the <code class="literal">Reds</code> color map is used), and even recognize some distribution patterns that were not visible when we looked at the original point layer:</p><div class="mediaobject"><img src="../Images/image00429.jpeg" alt="Creating heat maps with the Heatmap plugin"/></div><p style="clear:both; height: 1em;"> </p><p>Now we can <a id="id353" class="indexterm"/>easily locate the hottest points (displayed in colors closer to red if the <code class="literal">Reds</code> color map is used), and even recognize some<a id="id354" class="indexterm"/> distribution patterns that were not visible when we looked at the original point layer. Also, our heatmap layer showed up much faster than the vector which is used to create this heat map.</p><div class="section" title="Detecting the &quot;hottest&quot; regions"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec40"/>Detecting the "hottest" regions</h2></div></div></div><p>Sometimes, you<a id="id355" class="indexterm"/> don't need the heat map itself, but just want to find the hotspots—areas with the highest density—and use them in further analysis. It is pretty easy to find such regions in QGIS and extract them in the vector form.</p><p>First, we should define threshold value, which will be used to recognize the hotspots. As a starting value, we can use the maximum pixel value in our heat map and then adjust it as per our needs.</p><p>The simplest way to find the maximum pixel value is to use the <span class="strong"><strong>Identify Features</strong></span> tool. Select a layer in the QGIS layer tree, activate the <span class="strong"><strong>Identify Features</strong></span> tool, click on the most visually "hottest" regions, and look at the reported value. With our heat map, this will be <code class="literal">540.32</code>.</p><p>If we will use this value as is, we cannot find all the important clusters, so this value should be reduced first. The smaller the selected value (in comparison with the maximum value), the larger<a id="id356" class="indexterm"/> the number of clusters found. The area of separate clusters will also grow. For our example, we choose a value of <code class="literal">200</code>.</p><p>Now, open <span class="strong"><strong>Raster Calculator</strong></span> from the <span class="strong"><strong>Raster</strong></span> menu, specify a path where the output file should be saved in the <span class="strong"><strong>Output layer</strong></span> field, and enter the <code class="literal">"heatmap@1"&gt;=200</code> formula in the <span class="strong"><strong>Raster calculator expression</strong></span> field, like this:</p><div class="mediaobject"><img src="../Images/image00430.jpeg" alt="Detecting the &quot;hottest&quot; regions"/></div><p style="clear:both; height: 1em;"> </p><p>This formula is used to create a so-called mask. If the pixel value of the input layer is greater or equal to our threshold value of <code class="literal">200</code>, then the output pixel value will be <code class="literal">1</code>. Otherwise, it will be <code class="literal">0</code>. So, our output raster will be a binary raster, with only two pixel values—<code class="literal">0</code> and <code class="literal">1</code>—which is very easy to convert to a vector.</p><p>Leave all other values unchanged <a id="id357" class="indexterm"/>so that the resulting raster will have exactly the same dimensions and cell size as the input one. Press the <span class="strong"><strong>OK</strong></span> button to start the calculation. When it is done, a new black-and-white raster layer will be added to the QGIS canvas, as shown here:</p><div class="mediaobject"><img src="../Images/image00431.jpeg" alt="Detecting the &quot;hottest&quot; regions"/></div><p style="clear:both; height: 1em;"> </p><p>To convert the mask raster into vector format, we need to create polygons from all connected pixels with the same value. This is where the <span class="strong"><strong>Polygonize</strong></span> tool comes to help. In the <span class="strong"><strong>Processing</strong></span> toolbox, you can find the <span class="strong"><strong>Polygonize</strong></span> algorithm by typing its name in the filter field at the top of the toolbox. Double-click on the algorithm name to open its dialog, and you will see something like this:</p><div class="mediaobject"><img src="../Images/image00432.jpeg" alt="Detecting the &quot;hottest&quot; regions"/></div><p style="clear:both; height: 1em;"> </p><p>Select the mask layer that was previously created as <span class="strong"><strong>Input layer</strong></span>, specify the path where the result will be saved using the <span class="strong"><strong>Output layer</strong></span> field, and click on the <span class="strong"><strong>Run</strong></span> button to start the algorithm. When it is done, a new vector layer will be added to QGIS. This layer has an attribute called <code class="literal">DN</code> (if you did not change it) that indicates the pixel value of each polygon in the layer. So, all <a id="id358" class="indexterm"/>we need to do is remove all the features that have the attribute value equal to zero. The remaining features will be the hotspots.</p><p>To delete unnecessary features from the hotspots layer, select it in the QGIS layer tree, right-click to open the context menu, and select <span class="strong"><strong>Open Attribute Table</strong></span>. Click on the <span class="strong"><strong>Select features using an expression</strong></span> button. In the <span class="strong"><strong>Select by expression</strong></span> dialog, enter <code class="literal">"DN" = 0</code> (if necessary, replace <code class="literal">DN</code> with your field name), click on the <span class="strong"><strong>Select</strong></span> button, and close the dialog. Start editing by clicking on the <span class="strong"><strong>Toggle editing mode</strong></span> button, or press <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>E</em></span>. To remove the selected features, press the <span class="emphasis"><em>Delete</em></span> key or click on <span class="strong"><strong>Delete selected features</strong></span>. Finally, turn editing mode off by pressing <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>E</em></span> or clicking on <span class="strong"><strong>Toggle editing mode</strong></span> again.</p><div class="mediaobject"><img src="../Images/image00433.jpeg" alt="Detecting the &quot;hottest&quot; regions"/></div><p style="clear:both; height: 1em;"> </p><p>Now, the hotspots layer contains only hotspot polygons, which can be used for further analysis. For example, we can combine this cluster with information about the nearest buildings and noise<a id="id359" class="indexterm"/> types to find dependencies and develop some suggestions for reducing the noise levels there.</p></div><div class="section" title="Looking for distribution patterns with contour lines"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec41"/>Looking for distribution patterns with contour lines</h2></div></div></div><p>Apart from<a id="id360" class="indexterm"/> detecting hotspots, heat maps can also be used to detect intensity changes or visualize the direction of value changes. The most common way to do both of these tasks is contour lines generation.</p><p>Fortunately, QGIS has all the<a id="id361" class="indexterm"/> necessary tools for this. We will use processing again, but contour lines generation is also available in the <span class="strong"><strong>GDALTools</strong></span> plugin (which can be found in the <span class="strong"><strong>Raster</strong></span> menu). In the <span class="strong"><strong>Processing</strong></span> toolbox, you can find the <span class="strong"><strong>Contour</strong></span> algorithm by typing its name in the filter field at the top of the toolbox. Double-click on the algorithm name to open its dialog, which looks like this:</p><div class="mediaobject"><img src="../Images/image00434.jpeg" alt="Looking for distribution patterns with contour lines"/></div><p style="clear:both; height: 1em;"> </p><p>Select the <code class="literal">heatmap</code> raster layer as <span class="strong"><strong>Input layer</strong></span>. In the <span class="strong"><strong>Output file</strong></span> field, specify the path where the results will be saved. Also, it is necessary to define <span class="strong"><strong>Interval between contour lines</strong></span>. There<a id="id362" class="indexterm"/> are no strict principles about determining this interval. The general rule is to select such an interval that detects <a id="id363" class="indexterm"/>patterns in the areas with smooth density changes. We will select an interval of <code class="literal">10</code>.</p><p>When all of the necessary information has been defined, click on <span class="strong"><strong>Run</strong></span> to start the contour line generation. After some time, a new polygonal vector layer will be added to QGIS, and we can start analyzing it. First, if necessary, move the contours layer to the top of the heat map in the QGIS layer tree. Also, it is better to adjust contours' symbology to make them more recognizable against the background of the heat map.</p><div class="mediaobject"><img src="../Images/image00435.jpeg" alt="Looking for distribution patterns with contour lines"/></div><p style="clear:both; height: 1em;"> </p><p>More dense contours correspond to more intense density changes. Also, we can identify the direction of <a id="id364" class="indexterm"/>changes in noise. For<a id="id365" class="indexterm"/> example, in the preceding screenshot, we can see that in some places, the noise distribution around the center is not equal; the intensity reduces more quickly in the southeast than in the northwest. So, we may assume that there are some obstacles to noise there.</p></div></div>
<div class="section" title="Mapping density with a hexagonal grid"><div class="titlepage" id="aid-1AT9A2"><div><div><h1 class="title"><a id="ch05lvl1sec39"/>Mapping density with a hexagonal grid</h1></div></div></div><p>There is also another <a id="id366" class="indexterm"/>approach of mapping density, called binning. Generally speaking, binning is a technique of grouping <span class="emphasis"><em>N</em></span> values/features into <span class="emphasis"><em>M</em></span> groups, where <span class="emphasis"><em>M &lt; N</em></span>. The result of such an operation can be interpreted as a<a id="id367" class="indexterm"/> two-dimensional histogram.</p><p>Binning is an alternative to heat maps, not a replacement. The choice of the method depends on the requirements and further usage of the results. It is, however, worth mentioning that binning produces a vector output, while a heat map produces a raster output.</p><p>In general, binning can be described in two simple steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a hexagonal grid on top of the point layer.</li><li class="listitem">Count the number of points in each grid cell.</li></ol><div style="height:10px; width: 1px"/></div><p>In this section, you will learn how to use this technique in QGIS in the example of hexbinning, in other words, mapping density with a hexagonal grid.</p><div class="note" title="Note"><h3 class="title"><a id="note29"/>Note</h3><p>In fact, for binning, we can use not only hexagons but also other shapes that allow regular tessellation of a 2D surface—triangles and rectangles.</p></div><p>Why do we choose hexagons? Well, because a hexagon is closest to a circle among all shapes that tessellate. As a result, they represent curves more naturally. Another advantage of hexagons is a more compact structure, so the distance between cell centers in a hexagonal grid is lower than in a rectangular grid. So data aggregation around the cell center is more efficient.</p><div class="note" title="Note"><h3 class="title"><a id="note30"/>Note</h3><p>In <a class="link" title="Chapter 8. Automating Analysis with Processing Models" href="part0062.xhtml#aid-1R42S1">Chapter 8</a>, <span class="emphasis"><em>Automating Analysis with Processing Models</em></span>, we will create a model that produces two density maps: hexagonal and rectangular, so that you can compare them side by side and better understand their differences and use cases.</p></div><p>In the upcoming sections, we will create a density map using this approach. For this exercise, we will use data from Brooklyn's street tree census. This is the <code class="literal">trees</code> layer in our map.</p><div class="section" title="Creating a hexagonal grid"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec42"/>Creating a hexagonal grid</h2></div></div></div><p>To create a<a id="id368" class="indexterm"/> hexagonal grid, we will use the QGIS Processing framework and its algorithm called <span class="strong"><strong>Create grid</strong></span>:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the <span class="strong"><strong>Processing</strong></span> toolbox, find the <span class="strong"><strong>Create grid</strong></span> algorithm by typing its name in the filter field at the top of the toolbox. Double-click on the algorithm name to open its dialog, which looks like this:<div class="mediaobject"><img src="../Images/image00436.jpeg" alt="Creating a hexagonal grid"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">In the <span class="strong"><strong>Grid type</strong></span> combobox, select <span class="strong"><strong>Hexagon (polygon)</strong></span>.</li><li class="listitem">To specify grid extent press the <span class="strong"><strong>…</strong></span> button on the right side of the <span class="strong"><strong>Grid extent</strong></span> field and choose <span class="strong"><strong>Use layer/canvas extent</strong></span> from the menu.</li><li class="listitem">The <span class="strong"><strong>Select extent</strong></span> dialog will pop up. Use it to select the <code class="literal">trees</code> layer from the combobox, and click on <span class="strong"><strong>OK</strong></span>. The coordinates of the <code class="literal">layer</code> extent will be added to the field.</li><li class="listitem">Set <code class="literal">1000</code> as the horizontal and vertical spacing. These values have the same meaning as the search radius in the case of heat maps. Grid spacing determines how many cells will be in a grid and how smooth the resulting map will be. A smaller spacing produces smoother results, but very small values prevent us from identifying any distribution patterns. Note that the spacing <a id="id369" class="indexterm"/>should be specified in the same units as used by layer; for example, if a layer CRS uses feet as units, then the spacing should be in feet too.</li><li class="listitem">Finally, in the <span class="strong"><strong>Output</strong></span> field, specify the path where the resulting grid will be saved and click on <span class="strong"><strong>Run</strong></span> to create the grid. When the algorithm execution completes, a new polygonal layer will be added to QGIS.</li></ol><div style="height:10px; width: 1px"/></div></div><div class="section" title="Counting points in grid cells"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec43"/>Counting points in grid cells</h2></div></div></div><p>To calculate the number of<a id="id370" class="indexterm"/> features inside each grid cell, we can use fTools or Processing core plugins. The latter is more flexible and allows us to automate tasks, as described in <a class="link" title="Chapter 8. Automating Analysis with Processing Models" href="part0062.xhtml#aid-1R42S1">Chapter 8</a>, <span class="emphasis"><em>Automating Analysis with Processing Models</em></span>. We will use the <span class="strong"><strong>Count points in polygon</strong></span> algorithm from the Processing framework.</p><div class="note" title="Note"><h3 class="title"><a id="tip21"/>Tip</h3><p>There is also a <span class="strong"><strong>Count unique points</strong></span> algorithm in Processing that lets us count only points with unique attributes in the selected field. This may be useful when a more precise analysis is needed, for example, for mapping diversity.</p></div><p>In the Processing toolbox, find the <span class="strong"><strong>Count points in polygon</strong></span> algorithm by typing its name in filter field at the top of the toolbox. Double-click on the algorithm name to open its dialog, and you will see this:</p><div class="mediaobject"><img src="../Images/image00437.jpeg" alt="Counting points in grid cells"/></div><p style="clear:both; height: 1em;"> </p><p>Select the grid layer created in the previous section as <span class="strong"><strong>Polygons</strong></span> and the <code class="literal">trees</code> layer as <span class="strong"><strong>Points</strong></span>. Enter <span class="strong"><strong>Count field name</strong></span> or leave it unchanged. Don't forget the 10-character limitation for the shapefile field names! Finally, in the <span class="strong"><strong>Result</strong></span> field, specify the location where the resulting layer will be stored, and click on the <span class="strong"><strong>Run</strong></span> button to start the analysis. Keep in mind that<a id="id371" class="indexterm"/> this may take some time, as the <code class="literal">tree</code> layer contains many features and the grid size is relatively small.</p><p>When an algorithm execution completes, a new grid layer, containing the field with the number of points in each cell, will be added to QGIS. We can safely remove the original grid layer from QGIS and from the filesystem, as it is no longer needed.</p><p>For better visual representation of our data, we apply a graduated renderer to style cells according to the number of features in them. If necessary, go back to the <span class="emphasis"><em>Developing styles for vector layers</em></span> section of <a class="link" title="Chapter 2. Visualizing and Styling the Data" href="part0021.xhtml#aid-K0RQ1">Chapter 2</a>, <span class="emphasis"><em>Visualizing and Styling the Data</em></span>. The result may look like this:</p><div class="mediaobject"><img src="../Images/image00438.jpeg" alt="Counting points in grid cells"/></div><p style="clear:both; height: 1em;"> </p></div><div class="section" title="Removing redundant data"><div class="titlepage"><div><div><h2 class="title"><a id="ch05lvl2sec44"/>Removing redundant data</h2></div></div></div><p>If we look carefully<a id="id372" class="indexterm"/> at our grid layer and its attribute table, we will see that some grid cells are empty; there are no points in them. Such cells displayed with a very light green color in the preceding screenshot. It is clear that the empty cells are much more than the nonempty cells. Of course, we can simply hide such empty cells by assigning to them the same color as the map background, or by removing them from the renderer (assigning an empty style). But, is it better to remove them completely and reduce the file size?</p><p>There are two possible ways to remove empty cells: manually or by using one of the existing tools from the Processing toolbox. Each method has own advantages.</p><p>First, you will learn how to remove redundant data manually. This method can be used when you need to process only one layer and don't want to create any temporary intermediate files. Also, it allows you to easily examine the features that will be removed. Let's do it:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select the <code class="literal">LAYER</code> layer from the QGIS layer tree. Then, click on the <span class="strong"><strong>Select features using an expression</strong></span> button in the <span class="strong"><strong>Attributes</strong></span> toolbar to open the <span class="strong"><strong>Select by expression</strong></span> dialog.<div class="mediaobject"><img src="../Images/image00439.jpeg" alt="Removing redundant data"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">In the functions tree, under the <span class="strong"><strong>Fields and Values</strong></span> group, find the <code class="literal">NUMPOINTS</code> field and double-click on it to add its name to the expression.</li><li class="listitem">Then, click on <span class="strong"><strong>=</strong></span> to add the equal to operator to the expression, and type <code class="literal">0</code> after it. The final expression will look like <span class="strong"><strong>"NUMPOINTS" = 0</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Select</strong></span> to select all the features that match your condition. The selected features will be highlighted in yellow so that you can check whether they are<a id="id373" class="indexterm"/> what you want.</li><li class="listitem">Now, close the <span class="strong"><strong>Select by expression</strong></span> dialog and open the layer attribute table by clicking on the <span class="strong"><strong>Open Attribute Table</strong></span> button in the <span class="strong"><strong>Attributes</strong></span> toolbar.</li><li class="listitem">Toggle editing mode by clicking on the corresponding button in the attribute table dialog, or by simply pressing <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>E</em></span>.</li><li class="listitem">To remove the selected features, just press the <span class="emphasis"><em>Delete</em></span> key or click on the <span class="strong"><strong>Delete selected features</strong></span> button.</li><li class="listitem">Finally, turn editing mode off by pressing <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>E</em></span> again. Now our layer contains only nonempty cells and is much smaller in size.</li></ol><div style="height:10px; width: 1px"/></div><p>Deleting redundant data with Processing requires fewer steps than removing redundant data manually, but instead of updating the existing layer, it creates another file. The Processing framework is useful when you need to process many<a id="id374" class="indexterm"/> layers at once or want to automate some operations. To remove empty cells, we can use the <span class="strong"><strong>Extract by attribute</strong></span> algorithm.</p><div class="note" title="Note"><h3 class="title"><a id="tip22"/>Tip</h3><p>In our case, the comparison condition is very simple, so we use the <span class="strong"><strong>Extract by attribute</strong></span> algorithm. When a more complex comparison condition that includes several attributes or some calculations is needed, it is better to use the <span class="strong"><strong>Select by expression</strong></span> algorithm in combination with <span class="strong"><strong>Save selected features</strong></span>.</p></div><div class="mediaobject"><img src="../Images/image00440.jpeg" alt="Removing redundant data"/></div><p style="clear:both; height: 1em;"> </p><p>Here are the necessary steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Find the <span class="strong"><strong>Extract by attribute</strong></span> algorithm by typing its name in the filter field, and double-click on its name to open its dialog.</li><li class="listitem">In the <span class="strong"><strong>Input layer</strong></span> combobox, select <code class="literal">LAYER</code>.</li><li class="listitem">In the <span class="strong"><strong>Selection attribute</strong></span> combobox, select the <code class="literal">NUMPOINTS</code> field, which stores the<a id="id375" class="indexterm"/> point count in each cell.</li><li class="listitem">In the <span class="strong"><strong>Operator</strong></span> combobox select the not equal operator !<code class="literal">=</code>.</li><li class="listitem">Enter <code class="literal">0</code> in the <span class="strong"><strong>Value</strong></span> field.</li><li class="listitem">Specify the name of the output file in the <span class="strong"><strong>Output</strong></span> field.</li></ol><div style="height:10px; width: 1px"/></div><p>Now, we can press the <span class="strong"><strong>Run</strong></span> button to start processing. When it is done, the new layer, with empty cells removed, will be added to QGIS, and we can remove the original layer. The new layer is much smaller, but still contains all of the information. Also, we can now set up styles more precisely and identify some distribution patterns that were not visible earlier.</p><div class="mediaobject"><img src="../Images/image00441.jpeg" alt="Removing redundant data"/></div><p style="clear:both; height: 1em;"> </p><p>If we overlay a layer that has a street network with this density map, we can easily identify that<a id="id376" class="indexterm"/> the greenest street is the Ocean Parkway.</p><p>The result looks great, but performing all of these steps manually is not very comfortable. Also, there are a number of intermediate layers that can, and should, be removed. Fortunately, QGIS allows us to automate such operations with the Processing Graphical Modeler. Refer to <a class="link" title="Chapter 8. Automating Analysis with Processing Models" href="part0062.xhtml#aid-1R42S1">Chapter 8</a>, <span class="emphasis"><em>Automating Analysis with Processing Models</em></span>, to learn how to create models and use them.</p></div></div>
<div class="section" title="Summary" id="aid-1BRPS1"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec40"/>Summary</h1></div></div></div><p>In this chapter, we covered the analysis of dense-point datasets. You learned how to create raster heat maps with the help of the QGIS Heatmap plugin. Then, we covered analysis of heat maps and data extraction from them.</p><p>You also familiarized yourself with an alternative and popular technique for displaying dense datasets, called binning, and you learned how to perform hexbinning (a kind of binning technique) in QGIS using the Processing framework.</p></div></body></html>