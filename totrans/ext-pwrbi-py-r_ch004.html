<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="en-US">
<head>
<meta charset="utf-8"/>
<meta name="generator" content="packt"/>
<title>3 Configuring Python with Power BI</title>
<link rel="stylesheet" type="text/css" href="../styles/stylesheet1.css"/>
<link rel="stylesheet" type="text/css" href="../styles/stylesheet2.css"/>

</head>
<body>

<section id="configuring-python-with-power-bi" class="level1 pkt" data-number="4">
<h1 data-number="4">3 Configuring Python with Power BI</h1>
<p>Just as in <em>Chapter 2, Configuring R with Python</em>, you had to install the R engines in order to interact with Power BI, in the same way you will also have to install the Python engines on your machine. You'll also see how to configure some IDEs so you can develop and test Python code comfortably before using it in Power BI. Therefore, similar to what we have already seen in <em>Chapter 2</em>, <em>Configuring R with Python</em>, the following topics will be discussed in this chapter:</p>
<ul>
<li>The available Python engines</li>
<li>Which Python engine should I install?</li>
<li>Installing an IDE for Python development</li>
<li>Configuring Power BI Desktop to work with Python</li>
<li>Configuring the Power BI service to work with Python</li>
<li>Limitations of Python visuals</li>
</ul>
<section id="technical-requirements-2" class="level2" data-number="4.1">
<h2 data-number="4.1">Technical requirements</h2>
<p>This chapter requires you to have a working internet connection and <strong>Power BI Desktop</strong> already installed on your machine. The last part of the chapter also requires you to be signed up for the Power BI service (here’s a how-to: <a href="http://bit.ly/signup-powerbiservice">http://bit.ly/signup-powerbiservice</a>). A <strong>Power BI free</strong> license is enough to test all the code in this book, as you will share reports only in your personal <strong>workspace</strong>.</p>
</section>
<section id="the-available-python-engines" class="level2" data-number="4.2">
<h2 data-number="4.2">The available Python engines</h2>
<p>As with R, there are several distributions you can install for Python: <strong>standard Python</strong>, <strong>ActivePython</strong>, <strong>Anaconda</strong>, and so on. Typically, “pure” developers download the latest version of the Python engine from <a href="https://www.python.org/">https://www.python.org/</a>, and then install various community-developed packages useful for their projects from the <strong>Python Package Index</strong> (<strong>PyPI</strong>). Other vendors, such as ActiveState and Anaconda, pre-package a specific version of the Python engine with a set of packages for the purpose of accelerating a project's startup. While the standard Python and ActiveState distributions are more aimed at general-purpose developers, Anaconda is the distribution preferred by data scientists and by those who work more closely with machine learning projects. In turn, Anaconda comes in two distinct distributions itself: Anaconda and <strong>Miniconda</strong>.</p>
<p>The Anaconda distribution, with its more than 150 included packages, can be considered to be the best do-it-yourself supermarket for data scientists, where everything is ready and configured to be used. The Miniconda distribution, on the other hand, is considered the minimum indispensable toolbox for the data scientist seeking to trim the resources to the right level.</p>
<p>But there is one fundamental tool that Anaconda and Miniconda have in common: it is <strong>Conda</strong>, one of the most popular package managers for Python. Conda provides the developer with an easy-to-use system for the management of so-called <strong>virtual environments</strong>. A virtual environment, or <strong>environment</strong> for short, aims to encapsulate the installation of a Python engine with a set of version-specific packages. The goal is to create an isolated environment, often associated with a project or task, that can guarantee the <strong>reproducibility of results</strong>. This is a very important concept, essential to ensure that Python projects run smoothly when dealing with a large community of developers who create and maintain their own packages independently of each other.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Contrary to what you saw in <em>Chapter 2, Configuring R with Power BI</em>, the Python community does not have a "time machine" available that easily references a specific version of the Python engine at its release date and a snapshot of the entire ecosystem of PyPI packages at the versions they were at on that date. It is up to you to build your own "time capsules" using environments in order to ensure the reproducibility of your code.</p>
</blockquote>
<p>Conda is a very versatile tool. Besides managing the environments, it can also install various packages (regardless of the programming language used, not only Python), carefully managing all their dependencies. But the official recommended tool for installing Python packages from PyPI is <strong>pip</strong>, which only installs packages written in Python and is generally installed together with the Python engine.</p>
<p>That said, beyond the extent of the "bodywork" mounted around the Python engine, the various Python distributions do not add features that dramatically improve engine performance, unlike what we saw in <em>Chapter 2, Configuring R with Power BI</em>, with Microsoft R engines. For this reason, we won't go into detail about the features installed by each distribution.</p>
</section>
<section id="choosing-a-python-engine-to-install" class="level2" data-number="4.3">
<h2 data-number="4.3">Choosing a Python engine to install</h2>
<p>Back to our scenario, to develop Python code for use in Power Query or Python visuals, what you need for sure is the following:</p>
<ul>
<li>A Python engine</li>
<li>A package manager, to install the minimum number of packages needed to transform the data or visualize it appropriately</li>
</ul>
<p>To select the products that best suit your needs, you will need to understand your Power BI requirements in more detail.</p>
<section id="the-python-engines-used-by-power-bi" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1">The Python engines used by Power BI</h3>
<p>Just as with R visuals in the Power BI service, the following note applies to Python visuals.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>The Python engine and packages used by the Power BI service for <strong>Python visuals</strong> are preinstalled on the cloud and therefore the user must adapt to the versions adopted by the service.</p>
</blockquote>
<p>As you can imagine, the version of the engine adopted by the Power BI service is a bit behind the latest release (now 3.9.1). See the following note for more details.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>To date, the Power BI service relies on the <strong>Python 3.7.7</strong> runtime when implementing a Python visual. It is important to always keep an eye on the version of the Python engine and packages provided by the Power BI service with each release to ensure that the reports to be published work properly. See the following link for more information: <a href="http://bit.ly/powerbi-python-limits">http://bit.ly/powerbi-python-limits</a>.</p>
</blockquote>
<p>The behavior of the Power BI service is the same as that we’ve already seen for the R script in the case of doing data transformation in Power Query.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>The Python engine used by the Power BI service during the data refresh phase for <em>Python scripts in Power Query</em> has to be installed on any machine of your choice outside the service, and on that same machine you have to install the <strong>on-premises data gateway</strong> in <strong>personal mode</strong>. Note that you must use external engines even if the data to be refreshed does not flow through the gateway, but comes from data sources not referenced by the gateway itself.</p>
</blockquote>
<p>As long as the Python environment to be referenced via the data gateway is the base one, it is sufficient that both are installed on the same machine. Otherwise, the following note applies.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>If you need to <em>use multiple environments</em> installed on the machine for your Power Query transformations, you must <em>also install Power BI Desktop</em>. It allows you to switch the routing of the data gateway to the selected environment through its options, updating the configuration file at <code>C:\Users\&lt;your-username&gt;\AppData\Local\PowerBIScripting\PythonSettings.xml</code>. This file allows the overriding of the Python environment referenced by the data gateway by default.</p>
</blockquote>
<p>In a nutshell, regardless of whether you want to run R or Python scripts, the infrastructure required by Power BI Desktop and the Power BI service is managed in the same way. Therefore, again, if you need to do reports <em>for personal use on your desktop</em>, you have no limitations on which Python engine to use, so you can install the Python versions and packages that suit you best. If, on the other hand, you know in advance that the reports you will create <em>contain Python visuals and are intended to be shared with colleagues</em> on the Power BI service, then there are strict limitations on both the version and the packages pre-installed in the service.</p>
<p>But let's get down to business and start installing the Python stuff!</p>
</section>
<section id="installing-the-suggested-python-engines" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2">Installing the suggested Python engines</h3>
<p>Managing dependencies of Python scripts injected inside reports can be complex in the long run. Keeping in mind that it is possible to create multiple environments on the same machine, we suggest the following tip.</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>We recommend that you <em>dedicate a machine</em> to run only the Python engines used by Power BI reports. Our suggestion is to create a Python environment for each possible need that may arise when developing Python scripts in Power Query or for Python visuals. If you have already prepared a machine dedicated to running R scripts, as seen in <em>Chapter 2, Configuring R with Power BI</em>, then you could use the same machine to install Python engines on as well. Keep in mind that in this case, you need to make sure that the resources of the machine are sufficient to run all the engines and to satisfy the various requests coming from the various reports.</p>
</blockquote>
<p>Let's first install the latest version of the Python engine, to be used for data transformation.</p>
<section id="the-python-engine-for-data-transformation" class="level4" data-number="4.3.2.1">
<h4 data-number="4.3.2.1">The Python engine for data transformation</h4>
<p>Surely, to enrich your reports using Python, you won't need 150 pre-installed packages. Also, in order to easily manage your environments, Conda is a tool to include in your arsenal. Bearing in mind that the engine we are about to install will be used as an external Python engine by the Power BI service to transform data via Power Query through the on-premises data gateway in personal mode, the following tip applies.</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>We suggest adopting the latest version of <strong>Miniconda</strong> as the default distribution. This is because, besides pre-installing very few packages giving you the possibility to choose which packages to install, it also includes Conda in the distribution.</p>
</blockquote>
<p>The installation of Miniconda is very simple:</p>
<ol>
<li>Go to <a href="https://docs.conda.io/en/latest/miniconda.html">https://docs.conda.io/en/latest/miniconda.html</a>.</li>
<li><p>Click on the latest version available for your OS (3.8 as of the time of writing):</p>
<figure>
<img src="../media/file38.png" alt="Figure 3.1 – Download the latest version available of Miniconda" /><figcaption aria-hidden="true">Figure 3.1 – Download the latest version available of Miniconda</figcaption>
</figure></li>
<li>Once the file is downloaded, double-click on it, click <strong>Next</strong> on the welcome windows that pops up, and then click on <strong>I Agree</strong> to accept the License Agreement.</li>
<li>In the next window you'll be asked if you want to install Miniconda just for you or for other users as well. Leave the default setting (only for you) and click <strong>Next</strong>.</li>
<li>Leave the default folder for the installation on the next screen and click <strong>Next</strong>. Keep in mind that the installation route is in this form: <code>C:\Users\&lt;your-username&gt;\miniconda3</code>.</li>
<li><p>In the next window, check <strong>Register Miniconda3 as my default Python 3.8</strong> and click <strong>Install</strong>:</p>
<figure>
<img src="../media/file39.png" alt="Figure 3.2 – Set Miniconda as your default Python 3.8 engine" /><figcaption aria-hidden="true">Figure 3.2 – Set Miniconda as your default Python 3.8 engine</figcaption>
</figure></li>
<li>At the end of the installation, an <strong>Installation Complete</strong> window will inform you that the installation was completed successfully. Then, click <strong>Next</strong>.</li>
<li>The last screen gives you the possibility to open documents containing tips and resources to start working with Miniconda. You can unflag the two options and click <strong>Finish</strong>.</li>
</ol>
<p>And that's it! Now you are ready to write and run your Python code with Miniconda.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>Usually, the Power BI Desktop installation on which you develop reports is located on a separate machine from the one selected as the Power BI service Python engine machine, where the data gateway is also often installed. In that case, you must also install Miniconda on the machine on which your Power BI Desktop is installed.</p>
</blockquote>
<p>At the end of the installation, under the <strong>Anaconda3 (64-bit)</strong> folder in the Start menu, you will find shortcuts to two command-line interfaces (the standard <strong>Command Prompt</strong> and <strong>PowerShell</strong>), which ensure that you can activate <strong>Conda</strong> behind the scenes and interact with the tools provided by Miniconda:</p>
<figure>
<img src="../media/file40.png" alt="Figure 3.3 – Anaconda prompts that are useful for interacting with Miniconda" /><figcaption aria-hidden="true">Figure 3.3 – Anaconda prompts that are useful for interacting with Miniconda</figcaption>
</figure>
<p>Our favorite command line is the <strong>Anaconda Prompt</strong> and we'll show you how to use it very shortly.</p>
<p>As we said in the <em>The available Python engines</em> section, both <strong>conda</strong> and <strong>pip</strong> are very good package managers. As a package dependency solver, conda is better, although a bit slower than pip. But the reason pip is often used as a package manager is that it pulls packages directly from PyPI, which is a far more complete repository than Anaconda’s one. For the same reason, <em>we will also use pip as our default package manager</em>.</p>
</section>
<section id="creating-an-environment-for-data-transformations" class="level4" data-number="4.3.2.2">
<h4 data-number="4.3.2.2">Creating an environment for data transformations</h4>
<p>Contrary to what you have seen for R engines, for which two separate installations of two engines with different versions have been done, in the case of Python the installation is unique and <em>only the environments vary</em>.</p>
<p>Here, we will create an environment dedicated to data transformations and containing the latest version of Python made available by Miniconda and a small number of packages essential to make the first transformations.</p>
<p>First of all, you have to find the most recent version of Python present in the distribution you just installed:</p>
<ol>
<li>Open Anaconda Prompt from the Start menu as shown previously.</li>
<li>If the prompt has small fonts, just right click on its title bar, select <strong>Options</strong> and then change the fonts as you like in the <strong>Font</strong> tab.The first thing to notice is the word <strong>(base)</strong> before the current path. The string before the path indicates <em>the name of the current environment</em>. The <strong>base</strong> environment is the default environment created during the installation of the Miniconda distribution.</li>
<li>Enter the <code>conda search python</code> command and press <em>Enter</em>.</li>
<li><p>You will see the list of available Python versions:</p>
<figure>
<img src="../media/file41.png" alt="Figure 3.4 – List of all the available Python versions" /><figcaption aria-hidden="true">Figure 3.4 – List of all the available Python versions</figcaption>
</figure>
<p>The latest version available in our case is <strong>3.9.1</strong>.</p></li>
</ol>
<p>Once we have found the latest version of Python available, we can create our environment dedicated to the data transformation in Power Query, which we will call <code>pbi_powerquery_env</code>:</p>
<ol>
<li><p>Enter the following command to create a new environment named <code>pbi_powerquery_env</code> and containing Python version <code>3.9.1</code>:</p>
<pre><code>conda create --name pbi_powerquery_env python==3.9.1</code></pre>
<p>You would have achieved the same thing if, instead of <code>==3.9.1</code>, you had used the form <code>=3.9</code> (with a single <code>=</code>), leaving it up to conda to find the latest micro-version.</p></li>
<li>Anaconda Prompt will ask you to install some packages needed to create the environment. At the <code>Proceed ([y]/n)?</code> prompt, type <code>y</code> and press <em>Enter</em>.</li>
</ol>
<p>When the package installation is complete, you will still see <strong>(base)</strong> as the prompt prefix:</p>
<figure>
<img src="../media/file42.png" alt="Figure 3.5 – After creating the new environment, you are still in the old one called “base”" /><figcaption aria-hidden="true">Figure 3.5 – After creating the new environment, you are still in the old one called “base”</figcaption>
</figure>
<p>This means that you are still in the base environment. Are you sure you created the new environment correctly? Let's check it:</p>
<ol>
<li><p>Try to list the environments present on the system by entering the <code>conda env list</code> command:</p>
<figure>
<img src="../media/file43.png" alt="Figure 3.6 – List of conda environments in the system" /><figcaption aria-hidden="true">Figure 3.6 – List of conda environments in the system</figcaption>
</figure>
<p>Fortunately, the new environment is listed, but it is not the active one. The active environment is identified by an asterisk.</p></li>
<li><p>In order to install our packages inside the newly created environment, you must first <strong>activate</strong> it using the <code>conda activate pbi_powerquery_env</code> command:</p>
<figure>
<img src="../media/file44.png" alt="Figure 3.7 – Activating the new environment" /><figcaption aria-hidden="true">Figure 3.7 – Activating the new environment</figcaption>
</figure>
<p>Now your prompt prefix correctly indicates that you are in your new environment.</p></li>
<li>To be on the safe side, check that the version of Python within the new environment is the one you expect with the <code>python --version</code> command:</li>
</ol>
<figure>
<img src="../media/file45.png" alt="Figure 3.8 – Checking the Python version installed in the new environment" /><figcaption aria-hidden="true">Figure 3.8 – Checking the Python version installed in the new environment</figcaption>
</figure>
<p>You are inside your new environment and Python is correctly installed! You can now start installing some of the packages you'll need later. The packages to be installed are as follows:</p>
<ul>
<li><strong>NumPy</strong>: The most widely used library in Python for working with arrays, and with functions on linear algebra, Fourier transforms, and matrices.</li>
<li><strong>SciPy</strong>: Used to solve scientific and mathematical problems; it is built on the NumPy extension and allows the user to manipulate and visualize data.</li>
<li><strong>Pandas</strong>: A Python package that provides fast, flexible, and expressive tabular, multidimensional, and time-series data.</li>
<li><strong>Requests</strong>: Allows you to send HTTP requests extremely easily.</li>
<li><strong>BeautifulSoup</strong>: A library that makes it easy to scrape information from web pages.</li>
<li><strong>PyYAML</strong>: Allows you to easily read and write YAML files.</li>
</ul>
<p>You'll use the last three packages from the preceding list in the next section, where you will implicitly use web scraping procedures!</p>
<p>But let’s get back to it, and proceed with the installation of each package via <code>pip</code>:</p>
<ol>
<li>Enter the following command to install <strong>NumPy</strong>: <code>pip install numpy</code>.</li>
<li>Enter the following command to install <strong>SciPy</strong>: <code>pip install scipy</code>.</li>
<li>Enter the following command to install <strong>Pandas</strong>: <code>pip install pandas</code>.</li>
<li>Enter the following command to install <strong>Requests</strong>: <code>pip install requests</code>.</li>
<li>Enter the following command to install <strong>BeautifulSoup</strong>: <code>pip install beautifulsoup4</code>.</li>
<li>Enter the following command to install <strong>PyYAML</strong>: <code>pip install pyyaml</code>.</li>
<li>Check that all packages have been installed correctly with the <code>conda list</code> command:</li>
</ol>
<figure>
<img src="../media/file46.png" alt="Figure 3.9 – Checking all the selected Python packages are installed" /><figcaption aria-hidden="true">Figure 3.9 – Checking all the selected Python packages are installed</figcaption>
</figure>
<p>Awesome! Your new environment is now properly configured. Let's now configure another environment for Python visuals on the Power BI service.</p>
</section>
<section id="creating-an-environment-for-python-visuals-on-the-power-bi-service" class="level4" data-number="4.3.2.3">
<h4 data-number="4.3.2.3">Creating an environment for Python visuals on the Power BI service</h4>
<p>As already mentioned, Python visual scripts published on the Power BI service run on a pre-installed Python engine on the cloud, the version of which may change with new releases of the Power BI service itself. Should you need to share a report containing a Python visual with colleagues, you need to be sure that your Python code works correctly on the pre-installed engine.</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>We strongly recommend that you also install on your machine the <em>same version</em> of Python that is used for Python visuals by the Power BI service.</p>
</blockquote>
<p>Keep in mind that these limitations would not be there if your reports using Python visuals were not to be shared and that you only used them through Power BI Desktop. In this case, it is the engine on your machine that is used by the visuals.</p>
<p>To create the new environment, you must check which versions of both Python and the allowed packages are supported by the Power BI service. You can check these requirements at this link: <a href="http://bit.ly/powerbi-python-limits">http://bit.ly/powerbi-python-limits</a>. As you can see, to date the supported version of Python is 3.7.7:</p>
<figure>
<img src="../media/file47.png" alt="Figure 3.10 – Python version supported for visuals on the Power BI service" /><figcaption aria-hidden="true">Figure 3.10 – Python version supported for visuals on the Power BI service</figcaption>
</figure>
<p>In addition, to date the only packages allowed are the following ones:</p>
<ul>
<li><code>matplotlib 3.2.1</code></li>
<li><code>numpy 1.18.4</code></li>
<li><code>pandas 1.0.1</code></li>
<li><code>scikit-learn 0.23.0</code></li>
<li><code>scipy 1.4.1</code></li>
<li><code>seaborn 0.10.1</code></li>
<li><code>statsmodels 0.11.1</code></li>
<li><code>xgboost 1.1.0</code></li>
</ul>
<p>The first thing that jumps out at you is the far smaller number of packages compared to the R packages that the Power BI service provides (8 Python packages versus more than 900 R packages!). This evident imbalance of available packages is primarily due to two causes:</p>
<ul>
<li><strong>Python</strong> was <em>introduced more recently</em> than R (February 2019), so the Python packages introduced are mostly those essential to transforming and visualizing data.</li>
<li><strong>R</strong> is a language <em>primarily for data analysis</em>, and this is immediately clear because it provides a variety of packages that are designed for scientific visualization. <strong>Python</strong>, on the other hand, <em>is a general programming language</em> that can also be used for data analysis.</li>
</ul>
<blockquote>
<p><strong>Tip</strong></p>
<p>Because of the small number of Python packages supported by the Power BI service, we suggest creating a dedicated environment for Python scripts to run on the Power BI service, directly <em>installing all the current allowed packages</em>.</p>
</blockquote>
<p>Keep in mind that you can't properly run a Python visual without installing some default packages. See the following note.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>In order to properly run a Python visual, regardless of whether you do it on Power BI Desktop or the Power BI service, you must necessarily install the <strong>pandas</strong> and <strong>Matplotlib</strong> packages.</p>
</blockquote>
<p>That said, you could already proceed to create another environment, satisfying the aforementioned version specifications, and following the steps already used to create the previous environment. Even though the Power BI service engines are updated infrequently, this manual task would still be tedious. Unfortunately, there are no ready-made "snapshots" that you can install on-the-fly to reproduce the environment, as you have seen in the case of R engines.</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>To avoid unnecessary manual work, we created a Python script that <em>scrapes the web page containing the Python engine requirements on the Power BI service</em> and automatically generates a <strong>YAML file</strong> to be used in the creation of the new environment.</p>
</blockquote>
<p><strong>YAML</strong> (defined by some funny guy using the recursive acronym <strong>YAML Ain't Markup Language</strong>) is a language useful for serializing data (it's a bit of a rival to JSON) and is human-readable. It is often used to serialize the contents of a computer system’s configuration files.</p>
<p>In our case, a YAML file helps us gather together all the specifications we need to create our new environment. We thought about a YAML file because <code>conda</code> also permits the use of a YAML file as a parameter to create an environment. Our new environment, which we will call <code>pbi_visuals_env</code>, should have the following:</p>
<ul>
<li>The Python engine version 3.7.7</li>
<li>The pip package manager</li>
<li>All the 8 packages seen previously, each at the required version, installed using pip</li>
</ul>
<p>The preceding requirements can be summarized in a YAML file as follows:</p>
<pre><code>name: pbi_visuals_env
dependencies:
  - python==3.7.7
  - pip
  - pip:
    - matplotlib==3.2.1
    - numpy==1.18.4
    - pandas==1.0.1
    - scikit-learn==0.23.0
    - scipy==1.4.1
    - seaborn==0.10.1
    - statsmodels==0.11.1
    - xgboost==1.1.0</code></pre>
<p>So, let's generate the YAML file using our Python script as follows:</p>
<ol>
<li>Open your <strong>Anaconda Prompt</strong> (if you didn’t close it before, it should still be open) and make sure that <code>pbi_powerquery_env</code> is the activated environment. If not, activate it using the <code>conda activate pbi_powerquery_env</code> command.</li>
<li><p>Your current path should be in the form of <code>C:/Users/&lt;your-username&gt;</code>. In my case, I have the following:</p>
<figure>
<img src="../media/file48.png" alt="Figure 3.11 – Our default Anaconda Prompt path" /><figcaption aria-hidden="true">Figure 3.11 – Our default Anaconda Prompt path</figcaption>
</figure>
<p>If not, go to your user name folder using the command: <code>cd C:/Users/&lt;your-username&gt;</code>.</p></li>
<li>Let’s create a new folder called <code>py-environments</code> (this will contain the Python script for web scraping, along with the YAML file) using the <code>md py-environments</code> command.</li>
<li>Now, go to the book’s GitHub repository at <a href="https://github.com/PacktPublishing/Extending-Power-BI-with-Python-and-R">https://github.com/PacktPublishing/Extending-Power-BI-with-Python-and-R</a>.</li>
<li>If you have already downloaded the <code>.zip</code> file of the whole repository and unzipped it on your hard drive, you will find the Python script file that we are interested in in the <code>Chapter03</code> folder, with the name <code>01-create-pbi-service-py-packages-env-yaml-file.py</code>.</li>
<li><p>If you haven’t downloaded the entire repository, click <strong>Code</strong> on top right of the page at the preceding link, and then click <strong>Download ZIP</strong>:</p>
<figure>
<img src="../media/file49.png" alt="Figure 3.12 – Download the entire zipped repository" /><figcaption aria-hidden="true">Figure 3.12 – Download the entire zipped repository</figcaption>
</figure>
<p>After unzipping it, you'll find the file we need in the <code>Chapter03</code> folder.</p></li>
<li>Now copy the file, <code>01-create-pbi-service-py-packages-env-yaml-file.py</code>, into the <code>C:/Users/&lt;your-username&gt;/py-environments</code> folder using the File Explorer.</li>
<li>Go back to Anaconda Prompt and change your current folder to <code>py-environment</code> using this command: <code>cd py-environment</code>.</li>
<li><p>Now you can finally run the Python script that does the web scraping and generates the YAML file with this command: <code>python 01-create-pbi-service-py-packages-env-yaml-file.py</code>. You will see the contents of the YAML file printed at the prompt as follows:</p>
<figure>
<img src="../media/file50.png" alt="Figure 3.13 – Execute the Python script to create the YAML file" /><figcaption aria-hidden="true">Figure 3.13 – Execute the Python script to create the YAML file</figcaption>
</figure>
<p>You can also verify that the YAML file was generated correctly by looking again at the contents of the folder at <code>C:/Users/&lt;your-username&gt;/py-environments</code>:</p>
<figure>
<img src="../media/file51.png" alt="Figure 3.14 – The YAML file correctly created" /><figcaption aria-hidden="true">Figure 3.14 – The YAML file correctly created</figcaption>
</figure></li>
<li>At this point, we can directly create the new environment using the following command: <code>conda env create -f visuals_environment.yaml</code>.</li>
<li>When both Python and the packages’ installations are complete, activate the newly created environment using this command: <code>conda activate pbi_visuals_env</code>.</li>
<li>Then check if the Python version is the one defined for this environment in the YAML file by entering the <code>python –version</code> command. You should see the following output:</li>
</ol>
<figure>
<img src="../media/file52.png" alt="Figure 3.15 – The new environment contains the right Python version" /><figcaption aria-hidden="true">Figure 3.15 – The new environment contains the right Python version</figcaption>
</figure>
<p>Excellent! You have finally created the new environment that will come in use when developing your Python visuals for publishing on the Power BI service. If you are interested in understanding in detail how the previous Python script managed to capture all the information needed to create the environment, you can open it in any code editor and read the very detailed comments on the code.</p>
</section>
<section id="what-to-do-when-the-power-bi-service-upgrades-the-python-engine" class="level4" data-number="4.3.2.4">
<h4 data-number="4.3.2.4">What to do when the Power BI service upgrades the Python engine</h4>
<p>As we did in <em>Chapter 2, Configuring R with Power BI</em>, let's assume that you have already developed and published reports containing Python visuals using the new environment you created earlier. Suppose that Microsoft decides to upgrade the Python version supported by the Power BI service, and consequently to upgrade the versions of currently supported packages as well. As you may have already guessed, it is likely that these updates can cause the code to fail (it is a rare event as very often, backward compatibility is guaranteed).</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>In such circumstances, it is often more convenient to <em>create a new environment on the fly</em>, aligned to the updated requirements from Microsoft, through the Python script you have already used previously. Next, you'll need to <em>test reports on the service that contain Python visuals on Power BI Desktop</em>, making sure that it references the newly created environment. You need to fix any code issue in those Python visuals that have some problems, after which you can publish those reports back to the Power BI service.</p>
</blockquote>
<p>Once you've made sure that all of the reports are working properly, it's up to you to decide if you want to uninstall the "old" environment to free up disk space and avoid confusion in handling these particular reports.</p>
<p>At this point, we can move on to the configuration and installation of some IDEs that facilitate the development of Python scripts.</p>
</section>
</section>
</section>
<section id="installing-an-ide-for-python-development" class="level2" data-number="4.4">
<h2 data-number="4.4">Installing an IDE for Python development</h2>
<p>In <em>Chapter 2, Configuring R with Power BI</em>, you installed RStudio to conveniently develop your own R scripts. Did you know that, starting with version 1.4, you can write and run Python code directly in RStudio, making use of advanced tools for viewing instantiated Python objects?</p>
<p>Let's see how to configure your RStudio installation to also run Python code.</p>
<section id="configuring-python-with-rstudio" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1">Configuring Python with RStudio</h3>
<p>In order to allow RStudio to communicate with the Python world, you need to install a package called <strong>reticulate</strong>, which contains a comprehensive set of tools for interoperability between Python and R thanks to embedded Python sessions within R sessions. After that, it's a breeze to configure Python within RStudio. Let's see how to do it:</p>
<ol>
<li>Open RStudio and make sure the referenced engine is the latest one, in our case <strong>MRO 4.0.2</strong>. As seen in <em>Chapter 2, Configuring R with Power BI</em>, you can set up your R engine in RStudio by going to the <strong>Tools</strong> menu and then <strong>Global Options...</strong>.</li>
<li><p>Let's check at which date the current snapshot is frozen by typing <code>getOption("repos")</code> in the command-line interface:</p>
<figure>
<img src="../media/file53.png" alt="Figure 3.16 – Current snapshot date with MRO 4.0.2" /><figcaption aria-hidden="true">Figure 3.16 – Current snapshot date with MRO 4.0.2</figcaption>
</figure>
<p>As you can see, the snapshot date is not very recent.</p></li>
<li><p>Since the goal of installing the latest R engine is to develop code using the latest packages, we can remove the snapshot limitation by overwriting the package repository URL. You can do this by creating a new R script, by clicking on the top-left green <strong>+</strong> icon and then choosing <strong>R Script</strong>:</p>
<figure>
<img src="../media/file54.png" alt="Figure 3.17 – Reset the repository URL to a CRAN mirror" /><figcaption aria-hidden="true">Figure 3.17 – Reset the repository URL to a CRAN mirror</figcaption>
</figure></li>
<li><p>Then copy the following script into the new script tab that has been added by RStudio:</p>
<pre><code>local({
  r &lt;- getOption(&quot;repos&quot;)
  r[&quot;CRAN&quot;] &lt;- https://cloud.r-project.org/
  options(repos = r)
 })</code></pre>
<p>Now, just highlight the script and click <strong>Run</strong> at the top right:</p>
<figure>
<img src="../media/file55.png" alt="Figure 3.18 – Run your first R script into RStudio" /><figcaption aria-hidden="true">Figure 3.18 – Run your first R script into RStudio</figcaption>
</figure></li>
<li><p>If you now go to the console at the bottom and enter <code>getOption("repos")</code> again, you will see the updated repository URL:</p>
<figure>
<img src="../media/file56.png" alt="Figure 3.19 – The packages repository has been updated" /><figcaption aria-hidden="true">Figure 3.19 – The packages repository has been updated</figcaption>
</figure>
<p>Now, you are sure to always install the latest versions of the packages on CRAN.</p></li>
<li><p>You can now install the reticulate package by clicking on the <strong>Packages</strong> tab on the bottom-right panel in RStudio, clicking on <strong>Install</strong>, entering the <code>reticulate</code> string into the textbox, and finally clicking on the <strong>Install</strong> button:</p>
<figure>
<img src="../media/file57.png" alt="Figure 3.20 – Install the reticulate package" /><figcaption aria-hidden="true">Figure 3.20 – Install the reticulate package</figcaption>
</figure></li>
<li><p>After that, go to the <strong>Tools</strong> menu and then <strong>Global Options…</strong>. In the <strong>Options</strong> windows that pops up, click on <strong>Python</strong>, then click on <strong>Select…</strong> to choose your Python interpreter executable. Note that you will have as many executables as the number of environments you have created:</p>
<figure>
<img src="../media/file58.png" alt="Figure 3.21 – Set your preferred Python interpreter in RStudio" /><figcaption aria-hidden="true">Figure 3.21 – Set your preferred Python interpreter in RStudio</figcaption>
</figure></li>
<li>Choose the Python interpreter with the latest version (in our case 3.9.1). You’ll be asked to restart the current R session. Choose <strong>Yes</strong>.</li>
<li><p>Now you can open a new Python script file by clicking on the green <strong>+</strong> icon on the top left and then choosing <strong>Python Script</strong>:</p>
<figure>
<img src="../media/file59.png" alt="Figure 3.22 – Create a new Python script in RStudio" /><figcaption aria-hidden="true">Figure 3.22 – Create a new Python script in RStudio</figcaption>
</figure></li>
<li><p>Write the code <code>a = [1, 2]</code> in the new script file, highlight it, and then click the <strong>Run</strong> icon on the top right:</p>
<figure>
<img src="../media/file60.png" alt="Figure 3.23 – Run your first Python script in RStudio" /><figcaption aria-hidden="true">Figure 3.23 – Run your first Python script in RStudio</figcaption>
</figure>
<p>You can see from the console that RStudio uses reticulate behind the scenes. Moreover, on the top-right panel, you can inspect the Python variables created after the execution of your code.</p></li>
</ol>
<p>Great! You have successfully configured RStudio to run your Python code.</p>
</section>
<section id="configuring-python-with-visual-studio-code" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2">Configuring Python with Visual Studio Code</h3>
<p>If you're an R language lover, chances are you'd prefer to run both R and Python code on RStudio. However, if you have the spirit of a true <em>Pythonista</em>, you'll definitely enjoy using one of the advanced editors that has been all the rage lately: <strong>Visual Studio Code</strong> (<strong>VSCode</strong>). Let’s install and configure it!</p>
<ol>
<li>Download VSCode from this link (<a href="https://code.visualstudio.com/">https://code.visualstudio.com/</a>) by clicking on the <strong>Download for Windows</strong> button.</li>
<li>Run the executable and click <strong>OK</strong> when it asks to continue with the User Installer.</li>
<li>Accept the agreement and click <strong>Next</strong> on the next window.</li>
<li>Then keep the default destination folder and click <strong>Next</strong>.</li>
<li>Also keep the default Start menu folder on the following window and click <strong>Next</strong>.</li>
<li>On the <strong>Additional Tasks</strong> window, choose the tasks you prefer and click <strong>Next</strong>.</li>
<li>Click <strong>Install</strong> on the recap window.</li>
<li>After the installation is completed, keep the <strong>Launch Visual Studio Code</strong> checkbox flagged and click <strong>Finish</strong>.</li>
<li><p>After VSCode has started, click on the <strong>Extensions</strong> icon on the left, then start entering the <code>python</code> string and click on the <strong>Python</strong> extension:</p>
<figure>
<img src="../media/file61.png" alt="Figure 3.24 – Run your first Python script in RStudio" /><figcaption aria-hidden="true">Figure 3.24 – Run your first Python script in RStudio</figcaption>
</figure></li>
<li>Click on <strong>Install</strong> on the extension’s welcome page on the main panel.</li>
<li>Now go to the <strong>File</strong> menu at the top and click <strong>Open Folder…</strong>.</li>
<li><p>Create a new test folder named <strong>Hello</strong> from the <strong>Open Folder</strong> windows and then select that folder:</p>
<figure>
<img src="../media/file62.png" alt="Figure 3.25 – Create a new folder on the fly and select it in the Open Folder window" /><figcaption aria-hidden="true">Figure 3.25 – Create a new folder on the fly and select it in the Open Folder window</figcaption>
</figure></li>
<li><p>Now you have to select the Python interpreter accessing the <strong>Command Palette</strong> using <em>Ctrl</em> <strong></strong> + <em>Shift</em> <strong></strong> + <em>P</em>. Then start entering the <code>interpreter</code> string and click <strong>Python: Select Interpreter</strong>:</p>
<figure>
<img src="../media/file63.png" alt="Figure 3.26 – Choose the Python: Select Interpreter option in the Command Palette" /><figcaption aria-hidden="true">Figure 3.26 – Choose the Python: Select Interpreter option in the Command Palette</figcaption>
</figure></li>
<li><p>You’ll be prompted to select one of the actual environments you have on your machine. Choose the <strong>pbi_powerquery_env</strong> environment:</p>
<figure>
<img src="../media/file64.png" alt="Figure 3.27 – Select your preferred environment" /><figcaption aria-hidden="true">Figure 3.27 – Select your preferred environment</figcaption>
</figure></li>
<li><p>You can see the selected environment on the status bar on the left:</p>
<figure>
<img src="../media/file65.png" alt="Figure 3.28 – Check the selected environment on the status bar" /><figcaption aria-hidden="true">Figure 3.28 – Check the selected environment on the status bar</figcaption>
</figure></li>
<li><p>Go back to your <strong>HELLO</strong> folder in the Explorer panel on the left. Click on the <em>new file</em> icon next to the <strong>HELLO</strong> label and name the new file <code>hello.py</code>:</p>
<figure>
<img src="../media/file66.png" alt="Figure 3.29 – Create a new file named hello.py in the Hello folder" /><figcaption aria-hidden="true">Figure 3.29 – Create a new file named hello.py in the Hello folder</figcaption>
</figure></li>
<li><p>Enter the following code in the new file:</p>
<pre><code>msg = &quot;Hello World&quot;
print(msg)</code></pre>
<p>Then click the <em>run</em> icon (the green triangle) on the top right of the main panel:</p>
<figure>
<img src="../media/file67.png" alt="Figure 3.30 – Enter the sample code and run it" /><figcaption aria-hidden="true">Figure 3.30 – Enter the sample code and run it</figcaption>
</figure></li>
<li>You can see the result in the following Terminal output:</li>
</ol>
<figure>
<img src="../media/file68.png" alt="Figure 3.31 – Your first Python script run in VSCode" /><figcaption aria-hidden="true">Figure 3.31 – Your first Python script run in VSCode</figcaption>
</figure>
<p>Very good! Your VSCode is now configured correctly to run Python scripts.</p>
</section>
</section>
<section id="configuring-power-bi-desktop-to-work-with-python" class="level2" data-number="4.5">
<h2 data-number="4.5">Configuring Power BI Desktop to work with Python</h2>
<p>Since you have everything you need installed, you can now configure Power BI Desktop to interact with Python engines and IDEs. This is really a very simple task:</p>
<ol>
<li><p>In Power BI Desktop, go to the <strong>File</strong> menu, click on the <strong>Options and settings</strong> tab, and then click on <strong>Options</strong>:</p>
<figure>
<img src="../media/file69.png" alt="Figure 3.32 – Opening the Power BI Desktop Options and settings window" /><figcaption aria-hidden="true">Figure 3.32 – Opening the Power BI Desktop Options and settings window</figcaption>
</figure></li>
<li><p>In the <strong>Options</strong> window, click on the <strong>Python scripting</strong> link on the left. The contents of the panel on the right will update, giving you the option to select the Python environment to reference and the Python IDE to use for Python visuals. By default, the detected interpreter is the default one installed by Miniconda. In order to select a specific environment, you need to choose <strong>Other</strong> and then click <strong>Browse</strong> and supply a reference to your environment folder:</p>
<figure>
<img src="../media/file70.png" alt="Figure 3.33 – Configuring your Python environment and IDE in Power BI" /><figcaption aria-hidden="true">Figure 3.33 – Configuring your Python environment and IDE in Power BI</figcaption>
</figure>
<p>Usually, you can find the default environments folder in <code>C:\Users\&lt;your-username&gt;\miniconda3\envs\</code>. Then select your <code>pbi_powerquery_env</code> subfolder.</p></li>
<li>By default, Power BI recognizes VSCode as a Python IDE. Keep it as is and click <strong>OK</strong>.</li>
</ol>
<p>You will see how to interact with the IDE from Power BI Desktop when we introduce the R and Python script visuals in <em>Chapter 12, Exploratory Data Analysis</em>.</p>
</section>
<section id="configuring-the-power-bi-service-to-work-with-r-1" class="level2" data-number="4.6">
<h2 data-number="4.6">Configuring the Power BI service to work with R</h2>
<p>As you have already learned from <em>Chapter 2, Configuring R with Power BI</em>, in order to allow the Power BI service to use R in the data transformation steps with Power Query, you must install the <strong>on-premises data gateway</strong> in <strong>personal mode</strong> on an external machine, on which an R engine is installed. The same thing applies to Python with Power Query in the Power BI service. So, if you have not installed the on-premises data gateway yet, do it by following the steps in <em>Chapter 2</em>.</p>
<blockquote>
<p><strong>Important note</strong></p>
<p>Python engines and R engines can be <em>installed on the same external machine</em> and <em>referenced by a single data gateway</em>. You must make sure, however, that the machine's resources are sufficient to handle the load of requests coming from the Power BI service.</p>
</blockquote>
<section id="sharing-reports-that-use-python-scripts-in-the-power-bi-service" class="level3" data-number="4.6.1">
<h3 data-number="4.6.1">Sharing reports that use Python scripts in the Power BI service</h3>
<p>What was said about how to share reports that use R scripts for data transformations in the Power BI service in <em>Chapter 2, Configuring R with Power BI</em> also applies to reports that use Python scripts. Consider the following tip in summary.</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>You can use an unofficial architecture that makes use of a personal data gateway associated not with a physical person, but with a <em>fictitious "service" user</em>. The credentials of this user are shared between all those analysts who use Python (along with R) code to transform data into their reports. Also, since the machine with the Python engines referenced by the gateway is shared, it must remain on during periods of scheduled activity. The same machine often hosts the R engines too. An <em>Azure Windows Virtual Machine</em>, on which the R and Python engines and the data gateway run, is often used in this architecture.</p>
</blockquote>
<p>As a reminder, <em>Figure 3.34</em> summarizes the aforementioned architecture:</p>
<figure>
<img src="../media/file71.png" alt="Figure 3.34 – Enterprise architecture for the use of Python and R in data transformations" /><figcaption aria-hidden="true">Figure 3.34 – Enterprise architecture for the use of Python and R in data transformations</figcaption>
</figure>
<p>Thanks to this architecture it is possible to allow a group of analysts to be able to use Python scripts in their reports, despite the limitations imposed by the on-premises data gateway in personal mode.</p>
<p>That said, in addition to the limitations seen for Python scripts in Power Query, there are some important ones to be aware of for Python visuals as well.</p>
</section>
</section>
<section id="limitations-of-python-visuals" class="level2" data-number="4.7">
<h2 data-number="4.7">Limitations of Python visuals</h2>
<p>Python visuals have some important limitations regarding the data they can handle, both input and output:</p>
<ul>
<li>A Python visual can handle a <em>dataframe with only 150,000 rows</em>. If there are more than 150,000 rows, only the first 150,000 rows are used.</li>
<li>Python visuals have an <em>output size limit of 2MB</em>.</li>
</ul>
<p>You must also be careful not to exceed the <em>5-minute runtime calculation</em> for a Python visual in order to avoid a time-out error. Moreover, in order not to run into performance problems, <em>the resolution of the Python visual plots is fixed at 72 DPI</em>.</p>
<p>As you can imagine, some limitations of Python visuals are different depending on whether you run the visual on Power BI Desktop or the Power BI service.</p>
<p>When creating reports in <em>Power BI Desktop</em>, you can do the following:</p>
<ul>
<li>Install any kind of package (PyPI and custom) in your engine for Python visuals.</li>
<li>Access the internet from a Python visual.</li>
</ul>
<p>When creating reports in <em>the Power BI service</em>, you can do the following:</p>
<ul>
<li>You can only use the PyPI packages listed at this link: <a href="https://bit.ly/powerbi-python-limits">https://bit.ly/powerbi-python-limits</a>.</li>
<li>You cannot access the internet from a Python visual.</li>
</ul>
<blockquote>
<p><strong>Important note</strong></p>
<p>In contrast to the case of R visuals, you <strong>do not</strong> have the option of developing a custom Python visual.</p>
</blockquote>
<p>Once one of your reports is published on the Power BI service, you can decide to share it on your blog, on one of your websites, or on social media via the <strong>Publish to web</strong> option. Unfortunately, Python visuals (as well as R visuals) <em>are not usable on reports to be published publicly on the web by design by Microsoft</em>.</p>
<blockquote>
<p><strong>Tip</strong></p>
<p>If you absolutely need to publish a particular visualization to the web, remember that <em>custom R visuals</em> overcome the limitation on publishing to the web. So, you need to switch from Python to R.</p>
</blockquote>
</section>
<section id="summary-2" class="level2" data-number="4.8">
<h2 data-number="4.8">Summary</h2>
<p>In this chapter, you learned about the most popular free Python distributions in the community and the best practices for their use.</p>
<p>Using the unique features of Power BI Desktop and the Power BI service, you have learned how to properly create specific Python environments.</p>
<p>You also learned that the most popular IDE in the R community (RStudio) can also run Python code. In addition, you have installed and configured VSCode, which is to date one of the most widely used advanced editors for Python.</p>
<p>You were also introduced to all of the best practices for properly configuring both Power BI Desktop and the Power BI service with Python, whether in a development or enterprise environment.</p>
<p>Finally, you've learned some of the limitations on using Python with Power BI, knowledge of which is critical to avoid making mistakes in developing and deploying reports.</p>
<p>In the next chapter, we’ll finally start working with R and Python scripts in Power BI, doing data ingestion and data transformation.</p>
</section>
</section>
</body>
</html>
