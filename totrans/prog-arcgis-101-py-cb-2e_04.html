<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Finding and Fixing Broken Data Links</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Finding broken data sources in your map document and layer files</li><li class="listitem" style="list-style-type: disc">Fixing broken data sources with MapDocument.findAndReplaceWorkspacePaths()</li><li class="listitem" style="list-style-type: disc">Fixing broken data sources with MapDocument.replaceWorkspaces()</li><li class="listitem" style="list-style-type: disc">Fixing individual Layer and Table objects with replaceDataSource()</li><li class="listitem" style="list-style-type: disc">Finding all broken data sources in all map documents in a folder</li></ul></div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec31"/>Introduction</h1></div></div></div><p>It is not uncommon for your GIS data sources to move, migrate to a new data format or be deleted. The result can be broken data sources in many map document or layer files. These broken data sources can't be used until they have been fixed, which can be an overwhelming process if the same changes need to be made across numerous map documents. You can automate the process of finding and fixing these data sources using <code class="literal">arcpy.mapping</code>, without ever having to open the affected map documents. Finding broken data sources is a simple process requiring the use of the<a id="id303" class="indexterm"/> <code class="literal">ListBrokenDataSources()</code> function, which returns a Python list of all broken data sources in a map document or layer file. Typically, this function is used as the first step in a script that iterates through the list and fixes the data sources. Fixing broken data sources can be performed on the individual data layer or across all the layers in a common workspace.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec32"/>Finding broken data sources in your map document and layer files</h1></div></div></div><p>Broken data sources <a id="id304" class="indexterm"/>are a very common problem with map document files. You can use <code class="literal">arcpy.mapping</code> to identify data sources that have moved, been deleted, or changed format.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec71"/>Getting ready</h2></div></div></div><p>In ArcMap, a broken data connection is signified by a red exclamation point just before the layer name. This is illustrated in the following screenshot. The <code class="literal">ListBrokenDataSources()</code> function<a id="id305" class="indexterm"/> in <code class="literal">arcpy.mapping</code> returns a list of layer objects from a map document or layer file that have a broken data connection:</p><div><img src="img/4445_04_1.jpg" alt="Getting ready"/></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec72"/>How to do it…</h2></div></div></div><p>Follow the steps below to<a id="id306" class="indexterm"/>
<a id="id307" class="indexterm"/>
<a id="id308" class="indexterm"/>
<a id="id309" class="indexterm"/> learn how to find broken data sources in a map document file.</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">C:\ArcpyBook\Ch4\Crime_BrokenDataLinks.mxd</code> in ArcMap.<p>You will see that each of the data sources have been broken. In this case, the data has been moved to another folder, but you'd see the same indicator if the data had been deleted or migrated to a different format.  For example, it is not uncommon to convert data from a personal geodatabase to a file geodatabase:</p><div><img src="img/4445_04_2.jpg" alt="How to do it…"/></div></li><li class="listitem">Close <a id="id310" class="indexterm"/><a id="id311" class="indexterm"/><a id="id312" class="indexterm"/><a id="id313" class="indexterm"/>ArcMap.</li><li class="listitem">Open IDLE and create a new script window.</li><li class="listitem">Import the <code class="literal">arcpy.mapping</code> module:<div><pre class="programlisting">import arcpy.mapping as mapping</pre></div></li><li class="listitem">Reference the <code class="literal">Crime_BrokenDataLinks.mxd</code> map document file:<div><pre class="programlisting">mxd = mapping.MapDocument(r"c:\ArcpyBook\Ch4\Crime_BrokenDataLinks.mxd")</pre></div></li><li class="listitem">Get a list of the broken data sources:<div><pre class="programlisting">lstBrokenDS = mapping.ListBrokenDataSources(mxd)</pre></div></li><li class="listitem">Iterate the list and print out the layer names:<div><pre class="programlisting">for layer in lstBrokenDS:
    print layer.name</pre></div><p>The ouptput will be printed as follows:</p><div><pre class="programlisting">District_Crime_Join
Bexar_County_Boundary
District_Crime_Join
Bexar_County_Boundary
Bexar_County_Boundary
Texas_Counties_LowRes
School_Districts
Crime_surf
Bexar_County_Boundary
Crime2009Table</pre></div></li><li class="listitem">Save your script as <code class="literal">FindFixBrokenData.py</code> in the <code class="literal">c:\ArcpyBook\Ch4</code> folder.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec73"/>How it works…</h2></div></div></div><p>The <code class="literal">ListBrokenDataSources()</code> function <a id="id314" class="indexterm"/>returns a Python list of layers that have a broken data source. We then use a <code class="literal">for</code> loop to iterate this list and <a id="id315" class="indexterm"/>
<a id="id316" class="indexterm"/>
<a id="id317" class="indexterm"/>
<a id="id318" class="indexterm"/>perform some sort of action for each layer. In this case, we printed out the layer names simply to illustrate the data returned by this function. In a later recipe, we'll build on this code by fixing these broken data sources.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec74"/>There's more…</h2></div></div></div><p>In addition to returning a list of broken data sources from a map document file, the <code class="literal">ListBrokenDataSources()</code> function can also find broken data sources in a layer file (<code class="literal">.lyr</code>). Simply pass in the path to the layer file to have the function examine the file for broken data sources. Keep in mind that these functions are not needed with <code class="literal">Map</code> or <code class="literal">Layer</code> packages, since the data is bundled with these files, unlike a layer file.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec33"/>Fixing broken data sources with MapDocument.findAndReplaceWorkspacePaths()</h1></div></div></div><p>The <code class="literal">MapDocument.findAndReplaceWorkspacePaths()</code> method<a id="id319" class="indexterm"/> is used to perform a global find and replace of workspace paths for all the layers and tables in a map document. You can also replace the paths to multiple workspace types at once.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec75"/>Getting ready</h2></div></div></div><p>We need to cover some <a id="id320" class="indexterm"/>
<a id="id321" class="indexterm"/>definitions before examining the methods used to fix datasets. You'll see these terms used frequently when discussing the methods used to fix broken data sources, so you'll need to understand what they mean in this context. A <strong>workspace</strong>
<a id="id322" class="indexterm"/> is simply a container for data. This can be a folder (in the case of shapefiles), personal geodatabase, file geodatabase, or ArcSDE connection. A <strong>workspace path</strong> is the system path to the <strong>workspace</strong>. In the case of file geodatabases, this would include the name of the <strong>geodatabase</strong>. A dataset is simply a feature class or table within a workspace, and finally, a data source is the combination of the workspace and dataset. Don't confuse a dataset with a feature dataset. The former is just a generic term for data, while the latter is an object within a geodatabase that serves as a container for feature classes and other datasets.</p><p>There are three <code class="literal">acpy.mapping</code> classes involved in fixing broken data sources. They are <code class="literal">MapDocument</code>, <code class="literal">Layer</code>, and <code class="literal">TableView</code>. Each class contains methods that can be used to fix data sources. In this recipe, we'll examine how you can use the <code class="literal">findAndReplaceWorkspacePaths()</code> method<a id="id323" class="indexterm"/> in the <code class="literal">MapDocument</code> class to perform a global find and replace operation on the layers and tables in a map document.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec76"/>How to do it…</h2></div></div></div><p>Follow these steps to learn how to fix layers and tables in a map document using <code class="literal">findAndReplaceWorkspacePaths()</code>:</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">c:\ArcpyBook\Ch4\Crime_BrokenDataLinks.mxd</code> in ArcMap.</li><li class="listitem">Right-click on any of the layers and select <strong>Properties</strong>.</li><li class="listitem">Go to the <strong>Source</strong> tab and you will notice that the location for the layer refers to <code class="literal">C:\ArcpyBook\Ch4\Data\OldData\CityOfSanAntonio.gdb</code>. This is a file geodatabase but the location no longer exists; it has moved to the <code class="literal">C:\ArcpyBook\data</code> folder.</li><li class="listitem">Open IDLE and create a new script window.</li><li class="listitem">Import the <code class="literal">arcpy.mapping</code> module:<div><pre class="programlisting">import arcpy.mapping as mapping</pre></div></li><li class="listitem">Reference the <code class="literal">Crime_BrokenDataLinks.mxd</code> map document file:<div><pre class="programlisting">mxd = mapping.MapDocument(r"c:\ArcpyBook\Ch4\Crime_BrokenDataLinks.mxd")</pre></div></li><li class="listitem">Use <code class="literal">MapDocument.findAndReplaceWorkspacePaths()</code> to fix the source path for each data source in the map document:<div><pre class="programlisting">mxd.findAndReplaceWorkspacePaths(r"C:\ArcpyBook\Ch4\Data\OldData\CityOfSanAntonio.gdb", r"C:\ArcpyBook\Data\CityOfSanAntonio.gdb")</pre></div></li><li class="listitem">Save the results to a new <code class="literal">.mxd </code>file:<div><pre class="programlisting">mxd.saveACopy(r"C:\ArcpyBook\Ch4\Crime_DataLinksFixed.mxd")</pre></div></li><li class="listitem">Save the <a id="id324" class="indexterm"/><a id="id325" class="indexterm"/>script as <code class="literal">C:\ArcpyBook\Ch4\MapDocumentFindReplace.py</code>.</li><li class="listitem">Run the script.</li><li class="listitem">In ArcMap, open the <code class="literal">C:\ArcpyBook\Ch4\Crime_DataLinksFixed.mxd</code> file. You will notice that all the data sources get fixed, as shown in the following screenshot:<div><img src="img/4445_04_3.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec77"/>How it works…</h2></div></div></div><p>The <code class="literal">MapDocument.findAndReplaceWorkspacePaths()</code> method is used to perform a global find and replace of workspace paths for all layers and tables in a map document. You can replace<a id="id326" class="indexterm"/>
<a id="id327" class="indexterm"/> the paths to multiple workspace types at once.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec78"/>There's more…</h2></div></div></div><p>The <code class="literal">Layer</code> and <code class="literal">TableView</code> objects also have a <code class="literal">findAndReplaceWorkspacePaths()</code> method that performs the same type of operation. The difference is that this method, on the <code class="literal">Layer</code> and <code class="literal">TableView</code> objects, is used to fix an individual broken data source rather than a global find and replace of all broken data sources in a map document.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec34"/>Fixing broken data sources with MapDocument.replaceWorkspaces()</h1></div></div></div><p>During the <a id="id328" class="indexterm"/>
<a id="id329" class="indexterm"/>course of normal GIS operations, it is a fairly common practice to migrate data from one file type to another. For example, many organizations migrate data from the older personal geodatabase formats to the new file geodatabase types or perhaps even enterprise ArcSDE geodatabases. You can automate the process of updating your datasets to a different format with <code class="literal">MapDocument.replaceWorkspaces()</code>.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec79"/>Getting ready</h2></div></div></div><p>
<code class="literal">MapDocument.replaceWorkspaces()</code> is similar to <code class="literal">MapDocument.findAndReplaceWorkspacePaths()</code>, but it also allows you to switch from one workspace type to another. For example, you can switch from a file geodatabase to a personal geodatabase. However, it only works on one workspace at a time. In this recipe, we'll use <code class="literal">MapDocument.replaceWorkspaces()</code> to switch our data source from a file geodatabase to a personal geodatabase.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec80"/>How to do it…</h2></div></div></div><p>Follow these steps to learn how to fix broken data sources using <code class="literal">MapDocument.replaceWorkspaces()</code>:</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">c:\ArcpyBook\Ch4\Crime_DataLinksFixed.mxd</code> in ArcMap.</li><li class="listitem">Notice that all the layers and tables are loaded from a file geodatabase called <code class="literal">CityOfSanAntonio.gdb</code>, as shown in the following screenshot:<div><img src="img/4445_04_4.jpg" alt="How to do it…"/></div></li><li class="listitem">Open <a id="id330" class="indexterm"/><a id="id331" class="indexterm"/>IDLE and create a new script window.</li><li class="listitem">Import the <code class="literal">arcpy.mapping</code> module:<div><pre class="programlisting">import arcpy.mapping as mapping</pre></div></li><li class="listitem">Reference the <code class="literal">Crime_BrokenDataLinks.mxd</code> map document file:<div><pre class="programlisting">mxd = mapping.MapDocument(r"c:\ArcpyBook\Ch4\Crime_BrokenDataLinks.mxd.mxd")</pre></div></li><li class="listitem">Call <code class="literal">replaceWorkspaces()</code>, passing a reference to the old geodatabase type as well as the new geodatabase type:<div><pre class="programlisting">mxd.replaceWorkspaces(r"c:\ArcpyBook\data\CityOfSanAntonio.gdb", "FILEGDB_WORKSPACE",r"c:\ArcpyBook\new_data\CityOfSanAntonio_Personal.mdb","ACCESS_WORKSPACE")</pre></div></li><li class="listitem">Save a copy of the map document file.<div><pre class="programlisting">mxd.saveACopy(r"c:\ArcpyBook\Ch4\Crime_DataLinksUpdated.mxd")</pre></div></li><li class="listitem">Save the script as <code class="literal">c:\ArcpyBook\Ch4\MapDocumentReplaceWorkspace.py</code>.</li><li class="listitem">Run the script.</li><li class="listitem">In ArcMap, open the <code class="literal">c:\ArcpyBook\Ch4\Crime_DataLinksUpdated.mxd</code> file. As shown in the following screenshot, all data sources now reference a personal geodatabase (note the <code class="literal">.mdb</code> extension):<div><img src="img/4445_04_5.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec81"/>How it works…</h2></div></div></div><p>The <code class="literal">MapDocument.replaceWorkspaces()</code> method accepts several parameters including<a id="id332" class="indexterm"/>
<a id="id333" class="indexterm"/> old and new workspace paths along with the old and new workspace types. Paths to the workspaces are self-explanatory, but some discussion of the workspace types is helpful. The workspace types are passed into the method as string keywords. In this case, the old workspace type was a file geodatabase so its keyword is <code class="literal">FILEGDB_WORKSPACE</code>. The new workspace type is <code class="literal">ACCESS_WORKSPACE</code>, which indicates a personal geodatabase. Personal geodatabases are stored in Microsoft Access files. There are a number of different workspace types that can store GIS data. Make sure you provide the workspace type that is appropriate for your dataset. The following is a list of valid workspace types (many people still work with shapefiles, so in this case the workspace type would<a id="id334" class="indexterm"/>
<a id="id335" class="indexterm"/> be <code class="literal">SHAPEFILE_WORKSPACE</code>):</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">ACCESS_WORKSPACE</code>: A personal geodatabase or Access workspace </li><li class="listitem" style="list-style-type: disc"><code class="literal">ARCINFO_WORKSPACE</code>: An ArcInfo coverage workspace </li><li class="listitem" style="list-style-type: disc"><code class="literal">CAD_WORKSPACE</code>: A CAD file workspace </li><li class="listitem" style="list-style-type: disc"><code class="literal">EXCEL_WORKSPACE</code>: An Excel file workspace </li><li class="listitem" style="list-style-type: disc"><code class="literal">FILEGDB_WORKSPACE</code>: A file geodatabase workspace </li><li class="listitem" style="list-style-type: disc"><code class="literal">NONE</code>: Used to skip the parameter </li><li class="listitem" style="list-style-type: disc"><code class="literal">OLEDB_WORKSPACE</code>: An OLE database workspace </li><li class="listitem" style="list-style-type: disc"><code class="literal">PCCOVERAGE_WORKSPACE</code>: A PC ARC/INFO Coverage workspace </li><li class="listitem" style="list-style-type: disc"><code class="literal">RASTER_WORKSPACE</code>: A raster workspace </li><li class="listitem" style="list-style-type: disc"><code class="literal">SDE_WORKSPACE</code>: An SDE geodatabase workspace </li><li class="listitem" style="list-style-type: disc"><code class="literal">SHAPEFILE_WORKSPACE</code>: A shapefile workspace </li><li class="listitem" style="list-style-type: disc"><code class="literal">TEXT_WORKSPACE</code>: A text file workspace </li><li class="listitem" style="list-style-type: disc"><code class="literal">TIN_WORKSPACE</code>: A TIN workspace </li><li class="listitem" style="list-style-type: disc"><code class="literal">VPF_WORKSPACE</code>: A VPF workspace </li></ul></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec35"/>Fixing individual Layer and Table objects with replaceDataSource()</h1></div></div></div><p>The previous<a id="id336" class="indexterm"/>
<a id="id337" class="indexterm"/>
<a id="id338" class="indexterm"/>
<a id="id339" class="indexterm"/> recipes in this chapter have used various methods on the <code class="literal">MapDocument</code> object to fix broken data links. The <code class="literal">Layer</code> and <code class="literal">Table</code> objects also have methods that can be used to fix broken data links at the individual object level rather than working on all datasets in a map document file.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec82"/>Getting ready</h2></div></div></div><p>Both the <code class="literal">Layer</code> and <code class="literal">TableView</code> classes have a <code class="literal">replaceDataSource()</code> method. This method can be used to change the workspace path, workspace type, and/or dataset name for a single layer or table. In this recipe, you'll write a script that changes the workspace path and workspace type for a single layer. The <code class="literal">replaceDataSource()</code> method is available to the <code class="literal">Layer</code> and <code class="literal">TableView</code> classes. In the case of a layer it can be in either a map document or layer file. For a table, it can refer to the map document only, since <code class="literal">Table</code> objects can't be contained inside a layer file.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec83"/>How to do it…</h2></div></div></div><p>Follow these steps<a id="id340" class="indexterm"/>
<a id="id341" class="indexterm"/>
<a id="id342" class="indexterm"/>
<a id="id343" class="indexterm"/> to learn how to fix individual <code class="literal">Layer</code> and <code class="literal">Table</code> objects in a map document using <code class="literal">replaceDataSource()</code>:</p><div><ol class="orderedlist arabic"><li class="listitem">Open <code class="literal">c:\ArcpyBook\Ch4\Crime_DataLinksLayer.mxd</code> in ArcMap. The <strong>Crime</strong> data frame contains a layer called <strong>Burglary</strong>, which is a feature class in the <code class="literal">CityOfSanAntonio</code> file geodatabase. You're going to replace this feature class with a shapefile layer containing the same data:<div><img src="img/4445_04_6.jpg" alt="How to do it…"/></div></li><li class="listitem">Open<a id="id344" class="indexterm"/><a id="id345" class="indexterm"/><a id="id346" class="indexterm"/><a id="id347" class="indexterm"/> IDLE and create a new script window.</li><li class="listitem">Import the <code class="literal">arcpy.mapping</code> module:<div><pre class="programlisting">import arcpy.mapping as mapping</pre></div></li><li class="listitem">Reference the <code class="literal">Crime_BrokenDataLinks.mxd</code> map document file:<div><pre class="programlisting">mxd = mapping.MapDocument(r"c:\ArcpyBook\Ch4\ Crime_DataLinksUpdated.mxd")</pre></div></li><li class="listitem">Get a reference to the <code class="literal">Crime</code> data frame:<div><pre class="programlisting">df = mapping.ListDataFrames(mxd,"Crime")[0]</pre></div></li><li class="listitem">Find the <code class="literal">Burglary</code> layer and store it in a variable:<div><pre class="programlisting">lyr = mapping.ListLayers(mxd,"Burglary",df)[0]</pre></div></li><li class="listitem">Call the <code class="literal">replaceDataSource()</code> method on the <code class="literal">Layer</code> object and pass in the path to the shapefile, a keyword indicating that this will be a shapefile workspace, and the name of the shapefile:<div><pre class="programlisting">lyr.replaceDataSource(r"c:\ArcpyBook\data","SHAPEFILE_WORKSPACE","Burglaries_2009")</pre></div></li><li class="listitem">Save the results to a new map document file.<div><pre class="programlisting">mxd.saveACopy(r"c:\ArcpyBook\Ch4\Crime_DataLinksNewLayer.mxd")</pre></div></li><li class="listitem">Save the<a id="id348" class="indexterm"/><a id="id349" class="indexterm"/><a id="id350" class="indexterm"/><a id="id351" class="indexterm"/> script as <code class="literal">c:\ArcpyBook\Ch4\LayerReplaceDataSource.py</code>.</li><li class="listitem">Run the script.</li><li class="listitem">Open <code class="literal">C:\ArcpyBook\Ch4\Crime_DataLinksNewLayer.mxd</code> in ArcMap. You should see that the <strong>Burglary</strong> layer now references a new workspace:<div><img src="img/4445_04_7.jpg" alt="How to do it…"/></div></li><li class="listitem">Right-click on the <strong>Burglary</strong> layer and select <strong>Properties</strong>.</li><li class="listitem">Click on the <strong>Source</strong> tab and note the new workspace, workspace type, and <a id="id352" class="indexterm"/><a id="id353" class="indexterm"/><a id="id354" class="indexterm"/><a id="id355" class="indexterm"/>dataset name:<div><img src="img/4445_04_8.jpg" alt="How to do it…"/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec84"/>How it works…</h2></div></div></div><p>The <code class="literal">replaceDataSource()</code> method accepts two required parameters and two optional parameters. The first two parameters define the workspace path and workspace type for the layer that will be used as the replacement. The third parameter, <code class="literal">dataset_name</code>, is an optional parameter that defines the name of the dataset that will be used as the replacement layer. This name needs to be an exact match. For example, in this recipe, we passed in a <code class="literal">dataset_name</code> attribute <code class="literal">Burglaries_2009</code>, which is the name of the shapefile that will now be used as the replacement layer in the data frame. If a name is not provided, the method will attempt to replace the dataset by finding a table with the same name as the current layer's dataset property. The final optional parameter is <code class="literal">validate</code>. By default, this value is set to <code class="literal">true</code>. When set to <code class="literal">true</code>, a workspace will only be updated if the <code class="literal">workspace_path</code> value is a valid workspace. If it is not a valid workspace, then the workspace will not be replaced. If set to <code class="literal">false</code>, the method will set the source to match <code class="literal">workspace_path</code> regardless of whether it is a valid match or not. This can result in a broken data source, but can be useful if you are creating or modifying a map <a id="id356" class="indexterm"/>
<a id="id357" class="indexterm"/>
<a id="id358" class="indexterm"/>
<a id="id359" class="indexterm"/>document in preparation for data that does not yet exist.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec85"/>There's more…</h2></div></div></div><p>The <code class="literal">Layer</code> and <code class="literal">TableView</code> classes also contain a <code class="literal">findAndReplaceWorkspacePath() </code>method<a id="id360" class="indexterm"/>. This method is very similar to the <code class="literal">MapDocument.findAndReplaceWorkspacePaths()</code> method. The only difference is that it works against a single <code class="literal">Layer</code> or <code class="literal">TableView</code> class instead of iterating the entire map document or layer file.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec36"/>Finding all broken data sources in all map documents in a folder</h1></div></div></div><p>A common scenario in<a id="id361" class="indexterm"/>
<a id="id362" class="indexterm"/> many organizations involves the movement of data from one workspace to another or from one workspace type to another. When this happens, any map documents or layers that reference these data sources become broken. Finding each of these data sources can be a huge task if undertaken manually. Fortunately, you can create a geoprocessing script that will find all broken data sources in a folder or list of folders.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec86"/>Getting ready</h2></div></div></div><p>In this recipe, you will learn how to recursively search directories for map document files, find any broken data sources within those map documents, and write the names of the broken data layers to a file.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec87"/>How to do it...</h2></div></div></div><p>Follow these steps to learn how to find all broken data sources in all map documents in a folder:</p><div><ol class="orderedlist arabic"><li class="listitem">Open IDLE and create a new script window.</li><li class="listitem">Import the <code class="literal">arcpy</code> and <code class="literal">os</code> packages:<div><pre class="programlisting">import arcpy.mapping as mapping, os</pre></div></li><li class="listitem">Define a path where you'd like to begin the search. In this case, we're going to begin the search from the <code class="literal">C:</code> directory, which will then recursively search all directories inside the <code class="literal">C:</code> drive. You may want to define a more specific path:<div><pre class="programlisting">path = r"C:"</pre></div></li><li class="listitem">Open a file that you will use to which you will write the broken layer names:<div><pre class="programlisting">f = open('BrokenDataList.txt','w')</pre></div></li><li class="listitem">Use the <code class="literal">os.walk()</code> method along with a <code class="literal">for</code> loop to walk the directory tree:<div><pre class="programlisting">for root,dirs,files in os.walk(path):</pre></div></li><li class="listitem">Inside the <code class="literal">for</code> loop, create a second <code class="literal">for</code> loop that loops through all the files returned. For each file, use the <code class="literal">os.path.splitext()</code> method to obtain the base file name as well as the extension:<div><pre class="programlisting">for filename in files:
    basename, extension = os.path.splitext(filename)</pre></div></li><li class="listitem">Test the <a id="id363" class="indexterm"/><a id="id364" class="indexterm"/>file extension to see if it is a map document file. If so, get the full path to the map document file, create a new map document object instance using the path, write the map document name, loop through each of the broken data sources, and write to a file:<div><pre class="programlisting">if extension == ".mxd":
    fullPath = os.path.join(path,filename)
    mxd = mapping.MapDocument(fullPath)
    f.write("MXD: " + filename + "\n")
    brknList = mapping.ListBrokenDataSources(mxd)
    for brknItem in brknList:
        f.write("\t" + brknItem.name + "\n")</pre></div></li><li class="listitem">Close the file:<div><pre class="programlisting">f.close()</pre></div></li><li class="listitem">The entire script should appear as follows:<div><pre class="programlisting">import arcpy.mapping as mapping, os
path = r"C:"
f = open('filename_here.txt','w')
for root,dirs,files in os.walk(path):
    for filename in files:
        basename, extension = os.path.splitext(filename)
        if extension == ".mxd":
            fullPath = os.path.join(path,filename)
            mxd = mapping.MapDocument(fullPath)
            f.write("MXD: " + filename + "\n")
            brknList = mapping.ListBrokenDataSources(mxd)
            for brknItem in brknList:
                f.write("\t" + brknItem.name + "\n")
f.close()</pre></div></li><li class="listitem">Run the<a id="id365" class="indexterm"/><a id="id366" class="indexterm"/> script to generate the file.</li><li class="listitem">Open the file to see the results. Your output will vary depending upon the path you've defined. The following  screenshot shows my output file:<div><img src="img/4445_04_9.jpg" alt="How to do it..."/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec88"/>How it works...</h2></div></div></div><p>This script uses a combination of methods from the Python <code class="literal">os</code> package and <code class="literal">arcpy.mapping</code> package<a id="id367" class="indexterm"/>. The <code class="literal">os.walk()</code> method<a id="id368" class="indexterm"/> walks a directory tree and returns the path, a list of directories, and a list of files for each directory starting with a root directory that you have defined as the <code class="literal">c:</code> directory. This root directory could have been any directory. The <code class="literal">os.walk()</code> method returns a three item tuple consisting of the root directory, a list of directories, and a list of files. We then loop through this list of files and use the <code class="literal">os.path.splitext()</code> method<a id="id369" class="indexterm"/> to split each file into a base file name and file extension. The extension is tested to see if it matches the string <code class="literal">.mxd</code>, which indicates a map document file. Files <a id="id370" class="indexterm"/>
<a id="id371" class="indexterm"/>identified as map documents have their filenames written to a text file, and a new <code class="literal">MapDocument</code> object instance is created. The <code class="literal">ListBrokenDataSources()</code> method<a id="id372" class="indexterm"/> is then used with a reference to the map document to generate a list of broken data sources within the file, and these broken data sources are written to the file as well.</p></div></div></div>
</body></html>