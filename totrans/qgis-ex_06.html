<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Answering Questions with Visibility Analysis</h1></div></div></div><p>Visibility analysis is a <a id="id377" class="indexterm"/>valuable part of GIS analysis that answers questions such as "What can be seen from this location point?" In this chapter, you will be exposed to the basics of visibility analysis through defining the roof that provides the most scenic view of an area, and where the viewing platform can potentially be located. Throughout the chapter, you will learn how to do the following:</p><div><ul class="itemizedlist"><li class="listitem">Prepare data to represent urban landscape features</li><li class="listitem">Select potential observation points</li><li class="listitem">Compute the viewsheds to find the most scenic points</li><li class="listitem">Present the results in a 3D scene</li></ul></div><p>Before we start, we will explore some essential principles of viewshed analysis.</p><div><div><div><div><h1 class="title"><a id="ch06lvl1sec41"/>The basics of visibility analysis</h1></div></div></div><p>The aim of visibility analysis is to produce a coverage of an area that can be seen from a specified location. This coverage<a id="id378" class="indexterm"/> is called a <strong>viewshed</strong>, which is why the terms <strong>visibility analysis</strong> and <strong>viewshed analysis</strong> are <a id="id379" class="indexterm"/>used interchangeably. To perform a simple visibility analysis, you need to<a id="id380" class="indexterm"/> define at least two components:</p><div><ul class="itemizedlist"><li class="listitem"><strong>Observation point</strong>: A point that represents<a id="id381" class="indexterm"/> an observer's position and for which visibility is being analyzed</li><li class="listitem"><strong>DEM</strong>: This represents irregularities in the<a id="id382" class="indexterm"/> earth's surface and is used to examine visibility along the line of sight</li></ul></div><p>The idea underlying the process of this analysis is to compare the height of the observation point against the height of earth's surface point along the given line of sight. If the height of the surface point is less than that of the observation point, then it will be seen from the current position; if it is higher, the visibility line will be blocked. Similarly, all points within a certain radius are compared against the observation point and divided into the two categories, as follows:</p><div><ul class="itemizedlist"><li class="listitem">Visible, with the height lower than the observation height and located below the visibility line</li><li class="listitem">Invisible, with the height higher than the observation height and located above the visibility line</li></ul></div><p>The main output of visibility analysis is a binary true/false viewshed coverage that usually includes visible points and excludes invisible points. Depending on the algorithm used and the capacity of GIS, this basic analytical approach can be modified and improved by the following<a id="id383" class="indexterm"/> features and outputs:</p><div><ul class="itemizedlist"><li class="listitem">Instead of a single observation point, multiple points and even lines can be used</li><li class="listitem">Visibility relationships between several objects can be analyzed, and then intervisibility coverage is produced as the output</li><li class="listitem">Conversely to the assessment of a viewshed for the current observation point, the earth's surface can be analyzed to provide information about points and areas from which a certain object can be seen</li><li class="listitem">A line of the horizon can be modeled as the cumulative edge of visibility zones</li><li class="listitem">Views can be bound by a horizontal or vertical viewing angle or azimuthal values that limit extension of visibility lines</li><li class="listitem">The earth's curvature and atmospheric refraction can be taken into account to simulate more realistic results</li></ul></div><p>The most typical practical application of visibility analysis is in placement of communication towers, where instead of visibility, signal penetration is modeled. Viewsheds are also of great use in territorial and urban planning. For example, some features such as factories or landfills are expected to be hidden from the human' eye because of their unsightly appearance. In this case, the area undergoes a visibility analysis to find places from where such kinds of objects can't be seen. The more the blind spots associated with a certain point, the better it is for the object's location. Furthermore, instead of hiding some objects, viewsheds are used to detect scenery points that provide the most spectacular view of an area. This knowledge is then used for optimal placement of the sight places, which is what we are going to do in this chapter.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec42"/>Step 1 – converting a buildings' vector layer to raster</h1></div></div></div><p>We are going to deal with a highly urbanized landscape, whose primary features have been greatly transformed by <a id="id384" class="indexterm"/>humans. In the context of visibility analysis, this means that lines of sight are blocked mainly by buildings, while the original relief features play only a minor role. In our dataset, we have two layers that describe the area of interest, exterior, and appearance:</p><div><ul class="itemizedlist"><li class="listitem"><code class="literal">lidar_dem</code>: This represents the bare earth only, and provides a description of the general relief</li><li class="listitem"><code class="literal">building_footprints</code>: These are polygons that depict all buildings, and they also contain information about a building's height in feet above the bare earth's surface in the <code class="literal">height_roo</code> attribute field</li></ul></div><p>We need to add their values in order to obtain a meaningful result, but these layers use different data models: DEM is a raster coverage, and building footprints is a vector polygon layer. That is why before adding them, we should first take layers to a single common data model. In GIS, calculations for coverages are typically performed using raster algebra, which means that the <code class="literal">building_footprints</code> vector layer should be converted into a raster, or rasterized. Additionally, if we want this raster layer to contain data about building's height, the <code class="literal">height_roo</code> attribute field should be used as the provider of <em>Z</em> values.</p><p>It is also important that a newly created building footprint's raster has the same extent and resolution as <code class="literal">lidar_dem</code>. To get this information about <code class="literal">lidar_dem</code>, go to <strong>Layer Properties</strong> | <strong>Metadata</strong>. At the bottom of the window, you will see the <strong>Properties</strong> scrolling window section, which contains all of the information important to know in order to work with rasters, namely <strong>Band 1</strong> (statistics), <strong>Dimensions</strong> (number of rows and columns), <strong>Origin</strong> (coordinates of the bottom-left corner), and so on. The parameters of particular interest to us are as follows:</p><div><ul class="itemizedlist"><li class="listitem"><strong>Pixel Size</strong>: This contains the vertical and horizontal lengths of the pixel's sides. Usually, the values are equal, which means that the pixel is a square; but sometimes, it can be rectangular, with unequal values.</li><li class="listitem"><strong>Layer extent (layer original source projection)</strong>: This represents the minimum and maximum horizontal (<em>x</em>) and vertical (<em>y</em>) values of the raster extent, that is, the raster bounding box's northern, southern, eastern, and western limits in the layer's original coordinate reference system.</li></ul></div><p>The following screenshot shows the described parameters for the <code class="literal">lidar_dem</code> layer:</p><div><img src="img/image00442.jpeg" alt="Step 1 – converting a buildings' vector layer to raster"/></div><p style="clear:both; height: 1em;"> </p><p>To rasterize a layer, go to <strong>Raster</strong> | <strong>Conversion</strong> | <strong>Rasterize (Vector to Raster)</strong>. In the dialog window, adjust the following parameters:</p><div><ol class="orderedlist arabic"><li class="listitem"><strong>Input file (shapefile)</strong>: This is a<a id="id385" class="indexterm"/> shapefile to be rasterized. Select <code class="literal">building_footprints</code> from the drop-down list.</li><li class="listitem"><strong>Attribute field</strong>: This defines an attribute field with the values to be burned into an output raster. Select <code class="literal">HEIGHT_ROO</code> from the drop-down list.</li><li class="listitem"><strong>Output file for rasterized vectors (raster)</strong>: There are two possible options in this field. You can select an already existing file, and patches of vector geometry footprints with the selected values will be burned into it. It is very convenient if you have, for example, some gaps in the original raster layer and want to fill them with some values from the vector layer (such as elevation and surface level of water bodies). But we have to deal with the buildings' relative height above the bare earth level. This means that, in order to summarize them with DEM, building footprints should be rasterized as an individual layer. Navigate to your working directory and type <code class="literal">building.tif</code> as a new layer name. You will be shown this message: <strong>The output file doesn't exist. You must set up the output size or resolution to create it.</strong>. Click on <strong>OK</strong> and proceed to the following stage:<div><img src="img/image00443.jpeg" alt="Step 1 – converting a buildings' vector layer to raster"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">In the previous steps, you defined some major options. As we need to create a raster with exactly<a id="id386" class="indexterm"/> the same extent and resolution as <code class="literal">lidar_dem.tif</code>, we will use advanced options by editing the <code class="literal">gdal_rasterize</code> command-line parameters:<div><ol class="orderedlist arabic"><li class="listitem">
Click on the <strong>Edit</strong><img src="img/image00444.jpeg" alt="Step 1 – converting a buildings' vector layer to raster"/> button to make the line editable. All the previous options will be deactivated and grayed out.
</li><li class="listitem">
Delete the <code class="literal">–ts 3000 3000</code> option, as we are going to specify a resolution parameter that makes raster width and height parameters that are defined by <code class="literal">–ts</code> meaningless.
</li><li class="listitem">The <code class="literal">–init 0</code> parameter defines the initial values of the output raster. It creates an empty raster with initially predefined values, and then vector<a id="id387" class="indexterm"/> values are burned into it. In our case, this means that building-free areas will be assigned zero values.</li><li class="listitem">The target extent is defined by the <code class="literal">–te</code> parameter described by space-separated bounding box values (<strong>Xmin</strong>, <strong>Ymin</strong>, <strong>Xmax</strong>, and <strong>Ymax</strong>) in georeferenced units. If you want to use a predefined extent, just copy its values from a piece of correspondent raster metadata. Don't forget to replace the commas and semicolons with spaces.</li><li class="listitem">The target resolution (<code class="literal">–tr</code>) parameter defines the vertical and horizontal pixel size in units specified by the layer's CRS.</li><li class="listitem">The output data type is defined by the <code class="literal">–ot</code> parameter, whose default value is <code class="literal">Float64</code>, but we replace it by <code class="literal">Float32</code>, which is the same as that for <code class="literal">lidar_dem.tif</code>.</li></ol><div></div></li></ol><div></div><p>The resulting line will look as follows:</p><div><pre class="programlisting">
<strong>gdal_rasterize -a HEIGHT_ROO -l building_footprints -init 0 -te 982199.3000000000465661 188224.6749999999883585 991709.3000000000465661 196484.6749999999883585 -tr 10 10 -ot Float32 fullpath/building_footprints.shp fullpath/building.tif</strong>
</pre></div><div><h3 class="title"><a id="note31"/>Note</h3><p>To convert a vector to<a id="id388" class="indexterm"/> a raster, we have used a tool called <code class="literal">gdal_rasterize</code> from the <strong>Geospatial Data Abstraction Library</strong> (<strong>GDAL</strong>). You can read an extended synopsis of the <code class="literal">gdal_raserize</code> parameters and their values from <a class="ulink" href="http://www.gdal.org/gdal_rasterize.html">http://www.gdal.org/gdal_rasterize.html</a>.</p></div><p>After hitting <strong>OK</strong>, the resulting raster will be created and added to the map canvas. If you click on any pixel with the <strong>Identify Features</strong> tool selected, a height value of the building will be displayed, and if you click on an empty space, it will show <code class="literal">0</code>. The layer itself will look similar to the following screenshot:</p><div><img src="img/image00445.jpeg" alt="Step 1 – converting a buildings' vector layer to raster"/></div><p style="clear:both; height: 1em;"> </p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec43"/>Step 2 – combining the DEM and buildings layers</h1></div></div></div><p>Now, we need to combine the two layers into a single layer by adding their values. <strong>Raster algebra</strong> is a common approach to<a id="id389" class="indexterm"/> overlaying a raster layer (or layers), combining their values using algebraic operations (addition, subtraction, multiplication, division, and so on), and calculating values for a new raster layer. Modern GIS software uses so-called raster calculators that help create, validate, and apply raster algebra expressions<a id="id390" class="indexterm"/> to raster datasets.</p><p>QGIS also has its own raster<a id="id391" class="indexterm"/> calculator located at <strong>Raster</strong> | <strong>Raster Calculator</strong>. The <strong>Calculator</strong> dialog window consists of the following parts:</p><div><ul class="itemizedlist"><li class="listitem"><strong>Raster bands</strong>: In the top-left corner of the window, you can see the list of all rasters available in the project. The raster band number is separated from its name by an <code class="literal">@</code> sign. If the layer is a single-band raster, then only <code class="literal">name@1</code> appears in the list, but if it is a multiband raster, then <code class="literal">name@1</code>, <code class="literal">name@2</code>, and so on up to <code class="literal">name@n</code> (where <em>n</em> is the total number of bands in the multiband raster) will be shown for each band separately.</li><li class="listitem"><strong>Result layer</strong>: In the top-right part of the calculator window, you can adjust the output raster properties. The <strong>Current layer extent</strong> button sets up an output extent from the raster layer that is currently selected in the <strong>Raster bands</strong> list on the left side. It is very useful when you are working with layers that have different extents, and allows you to decide which extent to use.</li><li class="listitem"><strong>Operators</strong>: In the central part of the window, there are various operator buttons that can be used to construct expressions. Click on the relevant button to add an operator, or type it manually.</li><li class="listitem"><strong>Raster calculator expression</strong>: In the bottom part of the calculator, there is the expression<a id="id392" class="indexterm"/> window, where the calculation formula to be used is displayed. Double-click on the relevant layer to add it to the expression (it will be shown in double quotes). Note that for the expression, we type only the right side of the calculation formula, which comes after the equal to sign. Under the expression, you will see the <strong>Expression valid/ invalid</strong> message change dynamically, and this helps you control the <a id="id393" class="indexterm"/>correctness of the constructed formula.</li></ul></div><p>In the following screenshot, you can see that we apply a simple addition formula (<code class="literal">"building@1" + "liadar_dem@1"</code>) to combine rasterized buildings' heights and DEM layers:</p><div><img src="img/image00446.jpeg" alt="Step 2 – combining the DEM and buildings layers"/></div><p style="clear:both; height: 1em;"> </p><p>After you've<a id="id394" class="indexterm"/> clicked on the <strong>OK</strong> button, the calculation is performed and a newly created <code class="literal">urban_surface</code> raster appears in the <strong>Layers</strong> panel. Now, we <a id="id395" class="indexterm"/>can check its values with the <strong>Identify features</strong> tool <img src="img/image00447.jpeg" alt="Step 2 – combining the DEM and buildings layers"/>:</p><div><ol class="orderedlist arabic"><li class="listitem">Uncheck all unnecessary layers except those from <code class="literal">urban_surface</code>, <code class="literal">building</code>, and <code class="literal">lidar_dem</code>. Maintaining their order simplifies the interpretation of <strong>Identify Results</strong>.</li><li class="listitem">Go to the <strong>Identify Results</strong> tab. From the <strong>Mode</strong> drop-down list, select <strong>Top down</strong>. The identified values will be shown for all the active layers in order, from top to bottom.</li><li class="listitem">From the <a id="id396" class="indexterm"/><strong>View</strong> drop-down list, select <strong>Table</strong>. The identified values will be organized into a simple table, as shown in this <a id="id397" class="indexterm"/>screenshot:<div><img src="img/image00448.jpeg" alt="Step 2 – combining the DEM and buildings layers"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div></div><p>Now, by clicking on any point in the map canvas, you can explore values and make sure that they have been added properly.</p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec44"/>Step 3 – defining observation points</h1></div></div></div><p>Observation points play<a id="id398" class="indexterm"/> an important role in visual exploration of modern cityscapes. Usually, they are represented by the highest points in an area that provide the most spectacular views. Therefore, viewing platforms in the city are usually located on rooftops. In this section, we are going to create a layer that contains several prospective viewing platforms through the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Creating an empty vector layer</li><li class="listitem">Populating it with some points that represent the highest buildings</li><li class="listitem">Providing them with the information on height from the <code class="literal">buildings_footprint</code> layer</li></ol><div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec45"/>Creating an empty vector layer</h2></div></div></div><p>To create a vector layer, go<a id="id399" class="indexterm"/> to <strong>Layer</strong> | <strong>Create layer</strong>. There are three options available here:</p><div><ul class="itemizedlist"><li class="listitem"><strong>New Shapefile Layer</strong>: Also accessible by the <em>Ctrl</em> + <em>Shift</em> + <em>N</em> keyboard shortcut, this creates a new empty shapefile layer.</li><li class="listitem"><strong>New SpatiaLite Layer</strong>: Also accessible by the <em>Ctrl</em> + <em>Shift</em> + <em>A</em> keyboard shortcut, this creates an empty SpatiaLite layer within a specified SpatiaLite database (by default, a currently connected database is specified).</li><li class="listitem"><strong>New Temporary Scratch Layer</strong>: This creates a temporary layer that can be used and analyzed like any other layer within a working session, but the layer will disappear if it is not saved before closing the project. These layers are meant to be drafts, and using them for testing purposes prevents cluttering your project. This is the option we will use to create an empty layer.</li></ul></div><p>Similarly, you can use a relevant button from the <strong>Manage Layers</strong> toolbar and the small triangle beside it to get access to the options, as shown in the following screenshot:</p><div><img src="img/image00449.jpeg" alt="Creating an empty vector layer"/></div><p style="clear:both; height: 1em;"> </p><p>After selecting <strong>New Temporary Scratch Layer</strong>, you will see this dialog window:</p><div><img src="img/image00450.jpeg" alt="Creating an empty vector layer"/></div><p style="clear:both; height: 1em;"> </p><p>Consider the <a id="id400" class="indexterm"/>options in the <strong>New Temporary Scratch Layer</strong> window, as follows:</p><div><ul class="itemizedlist"><li class="listitem"><strong>Layer name</strong>: Type in a name or leave the default as it is, because we are going to use the layer for temporary work and its name really doesn't matter.</li><li class="listitem"><strong>Type</strong>: This defines the geometry type. As we are going to set up observation points, the default <strong>Point</strong> option is suitable.</li><li class="listitem"><strong>Selected CRS</strong>: A default projection is selected, but you need to set up a projection of your project in order for the layer to be processed correctly. To do so, select the <strong>Project CRS</strong> option from the drop-down combobox.</li></ul></div><p>After clicking on <strong>OK</strong>, a <strong>New scratch layer</strong> will be added to the <strong>Layers</strong> panel. By default, editing mode for the layer is activated (you can see it as a little pencil drawn above its marker symbol beside the layer's name) as shown in the following screenshot. Now we can proceed to the next stage and add some points to it.</p><div><img src="img/image00451.jpeg" alt="Creating an empty vector layer"/></div><p style="clear:both; height: 1em;"> </p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec46"/>Populating a layer with points</h2></div></div></div><p>Activate the <strong>Digitizing</strong> toolbar, if it has not already been done. You can do this by going to <strong>View</strong> | <strong>Toolbars</strong> | <strong>Digitizing</strong>, or simply by right-clicking somewhere on the toolbar's panel and activating the relevant toggle. The toolbar contains the primary digitizing tools, and looks like this:</p><div><img src="img/image00452.jpeg" alt="Populating a layer with points"/></div><p style="clear:both; height: 1em;"> </p><p>This panel's buttons provide access to the following options (from left to right):</p><div><ul class="itemizedlist"><li class="listitem"><strong>Current edits</strong>: This maintains edits within a current editing session for the selected layer (or layers). Click on the little black triangle in the bottom-right corner of the button to access the <strong>Save</strong>, <strong>Rollback</strong>, or <strong>Cancel</strong> options for your edits. Note that these options are available until the <strong>Save Layer Edits</strong> button isn't clicked on.</li><li class="listitem"><strong>Toggle Editing</strong>: This button activates/deactivates the editing mode.</li><li class="listitem"><strong>Save Layer Edits</strong>: This saves all the current edits without exiting the editing session. After clicking on this button, edits cannot be rolled back. It is inactive when there are no edits to save.</li><li class="listitem"><strong>Add Feature</strong>: Use this button to draw new features on the layer. Its appearance depends on layer's geometry type. Currently, it shows points because you are editing a point layer.</li><li class="listitem"><strong>Move Feature(s)</strong>: When this button is selected, you can move one or several features. It is important to note that if you are going to move multiple features, they should have been previously selected.</li><li class="listitem"><strong>Node Tool</strong>: This tool is used to add, remove, or move vertices of geometric features such as lines and polygons. It is unnecessary for a point layer and is therefore inaccessible.</li><li class="listitem"><strong>Delete Selected</strong>: This deletes the previously selected feature (or features). Until the edits are saved, they can be rolled back through the <strong>Current Edits</strong> button options.</li><li class="listitem"><strong>Cut/ Copy/ Paste Features</strong>: Similarly to other kinds of software, you can use these buttons to cut or copy features onto the clipboard and then paste them. Features must be previously selected if you want to apply these options. While <strong>Cut</strong> and <strong>Paste</strong> are available only in editing mode, <strong>Copy</strong> can be used with any other layer, and is of great use when moving features between layers.<div><h3 class="title"><a id="tip23"/>Tip</h3><p>You can also use more complex digitizing tools and options, such as feature rotation, simplification, adding parts and rings, and so on. These are available from the <strong>Advanced Digitizing</strong> panel, as shown in the following screenshot:</p><div><img src="img/image00453.jpeg" alt="Populating a layer with points"/></div><p style="clear:both; height: 1em;"> </p><p>Moreover, the panel provides access<a id="id401" class="indexterm"/> to input tools that are similar to those used in <strong>computer-aided design</strong> (<strong>CAD</strong>) systems. These tools allow digitizing with precise numerical values of coordinates, distances, and angles; control segments; parallelism; and perpendicularity, as shown in the following screenshot:</p><div><img src="img/image00454.jpeg" alt="Populating a layer with points"/></div><p style="clear:both; height: 1em;"> </p></div></li></ul></div><p>Now that you are<a id="id402" class="indexterm"/> familiar with the <strong>Digitizing</strong> toolbar, <strong>Toggle editing</strong>, and using <strong>Add Feature</strong>, click on different places to locate some observation points. Remember that these points should be placed on the footprints of the highest buildings. It is recommended to use the previously created <code class="literal">urban_surface</code> raster as a background, as it helps locate the points properly. Now, add several points (five to seven are enough) by clicking on the map canvas. Click on the <strong>Toggle editing</strong> button to exit editing mode. Click on the <strong>Save</strong> button when you are asked about edits. As a result, your map will look similar to this screenshot:</p><div><img src="img/image00455.jpeg" alt="Populating a layer with points"/></div><p style="clear:both; height: 1em;"> </p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec47"/>Providing points with height values</h2></div></div></div><p>As we are going to locate<a id="id403" class="indexterm"/> viewing platforms on the rooftops, taking into account the height of the building is of great importance to obtain realistic modeling results. Instead of looking for the necessary building and its height and adding the height value to the visibility points manually, we will automatically join attributes, taking into account the locations of the points. This operation—when you merge attributes from two different layers based on their spatial relationship—is very common in GIS <a id="id404" class="indexterm"/>and is called a <strong>spatial join</strong>.</p><p>Go to <strong>Vector</strong> | <strong>Data Management Tools</strong> | <strong>Join Attributes by Location</strong>. In the dialog window, the<a id="id405" class="indexterm"/> following options are present:</p><div><ul class="itemizedlist"><li class="listitem"><strong>Target vector layer</strong>: The layer to which attributes will be joined; in our case, it's <strong>New scratch layer</strong>.</li><li class="listitem"><strong>Join vector layer</strong>: The layer from which attributes will be taken; in our case, it is <code class="literal">building_footprints</code>.<div><img src="img/image00456.jpeg" alt="Providing points with height values"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem"><strong>Attribute Summary</strong> deals with multiple attribute values available for joining. The <strong>Take attributes of first located feature</strong> option joins a single value, and this is the default action that we select. Optionally, you can activate <strong>Take summary of intersection features</strong> and select one or several summarizing functions (<strong>Mean</strong>, <strong>Min</strong>, <strong>Max</strong>, and so on).</li><li class="listitem"><strong>Output Shapefile</strong> provides the path to the resulting vector layer. Click on the <strong>Browse</strong> button to select the necessary directory and type a name, for example, <code class="literal">observ_points</code>.</li><li class="listitem"><strong>Output table</strong> is responsible for the number of records in the resulting attribute table. We leave the <strong>Only keep matching records</strong> default option as selected because we only need records of buildings that match with the observation points.</li></ul></div><p>After clicking on<a id="id406" class="indexterm"/> <strong>OK</strong> and completing the spatial join, you will be informed that a new layer has been created and asked, "Would you like to add the new layer to the TOC?" Click on <strong>Yes</strong>, and the layer will be loaded and appear in the map canvas. Click on the <strong>Close</strong> button to exit the <strong>Join attributes by location</strong> dialog window.</p><p>Now, if you open the <code class="literal">observ_point</code> attribute table, you will see that all the attributes from matching buildings in the <code class="literal">building_footprint</code> layer have been joined to the points. This tool may be of great use when working with a large number of entities.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec45"/>Step 4 – creating viewshed coverages</h1></div></div></div><p>In this section, we will apply the<a id="id407" class="indexterm"/> advanced visibility analysis tools that are available from the <strong>Viewshed Analysis</strong> plugin. Install it as described in the <em>Extending functionality through plugins</em> section of <a class="link" title="Chapter 1. Handling Your Data" href="part0014.xhtml#aid-DB7S2">Chapter 1</a>, <em>Handling Your Data</em>.</p><p>After the plugin has been installed, you can get access to its functionality by going to <strong>Plugin</strong> | <strong>Viewshed Analysis</strong>. The <strong>Advanced viewshed analysis</strong> dialog window consists of three tabs. The <strong>General</strong> tab provides access to all the available analysis and output options. The <strong>Reference</strong> tab contains brief descriptions of the options and a link to the project's homepage, where you can read detailed information about the algorithm implemented in the plugin and report bugs, if any. The <strong>About</strong> tab contains brief information about the author and the plugin's homepage link.</p><p>Use the following options under the <strong>General</strong> tab to create viewshed coverages, as shown in the following screenshot:</p><div><ul class="itemizedlist"><li class="listitem"><strong>Elevation raster</strong>: Select the <code class="literal">urban_surface</code> raster to represent the earth's surface and buildings on it.</li><li class="listitem"><strong>Observation points</strong>: Select the <code class="literal">observ_points</code> point layer.</li><li class="listitem"><strong>Output file</strong>: Click on the <strong>Browse</strong> button, navigate to the working directory, and type a name for the output raster layer. Note that one output raster file will be created for each observation point, and the typed filename will be used as a template that will be accompanied by the output coverage type (viewshed, intervisibility, invisibility, and horizon) and index number. For this reason, we call the output layer <code class="literal">coverage</code>, presuming that the explanatory <a id="id408" class="indexterm"/>parameters (coverage type and point number) will be added automatically.<p>Our goal is to find the point (or points) of the most scenic view, so there is no need to analyze the points' intervisibility. Hence, the <strong>Target points</strong> (intervisibility) field is omitted.</p></li><li class="listitem"><strong>Search radius</strong>: This is the size of the area observed around a point in the layer's measurement units (feet in our case). The higher the value, the longer the time taken to produce coverages. Accept the default value of 5000.</li><li class="listitem"><strong>Observer height</strong>: This defines the height of an observation point above the earth's surface. Usually, the higher the point, the better the observation. Instead of the predefined height, select <code class="literal">HEIGHT_ROO</code> from the field drop-down list.</li><li class="listitem"><strong>Target height</strong>: This is necessary when you want to know whether any target objects of a specific height are visible from the current position. We omit this option because we are more interested in the general visibility than in the visibility of specific objects.</li><li class="listitem"><strong>Adapt to highest point at distance of</strong>: This option finds the highest point in the observer or target vicinity within a certain area, defined in pixels. It may be of great use when your observation points provide approximate locations, and you need their height values to be adjusted to the highest point within the surrounding area. As we already have the exact height values, this option will be omitted.</li><li class="listitem"><strong>Output</strong>: This can be represented by the following coverages:<div><ul class="itemizedlist"><li class="listitem"><strong>Binary viewshed</strong>: This is a simple raster coverage where all pixel values are assigned <code class="literal">0</code> (invisible) or <code class="literal">1</code> (visible). Activate this option to create viewsheds.</li><li class="listitem"><strong>Invisibility depth</strong>: This measures the size an object should attain in order to become visible if placed in an area which is out of view. In other words, it defines the number of height units required for an object to become visible within a given radius. The output raster is a kind of inverted visibility raster where all visible pixels are assigned 0 as the value and all invisible pixels are assigned<a id="id409" class="indexterm"/> negative height values (the lower the value, the more invisible an object).<div><img src="img/image00457.jpeg" alt="Step 4 – creating viewshed coverages"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem"><strong>Intervisibility</strong>: The output will be a shapefile that represents a network of visual relations between the observation points. In the output network, points that can be visible from each other are connected.</li><li class="listitem"><strong>Horizon</strong>: The output raster coverages represent the horizon line or the edge of the visibility area.</li></ul></div><p>Optionally, instead of multiple coverages, a single <strong>cumulative</strong> raster that summarizes raster coverages to generalize analysis results can be created. Then, <code class="literal">0</code> values are assigned to invisible pixels, and positive values are assigned to visible pixels (higher values correspond to pixels visible from multiple observation points).</p></li><li class="listitem"><strong>Use earth curvature option</strong>: This takes into account the earth's curvature and the effects of refraction of light when traveling through the atmosphere. Activate this<a id="id410" class="indexterm"/> option and accept the default <code class="literal">0.13</code> refraction value. After all the options are adjusted, click on the <strong>OK</strong> button and wait for the results to be loaded into the map canvas.</li></ul></div><p>Similarly, you can create the <strong>Horizon</strong> individual coverages. As a result, a total of 18 raster coverages will be added to the map canvas:</p><div><ul class="itemizedlist"><li class="listitem"><code class="literal">coverage_N_Binary</code>: A binary visibility raster where <em>N</em> is the number of observation point</li><li class="listitem"><code class="literal">coverage_N_Horizon</code>: A raster that represents the horizon line for the point <em>N</em></li></ul></div><p>In the following screenshot, you can see the example combination of binary visibility (on the left) and the horizon line (on the right) coverages for the same observation point:</p><div><img src="img/image00458.jpeg" alt="Step 4 – creating viewshed coverages"/></div><p style="clear:both; height: 1em;"> </p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec46"/>Step 5 – finding scenic points</h1></div></div></div><p>Now, we should go<a id="id411" class="indexterm"/> through all the observation points and corresponding coverages, adjust their visualization options, and select the point (or points) that provides the best view of the area of interest.</p><p>First of all, we need to enumerate the points properly in order to be able to distinguish between them. Follow these steps to do so:</p><div><ol class="orderedlist arabic"><li class="listitem">
Select <strong>Open Attribute Table</strong> from the <code class="literal">observ_points</code> by right-clicking on the contextual shortcut, or click on the correspondent button <img src="img/image00459.jpeg" alt="Step 5 – finding scenic points"/> from the <strong>Attributes</strong> toolbar.
</li><li class="listitem">
Select <strong>Open Field calculator</strong><img src="img/image00460.jpeg" alt="Step 5 – finding scenic points"/> from the table toolbar or use the <em>Ctrl</em> + <em>I</em> keyboard shortcut.</li><li class="listitem">
In the <strong>Field calculator</strong> dialog window, activate the <strong>Update existing field</strong> option, and<a id="id412" class="indexterm"/> make sure that the <code class="literal">OBJECTID</code> attribute field is selected from the drop-down list, as shown in the following screenshot. This field already contains values that were joined from the <code class="literal">building_footprints</code> layer. These values are independent of the point number, and this is why we are using the update option to change the existing values to consistent values.</li><li class="listitem">In the <strong>Expression</strong> tab, expand the <strong>Record</strong> group, which contains functions that operate on record identifiers. Select and double-click on the <strong>$id</strong> function to be added to the <strong>Expression</strong> window. This function returns the feature ID of the current row, which will help us identify the points and the correspondent coverages properly.<p>Click on the <strong>OK</strong> button. <strong>Edit mode</strong> will be automatically turned on and the records' values will be updated.</p><div><img src="img/image00461.jpeg" alt="Step 5 – finding scenic points"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem"><strong>Toggle editing mode</strong><img src="img/image00462.jpeg" alt="Step 5 – finding scenic points"/> from the <strong>Table</strong> toolbar or use the <em>Ctrl</em> + <em>E</em> keyboard<a id="id413" class="indexterm"/> shortcut to exit editing mode. You will be asked whether you want to save the changes made to the <code class="literal">observ_points</code> layer. Click on the <strong>Save</strong> button and close the attribute table.
</li><li class="listitem">Double-click on the <code class="literal">observ_points</code> layer to open its <strong>Layer Properties</strong> dialog window. In the <strong>Labels</strong> section, activate the <strong>Label this layer with</strong> option and select the <code class="literal">OBJECTID</code> field for labeling. Adjust any other labeling options, if needed, and click on <strong>OK</strong> to exit the window. When the observation points are labeled, it will be much easier to analyze them and their viewsheds.</li></ol><div></div><p>Now, we will adjust the symbology of the visibility layers to simplify their interpretation. Let's start from the<a id="id414" class="indexterm"/> very beginning—point number <code class="literal">0</code>. Follow these steps to achieve meaningful results:</p><div><ol class="orderedlist arabic"><li class="listitem">Activate the <code class="literal">coverage_0_Horizon</code> and <code class="literal">coverage_0_Binary</code> layers, and deactivate all other visibility layers. Make sure that the layers lie under <code class="literal">observ_points</code>. Activate any other layers that might be of interest when analyzing visibility (for example, <code class="literal">urban_surface</code>, <code class="literal">roads</code>, and so on), and make sure that they underlie visibility rasters.</li><li class="listitem">Adjust the <code class="literal">coverage_0_Horizon</code> layer's style. This layer contains only two values: <code class="literal">1</code> represents the horizon line (that is, the edge of the visibility area), and <code class="literal">0</code> represents all other areas. Double-click on its name in the <strong>Layers</strong> panel to open the <strong>Layer Properties</strong> dialog, go to the <strong>Style</strong> section, and adjust the following parameters:<div><ul class="itemizedlist"><li class="listitem">From the <strong>Render type</strong> drop-down list, select <strong>Singleband pseudocolor</strong>.</li><li class="listitem">Set <strong>Color interpolation</strong> to <strong>Exact</strong>, as we have only two values and want them to be assigned to the selected colors.</li><li class="listitem">
Use the <img src="img/image00463.jpeg" alt="Step 5 – finding scenic points"/> button to add the necessary values manually. Enter <code class="literal">0</code> and double-click on its <strong>Color </strong>sample. In the <strong>Change color</strong> window, select black from <strong>Standard colors</strong>, and using the <strong>Opacity slider</strong>, set the transparency to <code class="literal">25%</code>. Click on the <strong>OK</strong> button to come back to the main styling options.
</li><li class="listitem">Again, add one more row for the value of <code class="literal">1</code>, and assign it a bright, contrasting color to make the horizon line distinguishable on the map. Type in the explanatory names for values in the <strong>Label</strong> field. Your color table should look similar to the following screenshot:</li></ul></div><div><img src="img/image00464.jpeg" alt="Step 5 – finding scenic points"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">
Open the <code class="literal">coverage_0_Binary</code> properties dialog by double-clicking on the layer name in the <strong>Layers</strong> panel, and go to the <strong>Transparency</strong> section. We will use <strong>Custom transparency</strong> options and <strong>Transparent pixel list</strong> to adjust the pixels' transparency properties according to their values. The binary visibility raster contains only two values: <code class="literal">1</code> for visible areas and <code class="literal">0</code> for invisible areas. To add these values to the list, click on <img src="img/image00463.jpeg" alt="Step 5 – finding scenic points"/>, the <strong>Add values manually</strong> button. A new row will appear in the list. There, you should manually enter the <strong>From</strong> and <strong>To</strong> values, and adjust or accept the <strong>Percent Transparent</strong> value, which is set to <code class="literal">100</code> by default. As we are going to use values instead <a id="id415" class="indexterm"/>of ranges to set the transparency, the <strong>From</strong> and <strong>To</strong> entries will be identical:
<div><ul class="itemizedlist"><li class="listitem">In the first row, enter <code class="literal">1</code> and accept the 100% transparency.</li><li class="listitem">
Click on <img src="img/image00463.jpeg" alt="Step 5 – finding scenic points"/> again to add the next row, enter <code class="literal">0</code> in <strong>From</strong> and <strong>To</strong>, and set the transparency to <code class="literal">25%</code>. As a result, your <strong>Transparent pixel list</strong> will look like this:
</li></ul></div><div><img src="img/image00465.jpeg" alt="Step 5 – finding scenic points"/></div><p style="clear:both; height: 1em;"> </p>After making all the necessary adjustments, click on the <strong>OK</strong> button to apply them.</li><li class="listitem">Apply the same styling options for the layers of the other points. Instead of working on every raster individually, right-click and navigate to <strong>Styles</strong> | <strong>Copy Style</strong> to replicate the preliminary configured visualization options from <code class="literal">coverage_0_Horizon</code> and <code class="literal">coverage_0_Horizon</code>. Then, go to <strong>Styles</strong> | <strong>Paste Style</strong> to insert them into the appropriate layers.</li></ol><div></div><p>If the coverages are visualized properly, we only need to visually interpret them and make a decision about the best points after considering several criteria. First of all, a point should provide a view for the vast areas, and this can be analyzed through binary coverages; the more the area open to the observer, the better. Secondly, the horizon line should be clear, solid, and not disrupted by artifacts, if possible. The integrity of the visibility edge ensures panoramic views, and it can be analyzed through horizon coverages; the straighter and simpler the line, the better.</p><p>Finally, you should<a id="id416" class="indexterm"/> always take into account the local features represented by sights, open spaces, and any other possible points of interest. Regarding New York city's Brooklyn borough, there are a few remarkable features that you have probably heard about: the Brooklyn bridge and the waterfront area where the Brooklyn Bridge Park is located. This area is famous for its beautiful sunsets and awe-inspiring views of Manhattan and the East River. Taking into consideration all of these criteria, point number 7 would probably be the best choice. Not only does it provide views of the southern and northeastern parts of the area, but it also encompasses the waterfront area almost entirely, as shown here:</p><div><img src="img/image00466.jpeg" alt="Step 5 – finding scenic points"/></div><p style="clear:both; height: 1em;"> </p><p>When the winner among the best view is chosen, we can proceed to the following step and visualize the results of the analysis. Instead of representing them in a conventional cartographic way, we will use the power <a id="id417" class="indexterm"/>of three-dimensional visualization, which is of great use when dealing with urban landscapes.</p></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec47"/>Step 6 – styling the results in 3D</h1></div></div></div><p>In this section, we will represent our <a id="id418" class="indexterm"/>data in a 3D scene using the impressive capabilities of the <strong>Qgis2threejs</strong> plugin. Install it as described in the <em>Extending functionality through the plugins</em> section of <a class="link" title="Chapter 1. Handling Your Data" href="part0014.xhtml#aid-DB7S2">Chapter 1</a>, <em>Handling Your Data</em>. This plugin relies on the <code class="literal">three.js</code> library. It <a id="id419" class="indexterm"/>allows us to export terrain data, the map canvas image, and vector data straight to a web browser. As a result, you can view and explore exported objects as a 3D scene on web browser that supports WebGL.</p><p>After the installation is completed, the plugin is available from the <strong>Qgis2threejs</strong> menu under <strong>Web</strong>. There are two submenus available:</p><div><ul class="itemizedlist"><li class="listitem"><strong>Settings</strong>: This is responsible for defining a browser that will be used to open generated 3D scenes. These settings should not be changed if you want your default browser to be used.</li><li class="listitem"><strong>Qgis2threejs</strong>: This is the main window of the plugin, and it provides access to its general functionality. In the left part of the window, you can see the list of all available control parameters and the project's layers. The right part of the window provides access to their settings and changes interactively, depending on the item selected on the left.</li></ul></div><p>First of all, you need to<a id="id420" class="indexterm"/> adjust the map layers that will be used to generate an image draped over the terrain. For this example, we activate the following layers ordered from bottom to top: <code class="literal">water_area</code>, <code class="literal">parks</code>, <code class="literal">roads</code>, and <code class="literal">coverage_7_Binary</code>. You can always add more layers or even use the predefined WMS/ WFS or OpenLayers plugin coverages, for example, OpenStreetMap. These active layers will be used to <a id="id421" class="indexterm"/>provide background terrain.</p><div><h3 class="title"><a id="note32"/>Note</h3><p>In the following sections, we are going to explore only the basic settings of the plugin that are necessary for generating a meaningful result from the training data. Extended help and descriptions of the parameters are available at <a class="ulink" href="https://github.com/minorua/Qgis2threejs/wiki/ExportSettings">https://github.com/minorua/Qgis2threejs/wiki/ExportSettings</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec48"/>Working on the general settings of a 3D scene</h2></div></div></div><p>Once all the<a id="id422" class="indexterm"/> necessary layers are active, go through the following options<a id="id423" class="indexterm"/> to adjust the general settings of the scene:</p><div><ul class="itemizedlist"><li class="listitem"><strong>Template file</strong>: Here, you can select different output templates from the drop-down list. Use the default <strong>3DViewer(dat-gui).html</strong> option, as it not only generates a 3D scene but also adds a control parameters panel to regulate the visibility and opacity of the layers and vertical movement of a custom horizontal plane.</li><li class="listitem"><strong>World</strong>: This item is responsible for the general appearance of the scene in the 3D world. The parameter we are especially interested in is <strong>Vertical</strong> <strong>exaggeration</strong>, as it defines the complexity of relief appearance. The bigger the value, the more emphasized terrain will reflect the relief features. Also, this value affects the <em>Z</em> positions of all vector 3D objects and 3D object heights of some object types with volume (points and extruded polygons). The default value is set to <code class="literal">1.5</code>, but our area of interest has a plane relief with smoothly changing values, so we enter <code class="literal">2</code> to make changes in the height more obvious.</li><li class="listitem"><strong>Controls</strong>: There are two available control choices, accompanied by descriptions. Leave the default <code class="literal">OrbitControl.js</code> unchanged.</li><li class="listitem"><strong>DEM</strong>: From the <strong>DEM</strong> layer drop-down list of available rasters, select <code class="literal">lidar_dem</code>, which will be used to provide actual information about heights of the area and generate a terrain of predefined vertical exaggeration. There are several sections that provide parameters to regulate DEM appearance:<div><ul class="itemizedlist"><li class="listitem">The <strong>Resampling</strong> block is responsible for the generated surface resolution and provides various options for its adjustment. For the purpose of this tutorial, we will simply move the slider to the fourth tick, which gives an output resolution close to 400 x 400 pixels <a id="id424" class="indexterm"/>and resamples the original DEM to approximately 26.8 feet. This approach is fast and produces a lightweight output, but resampling values affects the DEM's resolution, not the texture draped over it. If you want to produce more sophisticated and high-resolution results, read about the advanced settings, but bear in mind that high-resolution output takes more time to export, and also that the scene itself will require more computer resources to be responsive and rendered fast.</li><li class="listitem"><strong>Display type</strong>: Accept all the default settings that presume use of <strong>Map canvas image</strong> as a texture.</li><li class="listitem"><strong>Sides and frame</strong>: Accept the default <strong>Build sides</strong> option. It adds sides and a bottom to the DEM.</li></ul></div></li><li class="listitem"><strong>Additional DEM</strong>: this option is might be of great use if you want to combine two rasters that contain some <em>Z</em> values (for example, absolute height and slope, heat maps and so on). As we are mainly interested in buildings and binary visibility rasters, this option is omitted.</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec49"/>Adjusting 3D visualization of the observation points</h2></div></div></div><p>Expand the<a id="id425" class="indexterm"/> <strong>Point</strong> item <a id="id426" class="indexterm"/>on the left side of the window to see all the available point layers, and activate <code class="literal">observ_point</code>. In the right part of the window, adjust the following settings:</p><div><ol class="orderedlist arabic"><li class="listitem">For <strong>Object type</strong>, accept the default <strong>Sphere</strong> value. The observation points will be represented by spheres in the 3D space.</li><li class="listitem">Set <strong>Z coordinate Mode</strong> to <strong>+"HEIGHT_ROO"</strong>, which means that the height of a point will be obtained from the following formula: <em>z = elevation at vertex + field value + addend</em> <em>= DEM + HEIGHT_ROO</em>. In other words, we only summarize the elevation of the relief and the height of the building at a certain point, without any other values (<em>addend</em> is set to 0 and excluded from the second part of the formula). As a result, the point will take into account the local relief and represent the real vertical position of the observer.</li><li class="listitem">The <strong>Style</strong> section is responsible for the visual properties of the symbol:<div><ul class="itemizedlist"><li class="listitem">Set <strong>Color</strong> to <strong>Random</strong> from the drop-down list, and the spheres will be assigned a color randomly.</li><li class="listitem">Accept the default <strong>Feature style</strong> option under <strong>Transparency</strong>. It will make the points solid, not transparent.</li><li class="listitem">As we want all spheres to have the same size, we accept the <strong>Fixed value</strong> under <strong>Radius</strong> as it is. Type <code class="literal">50</code> in the <strong>Value</strong> field.</li></ul></div></li><li class="listitem">Now, let's<a id="id427" class="indexterm"/> consider <strong>Features that intersect with map canvas extent</strong>. With this default option, only the features that are displayed on the map canvas will be exported.</li><li class="listitem">The <strong>Attribute and label</strong> section provides access to the labeling options:<div><ul class="itemizedlist"><li class="listitem">Activate <strong>Export</strong> attributes to enable labeling. All the attributes will be exported and shown when you click on the relevant object in the 3D scene.</li><li class="listitem">From the <strong>Label</strong> field drop-down list, select the <code class="literal">OBJECTID</code> field that will be used for labeling.</li><li class="listitem">The <strong>Label height</strong> option defines how high from the sphere its label will be shown. Here, we select the <strong>Height from point</strong> option from the drop-down list and set <strong>Value</strong> to <code class="literal">100</code>.</li></ul></div></li></ol><div></div><p>The following screenshot shows how the window will look after all the parameters are defined:</p><div><img src="img/image00467.jpeg" alt="Adjusting 3D visualization of the observation points"/></div><p style="clear:both; height: 1em;"> </p></div><div><div><div><div><h2 class="title"><a id="ch06lvl2sec50"/>Adjusting 3D visualization of building footprints</h2></div></div></div><p>Expand the <strong>Polygon</strong> item on the left side of<a id="id428" class="indexterm"/> the window to <a id="id429" class="indexterm"/>see all the available polygon layers, and activate <code class="literal">building_footprints</code>. On the right side of the window, change the settings to what is shown in the following screenshot:</p><div><ul class="itemizedlist"><li class="listitem"><strong>Object type</strong>: Set this to <strong>Extruded</strong>. This means that 2D polygon footprints will be represented as 3D parallelepipeds.</li><li class="listitem"><strong>Mode</strong>: Set this to <strong>Relative to DEM</strong>. This means that the height of the building will be<a id="id430" class="indexterm"/> obtained from the following formula <em>z = elevation at vertex + addend</em> <em>= DEM</em>. In other words, as we don't use any additional values and the height is set to 0, the relative height of the building will be DEM dependent only.</li><li class="listitem"><strong>Height</strong>: Set this to<a id="id431" class="indexterm"/> <code class="literal">HEIGHT_ROO</code>. Jointly with the previous setting, this setting makes it possible to show buildings with their real height, relative to the absolute height a.s.l. obtained from the DEM.<div><img src="img/image00468.jpeg" alt="Adjusting 3D visualization of building footprints"/></div><p style="clear:both; height: 1em;"> </p></li></ul></div><p>After all of these<a id="id432" class="indexterm"/> settings are done, click on the <strong>Browse</strong> button to specify the path and name for the output scene. Then click on<a id="id433" class="indexterm"/> <strong>Run</strong>. When the scene is generated, it will be automatically loaded and opened in your default web browser, where you can visually explore the results of the analysis using the previously defined controls, as shown here:</p><div><img src="img/image00469.jpeg" alt="Adjusting 3D visualization of building footprints"/></div><p style="clear:both; height: 1em;"> </p></div></div>
<div><div><div><div><h1 class="title"><a id="ch06lvl1sec48"/>Summary</h1></div></div></div><p>In this chapter, you were exposed to the basics of visibility analysis, including input data preparation, visibility point creation, and production and interpretation of visibility coverages in order to find the best observation point. Moreover, you learned how to represent your results through realistic 3D models, which are of great use in the visual exploration of urban data and the results of its analysis.</p><p>In the next chapter, you will learn how to define a perfect location by means of spatial analysis.</p></div></body></html>