<html><head></head><body>
<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01" class="calibre1"/>Chapter 1. Automating QGIS</h1></div></div></div><p class="calibre9">In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem">Installing QGIS for development</li><li class="listitem">Using the QGIS Python console</li><li class="listitem">Using Python's ScriptRunner plugin</li><li class="listitem">Setting up your QGIS IDE</li><li class="listitem">Debugging QGIS Python scripts</li><li class="listitem">Navigating the PyQGIS API</li><li class="listitem">Creating a QGIS plugin</li><li class="listitem">Distributing a plugin</li><li class="listitem">Building a standalone application</li><li class="listitem">Storing and reading global preferences</li><li class="listitem">Storing and reading project preferences</li><li class="listitem">Accessing the script path from within your script</li></ul></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_1"><a id="ch01lvl1sec09" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre9">This chapter explains how to configure QGIS for automation using Python. In addition to setting up QGIS, we will also configure the free Eclipse <strong class="calibre2">Integrated Development Environment</strong> (<strong class="calibre2">IDE</strong>) with<a id="id0" class="calibre1"/> the PyDev plugin to make writing, editing, and debugging scripts easier. We will also learn the basics of different types of QGIS automated Python scripts through the PyQGIS API. Finally, we'll examine some core QGIS plugins that significantly extend the capability of QGIS.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec10" class="calibre1"/>Installing QGIS for development</h1></div></div></div><p class="calibre9">QGIS has a set of Python modules and libraries that can be accessed from the Python console within QGIS. However, they can also be accessed from outside QGIS to write standalone applications. First, you must make sure that PyQGIS is installed for your platform, and then set up some required system environment variables.</p><p class="calibre9">In this recipe, we will <a id="id1" class="calibre1"/>walk you through the additional steps required beyond the normal QGIS installation to prepare your system for development. The steps for each platform are provided, which also include the different styles of Linux package managers.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec13" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">QGIS uses slightly different installation methods for Windows, GNU/Linux, and Mac OS X. The Windows installers install everything you need for Python development, including Python itself.</p><p class="calibre9">However, on Linux distributions and Mac OS X, you may need to manually install the Python modules for the system installation of Python. On Mac OS X, you can download installers for some of the commonly used Python modules with QGIS from <a class="calibre1" href="http://www.kyngchaos.com/software/python">http://www.kyngchaos.com/software/python</a>.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec14" class="calibre1"/>How to do it</h2></div></div></div><p class="calibre9">On Linux, you have the option to compile from the source or you can just specify the Python QGIS interface to be installed through your package manager.</p><div><div><div><div><h3 class="title2"><a id="ch01lvl3sec01" class="calibre1"/>Installing PyQGIS using the Debian package manager</h3></div></div></div><div><ol class="orderedlist"><li class="listitem" value="1">For Linux<a id="id2" class="calibre1"/> distributions based on the Debian Linux package manager, which includes Ubuntu and<a id="id3" class="calibre1"/> Debian, use the following command in a shell:<div><pre class="programlisting"><strong class="calibre2">sudo apt-get update</strong>
</pre></div></li><li class="listitem" value="2">Next, install the QGIS, PyQGIS, and QGIS GRASS plugins:<div><pre class="programlisting"><strong class="calibre2">sudo apt-get install qgis python-qgis qgis-plugin-grass</strong>
</pre></div></li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch01lvl3sec02" class="calibre1"/>Installing PyQGIS using the RPM package manager</h3></div></div></div><div><ol class="orderedlist"><li class="listitem" value="1">For Linux<a id="id4" class="calibre1"/> distributions<a id="id5" class="calibre1"/> based on the <a id="id6" class="calibre1"/><strong class="calibre2">Red Hat Package Manager</strong> (<strong class="calibre2">RPM</strong>), first update the package manager, as follows:<div><pre class="programlisting"><strong class="calibre2">sudo yum update</strong>
</pre></div></li><li class="listitem" value="2">Then, install the <a id="id7" class="calibre1"/>packages for the QGIS, PyQGIS, and QGIS GRASS plugins:<div><pre class="programlisting"><strong class="calibre2">sudo yum install qgis qgis-python qgis-grass</strong>
</pre></div></li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch01lvl3sec03" class="calibre1"/>Setting the environment variables</h3></div></div></div><p class="calibre9">Now, we must<a id="id8" class="calibre1"/> set the <code class="literal">PYTHONPATH</code> to the PyQGIS directory. At the same time, append the path to this directory to the <code class="literal">PATH</code> variable so that you can use the PyQGIS modules with an external IDE.</p><div><div><div><div><h4 class="title3"><a id="ch01lvl4sec01" class="calibre1"/>Setting the environment variables on Windows</h4></div></div></div><div><ol class="orderedlist"><li class="listitem" value="1">Set the <code class="literal">PYTHONPATH</code> variable<a id="id9" class="calibre1"/> in a command <a id="id10" class="calibre1"/>prompt to the <code class="literal">bin</code> directory of the QGIS installation:<div><pre class="programlisting"><strong class="calibre2">set PYTHONPATH="C:\Program Files\QGIS Brighton\bin"</strong>
</pre></div></li><li class="listitem" value="2">Next, append QGIS's <code class="literal">bin</code> directories to the system's <code class="literal">PATH</code> variable:<div><pre class="programlisting"><strong class="calibre2">set PATH="C:\Program Files\QGIS Brighton\bin";"C:\Program Files\QGIS Brighton\bin\apps\qgis\bin";%PATH%</strong>
</pre></div></li></ol><div></div></div><div><div><div><div><h4 class="title3"><a id="ch01lvl4sec02" class="calibre1"/>Setting the environment variables on Linux</h4></div></div></div><div><ol class="orderedlist"><li class="listitem" value="1">Set the <code class="literal">PYTHONPATH</code> variable<a id="id11" class="calibre1"/> in a command prompt to the <code class="literal">bin</code> directory of the QGIS installation:<div><pre class="programlisting"><strong class="calibre2">export PYTHONPATH=/usr/share/qgis/python</strong>
</pre></div></li><li class="listitem" value="2">Now, append the QGIS shared library directory to the runtime search path. Note that this<a id="id12" class="calibre1"/> location can vary depending on your particular system configuration:<div><pre class="programlisting"><strong class="calibre2">export LD_LIBRARY_PATH=/usr/share/qgis/python</strong>
</pre></div></li></ol><div></div></div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch01lvl2sec15" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre9">The QGIS installation<a id="id13" class="calibre1"/> process and package managers set up the Python module's configuration internal to QGIS. When you use the Python console inside QGIS, it knows where all the PyQGIS modules are. However, if you want to use the PyQGIS API outside QGIS, using a system Python installation on Windows or Linux, it is necessary to set some system variables so that Python can find the required PyQGIS modules.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch01lvl2sec16" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre9">This recipe uses the default QGIS paths on each platform. If you aren't sure which PyQGIS path is for your system, you can figure this out from the Python console in QGIS.</p><div><div><div><div><h3 class="title2"><a id="ch01lvl3sec04" class="calibre1"/>Finding the PyQGIS path on Windows</h3></div></div></div><p class="calibre9">The libraries on<a id="id14" class="calibre1"/> Windows are stored in a different location than in the case of other platforms. To locate the path, you can check the current <a id="id15" class="calibre1"/>working directory of the Python console:</p><div><ol class="orderedlist"><li class="listitem" value="1">Start QGIS.</li><li class="listitem" value="2">Select <strong class="calibre2">Python Console</strong> from the <strong class="calibre2">Plugins</strong> menu, which appears in the lower-right corner of the QGIS application window, as shown in the following screenshot:<div><img src="img/00002.jpeg" alt="Finding the PyQGIS path on Windows" class="calibre11"/></div><p class="calibre15"> </p></li><li class="listitem" value="3">Use the <code class="literal">os</code> module to get the current working directory:<div><pre class="programlisting"><strong class="calibre2">import os</strong>
<strong class="calibre2">os.getcwd()</strong>
</pre></div></li><li class="listitem" value="4">Verify that the current working directory of the Python console is returned.</li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch01lvl3sec05" class="calibre1"/>Finding the location of the QGIS Python installation on other platforms</h3></div></div></div><p class="calibre9">Perform the following <a id="id16" class="calibre1"/>steps to find the path needed for this recipe on all the platforms besides Windows:</p><div><ol class="orderedlist"><li class="listitem" value="1">Start QGIS.</li><li class="listitem" value="2">Start the QGIS <strong class="calibre2">Python Console</strong>.</li><li class="listitem" value="3">Use the <code class="literal">sys</code> module to locate the PyQGIS path:<div><pre class="programlisting"><strong class="calibre2">import sys</strong>
<strong class="calibre2">sys.path</strong>
</pre></div></li><li class="listitem" value="4">Python will return a list of paths.</li><li class="listitem" value="5">Find the<a id="id17" class="calibre1"/> path that ends in <code class="literal">/python</code>, which is the location of the Python installation used by QGIS</li></ol><div></div></div></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec11" class="calibre1"/>Using the QGIS Python console for interactive control</h1></div></div></div><p class="calibre9">The QGIS Python console allows you to interactively control QGIS. You can test out ideas or just do some<a id="id18" class="calibre1"/> quick automation. The console is the simplest way to use the QGIS Python API.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec17" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre9">In the following steps, we'll open the QGIS Python console, create a vector layer in memory, and display it on the map:</p><div><ol class="orderedlist"><li class="listitem" value="1">Start QGIS.</li><li class="listitem" value="2">From the <strong class="calibre2">Plugins</strong> menu, select <strong class="calibre2">Python Console</strong>.</li><li class="listitem" value="3">The following code will create a point on the map canvas:<div><pre class="programlisting">layer =  QgsVectorLayer('Point?crs=epsg:4326', 'MyPoint' , 'memory')
pr = layer.dataProvider()
pt = QgsFeature()
point1 = QgsPoint(20,20)
pt.setGeometry(QgsGeometry.fromPoint(point1))
pr.addFeatures([pt])
layer.updateExtents()
QgsMapLayerRegistry.instance().addMapLayers([layer])</pre></div></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec18" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre9">This example uses a <code class="literal">memory</code> layer to avoid interacting with any data on disk or a network to keep things simple. Notice that when we declare the layer type, we add the parameter for the<a id="id19" class="calibre1"/> <strong class="calibre2">Coordinate Reference System</strong> (<strong class="calibre2">CRS</strong>) as EPSG:4326. Without this declaration, QGIS will prompt you to choose one. There are three parts or levels of abstraction to create even a single <a id="id20" class="calibre1"/>point on the map canvas, as shown here:</p><div><ul class="itemizedlist"><li class="listitem">First, create a layer that is of the type geometry. Next, set up a data provider to accept the data source.</li><li class="listitem">Then, create a generic feature object, followed by the point geometry.</li><li class="listitem">Next, stack the objects together and add them to the map.</li></ul></div><p class="calibre9">The layer type is <code class="literal">memory</code>, meaning that you can define the geometry and the attributes inline in the code rather than in an external data source. In this recipe, we just define the geometry and skip the defining of any attributes.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec12" class="calibre1"/>Using the Python ScriptRunner plugin</h1></div></div></div><p class="calibre9">The QGIS Python ScriptRunner plugin provides a middle ground for QGIS automation, between the interactive console and the overhead of plugins. It provides a script management dialog<a id="id21" class="calibre1"/> that allows you to easily load, create, edit, and run scripts for large-scale QGIS automation.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec19" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">Install the <strong class="calibre2">ScriptRunner</strong> plugin using the QGIS plugin manager. Then, run the plugin from the <strong class="calibre2">Plugin</strong> menu to open the <strong class="calibre2">ScriptRunner</strong> dialog. Configure a default editor to edit scripts using the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Find the gear icon that represents the <strong class="calibre2">ScriptRunner Preferences</strong> settings dialog box and click on it.</li><li class="listitem" value="2">In the <strong class="calibre2">General Options</strong> section, check the <strong class="calibre2">Edit Scripts Using:</strong> checkbox.</li><li class="listitem" value="3">Click on the <strong class="calibre2">…</strong> button to browse to the location of a text editor on your system.</li><li class="listitem" value="4">Click on the <strong class="calibre2">Open</strong> button.</li><li class="listitem" value="5">Click on the <strong class="calibre2">OK</strong> button in the <strong class="calibre2">Preferences</strong> dialog.</li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec20" class="calibre1"/>How to do it…</h2></div></div></div><div><ol class="orderedlist"><li class="listitem" value="1">In the <strong class="calibre2">ScriptRunner</strong> dialog, click on the <strong class="calibre2">New Script</strong> icon, as shown in the following screenshot:<div><img src="img/00003.jpeg" alt="How to do it…" class="calibre11"/></div><p class="calibre15"> </p></li><li class="listitem" value="2">Browse to the directory where you can save your script, name the script, and save it.</li><li class="listitem" value="3">Verify <a id="id22" class="calibre1"/>that the new script is loaded in <strong class="calibre2">ScriptRunner</strong>.</li><li class="listitem" value="4">Right-click (or control-click on a Mac) on the script name in ScriptRunner and select <strong class="calibre2">Edit Script in External Editor</strong>.</li><li class="listitem" value="5">In the editor, replace the template code with the following code:<div><pre class="programlisting">from PyQt4.QtCore import *
from PyQt4.QtGui import *
from qgis.core import *
from qgis.gui import *

def run_script(iface):
    layer =  QgsVectorLayer('Polygon?crs=epsg:4326', 'Mississippi' , "memory")
pr = layer.dataProvider()
    poly = QgsFeature()
    geom = QgsGeometry.fromWkt("POLYGON ((-88.82 34.99,-88.09 34.89,-88.39 30.34,-89.57 30.18,-89.73 31,-91.63 30.99,-90.87 32.37,-91.23 33.44,-90.93 34.23,-90.30 34.99,-88.82 34.99))")
    poly.setGeometry(geom)
    pr.addFeatures([poly])
    layer.updateExtents()
QgsMapLayerRegistry.instance().addMapLayers([layer])</pre></div></li><li class="listitem" value="6">Click on the Run Script icon, which is represented by a green-colored arrow.</li><li class="listitem" value="7">Close the <strong class="calibre2">ScriptRunner</strong> plugin.</li><li class="listitem" value="8">Verify that the memory layer polygon was added to the QGIS map, as shown in the following screenshot:<div><img src="img/00004.jpeg" alt="How to do it…" class="calibre11"/></div><p class="calibre15"> </p></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch01lvl2sec21" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre9">ScriptRunner is<a id="id23" class="calibre1"/> a simple but powerful idea. It allows you to build a library of automation scripts and use them from within QGIS, but without the overhead of building a plugin or a standalone application. All the Python and system path variables are set correctly and inherited from QGIS; however, you must still import the QGIS and Qt libraries.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec13" class="calibre1"/>Setting up your QGIS IDE</h1></div></div></div><p class="calibre9">The Eclipse IDE with the<a id="id24" class="calibre1"/> PyDev plugin is cross-platform, has advanced debugging tools, and is free.</p><div><h3 class="title2"><a id="note02" class="calibre1"/>Note</h3><p class="calibre9">You can<a id="id25" class="calibre1"/> refer to <a class="calibre1" href="http://pydev.org/manual_101_install.html">http://pydev.org/manual_101_install.html</a> in order to install PyDev correctly.</p></div><p class="calibre9">This tool makes an excellent PyQGIS IDE. Eclipse allows you to have multiple Python interpreters configured for different Python environments. When you install PyDev, it automatically finds the installed system Python installations. On Windows, you must also add the Python interpreter installed with PyQGIS. On all platforms, you must tell PyDev where the PyQGIS libraries are.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec22" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">This recipe uses Eclipse and PyDev. You can use the latest version of either package that is supported by your operating system. All platforms besides Windows rely on the system Python interpreter. So, there is an extra step in Windows to add the QGIS Python interpreter.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec23" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre9">The following steps will walk you through how to add the QGIS-specific Python interpreter to Eclipse in order to support the running standalone QGIS applications or to debug QGIS plugins.</p><div><div><div><div><h3 class="title2"><a id="ch01lvl3sec06" class="calibre1"/>Adding the QGIS Python interpreter on Windows</h3></div></div></div><p class="calibre9">The process used to <a id="id26" class="calibre1"/>add the QGIS Python interpreter to Eclipse on Windows is different from the process used on Linux. The <a id="id27" class="calibre1"/>following steps describe how to set up<a id="id28" class="calibre1"/> the interpreter on the Windows version of Eclipse:</p><div><ol class="orderedlist"><li class="listitem" value="1">Open Eclipse.</li><li class="listitem" value="2">From the <strong class="calibre2">Window</strong> menu, select <strong class="calibre2">Preferences</strong>. On OS X, you must click on the <strong class="calibre2">Eclipse</strong> menu to find the preferences menu.</li><li class="listitem" value="3">In the pane on the left-hand side of the <strong class="calibre2">Preferences</strong> window, click on the plus sign next to <strong class="calibre2">PyDev</strong>.</li><li class="listitem" value="4">From the list of PyDev preferences, select <strong class="calibre2">Interpreter Python</strong>.</li><li class="listitem" value="5">In the pane labelled Python Interpreters, click on the <strong class="calibre2">New</strong> button.</li><li class="listitem" value="6">In the <strong class="calibre2">Select interpreter</strong> dialog, name the interpreter <code class="literal">PyQGIS</code>.</li><li class="listitem" value="7">Browse to the location of the QGIS Python interpreter called <code class="literal">python.exe</code> within the <code class="literal">bin</code> folder of the QGIS program folder. On OS X and Linux, you use can use the system Python installation. On Windows, Python is included with QGIS. The<a id="id29" class="calibre1"/> default location<a id="id30" class="calibre1"/> on Windows is <code class="literal">C:\Program Files\QGIS Brighton\bin\python.exe</code>, as shown in the following screenshot:<div><img src="img/00005.jpeg" alt="Adding the QGIS Python interpreter on Windows" class="calibre11"/></div><p class="calibre15"> </p></li><li class="listitem" value="8">When you click on the <strong class="calibre2">OK</strong> button, Eclipse will attempt to automatically add every Python library it finds to the Python path for this interpreter configuration. We need to control which libraries are added to prevent conflicts. Click on the <strong class="calibre2">Deselect All button</strong> and then click on <strong class="calibre2">OK</strong>:<div><img src="img/00006.jpeg" alt="Adding the QGIS Python interpreter on Windows" class="calibre11"/></div><p class="calibre15"> </p></li><li class="listitem" value="9">Eclipse will issue <a id="id31" class="calibre1"/>a warning dialog<a id="id32" class="calibre1"/> because you haven't selected any core libraries. Click on the <strong class="calibre2">Proceed anyways</strong> button, as shown here:<div><img src="img/00007.jpeg" alt="Adding the QGIS Python interpreter on Windows" class="calibre11"/></div><p class="calibre15"> </p></li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch01lvl3sec07" class="calibre1"/>Adding the PyQGIS module paths to the interpreter</h3></div></div></div><p class="calibre9">Apart from<a id="id33" class="calibre1"/> adding the Python interpreter, you must also<a id="id34" class="calibre1"/> add the module paths needed by PyQGIS using the following steps. These steps will require you to switch back and forth between QGIS and Eclipse:</p><div><ol class="orderedlist"><li class="listitem" value="1">Start QGIS.</li><li class="listitem" value="2">Start the QGIS <strong class="calibre2">Python Console</strong> from the <strong class="calibre2">Plugins</strong> menu.</li><li class="listitem" value="3">Use the <code class="literal">sys</code> module to locate the PyQGIS Python path, as described in the previous recipe, <em class="calibre10">Setting the environment variables</em>:<div><pre class="programlisting"><strong class="calibre2">import sys</strong>
<strong class="calibre2">sys.path</strong>
</pre></div></li><li class="listitem" value="4">We also want to add the PyQGIS API. Next, find that path using the QGIS <strong class="calibre2">Python Console</strong> by typing the following command:<div><pre class="programlisting">qgis</pre></div></li><li class="listitem" value="5">For each path in the returned lists, click on the <strong class="calibre2">New Folder</strong> button in Eclipse's <strong class="calibre2">Libraries</strong> pane for your QGIS interpreter, and browse to that folder until all the paths have been added. If a given folder does not exist on your system, simply<a id="id35" class="calibre1"/> ignore it, as shown here:<div><img src="img/00008.jpeg" alt="Adding the PyQGIS module paths to the interpreter" class="calibre11"/></div><p class="calibre15"> </p></li><li class="listitem" value="6">Click on<a id="id36" class="calibre1"/> the <strong class="calibre2">OK</strong> button in the <strong class="calibre2">Preferences</strong> dialog.</li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch01lvl3sec08" class="calibre1"/>Adding the PyQGIS API to the IDE</h3></div></div></div><p class="calibre9">To take full <a id="id37" class="calibre1"/>advantage of Eclipse's features, including code completion, we will <a id="id38" class="calibre1"/>add the QGIS and Qt4 modules to the PyQGIS Eclipse interpreter preferences. The following steps will allow Eclipse to suggest the possible methods and properties of QGIS objects as you type; this feature is known as<a id="id39" class="calibre1"/> <strong class="calibre2">autocomplete</strong>:</p><div><ol class="orderedlist"><li class="listitem" value="1">In the PyDev preferences for the PyQGIS Interpreter, select the <strong class="calibre2">Forced Builtins</strong> tab, as shown in the following screenshot:<div><img src="img/00009.jpeg" alt="Adding the PyQGIS API to the IDE" class="calibre11"/></div><p class="calibre15"> </p></li><li class="listitem" value="2">Click<a id="id40" class="calibre1"/> on the <strong class="calibre2">New</strong> button.</li><li class="listitem" value="3">In the <strong class="calibre2">Builtin to add</strong> <a id="id41" class="calibre1"/>dialog, type <code class="literal">qgis</code>:<div><img src="img/00010.jpeg" alt="Adding the PyQGIS API to the IDE" class="calibre11"/></div><p class="calibre15"> </p></li><li class="listitem" value="4">Click on the <strong class="calibre2">OK</strong> button.</li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch01lvl3sec09" class="calibre1"/>Adding environment variables</h3></div></div></div><p class="calibre9">You will also need to<a id="id42" class="calibre1"/> create a <code class="literal">PATH</code> variable, which points to the QGIS binary libraries, DLLs on Windows, and other libraries needed by QGIS at runtime on all platforms.</p><div><ol class="orderedlist"><li class="listitem" value="1">In the <strong class="calibre2">PyDev preferences</strong> dialog, ensure that the <strong class="calibre2">PyQGIS</strong> interpreter is selected in the list of interpreters.</li><li class="listitem" value="2">Select the <strong class="calibre2">Environment</strong> tab.</li><li class="listitem" value="3">Click on the <strong class="calibre2">New</strong> button.</li></ol><div></div><p class="calibre9">In the <strong class="calibre2">Name</strong> field, enter <strong class="calibre2">PATH</strong>.</p><div><ol class="orderedlist"><li class="listitem" value="1">For the <strong class="calibre2">Value</strong> field, add the path to the QGIS program directory and to any QGIS directories containing binaries separated by a semicolon. The following is an example from a Windows machine:<div><pre class="programlisting"><strong class="calibre2">C:\Program Files\QGIS Brighton;C:\Program Files\QGIS Brighton\bin;C:\Program Files\QGIS Brighton\apps\qgis\bin;C:\Program Files\QGIS Brighton\apps\Python27\DLLs</strong>
</pre></div></li></ol><div></div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch01lvl2sec24" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre9">Eclipse and PyDev<a id="id43" class="calibre1"/> use only the information you provide to run a script in the Eclipse workspace. This approach is very similar to the popular Python tool <strong class="calibre2">virtualenv</strong>, which<a id="id44" class="calibre1"/> provides a clean environment when writing and debugging code to ensure that you don't waste time troubleshooting issues caused by the environment.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec14" class="calibre1"/>Debugging QGIS Python scripts</h1></div></div></div><p class="calibre9">In this recipe, we will configure Eclipse<a id="id45" class="calibre1"/> to debug QGIS Python scripts.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec25" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre9">Both QGIS and Eclipse must be configured for debugging so that the two pieces of software can communicate. Eclipse <strong class="calibre2">attaches</strong> itself to QGIS in order to give you insights into the Python scripts running in QGIS. This approach allows you to run scripts in a controlled way that can pause execution while you monitor the program to catch bugs as they occur.</p><div><div><div><div><h3 class="title2"><a id="ch01lvl3sec10" class="calibre1"/>Configuring QGIS</h3></div></div></div><p class="calibre9">The following steps will add two plugins to QGIS, which allows Eclipse to communicate with QGIS. One plugin, <strong class="calibre2">Plugin Reloader</strong>, allows <a id="id46" class="calibre1"/>you to reload a QGIS plugin into memory without restarting QGIS for faster testing. The second plugin, <strong class="calibre2">Remote Debug</strong>, connects<a id="id47" class="calibre1"/> QGIS to Eclipse.</p><p class="calibre9">
<strong class="calibre2">Remote Debug</strong> is an experimental plugin, so you must ensure that experimental <a id="id48" class="calibre1"/>plugins are visible to the QGIS plugin manager in the list of available plugins.</p><div><ol class="orderedlist"><li class="listitem" value="1">Start QGIS.</li><li class="listitem" value="2">Under the <strong class="calibre2">Plugins</strong> menu, select <strong class="calibre2">ManageandInstallPlugins</strong>…</li><li class="listitem" value="3">In the left pane of the <strong class="calibre2">Plugins</strong> dialog, select the <strong class="calibre2">Settings</strong> tab.</li><li class="listitem" value="4">Scroll down in the <strong class="calibre2">Settings</strong> window and ensure that the <strong class="calibre2">Show also experimental plugins</strong> checkbox is checked, as shown in the following screesnhot:<div><img src="img/00011.jpeg" alt="Configuring QGIS" class="calibre11"/></div><p class="calibre15"> </p></li><li class="listitem" value="5">Click on the <strong class="calibre2">OK</strong> button.</li><li class="listitem" value="6">Select the tab labeled <strong class="calibre2">All</strong> in the pane on the left-hand side of the <strong class="calibre2">Plugins</strong> window.</li><li class="listitem" value="7">In the <strong class="calibre2">Search</strong> dialog at the top of the window, search for <strong class="calibre2">Plugin Reloader</strong>.</li><li class="listitem" value="8">Select <strong class="calibre2">Plugin Reloader</strong> from the search results and then click on the <strong class="calibre2">Install Plugin</strong> button.</li><li class="listitem" value="9">Next, search for<a id="id49" class="calibre1"/> the <strong class="calibre2">Remote Debug</strong> plugin and install it as well.</li><li class="listitem" value="10">Finally, install the <strong class="calibre2">HelloWorld</strong> plugin as well.</li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch01lvl3sec11" class="calibre1"/>Configuring Eclipse</h3></div></div></div><p class="calibre9">Now that QGIS is <a id="id50" class="calibre1"/>configured for debugging in Eclipse, we will configure Eclipse to complete the debugging communication loop, as shown in the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Start Eclipse.</li><li class="listitem" value="2">In the <strong class="calibre2">File</strong> menu, select <strong class="calibre2">New</strong> and then click on <strong class="calibre2">Project</strong>.</li><li class="listitem" value="3">Select <strong class="calibre2">General</strong> and then click on <strong class="calibre2">Project</strong> from the <strong class="calibre2">NewProject</strong> dialog.</li><li class="listitem" value="4">Click on the <strong class="calibre2">Next&gt;</strong> button.</li><li class="listitem" value="5">Give the project the name <strong class="calibre2">HelloWorldPlugin</strong>.</li><li class="listitem" value="6">Click on the <strong class="calibre2">Finish</strong> button.</li><li class="listitem" value="7">Select the new <strong class="calibre2">HelloWorldPlugin</strong> project in project explorer and select <strong class="calibre2">New</strong>; then, click on <strong class="calibre2">Folder</strong> from the <strong class="calibre2">File</strong> menu.</li><li class="listitem" value="8">In the <strong class="calibre2">New Folder</strong> dialog, click on the <strong class="calibre2">Advanced&gt;&gt; </strong>button.</li><li class="listitem" value="9">Choose the <strong class="calibre2">Link to alternate location (Linked Folder)</strong> radio button.</li><li class="listitem" value="10">Click on the <strong class="calibre2">Browse</strong> button and browse to the location of the <code class="literal">HelloWorldPlugin</code> folder, as shown in the following screenshot:<div><h3 class="title2"><a id="tip02" class="calibre1"/>Tip</h3><p class="calibre9">You can find the location of the HelloWorld plugin from within the QGIS plugin manager.</p></div><div><img src="img/00012.jpeg" alt="Configuring Eclipse" class="calibre11"/></div><p class="calibre15"> </p></li><li class="listitem" value="11">Click on the <strong class="calibre2">Finish</strong> button.</li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch01lvl3sec12" class="calibre1"/>Testing the debugger</h3></div></div></div><p class="calibre9">The previous parts<a id="id51" class="calibre1"/> of this recipe configured Eclipse and QGIS to work together in order to debug QGIS plugins. In this section, we will test the configuration using the simplest <a id="id52" class="calibre1"/>possible plugin, <strong class="calibre2">HelloWorld</strong>, to run Eclipse using the <a id="id53" class="calibre1"/>
<strong class="calibre2">Debug Perspective</strong>. We will set up a break point in the plugin to pause the execution and then monitor plugin execution from within Eclipse, as follows:</p><div><ol class="orderedlist"><li class="listitem" value="1">Under the <code class="literal">HelloWorld</code> folder, open the file <code class="literal">HelloWorld.py</code>.</li><li class="listitem" value="2">From the Eclipse<strong class="calibre2"> Window</strong> menu, select <strong class="calibre2">OpenPerspective</strong> and then click on <strong class="calibre2">Other…</strong></li><li class="listitem" value="3">From the <strong class="calibre2">OpenPerspective</strong> dialog, select <strong class="calibre2">Debug</strong>.</li><li class="listitem" value="4">Click on the <strong class="calibre2">OK</strong> button.</li><li class="listitem" value="5">Scroll to the first line of the <code class="literal">hello_world()</code> function and double-click on the left-hand side of the line number to set a break point, which is displayed as a green-icon:<div><img src="img/00013.jpeg" alt="Testing the debugger" class="calibre11"/></div><p class="calibre15"> </p></li><li class="listitem" value="6">From the <strong class="calibre2">Pydev</strong> menu, select <strong class="calibre2">Start Debug Server</strong>.</li><li class="listitem" value="7">Verify that the server is running by looking for a message in the Debug console <a id="id54" class="calibre1"/>at the bottom of the window, similar to the following:<div><pre class="programlisting"><strong class="calibre2">Debug Server at port: 5678</strong>
</pre></div></li><li class="listitem" value="8">Switch over to QGIS.</li><li class="listitem" value="9">From the QGIS <strong class="calibre2">Plugins</strong> menu, select <strong class="calibre2">RemoteDebug</strong> and then select the <strong class="calibre2">RemoteDebug</strong> command.</li><li class="listitem" value="10">Verify that the QGIS status bar in the lower-left corner of the window displays the following message:<div><pre class="programlisting"><strong class="calibre2">Python Debugging Active</strong>
</pre></div></li><li class="listitem" value="11">Now, select <strong class="calibre2">HelloWorld</strong> from the QGIS <strong class="calibre2">Plugins</strong> menu and then select <strong class="calibre2">HelloWorld</strong>.</li><li class="listitem" value="12">Switch back to Eclipse.</li><li class="listitem" value="13">Verify that the <code class="literal">hello_world()</code> function is highlighted at the break point.</li><li class="listitem" value="14">From the <strong class="calibre2">Run</strong> menu, select <strong class="calibre2">Resume</strong>.</li><li class="listitem" value="15">Switch back to QGIS.</li><li class="listitem" value="16">Verify that the <strong class="calibre2">HelloWorld</strong> dialog box has appeared.</li></ol><div></div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec26" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre9">The RemoteDebug plugin acts as a client to the PyDev debug server in order to send the Python script's execution status from QGIS to Eclipse. While it has been around for several versions of QGIS<a id="id55" class="calibre1"/> now, it is still considered experimental.</p><p class="calibre9">The PluginReloader plugin can reset plugins that maintain state as they run. The HelloWorld plugin is so<a id="id56" class="calibre1"/> simple that reloading is not needed to test it repeatedly. However, as you debug more complex plugins, you will need to run it in order to reset it before each test. This method is far more efficient and easier to use than closing QGIS, editing the plugin code, and then restarting.</p><div><h3 class="title2"><a id="note03" class="calibre1"/>Note</h3><p class="calibre9">You can find out more <a id="id57" class="calibre1"/>about debugging QGIS, including using other IDEs, at <a class="calibre1" href="http://docs.qgis.org/2.6/en/docs/pyqgis_developer_cookbook/ide_debugging.html">http://docs.qgis.org/2.6/en/docs/pyqgis_developer_cookbook/ide_debugging.html</a>.</p></div></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec15" class="calibre1"/>Navigating the PyQGIS API</h1></div></div></div><p class="calibre9">The QGIS Python <a id="id58" class="calibre1"/>API, also known as PyQGIS, allows you to control virtually every aspect of QGIS. The ability to find the PyQGIS object you need in order to access a particular feature of QGIS is critical to automation.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec27" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">The PyQGIS API is based on the QGIS C++ API. The C++ API is kept up to date online and is well-documented.</p><div><h3 class="title2"><a id="note04" class="calibre1"/>Note</h3><p class="calibre9">The QGIS API's web<a id="id59" class="calibre1"/> page is located at <a class="calibre1" href="http://qgis.org/api/2.6/modules.html">http://qgis.org/api/2.6/modules.html</a>.</p><p class="calibre9">Notice the version number, 2.2, in the URL. You can change this version number to the version of QGIS you are using in order to find the appropriate documentation.</p></div><p class="calibre9">The PyQGIS API documentation is not updated frequently because it is nearly identical to the structure of the C++ API. However, the QGIS project on <a class="calibre1" href="http://github.com">github.com</a> maintains a list of all the PyQGIS classes for the latest version. The PyQGIS 2.6 API is located at <a class="calibre1" href="https://github.com/qgis/QGIS/blob/master/python/qsci_apis/Python-2.6.api">https://github.com/qgis/QGIS/blob/master/python/qsci_apis/Python-2.6.api</a>.</p><p class="calibre9">You can locate the <a id="id60" class="calibre1"/>documented class in the main C++ API and read about it. Then, look up the corresponding Python module and class using the PyQGIS API listing. In most cases, the C++ API name for a class is identical in Python.</p><p class="calibre9">In this recipe, we'll locate the PyQGIS class that controls labels in QGIS.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec28" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre9">We will <a id="id61" class="calibre1"/>perform the following steps to see in which PyQGIS module the QGIS Label object and QgsLabel are located in:</p><div><ol class="orderedlist"><li class="listitem" value="1">Go to the QGIS API page at <a class="calibre1" href="http://qgis.org/api/2.6/index.html">http://qgis.org/api/2.6/index.html</a>.</li><li class="listitem" value="2">Click on the <strong class="calibre2">Modules</strong> tab.</li><li class="listitem" value="3">Click on the link <strong class="calibre2">QGIS</strong> <strong class="calibre2">Core</strong> <strong class="calibre2">Library</strong>.</li><li class="listitem" value="4">Scroll down the list of modules in alphabetical order until you see <strong class="calibre2">QgsLabel</strong>.</li><li class="listitem" value="5">Click on the <strong class="calibre2">QgsLabel</strong> link to access the label object documentation.</li><li class="listitem" value="6">Now, go to the <a id="id62" class="calibre1"/>PyQGIS API listing at <a class="calibre1" href="https://github.com/qgis/QGIS/blob/master/python/qsci_apis/Python-2.6.api">https://github.com/qgis/QGIS/blob/master/python/qsci_apis/Python-2.6.api</a>.</li><li class="listitem" value="7">Scroll down the alphabetical class listing until you see <code class="literal">qgis.core.QgsLabel.LabelField</code>.</li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch01lvl2sec29" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre9">The QGIS <a id="id63" class="calibre1"/>API is divided into five distinct categories, as follows:</p><div><ul class="itemizedlist"><li class="listitem">Core</li><li class="listitem">GUI</li><li class="listitem">Analysis</li><li class="listitem">Map composer</li><li class="listitem">Network analysis</li></ul></div><p class="calibre9">Most of the time, it's easy to find the class that targets the functionality you need with most of QGIS being contained in the catch-all <a id="id64" class="calibre1"/>
<strong class="calibre2">Core </strong>module. The more you use the API, the quicker you'll be able to locate the objects you need for your scripts.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch01lvl2sec30" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre9">If you're having trouble locating a class containing the keyword you need, you can use the search engine on the QGIS API website.</p><div><h3 class="title2"><a id="tip04" class="calibre1"/>Tip</h3><p class="calibre9">Beware, however, that the results returned by this search engine may contain items you don't need <a id="id65" class="calibre1"/>and can even send you looking in the wrong direction because of the similar keywords in different modules.</p></div></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec16" class="calibre1"/>Creating a QGIS plugin</h1></div></div></div><p class="calibre9">Plugins<a id="id66" class="calibre1"/> are the best way to extend QGIS, as they can be easily updated and reused by other people.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec31" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">The easiest approach to creating a plugin is to use the <strong class="calibre2">Plugin</strong> <strong class="calibre2">Builder</strong> plugin to jumpstart development. You can find it in the main QGIS plugin repository and install it.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec32" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre9">Perform the following steps to create a simple plugin that displays a dialog box with a custom message:</p><div><ol class="orderedlist"><li class="listitem" value="1">Start QGIS.</li><li class="listitem" value="2">From the <strong class="calibre2">Plugins</strong> menu, select <strong class="calibre2">Plugin Builder</strong> and then click on <strong class="calibre2">Plugin Builder</strong> under the submenu.</li><li class="listitem" value="3">In the <strong class="calibre2">QGIS Plugin Builder</strong> dialog, name the class <code class="literal">MyPlugin</code>.</li><li class="listitem" value="4">Name the plugin <code class="literal">My Plugin</code>.</li><li class="listitem" value="5">Type a short description, such as <code class="literal">A demonstration on building a QGIS Plugin.</code></li><li class="listitem" value="6">Enter <code class="literal">myplugin</code> for the <strong class="calibre2">Module</strong> name.</li><li class="listitem" value="7">Leave the default version numbers as they are.</li><li class="listitem" value="8">Enter <code class="literal">My Plugin</code> in the <strong class="calibre2">Text for the menu item</strong> field.</li><li class="listitem" value="9">Enter your name and email address for author information.</li><li class="listitem" value="10">Ensure that the checkbox labelled <strong class="calibre2">Flag the plugin as experimental </strong>is checked, as shown in the following screenshot:<div><img src="img/00014.jpeg" alt="How to do it…" class="calibre11"/></div><p class="calibre15"> </p></li><li class="listitem" value="11">Click on the <strong class="calibre2">OK</strong> button.</li><li class="listitem" value="12">A file browser dialog will appear; you can choose a folder in which you want to create your plugin. Select one of the folders called <code class="literal">plugins</code> within the <code class="literal">python</code> folder in either the main user directory or the QGIS program directory. The following examples are from a Windows machine. You should use the folder <a id="id67" class="calibre1"/>in your user directory, which is the preferred place for third-party plugins. QGIS standard plugins go in the main program directory:<div><pre class="programlisting"><strong class="calibre2">C:\Documents and Settings\Joel\.qgis2\python\plugins</strong>
<strong class="calibre2">C:\Program Files\QGIS Brighton\apps\qgis\python\plugins</strong>
</pre></div></li><li class="listitem" value="13">Close the follow-on <strong class="calibre2">Plugin Builder</strong> information dialog by clicking on the <strong class="calibre2">OK</strong> button.</li><li class="listitem" value="14">Using the command prompt, navigate to your new plugin template folder.</li><li class="listitem" value="15">Use the <code class="literal">pyrcc4</code> command to compile the resource file:<div><pre class="programlisting"><strong class="calibre2">pyrcc4 –o resources_rc.py resources.qrc</strong>
</pre></div><div><h3 class="title2"><a id="tip05" class="calibre1"/>Tip</h3><p class="calibre9">If you are on Windows, it is important to use the OSGEO4W shell, which is installed along with QGIS, for the Qt compilation tools to work properly.</p></div></li><li class="listitem" value="16">In a text editor, such as Windows Notepad or vi on Linux, open the user interface XML file named <code class="literal">myplugin_dialog_base.ui</code>.</li><li class="listitem" value="17">Insert the following XMLfor a custom label near line 31 and just before the last <code class="literal">&lt;/widget&gt;</code> tag. Save the file after this edit:<div><pre class="programlisting">&lt;widget class="QLabel" name="label"&gt;
&lt;property name="geometry"&gt;
&lt;rect&gt;
&lt;x&gt;120&lt;/x&gt;
&lt;y&gt;80&lt;/y&gt;
&lt;width&gt;201&lt;/width&gt;
&lt;height&gt;20&lt;/height&gt;
&lt;/rect&gt;
&lt;/property&gt;
&lt;property name="font"&gt;
&lt;font&gt;
&lt;pointsize&gt;14&lt;/pointsize&gt;
&lt;/font&gt;
&lt;/property&gt;
&lt;property name="text"&gt;
&lt;string&gt;Geospatial Python Rocks!&lt;/string&gt;
&lt;/property&gt;
&lt;/widget&gt;</pre></div></li><li class="listitem" value="18">Now, compile<a id="id68" class="calibre1"/> the <code class="literal">ui</code> file using the <code class="literal">pyuic4</code> tool:<div><pre class="programlisting"><strong class="calibre2">pyuic4 –o ui_myplugin.py ui_myplugin.ui</strong>
</pre></div></li><li class="listitem" value="19">Your plugin is now ready. Restart QGIS.</li><li class="listitem" value="20">Select <strong class="calibre2">My Plugin</strong> from the <strong class="calibre2">Plugins</strong> menu and then select <strong class="calibre2">My Plugin</strong> from the submenu to see the dialog you created within QGIS, as shown here:<div><img src="img/00015.jpeg" alt="How to do it…" class="calibre11"/></div><p class="calibre15"> </p></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch01lvl2sec33" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre9">This recipe <a id="id69" class="calibre1"/>shows you the bare bones needed to make a working plugin. Although we haven't altered it, the code for the plugin's behavior is contained in <code class="literal">myplugin.py</code>. You can change the icon and the GUI, and just recompile any time you want. Note that we must compile the <code class="literal">Qt4</code> portion of the plugin, which creates the dialog box. The entire QGIS GUI is built on the <code class="literal">Qt4</code> library, so the <code class="literal">pyrrc4</code> compiler and <code class="literal">pyuic4</code> is included to compile the GUI widgets.</p><p class="calibre9">You can download the completed <a id="id70" class="calibre1"/>plugin with both the source and compiled <code class="literal">ui</code> and resource files at <a class="calibre1" href="https://geospatialpython.googlecode.com/svn/MyPlugin.zip">https://geospatialpython.googlecode.com/svn/MyPlugin.zip</a>.</p><div><h3 class="title2"><a id="note05" class="calibre1"/>Note</h3><p class="calibre9">You can find out more about QGIS plugins, including the purpose of the other files in the directory, in the QGIS documentation at <a class="calibre1" href="http://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/plugins.html">http://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/plugins.html</a>.</p></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch01lvl2sec34" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre9">We have edited the <code class="literal">myplugin_dialog_base.ui</code> XML file by hand to make a small change. However, there is a better way to use Qt Creator. Qt Creator is a fully-fledged, open source GUI designer for the Qt framework. It is an easy what-you-see-is-what-you-get editor for Qt Widgets, including PyQGIS plugins, which uses the included Qt Designer interface. On Windows, Qt Designer can be found in the QGIS program directory within the <code class="literal">bin</code> directory. It is named <code class="literal">designer.exe</code>. On other platforms, Qt Designer is included as part <a id="id71" class="calibre1"/>of the qt4-devel package.</p><div><h3 class="title2"><a id="note06" class="calibre1"/>Note</h3><p class="calibre9">You can also download<a id="id72" class="calibre1"/> Qt Creator, which includes Qt Designer, from <a class="calibre1" href="http://qt-project.org/downloads">http://qt-project.org/downloads</a>.</p></div><p class="calibre9">When you run the installer, you can uncheck all the installation options, except the <strong class="calibre2">Tools</strong> category to install just the IDE.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec17" class="calibre1"/>Distributing a plugin</h1></div></div></div><p class="calibre9">Distributing a QGIS plugin means placing the collection of files on a server as a <code class="literal">ZIP</code> file, with a special configuration file, in order to allow the QGIS plugin manager to locate and install the plugin. The<a id="id73" class="calibre1"/> QGIS project has an official repository, but third-party repositories are also permitted. The official repository is very strict regarding how the plugin is uploaded. So, for this recipe, we'll set up a simple third-party repository for a sample plugin and test it with the QGIS plugin manager to avoid polluting the main QGIS repository with a test project.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec35" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">In order to complete this recipe, you'll need a sample plugin and a web-accessible directory. You'll also need<a id="id74" class="calibre1"/> a <code class="literal">zip</code> tool such as the free 7-zip program (<a class="calibre1" href="http://www.7-zip.org/download.html">http://www.7-zip.org/download.html</a>). You can use the <em class="calibre10">MyPlugin</em> example from the <em class="calibre10">Creating a QGIS plugin</em> recipe as the plugin to distribute. For a web directory, you can use a Google Code repository, GitHub repository, or an other online directory you can access. Code repositories work well because they are a good place to store a plugin that you are developing.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec36" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre9">In the following steps, we will package our plugin, create a server configuration file for it, and place it on a server to create a QGIS plugin repository:</p><div><ol class="orderedlist"><li class="listitem" value="1">First, zip up the plugin directory to create a <code class="literal">.ZIP</code> file.</li><li class="listitem" value="2">Rename the <code class="literal">.ZIP</code> file to contain the plugin's version number:<div><pre class="programlisting"><strong class="calibre2">Myplugin.0.1.0.zip</strong>
</pre></div></li><li class="listitem" value="3">Upload this file to a publicly accessible web directory.</li><li class="listitem" value="4">Upload the <code class="literal">icon.png</code> file from your plugin directory to the web directory.</li><li class="listitem" value="5">Next, customize a <code class="literal">plugins.xml</code> metadata file for your plugin. Most of the data you need can be<a id="id75" class="calibre1"/> found in the <code class="literal">metatdata.txt</code> file in your plugin directory. The following example provides some guidance:<div><pre class="programlisting">&lt;?xml version = '1.0' encoding = 'UTF-8'?&gt;
&lt;?xml-stylesheet type="text/xsl" href="" ?&gt;
&lt;plugins&gt;
&lt;pyqgis_plugin name="My Plugin" version="0.1.0" plugin_id="227"&gt;
&lt;description&gt;
&lt;![CDATA[Demonstration of a QGIS Plugin]]&gt;
&lt;/description&gt;
&lt;about&gt;&lt;/about&gt;
&lt;version&gt;0.1.0&lt;/version&gt;
&lt;qgis_minimum_version&gt;1.8.0&lt;/qgis_minimum_version&gt;
&lt;qgis_maximum_version&gt;2.9.9&lt;/qgis_maximum_version&gt;
&lt;homepage&gt;
&lt;![CDATA[https://code.google.com/p/geospatialpython]]&gt;
&lt;/homepage&gt;
&lt;file_name&gt;MyPlugin.0.1.0.zip&lt;/file_name&gt;
&lt;icon&gt;
http://geospatialpython.googlecode.com/svn/icon_227.png
&lt;/icon&gt;
&lt;author_name&gt;&lt;![CDATA[Joel Lawhead]]&gt;&lt;/author_name&gt;
&lt;download_url&gt; http://geospatialpython.googlecode.com/svn/MyPlugin.0.1.0.zip
&lt;/download_url&gt;
&lt;uploaded_by&gt;&lt;![CDATA[jll]]&gt;&lt;/uploaded_by&gt;
&lt;create_date&gt;2014-05-16T15:31:19.824333&lt;/create_date&gt;
&lt;update_date&gt;2014-07-15T15:31:19.824333&lt;/update_date&gt;
&lt;experimental&gt;True&lt;/experimental&gt;
&lt;deprecated&gt;False&lt;/deprecated&gt;
&lt;tracker&gt;
&lt;![CDATA[http://code.google.com/p/geospatialpython/issues]]&gt;
&lt;/tracker&gt;
&lt;repository&gt;
&lt;![CDATA[https://geospatialpython.googlecode.com/svn/]]&gt;
&lt;/repository&gt;
&lt;tags&gt;
&lt;![CDATA[development,debugging,tools]]&gt;&lt;/tags&gt;
&lt;downloads&gt;0&lt;/downloads&gt;
&lt;average_vote&gt;0&lt;/average_vote&gt;
&lt;rating_votes&gt;0&lt;/rating_votes&gt;
&lt;/pyqgis_plugin&gt;
&lt;/plugins&gt;</pre></div></li><li class="listitem" value="6">Upload the <code class="literal">plugins.xml</code> file to your web directory.</li><li class="listitem" value="7">Now, start QGIS and launch the plugins manager by going to the <strong class="calibre2">Plugins</strong> menu and selecting <strong class="calibre2">Manage and Install Plugins…</strong>.</li><li class="listitem" value="8">In the <strong class="calibre2">Settings</strong> tab of the <strong class="calibre2">plugins settings</strong> dialog, scroll down and click on the <strong class="calibre2">Add…</strong> button.</li><li class="listitem" value="9">Give the plugin a name and then add the complete URL to your <code class="literal">plugins.xml</code> in the URL field.</li><li class="listitem" value="10">Click on the <strong class="calibre2">OK</strong> button.</li><li class="listitem" value="11">To make<a id="id76" class="calibre1"/> things easier, disable the other repositories by selecting the repository name, clicking on the <strong class="calibre2">Edit</strong> button, and unchecking the <strong class="calibre2">Enable</strong> checkbox.</li><li class="listitem" value="12">Click on the <strong class="calibre2">OK</strong> button.</li><li class="listitem" value="13">Click on the <strong class="calibre2">Not Installed</strong> tab.</li><li class="listitem" value="14">Your test plugin should be the only plugin listed, so select it from the list.</li><li class="listitem" value="15">Click on the <strong class="calibre2">Install Plugin</strong> button in the bottom-right corner of the window.</li><li class="listitem" value="16">Click on the <strong class="calibre2">Close</strong> button.</li><li class="listitem" value="17">Go to the <strong class="calibre2">Plugins</strong> menu and select your plugin to ensure that it works.</li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch01lvl2sec37" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre9">The QGIS repository concept is simple and effective. The <code class="literal">plugins.xml</code> file contains a <code class="literal">download_url</code> tag that points to a <code class="literal">ZIP</code> file plugin on the same server or on a different server. The <code class="literal">name</code> attribute of the <code class="literal">pyqgis_plugin</code> tag is what appears in the QGIS plugin manager.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec18" class="calibre1"/>Creating a standalone application</h1></div></div></div><p class="calibre9">QGIS is a<a id="id77" class="calibre1"/> complete desktop GIS application. However, with PyQGIS, it can also be a comprehensive geospatial Python library to build standalone applications. In this recipe, we will build a simple standalone script that creates a map with a line on it.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec38" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">All you need to do to get ready is ensure that you have configured Eclipse and PyDev for PyQGIS development, as described in the <em class="calibre10">Setting up your QGIS IDE</em> recipe.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec39" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre9">In PyDev, create a <a id="id78" class="calibre1"/>new project called <code class="literal">MyMap</code> with a Python script called <code class="literal">MyMap.py</code>, as follows:</p><div><ol class="orderedlist"><li class="listitem" value="1">In the Eclipse <strong class="calibre2">File</strong> menu, select <strong class="calibre2">New</strong> and then click on <strong class="calibre2">PyDev Project</strong>.</li><li class="listitem" value="2">In the PyDev project's <strong class="calibre2">Name</strong> field, enter <code class="literal">MyMap</code>.</li><li class="listitem" value="3">Next, select the <strong class="calibre2">Python</strong> radio button from the <strong class="calibre2">Project Type</strong> list.</li><li class="listitem" value="4">From the <strong class="calibre2">Interpreter</strong> pull-down menu, select <strong class="calibre2">PyQGIS</strong>.</li><li class="listitem" value="5">Leave the radio button checked for <strong class="calibre2">Add project directory to the PYTHONPATH</strong>.</li><li class="listitem" value="6">Click on the <strong class="calibre2">Finish</strong> button.</li><li class="listitem" value="7">Now, select the project in the PyDev package explorer.</li><li class="listitem" value="8">From the <strong class="calibre2">File</strong> menu, select <strong class="calibre2">New</strong> and then click on <strong class="calibre2">File</strong>.</li><li class="listitem" value="9">Name the file <code class="literal">myMap.py</code>.</li><li class="listitem" value="10">Click on the <strong class="calibre2">Finish</strong> button.</li><li class="listitem" value="11">Add the following code to the file that is open in the editor:<div><pre class="programlisting">from qgis.core import *
from qgis.gui import *
from qgis.utils import *
from PyQt4.QtCore import *
from PyQt4.QtGui import *

app = QgsApplication([], True)
app.setPrefixPath("C:/Program Files/QGIS Brighton/apps/qgis", True)
app.initQgis()
canvas = QgsMapCanvas()
canvas.setWindowTitle("PyQGIS Standalone Application Example")
canvas.setCanvasColor(Qt.white)
layer =  QgsVectorLayer('LineString?crs=epsg:4326', 'MyLine' , "memory")
pr = layer.dataProvider()
linstr = QgsFeature()
geom = QgsGeometry.fromWkt("LINESTRING (1 1, 10 15, 40 35)")
linstr.setGeometry(geom)
pr.addFeatures([linstr])
layer.updateExtents()
QgsMapLayerRegistry.instance().addMapLayer(layer)
canvas.setExtent(layer.extent())
canvas.setLayerSet([QgsMapCanvasLayer(layer)])
canvas.zoomToFullExtent()
canvas.freeze(True)
canvas.show()
canvas.refresh()
canvas.freeze(False)
canvas.repaint()
exitcode = app._exec()
QgsApplication.exitQgis()
sys.exit(exitcode)</pre></div></li><li class="listitem" value="12">From the <strong class="calibre2">Run</strong> menu, select <strong class="calibre2">Run</strong>.</li><li class="listitem" value="13">Verify that the<a id="id79" class="calibre1"/> standalone QGIS map appears in a new window, as shown here:<div><img src="img/00016.jpeg" alt="How to do it…" class="calibre11"/></div><p class="calibre15"> </p></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch01lvl2sec40" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre9">This recipe uses as little code as possible to create a map canvas and to draw a line in order to demonstrate the skeleton of a standalone application, which can be built up further to add more functionality.</p><p class="calibre9">To create the line geometry, we use<a id="id80" class="calibre1"/> <strong class="calibre2">Well-Known Text</strong> (<strong class="calibre2">WKT)</strong>, which provides a simple way to define the line vertices without creating a bunch of objects. Towards the end of this code, we use a <a id="id81" class="calibre1"/>workaround for a bug in QGIS 2.2 by <strong class="calibre2">freezing</strong> the canvas. When the canvas is frozen, it does not respond to any events which, in the case of this bug, prevent the canvas from updating. Once we refresh the canvas, we unfreeze it and then repaint it to draw the line. This workaround will still work in QGIS 2.4 and 2.6 but is not necessary.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch01lvl2sec41" class="calibre1"/>There's more...</h2></div></div></div><p class="calibre9">The standalone application can be compiled into an executable that can be distributed without installing QGIS, using py2exe or PyInstaller:</p><p class="calibre9">You can find our more <a id="id82" class="calibre1"/>about py2exe at <a class="calibre1" href="http://www.py2exe.org">http://www.py2exe.org</a>.</p><p class="calibre9">You can learn<a id="id83" class="calibre1"/> more about PyInstaller at <a class="calibre1" href="https://github.com/pyinstaller/pyinstaller/wiki">https://github.com/pyinstaller/pyinstaller/wiki</a>.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec19" class="calibre1"/>Storing and reading global preferences</h1></div></div></div><p class="calibre9">PyQGIS allows you to store application-level preferences and retrieve them.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec42" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">This code can be run in any<a id="id84" class="calibre1"/> type of PyQGIS application. In this example, we'll run it in the QGIS Python console for an easy demonstration. In this example, we'll change the default CRS for new projects and then read the value back from the global settings.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec43" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre9">In this recipe, we will set the<a id="id85" class="calibre1"/> default projection used by QGIS for new projects using the Python console:</p><div><ol class="orderedlist"><li class="listitem" value="1">Start QGIS.</li><li class="listitem" value="2">From the <strong class="calibre2">Plugins</strong> menu, select <strong class="calibre2">Python Console</strong>.</li><li class="listitem" value="3">We will need to import the Qt core library, as follows:<div><pre class="programlisting">from PyQt4.QtCore import *</pre></div></li><li class="listitem" value="4">In the Python console, run the following code:<div><pre class="programlisting">settings = QSettings(QSettings.NativeFormat, QSettings.UserScope, 'QuantumGIS', 'QGis')
settings.setValue('/Projections/projectDefaultCrs', 'EPSG:2278')
settings.value('/Projections/projectDefaultCrs')</pre></div></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch01lvl2sec44" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre9">This API is actually the Qt API that QGIS relies on for settings. In the QSettings object, we specify the NativeFormat for storage, which is the default format for the platform. On Windows, the format is the registry; on OS X, it's the <code class="literal">plist</code> files; and on Unix, it's the text files. The other QSettings parameters are the <a id="id86" class="calibre1"/>
<strong class="calibre2">organization</strong> and the <strong class="calibre2">application</strong>,<a id="id87" class="calibre1"/> often used as a hierarchy to store information. Note that even after changing these settings, it may be that none of the properties in the <a id="id88" class="calibre1"/>QGIS GUI change immediately. In some cases, such as Windows, the system must be restarted for registry changes to take effect. However, everything will <a id="id89" class="calibre1"/>work programmatically.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch01lvl2sec45" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre9">If you want to see all the options that you can change, call the <code class="literal">allKeys()</code> method of QSettings; this will return a list of all the setting names.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec20" class="calibre1"/>Storing and reading project preferences</h1></div></div></div><p class="calibre9">The QGIS <a id="id90" class="calibre1"/>application settings are stored using the Qt API. However, QGIS project settings have their <a id="id91" class="calibre1"/>own object. In this recipe, we'll set and read the project title and then set and read a custom preference for a plugin.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec46" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">We are going to set a plugin preference using the sample plugin created in the previous recipe, <em class="calibre10">Creating a QGIS plugin</em>. You can substitute the name of any plugin you want, however. We will also run this recipe in the QGIS Python console for quick testing, but this code will normally be used in a plugin.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec47" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre9">In this recipe, we will first write and then read the title of the current project. Then, we will create a custom<a id="id92" class="calibre1"/> value for a <a id="id93" class="calibre1"/>plugin called <code class="literal">splash</code>, which can be used for the plugin startup splash screen if desired.</p><div><ol class="orderedlist"><li class="listitem" value="1">Start QGIS.</li><li class="listitem" value="2">From the <strong class="calibre2">Plugins</strong> menu, select <strong class="calibre2">Python Console</strong>.</li><li class="listitem" value="3">In the console, run the following code:<div><pre class="programlisting">proj = QgsProject.instance()
proj.title("My QGIS Project")
proj.title()
proj.writeEntry("MyPlugin", "splash", "Geospatial Python Rocks!")
proj.readEntry("MyPlugin", "splash", "Welcome!")[0]</pre></div></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch01lvl2sec48" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre9">In the first two lines, we change the title of the current active project and then echo it back. In the next set of two lines, we set up and read custom settings for a plugin. Notice that the <code class="literal">readEntry()</code> method returns a tuple with the desired text and a boolean, acknowledging<a id="id94" class="calibre1"/> that the value is set. So, we extract the first index to get the text. The read method also allows the default text in case that property is not set (rather than throw an exception which must be handled) as well as the boolean value <code class="literal">False</code> to inform you that the default text was used because the property was not set. The values you set using this method are stored in the project's XML file when you save it.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch01lvl2sec49" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre9">The <code class="literal">QgsProject</code> object has a number of methods and properties that may be useful. The QGIS API documentation <a id="id95" class="calibre1"/>details all of them at <a class="calibre1" href="http://qgis.org/api/2.6/classQgsProject.html">http://qgis.org/api/2.6/classQgsProject.html</a>.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch01lvl1sec21" class="calibre1"/>Accessing the script path from within your script</h1></div></div></div><p class="calibre9">Sometimes, you<a id="id96" class="calibre1"/> need to know exactly where the current working directory is so that you can access external resources.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch01lvl2sec50" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre9">This code uses the Python built-in library and can be used in any context. We will run this recipe in the QGIS Python console.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch01lvl2sec51" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre9">In this recipe, we will get the current working directory of the Python console, which can change with configuration:</p><div><ol class="orderedlist"><li class="listitem" value="1">Start QGIS.</li><li class="listitem" value="2">From the <strong class="calibre2">Plugins</strong> menu, select <strong class="calibre2">Python Console</strong>.</li><li class="listitem" value="3">In the Python console, run the following code:<div><pre class="programlisting">import os
os.getcwd()</pre></div></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch01lvl2sec52" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre9">QGIS relies heavily on file system paths to run the application and to manage external data. When writing<a id="id97" class="calibre1"/> cross-platform QGIS code, you cannot assume the working directory of your script.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch01lvl2sec53" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre9">On his blog, one of the QGIS developers has an excellent post about the various aspects of path variables in QGIS beyond just the execution directory; you can check it out at <a class="calibre1" href="http://spatialgalaxy.net/2013/11/06/getting-paths-with-pyqgis/">http://spatialgalaxy.net/2013/11/06/getting-paths-with-pyqgis/</a>.</p></div></div></body></html>