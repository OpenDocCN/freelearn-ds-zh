<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Tipping the Scales"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Tipping the Scales</h1></div></div></div><p>In this chapter we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using quantitative scales</li><li class="listitem" style="list-style-type: disc">Using time scale</li><li class="listitem" style="list-style-type: disc">Using ordinal scale</li><li class="listitem" style="list-style-type: disc">Interpolating string</li><li class="listitem" style="list-style-type: disc">Interpolating colors</li><li class="listitem" style="list-style-type: disc">Interpolating compound object</li><li class="listitem" style="list-style-type: disc">Implementing custom interpolator</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec27"/>Introduction</h1></div></div></div><p>As a data visualization developer, one key task that you need to perform over and over is to map values from your data domain to visual domain, for example, mapping your most recent purchase of a fancy tablet of $453.00 to a 653px-long bar, and your last night's pub bill of $23.59 to a 34px-long bar, respectively. In a sense, this is what data visualization is all about—mapping data elements to their visual metaphor in an efficient and accurate manner. Because this is an absolutely essential task in data visualization and animation (animation will be discussed in <a class="link" href="ch06.html" title="Chapter 6. Transition with Style">Chapter 6</a>, <span class="emphasis"><em>Transition with Style</em></span>, in detail), D3 provides rich and robust support on this topic, which is the focus of this chapter.</p><div class="section" title="What are scales?"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec59"/>What are scales?</h2></div></div></div><p>D3 provides various constructs called <span class="strong"><strong>scales</strong></span>
<a id="id213" class="indexterm"/> to help you perform this kind of mapping. Proper understanding of these constructs conceptually is crucial to become an effective visualization developer. This is because scales are not only used to perform the mapping we have mentioned previously, but also to serve as fundamental building blocks for many other D3 constructs, such as transition and axes.</p><p>What are these scales anyway?</p><p>In short, scales can<a id="id214" class="indexterm"/> be thought of as mathematical <span class="strong"><strong>functions</strong></span>. Mathematical functions<a id="id215" class="indexterm"/> differ from<a id="id216" class="indexterm"/> functions defined in imperative programming languages, such as JavaScript functions. In mathematics, a function is defined as mapping between two sets:</p><div class="blockquote"><blockquote class="blockquote"><p>Let A and B be nonempty sets. A <span class="emphasis"><em>function f</em></span> from A to B is an assignment of exactly one element of B to each element of A. We write <span class="emphasis"><em>f</em></span>(a) = b if b is the unique element of B assigned by the function <span class="emphasis"><em>f</em></span> to the element a of A.</p><p>(Rosen K. H. 2007)</p></blockquote></div><p>Despite the dryness of this definition, we still could not help but notice how nicely it fits the task we need to perform—mapping elements from the data domain to visual domain.</p><p>Another fundamentally important concept we need to illustrate here is the <span class="strong"><strong>domain</strong></span>
<a id="id217" class="indexterm"/> and <span class="strong"><strong>range</strong></span>
<a id="id218" class="indexterm"/> of a given function.</p><div class="blockquote"><blockquote class="blockquote"><p>If <span class="emphasis"><em>f</em></span> is a function from A to B, we say that A is the <span class="strong"><strong>domain</strong></span> of <span class="emphasis"><em>f</em></span> and B is the codomain of <span class="emphasis"><em>f</em></span>. If <span class="emphasis"><em>f</em></span>(a) = b, we say that b is the image of a and a is a preimage of b. The <span class="strong"><strong>range, or image,</strong></span> of <span class="emphasis"><em>f</em></span> is the set of all images of elements of A. Also, if <span class="emphasis"><em>f</em></span> is a function from A to B, we say that <span class="emphasis"><em>f</em></span> maps A to B.</p><p>(Rosen K. H. 2007)</p></blockquote></div><p>To help us understand this concept, let's take a look at the following illustration:</p><div class="mediaobject"><img src="graphics/2162OS_04_01.jpg" alt="What are scales?"/><div class="caption"><p>Function f maps A to B</p></div></div><p>We can clearly see now, in the preceding illustration for function <span class="emphasis"><em>f,</em></span> the domain is set <span class="strong"><strong>A</strong></span> and the range is set <span class="strong"><strong>B</strong></span>. Imagine if set A represents our data domain and B represents the visual domain, then a function <span class="emphasis"><em>f</em></span> defined here is essentially a scale in D3 that maps elements from set A to set B.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note19"/>Note</h3><p>For the mathematically inclined readers, scale function in data visualization are usually <span class="strong"><strong>one-to-one</strong></span> <a id="id219" class="indexterm"/>but not <span class="strong"><strong>onto</strong></span> functions<a id="id220" class="indexterm"/>. This is a useful insight to know but not critical to the purpose of this book. Therefore, we will not discuss it further here.</p></div></div><p>Now, we have discussed the conceptual definition of scale functions in D3, so let's take a look at how it can be used to help us develop our visualization project.</p></div></div></div>
<div class="section" title="Using quantitative scales"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec28"/>Using quantitative scales</h1></div></div></div><p>In this recipe, we will examine the most commonly-used scales provided by D3—the quantitative scales including linear, power, and logarithmic scales.</p><div class="section" title="Getting Ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec60"/>Getting Ready</h2></div></div></div><p>Open your local copy of the <a id="id221" class="indexterm"/>following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/quantitative-scales.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/quantitative-scales.html</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec61"/>How to do it...</h2></div></div></div><p>Let's take a look at the following code example:</p><div class="informalexample"><pre class="programlisting">&lt;div id="linear" class="clear"&gt;&lt;span&gt;n&lt;/span&gt;&lt;/div&gt;
&lt;div id="linear-capped" class="clear"&gt;
    &lt;span&gt;1 &amp;lt;= a*n + b &amp;lt;= 20&lt;/span&gt;
&lt;/div&gt;
&lt;div id="pow" class="clear"&gt;&lt;span&gt;n^2&lt;/span&gt;&lt;/div&gt;
&lt;div id="pow-capped" class="clear"&gt;
    &lt;span&gt;1 &amp;lt;= a*n^2 + b &amp;lt;= 10&lt;/span&gt;
&lt;/div&gt;
&lt;div id="log" class="clear"&gt;&lt;span&gt;log(n)&lt;/span&gt;&lt;/div&gt;
&lt;div id="log-capped" class="clear"&gt;
    &lt;span&gt;1 &amp;lt;= a*log(n) + b &amp;lt;= 10&lt;/span&gt;
&lt;/div&gt;

&lt;script type="text/javascript"&gt;
    var max = 11, data = [];
    for (var i = 1; i &lt; max; ++i) data.push(i);

<span class="strong"><strong>    var linear = d3.scale.linear() // &lt;-A</strong></span>
<span class="strong"><strong>        .domain([1, 10]) // &lt;-B</strong></span>
<span class="strong"><strong>        .range([1, 10]); // &lt;-C        </strong></span>
<span class="strong"><strong>    var linearCapped = d3.scale.linear()</strong></span>
<span class="strong"><strong>        .domain([1, 10])        </strong></span>
<span class="strong"><strong>        .range([1, 20]); // &lt;-D</strong></span>
<span class="strong"><strong>        </strong></span>
<span class="strong"><strong>    var pow = d3.scale.pow().exponent(2); // &lt;-E</strong></span>
<span class="strong"><strong>    var powCapped = d3.scale.pow() // &lt;-F</strong></span>
<span class="strong"><strong>        .exponent(2)</strong></span>
<span class="strong"><strong>        .domain([1, 10])</strong></span>
<span class="strong"><strong>        .rangeRound([1, 10]); // &lt;-G</strong></span>
<span class="strong"><strong>        </strong></span>
<span class="strong"><strong>    var log = d3.scale.log(); // &lt;-H</strong></span>
<span class="strong"><strong>    var logCapped = d3.scale.log() // &lt;-I</strong></span>
<span class="strong"><strong>        .domain([1, 10])</strong></span>
<span class="strong"><strong>        .rangeRound([1, 10]);</strong></span>


    function render(data, scale, selector) {
        d3.select(selector).selectAll("div.cell")
                .data(data)
                .enter().append("div").classed("cell", true);

        d3.select(selector).selectAll("div.cell")
                .data(data)
                .exit().remove();

        d3.select(selector).selectAll("div.cell")
                .data(data)
                .style("display", "inline-block")
<span class="strong"><strong>                .text(function (d) {</strong></span>
<span class="strong"><strong>                    return d3.round(scale(d), 2);</strong></span>
<span class="strong"><strong>                });</strong></span>
    }

    render(data, linear, "#linear");
    render(data, linearCapped, "#linear-capped");
    render(data, pow, "#pow");
    render(data, powCapped, "#pow-capped");
    render(data, log, "#log");
    render(data, logCapped, "#log-capped");
&lt;/script&gt;</pre></div><p>The preceding code generates the following output in your browser:</p><div class="mediaobject"><img src="graphics/2162OS_04_02.jpg" alt="How to do it..."/><div class="caption"><p>Quantitative scale output</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec62"/>How it works...</h2></div></div></div><p>In this recipe, we have<a id="id222" class="indexterm"/> demonstrated some of the most common scales provided by D3.</p><p>
<span class="strong"><strong>Linear Scale</strong></span>
</p><p>In the preceding code <a id="id223" class="indexterm"/>example, we have our data array filled with integers from <code class="literal">0</code> to <code class="literal">10</code>—as shown on the line marked as <code class="literal">A</code>—we created a <span class="strong"><strong>linear scale</strong></span>
<a id="id224" class="indexterm"/> by calling the <code class="literal">d3.scale.linear()</code> function. This returns a linear quantitative scale with the default domain set to <code class="literal">[0, 1]</code> and the default range set to <code class="literal">[0, 1]</code>. Thus the default scale is essentially the <span class="strong"><strong>identity function</strong></span>
<a id="id225" class="indexterm"/> for numbers. Therefore, this default function is not that useful to us, but typically needs to be further customized by using its <code class="literal">domain</code> and <code class="literal">range</code> functions on line <code class="literal">B</code> and <code class="literal">C</code>. In this case, we set them both to <code class="literal">[1, 10]</code>. This scale basically defines the function <span class="emphasis"><em>f(n) = n</em></span>.</p><div class="informalexample"><pre class="programlisting">    var linear = d3.scale.linear() // &lt;-A
        .domain([1, 10]) // &lt;-B
        .range([1, 10]); // &lt;-C        </pre></div><div class="mediaobject"><img src="graphics/2162OS_04_03.jpg" alt="How it works..."/><div class="caption"><p>Identity scale</p></div></div><p>The second linear scale is a little bit more interesting and it illustrates the mapping between two sets better. On line <code class="literal">D</code>, we set the range as <code class="literal">[1, 20]</code>, which is different from its domain. Hence, now this function is essentially representing the following equations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>f(n) = a * n + b</em></span></li><li class="listitem" style="list-style-type: disc"><span class="emphasis"><em>1 &lt;= f(n) &lt;= 20</em></span></li></ul></div><p>This is by far the <a id="id226" class="indexterm"/>most common case when using D3 scales because your data <a id="id227" class="indexterm"/>set will be an identical match of your visual set.</p><div class="informalexample"><pre class="programlisting">    var linearCapped = d3.scale.linear()
        .domain([1, 10])        
        .range([1, 20]); // &lt;-D</pre></div><div class="mediaobject"><img src="graphics/2162OS_04_04.jpg" alt="How it works..."/><div class="caption"><p>Linear scale</p></div></div><p>In this second scale, D3 <a id="id228" class="indexterm"/>will automatically calculate and assign the value of constants <code class="literal">a</code> and <code class="literal">b</code> to satisfy the equation.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note20"/>Note</h3><p>Some basic algebraic calculation will tell you that <code class="literal">a</code> is approximately 2.11 and <code class="literal">b</code> is -1.11, as in the previous example.</p></div></div><p>
<span class="strong"><strong>Pow Scale</strong></span>
</p><p>The second scale we have created is a <a id="id229" class="indexterm"/>
<span class="strong"><strong>power scale</strong></span>
<a id="id230" class="indexterm"/>. On line <code class="literal">E</code>, we defined a power scale with <code class="literal">exponent</code> of 2. The <code class="literal">d3.scale.pow()</code> function returns a default power scale function with its <code class="literal">exponent</code> set as <code class="literal">1</code>. This scale effectively defines the function <span class="emphasis"><em>f(n) = n^2</em></span>.</p><div class="informalexample"><pre class="programlisting">    var pow = d3.scale.pow().exponent(2); // &lt;-E</pre></div><div class="mediaobject"><img src="graphics/2162OS_04_05.jpg" alt="How it works..."/><div class="caption"><p>Simple power scale</p></div></div><p>On line <code class="literal">F</code>, a second power scale was defined, this time with a different range set on line <code class="literal">G</code> with rounding; the <code class="literal">rangeRound()</code> function<a id="id231" class="indexterm"/> works pretty much the same as the <code class="literal">range()</code> function, which sets the range for a scale. However, the <code class="literal">rangeRound</code> function rounds the output number so that there are no decimal fractions. This is very handy since scales are commonly used to map elements from the data domain to <a id="id232" class="indexterm"/>visual domain. So, the output of a scale is very likely to be a<a id="id233" class="indexterm"/> number describing some visual characteristics, for example, the number of pixels. Avoiding sub-pixel numbers is a useful technique that prevents anti-alias in rendering. </p><p>The second power scale defines the following function <span class="emphasis"><em>f(n) = a*n^2 + b, 1 &lt;= f(n) &lt;= 10</em></span>.</p><div class="informalexample"><pre class="programlisting">    var powCapped = d3.scale.pow() // &lt;-F
        .exponent(2)
        .domain([1, 10])
        .rangeRound([1, 10]); // &lt;-G</pre></div><div class="mediaobject"><img src="graphics/2162OS_04_06.jpg" alt="How it works..."/><div class="caption"><p>Power scale</p></div></div><p>Similar to the linear<a id="id234" class="indexterm"/> scale, D3 will automatically find the suitable constants <code class="literal">a</code> and <code class="literal">b</code> to satisfy the constraints defined by <code class="literal">domain</code> and <code class="literal">range</code> on a power scale.</p><p>
<span class="strong"><strong>Log Scale</strong></span>
</p><p>On line <code class="literal">H</code>, a third kind of <a id="id235" class="indexterm"/>quantitative <a id="id236" class="indexterm"/>scale was created using the <code class="literal">d3.scale.log()</code> function. The default log scale has a <code class="literal">base</code> of <code class="literal">10</code>. Line H essentially defines the following mathematical function <span class="emphasis"><em>f(n) = log(n)</em></span>.</p><div class="informalexample"><pre class="programlisting">    var log = d3.scale.log(); // &lt;-H</pre></div><div class="mediaobject"><img src="graphics/2162OS_04_07.jpg" alt="How it works..."/><div class="caption"><p>Simple log scale</p></div></div><p>On line <code class="literal">I</code>, we customized the log scale to have a domain of <code class="literal">[1, 10]</code> and a rounded range of <code class="literal">[1, 10]</code>, which defines the following constrained mathematical function <span class="emphasis"><em>f(n) = a*log(n) + b, 1 &lt;= f(n) &lt;= 10</em></span>.</p><div class="informalexample"><pre class="programlisting">    var logCapped = d3.scale.log() // &lt;-I
        .domain([1, 10])
        .rangeRound([1, 10]);</pre></div><div class="mediaobject"><img src="graphics/2162OS_04_08.jpg" alt="How it works..."/><div class="caption"><p>Log scale</p></div></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec63"/>There's more...</h2></div></div></div><p>D3 also provides<a id="id237" class="indexterm"/> other additional quantitative scales including quantize, threshold, quantile, and identity scales. Due to limited scope in this book and their relatively less common usage, they are not discussed here, however, the basic understanding of scales discussed and explained here will definitely help your understanding of other additional quantitative scales provided by the D3 library. For more information on other types of quantitative scales please visit <a class="ulink" href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-quantitative">https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-quantitative</a>
</p></div></div>
<div class="section" title="Using the time scale"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec29"/>Using the time scale</h1></div></div></div><p>Often, we perform analysis on a data set that is time- and date-sensitive, therefore, D3 provides a built-in time scale to help perform this type of mapping. In this recipe, we will learn how to use D3 time scale.</p><div class="section" title="Getting Ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec64"/>Getting Ready</h2></div></div></div><p>Open your local copy of the <a id="id238" class="indexterm"/>following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/time-scale.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/time-scale.html</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec65"/>How to do it...</h2></div></div></div><p>First, let's take a look at the following code example:</p><div class="informalexample"><pre class="programlisting">&lt;div id="time" class="clear"&gt;
    &lt;span&gt;Linear Time Progression&lt;br&gt;&lt;/span&gt;
    &lt;span&gt;Mapping [01/01/2013, 12/31/2013] to [0, 900]&lt;br&gt;&lt;/span&gt;
&lt;/div&gt;

&lt;script type="text/javascript"&gt;
<span class="strong"><strong>    var start = new Date(2013, 0, 1), // &lt;-A </strong></span>
<span class="strong"><strong>        end = new Date(2013, 11, 31),</strong></span>
<span class="strong"><strong>        range = [0, 1200],</strong></span>
<span class="strong"><strong>        time = d3.time.scale().domain([start, end]) // &lt;-B</strong></span>
<span class="strong"><strong>            .rangeRound(range), // &lt;-C</strong></span>
        max = 12,
        data = [];

<span class="strong"><strong>    for (var i = 0; i &lt; max; ++i){ // &lt;-D</strong></span>
<span class="strong"><strong>        var date = new Date(start.getTime());</strong></span>
<span class="strong"><strong>        date.setMonth(start.getMonth() + i);</strong></span>
<span class="strong"><strong>        data.push(date);</strong></span>
<span class="strong"><strong>    }</strong></span>

    function render(data, scale, selector) { // &lt;-E
        d3.select(selector).selectAll("div.fixed-cell")
                    .data(data)
                .enter()
                    .append("div").classed("fixed-cell", true);

        d3.select(selector).selectAll("div.fixed-cell")
                    .data(data)
                .exit().remove();

        d3.select(selector).selectAll("div.fixed-cell")
                    .data(data)
<span class="strong"><strong>                .style("margin-left", function(d){ // &lt;-F</strong></span>
<span class="strong"><strong>                    return scale(d) + "px";</strong></span>
<span class="strong"><strong>                })</strong></span>
<span class="strong"><strong>                .html(function (d) { // &lt;-G</strong></span>
<span class="strong"><strong>                    var format = d3.time.format("%x"); // &lt;-H</strong></span>
<span class="strong"><strong>                    return format(d) + "&lt;br&gt;" + scale(d) + "px";</strong></span>
<span class="strong"><strong>                });</strong></span>
    }

    render(data, time, "#time");
&lt;/script&gt;</pre></div><p>This recipe generates the<a id="id239" class="indexterm"/> following visual output:</p><div class="mediaobject"><img src="graphics/2162OS_04_09.jpg" alt="How to do it..."/><div class="caption"><p>Time scale</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec66"/>How it works...</h2></div></div></div><p>In this recipe, we have a <code class="literal">Date</code> range defined on line <code class="literal">A</code> between January 1, 2013 and December 31, 2013.</p><div class="informalexample"><pre class="programlisting">var start = new Date(2013, 0, 1), // &lt;-A 
        end = new Date(2013, 11, 31),
        range = [0, 900],
        time = d3.time.scale().domain([start, end]) // &lt;-B
            .rangeRound(range), // &lt;-C</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip28"/>Tip</h3><p>The JavaScript <code class="literal">Date</code> object starts its month from <code class="literal">0</code> and day from <code class="literal">1</code>. Therefore, <code class="literal">new Date(2013, 0, 1)</code> gives you January 1, 2013 while <code class="literal">new Date(2013, 0, 0)</code> actually gives you December 31, 2012.</p></div></div><p>This range was then <a id="id240" class="indexterm"/>used to create a D3 <span class="strong"><strong>time scale</strong></span> on line <code class="literal">B</code> using the <code class="literal">d3.time.scale</code> function. Similar to quantitative scales, time scale also supports separate <code class="literal">domain</code> and <code class="literal">range</code> definition, which is used to map date- and time-based data points to visual range. In this example, we set the range of the scale to <code class="literal">[0, 900]</code>. This effectively defines a mapping from any date-and-time value in time range between January 1, 2013 and December 31, 2013 to a number between 0 and 900.</p><p>With the time scale defined, we can now map any given <code class="literal">Date</code> object by calling the scale function, for example, <code class="literal">time(new Date(2013, 4, 1))</code> will return <code class="literal">395</code> and <code class="literal">time(new Date(2013, 11, 15))</code> will return <code class="literal">1147</code>, and so on.</p><p>On line <code class="literal">D</code>, we create our data array consisting 12 months from January to December in 2013:</p><div class="informalexample"><pre class="programlisting">    for (var i = 0; i &lt; max; ++i){ // &lt;-D
        var date = new Date(start.getTime());
        date.setMonth(start.getMonth() + i);
        data.push(date);
    }</pre></div><p>Then, on line <code class="literal">E</code>, we created 12 cells representing each month in a year using the <code class="literal">render</code> function.</p><p> To spread the cells horizontally, line <code class="literal">F</code> performs a mapping from the month to the <code class="literal">margin-left</code> CSS style using the time scale we defined:</p><div class="informalexample"><pre class="programlisting">.style("margin-left", function(d){ // &lt;-F
    return scale(d) + "px";
})</pre></div><p>Line <code class="literal">G</code> generates the label to demonstrating what the scale-based mapping produces in this example:</p><div class="informalexample"><pre class="programlisting">.html(function (d) { // &lt;-G
    var format = d3.time.format("%x"); // &lt;-H
    return format(d) + "&lt;br&gt;" + scale(d) + "px";
});</pre></div><p>To generate human-readable strings from a JavaScript <code class="literal">Date</code> object, we used a D3 time formatter on line <code class="literal">H</code>. D3 ships with a powerful and flexible time-formatting library, which is extremely useful when dealing with the <code class="literal">Date</code> object.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec67"/>There's more...</h2></div></div></div><p>Here are some<a id="id241" class="indexterm"/> of the most useful<a id="id242" class="indexterm"/> <code class="literal">d3.time.format</code> patterns:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">%a</code>: This is the abbreviated weekday name</li><li class="listitem" style="list-style-type: disc"><code class="literal">%A</code>: This is the full weekday name</li><li class="listitem" style="list-style-type: disc"><code class="literal">%b</code>: This is the abbreviated month name</li><li class="listitem" style="list-style-type: disc"><code class="literal">%B</code>: This is the full month name</li><li class="listitem" style="list-style-type: disc"><code class="literal">%d</code>: This is the zero-padded day of the month as a decimal number [01,31]</li><li class="listitem" style="list-style-type: disc"><code class="literal">%e</code>: This is the space-padded day of the month as a decimal number [ 1,31]</li><li class="listitem" style="list-style-type: disc"><code class="literal">%H</code>: This is the hour (24-hour clock) as a decimal number [00,23]</li><li class="listitem" style="list-style-type: disc"><code class="literal">%I</code>: This is the hour (12-hour clock) as a decimal number [01,12]</li><li class="listitem" style="list-style-type: disc"><code class="literal">%j</code>: This is the day of the year as a decimal number [001,366]</li><li class="listitem" style="list-style-type: disc"><code class="literal">%m</code>: This is the month as a decimal number [01,12]</li><li class="listitem" style="list-style-type: disc"><code class="literal">%M</code>: This is the minute as a decimal number [00,59]</li><li class="listitem" style="list-style-type: disc"><code class="literal">%L</code>: This is the milliseconds as a decimal number [000, 999]</li><li class="listitem" style="list-style-type: disc"><code class="literal">%p</code>: This is the either AM or PM</li><li class="listitem" style="list-style-type: disc"><code class="literal">%S</code>: This is the second as a decimal number [00,61]</li><li class="listitem" style="list-style-type: disc"><code class="literal">%x</code>: This is the date, as "<code class="literal">%m/%d/%Y</code>"</li><li class="listitem" style="list-style-type: disc"><code class="literal">%X</code>: This is the time, as "<code class="literal">%H:%M:%S</code>"</li><li class="listitem" style="list-style-type: disc"><code class="literal">%y</code>: This is the year without century as a decimal number [00,99]</li><li class="listitem" style="list-style-type: disc"><code class="literal">%Y</code>: This is the year with century as a decimal number</li></ul></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec68"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For the complete reference on D3 time format pattern visit the following link:<p>
<a class="ulink" href="https://github.com/mbostock/d3/wiki/Time-Formatting#wiki-format">https://github.com/mbostock/d3/wiki/Time-Formatting#wiki-format</a>
</p></li></ul></div></div></div>
<div class="section" title="Using the ordinal scale"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec30"/>Using the ordinal scale</h1></div></div></div><p>In some cases, we might need to map our data to some ordinal values, for example, <code class="literal">["a", "b", "c"]</code> or <code class="literal">["#1f77b4", "#ff7f0e", "#2ca02c"]</code>. So, how can we perform this kind of mapping using D3 scales? This recipe is dedicated to address this kind of question.</p><div class="section" title="Getting Ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec69"/>Getting Ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/ordinal-scale.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/ordinal-scale.html</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec70"/>How to do it...</h2></div></div></div><p>This kind of ordinal <a id="id243" class="indexterm"/>mapping is quite common in data visualization. For example, you might want to map certain data points through categorization into some textual value or perhaps into RGB color code, which in turn can be used in CSS styling. D3 offers a specialized scale implementation to handle this kind of mapping. We will explore its usage here. Here is the code of the <code class="literal">ordinal.scale.html</code> file:</p><div class="informalexample"><pre class="programlisting">&lt;div id="alphabet" class="clear"&gt;
    &lt;span&gt;Ordinal Scale with Alphabet&lt;/span&gt;
    &lt;span&gt;Mapping [1..10] to ["a".."j"]&lt;/span&gt;
&lt;/div&gt;
&lt;div id="category10" class="clear"&gt;
    &lt;span&gt;Ordinal Color Scale Category 10&lt;/span&gt;
    &lt;span&gt;Mapping [1..10] to category 10 colors&lt;/span&gt;
&lt;/div&gt;
&lt;div id="category20" class="clear"&gt;
    &lt;span&gt;Ordinal Color Scale Category 20&lt;/span&gt;
    &lt;span&gt;Mapping [1..10] to category 20 colors&lt;/span&gt;
&lt;/div&gt;
&lt;div id="category20b" class="clear"&gt;
    &lt;span&gt;Ordinal Color Scale Category 20b&lt;/span&gt;     &lt;span&gt;Mapping [1..10] to category 20b colors&lt;/span&gt;
&lt;/div&gt;
&lt;div id="category20c" class="clear"&gt;
    &lt;span&gt;Ordinal Color Scale Category 20c&lt;/span&gt;
    &lt;span&gt;Mapping [1..10] to category 20c colors&lt;/span&gt;
&lt;/div&gt;

&lt;script type="text/javascript"&gt;
    var max = 10, data = [];

    for (var i = 0; i &lt; max; ++i) data.push(i); // &lt;-A
    
<span class="strong"><strong>    var alphabet = d3.scale.ordinal() // &lt;-B</strong></span>
<span class="strong"><strong>        .domain(data)</strong></span>
<span class="strong"><strong>        .range(["a", "b", "c", "d", "e", "f", "g", "h", "i", "j"]);</strong></span>
        
    function render(data, scale, selector) { // &lt;-C
        d3.select(selector).selectAll("div.cell")
                  .data(data)
              .enter().append("div").classed("cell", true);

        d3.select(selector).selectAll("div.cell")
                  .data(data)
              .exit().remove();

        d3.select(selector).selectAll("div.cell")
                  .data(data)
              .style("display", "inline-block")
<span class="strong"><strong>              .style("background-color", function(d){  // &lt;-D</strong></span>
<span class="strong"><strong>                return scale(d).indexOf("#")&gt;=0?scale(d):"white";</strong></span>
<span class="strong"><strong>              })</strong></span>
<span class="strong"><strong>                .text(function (d) { // &lt;-E</strong></span>
<span class="strong"><strong>                    return scale(d);</strong></span>
<span class="strong"><strong>                });</strong></span>
    }

    render(data, alphabet, "#alphabet"); // &lt;-F
    render(data, d3.scale.category10(), "#category10");
    render(data, d3.scale.category20(), "#category20");
    render(data, d3.scale.category20b(), "#category20b");
    render(data, d3.scale.category20c(), "#category20c"); // &lt;-G
&lt;/script&gt;</pre></div><p>The preceding code<a id="id244" class="indexterm"/> outputs the following in your browser:</p><div class="mediaobject"><img src="graphics/2162OS_04_10.jpg" alt="How to do it..."/><div class="caption"><p>Ordinal scale</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec71"/>How it works...</h2></div></div></div><p>In the above code example, <a id="id245" class="indexterm"/>a simple data array containing integers from <code class="literal">0</code> to <code class="literal">9</code> is defined on line <code class="literal">A</code>:</p><div class="informalexample"><pre class="programlisting">for (var i = 0; i &lt; max; ++i) data.push(i); // &lt;-A    
var alphabet = d3.scale.ordinal() // &lt;-B
    .domain(data)
.range(["a", "b", "c", "d", "e", "f", "g", "h", "i", "j"]);</pre></div><p>Then an ordinal scale was created using the <code class="literal">d3.scale.ordinal</code> function on line <code class="literal">B</code>. The domain of this scale was set to our integer array data while range is set to a list of alphabets from <code class="literal">a</code> to <code class="literal">j</code>.</p><p>With this scale defined, we can perform the mapping by simply invoking the scale function, for example, <code class="literal">alphabet(0)</code> will return <code class="literal">a</code>, <code class="literal">alphabet(4)</code> will return <code class="literal">e</code>, and so on.</p><p>On line <code class="literal">C</code>, the <code class="literal">render</code> function was defined to generate a number of <code class="literal">div</code> elements on the page to represent the 10 elements in a data array. Each <code class="literal">div</code> has its <code class="literal">background-color</code> set to scale function's output or <code class="literal">white</code> if the output is not an RGB color string:</p><div class="informalexample"><pre class="programlisting">.style("background-color", function(d){  // &lt;-D
    return scale(d).indexOf("#")&gt;=0 ? scale(d) : "white";
})</pre></div><p>On line <code class="literal">E</code>, we also set the text of each cell to display scale function's output:</p><div class="informalexample"><pre class="programlisting">.text(function (d) { // &lt;-E
    return scale(d);
});</pre></div><p>Now, with all the structures <a id="id246" class="indexterm"/>in place, from line <code class="literal">F</code> to <code class="literal">G</code>, the <code class="literal">render</code> function was repetitively called with different ordinal scales to produce different visual outputs. On line <code class="literal">F</code>, calling <code class="literal">render</code> with the <code class="literal">alphabet</code> ordinal scale produces the following output:</p><div class="mediaobject"><img src="graphics/2162OS_04_11.jpg" alt="How it works..."/><div class="caption"><p>Alphabetic ordinal scale</p></div></div><p>While on line <code class="literal">G</code>, calling the <code class="literal">render</code> function with the built-in <code class="literal">d3.scale.category20c</code> ordinal color scale produces the following output:</p><div class="mediaobject"><img src="graphics/2162OS_04_12.jpg" alt="How it works..."/><div class="caption"><p>Color ordinal scale</p></div></div><p>Because assigning different colors to different elements in visualization is a common task, for example, assigning different colors in Pie and Bubble charts, D3 provides a number of different built-in ordinal color scales as we have seen in this recipe.</p><p>It is quite easy to build your own simple custom ordinal color scale. Just create an ordinal scale with the range set to the colors you want to use, for example:</p><div class="informalexample"><pre class="programlisting">d3.scale.ordinal()
.range(["#1f77b4", "#ff7f0e", "#2ca02c"]);</pre></div></div></div>
<div class="section" title="Interpolating a string"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec31"/>Interpolating a string</h1></div></div></div><p>In some cases, you might need to interpolate <a id="id247" class="indexterm"/>numbers embedded in a string; perhaps a CSS style for font.</p><p>In this recipe, we will examine how you can do that using D3 scale and interpolation. However, before we jump right into string interpolation, a bit of background research on interpolator is due and the following section will cover what interpolation is and how D3 implements interpolator functions.</p><div class="section" title="Interpolator"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec72"/>Interpolator</h2></div></div></div><p>In the first three recipes, we have gone over three different D3 scale implementations, now it is time to delve a little deeper into  D3 scales. You are probably already asking the question, "How different scale knows what value to use for different inputs?" In fact this question can be generalized to:</p><div class="blockquote"><blockquote class="blockquote"><p>We are given the values of a function f(x) at different points x0, x1, … ,xn. We want to find approximate values of the function f(x) for "new" x's that lie between these points . This process is called <span class="strong"><strong>interpolation</strong></span>.</p><p>Kreyszig E &amp; Kreyszig H &amp; Norminton E. J. (2010)</p></blockquote></div><p>Interpolation is not only important in scale implementation but also essential to many other core D3 capabilities, for example, animation and layout management. It is because of this essential role, D3 has designed a separate and re-usable construct called <span class="strong"><strong>interpolator</strong></span>
<a id="id248" class="indexterm"/> so that this common cross-functional concern can be addressed in a centralized and consistent fashion. Let's take a simple interpolator as an example:</p><div class="informalexample"><pre class="programlisting">var interpolate = d3.interpolateNumber(0, 100);
interpolate(0.1); // =&gt; 10
interpolate(0.99); //=&gt; 99</pre></div><p>In this simple <a id="id249" class="indexterm"/>example, we created a D3 number interpolator with a range of <code class="literal">[0, 100]</code>. The <code class="literal">d3.interpolateNumber</code> function returns an <code class="literal">interpolate</code> function which we can use to perform number-based interpolations. The <code class="literal">interpolate</code> function is an equivalent to the following code:</p><div class="informalexample"><pre class="programlisting">function interpolate(t) {
    return a * (1 - t) + b * t;
}</pre></div><p>In this function, <code class="literal">a</code> represents the start of the range and <code class="literal">b</code> represents the end of the range. The parameter <code class="literal">t</code> passed into the<a id="id250" class="indexterm"/> <code class="literal">interpolate()</code> function, is a float-point number ranging from 0 to 1, and it signifies how far the return value is from <code class="literal">a</code>.</p><p>D3 provides a number of built-in interpolators. Due to limited scope in this book, we will focus on some of the more interesting interpolators for the next few recipes; we are ending our discussion on simple number interpolation here. Nevertheless, the fundamental approach and mechanism remains the same whether it is a number or an RGB color code interpolator.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note21"/>Note</h3><p>For more details on number and round interpolation, please refer to the D3 reference documents at <a class="ulink" href="https://github.com/mbostock/d3/wiki/Transitions#wiki-d3_interpolateNumber">https://github.com/mbostock/d3/wiki/Transitions#wiki-d3_interpolateNumber</a>
</p></div></div><p>Now with general interpolation concepts behind, let's take a look at how string interpolator works in D3.</p></div><div class="section" title="Getting Ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec73"/>Getting Ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/string-interpolation.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/string-interpolation.html</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec74"/>How to do it...</h2></div></div></div><p>String interpolator <a id="id251" class="indexterm"/>finds the numbers embedded in the string, then performs interpolation using D3 number interpolator:</p><div class="informalexample"><pre class="programlisting">&lt;div id="font" class="clear"&gt;
    &lt;span&gt;Font Interpolation&lt;br&gt;&lt;/span&gt;
&lt;/div&gt;

&lt;script type="text/javascript"&gt;
    var max = 11, data = [];

<span class="strong"><strong>    var sizeScale = d3.scale.linear() // &lt;-A</strong></span>
<span class="strong"><strong>        .domain([0, max])</strong></span>
<span class="strong"><strong>        .range([  // &lt;-B</strong></span>
<span class="strong"><strong>            "italic bold 12px/30px Georgia, serif", </strong></span>
<span class="strong"><strong>            "italic bold 120px/180px Georgia, serif"</strong></span>
<span class="strong"><strong>        ]);</strong></span>

    for (var i = 0; i &lt; max; ++i){ data.push(i); }

    function render(data, scale, selector) { // &lt;-C
        d3.select(selector).selectAll("div.cell")
                .data(data)
            .enter().append("div").classed("cell", true)
                .append("span");

        d3.select(selector).selectAll("div.cell")
                .data(data)
            .exit().remove();

        d3.select(selector).selectAll("div.cell")
                .data(data)
            .style("display", "inline-block")
            .select("span")
<span class="strong"><strong>                .style("font", function(d,i){ </strong></span>
<span class="strong"><strong>                    return scale(d); // &lt;-D</strong></span>
<span class="strong"><strong>                })</strong></span>
<span class="strong"><strong>                .text(function(d,i){return i;}); // &lt;-E</strong></span>
    }

    render(data, sizeScale, "#font");
&lt;/script&gt;</pre></div><p>The preceding code produces the following output:</p><div class="mediaobject"><img src="graphics/2162OS_04_13.jpg" alt="How to do it..."/><div class="caption"><p>String interpolation</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec75"/>How it works...</h2></div></div></div><p>In this example, <a id="id252" class="indexterm"/>we created a linear scale on line <code class="literal">A</code> with range specified between two strings representing start and end <code class="literal">font</code> styles:</p><div class="informalexample"><pre class="programlisting">var sizeScale = d3.scale.linear() // &lt;-A
        .domain([0, max])
        .range([  // &lt;-B
            "italic bold 12px/30px Georgia, serif", 
            "italic bold 120px/180px Georgia, serif"
        ]);</pre></div><p>As you can see in the code of the <code class="literal">string-interpolation.html</code> file, the <code class="literal">font</code> style strings contain <code class="literal">font-size</code> numbers <code class="literal">12px/30px</code> and <code class="literal">120px/180px</code>, which we want to interpolate in this recipe.</p><p>On line <code class="literal">C</code>, the <code class="literal">render()</code> function simply creates 10 cells containing each one's index numbers (line <code class="literal">E</code>) styled using interpolated <code class="literal">font</code> style string calculated on line <code class="literal">D</code>.</p><div class="informalexample"><pre class="programlisting">.style("font", function(d,i){ 
    return scale(d); // &lt;-D
})
.text(function(d,i){return i;}); // &lt;-E</pre></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec76"/>There's more...</h2></div></div></div><p>Though we<a id="id253" class="indexterm"/> demonstrated string interpolation in D3 using a CSS font style as an example, D3 string interpolator is not only limited handling CSS styles. It can basically handle any string, and interpolates the embedded number as long as the number matches the following <a id="id254" class="indexterm"/>
<span class="strong"><strong>Regex pattern</strong></span>:</p><div class="informalexample"><pre class="programlisting">/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip29"/>Tip</h3><p>When generating a string using interpolation, very small values, when stringified, may get converted to scientific notation, for example, <span class="strong"><strong>1e-7</strong></span>. To avoid this particular conversion, you need to keep your value larger than 1e-6.</p></div></div></div></div>
<div class="section" title="Interpolating colors"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec32"/>Interpolating colors</h1></div></div></div><p>It is sometimes necessary to interpolate colors when you are interpolating values that do not contain numbers but rather RGB or HSL color code. This recipe addresses the question <span class="emphasis"><em>how can you define</em></span>
<a id="id255" class="indexterm"/>
<span class="emphasis"><em> scales for color codes and perform interpolation on them?</em></span>
</p><div class="section" title="Getting Ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec77"/>Getting Ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/color-interpolation.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/color-interpolation.html</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec78"/>How to do it...</h2></div></div></div><p>Color interpolation is such a common operation in visualization that D3 actually provides four different kinds of interpolators dedicated for color supporting—RGB, HSL, L*a*b*, and HCL color space. In this recipe, we will demonstrate how color interpolation can be performed in RGB color space. However, all other color interpolators work in the same way.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip30"/>Tip</h3><p>D3 color interpolate function always returns interpolated color in RGB space no matter what the original color space it is since not all browsers support HSL or L*a*b* color <a id="id256" class="indexterm"/>spaces.</p></div></div><div class="informalexample"><pre class="programlisting">&lt;div id="color" class="clear"&gt;
    &lt;span&gt;Linear Color Interpolation&lt;br&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div id="color-diverge" class="clear"&gt;
    &lt;span&gt;Poly-Linear Color Interpolation&lt;br&gt;&lt;/span&gt;
&lt;/div&gt;

&lt;script type="text/javascript"&gt;
    var max = 21, data = [];

<span class="strong"><strong>    var colorScale = d3.scale.linear() // &lt;-A</strong></span>
<span class="strong"><strong>        .domain([0, max])</strong></span>
<span class="strong"><strong>        .range(["white", "#4169e1"]);</strong></span>

<span class="strong"><strong>    function divergingScale(pivot) { // &lt;-B</strong></span>
<span class="strong"><strong>        var divergingColorScale = d3.scale.linear()</strong></span>
<span class="strong"><strong>            .domain([0, pivot, max]) // &lt;-C</strong></span>
<span class="strong"><strong>            .range(["white", "#4169e1", "white"]);</strong></span>
<span class="strong"><strong>        return divergingColorScale;</strong></span>
<span class="strong"><strong>    }</strong></span>

    for (var i = 0; i &lt; max; ++i) data.push(i);

    function render(data, scale, selector) { // &lt;-D
        d3.select(selector).selectAll("div.cell")
                .data(data)
            .enter()
                .append("div")
                    .classed("cell", true)
                .append("span");

        d3.select(selector).selectAll("div.cell")
                .data(data)
            .exit().remove();

        d3.select(selector).selectAll("div.cell")
                .data(data)
            .style("display", "inline-block")
<span class="strong"><strong>            .style("background-color", function(d){</strong></span>
<span class="strong"><strong>                return scale(d); // &lt;-E</strong></span>
<span class="strong"><strong>            })</strong></span>
            .select("span")
                .text(function(d,i){return i;});
    }

    render(data, colorScale, "#color");
    render(data, divergingScale(5), "#color-diverge");
&lt;/script&gt;</pre></div><p>The preceding code produces the following visual output:</p><div class="mediaobject"><img src="graphics/2162OS_04_14.jpg" alt="How to do it..."/><div class="caption"><p>Color interpolation</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec79"/>How it works...</h2></div></div></div><p>The first step in this<a id="id257" class="indexterm"/> recipe is defining a linear color scale on line <code class="literal">A</code> with its range set as <code class="literal">["white", "#4169e1"]</code>.</p><div class="informalexample"><pre class="programlisting">var colorScale = d3.scale.linear() // &lt;-A
    .domain([0, max])
    .range(["white", "#4169e1"]);</pre></div><p>One new technique used in this recipe, that we haven't encountered yet, is the <span class="strong"><strong>poly-linear scale</strong></span>
<a id="id258" class="indexterm"/>, which is defined in the <code class="literal">divergingScale</code> function<a id="id259" class="indexterm"/> on line <code class="literal">B</code>.</p><div class="informalexample"><pre class="programlisting">function divergingScale(pivot) { // &lt;-B
    var divergingColorScale = d3.scale.linear()
        .domain([0, pivot, max]) // &lt;-C
        .range(["white", "#4169e1", "white"]);
    return divergingColorScale;
}</pre></div><p>A poly-linear scale is a scale with non-uniformed linear progression. It is achieved by providing a poly-linear domain on a linear scale as we can see on line <code class="literal">C</code>. You can think of a poly-linear scale as stitching two linear scales with different domains together. So this poly-linear color scale is effectively the two following linear scales combined together.</p><div class="informalexample"><pre class="programlisting">d3.scale.linear()
    .domain([0, pivot]).range(["white", "#4169e1"]);
d3.scale.linear()
.domain([pivot, max]).range(["#4169e1", "white "]);</pre></div><p>No surprise in the rest of the recipe. The <code class="literal">render()</code> function defined on line <code class="literal">D</code> generates 20 cells that are numbered by its index and colored using the output of two color scales we defined earlier. Clicking the buttons on the web page (such as <span class="strong"><strong>Pivot at 5</strong></span>) will show you the effect of<a id="id260" class="indexterm"/> pivoting at different positions in a poly-linear color scale.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec80"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For a complete list of supported color keywords in CSS3, please refer to W3C official reference <a class="ulink" href="http://www.w3.org/TR/css3-color/#html4">http://www.w3.org/TR/css3-color/#html4</a></li></ul></div></div></div>
<div class="section" title="Interpolating compound objects"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec33"/>Interpolating compound objects</h1></div></div></div><p>There will be cases when what<a id="id261" class="indexterm"/> you need to interpolate in your visualization is not a simple value but rather an object consisting of multiple and different values, for example, a rectangular object with width, height, and color attributes. Fortunately, D3 has a built-in support for this type of compound object interpolation.</p><div class="section" title="Getting Ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec81"/>Getting Ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/compound-interpolation.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/compound-interpolation.html</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec82"/>How to do it...</h2></div></div></div><p>In this recipe, we will examine how compound object interpolation is performed in D3. The code for the <code class="literal">compound-interpolation.html</code> file is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;div id="compound" class="clear"&gt;
    &lt;span&gt;Compound Interpolation&lt;br&gt;&lt;/span&gt;
&lt;/div&gt;

&lt;script type="text/javascript"&gt;
    var max = 21, data = [];

<span class="strong"><strong>    var compoundScale = d3.scale.pow()</strong></span>
<span class="strong"><strong>            .exponent(2)</strong></span>
<span class="strong"><strong>            .domain([0, max])</strong></span>
<span class="strong"><strong>            .range([</strong></span>
<span class="strong"><strong>                {color:"#add8e6", height:"15px"}, // &lt;-A</strong></span>
<span class="strong"><strong>                {color:"#4169e1", height:"150px"} // &lt;-B</strong></span>
<span class="strong"><strong>            ]);</strong></span>

    for (var i = 0; i &lt; max; ++i) data.push(i);

    function render(data, scale, selector) { // &lt;-C
        d3.select(selector).selectAll("div.v-bar")
                .data(data)
                .enter().append("div").classed("v-bar", true)
                .append("span");

        d3.select(selector).selectAll("div.v-bar")
                .data(data)
                .exit().remove();

        d3.select(selector).selectAll("div.v-bar")
                .data(data)
                .classed("v-bar", true)
<span class="strong"><strong>                .style("height", function(d){ // &lt;-D</strong></span>
<span class="strong"><strong>                    return scale(d).height;</strong></span>
<span class="strong"><strong>                }) </strong></span>
<span class="strong"><strong>                .style("background-color", function(d){ // &lt;-E</strong></span>
<span class="strong"><strong>                    return scale(d).color;</strong></span>
<span class="strong"><strong>                })</strong></span>
                .select("span")
                .text(function(d,i){return i;});
    }

    render(data, compoundScale, "#compound");
&lt;/script&gt;</pre></div><p>The preceding code <a id="id262" class="indexterm"/>generates the following visual output:</p><div class="mediaobject"><img src="graphics/2162OS_04_15.jpg" alt="How to do it..."/><div class="caption"><p>Compound object interpolation</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec83"/>How it works...</h2></div></div></div><p>This recipe is different from the previous recipes of this chapter by the fact that the scale we use in this recipe has a range defined using two objects rather than simple primitive data types:</p><div class="informalexample"><pre class="programlisting">var compoundScale = d3.scale.pow()
            .exponent(2)
            .domain([0, max])
            .range([
                {color:"#add8e6", height:"15px"}, // &lt;-A
                {color:"#4169e1", height:"150px"} // &lt;-B
            ]);</pre></div><p>We can see on line <code class="literal">A</code> and <code class="literal">B</code> that the start and end of the scale range are two objects which contain two different kinds of values; one for RGB color and the other one for CSS height style. When you interpolate this kind of a scale containing compound range, D3 will iterate through each of the fields inside an object and recursively apply the simple interpolation rule on each one of them. Thus, in other words, for this example, D3 will interpolate the <code class="literal">color</code> field using color interpolation from <code class="literal">#add8e6</code> to <code class="literal">#4169e1</code> while using string interpolation on height field from <code class="literal">15px</code> to <code class="literal">150px</code>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip31"/>Tip</h3><p>The recursive nature of this algorithm allows D3 to interpolate on even nested objects. Therefore you can interpolate on an object like this:</p></div></div><div class="informalexample"><pre class="programlisting">{
  color:"#add8e6", 
  size{ 
height:"15px", 
width: "25px"
  }
}</pre></div><p>A compound scale function, when invoked, returns a compound object that matches the given range definition:</p><div class="informalexample"><pre class="programlisting">.style("height", function(d){
  return scale(d).height; // &lt;-D
}) 
.style("background-color", function(d){
  return scale(d).color; // &lt;-E
})</pre></div><p>As we can see on <a id="id263" class="indexterm"/>line <code class="literal">D</code> and <code class="literal">E</code>, the returned value is a compound object, and this is why we can access its attribute to retrieve the interpolated values.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip32"/>Tip</h3><p>Though it is not a common case, if the start and end of your compound scale range do not have identical attributes, D3 won't complain but rather it will just treat the missing attribute as a constant. The following scale will render the height to be <code class="literal">15px</code> for all the <code class="literal">div</code> elements:</p></div></div><div class="informalexample"><pre class="programlisting">var compoundScale = d3.scale.pow()
            .exponent(2)
            .domain([0, max])
            .range([
                {color:"#add8e6", height:"15px"}, // &lt;-A
                {color:"#4169e1"} // &lt;-B
            ]);</pre></div></div></div>
<div class="section" title="Implementing a custom interpolator"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec34"/>Implementing a custom interpolator</h1></div></div></div><p>In some rare cases, you might<a id="id264" class="indexterm"/> find that the built-in D3 interpolators are not enough to handle your visualization requirement. In such situations, you can choose to implement your own interpolator with specific logic to handle your needs. In this recipe, we will examine this approach and demonstrate some interesting use cases.</p><div class="section" title="Getting Ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec84"/>Getting Ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/custom-interpolator.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter4/custom-interpolator.html</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec85"/>How to do it...</h2></div></div></div><p>Let's take a look at two different examples of custom interpolator implementation. In the first example, we will implement a custom function capable of interpolating price in dollars, while in the second one <a id="id265" class="indexterm"/>we will implement custom interpolator for alphabets. Here is the code to this implementation:</p><div class="informalexample"><pre class="programlisting">&lt;div id="dollar" class="clear"&gt;
    &lt;span&gt;Custom Dollar Interpolation&lt;br&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div id="alphabet" class="clear"&gt;
    &lt;span&gt;Custom Alphabet Interpolation&lt;br&gt;&lt;/span&gt;
&lt;/div&gt;

&lt;script type="text/javascript"&gt;
<span class="strong"><strong>    d3.interpolators.push(function(a, b) { // &lt;-A</strong></span>
<span class="strong"><strong>      var re = /^\$([0-9,.]+)$/, // &lt;-B</strong></span>
<span class="strong"><strong>        ma, mb, f = d3.format(",.02f"); </strong></span>
<span class="strong"><strong>      if ((ma = re.exec(a)) &amp;&amp; (mb = re.exec(b))) { // &lt;-C</strong></span>
<span class="strong"><strong>        a = parseFloat(ma[1]);</strong></span>
<span class="strong"><strong>        b = parseFloat(mb[1]) - a;  // &lt;-D</strong></span>
<span class="strong"><strong>        return function(t) {  // &lt;-E</strong></span>
<span class="strong"><strong>          return "$" + f(a + b * t); // &lt;-F</strong></span>
<span class="strong"><strong>        };</strong></span>
<span class="strong"><strong>      }</strong></span>
<span class="strong"><strong>    });</strong></span>

<span class="strong"><strong>    d3.interpolators.push(function(a, b) { // &lt;-G</strong></span>
<span class="strong"><strong>      var re = /^([a-z])$/, ma, mb; // &lt;-H</strong></span>
<span class="strong"><strong>      if ((ma = re.exec(a)) &amp;&amp; (mb = re.exec(b))) { // &lt;-I</strong></span>
<span class="strong"><strong>        a = a.charCodeAt(0);</strong></span>
<span class="strong"><strong>        var delta = a - b.charCodeAt(0); // &lt;-J</strong></span>
<span class="strong"><strong>        return function(t) { // &lt;-K</strong></span>
<span class="strong"><strong>          return String.fromCharCode(Math.ceil(a - delta * t));</strong></span>
<span class="strong"><strong>        };</strong></span>
<span class="strong"><strong>      }</strong></span>
<span class="strong"><strong>    });</strong></span>

<span class="strong"><strong>    var dollarScale = d3.scale.linear()</strong></span>
<span class="strong"><strong>            .domain([0, 11])</strong></span>
<span class="strong"><strong>            .range(["$0", "$300"]); // &lt;-L</strong></span>
<span class="strong"><strong>            </strong></span>
<span class="strong"><strong>    var alphabetScale = d3.scale.linear()</strong></span>
<span class="strong"><strong>            .domain([0, 27])</strong></span>
<span class="strong"><strong>            .range(["a", "z"]); // &lt;-M</strong></span>
        
    function render(scale, selector) {        
        var data = [];
        var max = scale.domain()[1];
        
        for (var i = 0; i &lt; max; ++i) data.push(i);      
        
        d3.select(selector).selectAll("div.cell")
                    .data(data)
                .enter()
                    .append("div")
                        .classed("cell", true)
                    .append("span");

        d3.select(selector).selectAll("div.cell")
                    .data(data)
                .exit().remove();

        d3.select(selector).selectAll("div.cell")
                .data(data)
                .style("display", "inline-block")
                .select("span")
<span class="strong"><strong>                    .text(function(d,i){return scale(d);}); // &lt;-N</strong></span>
    }

    render(dollarScale, "#dollar");
    render(alphabetScale, "#alphabet");
&lt;/script&gt;</pre></div><p>The preceding code <a id="id266" class="indexterm"/>generates the following visual output:</p><div class="mediaobject"><img src="graphics/2162OS_04_16.jpg" alt="How to do it..."/><div class="caption"><p>Custom interpolation</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec86"/>How it works...</h2></div></div></div><p>The first custom<a id="id267" class="indexterm"/> interpolator we encounter in this recipe is defined on line <code class="literal">A</code>. The custom interpolator function is a bit more involved, so, let's take a closer look at how it works:</p><div class="informalexample"><pre class="programlisting">d3.interpolators.push(function(a, b) { // &lt;-A
      var re = /^\$([0-9,.]+)$/, // &lt;-B
        ma, mb, f = d3.format(",.02f"); 
      if ((ma = re.exec(a)) &amp;&amp; (mb = re.exec(b))) { // &lt;-C
        a = parseFloat(ma[1]);
        b = parseFloat(mb[1]) - a;  // &lt;-D
        return function(t) {  // &lt;-E
          return "$" + f(a + b * t); // &lt;-F
        };
      }
    });</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note22"/>Note</h3><p>This custom interpolator in the following link was directly extracted from D3 Wiki:</p><p>
<a class="ulink" href="https://github.com/mbostock/d3/wiki/Transitions#wiki-d3_interpolators">https://github.com/mbostock/d3/wiki/Transitions#wiki-d3_interpolators</a>
</p></div></div><p>On the line <code class="literal">A</code>, we push an interpolator function into <code class="literal">d3.interpolators</code>. This is a global interpolator registry array that contains all known registered interpolators. By default, this registry contains the following interpolators:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Number interpolator</li><li class="listitem" style="list-style-type: disc">String interpolator </li><li class="listitem" style="list-style-type: disc">Color interpolator</li><li class="listitem" style="list-style-type: disc">Object interpolator</li><li class="listitem" style="list-style-type: disc">Array interpolator</li></ul></div><p>Any new <a id="id268" class="indexterm"/>custom interpolator implementation can be pushed to the tail of the interpolators array which then becomes globally available. An interpolator function is expected to be a factory function that takes the start of the range (<code class="literal">a</code>) and the end of the range (<code class="literal">b</code>) as its input parameters while returning an implementation of the interpolate function as seen on line <code class="literal">E</code>. You might be wondering how D3 knows which interpolator to use when a certain string value is presented. The key to this lies on line <code class="literal">B</code>. Typically we use a variable called <code class="literal">re</code> defined as a regex pattern of <code class="literal">/^\$([0-9,.]+)$/</code>, which is then used to match both parameter <code class="literal">a</code> and <code class="literal">b</code> for any number with a leading dollar sign. If both parameters match the given pattern then the matching interpolate function is constructed and returned; otherwise D3 will continue iterating through <code class="literal">d3.interpolators</code> array to find a suitable interpolator.</p><p>Instead of an array, <code class="literal">d3.interpolators</code> is actually better considered as a FILO stack (though not exactly implemented as a stack), where new interpolators can be pushed to the top of the stack. When selecting an interpolator, D3 will pop and check each suitable interpolator from the top. Therefore, in this case, the interpolator pushed later in the stack takes precedence.</p><p>The anonymous <code class="literal">interpolate()</code> function<a id="id269" class="indexterm"/> created on line <code class="literal">E</code> takes a single parameter <code class="literal">t</code> with a value ranging from <code class="literal">0</code> to <code class="literal">1</code> indicating how far off the interpolated value is from base <code class="literal">a</code>.</p><div class="informalexample"><pre class="programlisting">return function(t) {  // &lt;-E
          return "$" + f(a + b * t); // &lt;-F
        };</pre></div><p>You can think of it<a id="id270" class="indexterm"/> as a percentage of how far the desired value has traveled from <code class="literal">a</code> to <code class="literal">b</code>. With that in mind, it becomes clear that in line <code class="literal">F</code> it performs the interpolation and calculates the desired value based on the offset <code class="literal">t</code>, which effectively interpolates a price string.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip33"/>Tip</h3><p>One thing to watch out for here is that the <code class="literal">b</code> parameter's value has been changed on line <code class="literal">D</code> from the end of the range to the difference between <code class="literal">a</code> and <code class="literal">b</code>.</p><div class="informalexample"><pre class="programlisting">b = parseFloat(mb[1]) - a;  // &lt;-D</pre></div><p>This is generally considered a bad practice for readability. So, in your own implementations you should avoid modifying input parameters' value in a function.</p></div></div><p>On the line <code class="literal">G</code>, a second custom interpolator was registered to handle single-character lowercase alphabets from <code class="literal">a</code> to <code class="literal">z</code>:</p><div class="informalexample"><pre class="programlisting">d3.interpolators.push(function(a, b) { // &lt;-G
      var re = /^([a-z])$/, ma, mb; // &lt;-H
      if ((ma = re.exec(a)) &amp;&amp; (mb = re.exec(b))) { // &lt;-I
        a = a.charCodeAt(0);
        var delta = a - b.charCodeAt(0); // &lt;-J
        return function(t) { // &lt;-K
          return String.fromCharCode(Math.ceil(a - delta * t));
        };
      }
});</pre></div><p>We quickly noticed that this interpolator function follows a very similar pattern with the previous one. Firstly, it has a regex pattern defined on line <code class="literal">H</code> that matches single lowercase alphabets. After the matching is conducted on line <code class="literal">I</code>, the start and end of the range <code class="literal">a</code> and <code class="literal">b</code> were both converted from <code class="literal">character</code> values into <code class="literal">integer</code> values. A difference between <code class="literal">a</code> and <code class="literal">b</code> was calculated on line <code class="literal">J</code>. The interpolate function again follows exactly the same formula as the first interpolator as shown on line <code class="literal">K</code>.</p><p>Once these custom interpolators are registered with D3, we can define scales with corresponding ranges without doing any additional work and we will be able to interpolate their values:</p><div class="informalexample"><pre class="programlisting">var dollarScale = d3.scale.linear()
        .domain([0, 11])
        .range(["$0", "$300"]); // &lt;-L
            
var alphabetScale = d3.scale.linear()
        .domain([0, 27])
        .range(["a", "z"]); // &lt;-M</pre></div><p>As expected, the <code class="literal">dollarScale</code> function will automatically use the price interpolator, while the <code class="literal">alphabetScale</code> function will use our alphabet interpolator, respectively. No additional work is required when invoking the scale function to obtain the value we need, as demonstrated on line <code class="literal">N</code>:</p><div class="informalexample"><pre class="programlisting">.text(function(d,i){
  return scale(d);} // &lt;-N
); </pre></div><p>In isolation, <a id="id271" class="indexterm"/>custom interpolator does not appear to be a very important concept; however, later on when exploring other D3 concepts in <a class="link" href="ch06.html" title="Chapter 6. Transition with Style">Chapter 6</a>, <span class="emphasis"><em>Transition with Style</em></span>, we will explore more powerful techniques when custom interpolator is combined with other D3 constructs to achieve interesting custom effects.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec87"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If the regular expression used in this chapter is a new concept or a well-known tool in your toolbox and you need a little bit of dusting, you can find a lot of useful resources at <a class="ulink" href="http://www.regular-expressions.info">http://www.regular-expressions.info</a></li></ul></div></div></div></body></html>