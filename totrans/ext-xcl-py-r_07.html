<html><head></head><body>
		<div><h1 id="_idParaDest-127" class="chapter-number"><a id="_idTextAnchor145"/>7</h1>
			<h1 id="_idParaDest-128"><a id="_idTextAnchor146"/>Pivot Tables and Summary Tables</h1>
			<p>In the realm of data analysis and spreadsheet manipulation, a pivot table is a powerful tool that enables users to transform and summarize large datasets into more manageable and insightful formats. By providing an organized and dynamic way to analyze data, pivot tables have become an indispensable asset for professionals across various domains.</p>
			<p>So, what is a pivot table? A pivot table is a data processing<a id="_idIndexMarker521"/> technique employed in spreadsheet software, such as Microsoft Excel or Google Sheets, to analyze and extract meaningful insights from complex datasets. It allows users to restructure and condense large amounts of information into a concise, comprehensible format, facilitating better decision-making and data exploration.</p>
			<p>In the world of data analysis, pivot tables stand as versatile tools that empower users to transform raw data into actionable insights. By organizing, summarizing, and presenting data in a user-friendly format, pivot tables streamline decision-making processes and promote a deeper understanding of complex datasets. Their adaptability, interactivity, and simplicity make them an invaluable asset across diverse industries and analytical tasks.</p>
			<p>In this chapter, we will cover the following topics:</p>
			<ul>
				<li>Making a table with the Base R <code>xtabs</code> function</li>
				<li>Making a table with the <code>gt</code> package</li>
				<li>Creating pivot tables with <code>tidyquant</code></li>
				<li>Creating and managing pivot tables in Python with <code>win32com</code> and <code>pypiwin32</code></li>
				<li>Creating pivot tables with Python basics</li>
			</ul>
			<h1 id="_idParaDest-129"><a id="_idTextAnchor147"/>Technical requirements</h1>
			<p>For this chapter, you will be able to find the code used at the following link:  <a href="https://github.com/PacktPublishing/Extending-Excel-with-Python-and-R/tree/main/Chapter7">https://github.com/PacktPublishing/Extending-Excel-with-Python-and-R/tree/main/Chapter7</a>.</p>
			<p>Some of the packages that will be covered for the R language are as follows:</p>
			<ul>
				<li><code>tidyquant &gt;= </code><code>1.0.6</code></li>
				<li><code>gt &gt;- </code><code>0.10.0</code></li>
			</ul>
			<h1 id="_idParaDest-130"><a id="_idTextAnchor148"/>Making a table with the Base R xtabs function</h1>
			<p>Before we move onto the core of the topic, let us understand a few of the important components.</p>
			<p>Here is a list of some key components of a pivot table:</p>
			<ul>
				<li><strong class="bold">Rows and columns</strong>: Pivot tables typically involve<a id="_idIndexMarker522"/> two primary components – rows and columns. The data rows contain individual records or observations, while the columns contain the attributes or variables that define those records.</li>
				<li><strong class="bold">Values</strong>: Pivot tables allow users to aggregate and summarize data by calculating values based on specific metrics, such as sum, average, count, or percentage.</li>
				<li><strong class="bold">Filters and slicers</strong>: Filters and slicers enable users to focus on specific subsets of data within the pivot table, enhancing the granularity of analysis. These tools are especially useful when dealing with large datasets.</li>
				<li><strong class="bold">Row and column labels</strong>: Pivot tables allow users to drag and drop attributes into row and column labels, defining the layout and structure of the table dynamically.</li>
			</ul>
			<p>The core functionality of a pivot table<a id="_idIndexMarker523"/> revolves around rearranging<a id="_idIndexMarker524"/> and summarizing data based on user-defined criteria. By “pivoting” the data, the table generates a multidimensional summary, providing insights that might not be readily apparent in the original dataset. The following details<a id="_idIndexMarker525"/> how a pivot table works:</p>
			<ul>
				<li><strong class="bold">Selection</strong>: Users select the dataset they want to analyze and identify the columns containing the relevant attributes and metrics.</li>
				<li><strong class="bold">Arrangement</strong>: Users place these attributes and metrics into specific areas of the pivot table layout, such as rows, columns, values, and filters.</li>
				<li><strong class="bold">Calculation</strong>: Pivot tables automatically calculate the specified metrics for various combinations of the chosen attributes. For instance, it can show the total sales amount for each product category in different regions.</li>
				<li><strong class="bold">Interactivity</strong>: Pivot tables are interactive; users can easily modify the layout by dragging and dropping attributes, allowing real-time exploration of the data.</li>
			</ul>
			<p>Pivot tables offer several advantages<a id="_idIndexMarker526"/> that make them indispensable tools for data analysis:</p>
			<ul>
				<li><strong class="bold">Data summarization</strong>: Pivot tables allow quick and effective summarization of data, helping users understand patterns, trends, and anomalies within large datasets</li>
				<li><strong class="bold">Quick insights</strong>: Users can swiftly generate insights without the need for complex coding or intricate formulas</li>
				<li><strong class="bold">Flexible analysis</strong>: Pivot tables enable users to experiment with different perspectives by rearranging attributes, thereby aiding in the identification of correlations and trends</li>
				<li><strong class="bold">Report generation</strong>: Pivot tables are pivotal (pun intended) in creating comprehensive and informative reports, dashboards, and visualizations</li>
				<li><strong class="bold">Data cleaning</strong>: Before analyzing data, pivot tables can be employed to identify missing values, outliers, or inconsistencies</li>
			</ul>
			<p>The <code>xtabs()</code> function in R is used<a id="_idIndexMarker527"/> to create a contingency<a id="_idIndexMarker528"/> table from factor columns in a data frame. You would use this function with the familiar formula input: <code>x ~ y</code>. A contingency table is a table that displays the frequency distribution of two or more categorical variables. In this case, we will<a id="_idIndexMarker529"/> use the <code>UCBAdmissions</code> dataset to demonstrate<a id="_idIndexMarker530"/> how to use the <code>xtabs()</code> function.</p>
			<p>The syntax for the <code>xtabs()</code> function is as follows:</p>
			<pre class="source-code">
xtabs(formula, data, subset, sparse, na.action, addNA, exclude, drop.unused.levels)</pre>			<p>The meaning of each is as follows:</p>
			<ul>
				<li><code>formula</code>: A formula object with the cross-classifying variables (separated by ~)</li>
				<li><code>data</code>: A data frame containing the variables in the formula</li>
				<li><code>subset</code>: An optional expression specifying a subset of observations to be used</li>
				<li><code>sparse</code>: A logical value indicating whether to return a sparse matrix</li>
				<li><code>na.action</code>: A function to handle missing values</li>
				<li><code>addNA</code>: A logical value indicating whether to add a row and column for missing values</li>
				<li><code>exclude</code>: A vector of values to exclude from the table</li>
				<li><code>drop.unused.levels</code>: A logical value indicating whether to drop unused factor levels</li>
			</ul>
			<p>To use the <code>xtabs()</code> function with the <code>UCBAdmissions</code> dataset, we first need to convert it to a data frame using the <code>as.data.frame()</code> function. The <code>UCBAdmissions</code> dataset contains the number of male and female applicants and the number of male and female applicants who were admitted or rejected. We can use the <code>xtabs()</code> function to create a contingency table that displays the frequency distribution of gender and admission status. Here is the code for it:</p>
			<pre class="source-code">
# Convert the dataset to a data frame
df &lt;- as.data.frame(UCBAdmissions)
# Create a contingency table using xtabs()
xtabs(Freq ~ Gender + Admit, df)
        Admit
Gender   Admitted Rejected
  Male       1198     1493
  Female      557     1278</pre>			<p>The output of the <code>xtabs()</code> function will be a table that displays the frequency distribution of gender and admission status. The rows represent the gender, and the columns represent the admission status. The values in the table represent the frequency of each combination of gender and admission status.</p>
			<p>In summary, the syntax for the <code>xtabs()</code> function includes several arguments that allow for customization of the output. To use the <code>xtabs()</code> function with the <code>UCBAdmissions</code> dataset, we first need to convert it to a data frame using the <code>as.data.frame()</code> function. We can then use the <code>xtabs()</code> function to create a contingency table that displays the frequency<a id="_idIndexMarker531"/> distribution of gender <a id="_idIndexMarker532"/>and admission status.</p>
			<p>Now that we have produced a contingency table in base R, we can move on to the <code>gt</code> package, which will allow us to make something we are more familiar with: a pivot table, as we have come to know it.</p>
			<h1 id="_idParaDest-131"><a id="_idTextAnchor149"/>Making a table with the gt package</h1>
			<p>The <code>gt</code> package in R allows users to create<a id="_idIndexMarker533"/> beautiful and customizable<a id="_idIndexMarker534"/> tables in R. One of the main pros of the <code>gt</code> package is its ease of use. The package is designed to be user-friendly, with a simple syntax that makes it easy to create tables quickly. Additionally, the package offers a wide range of customization options, allowing users to create tables that are tailored to their specific needs.</p>
			<p>Another pro of the <code>gt</code> package is its ability to handle large datasets. The package is optimized for performance, which means that it can handle large datasets without slowing down. This is particularly useful for users who need to create tables from large datasets, as it allows them to do so quickly and efficiently.</p>
			<p>The <code>gt</code> package also offers a wide range of styling options, allowing users to create tables that are visually appealing and easy to read. Users can customize the fonts, colors, and formatting of their tables, making it easy to create tables that match their branding or design preferences.</p>
			<p>Finally, the <code>gt</code> package is open source, which means that it is constantly being updated and improved by the R community. This ensures that the package remains up to date and relevant, with new features and improvements being added regularly.</p>
			<p>In summary, the <code>gt</code> package<a id="_idIndexMarker535"/> is a powerful tool for creating tables<a id="_idIndexMarker536"/> in R. Its ease of use, performance, customization options, and open source nature make it a popular choice among R users who need to create tables quickly and efficiently. Let’s check out an example using the <code>gt</code> package with the <code>mtcars</code> dataset.</p>
			<p>In this section, we are checking whether the <code>gt</code> package is installed. If it’s not installed, we use the <code>install.packages</code> function to install it. The <code>gt</code> package is a package for creating nicely formatted tables in R:</p>
			<pre class="source-code">
# The gt package
if (!require(gt)) {
  install.packages("gt", dependencies = TRUE)
}</pre>			<p>Here, we are loading two additional packages: <code>dplyr</code> and <code>tibble</code>. These packages provide useful functions and data structures for data manipulation and analysis in R:</p>
			<pre class="source-code">
library(dplyr)
library(tibble)</pre>			<p>In this section, we are performing several operations on the <code>mtcars</code> dataset:</p>
			<pre class="source-code">
tab &lt;- mtcars |&gt;
  rownames_to_column() |&gt;
  arrange(factor(cyl), mpg) |&gt;
  group_by(cyl) |&gt;
  slice(1:3) |&gt;
  gt()</pre>			<p>The operations are as follows:</p>
			<ul>
				<li><code>rownames_to_column()</code>: We are converting the row names of the dataset into a regular column so that we can work with it. This is a function from the <code>tibble</code> package.</li>
				<li><code>arrange(factor(cyl), mpg)</code>: We are sorting the dataset first by the <code>cyl</code> column in ascending order and then by the <code>mpg</code> column in ascending order. This, along with <code>group_by</code> and <code>slice</code>, is a function from <code>dplyr</code>.</li>
				<li><code>group_by(cyl)</code>: We are grouping the dataset by the <code>cyl</code> column.</li>
				<li><code>slice(1:3)</code>: We are selecting the first three rows within each group.</li>
				<li><code>gt()</code>: We are creating a table using the <code>gt</code> package to display the resulting data.</li>
			</ul>
			<p>In this next section, we are<a id="_idIndexMarker537"/> adding a <code>Performance</code> spanner (a label for a group of columns) to the<a id="_idIndexMarker538"/> table. We specify the columns we want to include under this spanner: <code>mpg</code>, <code>disp</code>, <code>hp</code>, <code>drat</code>, <code>wt</code>, and <code>qsec</code>. These columns are related to the performance of the cars:</p>
			<pre class="source-code">
tab &lt;- tab |&gt;
  tab_spanner(
    label = "Performance",
    columns = c(mpg, disp, hp, drat, wt, qsec)
  )</pre>			<p>Similarly, in this section, we are adding a <code>Specs</code> spanner to the table, and we specify the columns to be included under this spanner: <code>vs</code>, <code>am</code>, <code>gear</code>, and <code>carb</code>. These columns contain specification information about the cars:</p>
			<pre class="source-code">
tab &lt;- tab |&gt;
  tab_spanner(
    label = "Specs",
    columns = c(vs, am, gear, carb)
  )</pre>			<p>In the final section, we are setting the table header with a title and subtitle. The title is <code>The Cars of mtcars</code> with some Markdown formatting, and the subtitle is <code>These are some </code><code>fine automobiles</code>:</p>
			<pre class="source-code">
tab &lt;- tab |&gt;
  tab_header(
    title = md("The Cars of **mtcars**"),
    subtitle = "These are some fine automobiles"
  )
tab</pre>			<p>So, in summary, this R code<a id="_idIndexMarker539"/> loads the necessary packages, manipulates<a id="_idIndexMarker540"/> the <code>mtcars</code> dataset to create a customized table with performance and specification information, and sets a header for the table. Now that we have gone through all of the code, let’s see the output of it all. If you want to do this on your own, just call up the tab in the console. The table appears as follows:</p>
			<div><div><img src="img/B19142_7_01.jpg" alt="Figure 7.1 – mtcars and the gt package"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.1 – mtcars and the gt package</p>
			<p>Now that we have seen how<a id="_idIndexMarker541"/> to create a pivot table with the <code>gt</code> package by creating<a id="_idIndexMarker542"/> different spanners and headers, we can move on to the <code>tidyquant</code> package, which will give users an even more familiar feeling when creating pivot tables in R.</p>
			<h1 id="_idParaDest-132"><a id="_idTextAnchor150"/>Creating pivot tables with tidyquant</h1>
			<p>The <code>pivot_table()</code> function<a id="_idIndexMarker543"/> from the <code>tidyquant</code> library is a useful tool<a id="_idIndexMarker544"/> for creating summary tables from<a id="_idIndexMarker545"/> data frames in R. It allows you to specify the rows, columns, values, and aggregation functions for your table and to employ other options such as sorting, formatting, and filtering.</p>
			<p>To use the <code>pivot_table()</code> function, you need to load the <code>tidyquant</code> library first by using the <code>library(tidyquant)</code> command. Then, you can pass your data frame as the first argument to the function, followed by the other arguments that define your table. For example, if you want to create a table that shows the average sepal length and sepal width of different iris species, you can use the following code:</p>
			<pre class="source-code">
# Load the tidyquant library
library(tidyquant)
library(purrr)
# Create a pivot table
pivot_table(.data = iris,
            .rows = ~ Species,
            .values = c(~ mean(Sepal.Length),
                   ~ mean(Sepal.Width))) |&gt;
set_names("Species","Mean_Sepal_Length","Mean_Sepal_Width")</pre>			<p>The output<a id="_idIndexMarker546"/> of this code<a id="_idIndexMarker547"/> is as follows:</p>
			<pre class="source-code">
# A tibble: 3 × 3
  Species    Mean_Sepal_Length Mean_Sepal_Width
  &lt;fct&gt;                  &lt;dbl&gt;            &lt;dbl&gt;
1 setosa                  5.01             3.43
2 versicolor              5.94             2.77
3 virginica               6.59             2.97</pre>			<p>Here’s a breakdown of the code in simple terms:</p>
			<ul>
				<li><code>tidyquant</code> and <code>purrr</code>. These libraries provide functions and tools for data manipulation and analysis.</li>
				<li><code>pivot_table</code> function is used to reshape the data in the iris dataset. It takes three main arguments:<ul><li><code>.data</code>: This is the dataset you want to work with, which in this case is the iris dataset.</li><li><code>.rows</code>: This specifies how you want to group or categorize your data. In this code, it groups the data by the <code>Species</code> column, which represents different species of iris flowers.</li><li><code>.values</code>: This argument specifies which columns you want to calculate and display values for. Here, it calculates the mean (average) of two columns – <code>Sepal.Length</code> and <code>Sepal.Width</code> – for each species.</li></ul></li>
				<li><code>set_names</code> function is used to rename the columns of the resulting table. The names are set to <code>Species</code>, <code>Mean_Sepal_Length</code>, and <code>Mean_Sepal_Width</code>.</li>
			</ul>
			<p>So, in summary, this code<a id="_idIndexMarker548"/> takes the iris dataset, groups it by species, calculates <a id="_idIndexMarker549"/>the mean sepal length and mean sepal width for each species, and then renames the resulting table’s columns to make it more understandable. The result is a new table that shows the mean sepal length and mean sepal width for each species of iris flower. </p>
			<p>Now that we have gone over the material in R, let’s move on to Python!</p>
			<h1 id="_idParaDest-133"><a id="_idTextAnchor151"/>Creating and managing pivot tables in Python with win32com and pypiwin32</h1>
			<p>Pivot tables are powerful<a id="_idIndexMarker550"/> tools in data analysis, allowing<a id="_idIndexMarker551"/> you to summarize and explore large datasets quickly and efficiently. While<a id="_idIndexMarker552"/> they are a staple feature in spreadsheet <a id="_idIndexMarker553"/>software such as Microsoft Excel, you can<a id="_idIndexMarker554"/> also create and<a id="_idIndexMarker555"/> manipulate pivot tables programmatically using Python. In this section of the chapter, we will delve into the world of pivot tables and learn how to harness their potential with the <code>win32com</code> and <code>pywin32</code> libraries.</p>
			<h1 id="_idParaDest-134"><a id="_idTextAnchor152"/>Creating pivot tables with Python: the basics</h1>
			<p>Pivot tables are an indispensable<a id="_idIndexMarker556"/> tool in the world of data analysis. They provide a dynamic way to summarize, explore, and gain insights from complex datasets. However, when dealing with extensive data, setting up and customizing pivot tables can be a time-consuming and error-prone process, often requiring manual intervention.</p>
			<p>In this chapter, we’ll explore how Python, in combination with the <code>win32com</code> and <code>pywin32</code> libraries, can streamline and automate the creation and management of pivot tables. This powerful combination empowers data analysts and professionals to efficiently process large volumes of data without the need for repetitive, manual tasks.</p>
			<p>Imagine being able to create pivot tables, apply advanced calculations, and refresh data with just a few lines of Python code. This is precisely what we aim to achieve in this section. We’ll equip you with the knowledge and tools to harness the full potential of pivot tables while eliminating the tedious aspects of manual setup.</p>
			<h2 id="_idParaDest-135"><a id="_idTextAnchor153"/>Setting up the Python environment</h2>
			<p>Before we dive into creating pivot<a id="_idIndexMarker557"/> tables, you need to set up your Python environment with the required libraries. <code>win32com</code> and <code>pywin32</code> are essential for interacting with Microsoft Excel, so ensure they are installed on your system. We have covered the installation process in <a href="B19142_03.xhtml#_idTextAnchor055"><em class="italic">Chapter 3</em></a> and have provided a basic example of how to connect Python with Excel. See the <em class="italic">Integrating VBA with Python using pywin32</em> section for details, in particular, the <em class="italic">Setting up the environment subsection</em>. Please refer to that chapter if you have not set <code>pywin32</code> up yet.</p>
			<h2 id="_idParaDest-136"><a id="_idTextAnchor154"/>Creating pivot tables</h2>
			<p>The foundation of working<a id="_idIndexMarker558"/> with pivot tables is, of course, creating them. We’ll start with the basics, teaching you how to build pivot tables from scratch. The following is a step-by-step guide to help you get started:</p>
			<ol>
				<li><strong class="bold">Connecting to Excel</strong>: Create an instance of Excel and open a workbook. If the workbook doesn’t exist, you can create a new one as follows:<pre class="source-code">
import win32com.client as win32
# Create an Excel workbook and add a sheet
excel = win32.gencache.EnsureDispatch('Excel.Application')
workbook = excel.Workbooks.Add()
worksheet = workbook.Worksheets(1)</pre></li>				<li><strong class="bold">Adding data to the worksheet</strong>: You’ll need data to create a pivot table. Usually, that data is already<a id="_idIndexMarker559"/> there, but for the purposes of this example, you can add sample data to the worksheet as follows:<pre class="source-code">
worksheet.Cells(1, 1).Value = 'Name'
worksheet.Cells(1, 2).Value = 'Category'
worksheet.Cells(1, 3).Value = 'Sales'
worksheet.Cells(2, 1).Value = 'John'
worksheet.Cells(2, 2).Value = 'Electronics'
worksheet.Cells(2, 3).Value = 1000
worksheet.Cells(3, 1).Value = 'Alice'
worksheet.Cells(3, 2).Value = 'Clothing'
worksheet.Cells(3, 3).Value = 800
worksheet.Cells(4, 1).Value = 'John'
worksheet.Cells(4, 2).Value = 'Clothing'
worksheet.Cells(4, 3).Value = 300
# Add more data as needed</pre></li>				<li><strong class="bold">Selecting the data range</strong>: Define the data range that you want to use for your pivot table. You can do this by specifying the start and end cells of your data:<pre class="source-code">
data_range = worksheet.Range('A1:C4')  # Adjust the range as needed</pre></li>				<li><strong class="bold">Creating the pivot table</strong>: Now, you can create the pivot table based on the selected data range. Specify where<a id="_idIndexMarker560"/> you want the pivot table to be located and  which columns should be used for rows, columns, and values in your pivot table:<pre class="source-code">
# Add a new worksheet to the workbook to hold the Pivot Table:
pivot_table_sheet = workbook.Worksheets.Add()
pivot_table_sheet.Name = 'Pivot Table'
# Create a Pivot Cache using the data range:
pivot_cache = workbook.PivotCaches().Create(SourceType=1, SourceData=data_range)
# Create the Pivot Table on the new sheet using the Pivot Cache:
pivot_table = pivot_cache.CreatePivotTable(
    TableDestination=pivot_table_sheet.Cells(3, 1),
    TableName='MyPivotTable')
# Add the row, column and data fields
pivot_table.PivotFields('Name').Orientation = 1 # row field
pivot_table.PivotFields('Category').Orientation = 2 # column field
pivot_table.PivotFields('Sales').Orientation = 4 # data field
# Add the calculated fields
calculated_field = pivot_table.CalculatedFields().Add(
    "Total Sales", "=SUM(Sales)")
# Refresh the PivotTable to apply changes
pivot_table.RefreshTable()</pre><p class="list-inset">In this example, the <code>SourceType</code> parameter specifies the type of data source for <code>PivotTable</code>. In this case, <code>SourceType = 1</code> indicates that the data source is an Excel<a id="_idIndexMarker561"/> spreadsheet. The <code>SourceType</code> parameter can take on one of the following values (or a number between one and three representing them):</p><ul><li><code>xlDatabase</code>: This indicates that the data source is an Excel spreadsheet or an external database. It is the most common type of data source for pivot tables.</li><li><code>xlExternal</code>: This indicates that the data source is an OLAP cube or an external data source that is not directly accessible from Excel.</li><li><code>xlConsolidation</code>: This indicates that the data source is a consolidation. A consolidation is a pivot table that aggregates data from multiple worksheets or workbooks.</li></ul></li>				<li><strong class="bold">Save the workbook and close Excel</strong>: Don’t forget to save your Excel workbook with the newly created pivot table:<pre class="source-code">
workbook.SaveAs('PivotTableExample.xlsx')
workbook.Close()
excel.Quit()</pre><p class="list-inset">When saving the Excel sheet, you can provide a full path if you don’t want to save the spreadsheet to the Python working directory.</p></li>			</ol>
			<p>That’s it! You’ve created a pivot table using <code>pywin32</code> in Python. You can<a id="_idIndexMarker562"/> adjust the data, pivot table location, and formatting options to suit your specific needs.</p>
			<p>Now that you have a basic pivot table ready, let’s have a look at how to change one to fit your needs the best.</p>
			<h2 id="_idParaDest-137"><a id="_idTextAnchor155"/>Manipulating pivot tables</h2>
			<p>Once you have your pivot tables, you may<a id="_idIndexMarker563"/> want to perform various operations on them, such as filtering, sorting, and refreshing data. Here are the steps for it:</p>
			<ol>
				<li>First, open the Excel file from the previous section and select the pivot table created:<pre class="source-code">
import win32com.client as win32
# Connect to Excel
excel = win32.gencache.EnsureDispatch('Excel.Application')
# Open the workbook with the pivot table
workbook = excel.Workbooks.Open('PivotTableExample.xlsx')  # Replace with your workbook path
worksheet = workbook.Worksheets(1)
# Access the Pivot Table
pivot_table = worksheet.PivotTables('MyPivotTable')  # Use the name of your pivot table</pre></li>				<li>You can filter the data<a id="_idIndexMarker564"/> within the pivot table based on values. In this example, we’ll filter the <code>Category</code> field to show only <code>Electronics</code>:<pre class="source-code">
# Filter by value (need to make the field a Page field instaed of a column field)
category_field = pivot_table.PivotFields('Category')
category_field.Orientation = 3 # page field
category_field.CurrentPage = "Electronics"</pre></li>				<li>You may have to sort rows or columns within the pivot table. In this example, we’ll sort the <code>Name</code> field in ascending order:<pre class="source-code">
# Sort Rows or Columns
name_field = pivot_table.PivotFields('Name')
name_field.AutoSort(1, "Name")</pre></li>				<li>If your source data has changed, you can refresh the pivot table to update it:<pre class="source-code">
# Define the new source data range
new_source_data_range = 'Sheet1!A1:C2'
# Update the SourceData property of the pivot table's Table object
pivot_table.TableRange2(workbook.Sheets('Sheet1').Range(
    new_source_data_range))
# Refresh data
pivot_table.RefreshTable()</pre></li>				<li>After manipulating the pivot table, save your changes and close the workbook:<pre class="source-code">
workbook.Save()
workbook.Close()
excel.Quit()</pre></li>			</ol>
			<p class="callout-heading">Note</p>
			<p class="callout">Do not have the spreadsheet open (in Excel) while accessing or manipulating it from Python as it leads to <code>com_errors</code> instances that are difficult to debug.</p>
			<p>These steps should help you get started with manipulating pivot tables using <code>pywin32</code>. You can adjust the filters, sorting criteria, and refresh frequency to meet your specific requirements and automate various tasks involving pivot tables.</p>
			<p>Once your pivot table is set up<a id="_idIndexMarker565"/> as you want it, you may need to enhance it further by grouping some (or all) of your categories to better reflect the information you are trying to convey. In the next subsection, we go into the details of how to do just that.</p>
			<h2 id="_idParaDest-138"><a id="_idTextAnchor156"/>Groupings in pivot tables</h2>
			<p>Grouping data in a pivot table<a id="_idIndexMarker566"/> can help you create a more organized and insightful view of your dataset. You can group data by specific criteria, such as date ranges, numeric intervals, or custom categories. In this section, we’ll explore how to apply groupings to your pivot tables using Python with the <code>pywin32</code> library.</p>
			<h3>Creating date groupings</h3>
			<p>One common use case for grouping<a id="_idIndexMarker567"/> is aggregating data by date ranges. For example, you might want to group sales data into monthly or quarterly intervals. To do this, you can create date groupings within your pivot table.</p>
			<p>We will start by generating some sample data:</p>
			<pre class="source-code">
# Sample Data Generation
import pandas as pd
import random
from datetime import datetime, timedelta
import win32com.client as win32
import os
import numpy as np
data = {
    'Date': [datetime(2023, 1, 1) + timedelta(days=i) for i in range(365)],
    'Sales': [random.randint(100, 1000) for _ in range(365)]
}
df = pd.DataFrame(data)
# Create an ExcelWriter object and write the DataFrame to the Excel worksheet
df.to_excel("GroupingExample.xlsx", sheet_name='Sheet1', index=False)</pre>			<p>With the data saved in an Excel sheet (in the Python working directory by default but can be specified otherwise), we can follow the usual steps of opening the Excel sheet, adding a dedicated tab for the pivot table, and creating the pivot table. The steps that have been covered before are omitted<a id="_idIndexMarker568"/> here (but are available in GitHub). The steps are as follows:</p>
			<pre class="source-code">
# Connect to Excel
# Open the Excel workbook and add a sheet
# Add a new worksheet to the workbook to hold the Pivot Table:
# Define the range of data to be used as input for the pivot table
# Create a Pivot Cache using the data range:
# Create the Pivot Table on the new sheet using the Pivot Cache:
# Add the 'Date' field to Rows and define the date_field variable as done with name_field in the example above.
# Add the calculated fields
calculated_field = pivot_table.CalculatedFields().Add("Total Sales", "=SUM(Sales)")
# Group by months
date_field.Subtotals = [False]*12
date_field.NumberFormat = 'MMMM YYYY'
# Sort Rows
date_field.AutoSort(1, "Date")</pre>			<p>In this example, we created a pivot table<a id="_idIndexMarker569"/> and added the <code>Date</code> field to the rows and a calculated field for <code>Total Sales</code>. We then specified that we wanted to format the dates in the month-year format. Finally, the formatted dates were sorted.</p>
			<p>To add a grouped field to the pivot table, we will need to know which values belong together (note, the values have been formatted to not display the exact days, but they still differ):</p>
			<pre class="source-code">
# count the unique values for each value of the date column in the pivot
date_values = pd.DataFrame([item.Value for item in date_field.PivotItems()], columns = ['date'])
unique_values = pd.DataFrame(np.transpose(np.unique(date_values, return_counts=True)), columns=['date', 'count'])
date_values_count = date_values.merge(unique_values).drop_duplicates()
# Group by months
# Set the GroupOn property
date_range = pivot_table_sheet.Range(f"A4:A{starting_row + date_values_count['count'].iloc[0]}")
date_range.Group()
# You can use the above method to group the other months as well if you want to
# Note: the pivot is now changed, the second group starts at row starting_row + 2, instead of starting_row + 32</pre>			<p>This has created a grouped pivot field, called <code>Date2</code>. In the <code>Date2</code> field, the days belonging to January are grouped to the <code>Group1value</code>, while the other dates are grouped into groups consisting of a single date. Using the preceding example, you can now loop over the other unique values of month-year dates and group the other dates as well. Notice that the calculated field of <code>Total Sales</code> is now calculated over the groups.</p>
			<p>To finish, we change the format<a id="_idIndexMarker570"/> of the new grouped field to the month-year format, change back the raw data in the <code>Date</code> field to display the full date, and hide the details of the groups for clarity. Finally, the pivot table is refreshed, and the Excel file is saved and closed:</p>
			<pre class="source-code">
# change the formatting of the grouped column to show only month and year and change back the original date column to show the full date
# change the formatting of the grouped column to show only month and year and change back the original date column to show the full date
pivot_table.PivotFields('Date2').NumberFormat = 'MMMM YYYY'
date_field.NumberFormat = 'DD MMMM YYYY'
# hide the details of the grouped values
for item in pivot_table.PivotFields('Date2').PivotItems():
    item.ShowDetail = False
# Refresh data
pivot_table.RefreshTable()
#pivot_table.PivotFields('Date2').Orientation = 2
# Save and close
workbook.Save()
workbook.Close()
excel.Quit()</pre>			<p>This is just an example of how you can use groupings in pivot tables to analyze your data more effectively. Depending on your dataset and analysis goals, you can customize the groupings to fit your specific needs.</p>
			<p>This section has covered the steps<a id="_idIndexMarker571"/> you need to create and manipulate pivot tables directly from Python. We have covered inserting a pivot table into an Excel sheet and adding the various types of fields a pivot table needs as the basics. Then, we went into the more complex areas of calculated fields, formatting, and finally, grouping values. With the skills you learned from this section, you can now create the perfect pivot table for your analysis without opening Excel!</p>
			<h1 id="_idParaDest-139"><a id="_idTextAnchor157"/>Summary</h1>
			<p>In this chapter, we embarked on a journey to harness the power of pivot tables through the capabilities of R and Python. Pivot tables – indispensable tools in data analysis – offer a dynamic means of summarizing and exploring vast datasets. By mastering the techniques outlined in this chapter, you’ve unlocked the full potential of pivot tables, enabling you to automate their creation, manipulation, and enhancement.</p>
			<p>We began by introducing the significance of pivot tables in data analysis and established a foundation for our exploration. With a focus on practicality, we guided you through the installation of essential libraries, ensuring that your R or Python environment is well prepared to tackle the intricacies of Excel.</p>
			<p>Building pivot tables from scratch was our first venture, providing you with the fundamental knowledge to select data sources, arrange rows and columns, and customize the table’s appearance. We left no stone unturned in demystifying the creation process.</p>
			<p>Manipulating pivot tables opened a world of possibilities. You learned how to filter, sort, and refresh your data dynamically, which equipped you with the skills to tailor pivot tables to your evolving needs.</p>
			<p>Furthermore, we explored advanced pivot table features such as calculated fields and grouping, showcasing the versatility and depth of your newfound expertise. These advanced techniques serve as valuable tools for gaining deeper insights into your data and enhancing your analytical capabilities.</p>
			<p>In conclusion, your journey through pivot tables in R and Python has equipped you with a comprehensive skill set to tackle data analysis challenges efficiently and effectively. Armed with this knowledge, you can transform data into actionable insights, streamline your workflow, and make data-driven decisions with confidence. The ability to automate and manipulate pivot tables through R and Python is a valuable asset in today’s data-driven world, and you are now well prepared to harness this power to its fullest extent.</p>
			<p>In the next chapter, we will understand how <strong class="bold">exploratory data analysis</strong> (<strong class="bold">EDA</strong>) works for data analysis.</p>
		</div>
	

		<div><h1 id="_idParaDest-140" lang="en-US" xml:lang="en-US"><a id="_idTextAnchor158"/>Part 3: EDA, Statistical Analysis, and Time Series Analysis</h1>
		</div>
		<div><p>Dive into the world of <strong class="bold">exploratory data analysis</strong> (<strong class="bold">EDA</strong>) with R and Python, uncovering insights and patterns in your Excel data. Explore the fundamentals of statistical analysis, including linear and logistic regression techniques. Delve into the realm of time series analysis, mastering statistics, plots, and forecasting methods to gain valuable insights into temporal data trends and patterns.</p>
			<p>This part has the following chapters:</p>
			<ul>
				<li><a href="B19142_08.xhtml#_idTextAnchor159"><em class="italic">Chapter 8</em></a>, <em class="italic">Exploratory Data Analysis with R and Python</em></li>
				<li><a href="B19142_09.xhtml#_idTextAnchor178"><em class="italic">Chapter 9</em></a>, <em class="italic">Statistical Analysis: Linear and Logistic Regression</em></li>
				<li><a href="B19142_10.xhtml#_idTextAnchor194"><em class="italic">Chapter 10</em></a>, <em class="italic">Time Series Analysis: Statistics, Plots, and Forecasting</em></li>
			</ul>
		</div>
		<div><div></div>
		</div>
		<div><div></div>
		</div>
	</body></html>