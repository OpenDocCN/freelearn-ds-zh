# 第一章. 处理您的数据

在本章中，我们将准备所有必要的工具和数据，以便对空间现象进行视觉探索、制图和分析。在了解 QGIS 作为桌面 GIS 的基础知识之后，您将学习如何安装和配置它。然后，我们将介绍最常见的数据源，并在最后将它们聚合到一个单一的空间数据库中，该数据库将在后续章节中用于样式、制图和分析。

在本章中，我们将讨论以下主题：

+   QGIS 安装

+   图形用户界面 (GUI)，其元素及其定制

+   从常见来源加载各种类型的空间数据

+   投影的基本知识

+   将数据组装成单一的空间数据库

# 安装 QGIS

QGIS 是一个免费的开放源代码桌面 GIS，其开发始于 2002 年。自 2007 年以来，该项目在 **开源地理空间基金会** (**OSGeo**) 的支持下发展。作为一个相对较新的项目，QGIS 由于以下原因在全世界个人用户、私营公司和组织中越来越受欢迎：

+   根据 GNU **通用公共许可证** (**GPL**) 进行分发，该许可证确保用户有权使用、学习、分享和修改软件

+   跨平台支持，这意味着 QGIS 可以在 Linux、Unix、Mac OS、Windows 和 Android 操作系统上运行

+   多种矢量、栅格数据格式支持，以及数据库格式和功能

+   核心功能的持续改进，包括数据创建、编辑、处理、分析、存储和可视化表示

+   来自国际开发者社区支持的所谓插件的可用外部功能的持续增长

    ### 注意

    您可以从 QGIS 的官方网站 [`qgis.org/`](http://qgis.org/) 以及其文档章节 [`documentation.qgis.org/`](http://documentation.qgis.org/) 获取更多关于 QGIS 的信息。

根据 QGIS 项目的发布计划，每 4 个月就有一个新的 QGIS 版本可用。从 QGIS 2.8 开始，每第三个发布版本都是一个长期发布 (LTR)。它将维护一年，然后下一个 LTR 发生。在整个本书中，使用了一个名为 "Wein" 的 QGIS 2.8 LTR 版本。

当前 QGIS 版本的安装程序可以从官方网站的下载页面 [`download.qgis.org`](http://download.qgis.org) 获取，适用于不同的操作系统。MS Windows 的 32 位和 64 位安装文件如下分发：

+   **QGIS 独立安装程序**：使用这些安装程序安装 QGIS 与 Windows 下的传统软件安装程序没有区别

+   **OSGeo4W 网络安装程序**：与独立安装程序相比，它具有以下优点：

    +   除了 QGIS 之外，它还允许我们安装大量其他软件包以处理空间数据（命令行工具、库和桌面及服务器应用程序）

    +   它确保安装最新版本的软件，这些版本直接链接到不断更新的仓库

    +   一旦定义，OSGeo4W 工作环境方便用于自动和及时的更新、添加软件包或删除软件包

让我们以最新 32 位版本为例，通过 OSGeo4W 安装程序来了解 QGIS 及其组件的安装过程。由于安装（尤其是初级）需要下载大量文件，因此拥有高速互联网连接是理想的。安装过程如下：

1.  下载 OSGeo4W 32 位网络安装程序的最新版本，双击 `osgeo4w-setup-x86.exe` 以运行安装。

1.  在安装程序窗口中，选择 **高级安装**，如下面的截图所示。从现在起，只需仔细阅读并遵循说明。![安装 QGIS](img/image00266.jpeg)

1.  选择 **从互联网安装**，并保留下载的文件以供将来重用。

1.  选择 OSGeo4W 软件套件的安装目录。`C:\OSGeo4W` 是一个常见且方便的选择。如果您想使用另一个目录，请给它一个合适的名称，路径要短，不要包含空格和特殊符号。

1.  然后，选择一个目录来保存下载的软件包。您可以通过手动输入其名称来创建一个新目录，例如 `C:\OSGeo4W\Downloads`。请记住，要下载的文件量大约为 200 MB，您需要足够的空间来保存它们。

1.  如果有，配置您的互联网连接参数，然后点击 **下一步** 按钮继续。点击 **下一步** 按钮后，将下载所有软件包的列表，并进入软件包选择模式，如下面的截图所示。可用的软件包分为以下类别：**命令行工具**、**桌面**、**库**和**网络**。![安装 QGIS](img/image00267.jpeg)

1.  要安装软件包，点击 **+** 号以展开类别，并通过点击其旁边的圆形箭头（**跳过** 将被替换为最新可用版本号）选择一个应用程序。

1.  要安装最新版本的 QGIS，选择 **qgis: QGIS 桌面版** 和 **grass: GRASS GIS 稳定版**。GRASS 是一个独立的 GIS 应用程序，它与 QGIS 紧密集成，并提供高级地理处理功能。

1.  点击 **下一步** 按钮后，安装程序自动检测必要的依赖项，并继续下载软件包和安装，如下面的截图所示：![安装 QGIS](img/image00268.jpeg)

    ### 小贴士

    您也可以安装 **qgis-dev: QGIS 主分支的夜间构建版本**。由于处于持续开发中，这个版本被认为是不稳定的，并且每晚都会更新。它不推荐用于日常使用，但如果您想尝试一些新功能并向开发者提供反馈，则很有用。

安装完成后，您将在 **开始** 菜单中找到 **OSGeo4W** 组，包含以下组件：

+   **MSYS**：这是一组确保传统上依赖于 UNIX 工具的应用程序创建的 GNU 工具

+   **OSGe4W Shell**：这是 OSGeo4W 工具的命令行界面

+   **QGIS 浏览器 2.8.1**：这是一个用于导航和数据预览的 QGIS 探索器

+   **QGIS 桌面 2.8.1**：这是一个 QGIS 桌面应用程序

+   **设置**：这是一个 OSGeo4W 安装程序启动器

+   **GRASS GIS 7.0.0**：这是 GRASS GIS 及其组件

如果您想更新 QGIS 或使用一些新组件扩展当前安装，只需从 **OSGeo4W** 菜单文件夹中点击 **设置** 快捷方式并运行 **高级安装** 程序。安装程序将检查可用的更新和必要的依赖项，下载它们，并安装它们。

# GUI 元素和自定义

当您第一次启动 QGIS 时，您将看到以下截图所示的界面。根据定义，QGIS 界面使用系统语言。为了本教程的目的，您可以通过转到 **设置** | **选项** | **区域** 并重新启动 QGIS 来将其更改为英语并应用您的更改。

![GUI 元素和自定义](img/image00269.jpeg)

QGIS 界面由五个主要部分组成：

1.  **菜单栏**：它以传统形式提供对所有 QGIS 功能的访问——下拉菜单。

1.  **面板**：这些是可以停靠或浮动的窗口。默认情况下，您可以在工作区的左侧看到两个激活的面板。

    +   **图层**面板用于显示所有加载图层的树形视图列表。

    +   **浏览器**面板提供快速导航和访问各种本地、服务器或在线数据源。您可以使用其右上角的特殊按钮关闭或缩小面板。您还可以将其拖放到方便的位置。

        ### 小贴士

        在本书的整个过程中，我们将不时使用 **浏览器** 面板，因此请尽量将其分配到适当的位置，而不是关闭它。例如，通过将其拖放到 **图层** 面板，您可以创建两个独立的标签页：一个用于图层，另一个用于数据源导航。在这种情况下，您将不必牺牲窗口空间来扩展和查看项目。

    ![GUI 元素和自定义](img/image00270.jpeg)

    您可以通过转到 **视图** | **面板** 来打开或关闭面板。同样，您可以在工作区上方的任何位置右键单击，并将弹出一个带有切换按钮的窗口。此窗口由一条水平线分隔，面板切换按钮位于其上部。

1.  **工具栏**：菜单功能被分组到逻辑工具集中，并放置在栏中的按钮上，以提供方便访问所有必要的工具。默认情况下，以下工具栏被打开并显示：![GUI 元素和自定义](img/image00271.jpeg)

    文件工具栏

    ![GUI 元素和自定义](img/image00272.jpeg)

    地图导航工具栏

    ![GUI 元素和自定义](img/image00273.jpeg)

    属性工具栏

    ![GUI 元素和自定义](img/image00274.jpeg)

    数字化工具栏

    ![GUI 元素和自定义](img/image00275.jpeg)

    标签工具栏

    ![GUI 元素和自定义](img/image00276.jpeg)

    帮助和插件工具栏

    ![GUI 元素和自定义](img/image00277.jpeg)

    图层管理工具栏

    如果你想查看简短的工具参考，只需将鼠标指针悬停在按钮上，就会弹出一个黄色的信息窗口。一些按钮或工具栏被灰色显示（例如，**数字化** 工具栏和 **标签** 工具栏），这意味着它们只能在执行某些操作后使用。例如，**数字化** 工具栏的按钮只有在某些图层激活了编辑模式后才能使用。工具栏可以停靠，并且可以轻松地在工作区中移动。要移动工具栏，将鼠标箭头放在其由穿孔点标记的边界上。箭头将变成十字形，表示现在可以拖动并放下工具栏到任何其他位置，同时按住鼠标左键。你可以通过导航到 **视图** | **工具栏**，或从任何工具栏上右键点击调出的窗口中打开或关闭工具栏。

1.  **地图区域**：这是界面窗口中最大的部分，用于数据地图显示和视觉探索。

1.  **状态栏**：此栏简要显示有关当前地图概览的以下信息：渲染进度条（仅在渲染需要一些时间来显示进度时可见）、鼠标指针的位置坐标、比例尺和当前坐标参考系统。它还包含切换到范围坐标和暂时关闭地图渲染的切换按钮。还有用于打开坐标参考系统对话框 ![GUI 元素和自定义](img/image00278.jpeg) 和显示 **日志消息** 面板的按钮 ![GUI 元素和自定义](img/image00279.jpeg)。

通过导航到**设置** | **自定义**，可以进行高级 GUI 自定义。从这个对话框中，您可以完全控制所有菜单、面板、工具栏和小部件。要开始自定义过程，打开**启用自定义**切换按钮。如果您不熟悉 QGIS 界面，进入![GUI 元素和自定义](img/image00280.jpeg) **切换到捕获主应用程序小部件**模式会更简单。在此模式下，您可以点击任何想要隐藏的 GUI 项——工具栏上的按钮或工具栏本身。所选项目会被突出显示，相关的自定义树项会展开，如下面的截图所示。如果您不小心选择了某个项目，只需再次点击它即可取消选择。否则，您可以展开相关项目，检查/取消检查一些切换按钮，然后点击**确定**。更改将在 QGIS 重启后生效。

![GUI 元素和自定义](img/image00281.jpeg)

### 小贴士

随着你对 QGIS 的熟悉程度提高，并开始用它来完成不同的任务，创建几个针对不同用例的用户 GUI 配置文件可能很方便（例如，数字化、与数据库或栅格数据工作等）。为此，您需要在**自定义**对话框窗口中调整所有必要的设置，并将![GUI 元素和自定义](img/image00282.jpeg)保存到`.ini`文件中。之后，您只需通过加载预定义的自定义文件![GUI 元素和自定义](img/image00283.jpeg)的设置，就可以快速修改界面。

一些小的界面更改，例如通用样式、默认图标大小、字体等，都可以在**应用程序**组中找到，通过访问**设置** | **选项** | **常规**来查找。

# 通过插件扩展功能

从一开始，QGIS 就具有模块化架构，这使得添加新功能或功能变得容易。QGIS 中的大多数功能都是通过所谓的插件实现的，这些插件分为以下类型：

+   **核心插件**：这些插件默认包含在 QGIS 中，并由开发团队维护。为了使用它们，用户只需激活即可。

+   **外部插件**：这些插件位于外部仓库中，由作者维护。为了使用它们，用户首先需要安装。随着时间的推移，一些最有用和最受欢迎的插件被整合到了 QGIS 的核心功能中。

## 管理插件

插件管理意味着它们的激活、安装、更新和删除，这些操作通过导航到**插件** | **管理和安装插件**来完成。对话框窗口中有几个选项卡。点击这些选项卡中的任何单个插件都会显示详细信息：插件是否为实验性的，功能、评分、作者、版本，以及一些指向其**主页**、**代码仓库**和**跟踪器**的链接：

+   **全部**：在此选项卡下，您可以查看所有可用的插件列表，包括已安装和未安装的。

+   **已安装**：此选项卡显示已安装在 QGIS 中的插件。如果您想激活/停用插件，只需检查/取消检查其旁边的切换按钮。

+   **未安装**：此选项卡包含所有未在您的 QGIS 中安装的可用的插件列表。

    以下选项卡不是永久的，只有当有插件满足某些条件时才会显示：

    +   **可升级**：只有当仓库中有可用的较新版本的已安装插件时，此选项卡才会可见。

    +   **无效**：当安装了与您的 QGIS 版本不兼容或损坏的插件时，此选项卡会显示。如果您点击此选项卡中的单个插件，您将看到有关无效可能原因的信息；这样您就可以向开发者提供一致的反馈。

    +   **新插件**：此选项卡显示首次看到的未安装插件。

    ![管理插件](img/image00284.jpeg)

+   **设置**：此选项卡允许您定义更新检查的频率以及是否使用实验性或已弃用的插件。虽然不建议在生产环境中使用实验性插件，但您仍然可以激活选项来探索所有可用的工具。默认情况下，仅连接到**QGIS 官方插件仓库**，但您可以通过点击**添加...**按钮连接其他已知仓库。例如，前面的截图显示了如何添加外部 Boundless 插件仓库。

要安装插件，请返回到**未安装**选项卡，选择您想要安装的插件，然后点击**安装插件**。之后，安装开始，安装完成后，将显示关于成功安装的消息。默认情况下，已安装的插件被激活，并可能出现在**插件**菜单中，或者被添加到另一个相关菜单（例如，**矢量**或**栅格**）。此外，一些插件作为单独的工具栏和面板出现，可以手动放置并打开或关闭。

由于插件数量超过 400 个且不断增长，寻找和选择满足您需求的插件可能很困难。要探索 QGIS 插件的世界，您可以从 [`plugins.qgis.org/`](http://plugins.qgis.org/) 开始，该网站包含有关流行和特色插件的信息。如果您正在寻找特定功能但不知道确切的插件名称，我们建议您使用**管理和安装插件**对话框窗口中的标签词进行搜索，如图下所示：

![管理插件](img/image00285.jpeg)

### 小贴士

默认情况下，插件按名称字母顺序排序。如果您想根据下载量、投票或状态进行评分，可以通过右键单击插件列表的上下文菜单应用额外的排序选项。

# 将数据加载到 QGIS 中

GIS 中的数据可以以单独的文件、数据库或外部在线资源的形式提交。此外，GIS 中使用了不同的数据模型来表示空间对象的几何形状。矢量数据模型主要用于表达离散特征，例如点（例如，单独生长的树木和兴趣点）、线（道路或铁路）和多边形（建筑或行政边界）。栅格数据对于表达比点、线或多边形更好的连续现象来说很方便。最常见的栅格数据源是遥感影像、数字高程模型和扫描并地理定位的地形图。

QGIS 使用 GDAL/OGR 空间数据库来读取和写入多种矢量和栅格文件格式。在接下来的章节中，我们将简要讨论您可以获得数据的最常见的文件格式。此外，我们将探讨最近广泛使用的数据源，例如 CSV 文件、由 GPS 接收器收集的文件和 OpenStreetMap。

## 加载 shapefiles

我们的大部分数据都是以 ESRI shapefile 格式存储的，这是最常见的矢量数据文件格式之一。有几种不同的方法可以将 shapefile 加载到 QGIS 中。您可以通过访问**图层** | **添加图层** | **添加矢量图层**来打开对话框窗口，或者通过点击**管理图层**工具栏上的相关按钮 ![加载 shapefiles](img/image00286.jpeg)，或者使用*Ctrl* + *Shift* + *V* 键盘快捷键。

在**添加矢量图层**对话框窗口中，配置以下项目：

+   **数据源类型**，可以是**文件**、**目录**、**数据库**或**协议**。默认情况下，指定的**文件**数据源类型适用于加载由单独文件表示的空间数据，就像在我们的例子中一样。

+   如果您处理的数据包含特殊符号或其文本属性的字符集与传统的拉丁符号不同，请考虑**编码**下拉列表选项。在这种情况下，您应从下拉列表中选择适当的编码类型。我们的数据不包含任何特殊符号，所以我们接受默认的**系统**编码。

+   **浏览**按钮用于导航到工作目录。在那里，您可以选择一个或多个文件（使用*Ctrl*键），然后点击**打开**按钮来添加。

    ### 小贴士

    第一次使用时，您可能会被可用文件的数量和多样性所淹没。这是因为 GIS 中，数据集通常由具有不同扩展名的多个文件表示。例如，ESRI 形状文件至少由 4 个文件组成（`.shp`，`.shx`，`.dbf`和`.prj`），它们具有相同的名称，其中`.shp`是您应该选择以将数据加载到 QGIS 中的文件。您看到所有文件是因为窗口右下角的文件类型过滤器默认设置为**所有文件**。要隐藏所有不必要的文件，请选择**ESRI 形状文件**文件类型。将来，不要忘记根据所需的文件类型调整过滤器。

或者，您可以使用**浏览器**面板导航到工作目录。选择您想要加载的文件（一个或多个，按住*Ctrl*键），然后将它们拖放到地图区域。如果您想简化导航，可以从其右键菜单快捷键中将您当前正在工作的文件夹添加到**收藏夹**。

![加载形状文件](img/image00287.jpeg)

加载的文件被分配了随机颜色。目前不必担心这个问题；我们将在第二章，*可视化和样式化数据*中介绍图层符号。

## 加载栅格数据

添加栅格文件的过程与前面描述的类似，因此我们将简要介绍其示例，即常见的栅格文件格式**GeoTIFF**：

1.  您可以通过访问**图层** | **添加图层** | **添加栅格图层**，点击**管理图层**工具栏上的相关按钮 ![加载数据](img/image00288.jpeg)，或者使用*Ctrl* + *Shift* + *R*键盘快捷键来加载数据栅格文件。

1.  在**打开 GDAL 支持的栅格数据源**窗口中，进入工作目录。

1.  要查看可用的 GeoTIFF 文件，请记住调整文件类型过滤器，选择一个或多个文件（按住*Ctrl*键），然后点击**打开**。或者，您可以从**浏览器**面板拖放栅格数据。

## 从个人地理数据库加载数据

ESRI 个人地理数据库是 ArcGIS 的原始数据格式，其中数据库的所有内容都存储在一个单独的`.mdb` Microsoft Access 文件中。它广泛用于将数据存储在单个数据文件中，而不是多个不同格式的文件中。

将 ESRI 文件地理数据库添加到 QGIS 与添加任何其他矢量格式类似：

1.  通过访问**图层** | **添加图层** | **添加矢量图层**，或者点击**管理图层**工具栏上的相关按钮 ![从个人地理数据库加载数据](img/image00286.jpeg)，或者使用*Ctrl* + *Shift* + *V*键盘快捷键来访问对话框窗口。

1.  进入工作目录，设置文件类型过滤器为**ESRI 个人地理数据库**，并选择您想要从中导入数据的数据库文件。

1.  在**选择要添加的矢量图层...**窗口中，您将看到可用的图层及其特征。点击要添加的图层并点击**确定**。![从个人地理数据库加载数据](img/image00289.jpeg)

    ### 注意

    数据库中包含的栅格图层将被解释并作为边界框多边形加载到 QGIS 中。如果数据存储在不含任何空间特征的表中，几何类型将显示为**未知**。这些表将被加载并可用于导出为其他格式（例如，`.dbf`）或与空间数据图层连接。

## 导入 CSV 文件

**逗号分隔值**（**CSV**）文件是另一种流行的数据文件格式。实际上，它只是一个用逗号分隔字段值的电子表格。除了逗号之外，还有各种可能的分隔符（例如，制表符、空格、冒号等）。这些表格通常包含以点经度或纬度（*XY*）坐标或**已知文本（WKT**）几何形式表示的位置属性的空间数据。

在我们的数据集中，有一个名为 `noise.csv` 的 CSV 文件。它包含主要由纽约市警察局登记的噪音投诉的详细信息。要将此文件添加为空间图层，请按照以下步骤操作：

1.  通过访问**图层** | **添加图层** | **添加分隔文本图层**打开**从分隔文本文件创建图层**对话框，或者只需在**管理图层**工具栏中点击相关的按钮 ![导入 CSV 文件](img/image00290.jpeg)。

1.  在浏览并指向您的文件后，QGIS 尝试使用指定的分隔符解析它。默认情况下，使用逗号分隔符，但您可以使用**自定义分隔符**（逗号、制表符、空格等）或**正则表达式分隔符**指定任何其他分隔符。![导入 CSV 文件](img/image00291.jpeg)

1.  对话框还提供了访问许多其他有用设置的途径；例如，开启**第一行包含字段名**选项将为字段创建标题。在将几何形状定义为**点坐标**、包含**经度**和**纬度**值的**X 字段**和**Y 字段**后，这些字段将从数据集中自动加载。

1.  在您点击**确定**后，QGIS 读取数据并可能显示类似于**文件 full_path_to_the_file/filename.csv 中存在错误 100 条记录因缺少几何定义而被丢弃**的定界文本文件错误消息。这意味着某些点不包含地理坐标，因此它们无法正确定位。在关闭消息窗口后，您将被提示指定图层的**坐标参考系统**（**CRS**）。![导入 CSV 文件](img/image00292.jpeg)

    如我们从**纬度**和**经度**列的值中可以看到，点坐标最初是由**全球定位系统（GPS）**的接收设备以十进制度数注册的。还知道 GPS 使用 WGS 84 坐标系。这就是为什么在**坐标参考系统选择器**窗口中，我们输入**EPSG: 4326**代码过滤器，并在**地理坐标系统**下指定**WGS 84**作为初始坐标系。点击**确定**后，您会看到数据在地图画布上以点的方式呈现。

    ### 注意

    QGIS 使用基于欧洲石油勘探集团（EPSG）的地理参数数据集的 CRS 定义，该数据集包含全球、区域、国家和地方应用的坐标参考系统和转换的详细结构化描述。EPSG 标识符数据库可用于在 QGIS 中指定 CRS。您可以在[`www.epsg-registry.org/`](http://www.epsg-registry.org/)了解更多关于 EPSG 地理参数数据集的信息。

## 加载 GPS 数据

随着 GPS 接收器变得便携且相对便宜，GPS 跟踪成为在野外调查期间收集数据的一种普遍和广泛使用的技巧，或者在跑步或骑自行车时简单地跟踪自己的路线。根据接收器的功能，除了空间坐标外，还可以注册和写入大量信息——例如，时间、海拔等。注册的信息存储在代表位置变化的点（路径、轨迹或路线点）、（如果存在）计划路线以及移动轨迹中。存储 GPS 数据有多种格式。作为主要数据格式，QGIS 使用标准的交换**GPX**（**GPS 交换**）格式。

我们将从数据集中加载`nyc_marathon.gpx`文件。您可以通过前往**图层** | **添加图层** | **添加矢量图层**，点击**管理图层**工具栏中的相关按钮 ![加载 GPS 数据](img/image00286.jpeg)，或者使用*Ctrl* + *Shift* + *V*键盘快捷键来加载一个`.gpx`文件作为矢量图层。转到数据目录并应用**GPS 交换格式（GPX）**文件类型过滤器。选择您想要添加的文件（或文件），然后点击**打开**。或者，您可以从**浏览器**面板拖放文件。

![加载 GPS 数据](img/image00293.jpeg)

由于 GPS 数据由点、路线和轨迹组成，窗口会弹出，让您选择您想要打开的确切要素。您可以通过点击一行并按住*Ctrl*键来选择一个或多个要素。如果您不确定需要哪个要素，请使用**全选**。每种要素类型都会在单独的图层中呈现。通过打开和关闭图层，您可以检查它们是否包含数据；例如，我们正在处理的文件只包含轨迹和轨迹点。您可以通过右键点击图层上下文快捷方式**删除**来移除不必要的空图层。

### 注意

通过**GPS Tools**核心插件可以访问处理 GPS 数据的高级选项。激活后，可以通过导航到**向量** | **GPS** | **GPS Tools**或从**向量工具栏**面板上的![加载 GPS 数据](img/image00294.jpeg)按钮访问插件功能。

## 获取 OpenStreetMap 数据

**OpenStreetMap** (**OSM**)是一个旨在开发世界开放地图的众包项目。全球范围内，OSM 社区使用高分辨率遥感影像、GPS 测量和当地知识来制作尽可能精确和详细的地图。由于 OSM 数据根据 Open Data Commons 的**开放数据库许可**(**ODbL**)许可，它最近已成为广泛使用的空间数据来源。理解无限制访问空间数据的重要性，QGIS 支持 OSM，提供对其数据的集成访问和支持。

QGIS 的核心功能可以从**向量**菜单下的**OpenStreetMap**访问。在这里，你可以找到所有下载数据并将其导出为传统空间数据格式的所需工具，但如果你是 QGIS 和 OSM 数据概念的初学者，可能会觉得这个过程很繁琐。这就是为什么我们建议你使用外部**QuickOSM**插件功能来下载 OSM 数据。

如同在*通过插件扩展功能*部分所述安装后，可以通过访问**Web** | **QuickOSM** | **QuickOSM**来访问插件的主要功能。主窗口的**快速查询**标签页包含了执行查询并将数据导入 QGIS 所需的所有内容。首先，从下拉列表中定义一个`key=value`对，或者手动输入它。

### 注意

如果你不熟悉 OSM 标记系统，第一次选择合适的标记可能相当困难。每个标记都是一个描述某些点、线性或多边形特征的`key=value`对。键描述了一个广泛的类别（例如，便利设施），而值提供了详细信息（银行、电影院、咖啡馆、自行车停车区等）。使用**帮助键/值**按钮可以了解更多关于从 OSM 维基页面[`wiki.openstreetmap.org/wiki/Mapfeatures`](http://wiki.openstreetmap.org/wiki/Mapfeatures)的标记信息。

然后，通过位置名称、地图画布或图层设置感兴趣区域的范围。如果图层下拉列表不可用，点击其旁边的![获取 OpenStreetMap 数据](img/image00295.jpeg)按钮来刷新它。在**高级**部分，你可以开启/关闭不同的几何类型。默认情况下，所有几何类型都是开启的，因此所有相关的点、线和多边形都将被下载。浏览到你想保存数据的目录。在下面的屏幕截图中，你可以看到使用 QuickOSM 查询下载自行车停车点数据的示例。

![获取 OpenStreetMap 数据](img/image00296.jpeg)

### 小贴士

如果你熟悉**Overpass API**查询语言，可以点击**显示查询**或**查询**选项卡来修改初始查询。

点击**运行查询**按钮后，包含数据的 shapefile 将被加载到地图画布上。

# 处理投影

投影定义了地球曲面上现实世界对象如何被展平和投影到类似平面的地图上。不同的数据源通常在不同的投影中创建和分发，这取决于获取技术和应用范围。为了能够在 QGIS 中正确地操作和分析它们，理解它如何解释和管理投影信息非常重要。

QGIS 支持大约 2,700 个 CRS。它们构成一个数据库，每个项目都由一个**ESPG 标识符**和一个描述行来描述，该描述行遵循**PROJ.4**投影库的格式。为了存储和读取有关投影的信息，QGIS 使用其自有的格式存储在`.qpj`文件中。在处理投影时，有两个重要点需要记住：数据源投影和项目投影——它们并不总是相同的。

## 数据源投影

当你将数据加载到 QGIS 中时，它会尝试自动从随附的投影描述文件中定义投影信息，并将其设置为新添加的图层。你可以在**图层属性**对话框中检查图层的投影信息。要打开它，在**图层**面板中双击图层名称，或使用右键上下文快捷方式**属性**。投影信息显示在**常规**选项卡的**坐标参考系统**部分，如下所示：

![数据源投影](img/image00297.jpeg)

存在着许多投影描述文件格式，它们大多取决于数据格式和来源。其中最常见的一种是`.prj`文件。这种文件格式有时以简化的形式提供有关投影的信息，而 QGIS 无法正确定义它。如果缺少或信息不完整，你会看到投影描述缺失或看起来像这样：`USER:100000 - * 生成 CRS (+proj=etc.)`。这意味着 QGIS 在其数据库中没有找到合适的投影，并将其作为自定义 CRS 添加。如果你确信该投影是标准的，但 QGIS 由于简化的描述而无法正确解释它，请手动指定它。评估**坐标参考系统选择器**对话框有不同的方法如下：

+   在**图层**面板中双击图层名称以打开**图层属性**对话框。在**常规**选项卡下，点击**选择 CRS**按钮 ![数据源投影](img/image00298.jpeg) 从**坐标参考系统选择器**对话框窗口中选择必要的 CRS。

+   通过转到**图层** | **设置图层(s)的 CRS**。

+   使用*Ctrl* + *Shift* + *C*键盘快捷键。

+   通过右键单击图层快捷方式 **设置图层 CRS**。

在 **坐标参考系统选择器** 对话框中，从列表中选择必要的 CRS 并单击 **确定**。注意，您可以使用关键字或 EPSG 代码进行过滤，以隐藏不必要的投影。随着时间的推移，常用投影将被添加到最近使用的 CRS 列表中。

### 注意

如果 QGIS 没有自动为您的数据定义投影，并且您不确定投影名称和 EPSG 代码，请使用 [`prj2epsg.org/`](http://prj2epsg.org/) 网站的 Prj2EPSG 服务。在这个服务中，您只需上传您的 `.prj` 文件，其中的已知文本投影信息将被转换为标准的 EPSG 代码。

注意，从 **属性** 对话框手动指定投影是一个临时解决方案；在关闭文件和/或退出 QGIS 后，它不会持续存在。这意味着每次您将此文件加载到 QGIS 中时，您都必须再次指定投影。如果您打算在其他项目中使用该文件，最好通过转到 **向量** | **数据管理工具** | **定义当前投影** 使用 **定义当前投影** 工具。在这个对话框中，您可以从 **坐标参考系统选择器** 对话框中选择预定义的坐标参考系统，或者使用已知 CRS 的 **从现有图层导入坐标参考系统**。在这两种情况下，现有的 `.prj` 文件将由 QGIS 用所有必要的参数覆盖，您将不必在下次手动调整投影。

![数据源投影](img/image00299.jpeg)

当您从外部源导入文件时，所有这些都是正确的。如果您在 QGIS 中创建一个 shapefile，将同时创建 `.prj` 和 `.qpj` 文件，因此您不需要手动定义投影。这些文件的投影将在从 `.prj` 文件读取的其他 GIS 应用程序中正确解释。

您还可以通过转到 **设置** | **选项** | **CRS** 来保持 QGIS 在加载或创建没有 CRS 信息的新图层时的行为，这里有三种新图层 CRS 的选择：

1.  **提示 CRS**：在这种情况下，您将始终被要求手动指定图层的 CRS。

1.  **使用项目 CRS**：数据将被自动分配给项目设置的 CRS。如果您使用的是同一投影的文件，这是一个方便的选择，但如果它们的投影与指定的不同，您将无法看到它们。

1.  **使用下面显示的默认 CRS**：传统上使用 **EPSG:4326 - WGS 84**，但您可以指定自己的选择。

与投影一起工作可能会很棘手，除非你认识到**指定**和**定义投影**选项之间的区别。这全部关于正确分配投影信息，但当你指定它时，结果在当前工作会话中是临时的。一旦你定义了一个投影，除非重新定义，否则它将变得永久。在这两种情况下，如果你选择了错误的投影，你将无法在地图上看到你的数据（至少在你期望它出现的地方）。通常，首先指定投影是一个好习惯，将你的数据与正确投影的数据集进行比较。如果一切正常，定义它以使投影分配永久化。

## 项目投影

当你加载 QGIS 时，其地图画布投影默认设置为**EPSG:4326 – WGS 84**。这种行为由全局默认投影定义，可以通过访问**设置** | **选项** | **坐标参考系统** | **始终以此 CRS 开始新项目**来更改。

然而，当你开始添加数据时，投影标识符会自动更改为第一个加载层的投影。因此，默认情况下，投影投影是由第一个加载层定义的。数据源投影和投影投影并不总是相同的。如果它们不同，QGIS 可以应用所谓的**即时转换**。这意味着它会读取数据投影，如果它不同，会自动将其与项目投影对齐，并应用必要的转换。有几种方法可以指定项目的投影并启用即时转换：

+   通过访问**项目** | **项目属性** | **坐标参考系统**。

+   点击**状态栏**上的**当前 CRS**![项目投影](img/image00278.jpeg)按钮，并在**项目属性** | **坐标参考系统**窗口中激活**启用'即时'CRS 转换**。

+   前往**设置** | **选项** | **坐标参考系统** | **新项目的默认 CRS**。激活**如果图层具有不同的 CRS 则自动启用'即时'重投影**或**默认启用'即时'重投影**。

在最后一种方法中，区别非常微妙，主要在添加第一个图层到项目时才会明显。在自动启用重投影的情况下，默认地图画布 CRS 将被第一个图层投影取代，后续图层也将自动调整到它。在默认重投影的情况下，所有图层都将重新投影到项目的初始 CRS（这通常是默认的全局投影，除非你已更改它）。

启用即时转换后，你将在状态栏上的当前 CRS 附近看到**OTF**缩写，图标将变为实心。

如果你想要根据**图层**面板中的特定图层快速更改项目 CRS，请右键单击一个图层并选择**从图层设置项目 CRS**快捷方式。

# 将图层加载到空间数据库

现在我们已经将所有可用数据加载到 QGIS 中，让我们将其聚合到一个单一数据库中。QGIS 支持与各种数据库管理系统及其空间扩展（PostgreSQL/PostGIS、Oracle Spatial/GeoRaster、MSSQL Spatial、SQL Anywhere 和 SQLite/SpatiaLite）一起工作。其中，PostGIS 和 SpatiaLite 可能是你已经听说过的。作为常见的空间数据库，它们通常用于不同的目的。PostGIS 是一个企业级解决方案的例子，主要用于服务器上，为多个用户提供空间数据维护和访问。SpatiaLite 是一个轻量级的个人使用文件数据库。使用 SpatiaLite 数据库具有以下优点：

+   所有数据都存储在一个单一、便携的文件中，你不会因为不同文件类型（例如，`.shp`, `.dbf`, `.shx`, `.prj`, `.qpj`等）而感到混乱。

+   Shapefile 的大小限制（最多 2 GB）和字段名称长度（10 个字符）可以忽略。

+   内置的空间索引允许你更快地执行大范围搜索。

+   这是一个真正的单一格式的数据库，允许你使用各种空间函数和基于 SQL 的工作流程。

执行以下步骤将你的数据组装成一个单一的 SpatiaLite 数据库：

1.  首先，你需要创建一个空的空间数据库来加载你的数据。你可以从**浏览器**面板中这样做。右键单击**SpatiaLite**条目并选择**创建数据库**快捷方式。指定文件夹和`.sqlite`数据库文件名。你将得到**数据库已创建**的消息。现在你可以展开条目并看到你新创建的空数据库。

1.  我们将使用提供与不同数据库交互的单个界面的 DB Manager 核心插件来加载数据。可以通过转到**数据库** | **DB Manger**来访问插件功能。在窗口的左侧，你可以看到一个按类型分组的可用数据库连接的树状列表。一旦创建，你的数据库将自动在**SpatiaLite**项下可用，你可以通过双击来连接它。当连接建立后，你将在窗口右侧的**信息**选项卡中看到有关数据库或其选定项的一般信息。要将文件导入数据库，请单击**导入图层/文件**按钮 ![将图层加载到空间数据库](img/image00300.jpeg)，或从**表**菜单访问它。![将图层加载到空间数据库](img/image00301.jpeg)

1.  在打开的**导入矢量图层**窗口中，你应该定义你想要导入的图层。它可以是**输入**下拉列表中可用的已加载图层之一，或者你可以通过单击浏览按钮**...**从文件系统中选择图层。然后，定义**输出表**名称（在我们的例子中，它是`ny_boroughs`，与输入相同）。![将图层加载到空间数据库](img/image00302.jpeg)

    以下选项允许你更精细地控制你的数据：

    +   **主键**：如果没有指定，字段将默认命名为`pk`

    +   **几何列**：如果没有指定，字段将默认命名为`geom`

    +   **源 SRID**和**目标 SRID**：这些是从数据中读取的 CRS EPSG 代码，但如果你没有投影文件，或者你想在将数据加载到数据库之前重新投影它，你可以手动指定它们

    +   **编码**：如果没有指定，数据集字符集默认设置为**UTF-8**

    +   **删除现有表**：如果你导入一个与先前存在的表具有相同名称的表，它将被新表替换

    +   **创建单部分几何而不是多部分几何**：在将多部分要素加载到数据库之前，将它们分解为单部分几何

    +   **创建空间索引**：将创建一个空间索引，它允许更快的空间搜索和查询性能

点击**确定**并稍等片刻（根据文件大小，此过程可能需要一些时间），你将看到“导入成功”的消息。要探索导入的表，请点击**刷新**按钮 ![将图层加载到空间数据库中](img/image00303.jpeg)，你将在数据库项目列表中看到一个几何表。从**信息**选项卡，你可以查看有关表、几何类型、字段和触发器的信息。**表**选项卡以表格形式显示数据，而**预览**选项卡显示空间几何（如果有）。通过右键单击任何元素，你可以删除、重命名或将其添加到地图画布上。所有其他打开的图层都可以以类似的方式加载。

![将图层加载到空间数据库中](img/image00304.jpeg)

### 注意

除了核心功能之外，还有一个名为**QSpatiaLite**的外部插件，专门设计用于支持与 SpatiaLite 数据库一起工作。安装后，当你导航到**数据库** | **SpatiaLite** | **QSpatiaLite**时，它将可用。

# 摘要

到目前为止，我们已经介绍了一些入门主题并完成了几个任务。首先，你学习了如何安装 QGIS、配置其界面以及通过插件扩展功能。然后我们讨论了你可以用来将数据导入 QGIS 的常见数据源。你现在能够探索和管理不同投影的数据。最后但同样重要的是，你将所有数据导入了一个便携式、轻量级的 SpatiaLite 数据库文件。

在下一章中，我们将继续前进，揭示 QGIS 在数据可视化方面的潜力。
