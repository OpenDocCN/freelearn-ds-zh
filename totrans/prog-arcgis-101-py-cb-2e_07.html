<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter" title="Chapter 7. Creating Custom Geoprocessing Tools"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Creating Custom Geoprocessing Tools</h1></div></div></div><p>In this chapter, we will cover the following recipe:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating a custom geoprocessing tool</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec53"/>Introduction</h1></div></div></div><p>In addition to accessing the system tools provided by ArcGIS, you can also create your own custom tools. These tools work in the same way that system tools do and can be used in ModelBuilder, Python window, or in standalone Python scripts. Many organizations build their own library of tools that perform geoprocessing operations specific to their data. </p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Creating a custom geoprocessing tool"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec54"/>Creating a custom geoprocessing tool</h1></div></div></div><p>In addition to being able to <a id="id498" class="indexterm"/>execute any of the available tools in your scripts, you can also create your own custom tools, which can also be called from a script. Custom tools are frequently created to handle geoprocessing tasks that are specific to an organization. These tools can easily be shared as well. </p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec134"/>Getting ready</h2></div></div></div><p>In this recipe, you will learn to<a id="id499" class="indexterm"/> create custom geoprocessing script tools by attaching a Python script to a custom toolbox in <a id="id500" class="indexterm"/>ArcToolbox. There are a number of advantages of creating a custom script tool. When you take this approach, the script becomes a part of the geoprocessing framework, which means that it can be run from a model, command line, or another script. In addition to this, the script has access to ArcMap environment settings and help documentation. Other advantages include a nice, easy-to-use user interface and error-prevention capabilities. Error-prevention capabilities provided include a dialog box that informs the user of certain errors.</p><p>These custom developed script tools must be added to a custom toolbox that you create because the system toolboxes provided with ArcToolbox are read-only toolboxes and thus can't accept new tools. </p><p>In this recipe, you are going to be provided with a pre-written Python script that reads wildfire data from a comma-delimited text file, and writes this information to a point feature class called <code class="literal">FireIncidents</code>. References to these datasets have been hardcoded, so you are going to alter the script to accept dynamic variable input. You'll then attach the script to a custom tool in ArcToolbox to give your end users a visual interface for using the script.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec135"/>How to do it…</h2></div></div></div><p>The custom Python geoprocessing scripts that you write can be added to ArcToolbox inside custom toolboxes. You are not allowed to add your scripts to any of the system toolboxes, such as <span class="strong"><strong>Analysis</strong></span> or <span class="strong"><strong>Data Management</strong></span>. However, by creating a new custom toolbox, you can add these scripts.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open ArcMap with an empty map document file and open the ArcToolbox window.</li><li class="listitem">Right-click <a id="id501" class="indexterm"/>anywhere in the white space area of ArcToolbox and select <span class="strong"><strong>Add Toolbox</strong></span>. On the <span class="strong"><strong>Add Toolbox</strong></span> dialog box, click on the <span class="strong"><strong>New Toolbox </strong></span>button. This will create a new toolbox with a default name of <code class="literal">Toolbox.tbx</code>; you will rename the toolbox in the next step:<div class="mediaobject"><img src="images/4445_07_1.jpg" alt="How to do it…"/></div></li><li class="listitem">Navigate to the <code class="literal">c:\ArcpyBook\Ch7</code> folder and name the toolbox <code class="literal">Wildfire Tools</code>:<div class="mediaobject"><img src="images/4445_07_13.jpg" alt="How to do it…"/></div></li><li class="listitem">Open the<a id="id502" class="indexterm"/> toolbox by selecting <span class="strong"><strong>WildfireTools.tbx</strong></span> and clicking on the <span class="strong"><strong>Open</strong></span> button. The toolbox should now be displayed in ArcToolbox as shown in the following screenshot:<div class="mediaobject"><img src="images/4445_07_14.jpg" alt="How to do it…"/></div></li><li class="listitem">Each toolbox should be given a name and an alias. The alias will be used to uniquely define your custom tool. Alias names should be kept short and should not include any special characters. Right-click on the new toolbox and select <span class="strong"><strong>Properties</strong></span>. Add an alias of <code class="literal">wildfire</code> as shown in the following screenshot:<div class="mediaobject"><img src="images/4445_07_15.jpg" alt="How to do it…"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note11"/>Note</h3><p>You can optionally create a new toolset inside this toolbox by right-clicking on the toolbox and selecting <span class="strong"><strong>New</strong></span> | <span class="strong"><strong>Toolset</strong></span>. Toolsets allow you to functionally group your scripts. In this example, it won't be necessary to do this, but if you need to group your scripts in the future, then this is how you can accomplish it.</p></div></div></li><li class="listitem">In this <a id="id503" class="indexterm"/>next step, we will alter an existing Python script called <code class="literal">InsertWildfires.py</code> to accept dynamic inputs that will be provided by the user of the tool through the ArcToolbox interface. Open <code class="literal">c:\ArcpyBook\Ch7\InsertWildfires.py</code> in IDLE.<p>Notice that we have hardcoded the path to our workspace as well as the comma-delimited text file containing the wildland fire incidents:</p><div class="informalexample"><pre class="programlisting">arcpy.env.workspace = "C:/ArcpyBook/data/Wildfires/WildlandFires.mdb"
  f = open("C:/ArcpyBook/data/Wildfires/NorthAmericaWildfires_2007275.txt","r")</pre></div></li><li class="listitem">Delete the preceding two lines of code.<p>In addition, we have also hardcoded the output feature class name:</p><div class="informalexample"><pre class="programlisting">cur = arcpy.InsertCursor("FireIncidents")</pre></div><p>This hardcoding limits the usefulness of our script. If the datasets move or are deleted, the script will no longer run. In addition to this, the script lacks the flexibility to specify different input and output datasets. In the next step, we will remove this hardcoding and replace it with the ability to accept dynamic input.</p></li><li class="listitem">We will use the <code class="literal">GetParameterAsText()</code> function<a id="id504" class="indexterm"/> found in <code class="literal">arcpy</code> to accept dynamic input from the user. Add the following lines of code to your <code class="literal">try</code> block, so that your code appears as follows:<div class="informalexample"><pre class="programlisting">try:
  # the output feature class name
  outputFC = arcpy.GetParameterAsText(0)
	
  # the template feature class that defines the attribute schema
  fClassTemplate = arcpy.GetParameterAsText(1)

  # open the file to read
  f = open(arcpy.GetParameterAsText(2),'r')

  arcpy.CreateFeatureclass_management(os.path.split(outputFC)[0], os.path.split(outputFC[1]), "point", fClassTemplate)</pre></div><p>Notice<a id="id505" class="indexterm"/> that we call the <code class="literal">CreateFeatureClass</code> tool, found in the <span class="strong"><strong>Data Management Tools</strong></span> toolbox, passing in the <code class="literal">outputFC</code> variable along with the template feature class (<code class="literal">fClassTemplate</code>). This tool will create the empty feature class containing the output feature class defined by the user. </p></li><li class="listitem">You will also need to alter the line of code that creates an <code class="literal">InsertCursor</code> object. Change the line as follows:<div class="informalexample"><pre class="programlisting">cur = arcpy.InsertCursor(outputFC)</pre></div></li><li class="listitem">The entire script should appear as follows:<div class="informalexample"><pre class="programlisting">import arcpy, os
try:
	outputFC = arcpy.GetParameterAsText(0)
  fClassTemplate = arcpy.GetParameterAsText(1)
	f = open(arcpy.GetParameterAsText(2),'r')
	arcpy.CreateFeatureclass_management(os.path.split(outputFC)[0], os.path.split(outputFC[1]), "point", fClassTemplate)
  lstFires = f.readlines()
  cur = arcpy.InsertCursor(outputFC)
  cntr = 1
  for fire in lstFires:
    if 'Latitude' in fire:
      continue
    vals = fire.split(",")
    latitude = float(vals[0])
    longitude = float(vals[1])
    confid = int(vals[2])
    pnt = arcpy.Point(longitude, latitude)
    feat = cur.newRow()
    feat.shape = pnt
    feat.setValue("CONFIDENCEVALUE", confid)
    cur.insertRow(feat)
    arcpy.AddMessage("Record number: " + str(cntr) + " written to feature class")
    cntr = cntr + 1
except:
  print arcpy.GetMessages()
finally:
  del cur
  f.close()</pre></div><p>In the next step, we will<a id="id506" class="indexterm"/> add the script that we just created to the <span class="strong"><strong>Wildfire Tools</strong></span> toolbox as a script tool. </p></li><li class="listitem">In ArcToolbox, right-click on the <span class="strong"><strong>Wildfire Tools</strong></span> custom toolbox that you created earlier and select <span class="strong"><strong>Add</strong></span> | <span class="strong"><strong>Script</strong></span>. This will display the <span class="strong"><strong>Add Script</strong></span> dialog, as shown in the following screenshot. Give your script a name, label, and description. The <span class="strong"><strong>Name</strong></span> field can not contain any spaces or special characters. <span class="strong"><strong>Label</strong></span> is the name that shows up next to the script. For this example, give it a label of <code class="literal">Load Wildfires From Text</code>. Finally, add some descriptive information that details the operations the script will perform.</li><li class="listitem">See the following screenshot for <span class="strong"><strong>Name</strong></span>, <span class="strong"><strong>Label</strong></span>, and <span class="strong"><strong>Description</strong></span> details:<div class="mediaobject"><img src="images/4445_07_2.jpg" alt="How to do it…"/></div></li><li class="listitem">Click on <span class="strong"><strong>Next</strong></span> to display the next input dialog box for <span class="strong"><strong>Add Script</strong></span>. </li><li class="listitem">In this dialog box, you will specify the script that will be attached to the tool. Navigate to <code class="literal">c:\ArcpyBook\Ch7\InsertWildfires.py</code> and add <code class="literal">InsertWildfires.py</code> as the script. </li><li class="listitem">You will also <a id="id507" class="indexterm"/>want to make sure that the <span class="strong"><strong>Run Python script in process</strong></span> checkbox is selected, as shown in the following screenshot. Running a Python script "in process" increases the performance of your script. <div class="mediaobject"><img src="images/4445_07_10.jpg" alt="How to do it…"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note12"/>Note</h3><p>Running a script out of process requires ArcGIS to create a separate process to execute the script. The time it takes to start this process and execute the script leads to performance problems. Always run your scripts in process. Running a script in process means that ArcGIS does not have to spawn a second process to run the script. It runs in the same process space as ArcGIS. </p></div></div></li><li class="listitem">Click on <span class="strong"><strong>Next</strong></span> to display the parameter window, as shown in the following screenshot:<div class="mediaobject"><img src="images/4445_07_3.jpg" alt="How to do it…"/></div><p>Each <a id="id508" class="indexterm"/>parameter that you enter in this dialog box corresponds to a single call to <code class="literal">GetParameterAsText()</code>. Earlier, you altered your script to accept dynamic parameters through the <a id="id509" class="indexterm"/>
<code class="literal">GetParameterAsText()</code> method. The parameters should be entered in this dialog box in the same order that your script expects to receive them. For instance, you inserted the following line of code in your code:</p><div class="informalexample"><pre class="programlisting">outputFC = arcpy.GetParameterAsText(0)</pre></div><p>The first parameter that you add to the dialog box will need to correspond to this line. In our code, this parameter represents the feature class that will be created as a result of running this script. You add parameters by clicking on the first available row under <span class="strong"><strong>Display Name</strong></span>. You can enter in any text in this row. This text will be displayed to the user. You will also need to select a corresponding datatype for the parameter. In this case, Data Type should be set to <span class="strong"><strong>Feature Class</strong></span>, since this is the expected data that will be gathered from the user. Each parameter also has a number of properties that can be set. Some of the more important properties include <span class="strong"><strong>Type</strong></span>, <span class="strong"><strong>Direction</strong></span>, and <span class="strong"><strong>Default</strong></span>.</p></li><li class="listitem">Enter the information, as shown in the following screenshot, into your dialog box, for the output feature class. Make sure that you set <span class="strong"><strong>Direction</strong></span> to <span class="strong"><strong>Output</strong></span>:<div class="mediaobject"><img src="images/4445_07_4.jpg" alt="How to do it…"/></div></li><li class="listitem">Next, we<a id="id510" class="indexterm"/> need to add a parameter that defines the feature class that will be used as the attribute template for our new feature class. Enter the following information in your dialog box:<div class="mediaobject"><img src="images/4445_07_11.jpg" alt="How to do it…"/></div></li><li class="listitem">Finally, we <a id="id511" class="indexterm"/>need to add a parameter that will be used to specify the comma-delimited text file that will be used as an input in the creation of our new feature class. Enter the following information into your dialog box:<div class="mediaobject"><img src="images/4445_07_12.jpg" alt="How to do it…"/></div></li><li class="listitem">Click on <a id="id512" class="indexterm"/><span class="strong"><strong>Finish</strong></span>. The new script tool will be added to your <span class="strong"><strong>Wildfire Tools</strong></span> toolbox, as shown in the following screenshot:<div class="mediaobject"><img src="images/4445_07_5.jpg" alt="How to do it…"/></div></li><li class="listitem">Now, we'll test the tool to make sure it works. Double-click on the script tool to display the dialog box, as shown in the following screenshot:<div class="mediaobject"><img src="images/4445_07_6.jpg" alt="How to do it…"/></div></li><li class="listitem">Define a new output feature class, which should be loaded inside the existing <code class="literal">WildlandFires.mdb</code> personal geodatabase, as shown in the next screenshot. Click on the open folder icon and navigate to the <code class="literal">WildlandFires.mdb</code> personal geodatabase, which should be located in <code class="literal">c:\ArcpyBook\data\Wildfires</code>.</li><li class="listitem">You will also <a id="id513" class="indexterm"/>need to give your new feature class a name. In this case, we'll name the feature class <code class="literal">TodaysWildfires</code>, but the name can be whatever you'd like. In the following screenshot, you can see an example of how this should be done. Click on the <span class="strong"><strong>Save</strong></span> button:<div class="mediaobject"><img src="images/4445_07_16.jpg" alt="How to do it…"/></div></li><li class="listitem">For the attribute template, you will want to point to the <code class="literal">FireIncidents</code> feature class that has already been created for you. This feature class contains a field called <code class="literal">CONFIDENCEVAL</code>. This field will be created in our new feature class. Click on the <span class="strong"><strong>Browse</strong></span> button, navigate to <code class="literal">c:\ArcpyBook\data\Wildfires\WildlandFires.mdb</code>, and you should see the <code class="literal">FireIncidents</code> feature class. Select it and click on <span class="strong"><strong>Add</strong></span>.</li><li class="listitem">Finally, the <a id="id514" class="indexterm"/>last parameter needs to point to our comma-delimited text file containing wildland fires. This file can be found at: <code class="literal">c:\ArcpyBook\data\Wildfires\NorthAmericaWildfires_2007275.txt</code>. Click on the <span class="strong"><strong>Browse</strong></span> button and navigate to <code class="literal">c:\ArcpyBook\data\Wildfires</code>. Click on <code class="literal">NorthAmericaWildfires_2007275.txt</code> and click on the <span class="strong"><strong>Add</strong></span> button.<p>Your tool should appear as follows:</p><div class="mediaobject"><img src="images/4445_07_7.jpg" alt="How to do it…"/></div></li><li class="listitem">Click on <span class="strong"><strong>OK</strong></span> to execute the tool. Any messages will be written to the dialog box as shown in the following screenshot. This is a standard dialog box for any geoprocessing tool. If everything has been set up correctly, you should see the following screenshot, which shows that a new feature class will be added to the ArcMap display:<div class="mediaobject"><img src="images/4445_07_8.jpg" alt="How to do it…"/></div></li></ol></div><p>If everything is set up<a id="id515" class="indexterm"/> correctly, you should see the following screenshot, which shows that a new feature class will be added to the ArcMap display:</p><div class="mediaobject"><img src="images/4445_07_9.jpg" alt="How to do it…"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec136"/>How it works…</h2></div></div></div><p>Almost all script tools have parameters, and the values are set on the tool dialog box. When the tool is executed, the parameter values are sent to your script. Your script reads these values and then proceeds with its work. Python scripts can accept parameters as input. Parameters, also known as arguments, allow your scripts to become dynamic. Up to this point, all of our scripts have used hard coded values. By specifying input parameters for a script, you are able to supply the name of the feature class at run time. This capability makes your scripts more versatile. </p><p>The <code class="literal">GetParameterAsText()</code> method, which is used to capture parameter input, is zero-based with the first parameter entered occupying index <code class="literal">0</code>. Each successive parameter is incremented by 1. The output feature class that will be created by reading the comma-delimited text file is specified in the variable <code class="literal">outputFC</code>, which is retrieved by <code class="literal">GetParameterAsText(0)</code>. With <code class="literal">GetParameterAsText(1)</code>, we capture a feature class that will act as a template for the output feature class attribute schema. The attribute fields in the template feature class are used to define the fields that will populate our output feature class. Finally, <code class="literal">GetParameterAsText(2)</code> is used to create a variable called <code class="literal">f</code>, which will hold the comma-delimited text file that will be read.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec137"/>There's more...</h2></div></div></div><p>The <code class="literal">arcpy.GetParameterAsText()</code> method is <a id="id516" class="indexterm"/>not the only way to capture information passed into your script. When you call a Python script from the command line, you can pass in a set of arguments. When passing arguments to a script, each word must be separated by a space. These words are stored in a zero-based list object called <code class="literal">sys.argv</code>. With <code class="literal">sys.argv</code>, the first item in the list, referenced by index <code class="literal">0</code>, stores the name of the script. Each successive word is referenced by the next integer. Therefore, the first parameter will be stored in <code class="literal">sys.argv[1]</code>, the second in <code class="literal">sys.argv[2]</code>, and so on. These arguments can then be accessed from within your script.</p><p>It is recommended that you use the <code class="literal">GetParameterAsText()</code> function rather than <code class="literal">sys.argv</code>, because <code class="literal">GetParameterAsText()</code> does not have a character limit whereas <code class="literal">sys.argv</code> has a limit of 1,024 characters per parameter. In either case, once parameters have been read into the script, your script can continue execution using the input values. </p></div></div></div>
</body></html>