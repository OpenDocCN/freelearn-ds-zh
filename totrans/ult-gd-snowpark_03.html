<html><head></head><body>
<div id="_idContainer051" class="calibre2">
<h1 class="chapter-number" id="_idParaDest-29"><a id="_idTextAnchor028" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1.1">2</span></h1>
<h1 id="_idParaDest-30" class="calibre5"><a id="_idTextAnchor029" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.2.1">Establishing a Foundation with Snowpark</span></h1>
<p class="calibre3"><a id="_idTextAnchor030" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.3.1">In the previous chapter, you learned the basics of Snowpark, its benefits, and how it allows developers to develop complex data applications using Python. </span><span class="kobospan" id="kobo.3.2">This chapter will focus on establishing a solid foundation with Snowpark. </span><span class="kobospan" id="kobo.3.3">Here, you will learn how to configure and operate Snowpark, select a coding style and structure, and explore Snowpark’s fundamentals in depth. </span><span class="kobospan" id="kobo.3.4">This will help you acquire practical knowledge and skills to work efficiently with Snowpark, including setting up the environment, structuring the code, and utilizing it for </span><span><span class="kobospan" id="kobo.4.1">different workloads.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.5.1">In this chapter, we’re going to cover the following </span><span><span class="kobospan" id="kobo.6.1">main topics:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.7.1">Configuring the Snowpark </span><span><span class="kobospan" id="kobo.8.1">development environment</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.9.1">Operating </span><span><span class="kobospan" id="kobo.10.1">with Snowpark</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.11.1">Establishing a project structure </span><span><span class="kobospan" id="kobo.12.1">for Snowpark</span></span></li>
</ul>
<h1 id="_idParaDest-31" class="calibre5"><a id="_idTextAnchor031" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.13.1">Technical requirements</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.14.1">For this chapter, you’ll require an active Snowflake account and Python installed with Anaconda configured locally. </span><span class="kobospan" id="kobo.14.2">You can refer to the following documentation for </span><span><span class="kobospan" id="kobo.15.1">installation instructions:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.16.1">You can sign up for a Snowflake Trial account </span><span><span class="kobospan" id="kobo.17.1">at </span></span><a href="https://signup.snowflake.com/" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.18.1">https://signup.snowflake.com/</span></span></a></li>
<li class="calibre14"><span class="kobospan" id="kobo.19.1">To configure Anaconda, follow the guide at  </span><a href="https://code.visualstudio.com/docs/python/python-tutorial" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.20.1">https://conda.io/projects/conda/en/latest/user-guide/getting-started.html</span></span></a><span><span class="kobospan" id="kobo.21.1">.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.22.1">In addition, to install and set up Python for VS Code, follow the guide </span><span><span class="kobospan" id="kobo.23.1">at </span></span><a href="https://code.visualstudio.com/docs/python/python-tutorial" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.24.1">https://code.visualstudio.com/docs/python/python-tutorial</span></span></a></li>
<li class="calibre14"><span class="kobospan" id="kobo.25.1">To learn how to operate a Jupyter Notebook in VS Code, go </span><span><span class="kobospan" id="kobo.26.1">to </span></span><a href="https://code.visualstudio.com/docs/datascience/jupyter-notebooks" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.27.1">https://code.visualstudio.com/docs/datascience/jupyter-notebooks</span></span></a></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.28.1">The supporting materials for this chapter are available in this book’s GitHub repository </span><span><span class="kobospan" id="kobo.29.1">at </span></span><a href="https://github.com/PacktPublishing/The-Ultimate-Guide-To-Snowpark" class="calibre6 pcalibre1 pcalibre"><span><span class="kobospan" id="kobo.30.1">https://github.com/PacktPublishing/The-Ultimate-Guide-To-Snowpark</span></span></a><span><span class="kobospan" id="kobo.31.1">.</span></span></p>
<h1 id="_idParaDest-32" class="calibre5"><a id="_idTextAnchor032" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.32.1">Configuring the Snowpark development environment</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.33.1">The first </span><a id="_idIndexMarker028" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.34.1">step in developing Snowpark is to set up the Snowpark development environment. </span><span class="kobospan" id="kobo.34.2">Developers have much flexibility regarding </span><a id="_idIndexMarker029" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.35.1">which </span><strong class="bold"><span class="kobospan" id="kobo.36.1">integrated development environments</span></strong><span class="kobospan" id="kobo.37.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.38.1">IDEs</span></strong><span class="kobospan" id="kobo.39.1">) they can use to get started with Snowpark; the only thing they need to do is install the Snowpark client </span><strong class="bold"><span class="kobospan" id="kobo.40.1">application programmable interface</span></strong><span class="kobospan" id="kobo.41.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.42.1">API</span></strong><span class="kobospan" id="kobo.43.1">) and </span><a id="_idIndexMarker030" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.44.1">connect to their Snowflake account. </span><span class="kobospan" id="kobo.44.2">The development environment can be a local Python environment that contains your favorite IDE or the new Snowflake Python worksheets in Snowsight. </span><span class="kobospan" id="kobo.44.3">This section will cover setting up a Snowpark Python worksheet and the local </span><span><span class="kobospan" id="kobo.45.1">development environment.</span></span></p>
<h2 id="_idParaDest-33" class="calibre7"><a id="_idTextAnchor033" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.46.1">Snowpark Python worksheet</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.47.1">Snowflake</span><a id="_idIndexMarker031" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.48.1"> released </span><em class="italic"><span class="kobospan" id="kobo.49.1">Snowflake Worksheets for Python</span></em><span class="kobospan" id="kobo.50.1">, a new type of worksheet in Snowsight for developing</span><a id="_idIndexMarker032" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.51.1"> a Python-based Snowpark environment from within Snowflake. </span><span class="kobospan" id="kobo.51.2">This game-changing feature allows developers to easily leverage the power of Snowpark Python within Snowsight to perform </span><a id="_idIndexMarker033" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.52.1">data processing and create data pipelines, </span><strong class="bold"><span class="kobospan" id="kobo.53.1">machine learning</span></strong><span class="kobospan" id="kobo.54.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.55.1">ML</span></strong><span class="kobospan" id="kobo.56.1">) models, and applications by integrating Snowpark Python directly into the browser without setting up Python environments or installing open source libraries on the client. </span><span class="kobospan" id="kobo.56.2">Instead, developers can easily use pre-existing packages from Anaconda or import their own Python files from stages into the Worksheet. </span><span class="kobospan" id="kobo.56.3">In addition, they can quickly deploy the Python worksheets as a </span><span><span class="kobospan" id="kobo.57.1">stored procedure.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.58.1">Prerequisites for using Python worksheets</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.59.1">To enable and use Snowflake Python worksheets, you must first acknowledge the Anaconda</span><a id="_idIndexMarker034" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.60.1"> terms of service in Snowsight. </span><span class="kobospan" id="kobo.60.2">The following steps are to be performed by the </span><span><span class="kobospan" id="kobo.61.1">organization’s administrator:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.62.1">First, you must sign into your Snowflake account. </span><span class="kobospan" id="kobo.62.2">In the </span><strong class="bold"><span class="kobospan" id="kobo.63.1">Switch Role</span></strong><span class="kobospan" id="kobo.64.1"> section on the left panel, switch to the </span><strong class="bold"><span class="kobospan" id="kobo.65.1">ORGADMIN</span></strong><span class="kobospan" id="kobo.66.1"> role in the </span><span><span class="kobospan" id="kobo.67.1">user context:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer009">
<span class="kobospan" id="kobo.68.1"><img alt="Figure 2.1 – The ORGADMIN role in Snowflake" src="image/B19923_02_1.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.69.1">Figure 2.1 – The ORGADMIN role in Snowflake</span></p>
<ol class="calibre13">
<li value="2" class="calibre14"><span class="kobospan" id="kobo.70.1">Then, go to </span><strong class="bold"><span class="kobospan" id="kobo.71.1">Admin</span></strong><span class="kobospan" id="kobo.72.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.73.1">Billing &amp; </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.74.1">Terms</span></strong></span><span><span class="kobospan" id="kobo.75.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer010">
<span class="kobospan" id="kobo.76.1"><img alt="Figure 2.2 – Admin | Billing &amp; Terms" src="image/B19923_02_2.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.77.1">Figure 2.2 – Admin | Billing &amp; Terms</span></p>
<ol class="calibre13">
<li value="3" class="calibre14"><span class="kobospan" id="kobo.78.1">Click </span><strong class="bold"><span class="kobospan" id="kobo.79.1">Enable</span></strong><span class="kobospan" id="kobo.80.1"> next </span><a id="_idIndexMarker035" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.81.1">to </span><strong class="bold"><span class="kobospan" id="kobo.82.1">Anaconda </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.83.1">Python packages</span></strong></span><span><span class="kobospan" id="kobo.84.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer011">
<span class="kobospan" id="kobo.85.1"><img alt="Figure 2.3 – Enabling Anaconda Python packages" src="image/B19923_02_3.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.86.1">Figure 2.3 – Enabling Anaconda Python packages</span></p>
<ol class="calibre13">
<li value="4" class="calibre14"><span class="kobospan" id="kobo.87.1">You’ll get a popup, as shown in the following screenshot. </span><span class="kobospan" id="kobo.87.2">Click </span><strong class="bold"><span class="kobospan" id="kobo.88.1">Acknowledge &amp; Continue</span></strong><span class="kobospan" id="kobo.89.1"> to enable </span><span><span class="kobospan" id="kobo.90.1">the packages:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer012">
<span class="kobospan" id="kobo.91.1"><img alt="Figure 2.4 – Anaconda’s Terms and Services" src="image/B19923_02_4.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.92.1">Figure 2.4 – Anaconda’s Terms and Services</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.93.1">You’ll need to enable </span><a id="_idIndexMarker036" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.94.1">the Anaconda packages every time you create a new Snowflake environment. </span><span class="kobospan" id="kobo.94.2">Now that we’ve enabled the packages, let’s see how we can work with </span><span><span class="kobospan" id="kobo.95.1">Python worksheets.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.96.1">Database and schema creation in Snowflake Snowsight</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.97.1">To create </span><a id="_idIndexMarker037" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.98.1">a database called </span><strong class="source-inline"><span class="kobospan" id="kobo.99.1">SNOWPARK_DEFINITIVE_GUIDE</span></strong><span class="kobospan" id="kobo.100.1"> and a schema called </span><strong class="source-inline"><span class="kobospan" id="kobo.101.1">MY_SCHEMA</span></strong><span class="kobospan" id="kobo.102.1"> using Snowflake’s Snowsight UI interface, perform the </span><span><span class="kobospan" id="kobo.103.1">following steps:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.104.1">Go to the Snowsight web interface, log in using your Snowflake credentials, and navigate to the </span><strong class="bold"><span class="kobospan" id="kobo.105.1">Data</span></strong><span class="kobospan" id="kobo.106.1"> | </span><strong class="bold"><span class="kobospan" id="kobo.107.1">Databases</span></strong><span class="kobospan" id="kobo.108.1"> section. </span><span class="kobospan" id="kobo.108.2">This is typically located in the left-hand </span><span><span class="kobospan" id="kobo.109.1">navigation menu:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer013">
<span class="kobospan" id="kobo.110.1"><img alt="Figure 2.5 – The Databases section" src="image/B19923_02_5.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.111.1">Figure 2.5 – The Databases section</span></p>
<ol class="calibre13">
<li value="2" class="calibre14"><span class="kobospan" id="kobo.112.1">Look for a</span><a id="_idIndexMarker038" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.113.1"> button or link that says </span><strong class="bold"><span class="kobospan" id="kobo.114.1">+ Database</span></strong><span class="kobospan" id="kobo.115.1"> in the top-right corner and click it. </span><span class="kobospan" id="kobo.115.2">In the dialogue box that appears, enter </span><strong class="source-inline1"><span class="kobospan" id="kobo.116.1">SNOWPARK_DEFINITIVE_GUIDE</span></strong><span class="kobospan" id="kobo.117.1"> as the name for the new database. </span><span class="kobospan" id="kobo.117.2">Optionally, you can specify other settings, such as </span><strong class="bold"><span class="kobospan" id="kobo.118.1">Comment</span></strong><span class="kobospan" id="kobo.119.1">, if needed, and </span><span><span class="kobospan" id="kobo.120.1">click </span></span><span><strong class="bold"><span class="kobospan" id="kobo.121.1">Create</span></strong></span><span><span class="kobospan" id="kobo.122.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer014">
<span class="kobospan" id="kobo.123.1"><img alt="Figure 2.6 – The New Database dialogue" src="image/B19923_02_6.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.124.1">Figure 2.6 – The New Database dialogue</span></p>
<ol class="calibre13">
<li value="3" class="calibre14"><span class="kobospan" id="kobo.125.1">After creating the database, click on the </span><strong class="source-inline1"><span class="kobospan" id="kobo.126.1">SNOWPARK_DEFINITIVE_GUIDE</span></strong><span class="kobospan" id="kobo.127.1"> database. </span><span class="kobospan" id="kobo.127.2">This will take you to the </span><span><span class="kobospan" id="kobo.128.1">following page:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer015">
<span class="kobospan" id="kobo.129.1"><img alt="Figure 2.7 – The SNOWPARK_DEFINTIVE_GUIDE page" src="image/B19923_02_7.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.130.1">Figure 2.7 – The SNOWPARK_DEFINTIVE_GUIDE page</span></p>
<ol class="calibre13">
<li value="4" class="calibre14"><span class="kobospan" id="kobo.131.1">On this </span><a id="_idIndexMarker039" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.132.1">page, look for a button or link that says </span><strong class="bold"><span class="kobospan" id="kobo.133.1">+ Schema</span></strong><span class="kobospan" id="kobo.134.1"> and click on it. </span><span class="kobospan" id="kobo.134.2">In the dialogue box that appears, enter </span><strong class="source-inline1"><span class="kobospan" id="kobo.135.1">MY_SCHEMA</span></strong><span class="kobospan" id="kobo.136.1"> as the name for the new schema. </span><span class="kobospan" id="kobo.136.2">Optionally, you can specify other settings, such as </span><strong class="bold"><span class="kobospan" id="kobo.137.1">Comment</span></strong><span class="kobospan" id="kobo.138.1"> and </span><strong class="bold"><span class="kobospan" id="kobo.139.1">Managed access</span></strong><span class="kobospan" id="kobo.140.1">. </span><span class="kobospan" id="kobo.140.2">Click </span><strong class="bold"><span class="kobospan" id="kobo.141.1">Create</span></strong><span class="kobospan" id="kobo.142.1"> to create </span><span><span class="kobospan" id="kobo.143.1">the schema:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer016">
<span class="kobospan" id="kobo.144.1"><img alt="Figure 2.8 – The New Schema dialogue" src="image/B19923_02_8.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.145.1">Figure 2.8 – The New Schema dialogue</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.146.1">We’ll consistently utilize the same database and schema throughout this book unless explicitly instructed otherwise in </span><span><span class="kobospan" id="kobo.147.1">specific chapters.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.148.1">Working with Python worksheets in Snowflake</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.149.1">Python worksheets </span><a id="_idIndexMarker040" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.150.1">come with a sample code template that can be used as a starter. </span><span class="kobospan" id="kobo.150.2">The whole experience is embedded in Snowflake based on the Snowsight UI. </span><span class="kobospan" id="kobo.150.3">Perform the following steps to create and work with Python worksheets </span><span><span class="kobospan" id="kobo.151.1">in Snowflake:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.152.1">Navigate to the </span><strong class="bold"><span class="kobospan" id="kobo.153.1">Worksheets</span></strong><span class="kobospan" id="kobo.154.1"> section from the menu in the </span><span><span class="kobospan" id="kobo.155.1">Snowsight UI:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer017">
<span class="kobospan" id="kobo.156.1"><img alt="Figure 2.9 – The Worksheets menu option" src="image/B19923_02_9.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.157.1">Figure 2.9 – The Worksheets menu option</span></p>
<ol class="calibre13">
<li value="2" class="calibre14"><span class="kobospan" id="kobo.158.1">On the </span><strong class="bold"><span class="kobospan" id="kobo.159.1">Worksheets</span></strong><span class="kobospan" id="kobo.160.1"> pane, click the </span><strong class="bold"><span class="kobospan" id="kobo.161.1">+</span></strong><span class="kobospan" id="kobo.162.1"> icon on the right and select </span><strong class="bold"><span class="kobospan" id="kobo.163.1">Python Worksheet</span></strong><span class="kobospan" id="kobo.164.1"> to create a </span><span><span class="kobospan" id="kobo.165.1">Python worksheet:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer018">
<span class="kobospan" id="kobo.166.1"><img alt="Figure 2.10 – Creating a Python worksheet" src="image/B19923_02_10.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.167.1">Figure 2.10 – Creating a Python worksheet</span></p>
<ol class="calibre13">
<li value="3" class="calibre14"><span class="kobospan" id="kobo.168.1">Select a database and schema so that you can work in the worksheet context. </span><span class="kobospan" id="kobo.168.2">The scope of the Python code will operate based on </span><span><span class="kobospan" id="kobo.169.1">these details:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer019">
<span class="kobospan" id="kobo.170.1"><img alt="Figure 2.11 – Worksheet context" src="image/B19923_02_11.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.171.1">Figure 2.11 – Worksheet context</span></p>
<ol class="calibre13">
<li value="4" class="calibre14"><span class="kobospan" id="kobo.172.1">The</span><a id="_idIndexMarker041" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.173.1"> worksheet has a handler function that’s invoked when the worksheet is executed. </span><span class="kobospan" id="kobo.173.2">The </span><strong class="bold"><span class="kobospan" id="kobo.174.1">Settings</span></strong><span class="kobospan" id="kobo.175.1"> menu allows you to configure your worksheets. </span><span class="kobospan" id="kobo.175.2">The default handler function is </span><strong class="source-inline1"><span class="kobospan" id="kobo.176.1">main()</span></strong><span class="kobospan" id="kobo.177.1">, and the return type can be specified as </span><strong class="source-inline1"><span class="kobospan" id="kobo.178.1">Table()</span></strong><span class="kobospan" id="kobo.179.1">, </span><strong class="source-inline1"><span class="kobospan" id="kobo.180.1">Variant</span></strong><span class="kobospan" id="kobo.181.1">, or </span><strong class="source-inline1"><span class="kobospan" id="kobo.182.1">String</span></strong><span class="kobospan" id="kobo.183.1">. </span><span class="kobospan" id="kobo.183.2">The result will be shown in the format </span><span><span class="kobospan" id="kobo.184.1">you choose:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer020">
<span class="kobospan" id="kobo.185.1"><img alt="Figure 2.12 – Worksheet settings" src="image/B19923_02_12.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.186.1">Figure 2.12 – Worksheet settings</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.187.1">Worksheet preferences such as linting and line wrapping can also be </span><span><span class="kobospan" id="kobo.188.1">customized here.</span></span></p>
<ol class="calibre13">
<li value="5" class="calibre14"><span class="kobospan" id="kobo.189.1">The Python code can be executed by clicking on the </span><strong class="bold"><span class="kobospan" id="kobo.190.1">RUN</span></strong><span class="kobospan" id="kobo.191.1"> button at the top right of </span><span><span class="kobospan" id="kobo.192.1">the worksheet:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer021">
<span class="kobospan" id="kobo.193.1"><img alt="Figure 2.13 – Executing the worksheet" src="image/B19923_02_13.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.194.1">Figure 2.13 – Executing the worksheet</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.195.1">You can</span><a id="_idIndexMarker042" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.196.1"> start developing and executing the Python code within the worksheet to see </span><span><span class="kobospan" id="kobo.197.1">the results.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.198.1">Managing Anaconda packages in Python worksheets</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.199.1">Python worksheets </span><a id="_idIndexMarker043" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.200.1">come with an </span><a id="_idIndexMarker044" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.201.1">integrated Anaconda environment that supports importing the most common Anaconda libraries without having to worry about managing dependencies. </span><span class="kobospan" id="kobo.201.2">It also supports importing custom packages from the internal stage. </span><span class="kobospan" id="kobo.201.3">In this section, we will look at managing Anaconda packages in Python. </span><span class="kobospan" id="kobo.201.4">To do this, perform the </span><span><span class="kobospan" id="kobo.202.1">following steps:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.203.1">Navigate to the </span><strong class="bold"><span class="kobospan" id="kobo.204.1">Packages</span></strong><span class="kobospan" id="kobo.205.1"> tab from the menu and select </span><strong class="bold"><span class="kobospan" id="kobo.206.1">Anaconda Packages</span></strong><span class="kobospan" id="kobo.207.1">. </span><span class="kobospan" id="kobo.207.2">This will show a list of pre-installed packages and </span><span><span class="kobospan" id="kobo.208.1">their versions:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer022">
<span class="kobospan" id="kobo.209.1"><img alt="Figure 2.14 – Anaconda Packages" src="image/B19923_02_14.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.210.1">Figure 2.14 – Anaconda Packages</span></p>
<ol class="calibre13">
<li value="2" class="calibre14"><span class="kobospan" id="kobo.211.1">You can </span><a id="_idIndexMarker045" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.212.1">search for </span><a id="_idIndexMarker046" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.213.1">and install the required packages by using the </span><span><span class="kobospan" id="kobo.214.1">search bar:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer023">
<span class="kobospan" id="kobo.215.1"><img alt="Figure 2.15 – Searching for packages" src="image/B19923_02_15.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.216.1">Figure 2.15 – Searching for packages</span></p>
<ol class="calibre13">
<li value="3" class="calibre14"><span class="kobospan" id="kobo.217.1">You can also modify the version of the packages by selecting the available versions</span><a id="_idIndexMarker047" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.218.1"> from the </span><a id="_idIndexMarker048" class="calibre6 pcalibre1 pcalibre"/><span><span class="kobospan" id="kobo.219.1">respective dropdown:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer024">
<span class="kobospan" id="kobo.220.1"><img alt="Figure 2.16 – Package versioning" src="image/B19923_02_16.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.221.1">Figure 2.16 – Package versioning</span></p>
<ol class="calibre13">
<li value="4" class="calibre14"><span class="kobospan" id="kobo.222.1">You can execute the following query to check the available Python packages in Snowflake </span><span><span class="kobospan" id="kobo.223.1">using SQL:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.224.1">
SELECT distinct package_name
FROM information_schema.packages
WHERE language = 'python';</span></pre><p class="calibre3"><span class="kobospan" id="kobo.225.1">This query obtains the results from the packages view in the </span><span><span class="kobospan" id="kobo.226.1">information schema:</span></span></p></li> </ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer025">
<span class="kobospan" id="kobo.227.1"><img alt="Figure 2.17 – Anaconda packages query" src="image/B19923_02_17.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.228.1">Figure 2.17 – Anaconda packages query</span></p>
<ol class="calibre13">
<li value="5" class="calibre14"><span class="kobospan" id="kobo.229.1">If you </span><a id="_idIndexMarker049" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.230.1">need to check the </span><a id="_idIndexMarker050" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.231.1">version information of specific packages, you can filter the query by the </span><span><span class="kobospan" id="kobo.232.1">package’s name:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.233.1">
SELECT *
FROM information_schema.packages
WHERE (package_name='numpy' AND language = 'python');</span></pre><p class="calibre3"><span class="kobospan" id="kobo.234.1">The output of the preceding code is </span><span><span class="kobospan" id="kobo.235.1">as follows:</span></span></p></li> </ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer026">
<span class="kobospan" id="kobo.236.1"><img alt="Figure 2.18 – Anaconda Python package query" src="image/B19923_02_18.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.237.1">Figure 2.18 – Anaconda Python package query</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.238.1">This query shows the list of Anaconda packages that are available in my account. </span><span class="kobospan" id="kobo.238.2">In the next section, we’ll learn how to manage custom </span><span><span class="kobospan" id="kobo.239.1">Python packages.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.240.1">Managing custom packages in Python worksheets</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.241.1">Python worksheets </span><a id="_idIndexMarker051" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.242.1">also support the ability to import custom Python packages that can be used in Python code. </span><span class="kobospan" id="kobo.242.2">However, the package must be uploaded into the internal stage, which is the storage part of the Snowflake account, and imported from it. </span><span class="kobospan" id="kobo.242.3">In Snowsight, you can load files into a </span><a id="_idIndexMarker052" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.243.1">named internal stage area, allowing you to conveniently view and utilize them within your Python worksheets or load the data into a table using SQL. </span><span class="kobospan" id="kobo.243.2">However, it’s important to note that Snowsight does not support loading files into user or </span><span><span class="kobospan" id="kobo.244.1">table stages.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.245.1">To create a named internal stage, ensure that the role you are using has the </span><strong class="bold"><span class="kobospan" id="kobo.246.1">USAGE</span></strong><span class="kobospan" id="kobo.247.1"> privilege on the relevant database and schema and the </span><strong class="bold"><span class="kobospan" id="kobo.248.1">CREATE STAGE</span></strong><span class="kobospan" id="kobo.249.1"> privilege on the schema. </span><span><span class="kobospan" id="kobo.250.1">Let’s begin:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.251.1">Sign in </span><span><span class="kobospan" id="kobo.252.1">to Snowsight.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.253.1">Access the </span><strong class="bold"><span class="kobospan" id="kobo.254.1">Data</span></strong><span class="kobospan" id="kobo.255.1"> section and navigate </span><span><span class="kobospan" id="kobo.256.1">to </span></span><span><strong class="bold"><span class="kobospan" id="kobo.257.1">Databases</span></strong></span><span><span class="kobospan" id="kobo.258.1">.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.259.1">Choose the desired database and schema where you want to create the stage and </span><span><span class="kobospan" id="kobo.260.1">load files.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.261.1">Click </span><strong class="bold"><span class="kobospan" id="kobo.262.1">Create</span></strong><span class="kobospan" id="kobo.263.1">, select </span><strong class="bold"><span class="kobospan" id="kobo.264.1">Stage</span></strong><span class="kobospan" id="kobo.265.1">, and click </span><span><strong class="bold"><span class="kobospan" id="kobo.266.1">Snowflake Managed</span></strong></span><span><span class="kobospan" id="kobo.267.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer027">
<span class="kobospan" id="kobo.268.1"><img alt="Figure 2.19 – Creating a stage" src="image/B19923_02_19.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.269.1">Figure 2.19 – Creating a stage</span></p>
<ol class="calibre13">
<li value="5" class="calibre14"><span class="kobospan" id="kobo.270.1">Provide a name for the stage and opt-in to enable a directory table for the stage, allowing you to visualize the files. </span><span class="kobospan" id="kobo.270.2">Once you’re done, </span><span><span class="kobospan" id="kobo.271.1">click </span></span><span><strong class="bold"><span class="kobospan" id="kobo.272.1">Create</span></strong></span><span><span class="kobospan" id="kobo.273.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer028">
<span class="kobospan" id="kobo.274.1"><img alt="Figure 2.20 – Creating an internal stage" src="image/B19923_02_20.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.275.1">Figure 2.20 – Creating an internal stage</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.276.1">To load </span><a id="_idIndexMarker053" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.277.1">files into a Snowflake-managed </span><a id="_idIndexMarker054" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.278.1">named internal stage using Snowsight, follow </span><span><span class="kobospan" id="kobo.279.1">these steps:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.280.1">Access the </span><strong class="bold"><span class="kobospan" id="kobo.281.1">Data</span></strong><span class="kobospan" id="kobo.282.1"> section and </span><span><span class="kobospan" id="kobo.283.1">select </span></span><span><strong class="bold"><span class="kobospan" id="kobo.284.1">Databases</span></strong></span><span><span class="kobospan" id="kobo.285.1">.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.286.1">Choose the database schema where you created the stage and select the </span><span><span class="kobospan" id="kobo.287.1">stage itself.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.288.1">Click </span><strong class="bold"><span class="kobospan" id="kobo.289.1">+ Files</span></strong><span class="kobospan" id="kobo.290.1"> to load the desired files into </span><span><span class="kobospan" id="kobo.291.1">the stage.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.292.1">In the </span><strong class="bold"><span class="kobospan" id="kobo.293.1">Upload Your Files</span></strong><span class="kobospan" id="kobo.294.1"> dialogue that appears, select the files you want to upload (multiple files can be </span><span><span class="kobospan" id="kobo.295.1">selected simultaneously):</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer029">
<span class="kobospan" id="kobo.296.1"><img alt="Figure 2.21 – Uploading a custom package" src="image/B19923_02_21.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.297.1">Figure 2.21 – Uploading a custom package</span></p>
<ol class="calibre13">
<li value="5" class="calibre14"><span class="kobospan" id="kobo.298.1">Optionally, specify</span><a id="_idIndexMarker055" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.299.1"> or </span><a id="_idIndexMarker056" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.300.1">create a path within the stage where you want to store </span><span><span class="kobospan" id="kobo.301.1">the files.</span></span></li>
<li class="calibre14"><span><span class="kobospan" id="kobo.302.1">Click </span></span><span><strong class="bold"><span class="kobospan" id="kobo.303.1">Upload</span></strong></span><span><span class="kobospan" id="kobo.304.1">.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.305.1">Once the files have been successfully loaded into the stage, you can perform various actions, depending on </span><span><span class="kobospan" id="kobo.306.1">your requirements.</span></span></li>
</ol>
<p class="calibre3"><span class="kobospan" id="kobo.307.1">With that, the package has been uploaded into the stage and is ready to </span><span><span class="kobospan" id="kobo.308.1">be imported.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.309.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.310.1">The maximum permissible file size is 50 MB. </span><span class="kobospan" id="kobo.310.2">You need a role with the </span><strong class="bold"><span class="kobospan" id="kobo.311.1">USAGE</span></strong><span class="kobospan" id="kobo.312.1"> privilege on the database and schema and the </span><strong class="bold"><span class="kobospan" id="kobo.313.1">WRITE</span></strong><span class="kobospan" id="kobo.314.1"> privilege on </span><span><span class="kobospan" id="kobo.315.1">the stage.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.316.1">Once the stage has been created and the package has been uploaded, you can import the module so that you can use it in the program. </span><span class="kobospan" id="kobo.316.2">To import a package, follow </span><span><span class="kobospan" id="kobo.317.1">these steps:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.318.1">From the </span><strong class="bold"><span class="kobospan" id="kobo.319.1">Packages</span></strong><span class="kobospan" id="kobo.320.1"> menu, select </span><span><strong class="bold"><span class="kobospan" id="kobo.321.1">Stage Packages</span></strong></span><span><span class="kobospan" id="kobo.322.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer030">
<span class="kobospan" id="kobo.323.1"><img alt="Figure 2.22 – Stage Packages" src="image/B19923_02_22.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.324.1">Figure 2.22 – Stage Packages</span></p>
<ol class="calibre13">
<li value="2" class="calibre14"><span class="kobospan" id="kobo.325.1">Enter</span><a id="_idIndexMarker057" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.326.1"> the path to the </span><a id="_idIndexMarker058" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.327.1">package. </span><span class="kobospan" id="kobo.327.2">You can refer to the stage in the same database and schema using </span><strong class="source-inline1"><span class="kobospan" id="kobo.328.1">@Stage/path/to/package.py</span></strong><span class="kobospan" id="kobo.329.1">. </span><span class="kobospan" id="kobo.329.2">If the stage is in a different database and schema, you can </span><span><span class="kobospan" id="kobo.330.1">use </span></span><span><strong class="source-inline1"><span class="kobospan" id="kobo.331.1">@Database.Schema.Stage/path/to/package.py</span></strong></span><span><span class="kobospan" id="kobo.332.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer031">
<span class="kobospan" id="kobo.333.1"><img alt="Figure 2.23 – Importing a stage package" src="image/B19923_02_23.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.334.1">Figure 2.23 – Importing a stage package</span></p>
<ol class="calibre13">
<li value="3" class="calibre14"><span class="kobospan" id="kobo.335.1">Click </span><strong class="bold"><span class="kobospan" id="kobo.336.1">Import</span></strong><span class="kobospan" id="kobo.337.1"> to install the package. </span><span class="kobospan" id="kobo.337.2">The module will now be visible under </span><span><strong class="bold"><span class="kobospan" id="kobo.338.1">Installed Packages</span></strong></span><span><span class="kobospan" id="kobo.339.1">:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer032">
<span class="kobospan" id="kobo.340.1"><img alt="Figure 2.24 – Installing a stage package" src="image/B19923_02_24.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.341.1">Figure 2.24 – Installing a stage package</span></p>
<ol class="calibre13">
<li value="4" class="calibre14"><span class="kobospan" id="kobo.342.1">You can</span><a id="_idIndexMarker059" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.343.1"> import the package </span><a id="_idIndexMarker060" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.344.1">into your code by using </span><strong class="source-inline1"><span class="kobospan" id="kobo.345.1">import &lt;</span></strong><span><strong class="source-inline1"><span class="kobospan" id="kobo.346.1">package name&gt;</span></strong></span><span><span class="kobospan" id="kobo.347.1">.</span></span></li>
</ol>
<p class="calibre3"><span class="kobospan" id="kobo.348.1">In the next section, we will cover how to deploy a Python stored procedure using </span><span><span class="kobospan" id="kobo.349.1">the UI.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.350.1">Deploying a Python stored procedure</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.351.1">The </span><a id="_idIndexMarker061" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.352.1">Python script in our worksheet can be seamlessly deployed as a stored procedure. </span><span class="kobospan" id="kobo.352.2">This can then be used in a</span><a id="_idIndexMarker062" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.353.1"> regular SQL context or scheduled to execute as a task. </span><span class="kobospan" id="kobo.353.2">To deploy a stored procedure, follow </span><span><span class="kobospan" id="kobo.354.1">these steps:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.355.1">Click the </span><strong class="bold"><span class="kobospan" id="kobo.356.1">Deploy</span></strong><span class="kobospan" id="kobo.357.1"> button at the top right of </span><span><span class="kobospan" id="kobo.358.1">the worksheet.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.359.1">Give the stored procedure a name; an optional comment can also be specified that provides information about it. </span><span class="kobospan" id="kobo.359.2">If the stored procedure already exists, then check the </span><strong class="bold"><span class="kobospan" id="kobo.360.1">Replace if exists</span></strong><span class="kobospan" id="kobo.361.1"> box to replace the existing </span><span><span class="kobospan" id="kobo.362.1">stored procedure:</span></span></li>
</ol>
<div class="calibre2">
<div class="img---figure" id="_idContainer033">
<span class="kobospan" id="kobo.363.1"><img alt="Figure 2.25 – Deploying a stored procedure" src="image/B19923_02_25.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.364.1">Figure 2.25 – Deploying a stored procedure</span></p>
<ol class="calibre13">
<li value="3" class="calibre14"><span class="kobospan" id="kobo.365.1">Click </span><strong class="bold"><span class="kobospan" id="kobo.366.1">Deploy</span></strong><span class="kobospan" id="kobo.367.1"> to deploy the stored procedure. </span><span class="kobospan" id="kobo.367.2">It will be deployed under the database </span><a id="_idIndexMarker063" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.368.1">and </span><a id="_idIndexMarker064" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.369.1">schema you provided in the </span><span><span class="kobospan" id="kobo.370.1">worksheet context.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.371.1">The stored procedure can now be executed in your worksheets using the </span><span><span class="kobospan" id="kobo.372.1">following code:</span></span><pre class="source-code"><span class="kobospan1" id="kobo.373.1">
CALL DATABASE.SCHEMA.MY_STORED_PROCEDURE();</span></pre></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.374.1">In the next section, we will cover the various features of </span><span><span class="kobospan" id="kobo.375.1">Python worksheets.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.376.1">Features of Python worksheets</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.377.1">Python worksheets </span><a id="_idIndexMarker065" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.378.1">consist of some features that are developer-friendly and support productivity. </span><span class="kobospan" id="kobo.378.2">Here are some of the distinct characteristics of </span><span><span class="kobospan" id="kobo.379.1">Python worksheets:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.380.1">Interactive Python environment</span></strong><span class="kobospan" id="kobo.381.1">: Worksheets </span><a id="_idIndexMarker066" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.382.1">support the Python language and support Snowpark </span><strong class="bold"><span class="kobospan" id="kobo.383.1">user-defined functions</span></strong><span class="kobospan" id="kobo.384.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.385.1">UDFs</span></strong><span class="kobospan" id="kobo.386.1">) and stored procedures. </span><span class="kobospan" id="kobo.386.2">Features </span><a id="_idIndexMarker067" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.387.1">such as syntax highlighting, type-sensitive autocomplete for keywords, and handy diagnostics such as undeclared variables or invalid method usage help increase </span><span><span class="kobospan" id="kobo.388.1">developers’ productivity:</span></span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer034">
<span class="kobospan" id="kobo.389.1"><img alt="Figure 2.26 – Interactive Python environment" src="image/B19923_02_26.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.390.1">Figure 2.26 – Interactive Python environment</span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.391.1">Python libraries support</span></strong><span class="kobospan" id="kobo.392.1">: Python</span><a id="_idIndexMarker068" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.393.1"> worksheets come with an integrated Anaconda</span><a id="_idIndexMarker069" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.394.1"> environment that supports importing the most common Anaconda libraries without the need to worry about managing dependencies. </span><span class="kobospan" id="kobo.394.2">It also supports importing custom packages from the </span><span><span class="kobospan" id="kobo.395.1">internal stage.</span></span></li>
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.396.1">Snowpark debugging</span></strong><span class="kobospan" id="kobo.397.1">: Python </span><a id="_idIndexMarker070" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.398.1">worksheets can display the results from a DataFrame inside Snowsight using the </span><strong class="source-inline1"><span class="kobospan" id="kobo.399.1">show()</span></strong><span class="kobospan" id="kobo.400.1"> or </span><strong class="source-inline1"><span class="kobospan" id="kobo.401.1">print()</span></strong><span class="kobospan" id="kobo.402.1"> function. </span><span class="kobospan" id="kobo.402.2">The preview of the DataFrame can also be returned to display the output in tabular format, which is very useful when it comes to debugging </span><span><span class="kobospan" id="kobo.403.1">Python programs:</span></span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer035">
<span class="kobospan" id="kobo.404.1"><img alt="Figure 2.27 –  Snowpark debugging" src="image/B19923_02_27.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.405.1">Figure 2.27 –  Snowpark debugging</span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.406.1">Collaboration</span></strong><span class="kobospan" id="kobo.407.1">: Snowpark </span><a id="_idIndexMarker071" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.408.1">Python worksheets can be shared with developers. </span><span class="kobospan" id="kobo.408.2">This makes collaboration much easier as multiple developers can access and work on the worksheet at the </span><span><span class="kobospan" id="kobo.409.1">same time:</span></span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer036">
<span class="kobospan" id="kobo.410.1"><img alt="Figure 2.28 – Worksheet collaboration" src="image/B19923_02_28.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.411.1">Figure 2.28 – Worksheet collaboration</span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="bold"><span class="kobospan" id="kobo.412.1">Charts and data exploration</span></strong><span class="kobospan" id="kobo.413.1">: Python</span><a id="_idIndexMarker072" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.414.1"> worksheets provide a convenient way to visualize </span><a id="_idIndexMarker073" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.415.1">data and DataFrames as charts, which helps with data exploration and provides an easy way to analyze the </span><span><span class="kobospan" id="kobo.416.1">data quickly:</span></span></li>
</ul>
<div class="calibre2">
<div class="img---figure" id="_idContainer037">
<span class="kobospan" id="kobo.417.1"><img alt="Figure 2.29 – Charts and data exploration" src="image/B19923_02_29.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.418.1">Figure 2.29 – Charts and data exploration</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.419.1">In the next section, we will cover the limitations of </span><span><span class="kobospan" id="kobo.420.1">Python worksheets.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.421.1">Limitations of Python worksheets</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.422.1">Python worksheets are relatively new in Snowsight and have some limitations in terms of functionality. </span><span class="kobospan" id="kobo.422.2">Let’s </span><a id="_idIndexMarker074" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.423.1">take a </span><span><span class="kobospan" id="kobo.424.1">closer look:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><span class="kobospan" id="kobo.425.1">Logging levels lower than </span><strong class="bold"><span class="kobospan" id="kobo.426.1">WARN</span></strong><span class="kobospan" id="kobo.427.1"> do not appear in the </span><strong class="bold"><span class="kobospan" id="kobo.428.1">Results</span></strong><span class="kobospan" id="kobo.429.1"> area </span><span><span class="kobospan" id="kobo.430.1">by default.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.431.1">Python worksheets do not support breakpoints or selective execution of the portions of code. </span><span class="kobospan" id="kobo.431.2">Instead, the entire code is run in </span><span><span class="kobospan" id="kobo.432.1">the worksheet.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.433.1">The Python worksheet cannot display images or other artifacts of the Python code it generates. </span><span class="kobospan" id="kobo.433.2">It can only show results that are returned through </span><span><span class="kobospan" id="kobo.434.1">the DataFrame.</span></span></li>
<li class="calibre14"><span class="kobospan" id="kobo.435.1">It only supports Python 3.8 and libraries that use </span><span><span class="kobospan" id="kobo.436.1">Python 3.8.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.437.1">Snowflake constantly updates features for Python worksheets, improving them for developers. </span><span class="kobospan" id="kobo.437.2">As a result, Python worksheets make it easier and faster for developers to code in Python from within the </span><span><span class="kobospan" id="kobo.438.1">Snowflake environment.</span></span></p>
<h2 id="_idParaDest-34" class="calibre7"><a id="_idTextAnchor034" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.439.1">Snowpark development in a local environment</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.440.1">Snowpark can </span><a id="_idIndexMarker075" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.441.1">also be developed conveniently from a local environment with your favorite IDE. </span><span class="kobospan" id="kobo.441.2">The key benefit of Snowflake’s partnership with Anaconda is Anaconda’s Snowflake Snowpark for Python channel, which contains the necessary Python packages to run Snowpark. </span><span class="kobospan" id="kobo.441.3">To use this channel, Anaconda or Miniconda should be installed and set up on the machine. </span><span class="kobospan" id="kobo.441.4">In this section, we will walk you through how to set up Snowpark in your local development environment </span><span><span class="kobospan" id="kobo.442.1">using Anaconda.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.443.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.444.1">This book will utilize Anaconda for Snowpark development as it is the recommended approach and utilizes the benefits of Anaconda’s package manager to easily set up and manage the Snowpark </span><span><span class="kobospan" id="kobo.445.1">development environment.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.446.1">The Snowpark API requires Python 3.8 to be installed. </span><span class="kobospan" id="kobo.446.2">Snowflake recommends that you use Anaconda for easy package management. </span><span class="kobospan" id="kobo.446.3">You can check out the Python version you have by running the following command</span><a id="_idIndexMarker076" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.447.1"> in the </span><strong class="bold"><span class="kobospan" id="kobo.448.1">command-line </span></strong><span><strong class="bold"><span class="kobospan" id="kobo.449.1">interface</span></strong></span><span><span class="kobospan" id="kobo.450.1"> (</span></span><span><strong class="bold"><span class="kobospan" id="kobo.451.1">CLI</span></strong></span><span><span class="kobospan" id="kobo.452.1">):</span></span></p>
<pre class="console"><span class="kobospan1" id="kobo.453.1">
python –-version</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.454.1">Your output should look similar to </span><span><span class="kobospan" id="kobo.455.1">the following:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer038">
<span class="kobospan" id="kobo.456.1"><img alt="Figure 2.30 – Python CLI version" src="image/B19923_02_30.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.457.1">Figure 2.30 – Python CLI version</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.458.1">You can also </span><a id="_idIndexMarker077" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.459.1">check the Python version from within the Python code by running the </span><span><span class="kobospan" id="kobo.460.1">following command:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.461.1">
from platform import python_version
print(python_version())</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.462.1">This will print an output similar to </span><span><span class="kobospan" id="kobo.463.1">the following:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer039">
<span class="kobospan" id="kobo.464.1"><img alt="Figure 2.31 – Python version" src="image/B19923_02_31.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.465.1">Figure 2.31 – Python version</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.466.1">Once Python has been installed, the virtual environment needs to be created. </span><span class="kobospan" id="kobo.466.2">So, let’s </span><span><span class="kobospan" id="kobo.467.1">create one.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.468.1">Creating a virtual environment</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.469.1">It’s</span><a id="_idIndexMarker078" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.470.1"> recommended that you create a Python virtual environment to ensure a seamless developer experience when working with Snowpark; it isolates the Snowpark API and allows you to manage all dependencies that are required for development. </span><span class="kobospan" id="kobo.470.2">To create a virtual environment using Anaconda, run the </span><span><span class="kobospan" id="kobo.471.1">following command:</span></span></p>
<pre class="console"><span class="kobospan1" id="kobo.472.1">
conda create --name def_gui_3.8_env --override-channels --channel https://repo.anaconda.com/pkgs/snowflake python=3.8</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.473.1">This command</span><a id="_idIndexMarker079" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.474.1"> creates a new Python virtual environment named </span><strong class="source-inline"><span class="kobospan" id="kobo.475.1">def_gui_3.8_env</span></strong><span class="kobospan" id="kobo.476.1"> with Python 3.8 and installs the necessary packages, such as </span><strong class="source-inline"><span class="kobospan" id="kobo.477.1">numpy</span></strong><span class="kobospan" id="kobo.478.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.479.1">pandas</span></strong><span class="kobospan" id="kobo.480.1">, from Anaconda’s </span><span><span class="kobospan" id="kobo.481.1">Snowflake channel.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.482.1">Installing the Snowpark Python package</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.483.1">Before installing the package, let's activate our Python virtual environment using the </span><span><span class="kobospan" id="kobo.484.1">following command:</span></span></p>
<pre class="console"><span class="kobospan1" id="kobo.485.1">
conda activate def_gui_3.8_env</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.486.1">The Snowpark package can be installed from Anaconda’s Snowflake channel using the </span><span><span class="kobospan" id="kobo.487.1">following command:</span></span></p>
<pre class="console"><span class="kobospan1" id="kobo.488.1">
conda install --channel https://repo.anaconda.com/pkgs/snowflake Snowflake-snowpark-python</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.489.1">Next, let’s install some </span><span><span class="kobospan" id="kobo.490.1">additional packages.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.491.1">Installing additional Python packages</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.492.1">To install </span><a id="_idIndexMarker080" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.493.1">additional packages that are necessary for development, such as </span><strong class="source-inline"><span class="kobospan" id="kobo.494.1">pandas</span></strong><span class="kobospan" id="kobo.495.1"> and </span><strong class="source-inline"><span class="kobospan" id="kobo.496.1">numpy</span></strong><span class="kobospan" id="kobo.497.1">, you can use the same Anaconda </span><span><span class="kobospan" id="kobo.498.1">Snowflake channel:</span></span></p>
<pre class="console"><span class="kobospan1" id="kobo.499.1">
conda install --channel https://repo.anaconda.com/pkgs/snowflake numpy pandas</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.500.1">The virtual environment is now ready for development and is connected to your favorite IDE, Jupyter Notebook, or VS Code development. </span><span class="kobospan" id="kobo.500.2">Similarly, we can install an </span><span><span class="kobospan" id="kobo.501.1">IPython notebook.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.502.1">Configuring Jupyter Notebook</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.503.1">Jupyter Notebook</span><a id="_idIndexMarker081" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.504.1"> is one</span><a id="_idIndexMarker082" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.505.1"> of the most popular IDEs for developers. </span><span class="kobospan" id="kobo.505.2">In this section, we will cover how to configure the Jupyter IDE for Snowpark since the examples in this book use Jupyter. </span><span class="kobospan" id="kobo.505.3">Jupyter Notebook needs to be installed in your local environment. </span><span class="kobospan" id="kobo.505.4">The Jupyter environment</span><a id="_idIndexMarker083" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.506.1"> comes installed alongside Anaconda. </span><span class="kobospan" id="kobo.506.2">So, let’s open </span><span><span class="kobospan" id="kobo.507.1">Jupyter Notebook:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.508.1">The </span><strong class="source-inline1"><span class="kobospan" id="kobo.509.1">def_gui_3.8_env</span></strong><span class="kobospan" id="kobo.510.1"> virtual environment must be activated for development if it is not activated in the previous section. </span><span class="kobospan" id="kobo.510.2">To activate the virtual environment, run the </span><span><span class="kobospan" id="kobo.511.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.512.1">conda activate def_gui_3.8_env</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.513.1">Launch Jupyter Notebook by running the </span><span><span class="kobospan" id="kobo.514.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.515.1">jupyter notebook</span></strong></pre></li> <li class="calibre14"><span class="kobospan" id="kobo.516.1">On the Jupyter Notebook web page, click the </span><strong class="bold"><span class="kobospan" id="kobo.517.1">New</span></strong><span class="kobospan" id="kobo.518.1"> button in the top-right corner. </span><span class="kobospan" id="kobo.518.2">From the drop-down menu, select </span><strong class="bold"><span class="kobospan" id="kobo.519.1">Python 3</span></strong><span class="kobospan" id="kobo.520.1"> under the </span><strong class="bold"><span class="kobospan" id="kobo.521.1">Notebooks</span></strong><span class="kobospan" id="kobo.522.1"> section. </span><span class="kobospan" id="kobo.522.2">This will open a new notebook with an empty cell that’s ready for </span><span><span class="kobospan" id="kobo.523.1">code execution.</span></span></li>
</ol>
<p class="callout-heading"><span class="kobospan" id="kobo.524.1">Important note</span></p>
<p class="callout"><span class="kobospan" id="kobo.525.1">This book will utilize Jupyter Notebook for all </span><span><span class="kobospan" id="kobo.526.1">the examples.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.527.1">Importing Snowpark modules</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.528.1">The </span><a id="_idIndexMarker084" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.529.1">Python classes for the Snowpark API are part of the </span><strong class="source-inline"><span class="kobospan" id="kobo.530.1">snowflake.snowpark</span></strong><span class="kobospan" id="kobo.531.1"> module. </span><span class="kobospan" id="kobo.531.2">You can import particular classes from the module by specifying their names. </span><span class="kobospan" id="kobo.531.3">For example, to import the </span><strong class="source-inline"><span class="kobospan" id="kobo.532.1">average</span></strong><span class="kobospan" id="kobo.533.1"> function, you can use the </span><span><span class="kobospan" id="kobo.534.1">following code:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.535.1">
from snowflake.snowpark.functions import avg</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.536.1">Now that the development environment has been set up, let’s learn how to operate </span><span><span class="kobospan" id="kobo.537.1">with Snowpark.</span></span></p>
<h1 id="_idParaDest-35" class="calibre5"><a id="_idTextAnchor035" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.538.1">Operating with Snowpark</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.539.1">Snowpark</span><a id="_idIndexMarker085" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.540.1"> for Python consists of client APIs, UDFs, and stored procedures that execute directly on the Python engine. </span><span class="kobospan" id="kobo.540.2">The following screenshot shows the various Snowpark objects that you can </span><span><span class="kobospan" id="kobo.541.1">choose from:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer040">
<span class="kobospan" id="kobo.542.1"><img alt="Figure 2.32 – Snowpark Python objects" src="image/B19923_02_32.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.543.1">Figure 2.32 – Snowpark Python objects</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.544.1">Snowpark uses DataFrame objects to query and process data. </span><span class="kobospan" id="kobo.544.2">The guiding principle in operating with Snowpark is to keep the data in Snowflake and process it right within Snowflake using the various Snowflake objects. </span><span class="kobospan" id="kobo.544.3">The following figure shows </span><span><span class="kobospan" id="kobo.545.1">Snowpark’s architecture:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer041">
<span class="kobospan" id="kobo.546.1"><img alt="Figure 2.33 – Snowpark Python architecture" src="image/B19923_02_33.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.547.1">Figure 2.33 – Snowpark Python architecture</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.548.1">In the next section, we will cover the </span><span><span class="kobospan" id="kobo.549.1">Python Engine.</span></span></p>
<h2 id="_idParaDest-36" class="calibre7"><a id="_idTextAnchor036" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.550.1">The Python Engine</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.551.1">The Python Engine</span><a id="_idIndexMarker086" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.552.1"> is an Anaconda-powered secure</span><a id="_idIndexMarker087" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.553.1"> sandboxed Python environment that’s executed on top of Snowflake’s virtual warehouse and hosted on Snowflake’s compute infrastructure. </span><span class="kobospan" id="kobo.553.2">This lets you process data using Python without the need to extract the data outside the environment. </span><span class="kobospan" id="kobo.553.3">The Python Engine consists of the UDF engine and the stored procedure engine. </span><span class="kobospan" id="kobo.553.4">The UDF engine is a restricted engine that cannot read or write data outside of Snowflake, whereas the stored procedure engine is more permissive and consists of a session object for interacting with the </span><span><span class="kobospan" id="kobo.554.1">Snowflake database.</span></span></p>
<h2 id="_idParaDest-37" class="calibre7"><a id="_idTextAnchor037" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.555.1">Client APIs</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.556.1">The client API is </span><a id="_idIndexMarker088" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.557.1">the </span><strong class="source-inline"><span class="kobospan" id="kobo.558.1">snowflake-snowpark-python</span></strong><span class="kobospan" id="kobo.559.1"> library </span><a id="_idIndexMarker089" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.560.1">and it can be installed in any Python environment. </span><span class="kobospan" id="kobo.560.2">It provides a session and the DataFrame APIs as methods to support queries being pushed down in Snowflake’s Python Engine. </span><span class="kobospan" id="kobo.560.3">The client APIs consist of notable objects, including sessions, DataFrames, and </span><a id="_idIndexMarker090" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.561.1">more. </span><span class="kobospan" id="kobo.561.2">Let’s look at these </span><span><span class="kobospan" id="kobo.562.1">in detail.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.563.1">Working with sessions</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.564.1">The Snowpark session</span><a id="_idIndexMarker091" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.565.1"> is part of the Snowpark API and connects to Snowflake to interact with it and perform operations using Snowpark objects. </span><span class="kobospan" id="kobo.565.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.566.1">Session</span></strong><span class="kobospan" id="kobo.567.1"> function in Snowpark API is responsible for operating with the session. </span><span class="kobospan" id="kobo.567.2">To import the </span><strong class="source-inline"><span class="kobospan" id="kobo.568.1">Session</span></strong><span class="kobospan" id="kobo.569.1"> function for Snowpark, run the </span><span><span class="kobospan" id="kobo.570.1">following command:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.571.1">
from snowflake.snowpark import Session</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.572.1">The Snowpark session consists of a Python dictionary containing the parameter values that are required to establish a connection </span><span><span class="kobospan" id="kobo.573.1">to Snowflake:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.574.1">
connection_parameters = {
    "account": "&lt;your snowflake account identifier&gt;",
    "user": "&lt;your snowflake username&gt;",
    "password": "&lt;your snowflake password&gt;",
    "role": "&lt;your snowflake role&gt;", # optional
    "warehouse": "&lt;your snowflake warehouse&gt;",  # optional
    "database": "&lt;your snowflake database&gt;",  # optional
    "schema": "&lt;your snowflake schema&gt;" # optional
}</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.575.1">The connection consists of the following </span><span><span class="kobospan" id="kobo.576.1">mandatory parameters:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.577.1">Account</span></strong><span class="kobospan" id="kobo.578.1">: The Snowflake account identifier is </span><strong class="source-inline1"><span class="kobospan" id="kobo.579.1">&lt;orgname&gt;-&lt;account_name&gt;</span></strong><span class="kobospan" id="kobo.580.1">. </span><span class="kobospan" id="kobo.580.2">There is no need to specify the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.581.1">snowflakecomputing.com</span></strong></span><span><span class="kobospan" id="kobo.582.1"> suffix.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.583.1">User</span></strong><span class="kobospan" id="kobo.584.1">: The username of the </span><span><span class="kobospan" id="kobo.585.1">Snowflake user.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.586.1">Password</span></strong><span class="kobospan" id="kobo.587.1">: The password to authenticate </span><span><span class="kobospan" id="kobo.588.1">to Snowflake.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.589.1">The following are the optional parameters that can be passed to </span><span><span class="kobospan" id="kobo.590.1">the connection:</span></span></p>
<ul class="calibre15">
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.591.1">role</span></strong><span class="kobospan" id="kobo.592.1">: The role to be used in the Snowpark session. </span><span class="kobospan" id="kobo.592.2">If left blank, the user’s default role will </span><span><span class="kobospan" id="kobo.593.1">be used.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.594.1">warehouse</span></strong><span class="kobospan" id="kobo.595.1">: The warehouse that’s used to execute the process. </span><span class="kobospan" id="kobo.595.2">If left blank, the user’s default warehouse will </span><span><span class="kobospan" id="kobo.596.1">be used.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.597.1">database</span></strong><span class="kobospan" id="kobo.598.1">: The database for the context of execution. </span><span class="kobospan" id="kobo.598.2">If left blank, the user’s default database will </span><span><span class="kobospan" id="kobo.599.1">be used.</span></span></li>
<li class="calibre14"><strong class="source-inline1"><span class="kobospan" id="kobo.600.1">schema</span></strong><span class="kobospan" id="kobo.601.1">: The schema for the context of execution. </span><span class="kobospan" id="kobo.601.2">If left blank, the user’s default schema will </span><span><span class="kobospan" id="kobo.602.1">be used.</span></span></li>
</ul>
<p class="calibre3"><span class="kobospan" id="kobo.603.1">You can</span><a id="_idIndexMarker092" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.604.1"> create the </span><strong class="source-inline"><span class="kobospan" id="kobo.605.1">session</span></strong><span class="kobospan" id="kobo.606.1"> object by passing this dictionary to the session builder, which is then used to establish </span><span><span class="kobospan" id="kobo.607.1">the session:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.608.1">
session = Session.builder.configs(connection_parameters).create()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.609.1">Once the session has been created, the </span><strong class="source-inline"><span class="kobospan" id="kobo.610.1">session</span></strong><span class="kobospan" id="kobo.611.1"> object acts as a handle to interact with Snowflake through various methods to perform operations such as reading and manipulating data. </span><span class="kobospan" id="kobo.611.2">Some of the session methods that can be used are </span><span><span class="kobospan" id="kobo.612.1">shown here:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.613.1">
print("Session Current Account:", session.get_current_account())</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.614.1">Finally, you can close the session by using the </span><strong class="source-inline"><span class="kobospan" id="kobo.615.1">close()</span></strong><span class="kobospan" id="kobo.616.1"> method. </span><span class="kobospan" id="kobo.616.2">This terminates the session and the ongoing queries associated </span><span><span class="kobospan" id="kobo.617.1">with it:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.618.1">
session.close()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.619.1">Snowflake recommends that you close the session after the process has been completed. </span><span class="kobospan" id="kobo.619.2">The </span><strong class="source-inline"><span class="kobospan" id="kobo.620.1">Session</span></strong><span class="kobospan" id="kobo.621.1"> method can be used to establish a session and interact with the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.622.1">Session</span></strong></span><span><span class="kobospan" id="kobo.623.1"> objects.</span></span></p>
<h4 class="calibre16"><span class="kobospan" id="kobo.624.1">Advanced authentication</span></h4>
<p class="calibre3"><span class="kobospan" id="kobo.625.1">Snowpark sessions </span><a id="_idIndexMarker093" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.626.1">also support advanced authentication, such as key pair authentication, if it’s been configured for the user connecting to Snowflake. </span><span class="kobospan" id="kobo.626.2">The private key must be serialized and then passed to the connection object of the session builder. </span><span class="kobospan" id="kobo.626.3">We will be using the hazmat crypto package to serialize the private key. </span><span class="kobospan" id="kobo.626.4">This private key is provided </span><a id="_idIndexMarker094" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.627.1">as </span><span><span class="kobospan" id="kobo.628.1">a variable:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.629.1">
from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives import serialization
private_key_plain_text = '''-----BEGIN PRIVATE KEY-----
&lt; your private key &gt;
-----END PRIVATE KEY-----'''
private_key_passphrase = '&lt;your private key passphase&gt;'</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.630.1">We encode the private key using the passphrase and then serialize it to assign it to a variable that’s passed into the Snowflake </span><span><span class="kobospan" id="kobo.631.1">connection object:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.632.1">
private_key_encoded = private_key_plain_text.encode()
private_key_passphrase_encoded = private_key_passphrase.encode()
private_key_loaded = serialization.load_pem_private_key(
    private_key_encoded,
    password = private_key_passphrase_encoded,
    backend = default_backend()
)
private_key_serialized = private_key_loaded.private_bytes(
    encoding = serialization.Encoding.DER,
    format = serialization.PrivateFormat.PKCS8,
    encryption_algorithm = serialization.NoEncryption()
)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.633.1">The connection parameters will have the private key passed in serialized form, and the session can be</span><a id="_idIndexMarker095" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.634.1"> established using the </span><span><span class="kobospan" id="kobo.635.1">session builder:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.636.1">
connection_parameters = {
    "account": "&lt;your snowflake account identifier&gt;",
    "user": "&lt; your snowflake username&gt;",
    "private_key": private_key_serialized,
    "warehouse": "&lt;your snowflake warehouse&gt;",
    "database": "&lt;your snowflake database&gt;",
    "schema": "&lt;your snowflake schema&gt;"
}
session = Session.builder.configs(connection_parameters).create()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.637.1">Next, let’s discuss </span><span><span class="kobospan" id="kobo.638.1">Snowpark DataFrames.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.639.1">Snowpark DataFrames</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.640.1">Snowpark </span><a id="_idIndexMarker096" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.641.1">for Python consists of a client API that provides a DataFrame-based approach that queries and processes data with a DataFrame object. </span><span class="kobospan" id="kobo.641.2">The following diagram explains the code blocks that </span><span><span class="kobospan" id="kobo.642.1">are utilized:</span></span></p>
<p class="calibre3"> </p>
<div class="calibre2">
<div class="img---figure" id="_idContainer042">
<span class="kobospan" id="kobo.643.1"><img alt="Figure 2.34 – Snowpark DataFrame API" src="image/B19923_02_34.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.644.1">Figure 2.34 – Snowpark DataFrame API</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.645.1">The</span><a id="_idIndexMarker097" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.646.1"> Snowpark DataFrame API yields more efficiency with less effort required by the developer as it has a concise syntax that is easy to understand and debug. </span><span class="kobospan" id="kobo.646.2">The following figure compares a DataFrame and a </span><span><span class="kobospan" id="kobo.647.1">SQL query:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer043">
<span class="kobospan" id="kobo.648.1"><img alt="Figure 2.35 – Snowpark DataFrame versus a query" src="image/B19923_02_35.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.649.1">Figure 2.35 – Snowpark DataFrame versus a query</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.650.1">In addition, Snowpark DataFrames can directly read data from tables, views, and </span><strong class="source-inline"><span class="kobospan" id="kobo.651.1">SELECT</span></strong><span class="kobospan" id="kobo.652.1"> statements that support pushdown so that they can be executed in Snowflake. </span><span class="kobospan" id="kobo.652.2">The Snowpark </span><a id="_idIndexMarker098" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.653.1">client APIs also support converting pandas DataFrames into Snowflake DataFrames so that data can be written back into Snowflake. </span><span class="kobospan" id="kobo.653.2">Finally, Snowpark DataFrames support lazy evaluation as data computation is performed once an action </span><span><span class="kobospan" id="kobo.654.1">is invoked.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.655.1">Note</span></p>
<p class="callout"><span class="kobospan" id="kobo.656.1">Lazy evaluation in Snowpark means that data processing operations are not executed immediately when they are defined. </span><span class="kobospan" id="kobo.656.2">Instead, Snowpark builds a sequence of transformations without executing them until you explicitly request the result. </span><span class="kobospan" id="kobo.656.3">This approach optimizes performance and resource usage, allowing you to construct complex data workflows efficiently and interactively. </span><span class="kobospan" id="kobo.656.4">Lazy evaluation is a key feature for handling large datasets and optimizing data processing tasks </span><span><span class="kobospan" id="kobo.657.1">in Snowpark.</span></span></p>
<h4 class="calibre16"><span class="kobospan" id="kobo.658.1">Working with DataFrames</span></h4>
<p class="calibre3"><span class="kobospan" id="kobo.659.1">DataFrames are</span><a id="_idIndexMarker099" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.660.1"> the dataset objects in Snowpark in which data is queried and processed. </span><span class="kobospan" id="kobo.660.2">They represent relational datasets that provide lazy evaluation. </span><span class="kobospan" id="kobo.660.3">The DataFrame executes SQL in a push-down manner and can perform operations such as creating objects and reading, writing, and working with data from the Python code. </span><span class="kobospan" id="kobo.660.4">Various methods in the </span><strong class="source-inline"><span class="kobospan" id="kobo.661.1">Session</span></strong><span class="kobospan" id="kobo.662.1"> object are used to work </span><span><span class="kobospan" id="kobo.663.1">with DataFrames.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.664.1">Let’s create an employee data table </span><span><span class="kobospan" id="kobo.665.1">called </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.666.1">SAMPLE_EMPLOYEE_DATA</span></strong></span><span><span class="kobospan" id="kobo.667.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.668.1">
session.sql('CREATE OR REPLACE TABLE SAMPLE_EMPLOYEE_DATA (id INT,name VARCHAR, age INT, email VARCHAR, city VARCHAR,country VARCHAR)').collect()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.669.1">The preceding code will create a table with the required fields for employee data. </span><span class="kobospan" id="kobo.669.2">Let’s insert some data into the table for </span><span><span class="kobospan" id="kobo.670.1">operational purposes:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.671.1">
session.sql("""
    INSERT INTO SAMPLE_EMPLOYEE_DATA VALUES
    (1,'John Doe',25,'johndoe@example.com','New York','USA'),
    (2,'Jane Smith',30,'janesmith@example.com','Los Angeles','USA'),
    (3,'Michael Johnson',35,'michaeljohnson@example.com','London', 
       'UK'),
    (4,'Sarah Williams',28,'sarahwilliams@example.com','Leeds', 
       'UK'),
    (5,'David Brown',32,'davidbrown@example.com','Tokyo','Japan'),
    (6,'Emily Davis',29,'emilydavis@example.com','Sydney',
       'Australia'),
    (7,'James Miller',27,'jamesmiller@example.com','Dallas','USA'),
    (8,'Emma Wilson',33,'emmawilson@example.com','Berlin','Germany'),
    (9,'Alexander Taylor',31,'alexandertaylor@example.com',
       'Rome','Italy'),
    (10,'Olivia Anderson',26,'oliviaanderson@example.com',
        'Melbourne','Australia')
""").collect()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.672.1">The preceding </span><a id="_idIndexMarker100" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.673.1">code will populate the table with the data that we can query. </span><span class="kobospan" id="kobo.673.2">To query the data, we can directly pass the </span><span><span class="kobospan" id="kobo.674.1">SQL statement:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.675.1">
session.sql("SELECT count(*) FROM SAMPLE_EMPLOYEE_DATA").collect()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.676.1">The preceding code will return the results after it’s been executed in Snowflake. </span><span class="kobospan" id="kobo.676.2">We can also store these results in a DataFrame so that we can operate on it </span><span><span class="kobospan" id="kobo.677.1">in Python:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.678.1">
from snowflake.snowpark.functions import col
df_subset_row = session.table(
    "SAMPLE_EMPLOYEE_DATA").filter(col("id") == 1)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.679.1">The </span><a id="_idIndexMarker101" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.680.1">following code will save the results in a </span><strong class="source-inline"><span class="kobospan" id="kobo.681.1">df_subset_row</span></strong><span class="kobospan" id="kobo.682.1"> DataFrame that can be displayed </span><span><span class="kobospan" id="kobo.683.1">using </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.684.1">show()</span></strong></span><span><span class="kobospan" id="kobo.685.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.686.1">
df_subset_row.show()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.687.1">Here’s </span><span><span class="kobospan" id="kobo.688.1">the output:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer044">
<span class="kobospan" id="kobo.689.1"><img alt="Figure 2.36 – DataFrame data" src="image/B19923_02_36.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.690.1">Figure 2.36 – DataFrame data</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.691.1">In the next section, we will look at Snowpark UDFs and </span><span><span class="kobospan" id="kobo.692.1">stored procedures.</span></span></p>
<p class="callout-heading"><span class="kobospan" id="kobo.693.1">A note on code snippets</span></p>
<p class="callout"><span class="kobospan" id="kobo.694.1">The examples presented in the following section have been simplified intentionally. </span><span class="kobospan" id="kobo.694.2">Our main objective is to grasp and distinguish the concepts, rather than delving into complex scenarios. </span><span class="kobospan" id="kobo.694.3">However, we’ll delve into more sophisticated examples in the </span><span><span class="kobospan" id="kobo.695.1">upcoming chapters.</span></span></p>
<h2 id="_idParaDest-38" class="calibre7"><a id="_idTextAnchor038" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.696.1">UDFs</span></h2>
<p class="calibre3"><span class="kobospan" id="kobo.697.1">Snowpark for</span><a id="_idIndexMarker102" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.698.1"> Python supports UDFs that allow developers</span><a id="_idIndexMarker103" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.699.1"> to write reusable custom lambdas and functions to process the data through DataFrames. </span><span class="kobospan" id="kobo.699.2">Like built-in functions, UDFs can be called from SQL, which enhances SQL with functionality that it doesn’t have or doesn’t do well. </span><span class="kobospan" id="kobo.699.3">UDFs also provide a way to encapsulate functionality so that you can call it repeatedly from multiple places in your code. </span><span class="kobospan" id="kobo.699.4">For example, you can write a UDF that returns a single value called a </span><em class="italic"><span class="kobospan" id="kobo.700.1">scalar</span></em><span class="kobospan" id="kobo.701.1"> function, also known as a UDF, or a group of values called a </span><em class="italic"><span class="kobospan" id="kobo.702.1">tabular</span></em><span class="kobospan" id="kobo.703.1"> function, also known as a </span><strong class="bold"><span class="kobospan" id="kobo.704.1">user data table function</span></strong><span class="kobospan" id="kobo.705.1"> (</span><strong class="bold"><span class="kobospan" id="kobo.706.1">UDTF</span></strong><span class="kobospan" id="kobo.707.1">). </span><span class="kobospan" id="kobo.707.2">These UDFs can be developed from within Python worksheets or by using Snowpark from your local </span><span><span class="kobospan" id="kobo.708.1">development environment.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.709.1">Scalar UDFs</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.710.1">Scalar UDFs </span><a id="_idIndexMarker104" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.711.1">are invoked once per row and return one output row</span><a id="_idIndexMarker105" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.712.1"> for each input row. </span><span class="kobospan" id="kobo.712.2">These UDFs are called just like a standard SQL function, with columns or expressions as arguments. </span><span class="kobospan" id="kobo.712.3">It produces a row consisting of a single column/value as output. </span><span class="kobospan" id="kobo.712.4">The data gets processed in parallel across each node within a multi-node </span><span><span class="kobospan" id="kobo.713.1">virtual warehouse.</span></span></p>
<h4 class="calibre16"><span class="kobospan" id="kobo.714.1">Working with UDFs</span></h4>
<p class="calibre3"><span class="kobospan" id="kobo.715.1">Once a</span><a id="_idIndexMarker106" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.716.1"> Snowpark session has been created, the UDF can be turned into a standard function that can be registered </span><span><span class="kobospan" id="kobo.717.1">in Snowflake:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.718.1">
def &lt;main Python function name&gt;(&lt;arguments&gt;):
    return &lt;function output&gt;
from snowflake.snowpark.types \
    import &lt;specific Snowpark DataType object&gt;
snowpark_session.add_packages(
    'List of native packages in Anaconda Channel')
snowpark_session.add_import('Path to Local File')
snowpark_session.udf.register(
    func = &lt;Main Function Name&gt;
  , return_type = &lt;Return Type of Snowpark DataType object &gt;
  , input_types = &lt;[Input Types of Snowflake DataType object]&gt;
  , is_permanent = True
  , name = '&lt;UDF name&gt;'
  , replace = True
  , stage_location = '@&lt;UDF stage name&gt;'
)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.719.1">The</span><a id="_idIndexMarker107" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.720.1"> preceding template delineates the steps in creating a UDF in Snowflake using Python. </span><span class="kobospan" id="kobo.720.2">It involves defining the primary Python function that will be used by the UDF and registering it in Snowflake. </span><span class="kobospan" id="kobo.720.3">Next, the function and UDF names are specified, along with the Snowflake stage, where the UDF files will be uploaded. </span><span class="kobospan" id="kobo.720.4">Finally, the required Snowpark </span><strong class="source-inline"><span class="kobospan" id="kobo.721.1">DataType</span></strong><span class="kobospan" id="kobo.722.1"> object for the UDF’s return value is imported, and its specific object is determined. </span><span class="kobospan" id="kobo.722.2">This is not the only template we can follow – we can also leverage decorators to perform this. </span><span class="kobospan" id="kobo.722.3">But for beginners, this can be very helpful to templatize and organize UDFS, UDTFs, and </span><span><span class="kobospan" id="kobo.723.1">stored procedures.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.724.1">Additionally, any necessary Snowpark </span><strong class="source-inline"><span class="kobospan" id="kobo.725.1">DataType</span></strong><span class="kobospan" id="kobo.726.1"> objects for the UDF’s input arguments are imported and determined. </span><span class="kobospan" id="kobo.726.2">The template also allows you to include extra packages and imports in the UDF. </span><span class="kobospan" id="kobo.726.3">We can also specify whether the UDF should be temporary and whether an existing UDF with the same name should </span><span><span class="kobospan" id="kobo.727.1">be overwritten:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.728.1">
def last_name_finder(input_name:str):
    last_name = input_name.split()[1]
    return last_name
from snowflake.snowpark.types \
    import StringType,IntegerType,ArrayType
test = session.udf.register(
    func = last_name_finder
  , return_type = StringType()
  , input_types = [StringType()]
  , is_permanent = True
  , name = 'LAST_NAME_FINDER'
  , replace = True
  , stage_location = '@MY_STAGE'
)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.729.1">This simple</span><a id="_idIndexMarker108" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.730.1"> function gets the input name and splits it so that it returns the last name. </span><span class="kobospan" id="kobo.730.2">The UDF is registered to the internal </span><strong class="source-inline"><span class="kobospan" id="kobo.731.1">My_Stage</span></strong><span class="kobospan" id="kobo.732.1"> stage and is deployed into Snowflake. </span><span class="kobospan" id="kobo.732.2">The UDF can be invoked directly in SQL as </span><span><span class="kobospan" id="kobo.733.1">a function:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.734.1">
session.sql('''SELECT
    NAME,
    LAST_NAME_FINDER(NAME) AS LAST_NAME
    FROM SAMPLE_EMPLOYEE_DATA
''').show()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.735.1">The output is </span><span><span class="kobospan" id="kobo.736.1">as follows:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer045">
<span class="kobospan" id="kobo.737.1"><img alt="Figure 2.37 – UDF Snowpark execution" src="image/B19923_02_37.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.738.1">Figure 2.37 – UDF Snowpark execution</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.739.1">In this example, we invoked the </span><strong class="source-inline"><span class="kobospan" id="kobo.740.1">LAST_NAME_FINDER</span></strong><span class="kobospan" id="kobo.741.1"> function with the </span><strong class="source-inline"><span class="kobospan" id="kobo.742.1">Name</span></strong><span class="kobospan" id="kobo.743.1"> column, which</span><a id="_idIndexMarker109" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.744.1"> returned the last name by splitting it. </span><span class="kobospan" id="kobo.744.2">The function can also be called within the </span><strong class="source-inline"><span class="kobospan" id="kobo.745.1">DataFrame</span></strong><span class="kobospan" id="kobo.746.1"> function, </span><span><span class="kobospan" id="kobo.747.1">as follows:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.748.1">
from snowflake.snowpark.functions import col, call_udf
df = session.table("SAMPLE_EMPLOYEE_DATA")
df.with_column(
    "last_name",call_udf("LAST_NAME_FINDER", col("name"))).show()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.749.1">The preceding code generates the </span><span><span class="kobospan" id="kobo.750.1">following output:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer046">
<span class="kobospan" id="kobo.751.1"><img alt="Figure 2.38 – UDF DataFrame execution" src="image/B19923_02_38.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.752.1">Figure 2.38 – UDF DataFrame execution</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.753.1">Next, let’s look </span><span><span class="kobospan" id="kobo.754.1">into UDTFs.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.755.1">UDTF</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.756.1">Tabular UDFs, also</span><a id="_idIndexMarker110" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.757.1"> known as UDTFs, require stateful operations to</span><a id="_idIndexMarker111" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.758.1"> be performed on data batches and are invoked once per row, just like scalar UDFs, but they can return multiple rows as output for each input row. </span><span class="kobospan" id="kobo.758.2">The UDTF handler method consists of an additional optional parameter that helps initialize the handler once for each partition and finalize processing for each section. </span><span class="kobospan" id="kobo.758.3">A UDTF is a type of UDF that executes similarly to a UDF but with tabular output. </span><span class="kobospan" id="kobo.758.4">Therefore, they can be developed in Python worksheets and Snowpark </span><span><span class="kobospan" id="kobo.759.1">development environments.</span></span></p>
<h4 class="calibre16"><span class="kobospan" id="kobo.760.1">Working with UDTFs</span></h4>
<p class="calibre3"><span class="kobospan" id="kobo.761.1">Creating a UDTF in </span><a id="_idIndexMarker112" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.762.1">Snowpark is similar to creating a UDF in that after a Snowpark session is created, the UDTF can be made directly in a standard command that can be registered </span><span><span class="kobospan" id="kobo.763.1">in Snowflake.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.764.1">The following Snowpark UDTF template provides a basic outline for creating a UDTF in Snowpark using Python. </span><span class="kobospan" id="kobo.764.2">The following code shows the key elements in </span><span><span class="kobospan" id="kobo.765.1">this template:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.766.1">
# Define Python class locally
'''
Define main Python class which is
leveraged to process partitions.
</span><span class="kobospan1" id="kobo.766.2">Executes in the following order:
- __init__ | Executes once per partition
- process | Executes once per input row within the partition
- end_partition | Executes once per partition
'''
class &lt;name of main Python class&gt; :
    '''
    Optional __init__ method to
    execute logic for a partition
    before breaking out into rows
    '''
    def __init__(self) :</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.767.1">This template </span><a id="_idIndexMarker113" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.768.1">creates a UDTF in Snowflake. </span><span class="kobospan" id="kobo.768.2">First, a main Python handler class is defined for the UDTF, which can utilize other functions from the script or be imported from external sources. </span><span class="kobospan" id="kobo.768.3">It is important to note that only one main Python handler class can be assigned to </span><span><span class="kobospan" id="kobo.769.1">the UDTF.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.770.1">In this template, you are expected to replace </span><strong class="source-inline"><span class="kobospan" id="kobo.771.1">&lt;name of main Python class&gt;</span></strong><span class="kobospan" id="kobo.772.1"> with a meaningful name for your UDTF class. </span><span class="kobospan" id="kobo.772.2">This is the main class where you will define the logic for processing data within </span><span><span class="kobospan" id="kobo.773.1">your UDTF.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.774.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.775.1">__init__</span></strong><span class="kobospan" id="kobo.776.1"> method is marked as optional, meaning you may or may not include it in your UDTF implementation. </span><span class="kobospan" id="kobo.776.2">If you choose to include it, this method will execute once per partition before breaking out into </span><span><span class="kobospan" id="kobo.777.1">individual rows.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.778.1">You can use </span><a id="_idIndexMarker114" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.779.1">the </span><strong class="source-inline"><span class="kobospan" id="kobo.780.1">__init__</span></strong><span class="kobospan" id="kobo.781.1"> method to perform any partition-level setup or initialization specific to your UDTF. </span><span class="kobospan" id="kobo.781.2">For example, you might use it to initialize variables and open connections or set up data structures that will be used throughout the </span><span><span class="kobospan" id="kobo.782.1">UDTF’s execution:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.783.1">
'''
Method to process each input row
within a partition, returning a
tabular value as tuples.
</span><span class="kobospan1" id="kobo.783.2">'''
def process(self, &lt;arguments&gt;) :
    '''
    Enter Python code here that
    executes for each input row.
</span><span class="kobospan1" id="kobo.783.3">    This likely ends with a set of yield
    clauses that output tuples,
    for example:
    '''
    yield (&lt;field_1_value_1&gt;, &lt;field_2_value_1&gt;, ...)
    yield (&lt;field_1_value_2&gt;, &lt;field_2_value_2&gt;, ...)
    '''
    Alternatively, this may end with
    a single return clause containing
    an iterable of tuples, for example:
    '''
    return [
        (&lt;field_1_value_1&gt;, &lt;field_2_value_1&gt;, ...)
      , (&lt;field_1_value_2&gt;, &lt;field_2_value_2&gt;, ...)
    ]</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.784.1">This method is </span><a id="_idIndexMarker115" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.785.1">responsible for processing each input row within a partition and generating tabular data as tuples. </span><span class="kobospan" id="kobo.785.2">Inside the </span><strong class="source-inline"><span class="kobospan" id="kobo.786.1">process</span></strong><span class="kobospan" id="kobo.787.1"> method, you can write custom Python code that executes for every input row in the partition. </span><span class="kobospan" id="kobo.787.2">The key part of this method is the usage of </span><strong class="source-inline"><span class="kobospan" id="kobo.788.1">yield</span></strong><span class="kobospan" id="kobo.789.1"> statements or a </span><strong class="source-inline"><span class="kobospan" id="kobo.790.1">return</span></strong><span class="kobospan" id="kobo.791.1"> statement to produce tuples </span><span><span class="kobospan" id="kobo.792.1">as output.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.793.1">In terms of </span><strong class="source-inline"><span class="kobospan" id="kobo.794.1">yield</span></strong><span class="kobospan" id="kobo.795.1"> statements, you can output one or more tuples for each input row, allowing for flexibility in generating tabular results. </span><span class="kobospan" id="kobo.795.2">Alternatively, you can use a </span><strong class="source-inline"><span class="kobospan" id="kobo.796.1">return</span></strong><span class="kobospan" id="kobo.797.1"> statement with a list of tuples to achieve the same result. </span><span class="kobospan" id="kobo.797.2">In essence, the </span><strong class="source-inline"><span class="kobospan" id="kobo.798.1">process</span></strong><span class="kobospan" id="kobo.799.1"> method serves as the core logic for your UDTF, where you manipulate and transform data from each input row into tabular format, making it suitable for further processing </span><span><span class="kobospan" id="kobo.800.1">or analysis:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.801.1">
'''
Optional end_partition method to
execute logic for a partition
after processing all input rows
'''
def end_partition(self) :
    # Python code at the partition level
    '''
    This ends with a set of yield
    clauses that output tuples,
    for example:
    '''
    yield (&lt;field_1_value_1&gt;, &lt;field_2_value_1&gt;, ...)
    yield (&lt;field_1_value_2&gt;, &lt;field_2_value_2&gt;, ...)
    '''
    Alternatively, this ends with
    a single return clause containing
    an iterable of tuples, for example:
    '''
    return [
        (&lt;field_1_value_1&gt;, &lt;field_2_value_1&gt;, ...)
      , (&lt;field_1_value_2&gt;, &lt;field_2_value_2&gt;, ...)
    ]</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.802.1">This method </span><a id="_idIndexMarker116" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.803.1">is used to execute logic that’s specific to a partition after processing all the input rows in that partition. </span><span class="kobospan" id="kobo.803.2">Inside the </span><strong class="source-inline"><span class="kobospan" id="kobo.804.1">end_partition</span></strong><span class="kobospan" id="kobo.805.1"> method, you can write custom Python code that performs calculations or generates results based on the data that’s processed within that partition. </span><span class="kobospan" id="kobo.805.2">This method can also be used to yield or return tabular data as tuples, similar to the </span><strong class="source-inline"><span class="kobospan" id="kobo.806.1">process</span></strong><span class="kobospan" id="kobo.807.1"> method, but this data typically represents aggregated or summarized information for the </span><span><span class="kobospan" id="kobo.808.1">entire partition.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.809.1">You have the option to use </span><strong class="source-inline"><span class="kobospan" id="kobo.810.1">yield</span></strong><span class="kobospan" id="kobo.811.1"> statements to output one or more tuples, or you can use a </span><strong class="source-inline"><span class="kobospan" id="kobo.812.1">return</span></strong><span class="kobospan" id="kobo.813.1"> statement with a list of tuples to provide the partition-level result. </span><span class="kobospan" id="kobo.813.2">This allows you to perform partition-specific operations and return the results in a </span><span><span class="kobospan" id="kobo.814.1">structured format.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.815.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.816.1">end_partition</span></strong><span class="kobospan" id="kobo.817.1"> method in a Snowpark UDTF template is used for executing partition-level logic and returning tabular data or results specific to that partition after processing all input rows within it. </span><span class="kobospan" id="kobo.817.2">It’s especially useful for tasks such as aggregations or calculations, which require data from the </span><span><span class="kobospan" id="kobo.818.1">entire partition.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.819.1">The following code template provides details on how to register a UDTF in Snowflake and the corresponding options to define </span><span><span class="kobospan" id="kobo.820.1">the UDTF:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.821.1">
from snowflake.snowpark.types import StructType, StructField
from snowflake.snowpark.types \
    import &lt;specific Snowpark DataType objects&gt;
snowpark_session.add_packages(
    '&lt;list of required packages natively available in Snowflake( 
        i.e. </span><span class="kobospan1" id="kobo.821.2">included in Anaconda Snowpark channel)&gt;')
snowpark_session.add_import('&lt;path\\to\\local\\directory\\or\\file&gt;')
snowpark_session.udtf.register(
    handler = &lt;name of main Python class&gt;
  , output_schema = StructType(
        &lt;list of StructField objects with specific field \
        name and Snowpark DataType objects&gt;)
  , input_types = &lt;list of input DataType() \
        objects for input parameters&gt;
  , is_permanent = True
  , name = '&lt;UDTF name&gt;'
  , replace = True
  , stage_location = '@&lt;UDTF stage name&gt;'
)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.822.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.823.1">udtf()</span></strong><span class="kobospan" id="kobo.824.1"> method </span><a id="_idIndexMarker117" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.825.1">of the Snowflake Snowpark </span><strong class="source-inline"><span class="kobospan" id="kobo.826.1">Session</span></strong><span class="kobospan" id="kobo.827.1"> object is used to create the UDTF in Snowflake. </span><span class="kobospan" id="kobo.827.2">The process involves several steps: determining the Python class that the UDTF will use, specifying the name of the UDTF within Snowflake (it can be a fully qualified name or created in the same namespace as the Snowpark </span><strong class="source-inline"><span class="kobospan" id="kobo.828.1">Session</span></strong><span class="kobospan" id="kobo.829.1"> object), and providing the name of the Snowflake stage where the UDTF files will </span><span><span class="kobospan" id="kobo.830.1">be uploaded.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.831.1">Specific Snowpark </span><strong class="source-inline"><span class="kobospan" id="kobo.832.1">DataType</span></strong><span class="kobospan" id="kobo.833.1"> objects are imported to define the structure of the UDTF. </span><span class="kobospan" id="kobo.833.2">This includes importing objects for defining tabular structures, such as table schemas (using </span><strong class="source-inline"><span class="kobospan" id="kobo.834.1">StructType</span></strong><span class="kobospan" id="kobo.835.1">) and fields within a table (using </span><strong class="source-inline"><span class="kobospan" id="kobo.836.1">StructField</span></strong><span class="kobospan" id="kobo.837.1">). </span><span class="kobospan" id="kobo.837.2">Furthermore, a specific Snowpark </span><strong class="source-inline"><span class="kobospan" id="kobo.838.1">DataType</span></strong><span class="kobospan" id="kobo.839.1"> object is imported for the values that are passed into and returned by the UDTF. </span><span class="kobospan" id="kobo.839.2">The output schema of the UDTF is defined using the imported Snowpark </span><strong class="source-inline"><span class="kobospan" id="kobo.840.1">DataType</span></strong><span class="kobospan" id="kobo.841.1"> objects, embedding them into </span><strong class="source-inline"><span class="kobospan" id="kobo.842.1">StructField </span></strong><span class="kobospan" id="kobo.843.1">and </span><strong class="source-inline"><span class="kobospan" id="kobo.844.1">StructType</span></strong><span class="kobospan" id="kobo.845.1"> objects. </span><span class="kobospan" id="kobo.845.2">Additionally, a list of specific Snowpark </span><strong class="source-inline"><span class="kobospan" id="kobo.846.1">DataType</span></strong><span class="kobospan" id="kobo.847.1"> objects is defined for the</span><a id="_idIndexMarker118" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.848.1"> input arguments of the UDTF. </span><span class="kobospan" id="kobo.848.2">It is crucial to include all these </span><strong class="source-inline"><span class="kobospan" id="kobo.849.1">DataType</span></strong><span class="kobospan" id="kobo.850.1"> objects in the import and ensure they match the expected arguments that are passed to the </span><strong class="source-inline"><span class="kobospan" id="kobo.851.1">process</span></strong><span class="kobospan" id="kobo.852.1"> method within the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.853.1">handler</span></strong></span><span><span class="kobospan" id="kobo.854.1"> class.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.855.1">The template allows a temporary UDTF to be created that only exists within the specific Snowflake Snowpark </span><strong class="source-inline"><span class="kobospan" id="kobo.856.1">Session</span></strong><span class="kobospan" id="kobo.857.1"> object. </span><span class="kobospan" id="kobo.857.2">Additionally, an option exists to overwrite an existing UDTF with the same name; an error will be returned if it’s set to </span><strong class="source-inline"><span class="kobospan" id="kobo.858.1">False</span></strong><span class="kobospan" id="kobo.859.1"> and a UDTF already exists. </span><span class="kobospan" id="kobo.859.2">Lastly, the template briefly mentions adding additional packages and imports to the UDTF, which is optional and can be done using the </span><span><span class="kobospan" id="kobo.860.1">provided rows.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.861.1">The following example illustrates how to use a Snowpark UDTF to calculate the averages of numeric data within Snowflake tables. </span><span class="kobospan" id="kobo.861.2">This showcases the practical application of UDTFs in Snowpark for custom data </span><span><span class="kobospan" id="kobo.862.1">processing tasks:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.863.1">
class CalculateAverage:
    def __init__(self) :
        self._values = []
    def process(self, input_measure: int) :
        self._values.append(input_measure)
    def end_partition(self) :
        values_list = self._values
        average = sum(values_list) / len(values_list)
        yield(average ,)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.864.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.865.1">CalculateAverage</span></strong><span class="kobospan" id="kobo.866.1"> Snowpark UDTF is designed to compute the average of a numeric column within a Snowflake table. </span><span class="kobospan" id="kobo.866.2">It does this by accumulating the input values for each partition of the data and then calculating the average when the </span><span><span class="kobospan" id="kobo.867.1">partition ends.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.868.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.869.1">process</span></strong><span class="kobospan" id="kobo.870.1"> method collects input values one by one and stores them in a list. </span><span class="kobospan" id="kobo.870.2">When the partition ends (in the </span><strong class="source-inline"><span class="kobospan" id="kobo.871.1">end_partition</span></strong><span class="kobospan" id="kobo.872.1"> method), it calculates the average by summing up all the collected values and dividing by the count of values. </span><span class="kobospan" id="kobo.872.2">Finally, it yields the calculated </span><a id="_idIndexMarker119" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.873.1">average as the UDTF’s output. </span><span class="kobospan" id="kobo.873.2">This UDTF simplifies the process of computing averages in Snowflake SQL queries, especially when dealing with </span><span><span class="kobospan" id="kobo.874.1">large datasets:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.875.1">
from snowflake.snowpark.types import StructType, StructField
from snowflake.snowpark.types \
    import FloatType,IntegerType,StringType
output_schema = StructType([
    StructField("Avg_Age", FloatType())
])
session.udtf.register(
    handler = CalculateAverage
  , output_schema = output_schema
  , input_types = [IntegerType()]
  , is_permanent = True
  , name = 'AVERAGE_AGE'
  , replace = True
  , stage_location = '@MY_STAGE'
)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.876.1">In this example, we’re creating a UDTF function called </span><strong class="source-inline"><span class="kobospan" id="kobo.877.1">Average_Age</span></strong><span class="kobospan" id="kobo.878.1"> that calculates the average age by getting the age as input. </span><span class="kobospan" id="kobo.878.2">The function is uploaded into </span><strong class="source-inline"><span class="kobospan" id="kobo.879.1">MY_STAGE</span></strong><span class="kobospan" id="kobo.880.1"> and registered </span><span><span class="kobospan" id="kobo.881.1">in Snowflake.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.882.1">The function can</span><a id="_idIndexMarker120" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.883.1"> be executed to get the average age per country from the sample </span><span><span class="kobospan" id="kobo.884.1">employee data:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.885.1">
session.sql('''
    SELECT
        COUNTRY, Avg_Age
    FROM
        SAMPLE_EMPLOYEE_DATA,
        table(AVERAGE_AGE(AGE) over (partition by COUNTRY))
''').show()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.886.1">This will display the </span><span><span class="kobospan" id="kobo.887.1">following output:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer047">
<span class="kobospan" id="kobo.888.1"><img alt="Figure 2.39 – UDTF Snowpark execution" src="image/B19923_02_39.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.889.1">Figure 2.39 – UDTF Snowpark execution</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.890.1">The output shows the execution output of the UDTF. </span><span class="kobospan" id="kobo.890.2">In the next section, we will cover </span><span><span class="kobospan" id="kobo.891.1">vectorized UDFs.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.892.1">Vectorized UDFs</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.893.1">Vectorized UDFs </span><a id="_idIndexMarker121" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.894.1">operate similarly to scalar UDFs in</span><a id="_idIndexMarker122" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.895.1"> that they let you define Python functions that receive batches of input rows as pandas DataFrames and return collections of results as pandas arrays </span><span><span class="kobospan" id="kobo.896.1">or series.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.897.1">Vectorized UDFs</span><a id="_idIndexMarker123" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.898.1"> parallelize the operation on batches of data and provide significant performance advantages on sets of rows compared to serial row processing. </span><span class="kobospan" id="kobo.898.2">In addition, they reduce the complexity of using libraries that operate on pandas DataFrames </span><span><span class="kobospan" id="kobo.899.1">and arrays.</span></span></p>
<h4 class="calibre16"><span class="kobospan" id="kobo.900.1">Working with vectorized UDFs</span></h4>
<p class="calibre3"><span class="kobospan" id="kobo.901.1">The</span><a id="_idIndexMarker124" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.902.1"> same example we looked at previously can be executed in the Snowpark environment after establishing the session by passing a vectorized DataFrame as the input to the </span><span><span class="kobospan" id="kobo.903.1">standard UDF:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.904.1">
import pandas as pd
from snowflake.snowpark.functions import pandas_udf
from snowflake.snowpark.types \
    import IntegerType, PandasSeriesType,StringType
@pandas_udf(
    name='column_adder'
  , stage_location = '@MY_STAGE'
  , input_types=[PandasSeriesType(StringType()), \
        PandasSeriesType(StringType())]
  , return_type=PandasSeriesType(StringType())
  , is_permanent=True
  , replace=True)
def column_adder(
    column1: pd.Series, column2: pd.Series) -&gt; pd.Series:
    return column1 + "," + column2
df = session.table("SAMPLE_EMPLOYEE_DATA")
df.withColumn('City_Country', column_adder(col('CITY'), \
    col('COUNTRY'))).show()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.905.1">The</span><a id="_idIndexMarker125" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.906.1"> example UDF returns the city and country in the </span><strong class="source-inline"><span class="kobospan" id="kobo.907.1">CITY_COUNTRY</span></strong><span class="kobospan" id="kobo.908.1"> column for each row in the </span><strong class="source-inline"><span class="kobospan" id="kobo.909.1">Sample </span></strong><span><strong class="source-inline"><span class="kobospan" id="kobo.910.1">Employee</span></strong></span><span><span class="kobospan" id="kobo.911.1"> table:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer048">
<span class="kobospan" id="kobo.912.1"><img alt="Figure 2.40 – Vectorized UDF in Snowpark" src="image/B19923_02_40.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.913.1">Figure 2.40 – Vectorized UDF in Snowpark</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.914.1">The output shows the execution output of the vectorized UDF. </span><span class="kobospan" id="kobo.914.2">In the next section, we will cover </span><span><span class="kobospan" id="kobo.915.1">stored procedures.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.916.1">Stored procedures</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.917.1">A Python </span><a id="_idIndexMarker126" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.918.1">stored procedure is a series of code statements you can parameterize and execute on demand. </span><span class="kobospan" id="kobo.918.2">They run in a less restricted environment than UDFs and support interacting with Snowflake objects, as well as performing DDL and DML operations </span><span><span class="kobospan" id="kobo.919.1">on tables.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.920.1">Stored procedures</span><a id="_idIndexMarker127" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.921.1"> in Snowpark are utilized for executing tasks and streams within Snowflake’s data processing framework. </span><span class="kobospan" id="kobo.921.2">These stored procedures encapsulate specific logic or functionality, allowing users to perform various operations on data seamlessly. </span><span class="kobospan" id="kobo.921.3">Tasks, which are often associated with batch processing, involve executing predefined actions or workflows on datasets at scheduled intervals. </span><span class="kobospan" id="kobo.921.4">Stored procedures enable users to automate these tasks, ensuring consistent and efficient </span><span><span class="kobospan" id="kobo.922.1">data processing.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.923.1">On the other hand, streams are continuous data pipelines that capture changes in real-time from a data source. </span><span class="kobospan" id="kobo.923.2">Stored procedures play a vital role in managing and processing streams by defining how incoming data should be processed and integrated into the target destination. </span><span class="kobospan" id="kobo.923.3">With Snowpark, users can create stored procedures to handle these streaming data </span><a id="_idIndexMarker128" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.924.1">scenarios, including data transformation, filtering, and loading data into </span><span><span class="kobospan" id="kobo.925.1">Snowflake tables.</span></span></p>
<h4 class="calibre16"><span class="kobospan" id="kobo.926.1">Working with stored procedures</span></h4>
<p class="calibre3"><span class="kobospan" id="kobo.927.1">A stored procedure</span><a id="_idIndexMarker129" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.928.1"> can be created in Snowpark with the </span><span><span class="kobospan" id="kobo.929.1">following template:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.930.1">
# Define Python function locally
def &lt;Python Function Name&gt;(
    snowpark_session: snowflake.snowpark.Session, &lt;arguments&gt;):
    return &lt;Output&gt;
# Imports Required For Stored Procedure
from snowflake.snowpark.types \
    import &lt;specific Snowpark DataType object&gt;
# Optional: Import additional packages or files
snowpark_session.add_packages(
    'List of native packages in Anaconda Channel')
snowpark_session.add_import('Path to Local File')
# Upload Stored Procedure to Snowflake
snowpark_session.sproc.register(
    func = &lt;Function name to register&gt;
  , return_type = &lt;Return Type of Snowpark DataType object&gt;
  , input_types = &lt;[Input Types of Snowflake DataType object]&gt;
  , is_permanent = True
  , name = '&lt;Stored Procedure name&gt;'
  , replace = True
  , stage_location = '@&lt;Stored Procedure stage name&gt;'
    &lt;optional: , execute_as = 'CALLER'&gt;
)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.931.1">Here, we </span><a id="_idIndexMarker130" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.932.1">define the main Python function that will be used in the stored procedure and an additional argument called </span><strong class="source-inline"><span class="kobospan" id="kobo.933.1">snowpark_session</span></strong><span class="kobospan" id="kobo.934.1">, which allows us to interact with Snowflake objects. </span><span class="kobospan" id="kobo.934.2">Next, we use the </span><strong class="source-inline"><span class="kobospan" id="kobo.935.1">sproc.register()</span></strong><span class="kobospan" id="kobo.936.1"> method to create the stored procedure, specifying the Python function, stored procedure’s name, and Snowflake stage for file uploads. </span><span class="kobospan" id="kobo.936.2">Finally, we import specific Snowpark </span><strong class="source-inline"><span class="kobospan" id="kobo.937.1">DataType</span></strong><span class="kobospan" id="kobo.938.1"> objects for the stored procedure’s return value and </span><span><span class="kobospan" id="kobo.939.1">input arguments.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.940.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.941.1">snowflake_session</span></strong><span class="kobospan" id="kobo.942.1"> argument is implicitly understood and not included in the input arguments. </span><span class="kobospan" id="kobo.942.2">Optional rows allow for additional packages and imports. </span><span class="kobospan" id="kobo.942.3">Here, we can determine whether the stored procedure will be temporary. </span><span class="kobospan" id="kobo.942.4">We can also decide whether to overwrite an existing one with the same name and specify whether it will execute as the caller or </span><span><span class="kobospan" id="kobo.943.1">the owner:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.944.1">
def subset_table(snowpark_session:Session):
    df = snowpark_session.table(
        'SAMPLE_EMPLOYEE_DATA').select("NAME","AGE")
    return df.collect()
from snowflake.snowpark.types import StringType
session.add_packages('snowflake-snowpark-python')
session.sproc.register(
    func = subset_table
  , return_type = StringType()
  , input_types = []
  , is_permanent = True
  , name = 'SPROC_SUBSET_TABLE'
  , replace = True
  , stage_location = '@MY_STAGE'
)</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.945.1">The</span><a id="_idIndexMarker131" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.946.1"> stored procedure returns the column name and the age from the </span><strong class="source-inline"><span class="kobospan" id="kobo.947.1">Employee Data</span></strong><span class="kobospan" id="kobo.948.1"> table. </span><span class="kobospan" id="kobo.948.2">It’s registered as </span><strong class="source-inline"><span class="kobospan" id="kobo.949.1">SPROC_SUBSET_TABLE</span></strong><span class="kobospan" id="kobo.950.1"> and uploaded </span><span><span class="kobospan" id="kobo.951.1">through </span></span><span><strong class="source-inline"><span class="kobospan" id="kobo.952.1">My_Stage</span></strong></span><span><span class="kobospan" id="kobo.953.1">:</span></span></p>
<pre class="source-code"><span class="kobospan1" id="kobo.954.1">
session.sql(''' CALL SPROC_SUBSET_TABLE()''').show()</span></pre> <p class="calibre3"><span class="kobospan" id="kobo.955.1">Here’s </span><span><span class="kobospan" id="kobo.956.1">the output:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer049">
<span class="kobospan" id="kobo.957.1"><img alt="Figure 2.41 – Stored procedure execution" src="image/B19923_02_41.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.958.1">Figure 2.41 – Stored procedure execution</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.959.1">The stored procedure can be executed by running the </span><span><strong class="source-inline"><span class="kobospan" id="kobo.960.1">CALL</span></strong></span><span><span class="kobospan" id="kobo.961.1"> command.</span></span></p>
<h3 class="calibre9"><span class="kobospan" id="kobo.962.1">The difference between UDFs and stored procedures</span></h3>
<p class="calibre3"><span class="kobospan" id="kobo.963.1">UDFs and</span><a id="_idIndexMarker132" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.964.1"> stored procedures have significant differences</span><a id="_idIndexMarker133" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.965.1"> in terms of functionality and usage. </span><span class="kobospan" id="kobo.965.2">The following figure shows the basic differences between UDFs and stored procedures and what they’re </span><span><span class="kobospan" id="kobo.966.1">used for:</span></span></p>
<div class="calibre2">
<div class="img---figure" id="_idContainer050">
<span class="kobospan" id="kobo.967.1"><img alt="Figure 2.42 – UDFs versus stored procedures" src="image/B19923_02_42.jpg" class="calibre4"/></span>
</div>
</div>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.968.1">Figure 2.42 – UDFs versus stored procedures</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.969.1">The </span><a id="_idIndexMarker134" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.970.1">following table shows the differences and </span><a id="_idIndexMarker135" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.971.1">similarities between UDFs and stored procedures based on </span><span><span class="kobospan" id="kobo.972.1">their properties:</span></span></p>
<table class="no-table-style" id="table001-1">
<colgroup class="calibre10">
<col class="calibre11"/>
<col class="calibre11"/>
<col class="calibre11"/>
</colgroup>
<tbody class="calibre12">
<tr class="no-table-style1">
<td class="no-table-style2"/>
<td class="no-table-style2">
<p class="calibre3"><span><strong class="bold"><span class="kobospan" id="kobo.973.1">UDF</span></strong></span><span><strong class="bold" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.974.1">s</span></strong></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span><strong class="bold"><span class="kobospan" id="kobo.975.1">Stored Procedure</span></strong></span><span><strong class="bold" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.976.1">s</span></strong></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.977.1">Purpose</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.978.1">Perform calculations and return the results. </span><span class="kobospan" id="kobo.978.2">UDFs require a value to </span><span><span class="kobospan" id="kobo.979.1">be returned.</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.980.1">Perform complex operations by executing SQL statements. </span><span class="kobospan" id="kobo.980.2">They do not require an explicit value to </span><span><span class="kobospan" id="kobo.981.1">be returned.</span></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.982.1">Usage</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.983.1">UDFs can be used when logic needs to be called as part of SQL statements that return </span><span><span class="kobospan" id="kobo.984.1">a value.</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.985.1">When database operations or administrative tasks need to </span><span><span class="kobospan" id="kobo.986.1">be performed.</span></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.987.1">Output</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.988.1">UDFs always need to return </span><span><span class="kobospan" id="kobo.989.1">a result.</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.990.1">Stored procedures don’t need to return </span><span><span class="kobospan" id="kobo.991.1">a result.</span></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.992.1">Context</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.993.1">UDF return values are directly accessible in the </span><span><span class="kobospan" id="kobo.994.1">SQL context.</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.995.1">Stored procedure return values are not accessible in the </span><span><span class="kobospan" id="kobo.996.1">SQL context.</span></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.997.1">Execution</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.998.1">UDFs can be called in the context of another SQL statement. </span><span class="kobospan" id="kobo.998.2">In addition, multiple UDFs can be invoked in a single </span><span><span class="kobospan" id="kobo.999.1">SQL statement.</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.1000.1">Stored procedures are called independently. </span><span class="kobospan" id="kobo.1000.2">Therefore, only a single stored procedure is invoked in a </span><span><span class="kobospan" id="kobo.1001.1">SQL statement.</span></span></p>
</td>
</tr>
<tr class="no-table-style1">
<td class="no-table-style2">
<p class="calibre3"><span><span class="kobospan" id="kobo.1002.1">Security</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.1003.1">UDFs cannot access the database or perform operations directly </span><span><span class="kobospan" id="kobo.1004.1">on it.</span></span></p>
</td>
<td class="no-table-style2">
<p class="calibre3"><span class="kobospan" id="kobo.1005.1">Stored procedures can access the database and perform data operations </span><span><span class="kobospan" id="kobo.1006.1">on it.</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="img---caption" lang="en-US" xml:lang="en-US"><span class="kobospan" id="kobo.1007.1">Table 2.1 – Comparison of UDFs and stored procedures</span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1008.1">Both stored</span><a id="_idIndexMarker136" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1009.1"> procedures and UDFs can be used together </span><a id="_idIndexMarker137" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1010.1">to expand the capabilities of Python execution </span><span><span class="kobospan" id="kobo.1011.1">in Snowflake.</span></span></p>
<h1 id="_idParaDest-39" class="calibre5"><a id="_idTextAnchor039" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1012.1">Establishing a project structure for Snowpark</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.1013.1">To assist</span><a id="_idIndexMarker138" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1014.1"> with the development of Snowpark in Python and to make it easy to create a Snowpark project, Snowflake has released Snowpark</span><a id="_idIndexMarker139" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1015.1"> project templates for Python. </span><span class="kobospan" id="kobo.1015.2">These contain everything you’ll need for developing, testing, and deploying with Snowpark – they provide all the boilerplate required to develop UDFs and stored procedures, along with unit tests and even GitHub Actions workflow files </span><span><span class="kobospan" id="kobo.1016.1">for CI/CD.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1017.1">The project template has been released as open source on GitHub, making it easy for developers to clone and use the project. </span><span class="kobospan" id="kobo.1017.2">To clone the project, follow </span><span><span class="kobospan" id="kobo.1018.1">these steps:</span></span></p>
<ol class="calibre13">
<li class="calibre14"><span class="kobospan" id="kobo.1019.1">Download the files or clone the repository from </span><a href="https://github.com/Snowflake-Labs/snowpark-python-template" class="calibre6 pcalibre1 pcalibre"><span class="kobospan" id="kobo.1020.1">https://github.com/Snowflake-Labs/snowpark-python-template</span></a><span class="kobospan" id="kobo.1021.1">. </span><span class="kobospan" id="kobo.1021.2">A new GitHub repository can be created from the template by using the GitHub CLI, </span><span><span class="kobospan" id="kobo.1022.1">like so:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.1023.1">gh repo create &lt;new-repo-name&gt; --template="Snowflake-Labs/snowpark-python-template"</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.1024.1">The new repository’s name needs to be specified. </span><span class="kobospan" id="kobo.1024.2">The repository will be similar to the Snowpark </span><span><span class="kobospan" id="kobo.1025.1">project template.</span></span></p></li> <li class="calibre14"><span class="kobospan" id="kobo.1026.1">Set up the</span><a id="_idIndexMarker140" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1027.1"> following environment variables so that you can configure the necessary </span><span><span class="kobospan" id="kobo.1028.1">Snowflake details:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.1029.1">SNOWSQL_ACCOUNT=&lt;replace with your account identifier&gt;</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.1030.1">SNOWSQL_USER=&lt;replace with your username&gt;</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.1031.1">SNOWSQL_PWD=&lt;replace with your password&gt;</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.1032.1">SNOWSQL_DATABASE=&lt;replace with your database&gt;</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.1033.1">SNOWSQL_SCHEMA=&lt;replace with your schema&gt;</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.1034.1">SNOWSQL_WAREHOUSE=&lt;replace with your warehouse&gt;</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.1035.1">These </span><a id="_idIndexMarker141" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1036.1">environment variables are required to connect to the Snowflake environment and for Snowpark to establish </span><span><span class="kobospan" id="kobo.1037.1">a session.</span></span></p></li> <li class="calibre14"><span class="kobospan" id="kobo.1038.1">Create an Anaconda virtual environment and install the dependencies from the </span><span><strong class="source-inline1"><span class="kobospan" id="kobo.1039.1">environment.yml</span></strong></span><span><span class="kobospan" id="kobo.1040.1"> file:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.1041.1">conda env create -f environment.yml</span></strong>
<strong class="bold1"><span class="kobospan1" id="kobo.1042.1">conda activate snowpark</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.1043.1">The preceding code creates an Anaconda environment called </span><strong class="source-inline"><span class="kobospan" id="kobo.1044.1">snowpark</span></strong><span class="kobospan" id="kobo.1045.1"> that can be used </span><span><span class="kobospan" id="kobo.1046.1">for development.</span></span></p></li> <li class="calibre14"><span class="kobospan" id="kobo.1047.1">You can test the connection and check if the environment has been set up by executing the </span><strong class="source-inline1"><span class="kobospan" id="kobo.1048.1">app.py</span></strong><span class="kobospan" id="kobo.1049.1"> stored procedure. </span><span class="kobospan" id="kobo.1049.2">Navigate to the project folder and run the </span><span><span class="kobospan" id="kobo.1050.1">following command:</span></span><pre class="source-code">
<strong class="bold1"><span class="kobospan1" id="kobo.1051.1">python src/procs/app.py</span></strong></pre><p class="calibre3"><span class="kobospan" id="kobo.1052.1">This produces an output called </span><strong class="bold"><span class="kobospan" id="kobo.1053.1">Hello World</span></strong><span class="kobospan" id="kobo.1054.1"> that establishes a connection </span><span><span class="kobospan" id="kobo.1055.1">to Snowflake.</span></span></p></li> </ol>
<p class="calibre3"><span class="kobospan" id="kobo.1056.1">The Snowpark project supports functions and stored procedures. </span><span class="kobospan" id="kobo.1056.2">The project structure consists of the </span><strong class="source-inline"><span class="kobospan" id="kobo.1057.1">procs</span></strong><span class="kobospan" id="kobo.1058.1"> directory for stored procedures, the </span><strong class="source-inline"><span class="kobospan" id="kobo.1059.1">udf</span></strong><span class="kobospan" id="kobo.1060.1"> directory for UDFs, and the </span><strong class="source-inline"><span class="kobospan" id="kobo.1061.1">util</span></strong><span class="kobospan" id="kobo.1062.1"> directory </span><a id="_idIndexMarker142" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1063.1">for the utilities methods and classes that are shared between UDFs and </span><span><span class="kobospan" id="kobo.1064.1">stored procedures.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1065.1">The </span><strong class="source-inline"><span class="kobospan" id="kobo.1066.1">test</span></strong><span class="kobospan" id="kobo.1067.1"> folder </span><a id="_idIndexMarker143" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1068.1">consists of the test cases that can be tested via </span><strong class="source-inline"><span class="kobospan" id="kobo.1069.1">pytest</span></strong><span class="kobospan" id="kobo.1070.1">. </span><span class="kobospan" id="kobo.1070.2">There’s also a GitHub workflow that can be deployed via GitHub Actions. </span><span class="kobospan" id="kobo.1070.3">We will cover this in detail in the </span><span><span class="kobospan" id="kobo.1071.1">following chapters.</span></span></p>
<h1 id="_idParaDest-40" class="calibre5"><a id="_idTextAnchor040" class="calibre6 pcalibre1 pcalibre"/><span class="kobospan" id="kobo.1072.1">Summary</span></h1>
<p class="calibre3"><span class="kobospan" id="kobo.1073.1">Snowpark is very versatile and supports complex development patterns. </span><span class="kobospan" id="kobo.1073.2">In this chapter, we learned how to configure the Snowpark development environment and different Snowpark objects, such as sessions, UDFs, and stored procedures, and how to use them. </span><span class="kobospan" id="kobo.1073.3">We also learned how to set up a Snowpark development project locally and inside a Python worksheet before looking at some sample code that we could use to </span><span><span class="kobospan" id="kobo.1074.1">start developing.</span></span></p>
<p class="calibre3"><span class="kobospan" id="kobo.1075.1">In the next chapter, we will cover how to perform data processing with Snowpark, as well as how to ingest, prepare, and </span><span><span class="kobospan" id="kobo.1076.1">analyze data.</span></span></p>
</div>
</body></html>