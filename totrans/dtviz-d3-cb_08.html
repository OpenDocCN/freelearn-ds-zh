<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Chart Them Up"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Chart Them Up</h1></div></div></div><p>In this chapter we will cover:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating a line chart</li><li class="listitem" style="list-style-type: disc">Creating an area chart</li><li class="listitem" style="list-style-type: disc">Creating a scatter plot chart</li><li class="listitem" style="list-style-type: disc">Creating a bubble chart</li><li class="listitem" style="list-style-type: disc">Creating a bar chart</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec59"/>Introduction</h1></div></div></div><p>In this chapter, we will turn our attention to one of the oldest and well trusted companions in data visualization—charts. Charts<a id="id430" class="indexterm"/> are a well defined and well understood graphical representation of data; the following definition just confirms it:</p><div class="blockquote"><blockquote class="blockquote"><p>(In charts) the data is represented by symbols, such as bars in a bar chart, lines in a line chart, or slices in a pie chart.</p><p>Jensen C. &amp; Anderson L. (1991)</p></blockquote></div><p>When charts are used in data visualization, their well understood graphical semantics and syntax relieve the audience of your visualization from the burden of learning the meaning of the graphical metaphor. Hence they can focus on the data itself and the information generated through visualization. The goal of this chapter is not only to introduce some of the commonly used chart types but also demonstrate how the various topics and techniques we have learned so far can be combined and leveraged in producing sleek interactive charts using D3.</p><p>Recipes in this chapter are much longer than the recipes we have encountered so far since they are designed to implement fully functional reusable charts. I have tried to break it into different segments and with consistent chart structures to ease your reading experience. However, it is still highly recommended to open the companion code examples in your browser and your text editor while going through this chapter to minimize potential confusion and maximize the benefit.</p><p>
<span class="strong"><strong>D3 chart convention</strong></span>: Before <a id="id431" class="indexterm"/>we dive into creating our first reusable chart in D3, we need to cover some charting conventions commonly accepted in the D3 community otherwise we might risk creating charting libraries that confuse our user instead of helping them.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note36"/>Note</h3><p>As you would have imagined, D3 charts are most commonly implemented using SVG instead of HTML; however, the convention we discuss here would also apply to HTML-based charts albeit the implementation detail will be somewhat different.</p></div></div><p>Let's first take a look at the following diagram:</p><div class="mediaobject"><img src="graphics/2162OS_08_01.jpg" alt="Introduction"/><div class="caption"><p>D3 chart convention</p></div></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note37"/>Note</h3><p>To see this convention explained by<a id="id432" class="indexterm"/> the creator of D3 please visit <a class="ulink" href="http://bl.ocks.org/mbostock/3019563">http://bl.ocks.org/mbostock/3019563</a>
</p></div></div><p>As shown in this diagram the point of origin (0, 0) in an SVG image is at its top-leftmost corner as expected, however, the most important aspect of this convention pertains to how chart margins are defined and furthermore where the axes are placed.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Margins</strong></span>: First of <a id="id433" class="indexterm"/>all, let us see the most important<a id="id434" class="indexterm"/> aspect of this convention—the margins. As we can see for each chart there are four different margin settings: left, right, top, and bottom margins. A flexible chart implementation should allow its user to set different values for each of these margins and we will see in later recipes how this can be achieved.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Coordinate translation</strong></span>: Secondly, this <a id="id435" class="indexterm"/>convention also suggests that the coordinate reference of the<a id="id436" class="indexterm"/> chart body (grey area) should be defined using a SVG translate transformation <code class="literal">translate(margin.left, margin.top)</code>. This translation effectively moves the chart body area to the desired point, and one additional benefit of this approach is, by shifting the frame of reference for chart body coordinates, it simplifies the job of creating sub-elements inside the chart body since the margin size becomes irrelevant. For any sub-element inside the chart body, its point of origin (0, 0) is now the top-leftmost corner of the chart body area.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Axes</strong></span>: Lastly, the final<a id="id437" class="indexterm"/> aspect of this convention is regarding<a id="id438" class="indexterm"/> how and where chart axes are placed. As shown by this diagram chart axes are placed inside chart margins instead of being part of the chart body. This approach has the advantage of treating axes as peripheral elements in a chart, hence not convoluting the chart body implementation and additionally making axes rendering logic chart-independent and easily reusable.</li></ul></div><p>Now let's create our first reusable D3 chart with all the knowledge and techniques we learned so far.</p></div></div>
<div class="section" title="Creating a line chart"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec60"/>Creating a line chart</h1></div></div></div><p>Line chart <a id="id439" class="indexterm"/>is a <a id="id440" class="indexterm"/>common, basic chart type that is widely used in many fields. This chart consists of a series of data points connected by straight line segments. A line chart is also typically bordered by two perpendicular axes: the x axis and y axis. In this recipe, we will see how this basic chart can be implemented using D3 as a reusable JavaScript object that can be configured to display multiple data series on a different scale. Along with that we will also show the technique of implementing a dynamic multi-data-series update with animation.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec163"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter8/line-chart.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter8/line-chart.html</a>
</p><p>It is highly recommended to have the companion code example open while reading this recipe. </p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec164"/>How to do it...</h2></div></div></div><p>Let's take a look at the<a id="id441" class="indexterm"/> code that implements this chart type. Due the length of the recipe we will only show the outline of the code here while diving into the details in the following <span class="emphasis"><em>How it works...</em></span> section.</p><div class="informalexample"><pre class="programlisting">&lt;script type="text/javascript"&gt;
// First we define the chart object using a functional objectfunction lineChart() { // &lt;-1A
...
    // main render function 
    _chart.render = function () { // &lt;-2A
    ...
    };

    // axes rendering function
    function renderAxes(svg) {
    ...
    }
  ...
    

    // function to render chart body
    function renderBody(svg) { // &lt;-2D        
    ...
    }

    // function to render lines
    function renderLines() {
    ...
    }

 // function to render data points
    function renderDots() {
        
    }

    return _chart; // &lt;-1E
}</pre></div><p>This recipe generates the following chart:</p><div class="mediaobject"><img src="graphics/2162OS_08_02.jpg" alt="How to do it..."/><div class="caption"><p>Line chart</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec165"/>How it works...</h2></div></div></div><p>As we can see, this recipe <a id="id442" class="indexterm"/>is significantly more involved than anything we have encountered so far, so now I will break it into multiple detailed sections with different focuses.</p><p>
<span class="strong"><strong>Chart object and attributes</strong></span>: First, we will take a look at how this chart object<a id="id443" class="indexterm"/> is created<a id="id444" class="indexterm"/> and how associated attributes can be retrieved and set on the chart object.</p><div class="informalexample"><pre class="programlisting">function lineChart() { // &lt;-1A
  var _chart = {};

  var _width = 600, _height = 300, // &lt;-1B
    _margins = {top: 30, left: 30, right: 30, bottom: 30},
    _x, _y,
    _data = [],
    _colors = d3.scale.category10(),
    _svg,
    _bodyG,
    _line;
  ...
  _chart.height = function (h) {// &lt;-1C
    if (!arguments.length) return _height;
    _height = h;
    return _chart;
  };

  _chart.margins = function (m) {
    if (!arguments.length) return _margins;
    _margins = m;
    return _chart;
  };
...
  _chart.addSeries = function (series) { // &lt;-1D
    _data.push(series);
    return _chart;
  };
...
   return _chart; // &lt;-1E
}

...

var chart = lineChart()
  .x(d3.scale.linear().domain([0, 10]))
  .y(d3.scale.linear().domain([0, 10]));

data.forEach(function (series) {
  chart.addSeries(series);
});

chart.render();</pre></div><p>As we can see, the <a id="id445" class="indexterm"/>chart object is defined using a function called <code class="literal">lineChart</code> on line 1A following the functional object pattern we have discussed in the <span class="emphasis"><em>Understanding D3-Style JavaScript</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with D3.js">Chapter 1</a>, <span class="emphasis"><em>Getting Started with D3</em></span>.js. Leveraging the greater flexibility with information hiding offered by the functional object pattern, we have defined a series of internal attributes all named starting with an underscore (line 1B). Some of these attributes are made public by offering accessor function (line 1C). Publically accessible attributes are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">width</code>: Chart SVG total width in pixels</li><li class="listitem" style="list-style-type: disc"><code class="literal">height</code>: Chart SVG total height in pixels</li><li class="listitem" style="list-style-type: disc"><code class="literal">margins</code>: Chart margins</li><li class="listitem" style="list-style-type: disc"><code class="literal">colors</code>: Chart ordinal color scale used to differentiate different data series</li><li class="listitem" style="list-style-type: disc"><code class="literal">x</code>: x axis scale</li><li class="listitem" style="list-style-type: disc"><code class="literal">y</code>: y axis scale<p>The <a id="id446" class="indexterm"/>accessor functions are implemented using the technique we introduced in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with D3.js">Chapter 1</a>, <span class="emphasis"><em>Getting Started with D3.js</em></span>, effectively combining both getter and setter functions in one function, which behaves as a getter when no argument is given and a setter when an argument is present (line 1C). Additionally, both <code class="literal">lineChart</code> function and its accessors, return a chart instance thus allowing function chaining. Finally, the chart object also offers an <code class="literal">addSeries</code> function which simply pushes a data array (<code class="literal">series</code>) into its internal data storage array (<code class="literal">_data</code>), see line 1D.</p><p>
<span class="strong"><strong>Chart body frame rendering</strong></span>: After covering the <a id="id447" class="indexterm"/>basic chart object and its attributes, the next aspect of this reusable chart implementation is the chart body <code class="literal">svg:g</code> element rendering and its clip path generation.</p><div class="informalexample"><pre class="programlisting">_chart.render = function () { // &lt;-2A
  if (!_svg) {
    _svg = d3.select("body").append("svg") // &lt;-2B
      .attr("height", _height)
      .attr("width", _width);

    renderAxes(_svg);

    defineBodyClip(_svg);
  }

  renderBody(_svg);
};
...
function defineBodyClip(svg) { // &lt;-2C
  var padding = 5;

  svg.append("defs")
    .append("clipPath")
    .attr("id", "body-clip")
    .append("rect")
    .attr("x", 0 - padding)
    .attr("y", 0)
    .attr("width", quadrantWidth() + 2 * padding)
    .attr("height", quadrantHeight());
  }

function renderBody(svg) { // &lt;-2D
  if (!_bodyG)
    _bodyG = svg.append("g")
      .attr("class", "body")
      .attr("transform", "translate(" 
        + xStart() + "," 
        + yEnd() + ")") // &lt;-2E
      .attr("clip-path", "url(#body-clip)");        

  renderLines();

  renderDots();
}
...</pre></div><p>The <code class="literal">render</code> function <a id="id448" class="indexterm"/>defined on line 2A is responsible for creating the <code class="literal">svg:svg</code> element and setting its <code class="literal">width</code> and <code class="literal">height</code> (line 2B). After that, it creates an <code class="literal">svg:clipPath</code> element that covers the entire chart body area. The <code class="literal">svg:clipPath</code> element is used to restrict the region where paint can be applied. In our case we use it to restrict where the line and dots can be painted (only within the chart body area). This code generates the following SVG element structure that defines the chart body:</p><div class="mediaobject"><img src="graphics/2162OS_08_03.jpg" alt="How it works..."/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note38"/>Note</h3><p>For more information on clipping<a id="id449" class="indexterm"/> and masking<a id="id450" class="indexterm"/> please visit <a class="ulink" href="http://www.w3.org/TR/SVG/masking.html">http://www.w3.org/TR/SVG/masking.html</a>
</p></div></div><p>The <code class="literal">renderBody</code> function<a id="id451" class="indexterm"/> defined on line 2D generates the <code class="literal">svg:g</code> element which wraps all the chart body content with a translation set according to the chart margin convention we have discussed in the previous section (line 2E).</p><p>
<span class="strong"><strong>Render axes</strong></span>: Axes<a id="id452" class="indexterm"/> are rendered in the function <code class="literal">renderAxes</code> (line 3A).</p><div class="informalexample"><pre class="programlisting">function renderAxes(svg) { // &lt;-3A
  var axesG = svg.append("g")
    .attr("class", "axes");

  renderXAxis(axesG);

  renderYAxis(axesG);
}</pre></div><p>As discussed in the previous<a id="id453" class="indexterm"/> chapter, both x and y axes are rendered inside the chart margin area. We are not going into details about axes rendering since we have discussed this topic in much detail in <a class="link" href="ch05.html" title="Chapter 5. Playing with Axes">Chapter 5</a>, <span class="emphasis"><em>Playing with Axes</em></span>.</p><p>
<span class="strong"><strong>Render data series</strong></span>: Everything <a id="id454" class="indexterm"/>we discussed so far in this recipe is not unique to this chart type alone but rather it is a shared framework among other Cartesian coordinates based chart types. Finally, now we will discuss how the line segments and dots are created for multiple data series. Let's take a look at the following code fragments that are responsible for data series rendering.</p><div class="informalexample"><pre class="programlisting">function renderLines() { 
  _line = d3.svg.line() // &lt;-4A
    .x(function (d) { return _x(d.x); })
    .y(function (d) { return _y(d.y); });
    
  _bodyG.selectAll("path.line")
    .data(_data)
    .enter() // &lt;-4B
    .append("path")                
    .style("stroke", function (d, i) { 
      return _colors(i); // &lt;-4C
    })
    .attr("class", "line");

  _bodyG.selectAll("path.line")
    .data(_data)
    .transition() // &lt;-4D
    .attr("d", function (d) { return _line(d); });
}

function renderDots() {
  _data.forEach(function (list, i) {
    _bodyG.selectAll("circle._" + i) // &lt;-4E
      .data(list)
      .enter()
      .append("circle")
      .attr("class", "dot _" + i);

    _bodyG.selectAll("circle._" + i)
      .data(list)                    
      .style("stroke", function (d, i) { 
        return _colors(i); // &lt;-4F
      })
      .transition() // &lt;-4G
      .attr("cx", function (d) { return _x(d.x); })
      .attr("cy", function (d) { return _y(d.y); })
      .attr("r", 4.5);
    });
}</pre></div><p>The line segments and dots are generated using techniques we introduced in <a class="link" href="ch07.html" title="Chapter 7. Getting into Shape">Chapter 7</a>, <span class="emphasis"><em>Getting into Shape</em></span>. The <code class="literal">d3.svg.line</code> generator was created on line 4A to create <code class="literal">svg:path</code> that maps the data series. The Enter-and-Update pattern is used to create the data line (line 4B). Line 4C sets a different color for each data line based on its index. Lastly, line 4E sets the transition in the update mode to move the data line smoothly on each update. The <code class="literal">renderDots</code> function performs a similar rendering logic that generates a set of <code class="literal">svg:circle</code> elements representing each data point (line 4E), coordinating its color based on the data series index (line 4F), and finally also initiates a transition on line 4G, so the dots can move with the line whenever the data is updated.</p><p>As illustrated by this<a id="id455" class="indexterm"/> recipe, creating a reusable chart component involves actually quite a bit of work. However, more than two-thirds of the code is required in creating peripheral graphical elements and accessors methods. Therefore in a real-world project you can extract this logic and reuse a large part of this implementation for other charts; though we did not do this in our recipes in order to reduce the complexity, so you can quickly grasp all aspects of chart rendering. Due to limited scope in this book, in later recipes we will omit all peripheral rendering logic while only focusing on the core logic related to each chart type.</p></li></ul></div></div></div>
<div class="section" title="Creating an area chart"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec61"/>Creating an area chart</h1></div></div></div><p>An area chart<a id="id456" class="indexterm"/> or an <a id="id457" class="indexterm"/>area graph is very similar to a line chart and largely implemented based on the line chart. The main difference between an area chart and a line chart is that in the area chart, the area between the axis and the line are filled with colors or textures. In this recipe we will explore techniques of implementing a type of area chart known as <a id="id458" class="indexterm"/>
<span class="strong"><strong>Layered Area Chart</strong></span>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec166"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter8/area-chart.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter8/area-chart.html</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec167"/>How to do it...</h2></div></div></div><p>Since an area chart <a id="id459" class="indexterm"/>implementation is largely based on the line chart implementation and it shares a lot of common graphical elements such as the axes and the clip path, therefore in this recipe we will only show the code concerning the area chart implementation specifics:</p><div class="informalexample"><pre class="programlisting">...
function renderBody(svg) {
  if (!_bodyG)
    _bodyG = svg.append("g")
      .attr("class", "body")
      .attr("transform", "translate(" 
        + xStart() + "," 
        + yEnd() + ")") 
      .attr("clip-path", "url(#body-clip)");        

  renderLines();

  renderAreas();

  renderDots();
}

function renderLines() {
  _line = d3.svg.line()
    .x(function (d) { return _x(d.x); })
    .y(function (d) { return _y(d.y); });
    
  _bodyG.selectAll("path.line")
    .data(_data)
    .enter()
    .append("path")
    .style("stroke", function (d, i) { 
      return _colors(i); 
    })
    .attr("class", "line");

  _bodyG.selectAll("path.line")
    .data(_data)
    .transition()
    .attr("d", function (d) { return _line(d); });
}

function renderDots() {
  _data.forEach(function (list, i) {
    _bodyG.selectAll("circle._" + i)
      .data(list)
      .enter().append("circle")
      .attr("class", "dot _" + i);

    _bodyG.selectAll("circle._" + i)
      .data(list)
      .style("stroke", function (d, i) { 
        return _colors(i); 
      })
      .transition()
      .attr("cx", function (d) { return _x(d.x); })
      .attr("cy", function (d) { return _y(d.y); })
      .attr("r", 4.5);
  });
}

<span class="strong"><strong>function renderAreas() {</strong></span>
<span class="strong"><strong>  var area = d3.svg.area() // &lt;-A</strong></span>
<span class="strong"><strong>    .x(function(d) { return _x(d.x); })</strong></span>
<span class="strong"><strong>    .y0(yStart())</strong></span>
<span class="strong"><strong>    .y1(function(d) { return _y(d.y); });</strong></span>

<span class="strong"><strong>  _bodyG.selectAll("path.area")</strong></span>
<span class="strong"><strong>    .data(_data)</strong></span>
<span class="strong"><strong>    .enter() // &lt;-B</strong></span>
<span class="strong"><strong>    .append("path")</strong></span>
<span class="strong"><strong>    .style("fill", function (d, i) { </strong></span>
<span class="strong"><strong>      return _colors(i); </strong></span>
<span class="strong"><strong>    })</strong></span>
<span class="strong"><strong>    .attr("class", "area");</strong></span>

<span class="strong"><strong>  _bodyG.selectAll("path.area")</strong></span>
<span class="strong"><strong>    .data(_data)</strong></span>
<span class="strong"><strong>    .transition() // &lt;-C</strong></span>
<span class="strong"><strong>    .attr("d", function (d) { return area(d); });</strong></span>
<span class="strong"><strong>}</strong></span>
...</pre></div><p>This recipe generates the following layered area chart:</p><div class="mediaobject"><img src="graphics/2162OS_08_04.jpg" alt="How to do it..."/><div class="caption"><p>Layered area chart</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec168"/>How it works...</h2></div></div></div><p>As we mentioned <a id="id460" class="indexterm"/>before, since the area chart implementation is based on our line chart implementation, a large part of the implementation is identical to the line chart. In fact the area chart needs to render the exact line and dots implemented in the line chart. The crucial difference lies in <code class="literal">renderAreas</code> function. In this recipe we rely on the area generation technique discussed in <a class="link" href="ch07.html" title="Chapter 7. Getting into Shape">Chapter 7</a>, <span class="emphasis"><em>Getting into Shape</em></span>. The <code class="literal">d3.svg.area</code> generator was created on line A with its upper line created to match the line while its lower line (<code class="literal">y0</code>) fixed on x-axis.</p><div class="informalexample"><pre class="programlisting">var area = d3.svg.area() // &lt;-A
  .x(function(d) { return _x(d.x); })
  .y0(yStart())
  .y1(function(d) { return _y(d.y); });</pre></div><p>Once the area generator is defined, a classic Enter-and-Update pattern is employed to create and update the areas. In the Enter case (line B), an <code class="literal">svg:path</code> element was created for each data series and colored using its series index so it will have matching color with our line and dots (line C).</p><div class="informalexample"><pre class="programlisting">_bodyG.selectAll("path.area")
  .data(_data)
  .enter() // &lt;-B
  .append("path")
  .style("fill", function (d, i) { 
    return _colors(i); // &lt;-C
  })
  .attr("class", "area");</pre></div><p>Whenever the data is updated, as well as for newly created areas, we start a transition (line D) to update the area <code class="literal">svg:path</code> elements' <code class="literal">d</code> attribute to the desired shape (line E).</p><div class="informalexample"><pre class="programlisting">_bodyG.selectAll("path.area")
  .data(_data)
  .transition() // &lt;-D
  .attr("d", function (d) { 
    return area(d); // &lt;-E
  });</pre></div><p>Since we know that the line chart implementation animates both line and dots when updated, therefore our area update transition here effectively allows the areas to be animated and moved in accordance with both lines and dots in our chart.</p><p>Finally, we also add the<a id="id461" class="indexterm"/> CSS style for <code class="literal">path.area</code> to decrease its opacity so areas become see-through; hence allowing the layered effect we desire.</p><div class="informalexample"><pre class="programlisting">.area {
    stroke: none;
    fill-opacity: .2;
}</pre></div></div></div>
<div class="section" title="Creating a scatter plot chart"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec62"/>Creating a scatter plot chart</h1></div></div></div><p>A scatter plot <a id="id462" class="indexterm"/>or <a id="id463" class="indexterm"/>scatter graph is another common type of diagram used to display data points on Cartesian coordinates with two different variables. Scatter plot is especially useful when exploring the problem of clustering and classification. In this recipe, we will learn how to implement a multi-series scatter plot chart in D3.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec169"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter8/scatterplot-chart.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter8/scatterplot-chart.html</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec170"/>How to do it...</h2></div></div></div><p>A scatter plot is another chart which uses Cartesian coordinates. Thus, a large part of its implementation is very similar to the charts we have introduced so far, therefore the code concerning peripheral graphical elements are again omitted to save space in this book. Please review the<a id="id464" class="indexterm"/> companion code for the complete implementation.</p><div class="informalexample"><pre class="programlisting">...
_symbolTypes = d3.scale.ordinal() // &lt;-A
  .range(["circle",
    "cross",
    "diamond",
    "square",
    "triangle-down",
    "triangle-up"]);
...
function renderBody(svg) {
  if (!_bodyG)
    _bodyG = svg.append("g")
      .attr("class", "body")                    
      .attr("transform", "translate(" 
        + xStart() + "," 
        + yEnd() + ")") 
      .attr("clip-path", "url(#body-clip)");

  renderSymbols();
}

function renderSymbols() { // &lt;-B
  _data.forEach(function (list, i) {
    _bodyG.selectAll("path._" + i)
      .data(list)
      .enter()
      .append("path")
      .attr("class", "symbol _" + i);

    _bodyG.selectAll("path._" + i)
      .data(list)
      .classed(_symbolTypes(i), true)
      .transition()
      .attr("transform", function(d){
        return "translate("
          + _x(d.x)
          + ","
          + _y(d.y)
          + ")";
      })
      .attr("d", 
    d3.svg.symbol().type(_symbolTypes(i)));
  });
}
...</pre></div><p>This recipe generates a <a id="id465" class="indexterm"/>scatter plot chart:</p><div class="mediaobject"><img src="graphics/2162OS_08_05.jpg" alt="How to do it..."/><div class="caption"><p>Scatter plot chart </p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec171"/>How it works...</h2></div></div></div><p>The content of the scatter plot chart is mainly rendered by the <code class="literal">renderSymbols</code> function on line B. You probably have already noticed that the <code class="literal">renderSymbols</code> function implementation is very similar to the <code class="literal">renderDots</code> function<a id="id466" class="indexterm"/> we discussed in the <span class="emphasis"><em>Creating a line chart</em></span> recipe. This is not <a id="id467" class="indexterm"/>by accident since both are trying to plot data points on Cartesian coordinates with two variables (x and y). In the case of plotting dots, we were creating <code class="literal">svg:circle</code> elements, while in scatter plot we need to create <code class="literal">d3.svg.symbol</code> elements. D3 provides a list of predefined symbols that can be generated easily and rendered using an <code class="literal">svg:path</code> element. On line A we defined an ordinal scale to allow mapping of data series index to different symbol types:</p><div class="informalexample"><pre class="programlisting">_symbolTypes = d3.scale.ordinal() // &lt;-A
  .range(["circle",
    "cross",
    "diamond",
    "square",
    "triangle-down",
    "triangle-up"]);</pre></div><p>Plotting the data points with symbols is quite straight-forward. First we loop through the data series array and for each data series we create a set of <code class="literal">svg:path</code> elements representing each data point in the series.</p><div class="informalexample"><pre class="programlisting">_data.forEach(function (list, i) {
  _bodyG.selectAll("path._" + i)
    .data(list)
    .enter()
    .append("path")
    .attr("class", "symbol _" + i);
    ...
});</pre></div><p>Whenever data series are updated, as well as for newly created symbols, we apply the update with transition (line C) placing them on the right coordinates with an SVG translation transformation (line D).</p><div class="informalexample"><pre class="programlisting">_bodyG.selectAll("path._" + i)
  .data(list)
    .classed(_symbolTypes(i), true)
  .transition() // &lt;-C
    .attr("transform", function(d){
      return "translate(" // &lt;-D
        + _x(d.x) 
        + "," 
        + _y(d.y) 
        + ")";
    })
    .attr("d", 
      d3.svg.symbol() // &lt;-E
      .type(_symbolTypes(i))
  );</pre></div><p>Finally, the <code class="literal">d</code> attribute of each <code class="literal">svg:path</code> element is generated using the <code class="literal">d3.svg.symbol</code> generator function as shown on line E.</p></div></div>
<div class="section" title="Creating a bubble chart"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec63"/>Creating a bubble chart</h1></div></div></div><p>A bubble chart <a id="id468" class="indexterm"/>is a<a id="id469" class="indexterm"/> typical visualization capable of displaying three data dimensions. Every data entity with its three data points is visualized as a bubble (or disk) on Cartesian coordinates, with two different variables represented using x axis and y axis, similar to the scatter plot chart. While the third dimension is represented using the radius of the bubble (size of the disk). Bubble chart is particularly useful when used to facilitate understanding of relationships between data entities.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec172"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter8/bubble-chart.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter8/bubble-chart.html</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec173"/>How to do it...</h2></div></div></div><p>In this recipe we will<a id="id470" class="indexterm"/> explore techniques and ways of implementing a typical bubble chart using D3. The following code example shows the important implementation aspects of a bubble chart with accessors and peripheral graphic implementation details omitted.</p><div class="informalexample"><pre class="programlisting">...
var _width = 600, _height = 300,
  _margins = {top: 30, left: 30, right: 30, bottom: 30},
  <span class="strong"><strong>_x, _y, _r, // &lt;-A</strong></span>
  _data = [],
  _colors = d3.scale.category10(),
  _svg,
  _bodyG;

  _chart.render = function () {
    if (!_svg) {
      _svg = d3.select("body").append("svg")
      .attr("height", _height)
      .attr("width", _width);

    renderAxes(_svg);

    defineBodyClip(_svg);
  }

  renderBody(_svg);
};
...
function renderBody(svg) {
  if (!_bodyG)
    _bodyG = svg.append("g")
      .attr("class", "body")
      .attr("transform", "translate(" 
        + xStart() 
        + "," 
        + yEnd() + ")")
      .attr("clip-path", "url(#body-clip)");
  renderBubbles();
}

<span class="strong"><strong>function renderBubbles() {</strong></span>
<span class="strong"><strong>  _r.range([0, 50]); // &lt;-B</strong></span>
<span class="strong"><strong>  </strong></span>
<span class="strong"><strong>  _data.forEach(function (list, i) {</strong></span>
<span class="strong"><strong>    _bodyG.selectAll("circle._" + i)</strong></span>
<span class="strong"><strong>      .data(list)</strong></span>
<span class="strong"><strong>      .enter()</strong></span>
<span class="strong"><strong>      .append("circle") // &lt;-C</strong></span>
<span class="strong"><strong>      .attr("class", "bubble _" + i);</strong></span>

<span class="strong"><strong>    _bodyG.selectAll("circle._" + i)</strong></span>
<span class="strong"><strong>      .data(list)</strong></span>
<span class="strong"><strong>      .style("stroke", function (d, j) { </strong></span>
<span class="strong"><strong>        return _colors(j); </strong></span>
<span class="strong"><strong>      })</strong></span>
<span class="strong"><strong>      .style("fill", function (d, j) { </strong></span>
<span class="strong"><strong>        return _colors(j); </strong></span>
<span class="strong"><strong>      })</strong></span>
<span class="strong"><strong>      .transition()</strong></span>
<span class="strong"><strong>      .attr("cx", function (d) { </strong></span>
<span class="strong"><strong>        return _x(d.x); // &lt;-D</strong></span>
<span class="strong"><strong>      })</strong></span>
<span class="strong"><strong>      .attr("cy", function (d) { </strong></span>
<span class="strong"><strong>        return _y(d.y); // &lt;-E</strong></span>
<span class="strong"><strong>      })</strong></span>
<span class="strong"><strong>      .attr("r", function (d) { </strong></span>
<span class="strong"><strong>        return _r(d.r); // &lt;-F</strong></span>
<span class="strong"><strong>      });</strong></span>
<span class="strong"><strong>  });</strong></span>
}
...</pre></div><p>This recipe generates the following visualization:</p><div class="mediaobject"><img src="graphics/2162OS_08_06.jpg" alt="How to do it..."/><div class="caption"><p>Bubble chart</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec174"/>How it works...</h2></div></div></div><p>Overall, bubble chart <a id="id471" class="indexterm"/>implementation follows the same pattern as other chart implementations introduced in this chapter so far. However, since in bubble chart we want to visualize three different dimensions (x, y, and radius) instead of two, therefore a new scale <code class="literal">_r</code> was added in this implementation (line A).</p><div class="informalexample"><pre class="programlisting">var _width = 600, _height = 300,
  _margins = {top: 30, left: 30, right: 30, bottom: 30},
  _x, _y, _r, // &lt;-A
  _data = [],
  _colors = d3.scale.category10(),
  _svg,
  _bodyG;</pre></div><p>Most of the bubble chart related implementation details are handled<a id="id472" class="indexterm"/> by the <code class="literal">renderBubbles</code> function. It<a id="id473" class="indexterm"/> starts with setting the range on the radius scale (line B). Of course we can also make the radius range configurable in our chart implementation; however, for simplicity we chose to set it explicitly here:</p><div class="informalexample"><pre class="programlisting">function renderBubbles() {
  _r.range([0, 50]); // &lt;-B
  
  _data.forEach(function (list, i) {
    _bodyG.selectAll("circle._" + i)
      .data(list)
      .enter()
      .append("circle") // &lt;-C
      .attr("class", "bubble _" + i);

    _bodyG.selectAll("circle._" + i)
      .data(list)
      .style("stroke", function (d, j) { 
        return _colors(j); 
      })
      .style("fill", function (d, j) { 
        return _colors(j); 
      })
      .transition()
      .attr("cx", function (d) { 
        return _x(d.x); // &lt;-D
      })
      .attr("cy", function (d) { 
        return _y(d.y); // &lt;-E
      })
      .attr("r", function (d) { 
        return _r(d.r); // &lt;-F
      });
  });
}</pre></div><p>Once the range is set, then we iterated through our data series and for each series we created a set of <code class="literal">svg:circle</code> elements (line C). Finally we handled the newly created bubble as well as its update <a id="id474" class="indexterm"/>in the last section, where <code class="literal">svg:circle</code> elements are colored and placed to the correct coordinates using its <code class="literal">cx</code> and <code class="literal">cy</code> attributes (line D and E). In the end, the bubble size is controlled using its radius attribute <code class="literal">r </code>mapped using the <code class="literal">_r</code> scale we defined earlier (line F).</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip41"/>Tip</h3><p>In some bubble chart implementations, the implementer also leverages the color of each bubble to visualize a fourth data dimension, though some believe this kind of visual representation is hard to grasp and superfluous.</p></div></div></div></div>
<div class="section" title="Creating a bar chart"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec64"/>Creating a bar chart</h1></div></div></div><p>A bar chart <a id="id475" class="indexterm"/>is a<a id="id476" class="indexterm"/> visualization that uses either horizontal (row charts) or vertical (column charts) rectangular bars with length proportional to the values that they represent. In this recipe we will implement a column chart using D3. A column chart is capable of visually representing two variables at the same time with its y axis; in other words, the bar height, and its x axis. The x axis values can be either discrete or continuous (for example, a histogram). In our example we choose to visualize continuous values on the x axis and hence effectively implementing a histogram. However, the same techniques can be applied when working with discrete values.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec175"/>Getting ready</h2></div></div></div><p>Open your local copy of the following file in your web browser:</p><p>
<a class="ulink" href="https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter8/bar-chart.html">https://github.com/NickQiZhu/d3-cookbook/blob/master/src/chapter8/bar-chart.html</a>
</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec176"/>How to do it...</h2></div></div></div><p>The following code<a id="id477" class="indexterm"/> example shows the important implementation aspects of a histogram with accessors and peripheral graphic implementation details omitted.</p><div class="informalexample"><pre class="programlisting">...
var _width = 600, _height = 250,
  _margins = {top: 30, left: 30, right: 30, bottom: 30},
  _x, _y,
  _data = [],
  _colors = d3.scale.category10(),
  _svg,
  _bodyG;

  _chart.render = function () {
    if (!_svg) {
      _svg = d3.select("body").append("svg")
        .attr("height", _height)
        .attr("width", _width);

    renderAxes(_svg);

    defineBodyClip(_svg);
  }

  renderBody(_svg);
};
...
function renderBody(svg) {
  if (!_bodyG)
    _bodyG = svg.append("g")
      .attr("class", "body")
      .attr("transform", "translate(" 
        + xStart() 
        + "," 
        + yEnd() + ")")
      .attr("clip-path", "url(#body-clip)");

  renderBars();
  }

<span class="strong"><strong>function renderBars() {</strong></span>
<span class="strong"><strong>  var padding = 2; // &lt;-A</strong></span>
<span class="strong"><strong>  </strong></span>
<span class="strong"><strong>  _bodyG.selectAll("rect.bar")</strong></span>
<span class="strong"><strong>    .data(_data)</strong></span>
<span class="strong"><strong>    .enter()</strong></span>
<span class="strong"><strong>    .append("rect") // &lt;-B</strong></span>
<span class="strong"><strong>    .attr("class", "bar");</strong></span>

<span class="strong"><strong>  _bodyG.selectAll("rect.bar")</strong></span>
<span class="strong"><strong>    .data(_data)                    </strong></span>
<span class="strong"><strong>    .transition()</strong></span>
<span class="strong"><strong>    .attr("x", function (d) { </strong></span>
<span class="strong"><strong>      return _x(d.x); // &lt;-C</strong></span>
<span class="strong"><strong>    })</strong></span>
<span class="strong"><strong>    .attr("y", function (d) { </strong></span>
<span class="strong"><strong>      return _y(d.y); // &lt;-D </strong></span>
<span class="strong"><strong>    })</strong></span>
<span class="strong"><strong>    .attr("height", function (d) { </strong></span>
<span class="strong"><strong>      return yStart() - _y(d.y); // &lt;-E</strong></span>
<span class="strong"><strong>    })</strong></span>
<span class="strong"><strong>    .attr("width", function(d){</strong></span>
<span class="strong"><strong>      return Math.floor(quadrantWidth() / _data.length) - padding;</strong></span>
<span class="strong"><strong>  });</strong></span>
<span class="strong"><strong>}</strong></span>
...</pre></div><p>This recipe generates the following visualization:</p><div class="mediaobject"><img src="graphics/2162OS_08_07.jpg" alt="How to do it..."/><div class="caption"><p>Bar chart (histogram)</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec177"/>How it works...</h2></div></div></div><p>One major difference<a id="id478" class="indexterm"/> here is that the bar chart implementation does not support multiple data series. Therefore instead of using a 2-dimensional array storing multiple data series as we did with other charts so far, in this implementation, the <code class="literal">_data</code> array simply stores a single set of data points directly. Main bar chart related visualization logic <a id="id479" class="indexterm"/>resides in the <code class="literal">renderBars</code> function.</p><div class="informalexample"><pre class="programlisting">function renderBars() {
  var padding = 2; // &lt;-A
  ...
}</pre></div><p>In the first step, we defined the padding between bars (line A), so later on we can automatically calculate the width of each bar. Afterwards we generate an <code class="literal">svg:rect</code> element (the bars) for each data point (line B).</p><div class="informalexample"><pre class="programlisting">_bodyG.selectAll("rect.bar")
  .data(_data)
  .enter()
  .append("rect") // &lt;-B
  .attr("class", "bar");</pre></div><p>Then in the update section <a id="id480" class="indexterm"/>we place each bar at the correct coordinates using its <code class="literal">x</code> and <code class="literal">y</code> attributes (line C and D) and extend each bar all the way down to touch the x axis with an adaptive <code class="literal">height</code> calculated on line E.</p><div class="informalexample"><pre class="programlisting">_bodyG.selectAll("rect.bar")
  .data(_data)
  .transition()
  .attr("x", function (d) { 
    return _x(d.x); // &lt;-C
  })
  .attr("y", function (d) { 
    return _y(d.y); // &lt;-D 
  })
  .attr("height", function (d) { 
    return yStart() - _y(d.y); // &lt;-E
  })</pre></div><p>Finally we calculate the optimal width for each bar using the number of bars as well as the padding value we have defined earlier.</p><div class="informalexample"><pre class="programlisting">.attr("width", function(d){
  return Math.floor(quadrantWidth() / _data.length) - padding;
});</pre></div><p>Of course in a more flexible implementation, we can make the padding configurable instead of being fixed to 2 pixels.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec178"/>See also</h2></div></div></div><p>Before planning to implement your own reusable chart for your next visualization project, make sure you also check out the following open source reusable chart projects based on <a id="id481" class="indexterm"/>D3:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">NVD3: <a class="ulink" href="http://nvd3.org/">http://nvd3.org/</a>.</li><li class="listitem" style="list-style-type: disc">Rickshaw<a id="id482" class="indexterm"/>: <a class="ulink" href="http://code.shutterstock.com/rickshaw/">http://code.shutterstock.com/rickshaw/</a>.</li></ul></div></div></div></body></html>