<html><head></head><body><div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Cloud Geodatabase Analysis and Visualization</h1>
                </header>
            
            <article>
                
<p>This chapter will cover <strong>CARTOframes</strong>, a Python package released by location intelligence software company CARTO in November 2017. It offers a Python interface for working with the CARTO stack, enabling integration of CARTO maps, analysis, and data services into data science workflows.</p>
<p>This chapter will cover the following topics:</p>
<ul>
<li>The specifics of the CARTOframes Python library</li>
<li>Getting familiar with the CARTO stack and how CARTOframes interacts with different parts of it</li>
<li>How to install CARTOframes, its package requirements, and documentation</li>
<li>The different package dependencies of CARTOframes</li>
<li>How to get a CARTO API key</li>
<li>Setting up a CARTO Builder account</li>
<li>Virtual environments</li>
<li>Using Jupyter Notebook</li>
<li>Installing GeoPandas</li>
</ul>
<p>A Python package created with data scientists in mind, CARTOframes is a data science tool that combines CARTO's SaaS offerings and web mapping tools with Python data science workflows. Released in late 2017 by CARTO (<a href="https://carto.com">www.carto.com)</a>, it is available for download through GitHub and the <strong>Python Package Index</strong> (<strong>PyPI</strong>) repository.</p>
<p>The package can be seen as a way to integrate CARTO elements with data science workflows, using Jupyter Notebooks as a working environment. This not only makes it attractive to use for data scientists, but also allows you to save and distribute code and workflows through Jupyter Notebooks. These data science workflows can be extended by using CARTO's services, such as hosted, dynamic, or static maps and datasets from CARTO's Data Observatory—all available through CARTO's cloud platform. This platform is accessed through an API key, which needs to be used when using CARTOframes in a Jupyter Notebook. We'll describe how to get an API key and how to install the CARTOframes package shortly.</p>
<p>The package offers functionality to read and write different types of spatial data. For instance, you can write <kbd>pandas</kbd> dataframes to CARTO tables, as well as read CARTO tables and queries into <kbd>pandas</kbd> dataframes. The CARTOframes package brings external data location data services from CARTO into the Jupyter Notebook, such as location data services, cloud-based data storage, CARTOColors (a set of custom color palettes built on top of well-known standards for color use on maps), PostGIS, and animated maps.</p>
<p>One good reason for using CARTOframes is because of its plotting capabilities. It is a good alternative to other map-plotting packages such as GeoPandas, <kbd>matplotlib</kbd>, Folio, and GeoNotebook. All these packages have their advantages and disadvantages. For example, <kbd>matplotlib</kbd> is not an easy package to learn and requires a lot of code for basic maps. This is not the case with CARTOframes, and the results look impressive, especially because of the use of colors, combined with dynamic images (time-lapses) and easy commands to read, write, query, plot and delete data. </p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">How to install CARTOframes</h1>
                </header>
            
            <article>
                
<p>The CARTOframes library can be best installed by starting Anaconda Navigator and creating a new environment. From there, you can open a terminal and use <kbd>pip</kbd> install, which will install the library for you. This is currently the only way to install it (there's no <kbd>conda</kbd> support yet). Use the following command:</p>
<pre><strong>&gt;&gt;pip install cartoframes</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Additional resources</h1>
                </header>
            
            <article>
                
<p>CARTOframes documentation can be found, at: <a href="http://cartoframes.readthedocs.io/en/latest/">http://CARTOframes.readthedocs.io/en/latest/</a>.<a href="http://cartoframes.readthedocs.io/en/latest/"/></p>
<p>The current version of CARTOframes is 0.5.5. The PyPi repository for CARTOframes can be accessed here: <a href="https://pypi.python.org/pypi/cartoframes">https://pypi.python.org/pypi/CARTOframes</a>.</p>
<p>There's also a GitHub repository with additional information, as one of the many CARTO GitHub repositories: <a href="https://github.com/CartoDB/cartoframes">https://github.com/CARTODB/CARTOframes.</a> </p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Jupyter Notebooks</h1>
                </header>
            
            <article>
                
<p>It is recommended to use CARTOframes in Jupyter Notebooks. In the example scripts later in this chapter, we'll be using the CARTOframes package with other geospatial packages, so you might want to install it in a virtual environment together with GeoPandas, so that you'll have access to its dependencies as well. Consult the installation guides for GeoPandas and other libraries in <a href="757a81a6-cc47-4f08-88d2-b50480eb32e6.xhtml">Chapter 2</a>, <em>Introduction to Geospatial Code Libraries</em>. You can install the Jupyter Notebook app in a separate Python environment with the following command, in a terminal window:</p>
<pre><strong>&gt;&gt;pip install jupyter</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">The CARTO API key</h1>
                </header>
            
            <article>
                
<p>After installing CARTOframes, we need to create a CARTO API key in order to be able to use the functionality from the library. The library interacts with the CARTO infrastructure, similarly to the ArcGIS API for Python in <a href="399c3041-569f-400a-83f0-e13020a177cf.xhtml">Chapter 9</a>, <em>ArcGIS API for Python and ArcGIS Online</em>. The API key can be used for writing dataframes to an account, reading from private tables, and visualizing data on maps. CARTO provides API keys for education and nonprofit uses, among others. If you're a student, you can get access to an API key by signing up to GitHub's student developer pack: <a href="https://education.github.com/pack">https://education.github.com/pack. </a></p>
<div class="packt_tip">Another option is to become a CARTO ambassador: <br/>
<a href="https://CARTO.com/community/ambassadors/">https://carto.com/community/ambassadors/.</a> </div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Package dependencies</h1>
                </header>
            
            <article>
                
<p><strong> </strong>CARTOframes depends on a number of Python libraries that are installed automatically once you run the <kbd>pip</kbd> install command. The following Python libraries are installed:</p>
<ul>
<li><kbd>ipython</kbd>: Provides a rich toolkit for using Python interactively</li>
<li><kbd>appdirs</kbd>: A small Python module for determining appropriate platform-specific directories</li>
<li><kbd>carto</kbd>: Provides an SDK around CARTO's APIs</li>
<li><kbd>chardet</kbd>: A universal encoding detector for Python 2 and 3</li>
<li><kbd>colorama</kbd>: Enables colored terminal text and cursor positioning in MS Windows</li>
<li><kbd>decorator</kbd>: Preserves the signature of decorated functions consistently across Python releases</li>
<li><kbd>future</kbd>: Offers a compatibility layer between Python 2 and Python 3</li>
<li><kbd>idna</kbd>: Offers support for <strong>Internationalized Domain Names in Applications</strong> (<strong>IDNA</strong>)</li>
<li><kbd>ipython-genutils</kbd>: Vestigial utilities from IPython</li>
<li><kbd>jedi</kbd>: An autocompletion tool for Python that can be used for text editors</li>
<li><kbd>numpy</kbd>: Performs array processing for numbers, strings, records, and objects</li>
<li><kbd>pandas</kbd>: Offers powerful data structures for data analysis, time series, and statistics</li>
<li><kbd>parso</kbd>: A Python parser that supports error recovery for different Python versions, and more</li>
<li><kbd>pickleshare</kbd>: A small shelve-like datastore with concurrency support</li>
<li><kbd>prompt-toolkit</kbd>: A library for building powerful interactive command lines in Python</li>
<li><kbd>pygments</kbd>: A syntax highlighting package written in Python</li>
<li><kbd>pyrestcli</kbd>: A generic REST client for Python</li>
<li><kbd>python-dateutil</kbd>: Offers extensions to the standard Python <kbd>datetime</kbd> module</li>
<li><kbd>pytz</kbd>: Provides modern and historical world timezone definitions</li>
<li><kbd>requests</kbd>: An HTTP <kbd>requests</kbd> library</li>
<li><kbd>simplegeneric</kbd>: Lets you define simple single-dispatch generic functions</li>
<li><kbd>six</kbd>: A Python 2 and 3 compatibility library</li>
<li><kbd>tqdm</kbd>: Offers a fast, extensible progress meter</li>
<li><kbd>traitlets</kbd>: A configuration system for Python applications</li>
<li><kbd>urllib3</kbd>: An HTTP library with thread-safe connection pooling, file post, and more</li>
<li><kbd>wcwidth</kbd>: Measures the number of terminal column cells of wide-character codes</li>
<li><kbd>webcolors</kbd>: A library for working with color names and color value formats defined by HTML and CSS</li>
</ul>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">The CARTO Data Observatory</h1>
                </header>
            
            <article>
                
<p>You can augment the CARTOframes library by using the CARTO Data Observatory, an online data service from CARTO. It provides three things—out-of-the-box location data, access to a catalog of analyzed data methods, and the opportunity to build location intelligence apps on top of fast APIs. This data service was created with the idea in mind that data available on the web has to be searchable, and therefore labeled well. To be able to find this data, provide a context to your data, and use it for spatial analysis is what is possible with this service.</p>
<p>The CARTO Data Observatory is available for CARTO enterprise users, which requires a paid subscription. In this chapter, we won't cover this option, but we mention it here as to give you an idea of what is possible with the CARTOframes library.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Signing up for a CARTO account</h1>
                </header>
            
            <article>
                
<p>To be able to use CARTOframes, and to interact with data stored in the cloud-based PostGIS database service that CARTO offers, it is necessary to sign up for a CARTO account. While free accounts are available, with limited storage capacity and access to existing data resources, it is necessary to have a paid account to use CARTOframes, as these accounts are provided API keys. The API key will be used by CARTOframes to identify the account, with each data request sent to the user's cloud geodatabase.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">A free trial of CARTO</h1>
                </header>
            
            <article>
                
<p>By signing up, the account is initially a paid account with access to all CARTO features. The paid account offers a free 30-day trial that can be used to for evaluation purposes. Go to the site <a href="http://carto.com/signup">https://carto.com/signup</a> and create an account:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/9dd2dcdb-9ab0-4a3d-9c24-bbf172f2b1c9.png" style="width:33.75em;height:40.17em;" width="794" height="945"/></div>
<p>Once the account has been created, the 30-day trial period begins. This will allow you to add data to the cloud database, or to access publicly available data from the CARTO library. It also allows you to easily publish a map. Click on the <span class="packt_screen">NEW MAP</span> button to get started:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/72034ea5-69c4-483f-b163-1be4c3f298f5.png" width="1451" height="757"/></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Adding a dataset</h1>
                </header>
            
            <article>
                
<p>Using the <span class="packt_screen">DATA LIBRARY</span> tab, add the <span class="packt_screen">Portland</span> <span class="packt_screen">building footprints</span> to the map. Select the data set from the list, and then push <span class="packt_screen">Create Map</span>. The dataset will be added to the account datasets tab, and to the map creation interface called Builder:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/d1ab5f89-5baa-4c17-8e10-a7b56944b76a.png" width="1916" height="977"/></div>
<p>The dataset is added as a layer to the map. All aspects of the layer can be manipulated in the map editor, including the color of the layer, the attributes shown, the pop-up window, and more. The basemap can also be adjusted. </p>
<p>Widgets, representing live data from attributes, can be added as well. I've added the <span class="packt_screen">US Census Tracts</span> layer from the <span class="packt_screen">DATA LIBRARY</span> to the map, and added a graphing widget that will display values from a selected attribute field. This graph is dynamic, and will adjust the values displayed based on the specific census tracts which are shown in the map window:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/27049833-8a32-455e-97a9-2bcad929301f.png" width="1800" height="974"/></div>
<p>Check out the other tabs in Builder, including <span class="packt_screen">DATA</span>, <span class="packt_screen">ANALYSIS</span>,<span class="packt_screen"> </span><span class="packt_screen">STYLE</span>, <span class="packt_screen">POP-UP</span>,<span class="packt_screen"><span class="packt_screen"> </span></span>and<span class="packt_screen"><span class="packt_screen"> </span>LEGEND</span>, to further customize the map. There are a number of adjustments and widgets that will make the data interactive. The map can also be made either public or private, and can be published to the web by pushing the <span class="packt_screen">PUBLISH</span> button. CARTO's editors and data ingestion interface make it really easy to create and share maps.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">The API key</h1>
                </header>
            
            <article>
                
<p>To connect to the CARTO account using CARTOframes, an API key is required. To access it, go to the account dashboard, click on the image in the upper right, and select the <span class="packt_screen">Your API keys</span> link from the drop-down menu:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/4c3e11e3-b0e6-4aeb-92b8-404730089c84.png" width="1666" height="940"/></div>
<p>The API key is a long string of text used to ensure that the scripts we will write can have access to the account and the datasets associated with it. When it is time to write scripts, copy the key text and assign it to a variable as a Python string within the script:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/a0c47392-c9d3-4715-83d2-f9451d440ed4.png" style="width:40.58em;height:20.58em;" width="1475" height="748"/> </div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Adding a dataset</h1>
                </header>
            
            <article>
                
<p>There is a handy method for adding data from your computer to the account. However, when adding shapefiles, all of the data files that make up the shapefile must be in a ZIP file. We'll add the NBA arenas shapefile from <a href="e483966e-f5c7-47dd-a40c-9b8b6f807107.xhtml">Chapter 11</a>, <em>Flask and GeoAlchemy2</em>, as a ZIP file to the account. Click on the <span class="packt_screen">NEW DATASET</span> button in the <span class="packt_screen">DATASETS</span> area of your dashboard:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/d07aa76d-d9d7-432a-a995-e141a3ba494b.png" width="983" height="303"/></div>
<p>Once the <span class="packt_screen">NEW DATASET</span> button is pushed, and the <span class="packt_screen">CONNECT DATASET</span> interface appears, click on <span class="packt_screen">BROWSE</span> and navigate to the zipped file to upload it:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/d141f6df-1a86-432f-9824-72c5c031b29b.png" style="width:46.33em;height:27.17em;" width="927" height="542"/></div>
<p>Upon completion of the upload process, the data will be given a URL and can be edited using Builder. It can also be edited using CARTOframes. </p>
<p>Now that the account is set up, and a dataset has been added from a local file as well as from the <span class="packt_screen">DATA LIBRARY</span>, we need to set up the Python environment on our local machine to be able to connect to the data stored in the account.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Virtual environments</h1>
                </header>
            
            <article>
                
<p>To manage the installation of CARTOframes and the other associated Python 3 modules, we will be using the virtual environments package <kbd>virtualenv</kbd>. This Python module makes it easy to set up completely separate Python installations on the same computer. Using <kbd>virtualenv</kbd>, a copy of Python is created, and when activated, all modules that are installed are separate from the main Python installation (in other words, the modules installed inside a virtual environment will not be added to the main <kbd>site-packages</kbd> folder). This allows for a lot less package management headaches.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Installing virtualenv</h1>
                </header>
            
            <article>
                
<p>Installation of the <kbd>virtualenv</kbd> package is easy when using <kbd>pip</kbd> from PyPI (<a href="http://pypi.org">pypi.org</a>):</p>
<pre><strong>pip install virtualenv</strong></pre>
<p>This command will add <kbd>virtualenv</kbd> and its supporting modules. Make sure that the main Python installation has been added to the path Windows environment variables so that <kbd>virtualenv</kbd> can be called from the command line.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Running virtualenv</h1>
                </header>
            
            <article>
                
<p>To create the virtual environment, open a command line and enter the following command structure, <kbd>virtualenv {environment name}</kbd><em>.</em> In this case, the name of the environment is <kbd>cartoenv</kbd>:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/b9f8c0a8-f588-40ac-85d4-0d419eae77cb.png" width="966" height="98"/></div>
<p>Inside the folder where <kbd>virtualenv</kbd> is created, a series of folders are generated with the code files necessary to support Python. There is also a <kbd>Lib</kbd> folder, which contains the <kbd>site-packages</kbd> folder that will hold all of the modules installed inside this virtual version of Python:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/bb44e0fd-ef8d-4500-86cf-51804eaf0c00.png" style="width:61.17em;height:27.08em;" width="1065" height="471"/></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Activating the virtual environment</h1>
                </header>
            
            <article>
                
<p>To start using the new virtual environment from the command line, pass the following argument inside the folder that holds the virtual environment. This will run the <kbd>activate</kbd> batch file, and will start the virtual environment:</p>
<pre><strong>C:\PythonGeospatial3&gt;cartoenv\Scripts\activate</strong></pre>
<p>Once the virtual environment is activated, the name of the environment will appear before the folder name, indicating that the commands are being run inside the environment and any changes that are performed (such as installing modules) will not affect the main Python installation:</p>
<pre><strong>(cartoenv)</strong> <strong>C:\PythonGeospatial3&gt;</strong></pre>
<p>In a Linux environment, the command source <kbd>{environment}/bin/activate</kbd> is used instead. When programming in Linux, the commands in the terminal would look like this:</p>
<pre><strong>silas@ubuntu16:~$ mkdir carto</strong><br/><strong>silas@ubuntu16:~$ cd carto/</strong><br/><strong>silas@ubuntu16:~/carto$ virtualenv cartoenv</strong><br/><strong>New python executable in /home/silas/carto/cartoenv/bin/python</strong><br/><strong>Installing setuptools, pip, wheel...done.</strong><br/><strong>silas@ubuntu16:~/carto$ source cartoenv/bin/activate</strong><br/><strong>(cartoenv) silas@ubuntu16:~/carto$</strong></pre>
<p>In either OS, to deactivate the virtual environment, pass the <kbd>deactivate</kbd> command. This will end the virtual session:</p>
<pre><strong>C:\PythonGeospatial3&gt;cartoenv\Scripts\activate</strong><br/><br/><strong>(cartoenv) C:\PythonGeospatial3&gt;deactivate</strong><br/><strong>C:\PythonGeospatial3&gt;</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Installing modules in virtualenv</h1>
                </header>
            
            <article>
                
<p>Because each virtual environment is separate from the main Python installation, each environment must have the required modules installed. While this can seem like a pain, <kbd>pip</kbd> makes it quite easy. After setting up the first virtual environment, a <kbd>pip</kbd> command called <kbd>freeze</kbd> allows you to generate a file called <kbd>requirements.txt</kbd>. This file can be copied into a new virtual environment and using <kbd>pip</kbd> install, all of the listed modules will be added from PyPI.</p>
<p>To generate a <kbd>requirements.txt</kbd> file in the current folder, use this command:</p>
<pre><strong><span class="n">(cartoenv) C:\Packt\Chapters&gt;pip</span> <span class="n">freeze</span> <span class="o">&gt;</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span></strong></pre>
<p>After the file has been copied into a new virtual environment folder, activate the environment and pass the following command to read from the file:</p>
<pre><strong><span class="n">(newenv) C:\Packt\Chapters&gt;pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span></strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Modules to use</h1>
                </header>
            
            <article>
                
<p>For this virtual environment, we will install the two modules CARTOframes and Jupyter. The second module will allow us to run Jupyter Notebooks, which are specialized browser-based coding environments.</p>
<p>Activate the virtual environment, and install the modules within the virtual environment with the following commands:</p>
<pre><strong><span class="n">(cartoenv) C:\Packt\Chapters&gt;</span>pip install cartoframes</strong><br/><strong><span class="n">(cartoenv) C:\Packt\Chapters&gt;</span>pip install jupyter</strong></pre>
<p>All of the required modules will also be downloaded and installed, along with the two that we are installing directly. Using <kbd>pip</kbd> and <kbd>virtualenv</kbd> makes package installation and management simple and quick. </p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Using Jupyter Notebook</h1>
                </header>
            
            <article>
                
<p>We have covered the basic installation of Jupyter Notebook in <a href="23e9b6f4-e43b-4bf7-bc80-2c1537d5f760.xhtml" target="_blank">Chapter 1</a>, <em>Package Installation and Management</em> and in the previous chapter at various instances to run code and get the desired output.</p>
<p>Here, we will be using Jupyter Notebook for CARTOframes to connect to an account and analyze geospatial data and display it.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Connecting to an account</h1>
                </header>
            
            <article>
                
<p>In the first code box, we will import the CARTOframes module, and pass the API key string along with the base URL, which is generated from your CARTO username as <kbd>https://{username}.carto.com</kbd>. In this case, the URL is <kbd>https://lokiintelligent.carto.com</kbd>:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/591ae76b-2dd4-4178-8394-4f798f245af0.png" width="1549" height="419"/></div>
<p>In this code block, the API key and the URL are passed to the <kbd>CartoContext</kbd> class, and a <kbd>CartoContext</kbd> connect object is returned and assigned to the variable <kbd>cc</kbd>. With this object, we can now interact with the datasets associated with our account, load datasets into the account, and even generate maps directly in the Jupyter Notebook. </p>
<p>Once the code has been entered into the section, push the <span class="packt_screen">Run</span> button to execute the code in the current section. Any output will appear in an <span class="packt_screen">Out</span> section, underneath the code run. This section can include maps, tables, and even graphs—Jupyter Notebooks are often used in scientific computing because of this ability to instantly produce graphs and to save them within the Notebook.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Saving credentials</h1>
                </header>
            
            <article>
                
<p>The CARTO account credentials can be saved and accessed later by using the <kbd>Credentials</kbd> library:</p>
<pre>from cartoframes import Credentials<br/>creds = Credentials(username='{username}', key='{password}')<br/>creds.save()</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Accessing a dataset</h1>
                </header>
            
            <article>
                
<p>To access the NBA arenas dataset that we loaded into the account, we are going to use the <kbd>CartoContext</kbd> <kbd>read</kbd> method, passing the name of the dataset we want to interact with as a string. In a Jupyter Notebook <span class="packt_screen">In</span> section, run the following code:</p>
<pre>import cartoframes<br/>APIKEY = "{YOUR API KEY}"<br/>cc = cartoframes.CartoContext(base_url='https://{username}.carto.com/', api_key=APIKEY)<br/>df = cc.read('arenas_nba')<br/>print(df)</pre>
<p>Using <kbd>CartoContext</kbd>, the account is accessed. With the <kbd>cc</kbd> object, the <kbd>read</kbd> method creates a <kbd>DataFrame</kbd> object from the NBA <kbd>arenas</kbd> dataset. The <kbd>DataFrame</kbd> object is what is queried or updated.</p>
<p>The <kbd>print</kbd> statement will produce a table with values from the NBA <kbd>arenas</kbd> dataset, which has been loaded into a CARTOframe object:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/117be600-7f09-4f7d-a4f1-deef661e8c40.png" width="758" height="314"/></div>
<p>Individual columns can be access using dot notation (for example, <kbd>df.address1</kbd>) or using keys (for example, <kbd>df['address1']</kbd>):</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/75f11b12-f0e7-4df9-aad7-a5323119f728.png" style="width:25.92em;height:28.33em;" width="349" height="382"/></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Selecting individual rows</h1>
                </header>
            
            <article>
                
<p>To select a specific row within the Pandas dataframe derived from the CARTO account dataset, a conditional statement can be passed to the object in brackets. Here, the NBA <kbd>arenas</kbd> dataset's team column is queried by passing the name of an NBA team as a parameter:</p>
<pre>df[df.team=='Toronto Raptors']</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Loading a CSV dataset</h1>
                </header>
            
            <article>
                
<p><span>To load a dataset into the account using</span> CARTOframes<span>, we will use the </span><kbd>pandas</kbd><span> library again, which is installed with the Jupyter modules. Pandas allow us to read data from a CSV (and other file formats), loading it into a Pandas</span> dataframe <span>(a special data object that allows for a multitude of data-manipulation methods, as well as producing output). Then, using <kbd>CartoContext</kbd>, the</span> dataframe <span>is written (as a table) to the account:</span></p>
<pre>import pandas as pd<br/>APIKEY = "{YOUR API KEY}"<br/>cc = cartoframes.CartoContext(base_url='https://{username}.carto.com/', api_key=APIKEY)<br/>df = pd.read_csv(r'Path\to\sacramento.csv')<br/>cc.write(df, 'sacramento_addresses')</pre>
<p>This will write the CSV table, imported as a dataframe, into the CARTO account <span class="packt_screen">DATASETS</span> section:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/30feff43-aea0-466e-9788-d380d7aa3c60.png" width="1080" height="369"/></div>
<div class="packt_infobox">The imported dataset <span><span>will not be a geospatial table, but is instead a table that can be queried and joined to spatial data.</span></span></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Loading a shapefile</h1>
                </header>
            
            <article>
                
<p>Loading geospatial data manually into CARTO is easy, as we explored earlier. It's even easier when using CARTOframes, as it makes automated data management possible. New, updated data files or data from REST APIs can be converted into dataframes and written into the CARTO account.</p>
<p>Shapefiles require the installation of the GeoPandas library, as the geometry requires a GeoPandas <kbd>DataFrame</kbd> object for data management.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Installing GeoPandas</h1>
                </header>
            
            <article>
                
<p>GeoPandas, as discussed in <a href="0b3a2208-3881-479a-83a8-78be85b9c1d6.xhtml">Chapter 5</a>, <em>Vector Data Analysis</em>, is the geospatial compliment to Pandas. To be able to create dataframes objects from shapefiles, we have to make sure that GeoPandas is installed and added to the virtual environment. Use <kbd>pip install</kbd> to add the GeoPandas library:</p>
<pre><strong>(cartoenv) C:\PythonGeospatial3&gt;pip install geopandas</strong></pre>
<p><span>If there are installation issues on Windows, pre-built binaries for GeoPandas and Fiona (which powers GeoPandas) are available here, along with many other Python libraries: </span><a href="https://www.lfd.uci.edu/~gohlke/pythonlibs">https://www.lfd.uci.edu/~gohlke/pythonlibs</a>. Install Fiona and GeoPandas from the wheels by downloading them, copying them into a folder, and using <kbd>pip install</kbd> to install from the wheel. For example, here, Fiona is installed from the wheel file:</p>
<pre><strong>C:\PythonGeospatial3&gt;pip install Fiona-1.7.11.post1-cp36-cp36m-win_amd64.whl</strong></pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Writing to CARTO</h1>
                </header>
            
            <article>
                
<p>Writing the shapefile to the CARTO account requires only a <kbd>CartoContext</kbd> object, a file path, and the usual URL and API key combination. With GeoPandas now installed, the MLB Stadiums shapefile can be loaded into a GeoPandas <kbd>DataFrame</kbd>, and then written to the CARTO account using the <kbd>CartoContext</kbd> <kbd>write</kbd> method:</p>
<pre>import geopandas as gdp<br/>import cartoframes<br/>APIKEY = "{API KEY}"<br/>cc = cartoframes.CartoContext(base_url='https://{username}.carto.com/',<br/>                              api_key=APIKEY)<br/>shp = r"C:\Data\Stadiums_MLB\Stadiums_MLB.shp"<br/>data = gdp.read_file(shp)<br/>cc.write(data,"stadiums_mlb")</pre>
<p>Log in to the CARTO account to confirm that the dataset has been added.</p>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Loading CSV with geometry</h1>
                </header>
            
            <article>
                
<p>To ensure that a table (address data from OpenAddresses in this case) with latitude and longitude columns is imported as a geospatial dataset, we have to use the Shapely library's <kbd>Point</kbd> class. Each <kbd>Point</kbd> geometry is generated from the <kbd>LON</kbd> and <kbd>LAT</kbd> fields of the address dataset which has been imported:</p>
<pre>import geopandas as gdp<br/>import cartoframes<br/>import pandas as pd<br/>from shapely.geometry import Point<br/>APIKEY = "{API KEY}"<br/>cc = cartoframes.CartoContext(base_url='https://{username}.carto.com/',<br/>                              api_key=APIKEY)<br/>address_df = pd.read_csv(r'data/city_of_juneau.csv')<br/>geometry = [Point(xy) for xy in zip(address_df.LON, address_df.LAT)]<br/>address_df = address_df.drop(['LON', 'LAT'], axis=1)<br/>crs = {'init': 'epsg:4326'}<br/>geo_df = gdp.GeoDataFrame(address_df, crs=crs, geometry=geometry)<br/>cc.write(geo_df, 'juneau_addresses')</pre>
<div class="packt_tip">Ensure that the GeoPandas library is imported before CARTOframes to avoid import errors from the Fiona library.</div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Geospatial analysis</h1>
                </header>
            
            <article>
                
<p>To perform geospatial analysis, using the cloud datasets, we can connect using CARTOframes and perform spatial queries using a combination of GeoPandas and Shapely. In this example, the NBA <kbd>arenas</kbd> dataset is compared against a US States shapefile using an intersects spatial query. If the <kbd>arena</kbd> object intersects with a state object, the name of the <kbd>arena</kbd> and the state are printed:</p>
<pre>import geopandas as gdp<br/>import cartoframes<br/>import pandas as pd<br/>APIKEY = "1353407a098fef50ec1b6324c437d6d52617b890"<br/><br/>cc = cartoframes.CartoContext(base_url='https://lokiintelligent.carto.com/',<br/>                              api_key=APIKEY)<br/>from shapely.geometry import Point<br/>from shapely.wkb import loads<br/>arenas_df = cc.read('arenas_nba')<br/>shp = r"C:\Data\US_States\US_States.shp"<br/>states_df = gdp.read_file(shp)<br/><br/>for index, orig in states_df.iterrows():<br/>    for index2, ref in arenas_df.iterrows():<br/>      if loads(ref['the_geom'], hex=True).intersects(orig['geometry']):<br/>          print(orig['STATE'], ref['team'])</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Editing and updating datasets</h1>
                </header>
            
            <article>
                
<p><span>Because </span>CARTOframes<span> incorporates the Pandas </span>dataframes<span> objects, which can be edited in memory, and writes to the datasets stored in the CARTO account, we can create scripts that will automate the upload of geospatial data. Datasets can be updated entirely, or individual rows and values can be updated using Pandas data methods such as </span><kbd>replace</kbd><span>. This, coupled with Builder, the CARTO web-map deployment tool, makes it easy to create GIS with a web-map frontend and cloud data storage that can be managed using scripting.</span></p>
<p>In this example code, the name of the state that contains the NBA <kbd>arena</kbd> is found using the <kbd>intersect</kbd> query. The names are added to a list, and the list is added to the <kbd>arena</kbd> dataframe as a new column called states. The geometry data stored in the <kbd>arenas</kbd> dataset are required to be converted into Shapely objects, using the <kbd>loads</kbd> module:</p>
<pre>import geopandas as gdp<br/>import cartoframes<br/>import pandas as pd<br/>from shapely.wkb import loads<br/>APIKEY = "API KEY"<br/>cc = cartoframes.CartoContext(base_url='https://{username}.carto.com/',<br/>                api_key=APIKEY)<br/>arenas_df = cc.read('arenas_nba')<br/>shp = r"C:\Data\US_States\US_States.shp"<br/>states_df = gdp.read_file(shp)<br/>data = []<br/>for index, ref in arenas_df.iterrows():<br/>  check = 0<br/>  for index2, orig in states_df.iterrows():<br/>    if <strong>loads</strong>(ref['the_geom'], hex=True).<strong>intersects</strong>(orig['geometry']):<br/>      data.append(orig['STATE'])<br/>      check = 1<br/>  if check == 0:<br/>    data.append(None)<br/>arenas_df['state'] = data<br/>cc.write(arenas_df,'arenas_nba', overwrite=True)</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">overwrite=True</h1>
                </header>
            
            <article>
                
<p>With each update to the datasets, the changes must be written to the CARTO account.<span> </span>To overwrite data in the cloud database with new data, the <kbd>overwrite</kbd> parameter must be set to <kbd>True</kbd>:</p>
<pre>cc.write(data,"stadiums_mlb",'overwrite=True')</pre>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Creating a map</h1>
                </header>
            
            <article>
                
<p>Because of the interactivity of Jupyter Notebooks, code and code output exist together. This is great when dealing with geospatial data, as it makes it easy to create a map of the data. In this example, the NBA <kbd>arenas</kbd> and MLB stadiums datasets are added to a map over a <kbd>BaseMap</kbd> object:</p>
<pre>from cartoframes import Layer, BaseMap, styling<br/>cc.map(layers=[BaseMap('light'),<br/>               Layer('arenas_nba',),<br/>              Layer('stadiums_mlb')], interactive=True)</pre>
<p>The output produced is as follows:</p>
<div class="CDPAlignCenter CDPAlign"><img src="Images/3a2534bd-e1eb-40d7-90bd-e46c4e72b82d.png" width="941" height="505"/></div>


            </article>

            
        </section>
    </div>



  
<div id="sbo-rt-content"><section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>This chapter covered the following topics. First, we introduced the CARTOframes Python library and discussed how it relates to other parts of the CARTO stack, such as CARTO Builder and CARTO Data Observatory. Next, we explained how to install the CARTOframes library, what other Python packages it depends on, and where to look for documentation. Because CARTOframes uses data from CARTO Builder, we explained how to set up a CARTO Builder account. In the example scripts that make up the rest of the chapter, we saw how the library integrates <kbd>pandas</kbd> dataframes, how to work with tables, and how to make maps and combine them with other geospatial libraries, such as Shapely and GeoPandas.</p>
<p>In the next chapter, we will cover another module that utilizes Jupyter Notebooks and cartographic visualizations, MapboxGL—Jupyter.</p>


            </article>

            
        </section>
    </div>



  </body></html>