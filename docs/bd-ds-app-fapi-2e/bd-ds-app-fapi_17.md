

# ç¬¬åå››ç« ï¼šä½¿ç”¨ Stable Diffusion æ¨¡å‹åˆ›å»ºåˆ†å¸ƒå¼æ–‡æœ¬åˆ°å›¾åƒ AI ç³»ç»Ÿ

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåœ¨è¿™æœ¬ä¹¦ä¸­ï¼Œæˆ‘ä»¬æ„å»ºçš„ API ä¸­æ‰€æœ‰æ“ä½œéƒ½æ˜¯åœ¨è¯·æ±‚å¤„ç†å†…éƒ¨è®¡ç®—çš„ã€‚æ¢å¥è¯è¯´ï¼Œç”¨æˆ·å¿…é¡»ç­‰å¾…æœåŠ¡å™¨å®Œæˆæˆ‘ä»¬å®šä¹‰çš„æ‰€æœ‰æ“ä½œï¼ˆå¦‚è¯·æ±‚éªŒè¯ã€æ•°æ®åº“æŸ¥è¯¢ã€ML é¢„æµ‹ç­‰ï¼‰ï¼Œæ‰èƒ½æ”¶åˆ°ä»–ä»¬çš„å“åº”ã€‚ç„¶è€Œï¼Œå¹¶éæ€»æ˜¯å¸Œæœ›æˆ–å¯èƒ½è¦æ±‚è¿™ç§è¡Œä¸ºã€‚

å…¸å‹ä¾‹å­æ˜¯ç”µå­é‚®ä»¶é€šçŸ¥ã€‚åœ¨ Web åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å‘ç”¨æˆ·å‘é€ç”µå­é‚®ä»¶ï¼Œå› ä¸ºä»–ä»¬åˆšåˆšæ³¨å†Œæˆ–æ‰§è¡Œäº†ç‰¹å®šæ“ä½œã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼ŒæœåŠ¡å™¨éœ€è¦å‘ç”µå­é‚®ä»¶æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä»¥ä¾¿å‘é€ç”µå­é‚®ä»¶ã€‚æ­¤æ“ä½œå¯èƒ½éœ€è¦å‡ æ¯«ç§’æ—¶é—´ã€‚å¦‚æœæˆ‘ä»¬åœ¨è¯·æ±‚å¤„ç†ä¸­æ‰§è¡Œæ­¤æ“ä½œï¼Œå“åº”å°†å»¶è¿Ÿç›´åˆ°æˆ‘ä»¬å‘é€ç”µå­é‚®ä»¶ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä½“éªŒï¼Œå› ä¸ºç”¨æˆ·å¹¶ä¸çœŸæ­£å…³å¿ƒç”µå­é‚®ä»¶æ˜¯å¦‚ä½•ä½•æ—¶å‘é€çš„ã€‚è¿™ä¸ªä¾‹å­æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€è¯´çš„**åå°æ“ä½œ**çš„å…¸å‹ä¾‹å­ï¼šéœ€è¦åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­å®Œæˆçš„äº‹æƒ…ï¼Œä½†ä¸éœ€è¦ç›´æ¥ç”¨æˆ·äº¤äº’ã€‚

å¦ä¸€ç§æƒ…å†µæ˜¯å½“ç”¨æˆ·è¯·æ±‚ä¸€ä¸ªè€—æ—¶çš„æ“ä½œï¼Œåœ¨åˆç†çš„æ—¶é—´å†…æ— æ³•å®Œæˆã€‚è¿™é€šå¸¸æ˜¯å¤æ‚æ•°æ®å¯¼å‡ºæˆ–é‡å‹ AI æ¨¡å‹çš„æƒ…å†µã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¸Œæœ›ç›´æ¥è·å–ç»“æœï¼Œä½†å¦‚æœåœ¨è¯·æ±‚å¤„ç†ç¨‹åºä¸­æ‰§è¡Œæ­¤æ“ä½œï¼Œå°†ä¼šé˜»å¡æœåŠ¡å™¨è¿›ç¨‹ï¼Œç›´åˆ°å®Œæˆã€‚å¦‚æœå¤§é‡ç”¨æˆ·è¯·æ±‚è¿™ç§æ“ä½œï¼Œä¼šè¿…é€Ÿä½¿æˆ‘ä»¬çš„æœåŠ¡å™¨æ— å“åº”ã€‚æ­¤å¤–ï¼ŒæŸäº›ç½‘ç»œåŸºç¡€è®¾æ–½ï¼Œå¦‚ä»£ç†æˆ– Web å®¢æˆ·ç«¯ï¼ˆå¦‚æµè§ˆå™¨ï¼‰ï¼Œå…·æœ‰éå¸¸ä¸¥æ ¼çš„è¶…æ—¶è®¾ç½®ï¼Œè¿™æ„å‘³ç€å¦‚æœå“åº”æ—¶é—´è¿‡é•¿ï¼Œå®ƒä»¬é€šå¸¸ä¼šå–æ¶ˆæ“ä½œã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°†å¼•å…¥ä¸€ä¸ªå…¸å‹çš„ Web åº”ç”¨ç¨‹åºæ¶æ„ï¼š**web-queue-worker**ã€‚æ­£å¦‚æˆ‘ä»¬å°†åœ¨æœ¬ç« ä¸­çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬å°†æŠŠæœ€æ˜‚è´µã€è€—æ—¶æœ€é•¿çš„æ“ä½œæ¨è¿Ÿåˆ°åå°è¿›ç¨‹ï¼Œå³**worker**ã€‚ä¸ºäº†å±•ç¤ºè¿™ç§æ¶æ„çš„è¿è¡Œæ–¹å¼ï¼Œæˆ‘ä»¬å°†å»ºç«‹æˆ‘ä»¬è‡ªå·±çš„ AI ç³»ç»Ÿï¼Œä½¿ç”¨**Stable Diffusion**æ¨¡å‹æ ¹æ®æ–‡æœ¬æç¤ºç”Ÿæˆå›¾åƒã€‚

æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¶µç›–ä»¥ä¸‹ä¸»è¦è¯é¢˜ï¼š

+   ä½¿ç”¨ Stable Diffusion æ¨¡å‹ä¸ Hugging Face Diffusers ç”Ÿæˆå›¾åƒçš„æ–‡æœ¬æç¤º

+   ä½¿ç”¨ Dramatiq å®ç°å·¥ä½œè¿›ç¨‹å’Œå›¾åƒç”Ÿæˆä»»åŠ¡

+   å­˜å‚¨å’ŒæœåŠ¡äºå¯¹è±¡å­˜å‚¨ä¸­çš„æ–‡ä»¶

# æŠ€æœ¯è¦æ±‚

å¯¹äºæœ¬ç« ï¼Œæ‚¨å°†éœ€è¦ä¸€ä¸ª Python è™šæ‹Ÿç¯å¢ƒï¼Œå°±åƒæˆ‘ä»¬åœ¨*ç¬¬ä¸€ç« *ä¸­è®¾ç½®çš„é‚£æ ·ï¼Œ*Python å¼€å‘ç¯å¢ƒè®¾ç½®*ã€‚

ä¸ºäº†æ­£ç¡®è¿è¡Œ Stable Diffusion æ¨¡å‹ï¼Œæˆ‘ä»¬å»ºè®®ä½ ä½¿ç”¨é…å¤‡è‡³å°‘ 16 GB RAM çš„æœ€æ–°è®¡ç®—æœºï¼Œç†æƒ³æƒ…å†µä¸‹è¿˜åº”é…å¤‡ 8 GB VRAM çš„ä¸“ç”¨ GPUã€‚å¯¹äº Mac ç”¨æˆ·ï¼Œé…å¤‡ M1 Pro æˆ– M2 Pro èŠ¯ç‰‡çš„æœ€æ–°å‹å·ä¹Ÿéå¸¸é€‚åˆã€‚å¦‚æœä½ æ²¡æœ‰è¿™ç§æœºå™¨ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒï¼šæˆ‘ä»¬ä¼šå‘Šè¯‰ä½ å¦‚ä½•ä»¥å…¶ä»–æ–¹å¼è¿è¡Œç³»ç»Ÿâ€”â€”å”¯ä¸€çš„ç¼ºç‚¹æ˜¯å›¾åƒç”Ÿæˆä¼šå˜æ…¢å¹¶ä¸”æ•ˆæœè¾ƒå·®ã€‚

è¦è¿è¡Œå·¥ä½œç¨‹åºï¼Œä½ éœ€è¦åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šè¿è¡Œ**Redis æœåŠ¡å™¨**ã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯å°†å…¶ä½œä¸º Docker å®¹å™¨è¿è¡Œã€‚å¦‚æœä½ ä»¥å‰ä»æœªä½¿ç”¨è¿‡ Dockerï¼Œæˆ‘ä»¬å»ºè®®ä½ é˜…è¯»å®˜æ–¹æ–‡æ¡£ä¸­çš„*å…¥é—¨æ•™ç¨‹*ï¼Œç½‘å€ä¸º[`docs.docker.com/get-started/`](https://docs.docker.com/get-started/)ã€‚å®Œæˆåï¼Œä½ å°†èƒ½å¤Ÿé€šè¿‡ä»¥ä¸‹ç®€å•å‘½ä»¤è¿è¡Œ Redis æœåŠ¡å™¨ï¼š

```py

$ docker run -d --name worker-redis -p 6379:6379 redis
```

ä½ å¯ä»¥åœ¨ä¸“ç”¨çš„ GitHub ä»“åº“ä¸­æ‰¾åˆ°æœ¬ç« çš„æ‰€æœ‰ä»£ç ç¤ºä¾‹ï¼Œåœ°å€ä¸º[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14)ã€‚

# ä½¿ç”¨ Stable Diffusion ä»æ–‡æœ¬æç¤ºç”Ÿæˆå›¾åƒ

æœ€è¿‘ï¼Œä¸€ç§æ–°ä¸€ä»£çš„ AI å·¥å…·å¼•èµ·äº†å…¨ä¸–ç•Œçš„å…³æ³¨ï¼šå›¾åƒç”Ÿæˆæ¨¡å‹ï¼Œä¾‹å¦‚ DALL-E æˆ– Midjourneyã€‚è¿™äº›æ¨¡å‹æ˜¯åœ¨å¤§é‡å›¾åƒæ•°æ®ä¸Šè¿›è¡Œè®­ç»ƒçš„ï¼Œèƒ½å¤Ÿä»ç®€å•çš„æ–‡æœ¬æç¤ºä¸­ç”Ÿæˆå…¨æ–°çš„å›¾åƒã€‚è¿™äº› AI æ¨¡å‹éå¸¸é€‚åˆä½œä¸ºåå°å·¥ä½œç¨‹åºï¼šå®ƒä»¬çš„å¤„ç†æ—¶é—´ä¸ºå‡ ç§’é’Ÿç”šè‡³å‡ åˆ†é’Ÿï¼Œå¹¶ä¸”éœ€è¦å¤§é‡çš„ CPUã€RAM ç”šè‡³ GPU èµ„æºã€‚

ä¸ºäº†æ„å»ºæˆ‘ä»¬çš„ç³»ç»Ÿï¼Œæˆ‘ä»¬å°†ä¾èµ–äº Stable Diffusionï¼Œè¿™æ˜¯ä¸€ç§éå¸¸æµè¡Œçš„å›¾åƒç”Ÿæˆæ¨¡å‹ï¼Œå‘å¸ƒäº 2022 å¹´ã€‚è¯¥æ¨¡å‹æ˜¯å…¬å¼€çš„ï¼Œå¯ä»¥åœ¨ç°ä»£æ¸¸æˆè®¡ç®—æœºä¸Šè¿è¡Œã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šä¸€ç« ä¸­æ‰€åšçš„ï¼Œæˆ‘ä»¬å°†ä¾èµ– Hugging Face å·¥å…·æ¥ä¸‹è½½å’Œè¿è¡Œè¯¥æ¨¡å‹ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å®‰è£…æ‰€éœ€çš„å·¥å…·ï¼š

```py

(venv) $ pip install accelerate diffusers
```

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½é€šè¿‡ Hugging Face ä½¿ç”¨æ‰©æ•£æ¨¡å‹äº†ã€‚

## åœ¨ Python è„šæœ¬ä¸­å®ç°æ¨¡å‹

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºä¸€ä¸ªèƒ½å¤Ÿå®ä¾‹åŒ–æ¨¡å‹å¹¶è¿è¡Œå›¾åƒç”Ÿæˆçš„ç±»çš„å®ç°ã€‚å†æ¬¡æé†’ï¼Œæˆ‘ä»¬å°†åº”ç”¨æ‡’åŠ è½½æ¨¡å¼ï¼Œä½¿ç”¨å•ç‹¬çš„ `load_model` å’Œ `generate` æ–¹æ³•ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä¸“æ³¨äº `load_model`ï¼š

text_to_image.py

```py

class TextToImage:Â Â Â Â pipe: StableDiffusionPipeline | None = None
Â Â Â Â def load_model(self) -> None:
Â Â Â Â Â Â Â Â # Enable CUDA GPU
Â Â Â Â Â Â Â Â if torch.cuda.is_available():
Â Â Â Â Â Â Â Â Â Â Â Â device = "cuda"
Â Â Â Â Â Â Â Â # Enable Apple Silicon (M1) GPU
Â Â Â Â Â Â Â Â elif torch.backends.mps.is_available():
Â Â Â Â Â Â Â Â Â Â Â Â device = "mps"
Â Â Â Â Â Â Â Â # Fallback to CPU
Â Â Â Â Â Â Â Â else:
Â Â Â Â Â Â Â Â Â Â Â Â device = "cpu"
Â Â Â Â Â Â Â Â pipe = StableDiffusionPipeline.from_pretrained("runwayml/stable-diffusion-v1-5")
Â Â Â Â Â Â Â Â pipe.to(device)
Â Â Â Â Â Â Â Â self.pipe = pipe
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/basic/text_to_image.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/basic/text_to_image.py)

è¯¥æ–¹æ³•çš„ç¬¬ä¸€éƒ¨åˆ†æ—¨åœ¨æ ¹æ®ä½ çš„è®¡ç®—æœºæ‰¾åˆ°æœ€æœ‰æ•ˆçš„è¿è¡Œæ¨¡å‹çš„æ–¹å¼ã€‚å½“åœ¨ GPU ä¸Šè¿è¡Œæ—¶ï¼Œè¿™äº›æ‰©æ•£æ¨¡å‹çš„é€Ÿåº¦æ›´å¿«â€”â€”è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ CUDAï¼ˆNVIDIA GPUï¼‰æˆ– MPSï¼ˆApple Siliconï¼‰è®¾å¤‡å¯ç”¨ã€‚å¦‚æœæ²¡æœ‰ï¼Œæˆ‘ä»¬å°†é€€å›åˆ° CPUã€‚

ç„¶åï¼Œæˆ‘ä»¬åªéœ€åˆ›å»ºä¸€ä¸ªç”± Hugging Face æä¾›çš„`StableDiffusionPipeline`ç®¡é“ã€‚æˆ‘ä»¬åªéœ€è¦è®¾ç½®æˆ‘ä»¬æƒ³è¦ä» Hub ä¸‹è½½çš„æ¨¡å‹ã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬é€‰æ‹©äº†`runwayml/stable-diffusion-v1-5`ã€‚ä½ å¯ä»¥åœ¨ Hugging Face ä¸Šæ‰¾åˆ°å®ƒçš„è¯¦ç»†ä¿¡æ¯ï¼š[`huggingface.co/runwayml/stable-diffusion-v1-5`](https://huggingface.co/runwayml/stable-diffusion-v1-5)ã€‚

æˆ‘ä»¬ç°åœ¨å¯ä»¥ä¸“æ³¨äº`generate`æ–¹æ³•ï¼š

text_to_image.py

```py

Â Â Â Â def generate(Â Â Â Â Â Â Â Â self,
Â Â Â Â Â Â Â Â prompt: str,
Â Â Â Â Â Â Â Â *,
Â Â Â Â Â Â Â Â negative_prompt: str | None = None,
Â Â Â Â Â Â Â Â num_steps: int = 50,
Â Â Â Â Â Â Â Â callback: Callable[[int, int, torch.FloatTensor], None] | None = None,
Â Â Â Â )Â Â Â Â Image.Image:
Â Â Â Â Â Â Â Â if not self.pipe:
Â Â Â Â Â Â Â Â Â Â Â Â raise RuntimeError("Pipeline is not loaded")
Â Â Â Â Â Â Â Â return self.pipe(
Â Â Â Â Â Â Â Â Â Â Â Â prompt,
Â Â Â Â Â Â Â Â Â Â Â Â negative_prompt=negative_prompt,
Â Â Â Â Â Â Â Â Â Â Â Â num_inference_steps=num_steps,
Â Â Â Â Â Â Â Â Â Â Â Â guidance_scale=9.0,
Â Â Â Â Â Â Â Â Â Â Â Â callback=callback,
Â Â Â Â Â Â Â Â ).images[0]
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/basic/text_to_image.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/basic/text_to_image.py)

ä½ å¯ä»¥çœ‹åˆ°å®ƒæ¥å—å››ä¸ªå‚æ•°ï¼š

+   `prompt`ï¼Œå½“ç„¶ï¼Œè¿™æ˜¯æè¿°æˆ‘ä»¬æƒ³è¦ç”Ÿæˆçš„å›¾åƒçš„æ–‡æœ¬æç¤ºã€‚

+   `negative_prompt`ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯é€‰çš„æç¤ºï¼Œç”¨äºå‘Šè¯‰æ¨¡å‹æˆ‘ä»¬ç»å¯¹ä¸å¸Œæœ›å‡ºç°çš„å†…å®¹ã€‚

+   `num_steps`ï¼Œå³æ¨¡å‹åº”æ‰§è¡Œçš„æ¨ç†æ­¥éª¤æ•°ã€‚æ›´å¤šæ­¥éª¤ä¼šå¯¼è‡´æ›´å¥½çš„å›¾åƒï¼Œä½†æ¯æ¬¡è¿­ä»£éƒ½ä¼šå»¶è¿Ÿæ¨ç†ã€‚é»˜è®¤å€¼`50`åº”è¯¥åœ¨é€Ÿåº¦å’Œè´¨é‡ä¹‹é—´æä¾›è‰¯å¥½çš„å¹³è¡¡ã€‚

+   `callback`ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯é€‰çš„å‡½æ•°ï¼Œå®ƒå°†åœ¨æ¯æ¬¡è¿­ä»£æ­¥éª¤ä¸­è¢«è°ƒç”¨ã€‚è¿™å¯¹äºäº†è§£ç”Ÿæˆè¿›åº¦å¹¶å¯èƒ½æ‰§è¡Œæ›´å¤šé€»è¾‘ï¼ˆå¦‚å°†è¿›åº¦ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼‰éå¸¸æœ‰ç”¨ã€‚

æ–¹æ³•ç­¾åä¸­çš„æ˜Ÿå·ï¼ˆ*ï¼‰æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°æ–¹æ³•ç­¾åä¸­çš„æ˜Ÿå·ï¼ˆ`*`ï¼‰ã€‚å®ƒå‘Šè¯‰ Pythonï¼Œæ˜Ÿå·åé¢çš„å‚æ•°åº”è¯¥ä»…ä½œä¸ºå…³é”®å­—å‚æ•°å¤„ç†ã€‚æ¢å¥è¯è¯´ï¼Œä½ åªèƒ½åƒè¿™æ ·è°ƒç”¨å®ƒä»¬ï¼š`.generate("PROMPT",` `negative_prompt="NEGATIVE", num_steps=10)`ã€‚

å°½ç®¡ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†è¿™æ˜¯ä¸€ç§ä¿æŒå‡½æ•°æ¸…æ™°ä¸”è‡ªè§£é‡Šçš„æ–¹å¼ã€‚å¦‚æœä½ å¼€å‘çš„æ˜¯ä¾›å…¶ä»–å¼€å‘è€…ä½¿ç”¨çš„ç±»æˆ–å‡½æ•°ï¼Œè¿™å°¤å…¶é‡è¦ã€‚

è¿˜æœ‰ä¸€ç§è¯­æ³•å¯ä»¥å¼ºåˆ¶å‚æ•°ä»…ä½œä¸ºä½ç½®å‚æ•°ä¼ é€’ï¼Œæ–¹æ³•æ˜¯ä½¿ç”¨æ–œæ ï¼ˆ`/`ï¼‰ç¬¦å·ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æ›´å¤šç›¸å…³å†…å®¹ï¼š[`docs.python.org/3/whatsnew/3.8.html#positional-only-parameters`](https://docs.python.org/3/whatsnew/3.8.html#positional-only-parameters)ã€‚

ç„¶åï¼Œæˆ‘ä»¬åªéœ€è¦å°†è¿™äº›å‚æ•°ä¼ é€’ç»™`pipe`ã€‚å¦‚æœéœ€è¦çš„è¯ï¼Œè¿˜æœ‰æ›´å¤šçš„å‚æ•°å¯ä»¥è°ƒèŠ‚ï¼Œä½†é»˜è®¤çš„å‚æ•°åº”è¯¥ä¼šç»™ä½ ä¸é”™çš„ç»“æœã€‚ä½ å¯ä»¥åœ¨ Hugging Face æ–‡æ¡£ä¸­æ‰¾åˆ°å®Œæ•´çš„å‚æ•°åˆ—è¡¨ï¼š[`huggingface.co/docs/diffusers/api/pipelines/stable_diffusion/text2img#diffusers.StableDiffusionPipeline.__call__`](https://huggingface.co/docs/diffusers/api/pipelines/stable_diffusion/text2img#diffusers.StableDiffusionPipeline.__call__)ã€‚è¿™ä¸ª`pipe`å¯¹è±¡èƒ½å¤Ÿä¸ºæ¯ä¸ªæç¤ºç”Ÿæˆå¤šå¼ å›¾åƒï¼Œå› æ­¤è¯¥æ“ä½œçš„ç»“æœæ˜¯ä¸€ä¸ª Pillow å›¾åƒåˆ—è¡¨ã€‚è¿™é‡Œçš„é»˜è®¤è¡Œä¸ºæ˜¯ç”Ÿæˆä¸€å¼ å›¾åƒï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥è¿”å›ç¬¬ä¸€å¼ ã€‚

å°±è¿™äº›ï¼å†æ¬¡æ„Ÿè°¢ Hugging Faceï¼Œé€šè¿‡å…è®¸æˆ‘ä»¬åœ¨å‡ åè¡Œä»£ç å†…è¿è¡Œæœ€å‰æ²¿çš„æ¨¡å‹ï¼ŒçœŸçš„æ˜¯è®©æˆ‘ä»¬çš„ç”Ÿæ´»å˜å¾—æ›´è½»æ¾ï¼

## æ‰§è¡Œ Python è„šæœ¬

æˆ‘ä»¬æ•¢æ‰“èµŒä½ æ€¥äºè‡ªå·±è¯•ä¸€è¯•â€”â€”æ‰€ä»¥æˆ‘ä»¬åœ¨ç¤ºä¾‹çš„åº•éƒ¨æ·»åŠ äº†ä¸€ä¸ªå°çš„`main`è„šæœ¬ï¼š

text_to_image.py

```py

if __name__ == "__main__":Â Â Â Â text_to_image = TextToImage()
Â Â Â Â text_to_image.load_model()
Â Â Â Â def callback(step: int, _timestep, _tensor):
Â Â Â Â Â Â Â Â print(f"ğŸš€ Step {step}")
Â Â Â Â image = text_to_image.generate(
Â Â Â Â Â Â Â Â "A Renaissance castle in the Loire Valley",
Â Â Â Â Â Â Â Â negative_prompt="low quality, ugly",
Â Â Â Â Â Â Â Â callback=callback,
Â Â Â Â )
Â Â Â Â image.save("output.png")
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/basic/text_to_image.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/basic/text_to_image.py)

è¿™ä¸ªå°è„šæœ¬å®ä¾‹åŒ–äº†æˆ‘ä»¬çš„`TextToImage`ç±»ï¼ŒåŠ è½½äº†æ¨¡å‹ï¼Œå¹¶åœ¨ä¿å­˜åˆ°ç£ç›˜ä¹‹å‰ç”Ÿæˆäº†å›¾åƒã€‚æˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ä¸ªè™šæ‹Ÿå›è°ƒå‡½æ•°ï¼Œè®©ä½ èƒ½çœ‹åˆ°å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

å½“ä½ ç¬¬ä¸€æ¬¡è¿è¡Œè¿™ä¸ªè„šæœ¬æ—¶ï¼Œä½ ä¼šæ³¨æ„åˆ° Hugging Face ä¼šå°†å‡ ä¸ª GB çš„æ–‡ä»¶ä¸‹è½½åˆ°ä½ çš„è®¡ç®—æœºä¸Šï¼šé‚£å°±æ˜¯ç¨³å®šæ‰©æ•£æ¨¡å‹ï¼Œç¡®å®ç›¸å½“åºå¤§ï¼

ç„¶åï¼Œæ¨ç†å¼€å§‹äº†ã€‚ä½ ä¼šçœ‹åˆ°ä¸€ä¸ªè¿›åº¦æ¡ï¼Œæ˜¾ç¤ºå‰©ä½™çš„æ¨ç†æ­¥éª¤æ•°ï¼Œå¹¶æ˜¾ç¤ºæˆ‘ä»¬å›è°ƒå‡½æ•°ä¸­çš„`print`è¯­å¥ï¼Œå¦‚*å›¾ 14.1*æ‰€ç¤ºã€‚

![å›¾ 14.1 â€“ ç¨³å®šæ‰©æ•£ç”Ÿæˆå›¾åƒ](img/Figure_14.1_B19528.jpg)

å›¾ 14.1 â€“ ç¨³å®šæ‰©æ•£ç”Ÿæˆå›¾åƒ

ç”Ÿæˆä¸€å¼ å›¾åƒéœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ

æˆ‘ä»¬åœ¨ä¸åŒç±»å‹çš„è®¡ç®—æœºä¸Šè¿›è¡Œäº†å¤šæ¬¡æµ‹è¯•ã€‚åœ¨é…å¤‡ 8 GB RAM çš„ç°ä»£ NVIDIA GPU æˆ– M1 Pro èŠ¯ç‰‡çš„ Mac ä¸Šï¼Œæ¨¡å‹èƒ½å¤Ÿåœ¨*å¤§çº¦ä¸€åˆ†é’Ÿ*å†…ç”Ÿæˆä¸€å¼ å›¾åƒï¼Œå¹¶ä¸”å†…å­˜ä½¿ç”¨åˆç†ã€‚è€Œåœ¨ CPU ä¸Šè¿è¡Œæ—¶ï¼Œå¤§çº¦éœ€è¦*5 åˆ° 10 åˆ†é’Ÿ*ï¼Œå¹¶ä¸”ä¼šå ç”¨å¤šè¾¾ 16 GB çš„å†…å­˜ã€‚

å¦‚æœä½ çš„è®¡ç®—æœºä¸Šæ¨ç†é€Ÿåº¦ç¡®å®å¤ªæ…¢ï¼Œä½ å¯ä»¥å°è¯•å‡å°‘`num_steps`å‚æ•°ã€‚

å½“æ¨ç†å®Œæˆåï¼Œä½ ä¼šåœ¨ç£ç›˜ä¸Šæ‰¾åˆ°ç”Ÿæˆçš„å›¾åƒå’Œä½ çš„è„šæœ¬ã€‚*å›¾ 14.2*å±•ç¤ºäº†è¿™ç§ç»“æœçš„ä¸€ä¸ªä¾‹å­ã€‚ä¸é”™å§ï¼Ÿ

![å›¾ 14.2 â€“ ç¨³å®šæ‰©æ•£å›¾åƒç”Ÿæˆç»“æœ](img/Figure_14.2_B19528.jpg)

å›¾ 14.2 â€“ ç¨³å®šæ‰©æ•£å›¾åƒç”Ÿæˆç»“æœ

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»æ‹¥æœ‰äº†æˆ‘ä»¬ AI ç³»ç»Ÿçš„åŸºç¡€æ„ä»¶ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ª APIï¼Œä¾›ç”¨æˆ·ç”Ÿæˆè‡ªå·±çš„å›¾åƒã€‚æ­£å¦‚æˆ‘ä»¬åˆšåˆšçœ‹åˆ°çš„ï¼Œç”Ÿæˆä¸€å¼ å›¾åƒéœ€è¦ä¸€äº›æ—¶é—´ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ä»‹ç»ä¸­æ‰€è¯´çš„ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ª Web é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹æ¶æ„ï¼Œä½¿å¾—è¿™ä¸ªç³»ç»Ÿæ—¢å¯é åˆå…·æœ‰å¯æ‰©å±•æ€§ã€‚

# åˆ›å»º Dramatiq å·¥ä½œè¿›ç¨‹å¹¶å®šä¹‰å›¾åƒç”Ÿæˆä»»åŠ¡

æ­£å¦‚æˆ‘ä»¬åœ¨æœ¬ç« çš„ä»‹ç»ä¸­æåˆ°çš„ï¼Œç›´æ¥åœ¨æˆ‘ä»¬çš„ REST API æœåŠ¡å™¨ä¸Šè¿è¡Œå›¾åƒç”Ÿæˆæ¨¡å‹æ˜¯ä¸å¯è¡Œçš„ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚æ‰€è§ï¼Œè¿™ä¸€æ“ä½œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œå¹¶æ¶ˆè€—å¤§é‡å†…å­˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ªç‹¬ç«‹äºæœåŠ¡å™¨è¿›ç¨‹çš„å…¶ä»–è¿›ç¨‹æ¥å¤„ç†å›¾åƒç”Ÿæˆä»»åŠ¡ï¼š**å·¥ä½œè¿›ç¨‹**ã€‚æœ¬è´¨ä¸Šï¼Œå·¥ä½œè¿›ç¨‹å¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªåœ¨åå°æ‰§è¡Œä»»åŠ¡çš„ç¨‹åºã€‚

åœ¨ Web å¼€å‘ä¸­ï¼Œè¿™ä¸ªæ¦‚å¿µé€šå¸¸æ„å‘³ç€æ¯”è¿™æ›´å¤šçš„å†…å®¹ã€‚å·¥ä½œè¿›ç¨‹æ˜¯ä¸€ä¸ªæŒç»­è¿è¡Œåœ¨åå°çš„è¿›ç¨‹ï¼Œç­‰å¾…æ¥æ”¶ä»»åŠ¡ã€‚è¿™äº›ä»»åŠ¡é€šå¸¸ç”± Web æœåŠ¡å™¨å‘é€ï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®ç”¨æˆ·çš„æ“ä½œè¯·æ±‚æ‰§è¡Œç‰¹å®šçš„æ“ä½œã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé€šä¿¡é€šé“æ¥è¿æ¥ Web æœåŠ¡å™¨å’Œå·¥ä½œè¿›ç¨‹ã€‚è¿™å°±æ˜¯**é˜Ÿåˆ—**çš„ä½œç”¨ã€‚é˜Ÿåˆ—ä¼šæ¥æ”¶å¹¶å †ç§¯æ¥è‡ª Web æœåŠ¡å™¨çš„æ¶ˆæ¯ï¼Œç„¶åå°†è¿™äº›æ¶ˆæ¯æä¾›ç»™å·¥ä½œè¿›ç¨‹è¯»å–ã€‚è¿™å°±æ˜¯ Web é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹æ¶æ„ã€‚ä¸ºäº†æ›´å¥½åœ°ç†è§£è¿™ä¸€ç‚¹ï¼Œ*å›¾ 14.4* å±•ç¤ºäº†è¿™ç§æ¶æ„çš„ç¤ºæ„å›¾ã€‚

![å›¾ 14.3 â€“ Web é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹æ¶æ„ç¤ºæ„å›¾](img/Figure_14.3_B19528.jpg)

å›¾ 14.3 â€“ Web é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹æ¶æ„ç¤ºæ„å›¾

è¿™æ˜¯ä¸æ˜¯è®©ä½ æƒ³èµ·äº†ä»€ä¹ˆï¼Ÿæ˜¯çš„ï¼Œè¿™ä¸æˆ‘ä»¬åœ¨*ç¬¬å…«ç« *ä¸­çœ‹åˆ°çš„éå¸¸ç›¸ä¼¼ï¼Œåœ¨*å¤„ç†å¤šä¸ª WebSocket è¿æ¥å¹¶å¹¿æ’­æ¶ˆæ¯*è¿™ä¸€èŠ‚ã€‚å®é™…ä¸Šï¼Œè¿™æ˜¯åŒä¸€ä¸ªåŸç†ï¼šæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¸­å¤®æ•°æ®æºæ¥è§£å†³æœ‰å¤šä¸ªè¿›ç¨‹çš„é—®é¢˜ã€‚

è¿™ç§æ¶æ„çš„ä¸€ä¸ªä¼Ÿå¤§ç‰¹æ€§æ˜¯å®ƒéå¸¸å®¹æ˜“æ‰©å±•ã€‚è¯•æƒ³ä½ çš„åº”ç”¨ç¨‹åºå–å¾—äº†å·¨å¤§æˆåŠŸï¼Œæˆåƒä¸Šä¸‡çš„ç”¨æˆ·æƒ³è¦ç”Ÿæˆå›¾åƒï¼šå•ä¸ªå·¥ä½œè¿›ç¨‹æ ¹æœ¬æ— æ³•æ»¡è¶³è¿™ç§éœ€æ±‚ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬æ‰€éœ€è¦åšçš„å°±æ˜¯å¯åŠ¨æ›´å¤šçš„å·¥ä½œè¿›ç¨‹ã€‚ç”±äºæ¶æ„ä¸­æœ‰ä¸€ä¸ªå•ç‹¬çš„æ¶ˆæ¯ä»£ç†ï¼Œæ¯ä¸ªå·¥ä½œè¿›ç¨‹ä¼šåœ¨æ”¶åˆ°æ¶ˆæ¯æ—¶è¿›è¡Œæ‹‰å–ï¼Œä»è€Œå®ç°ä»»åŠ¡çš„å¹¶è¡Œå¤„ç†ã€‚å®ƒä»¬ç”šè‡³ä¸éœ€è¦ä½äºåŒä¸€å°ç‰©ç†æœºå™¨ä¸Šã€‚*å›¾ 14.4* å±•ç¤ºäº†è¿™ä¸€ç‚¹ã€‚

![å›¾ 14.4 â€“ å¸¦æœ‰å¤šä¸ªå·¥ä½œè¿›ç¨‹çš„ Web é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹æ¶æ„](img/Figure_14.4_B19528.jpg)

å›¾ 14.4 â€“ å¸¦æœ‰å¤šä¸ªå·¥ä½œè¿›ç¨‹çš„ Web é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹æ¶æ„

åœ¨ Python ä¸­ï¼Œæœ‰å¤šç§åº“å¯ä»¥å¸®åŠ©å®ç°å·¥ä½œè¿›ç¨‹ã€‚å®ƒä»¬æä¾›äº†å®šä¹‰ä»»åŠ¡ã€å°†ä»»åŠ¡è°ƒåº¦åˆ°é˜Ÿåˆ—ä¸­å¹¶è¿è¡Œè¿›ç¨‹ã€æ‹‰å–å¹¶æ‰§è¡Œä»»åŠ¡æ‰€éœ€çš„å·¥å…·ã€‚åœ¨æœ¬ä¹¦ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Dramatiqï¼Œä¸€ä¸ªè½»é‡çº§ä½†å¼ºå¤§ä¸”ç°ä»£çš„åå°ä»»åŠ¡å¤„ç†åº“ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ *ç¬¬å…«ç« * ä¸­æ‰€åšçš„ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Redis ä½œä¸ºæ¶ˆæ¯ä»£ç†ã€‚

## å®ç°ä¸€ä¸ªå·¥ä½œè¿›ç¨‹

å’Œå¾€å¸¸ä¸€æ ·ï¼Œæˆ‘ä»¬é¦–å…ˆå®‰è£…æ‰€éœ€çš„ä¾èµ–é¡¹ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```py

(venv) $ pip install "dramatiq[redis]"
```

è¿™å°†å®‰è£… Dramatiqï¼Œå¹¶å®‰è£…ä¸ Redis ä»£ç†é€šä¿¡æ‰€éœ€çš„ä¾èµ–é¡¹ã€‚

åœ¨ä¸€ä¸ªæœ€å°çš„ç¤ºä¾‹ä¸­ï¼Œè®¾ç½® Dramatiq å·¥ä½œè¿›ç¨‹æ¶‰åŠä¸¤ä»¶äº‹ï¼š

1.  è®¾ç½®ä»£ç†ç±»å‹å’Œ URLã€‚

1.  é€šè¿‡ä½¿ç”¨ `@``dramatiq.actor` è£…é¥°å™¨æ¥å®šä¹‰ä»»åŠ¡ã€‚

å®ƒéå¸¸é€‚åˆç»å¤§å¤šæ•°ä»»åŠ¡ï¼Œæ¯”å¦‚å‘é€ç”µå­é‚®ä»¶æˆ–ç”Ÿæˆå¯¼å‡ºæ–‡ä»¶ã€‚

ç„¶è€Œï¼Œåœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åŠ è½½åºå¤§çš„ Stable Diffusion æ¨¡å‹ã€‚æ­£å¦‚æˆ‘ä»¬é€šå¸¸åœ¨ FastAPI æœåŠ¡å™¨ä¸­é€šè¿‡ `startup` äº‹ä»¶åšçš„é‚£æ ·ï¼Œæˆ‘ä»¬å¸Œæœ›åªæœ‰åœ¨è¿›ç¨‹å®é™…å¯åŠ¨æ—¶æ‰æ‰§è¡Œè¿™ä¸€æ“ä½œã€‚ä¸ºäº†ä½¿ç”¨ Dramatiq å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ª*ä¸­é—´ä»¶*ã€‚å®ƒä»¬å…è®¸æˆ‘ä»¬åœ¨å·¥ä½œè¿›ç¨‹ç”Ÿå‘½å‘¨æœŸä¸­çš„å‡ ä¸ªå…³é”®äº‹ä»¶æ’å…¥è‡ªå®šä¹‰é€»è¾‘ï¼ŒåŒ…æ‹¬å½“å·¥ä½œè¿›ç¨‹å¯åŠ¨æ—¶ã€‚

ä½ å¯ä»¥åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­çœ‹åˆ°æˆ‘ä»¬è‡ªå®šä¹‰ä¸­é—´ä»¶çš„å®ç°ï¼š

worker.py

```py

class TextToImageMiddleware(Middleware):Â Â Â Â def __init__(self) -> None:
Â Â Â Â Â Â Â Â super().__init__()
Â Â Â Â Â Â Â Â self.text_to_image = TextToImage()
Â Â Â Â def after_process_boot(self, broker):
Â Â Â Â Â Â Â Â self.text_to_image.load_model()
Â Â Â Â Â Â Â Â return super().after_process_boot(broker)
text_to_image_middleware = TextToImageMiddleware()
redis_broker = RedisBroker(host="localhost")
redis_broker.add_middleware(text_to_image_middleware)
dramatiq.set_broker(redis_broker)
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/basic/worker.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/basic/worker.py)

æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `TextToImageMiddleware` ç±»ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ‰¿è½½ `TextToImage` çš„å®ä¾‹ï¼Œè¿™æ˜¯æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­å®šä¹‰çš„å›¾åƒç”ŸæˆæœåŠ¡ã€‚å®ƒç»§æ‰¿è‡ª Dramatiq çš„ `Middleware` ç±»ã€‚è¿™é‡Œçš„å…³é”®æ˜¯ `after_process_boot` æ–¹æ³•ã€‚å®ƒæ˜¯ Dramatiq æä¾›çš„äº‹ä»¶é’©å­ä¹‹ä¸€ï¼Œå…è®¸æˆ‘ä»¬æ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å‘Šè¯‰å®ƒåœ¨å·¥ä½œè¿›ç¨‹å¯åŠ¨ååŠ è½½ Stable Diffusion æ¨¡å‹ã€‚ä½ å¯ä»¥åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æŸ¥çœ‹æ”¯æŒçš„é’©å­åˆ—è¡¨ï¼š[`dramatiq.io/reference.html#middleware`](https://dramatiq.io/reference.html#middleware)ã€‚

æ¥ä¸‹æ¥çš„å‡ è¡Œä»£ç è®©æˆ‘ä»¬å¯ä»¥é…ç½®æˆ‘ä»¬çš„å·¥ä½œè¿›ç¨‹ã€‚æˆ‘ä»¬é¦–å…ˆå®ä¾‹åŒ–æˆ‘ä»¬è‡ªå®šä¹‰ä¸­é—´ä»¶çš„ä¸€ä¸ªå®ä¾‹ã€‚ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸æˆ‘ä»¬é€‰æ‹©çš„æŠ€æœ¯ç›¸å¯¹åº”çš„ä»£ç†ç±»ï¼›åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­æ˜¯ Redisã€‚åœ¨å‘Šè¯‰ Dramatiq ä½¿ç”¨å®ƒä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å°†ä¸­é—´ä»¶æ·»åŠ åˆ°è¿™ä¸ªä»£ç†ä¸­ã€‚æˆ‘ä»¬çš„å·¥ä½œè¿›ç¨‹ç°åœ¨å·²ç»å®Œå…¨é…ç½®å¥½ï¼Œå¯ä»¥è¿æ¥åˆ° Redis ä»£ç†ï¼Œå¹¶åœ¨å¯åŠ¨æ—¶åŠ è½½æˆ‘ä»¬çš„æ¨¡å‹ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•å®šä¹‰ä¸€ä¸ªä»»åŠ¡æ¥ç”Ÿæˆå›¾åƒï¼š

worker.py

```py

@dramatiq.actor()def text_to_image_task(
Â Â Â Â prompt: str, *, negative_prompt: str | None = None, num_steps: int = 50
):
Â Â Â Â image = text_to_image_middleware.text_to_image.generate(
Â Â Â Â Â Â Â Â prompt, negative_prompt=negative_prompt, num_steps=num_steps
Â Â Â Â )
Â Â Â Â image.save(f"{uuid.uuid4()}.png")
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/basic/worker.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/basic/worker.py)

å®ç°æ˜¯ç›´æ¥çš„ï¼šDramatiq ä»»åŠ¡å®é™…ä¸Šæ˜¯æˆ‘ä»¬ç”¨ `@dramatiq.actor` è£…é¥°çš„æ™®é€šå‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥åƒå®šä¹‰å…¶ä»–å‡½æ•°ä¸€æ ·å®šä¹‰å‚æ•°ã€‚ç„¶è€Œï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé‡è¦çš„é™·é˜±éœ€è¦é¿å…ï¼šå½“æˆ‘ä»¬ä»æœåŠ¡å™¨è°ƒåº¦ä»»åŠ¡æ—¶ï¼Œå‚æ•°å°†å¿…é¡»å­˜å‚¨åœ¨é˜Ÿåˆ—å­˜å‚¨ä¸­ã€‚å› æ­¤ï¼Œ*Dramatiq ä¼šå°†å‚æ•°å†…éƒ¨åºåˆ—åŒ–ä¸º JSON*ã€‚è¿™æ„å‘³ç€ä½ çš„ä»»åŠ¡å‚æ•°å¿…é¡»æ˜¯å¯åºåˆ—åŒ–çš„æ•°æ®â€”â€”ä½ ä¸èƒ½æœ‰ä»»æ„çš„ Python å¯¹è±¡ï¼Œæ¯”å¦‚ç±»å®ä¾‹æˆ–å‡½æ•°ã€‚

å‡½æ•°ä½“åœ¨å°†å›¾åƒä¿å­˜åˆ°ç£ç›˜ä¹‹å‰ï¼Œä¼šè°ƒç”¨æˆ‘ä»¬åœ¨ `text_to_image_middleware` ä¸­åŠ è½½çš„ `TextToImage` å®ä¾‹ã€‚ä¸ºäº†é¿å…æ–‡ä»¶è¦†ç›–ï¼Œæˆ‘ä»¬é€‰æ‹©åœ¨è¿™é‡Œç”Ÿæˆä¸€ä¸ª**UUID**ï¼Œå³**é€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦**ã€‚å®ƒæ˜¯ä¸€ä¸ªå¤§çš„éšæœºå­—ç¬¦ä¸²ï¼Œä¿è¯æ¯æ¬¡ç”Ÿæˆæ—¶éƒ½æ˜¯å”¯ä¸€çš„ã€‚å‡­å€Ÿè¿™ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°å°†å…¶ä½œä¸ºæ–‡ä»¶åï¼Œå¹¶ç¡®ä¿å®ƒä¸ä¼šåœ¨ç£ç›˜ä¸Šå·²å­˜åœ¨ã€‚

è¿™å°±æ˜¯ worker å®ç°çš„å†…å®¹ã€‚

### å¯åŠ¨ worker

æˆ‘ä»¬è¿˜æ²¡æœ‰ä»£ç æ¥è°ƒç”¨å®ƒï¼Œä½†æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨å°è¯•ã€‚é¦–å…ˆï¼Œç¡®ä¿ä½ å·²ç»å¯åŠ¨äº†ä¸€ä¸ª Redis æœåŠ¡å™¨ï¼Œæ­£å¦‚åœ¨*æŠ€æœ¯è¦æ±‚*éƒ¨åˆ†ä¸­æ‰€è§£é‡Šçš„é‚£æ ·ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ Dramatiq workerï¼š

```py

(venv) $ dramatiq -p 1 -t 1 chapter14.basic.worker
```

Dramatiq æä¾›äº†å‘½ä»¤è¡Œå·¥å…·æ¥å¯åŠ¨ worker è¿›ç¨‹ã€‚ä¸»è¦çš„ä½ç½®å‚æ•°æ˜¯ worker æ¨¡å—çš„ç‚¹è·¯å¾„ã€‚è¿™ç±»ä¼¼äºæˆ‘ä»¬åœ¨ä½¿ç”¨ Uvicorn æ—¶çš„æ“ä½œã€‚æˆ‘ä»¬è¿˜è®¾ç½®äº†ä¸¤ä¸ªå¯é€‰å‚æ•°ï¼Œ`-p` å’Œ `-t`ã€‚å®ƒä»¬æ§åˆ¶ Dramatiq å¯åŠ¨çš„è¿›ç¨‹å’Œçº¿ç¨‹çš„æ•°é‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå¯åŠ¨ 10 ä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰ 8 ä¸ªçº¿ç¨‹ã€‚è¿™æ„å‘³ç€å°†ä¼šæœ‰ 80 ä¸ª worker æ¥æ‹‰å–å¹¶æ‰§è¡Œä»»åŠ¡ã€‚è™½ç„¶è¿™ä¸ªé»˜è®¤é…ç½®é€‚åˆå¸¸è§éœ€æ±‚ï¼Œä½†ç”±äºä¸¤ä¸ªåŸå› ï¼Œå®ƒä¸é€‚ç”¨äºæˆ‘ä»¬çš„ Stable Diffusion æ¨¡å‹ï¼š

+   è¿›ç¨‹ä¸­çš„æ¯ä¸ªçº¿ç¨‹å…±äº«ç›¸åŒçš„å†…å­˜ç©ºé—´ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä¸¤ä¸ªï¼ˆæˆ–æ›´å¤šï¼‰çº¿ç¨‹å°è¯•ç”Ÿæˆå›¾åƒï¼Œå®ƒä»¬å°†å¯¹å†…å­˜ä¸­çš„åŒä¸€å¯¹è±¡è¿›è¡Œè¯»å†™æ“ä½œã€‚å¯¹äºæˆ‘ä»¬çš„æ¨¡å‹æ¥è¯´ï¼Œè¿™ä¼šå¯¼è‡´å¹¶å‘é—®é¢˜ã€‚æˆ‘ä»¬è¯´å®ƒæ˜¯*éçº¿ç¨‹å®‰å…¨çš„*ã€‚å› æ­¤ï¼Œæ¯ä¸ªè¿›ç¨‹åº”è¯¥ä»…å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼šè¿™å°±æ˜¯`-t` `1`é€‰é¡¹çš„æ„ä¹‰æ‰€åœ¨ã€‚

+   æ¯ä¸ªè¿›ç¨‹éƒ½åº”è¯¥å°†æ¨¡å‹åŠ è½½åˆ°å†…å­˜ä¸­ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæˆ‘ä»¬å¯åŠ¨ 8 ä¸ªè¿›ç¨‹ï¼Œæˆ‘ä»¬å°†åŠ è½½ 8 æ¬¡æ¨¡å‹ã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€çœ‹åˆ°çš„ï¼Œå®ƒéœ€è¦ç›¸å½“å¤§çš„å†…å­˜ï¼Œæ‰€ä»¥è¿™æ ·åšå¯èƒ½ä¼šä½¿ä½ çš„è®¡ç®—æœºå†…å­˜çˆ†ç‚¸ã€‚ä¸ºäº†å®‰å…¨èµ·è§ï¼Œæˆ‘ä»¬ä»…å¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œä½¿ç”¨`-p 1`é€‰é¡¹ã€‚å¦‚æœä½ æƒ³å°è¯•å¹¶è¡ŒåŒ–å¹¶æŸ¥çœ‹æˆ‘ä»¬çš„ worker èƒ½å¦å¹¶è¡Œç”Ÿæˆä¸¤å¼ å›¾åƒï¼Œä½ å¯ä»¥å°è¯•`-p 2`æ¥å¯åŠ¨ä¸¤ä¸ªè¿›ç¨‹ã€‚ä½†è¦ç¡®ä¿ä½ çš„è®¡ç®—æœºèƒ½å¤Ÿå¤„ç†ï¼

å¦‚æœä½ è¿è¡Œå‰é¢çš„å‘½ä»¤ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¾“å‡ºï¼š

```py

[2023-02-02 08:52:11,479] [PID 44348] [MainThread] [dramatiq.MainProcess] [INFO] Dramatiq '1.13.0' is booting up.Fetching 19 files:Â Â Â 0%|Â Â Â Â Â Â Â Â Â Â | 0/19 [00:00<?, ?it/s]
Fetching 19 files: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 19/19 [00:00<00:00, 13990.83it/s]
[2023-02-02 08:52:11,477] [PID 44350] [MainThread] [dramatiq.WorkerProcess(0)] [INFO] Worker process is ready for action.
[2023-02-02 08:52:11,578] [PID 44355] [MainThread] [dramatiq.ForkProcess(0)] [INFO] Fork process 'dramatiq.middleware.prometheus:_run_exposition_server' is ready for action.
```

ä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹ Stable Diffusion æµæ°´çº¿çš„è¾“å‡ºï¼Œæ£€æŸ¥æ¨¡å‹æ–‡ä»¶æ˜¯å¦å·²ç»ä¸‹è½½ï¼Œç›´åˆ° worker å®Œå…¨å¯åŠ¨ã€‚è¿™æ„å‘³ç€å®ƒå·²ç»æ­£ç¡®åŠ è½½ã€‚

### åœ¨ worker ä¸­è°ƒåº¦ä»»åŠ¡

ç°åœ¨æˆ‘ä»¬å¯ä»¥å°è¯•åœ¨å·¥ä½œçº¿ç¨‹ä¸­è°ƒåº¦ä»»åŠ¡äº†ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨ä¸€ä¸ª Python äº¤äº’å¼ Shell å¹¶å¯¼å…¥`task`å‡½æ•°ã€‚æ‰“å¼€ä¸€ä¸ªæ–°çš„å‘½ä»¤è¡Œå¹¶è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆç¡®ä¿ä½ å·²å¯ç”¨ Python è™šæ‹Ÿç¯å¢ƒï¼‰ï¼š

```py

(venv) $ python>>> from chapter14.basic.worker import text_to_image_task
>>> text_to_image_task.send("A Renaissance castle in the Loire Valley")
Message(queue_name='default', actor_name='text_to_image_task', args=('A Renaissance castle in the Loire Valley',), kwargs={}, options={'redis_message_id': '663df44a-cfc1-4f13-8457-05d8181290c1'}, message_id='bf57d112-6c20-49bc-a926-682ca43ea7ea', message_timestamp=1675324585644)
```

å°±æ˜¯è¿™æ ·â€”â€”æˆ‘ä»¬åœ¨å·¥ä½œçº¿ç¨‹ä¸­å®‰æ’äº†ä¸€ä¸ªä»»åŠ¡ï¼æ³¨æ„æˆ‘ä»¬åœ¨`task`å‡½æ•°ä¸Šä½¿ç”¨äº†`send`æ–¹æ³•ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨å®ƒï¼šè¿™æ˜¯å‘Šè¯‰ Dramatiq å°†å…¶å‘é€åˆ°é˜Ÿåˆ—ä¸­çš„æ–¹å¼ã€‚

å¦‚æœä½ å›åˆ°å·¥ä½œçº¿ç¨‹ç»ˆç«¯ï¼Œä½ ä¼šçœ‹åˆ° Stable Diffusion æ­£åœ¨ç”Ÿæˆå›¾åƒã€‚è¿‡ä¸€ä¼šå„¿ï¼Œä½ çš„å›¾åƒå°†ä¿å­˜åœ¨ç£ç›˜ä¸Šã€‚ä½ è¿˜å¯ä»¥å°è¯•åœ¨çŸ­æ—¶é—´å†…è¿ç»­å‘é€ä¸¤ä¸ªä»»åŠ¡ã€‚ä½ ä¼šå‘ç° Dramatiq ä¼šä¸€ä¸ªæ¥ä¸€ä¸ªåœ°å¤„ç†å®ƒä»¬ã€‚

å¹²å¾—å¥½ï¼æˆ‘ä»¬çš„åå°è¿›ç¨‹å·²ç»å‡†å¤‡å¥½ï¼Œç”šè‡³èƒ½å¤Ÿåœ¨å…¶ä¸­è°ƒåº¦ä»»åŠ¡ã€‚ä¸‹ä¸€æ­¥å°±æ˜¯å®ç° REST APIï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥è‡ªå·±è¯·æ±‚å›¾åƒç”Ÿæˆã€‚

## å®ç° REST API

è¦åœ¨å·¥ä½œçº¿ç¨‹ä¸­è°ƒåº¦ä»»åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç”¨æˆ·å¯ä»¥äº¤äº’çš„å®‰å…¨æ¥å£ã€‚REST API æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒå¯ä»¥è½»æ¾é›†æˆåˆ°ä»»ä½•è½¯ä»¶ä¸­ï¼Œå¦‚ç½‘ç«™æˆ–ç§»åŠ¨åº”ç”¨ã€‚åœ¨è¿™ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å¿«é€Ÿå›é¡¾ä¸€ä¸‹æˆ‘ä»¬å®ç°çš„ç®€å• API ç«¯ç‚¹ï¼Œç”¨äºå°†å›¾åƒç”Ÿæˆä»»åŠ¡å‘é€åˆ°é˜Ÿåˆ—ä¸­ã€‚ä»¥ä¸‹æ˜¯å®ç°ä»£ç ï¼š

api.py

```py

class ImageGenerationInput(BaseModel):Â Â Â Â prompt: str
Â Â Â Â negative_prompt: str | None
Â Â Â Â num_steps: int = Field(50, gt=0, le=50)
class ImageGenerationOutput(BaseModel):
Â Â Â Â task_id: UUID4
app = FastAPI()
@app.post(
Â Â Â Â "/image-generation",
Â Â Â Â response_model=ImageGenerationOutput,
Â Â Â Â status_code=status.HTTP_202_ACCEPTED,
)
async def post_image_generation(input: ImageGenerationInput) -> ImageGenerationOutput:
Â Â Â Â task: Message = text_to_image_task.send(
Â Â Â Â Â Â Â Â input.prompt, negative_prompt=input.negative_prompt, num_steps=input.num_steps
Â Â Â Â )
Â Â Â Â return ImageGenerationOutput(task_id=task.message_id)
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/basic/api.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/basic/api.py)

å¦‚æœä½ ä»è¿™æœ¬ä¹¦çš„å¼€å¤´ä¸€ç›´è·Ÿåˆ°ç°åœ¨ï¼Œè¿™ä¸åº”è¯¥è®©ä½ æ„Ÿåˆ°æƒŠè®¶ã€‚æˆ‘ä»¬å·²ç»å¦¥å–„åœ°å®šä¹‰äº†åˆé€‚çš„ Pydantic æ¨¡å‹æ¥æ„å»ºå’ŒéªŒè¯ç«¯ç‚¹è´Ÿè½½ã€‚ç„¶åï¼Œè¿™äº›æ•°æ®ä¼šç›´æ¥ç”¨äºå‘é€ä»»åŠ¡åˆ° Dramatiqï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨å‰ä¸€èŠ‚çœ‹åˆ°çš„é‚£æ ·ã€‚

åœ¨è¿™ä¸ªç®€å•çš„å®ç°ä¸­ï¼Œè¾“å‡ºä»…åŒ…å«æ¶ˆæ¯ IDï¼ŒDramatiq ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªä»»åŠ¡åˆ†é…è¿™ä¸ª IDã€‚æ³¨æ„æˆ‘ä»¬å°† HTTP çŠ¶æ€ç è®¾ç½®ä¸º`202`ï¼Œè¡¨ç¤º*å·²æ¥å—*ã€‚ä»è¯­ä¹‰ä¸Šè®²ï¼Œè¿™æ„å‘³ç€æœåŠ¡å™¨å·²ç†è§£å¹¶æ¥å—äº†è¯·æ±‚ï¼Œä½†å¤„ç†å°šæœªå®Œæˆï¼Œç”šè‡³å¯èƒ½è¿˜æ²¡æœ‰å¼€å§‹ã€‚å®ƒä¸“é—¨ç”¨äºå¤„ç†åœ¨åå°è¿›è¡Œçš„æƒ…å†µï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œçš„æƒ…å†µã€‚

å¦‚æœä½ åŒæ—¶å¯åŠ¨å·¥ä½œçº¿ç¨‹å’Œè¿™ä¸ª APIï¼Œä½ å°†èƒ½å¤Ÿé€šè¿‡ HTTP è°ƒç”¨è§¦å‘å›¾åƒç”Ÿæˆã€‚

ä½ å¯èƒ½åœ¨æƒ³ï¼š*è¿™ä¸é”™â€¦â€¦ä½†æ˜¯ç”¨æˆ·æ€ä¹ˆæ‰èƒ½è·å–ç»“æœå‘¢ï¼Ÿä»–ä»¬æ€ä¹ˆçŸ¥é“ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Ÿ* ä½ è¯´å¾—å¯¹â€”â€”æˆ‘ä»¬å®Œå…¨æ²¡æœ‰è®¨è®ºè¿™ä¸ªé—®é¢˜ï¼å®é™…ä¸Šï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªæ–¹é¢éœ€è¦è§£å†³ï¼šæˆ‘ä»¬å¦‚ä½•è·Ÿè¸ªå¾…å¤„ç†ä»»åŠ¡åŠå…¶æ‰§è¡Œæƒ…å†µï¼Ÿæˆ‘ä»¬å¦‚ä½•å­˜å‚¨å¹¶æä¾›ç”Ÿæˆçš„å›¾åƒï¼Ÿè¿™å°±æ˜¯ä¸‹ä¸€èŠ‚çš„å†…å®¹ã€‚

# å°†ç»“æœå­˜å‚¨åœ¨æ•°æ®åº“å’Œå¯¹è±¡å­˜å‚¨ä¸­

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•å®ç°ä¸€ä¸ªåå°å·¥ä½œç¨‹åºæ¥æ‰§è¡Œç¹é‡çš„è®¡ç®—ï¼Œä»¥åŠä¸€ä¸ª API æ¥è°ƒåº¦ä»»åŠ¡ç»™è¿™ä¸ªå·¥ä½œç¨‹åºã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ä»ç„¶ç¼ºå°‘ä¸¤ä¸ªé‡è¦æ–¹é¢ï¼šç”¨æˆ·æ²¡æœ‰ä»»ä½•æ–¹å¼äº†è§£ä»»åŠ¡çš„è¿›åº¦ï¼Œä¹Ÿæ— æ³•è·å–æœ€ç»ˆç»“æœã€‚è®©æˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼

## åœ¨å·¥ä½œç¨‹åºå’Œ API ä¹‹é—´å…±äº«æ•°æ®

æ­£å¦‚æˆ‘ä»¬æ‰€è§ï¼Œå·¥ä½œç¨‹åºæ˜¯ä¸€ä¸ªåœ¨åå°è¿è¡Œçš„ç¨‹åºï¼Œæ‰§è¡Œ API è¯·æ±‚å®ƒåšçš„è®¡ç®—ã€‚ç„¶è€Œï¼Œå·¥ä½œç¨‹åºå¹¶æ²¡æœ‰ä¸ API æœåŠ¡å™¨é€šä¿¡çš„ä»»ä½•æ–¹å¼ã€‚è¿™æ˜¯é¢„æœŸä¸­çš„ï¼šå› ä¸ºå¯èƒ½æœ‰ä»»æ„æ•°é‡çš„æœåŠ¡å™¨è¿›ç¨‹ï¼Œä¸”å®ƒä»¬ç”šè‡³å¯èƒ½è¿è¡Œåœ¨ä¸åŒçš„ç‰©ç†æœåŠ¡å™¨ä¸Šï¼Œå› æ­¤è¿›ç¨‹ä¹‹é—´ä¸èƒ½ç›´æ¥é€šä¿¡ã€‚å§‹ç»ˆæ˜¯åŒæ ·çš„é—®é¢˜ï¼šéœ€è¦æœ‰ä¸€ä¸ªä¸­å¤®æ•°æ®æºï¼Œä¾›è¿›ç¨‹å†™å…¥å’Œè¯»å–æ•°æ®ã€‚

äº‹å®ä¸Šï¼Œè§£å†³ API å’Œå·¥ä½œç¨‹åºä¹‹é—´ç¼ºä¹é€šä¿¡çš„ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨æˆ‘ä»¬ç”¨æ¥è°ƒåº¦ä»»åŠ¡çš„ç›¸åŒä»£ç†ï¼šå·¥ä½œç¨‹åºå¯ä»¥å°†ç»“æœå†™å…¥ä»£ç†ï¼ŒAPI å¯ä»¥ä»ä¸­è¯»å–ã€‚è¿™åœ¨å¤§å¤šæ•°åå°ä»»åŠ¡åº“ä¸­éƒ½æ˜¯å¯èƒ½çš„ï¼ŒåŒ…æ‹¬ Dramatiqã€‚ç„¶è€Œï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆæœ‰ä¸€äº›å±€é™æ€§ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„æ˜¯æˆ‘ä»¬èƒ½ä¿ç•™æ•°æ®çš„æ—¶é—´æœ‰é™ã€‚åƒ Redis è¿™æ ·çš„ä»£ç†å¹¶ä¸é€‚åˆé•¿æ—¶é—´å¯é åœ°å­˜å‚¨æ•°æ®ã€‚åœ¨æŸäº›æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åˆ é™¤æœ€å¤è€çš„æ•°æ®ä»¥é™åˆ¶å†…å­˜ä½¿ç”¨ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“æœ‰ä¸€äº›ä¸œè¥¿èƒ½å¤Ÿé«˜æ•ˆåœ°å­˜å‚¨ç»“æ„åŒ–æ•°æ®ï¼šå½“ç„¶æ˜¯æ•°æ®åº“ï¼è¿™å°±æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œå±•ç¤ºçš„æ–¹æ³•ã€‚é€šè¿‡æ‹¥æœ‰ä¸€ä¸ªä¸­å¤®æ•°æ®åº“ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­å­˜å‚¨å›¾åƒç”Ÿæˆè¯·æ±‚å’Œç»“æœï¼Œè¿™æ ·å°±èƒ½åœ¨å·¥ä½œç¨‹åºå’Œ API ä¹‹é—´å…±äº«ä¿¡æ¯ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†é‡ç”¨æˆ‘ä»¬åœ¨ã€Šç¬¬å…­ç« ã€‹çš„*ä½¿ç”¨ SQLAlchemy ORM ä¸ SQL æ•°æ®åº“é€šä¿¡*éƒ¨åˆ†ä¸­å±•ç¤ºçš„å¾ˆå¤šæŠ€å·§ã€‚æˆ‘ä»¬å¼€å§‹å§ï¼

### å®šä¹‰ä¸€ä¸ª SQLAlchemy æ¨¡å‹

ç¬¬ä¸€æ­¥æ˜¯å®šä¹‰ä¸€ä¸ª SQLAlchemy æ¨¡å‹æ¥å­˜å‚¨å•ä¸ªå›¾åƒç”Ÿæˆä»»åŠ¡ã€‚ä½ å¯ä»¥å¦‚ä¸‹æ‰€ç¤ºæŸ¥çœ‹å®ƒï¼š

models.py

```py

class GeneratedImage(Base):Â Â Â Â __tablename__ = "generated_images"
Â Â Â Â id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
Â Â Â Â created_at: Mapped[datetime] = mapped_column(
Â Â Â Â Â Â Â Â DateTime, nullable=False, default=datetime.now
Â Â Â Â )
Â Â Â Â progress: Mapped[int] = mapped_column(Integer, nullable=False, default=0)
Â Â Â Â prompt: Mapped[str] = mapped_column(Text, nullable=False)
Â Â Â Â negative_prompt: Mapped[str | None] = mapped_column(Text, nullable=True)
Â Â Â Â num_steps: Mapped[int] = mapped_column(Integer, nullable=False)
Â Â Â Â file_name: Mapped[str | None] = mapped_column(String(255), nullable=True)
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/models.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/models.py)

åƒå¾€å¸¸ä¸€æ ·ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè‡ªå¢çš„ ID ä½œä¸ºä¸»é”®ã€‚æˆ‘ä»¬è¿˜æ·»åŠ äº† `prompt`ã€`negative_prompt` å’Œ `num_steps` åˆ—ï¼Œè¿™äº›åˆ—å¯¹åº”æˆ‘ä»¬ä¼ é€’ç»™å·¥ä½œç¨‹åºä»»åŠ¡çš„å‚æ•°ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å°† ID ä¼ é€’ç»™å·¥ä½œç¨‹åºï¼Œå®ƒä¼šç›´æ¥ä»å¯¹è±¡ä¸­è·å–å‚æ•°ã€‚æ­¤å¤–ï¼Œè¿™è¿˜å…è®¸æˆ‘ä»¬å­˜å‚¨å¹¶è®°ä½ç”¨äºç‰¹å®šç”Ÿæˆçš„å‚æ•°ã€‚

`progress` åˆ—æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œç”¨æ¥å­˜å‚¨å½“å‰ç”Ÿæˆä»»åŠ¡çš„è¿›åº¦ã€‚

æœ€åï¼Œ`file_name` å°†å­˜å‚¨æˆ‘ä»¬åœ¨ç³»ç»Ÿä¸­ä¿å­˜çš„å®é™…æ–‡ä»¶åã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­å…³äºå¯¹è±¡å­˜å‚¨çš„éƒ¨åˆ†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨å®ƒã€‚

### å°† API è°ƒæ•´ä¸ºåœ¨æ•°æ®åº“ä¸­ä¿å­˜å›¾åƒç”Ÿæˆä»»åŠ¡

æœ‰äº†è¿™ä¸ªæ¨¡å‹åï¼Œæˆ‘ä»¬å¯¹ API ä¸­å›¾åƒç”Ÿæˆä»»åŠ¡çš„è°ƒåº¦æ–¹å¼ç¨å¾®åšäº†äº›è°ƒæ•´ã€‚æˆ‘ä»¬ä¸å†ç›´æ¥å°†ä»»åŠ¡å‘é€ç»™å·¥ä½œè¿›ç¨‹ï¼Œè€Œæ˜¯é¦–å…ˆåœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€è¡Œæ•°æ®ï¼Œå¹¶å°†è¯¥å¯¹è±¡çš„ ID ä½œä¸ºè¾“å…¥ä¼ é€’ç»™å·¥ä½œè¿›ç¨‹ä»»åŠ¡ã€‚ç«¯ç‚¹çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

api.py

```py

@app.post(Â Â Â Â "/generated-images",
Â Â Â Â response_model=schemas.GeneratedImageRead,
Â Â Â Â status_code=status.HTTP_201_CREATED,
)
async def create_generated_image(
Â Â Â Â generated_image_create: schemas.GeneratedImageCreate,
Â Â Â Â session: AsyncSession = Depends(get_async_session),
)Â Â Â Â GeneratedImage:
Â Â Â Â image = GeneratedImage(**generated_image_create.dict())
Â Â Â Â session.add(image)
Â Â Â Â await session.commit()
Â Â Â Â text_to_image_task.send(image.id)
Â Â Â Â return image
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/api.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/api.py)

æˆ‘ä»¬ä¸ä¼šæ·±å…¥è®¨è®ºå¦‚ä½•ä½¿ç”¨ SQLAlchemy ORM åœ¨æ•°æ®åº“ä¸­åˆ›å»ºå¯¹è±¡ã€‚å¦‚æœä½ éœ€è¦å¤ä¹ ï¼Œå¯ä»¥å‚è€ƒã€Šç¬¬å…­ç« ã€‹ä¸­çš„*ä½¿ç”¨ SQLAlchemy ORM ä¸ SQL æ•°æ®åº“é€šä¿¡*éƒ¨åˆ†ã€‚

åœ¨è¿™ä¸ªä»£ç ç‰‡æ®µä¸­ï¼Œä¸»è¦éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬å°†æ–°åˆ›å»ºå¯¹è±¡çš„ ID ä½œä¸º`text_to_image_task`çš„å‚æ•°ä¼ é€’ã€‚æ­£å¦‚æˆ‘ä»¬ç¨åçœ‹åˆ°çš„ï¼Œå·¥ä½œè¿›ç¨‹ä¼šä»æ•°æ®åº“ä¸­é‡æ–°è¯»å–è¿™ä¸ª IDï¼Œä»¥æ£€ç´¢ç”Ÿæˆå‚æ•°ã€‚

è¯¥ç«¯ç‚¹çš„å“åº”ä»…ä»…æ˜¯æˆ‘ä»¬`GeneratedImage`æ¨¡å‹çš„è¡¨ç¤ºï¼Œä½¿ç”¨äº† Pydantic æ¶æ„`GeneratedImageRead`ã€‚å› æ­¤ï¼Œç”¨æˆ·å°†ä¼šæ”¶åˆ°ç±»ä¼¼è¿™æ ·çš„å“åº”ï¼š

```py

{Â Â Â Â "created_at": "2023-02-07T10:17:50.992822",
Â Â Â Â "file_name": null,
Â Â Â Â "id": 6,
Â Â Â Â "negative_prompt": null,
Â Â Â Â "num_steps": 50,
Â Â Â Â "progress": 0,
Â Â Â Â "prompt": "a sunset over a beach"
}
```

å®ƒå±•ç¤ºäº†æˆ‘ä»¬åœ¨è¯·æ±‚ä¸­æä¾›çš„æç¤ºï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œ*å®ƒç»™äº†ä¸€ä¸ª ID*ã€‚è¿™æ„å‘³ç€ç”¨æˆ·å°†èƒ½å¤Ÿå†æ¬¡æŸ¥è¯¢æ­¤ç‰¹å®šè¯·æ±‚ä»¥æ£€ç´¢æ•°æ®ï¼Œå¹¶æŸ¥çœ‹æ˜¯å¦å®Œæˆã€‚è¿™å°±æ˜¯ä¸‹é¢å®šä¹‰çš„`get_generated_image`ç«¯ç‚¹çš„ç›®çš„ã€‚æˆ‘ä»¬ä¸ä¼šåœ¨è¿™é‡Œå±•ç¤ºå®ƒï¼Œä½†ä½ å¯ä»¥åœ¨ç¤ºä¾‹ä»“åº“ä¸­é˜…è¯»åˆ°å®ƒã€‚

### å°†å·¥ä½œè¿›ç¨‹è°ƒæ•´ä¸ºä»æ•°æ®åº“ä¸­è¯»å–å’Œæ›´æ–°å›¾åƒç”Ÿæˆä»»åŠ¡

ä½ å¯èƒ½å·²ç»çŒœåˆ°ï¼Œæˆ‘ä»¬éœ€è¦æ”¹å˜ä»»åŠ¡çš„å®ç°ï¼Œä»¥ä¾¿å®ƒèƒ½ä»æ•°æ®åº“ä¸­æ£€ç´¢å¯¹è±¡ï¼Œè€Œä¸æ˜¯ç›´æ¥è¯»å–å‚æ•°ã€‚è®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥è¿›è¡Œè°ƒæ•´ã€‚

æˆ‘ä»¬åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯ä½¿ç”¨åœ¨ä»»åŠ¡å‚æ•°ä¸­è·å¾—çš„ ID ä»æ•°æ®åº“ä¸­æ£€ç´¢ä¸€ä¸ª`GeneratedImage`ã€‚

worker.py

```py

@dramatiq.actor()def text_to_image_task(image_id: int):
Â Â Â Â image = get_image(image_id)
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py)

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œä½ ä¼šçœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªåä¸º`get_image`çš„è¾…åŠ©å‡½æ•°ã€‚å®ƒå®šä¹‰åœ¨ä»»åŠ¡çš„ä¸Šæ–¹ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š

worker.py

```py

def get_image(id: int) -> GeneratedImage:Â Â Â Â async def _get_image(id: int) -> GeneratedImage:
Â Â Â Â Â Â Â Â async with async_session_maker() as session:
Â Â Â Â Â Â Â Â Â Â Â Â select_query = select(GeneratedImage).where(GeneratedImage.id == id)
Â Â Â Â Â Â Â Â Â Â Â Â result = await session.execute(select_query)
Â Â Â Â Â Â Â Â Â Â Â Â image = result.scalar_one_or_none()
Â Â Â Â Â Â Â Â Â Â Â Â if image is None:
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â raise Exception("Image does not exist")
Â Â Â Â Â Â Â Â Â Â Â Â return image
Â Â Â Â return asyncio.run(_get_image(id))
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py)

å®ƒçœ‹èµ·æ¥å¯èƒ½æœ‰äº›å¥‡æ€ªï¼Œä½†å®é™…ä¸Šï¼Œä½ å·²ç»å¯¹å…¶å¤§éƒ¨åˆ†é€»è¾‘éå¸¸ç†Ÿæ‚‰äº†ã€‚å¦‚æœä½ ä»”ç»†è§‚å¯Ÿï¼Œä½ ä¼šå‘ç°å®ƒå®šä¹‰äº†ä¸€ä¸ªåµŒå¥—çš„ç§æœ‰å‡½æ•°ï¼Œåœ¨å…¶ä¸­æˆ‘ä»¬å®šä¹‰äº†å®é™…çš„é€»è¾‘æ¥ä½¿ç”¨ SQLAlchemy ORM è·å–å’Œä¿å­˜å¯¹è±¡ã€‚è¯·æ³¨æ„ï¼Œå®ƒæ˜¯*å¼‚æ­¥çš„*ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨å…¶ä¸­å¤§é‡ä½¿ç”¨äº†å¼‚æ­¥ I/O æ¨¡å¼ï¼Œæ­£å¦‚æœ¬ä¹¦ä¸­æ‰€å±•ç¤ºçš„é‚£æ ·ã€‚

è¿™æ­£æ˜¯æˆ‘ä»¬éœ€è¦åƒè¿™æ ·çš„è¾…åŠ©å‡½æ•°çš„åŸå› ã€‚äº‹å®ä¸Šï¼ŒDramatiq å¹¶æœªåŸç”Ÿè®¾è®¡ä¸ºè¿è¡Œå¼‚æ­¥å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä½¿ç”¨`asyncio.run`æ¥è°ƒåº¦å…¶æ‰§è¡Œã€‚æˆ‘ä»¬å·²ç»åœ¨*ç¬¬äºŒç« *ä¸­çœ‹åˆ°è¿‡è¿™ä¸ªå‡½æ•°ï¼Œé‚£é‡Œä»‹ç»äº†å¼‚æ­¥ I/Oã€‚å®ƒçš„ä½œç”¨æ˜¯è¿è¡Œå¼‚æ­¥å‡½æ•°å¹¶è¿”å›å…¶ç»“æœã€‚è¿™å°±æ˜¯æˆ‘ä»¬å¦‚ä½•åœ¨ä»»åŠ¡ä¸­åŒæ­¥è°ƒç”¨åŒ…è£…å‡½æ•°è€Œä¸å‡ºç°ä»»ä½•é—®é¢˜ã€‚

å…¶ä»–æ–¹æ³•ä¹Ÿå¯ä»¥è§£å†³å¼‚æ­¥ I/O é—®é¢˜ã€‚

æˆ‘ä»¬åœ¨è¿™é‡Œå±•ç¤ºçš„æ–¹æ³•æ˜¯è§£å†³å¼‚æ­¥å·¥ä½œè€…é—®é¢˜æœ€ç›´æ¥ä¸”ç¨³å¥çš„æ–¹æ³•ã€‚

å¦ä¸€ç§æ–¹æ³•å¯èƒ½æ˜¯ä¸º Dramatiq è®¾ç½®è£…é¥°å™¨æˆ–ä¸­é—´ä»¶ï¼Œä½¿å…¶èƒ½å¤ŸåŸç”Ÿæ”¯æŒè¿è¡Œå¼‚æ­¥å‡½æ•°ï¼Œä½†è¿™ç§æ–¹æ³•å¤æ‚ä¸”å®¹æ˜“å‡ºç° BUGã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘æ‹¥æœ‰å¦ä¸€ä¸ªåŒæ­¥å·¥ä½œçš„ SQLAlchemy å¼•æ“å’Œä¼šè¯ç”Ÿæˆå™¨ã€‚ç„¶è€Œï¼Œè¿™ä¼šå¯¼è‡´ä»£ç ä¸­å‡ºç°å¤§é‡é‡å¤çš„å†…å®¹ã€‚è€Œä¸”ï¼Œå¦‚æœæˆ‘ä»¬æœ‰é™¤äº† SQLAlchemy ä¹‹å¤–çš„å…¶ä»–å¼‚æ­¥å‡½æ•°ï¼Œè¿™ä¹Ÿæ— æ³•æä¾›å¸®åŠ©ã€‚

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å›åˆ°`text_to_image_task`çš„å®ç°ï¼š

worker.py

```py

@dramatiq.actor()def text_to_image_task(image_id: int):
Â Â Â Â image = get_image(image_id)
Â Â Â Â def callback(step: int, _timestep, _tensor):
Â Â Â Â Â Â Â Â update_progress(image, step)
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py)

æˆ‘ä»¬ä¸º Stable Diffusion ç®¡é“å®šä¹‰äº†ä¸€ä¸ª`callback`å‡½æ•°ã€‚å®ƒçš„ä½œç”¨æ˜¯å°†å½“å‰çš„è¿›åº¦ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œé’ˆå¯¹å½“å‰çš„`GeneratedImage`ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å†æ¬¡ä½¿ç”¨äº†ä¸€ä¸ªè¾…åŠ©å‡½æ•°`update_progress`ï¼š

worker.py

```py

def update_progress(image: GeneratedImage, step: int):Â Â Â Â async def _update_progress(image: GeneratedImage, step: int):
Â Â Â Â Â Â Â Â async with async_session_maker() as session:
Â Â Â Â Â Â Â Â Â Â Â Â image.progress = int((step / image.num_steps) * 100)
Â Â Â Â Â Â Â Â Â Â Â Â session.add(image)
Â Â Â Â Â Â Â Â Â Â Â Â await session.commit()
Â Â Â Â asyncio.run(_update_progress(image, step))
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py)

æˆ‘ä»¬ä½¿ç”¨ä¸`get_image`ç›¸åŒçš„æ–¹æ³•æ¥åŒ…è£…å¼‚æ­¥å‡½æ•°ã€‚

å›åˆ°`text_to_image_task`ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥è°ƒç”¨æˆ‘ä»¬çš„`TextToImage`æ¨¡å‹æ¥ç”Ÿæˆå›¾åƒã€‚è¿™ä¸å‰ä¸€èŠ‚ä¸­å±•ç¤ºçš„è°ƒç”¨å®Œå…¨ç›¸åŒã€‚å”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼Œæˆ‘ä»¬ä»`image`å¯¹è±¡ä¸­è·å–å‚æ•°ã€‚æˆ‘ä»¬è¿˜ä½¿ç”¨ UUID ç”Ÿæˆä¸€ä¸ªéšæœºçš„æ–‡ä»¶åï¼š

worker.py

```py

Â Â Â Â image_output = text_to_image_middleware.text_to_image.generate(Â Â Â Â Â Â Â Â image.prompt,
Â Â Â Â Â Â Â Â negative_prompt=image.negative_prompt,
Â Â Â Â Â Â Â Â num_steps=image.num_steps,
Â Â Â Â Â Â Â Â callback=callback,
Â Â Â Â )
Â Â Â Â file_name = f"{uuid.uuid4()}.png"
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py)

ä»¥ä¸‹éƒ¨åˆ†ç”¨äºå°†å›¾åƒä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€éƒ¨åˆ†ä¸­æ›´è¯¦ç»†åœ°è§£é‡Šè¿™ä¸€ç‚¹ï¼š

worker.py

```py

Â Â Â Â storage = Storage()Â Â Â Â storage.upload_image(image_output, file_name, settings.storage_bucket)
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py)

æœ€åï¼Œæˆ‘ä»¬è°ƒç”¨å¦ä¸€ä¸ªè¾…åŠ©å‡½æ•°`update_file_name`ï¼Œå°†éšæœºæ–‡ä»¶åä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚å®ƒå°†å…è®¸æˆ‘ä»¬ä¸ºç”¨æˆ·æ£€ç´¢è¯¥æ–‡ä»¶ï¼š

worker.py

```py

Â Â Â Â update_file_name(image, file_name)
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py)

å¦‚ä½ æ‰€è§ï¼Œè¿™ä¸ªå®ç°çš„é‡ç‚¹æ˜¯æˆ‘ä»¬ä»æ•°æ®åº“ä¸­è¯»å–å’Œå†™å…¥`GeneratedImage`çš„ä¿¡æ¯ã€‚è¿™å°±æ˜¯æˆ‘ä»¬å¦‚ä½•åœ¨ API æœåŠ¡å™¨å’Œå·¥ä½œè¿›ç¨‹ä¹‹é—´è¿›è¡Œ*åŒæ­¥*ã€‚å·¥ä½œè¿›ç¨‹çš„éƒ¨åˆ†å°±åˆ°æ­¤ä¸ºæ­¢ï¼æœ‰äº†è¿™ä¸ªé€»è¾‘ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä» API è°ƒåº¦ä¸€ä¸ªå›¾åƒç”Ÿæˆä»»åŠ¡ï¼Œè€Œå·¥ä½œè¿›ç¨‹åˆ™èƒ½å¤Ÿåœ¨è®¾ç½®æœ€ç»ˆæ–‡ä»¶åä¹‹å‰å®šæœŸæ›´æ–°ä»»åŠ¡è¿›åº¦ã€‚å› æ­¤ï¼Œé€šè¿‡ APIï¼Œä¸€ä¸ªç®€å•çš„`GET`è¯·æ±‚å°±èƒ½è®©æˆ‘ä»¬çœ‹åˆ°ä»»åŠ¡çš„çŠ¶æ€ã€‚

## åœ¨å¯¹è±¡å­˜å‚¨ä¸­å­˜å‚¨å’ŒæœåŠ¡æ–‡ä»¶

æˆ‘ä»¬å¿…é¡»è§£å†³çš„æœ€åä¸€ä¸ªæŒ‘æˆ˜æ˜¯å…³äºå­˜å‚¨ç”Ÿæˆçš„å›¾åƒã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§å¯é çš„æ–¹å¼æ¥å­˜å‚¨å®ƒä»¬ï¼ŒåŒæ—¶è®©ç”¨æˆ·èƒ½å¤Ÿè½»æ¾åœ°ä»äº’è”ç½‘ä¸­æ£€ç´¢å®ƒä»¬ã€‚

ä¼ ç»Ÿä¸Šï¼ŒWeb åº”ç”¨ç¨‹åºçš„å¤„ç†æ–¹å¼éå¸¸ç®€å•ã€‚å®ƒä»¬å°†æ–‡ä»¶ç›´æ¥å­˜å‚¨åœ¨æœåŠ¡å™¨çš„ç¡¬ç›˜ä¸­ï¼Œåœ¨æŒ‡å®šçš„ç›®å½•ä¸‹ï¼Œå¹¶é…ç½®å…¶ Web æœåŠ¡å™¨ï¼Œå½“è®¿é—®æŸä¸ª URL æ—¶æä¾›è¿™äº›æ–‡ä»¶ã€‚è¿™å®é™…ä¸Šæ˜¯æˆ‘ä»¬åœ¨*ç¬¬åä¸‰ç« *ä¸­çš„ WebSocket ç¤ºä¾‹ä¸­åšçš„ï¼šæˆ‘ä»¬ä½¿ç”¨äº† `StaticFiles` ä¸­é—´ä»¶æ¥é™æ€åœ°æä¾›æˆ‘ä»¬ç£ç›˜ä¸Šçš„ JavaScript è„šæœ¬ã€‚

è™½ç„¶è¿™ç§æ–¹å¼é€‚ç”¨äºé™æ€æ–‡ä»¶ï¼Œæ¯”å¦‚æ¯ä¸ªæœåŠ¡å™¨éƒ½æœ‰è‡ªå·±å‰¯æœ¬çš„ JavaScript æˆ– CSS æ–‡ä»¶ï¼Œä½†å¯¹äºç”¨æˆ·ä¸Šä¼ æˆ–åå°ç”Ÿæˆçš„åŠ¨æ€æ–‡ä»¶æ¥è¯´å¹¶ä¸åˆé€‚ï¼Œå°¤å…¶æ˜¯åœ¨å¤šä¸ªè¿›ç¨‹è¿è¡Œåœ¨ä¸åŒç‰©ç†æœºå™¨ä¸Šçš„å¤æ‚æ¶æ„ä¸­ã€‚é—®é¢˜å†æ¬¡å‡ºç°ï¼Œå³ä¸åŒè¿›ç¨‹è¯»å–çš„ä¸­å¤®æ•°æ®æºé—®é¢˜ã€‚åœ¨å‰é¢çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬çœ‹åˆ°æ¶ˆæ¯ä»£ç†å’Œæ•°æ®åº“å¯ä»¥åœ¨å¤šä¸ªåœºæ™¯ä¸­è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è€Œå¯¹äºä»»æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— è®ºæ˜¯å›¾åƒã€è§†é¢‘è¿˜æ˜¯ç®€å•çš„æ–‡æœ¬æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å…¶ä»–è§£å†³æ–¹æ¡ˆã€‚è®©æˆ‘ä»¬æ¥ä»‹ç»**å¯¹è±¡å­˜å‚¨**ã€‚

å¯¹è±¡å­˜å‚¨ä¸æˆ‘ä»¬æ—¥å¸¸åœ¨è®¡ç®—æœºä¸­ä½¿ç”¨çš„æ ‡å‡†æ–‡ä»¶å­˜å‚¨æœ‰æ‰€ä¸åŒï¼Œåè€…ä¸­çš„ç£ç›˜æ˜¯ä»¥ç›®å½•å’Œæ–‡ä»¶çš„å±‚æ¬¡ç»“æ„ç»„ç»‡çš„ã€‚è€Œå¯¹è±¡å­˜å‚¨å°†æ¯ä¸ªæ–‡ä»¶ä½œä¸ºä¸€ä¸ªå¯¹è±¡è¿›è¡Œå­˜å‚¨ï¼Œå…¶ä¸­åŒ…å«å®é™…æ•°æ®åŠå…¶æ‰€æœ‰å…ƒæ•°æ®ï¼Œå¦‚æ–‡ä»¶åã€å¤§å°ã€ç±»å‹å’Œå”¯ä¸€ IDã€‚è¿™ç§æ¦‚å¿µåŒ–çš„ä¸»è¦å¥½å¤„æ˜¯ï¼Œå®ƒæ›´å®¹æ˜“å°†è¿™äº›æ–‡ä»¶åˆ†å¸ƒåˆ°å¤šä¸ªç‰©ç†æœºå™¨ä¸Šï¼š*æˆ‘ä»¬å¯ä»¥å°†æ•°åäº¿ä¸ªæ–‡ä»¶å­˜å‚¨åœ¨åŒä¸€ä¸ªå¯¹è±¡å­˜å‚¨ä¸­*ã€‚ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬åªéœ€è¯·æ±‚ä¸€ä¸ªç‰¹å®šçš„æ–‡ä»¶ï¼Œå­˜å‚¨ç³»ç»Ÿä¼šè´Ÿè´£ä»å®é™…çš„ç‰©ç†ç£ç›˜åŠ è½½è¯¥æ–‡ä»¶ã€‚

åœ¨äº‘æ—¶ä»£ï¼Œè¿™ç§æ–¹æ³•æ˜¾ç„¶è·å¾—äº†å¹¿æ³›çš„å…³æ³¨ã€‚2006 å¹´ï¼Œ**äºšé©¬é€Šç½‘ç»œæœåŠ¡**ï¼ˆ**AWS**ï¼‰æ¨å‡ºäº†å…¶è‡ªæœ‰å®ç°çš„å¯¹è±¡å­˜å‚¨â€”â€”Amazon S3ã€‚å®ƒä¸ºå¼€å‘äººå‘˜æä¾›äº†å‡ ä¹æ— é™çš„ç£ç›˜ç©ºé—´ï¼Œå…è®¸é€šè¿‡ä¸€ä¸ªç®€å•çš„ API å­˜å‚¨æ–‡ä»¶ï¼Œå¹¶ä¸”ä»·æ ¼éå¸¸ä½å»‰ã€‚Amazon S3 å› å…¶å¹¿æ³›çš„æµè¡Œï¼Œå…¶ API æˆä¸ºè¡Œä¸šäº‹å®ä¸Šçš„æ ‡å‡†ã€‚å¦‚ä»Šï¼Œå¤§å¤šæ•°äº‘å¯¹è±¡å­˜å‚¨ï¼ŒåŒ…æ‹¬å¾®è½¯ Azure æˆ– Google Cloud ç­‰ç«äº‰å¯¹æ‰‹çš„å­˜å‚¨ï¼Œéƒ½ä¸ S3 API å…¼å®¹ã€‚å¼€æºå®ç°ä¹Ÿåº”è¿è€Œç”Ÿï¼Œå¦‚ MinIOã€‚è¿™ä¸ªé€šç”¨çš„ S3 API çš„ä¸»è¦å¥½å¤„æ˜¯ï¼Œæ‚¨å¯ä»¥åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ç›¸åŒçš„ä»£ç å’Œåº“ä¸ä»»ä½•å¯¹è±¡å­˜å‚¨æä¾›å•†è¿›è¡Œäº¤äº’ï¼Œå¹¶åœ¨éœ€è¦æ—¶è½»æ¾åˆ‡æ¢ã€‚

æ€»ç»“ä¸€ä¸‹ï¼Œå¯¹è±¡å­˜å‚¨æ˜¯ä¸€ç§éå¸¸æ–¹ä¾¿çš„æ–¹å¼ï¼Œç”¨äºå¤§è§„æ¨¡å­˜å‚¨å’Œæä¾›æ–‡ä»¶ï¼Œæ— è®ºæœ‰å¤šå°‘ä¸ªè¿›ç¨‹éœ€è¦è®¿é—®è¿™äº›æ•°æ®ã€‚åœ¨æœ¬èŠ‚ç»“æŸæ—¶ï¼Œæˆ‘ä»¬é¡¹ç›®çš„å…¨çƒæ¶æ„å°†åƒ*å›¾ 14.5*ä¸­æ‰€ç¤ºã€‚

![å›¾ 14.5 â€“ Web-é˜Ÿåˆ—-å·¥ä½œè€…æ¶æ„å’Œå¯¹è±¡å­˜å‚¨](img/Figure_14.5_B19528.jpg)

å›¾ 14.5 â€“ Web-é˜Ÿåˆ—-å·¥ä½œè€…æ¶æ„å’Œå¯¹è±¡å­˜å‚¨

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ*å¯¹è±¡å­˜å‚¨ä¼šç›´æ¥å°†æ–‡ä»¶æä¾›ç»™ç”¨æˆ·*ã€‚ä¸ä¼šæœ‰ä¸€ä¸ªç«¯ç‚¹ï¼ŒæœåŠ¡å™¨åœ¨ä»å¯¹è±¡å­˜å‚¨ä¸‹è½½æ–‡ä»¶åå†å°†å…¶å‘é€ç»™ç”¨æˆ·ã€‚ä»¥è¿™ç§æ–¹å¼æ“ä½œå¹¶æ²¡æœ‰å¤ªå¤§å¥½å¤„ï¼Œå³ä½¿åœ¨è®¤è¯æ–¹é¢ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æˆ‘ä»¬å°†çœ‹åˆ°ï¼Œå…¼å®¹ S3 çš„å­˜å‚¨å…·æœ‰å†…å»ºçš„æœºåˆ¶æ¥ä¿æŠ¤æ–‡ä»¶ä¸è¢«æœªæˆæƒè®¿é—®ã€‚

### å®ç°ä¸€ä¸ªå¯¹è±¡å­˜å‚¨åŠ©æ‰‹

é‚£ä¹ˆæˆ‘ä»¬å¼€å§‹å†™ä»£ç å§ï¼æˆ‘ä»¬å°†ä½¿ç”¨ MinIO çš„ Python å®¢æˆ·ç«¯åº“ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸ä»»ä½•å…¼å®¹ S3 çš„å­˜å‚¨è¿›è¡Œäº¤äº’çš„åº“ã€‚è®©æˆ‘ä»¬å…ˆå®‰è£…å®ƒï¼š

```py

(venv) $ pip install minio
```

æˆ‘ä»¬ç°åœ¨å¯ä»¥å®ç°ä¸€ä¸ªç±»ï¼Œä»¥ä¾¿æ‰‹å¤´æœ‰æˆ‘ä»¬éœ€è¦çš„æ‰€æœ‰æ“ä½œã€‚æˆ‘ä»¬å…ˆä»åˆå§‹åŒ–å™¨å¼€å§‹ï¼š

storage.py

```py

class Storage:Â Â Â Â def __init__(self) -> None:
Â Â Â Â Â Â Â Â self.client = Minio(
Â Â Â Â Â Â Â Â Â Â Â Â settings.storage_endpoint,
Â Â Â Â Â Â Â Â Â Â Â Â access_key=settings.storage_access_key,
Â Â Â Â Â Â Â Â Â Â Â Â secret_key=settings.storage_secret_key,
Â Â Â Â Â Â Â Â )
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/storage.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/storage.py)

åœ¨è¯¥ç±»çš„åˆå§‹åŒ–å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª `Minio` å®¢æˆ·ç«¯å®ä¾‹ã€‚ä½ ä¼šçœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª `settings` å¯¹è±¡æ¥æå–å­˜å‚¨ URL å’Œå‡­è¯ã€‚å› æ­¤ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡å°±èƒ½éå¸¸è½»æ¾åœ°åˆ‡æ¢å®ƒä»¬ã€‚

ç„¶åæˆ‘ä»¬å°†å®ç°ä¸€äº›æ–¹æ³•ï¼Œå¸®åŠ©æˆ‘ä»¬å¤„ç†å¯¹è±¡å­˜å‚¨ã€‚ç¬¬ä¸€ä¸ªæ–¹æ³•æ˜¯ `ensure_bucket`ï¼š

storage.py

```py

Â Â Â Â def ensure_bucket(self, bucket_name: str):Â Â Â Â Â Â Â Â bucket_exists = self.client.bucket_exists(bucket_name)
Â Â Â Â Â Â Â Â if not bucket_exists:
Â Â Â Â Â Â Â Â Â Â Â Â self.client.make_bucket(bucket_name)
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/storage.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/storage.py)

è¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯ç¡®ä¿åœ¨æˆ‘ä»¬çš„å¯¹è±¡å­˜å‚¨ä¸­åˆ›å»ºäº†æ­£ç¡®çš„å­˜å‚¨æ¡¶ã€‚åœ¨ S3 å®ç°ä¸­ï¼Œ**å­˜å‚¨æ¡¶**å°±åƒæ˜¯ä½ æ‹¥æœ‰çš„æ–‡ä»¶å¤¹ï¼Œä½ å¯ä»¥å°†æ–‡ä»¶å­˜å‚¨åœ¨å…¶ä¸­ã€‚ä½ ä¸Šä¼ çš„æ¯ä¸ªæ–‡ä»¶éƒ½å¿…é¡»æ”¾å…¥ä¸€ä¸ªç°æœ‰çš„å­˜å‚¨æ¡¶ä¸­ã€‚

ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰äº† `upload_image`ï¼š

storage.py

```py

Â Â Â Â def upload_image(self, image: Image, object_name: str, bucket_name: str):Â Â Â Â Â Â Â Â self.ensure_bucket(bucket_name)
Â Â Â Â Â Â Â Â image_data = io.BytesIO()
Â Â Â Â Â Â Â Â image.save(image_data, format="PNG")
Â Â Â Â Â Â Â Â image_data.seek(0)
Â Â Â Â Â Â Â Â image_data_length = len(image_data.getvalue())
Â Â Â Â Â Â Â Â self.client.put_object(
Â Â Â Â Â Â Â Â Â Â Â Â bucket_name,
Â Â Â Â Â Â Â Â Â Â Â Â object_name,
Â Â Â Â Â Â Â Â Â Â Â Â image_data,
Â Â Â Â Â Â Â Â Â Â Â Â length=image_data_length,
Â Â Â Â Â Â Â Â Â Â Â Â content_type="image/png",
Â Â Â Â Â Â Â Â )
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/storage.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/storage.py)

è¿™æ˜¯ç”¨äºå°†å›¾åƒä¸Šä¼ åˆ°å­˜å‚¨çš„ã€‚ä¸ºäº†ç®€åŒ–æ“ä½œï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ª Pillow `Image` å¯¹è±¡ï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬åœ¨ Stable Diffusion æµæ°´çº¿çš„æœ€åå¾—åˆ°çš„ç»“æœã€‚æˆ‘ä»¬å®ç°äº†ä¸€äº›é€»è¾‘ï¼Œå°†è¿™ä¸ª `Image` å¯¹è±¡è½¬æ¢ä¸ºé€‚åˆ S3 ä¸Šä¼ çš„åŸå§‹å­—èŠ‚æµã€‚è¯¥æ–¹æ³•è¿˜æœŸæœ›æ¥æ”¶ `object_name`ï¼Œå³å­˜å‚¨ä¸­å®é™…çš„æ–‡ä»¶åï¼Œä»¥åŠ `bucket_name`ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬é¦–å…ˆç¡®ä¿å­˜å‚¨æ¡¶å·²ç»æ­£ç¡®åˆ›å»ºï¼Œç„¶åå†å°è¯•ä¸Šä¼ æ–‡ä»¶ã€‚

æœ€åï¼Œæˆ‘ä»¬æ·»åŠ äº† `get_presigned_url` æ–¹æ³•ï¼š

storage.py

```py

Â Â Â Â def get_presigned_url(Â Â Â Â Â Â Â Â self,
Â Â Â Â Â Â Â Â object_name: str,
Â Â Â Â Â Â Â Â bucket_name: str,
Â Â Â Â Â Â Â Â *,
Â Â Â Â Â Â Â Â expires: timedelta = timedelta(days=7)
Â Â Â Â )Â Â Â Â str:
Â Â Â Â Â Â Â Â return self.client.presigned_get_object(
Â Â Â Â Â Â Â Â Â Â Â Â bucket_name, object_name, expires=expires
Â Â Â Â Â Â Â Â )
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/storage.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/storage.py)

è¿™ç§æ–¹æ³•å°†å¸®åŠ©æˆ‘ä»¬å®‰å…¨åœ°å°†æ–‡ä»¶æä¾›ç»™ç”¨æˆ·ã€‚å‡ºäºå®‰å…¨åŸå› ï¼ŒS3 å­˜å‚¨ä¸­çš„æ–‡ä»¶é»˜è®¤å¯¹äº’è”ç½‘ç”¨æˆ·ä¸å¯è®¿é—®ã€‚ä¸ºäº†ç»™äºˆæ–‡ä»¶è®¿é—®æƒé™ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹ä»»ä¸€æ“ä½œï¼š

+   å°†æ–‡ä»¶è®¾ç½®ä¸ºå…¬å¼€çŠ¶æ€ï¼Œè¿™æ ·ä»»ä½•æ‹¥æœ‰ URL çš„äººéƒ½èƒ½è®¿é—®å®ƒã€‚è¿™ä¸ªé€‚åˆå…¬å¼€æ–‡ä»¶ï¼Œä½†å¯¹äºç§å¯†çš„ç”¨æˆ·æ–‡ä»¶åˆ™ä¸é€‚ç”¨ã€‚

+   ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰ä¸´æ—¶è®¿é—®å¯†é’¥çš„ URLã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†æ–‡ä»¶è®¿é—®æƒé™æä¾›ç»™ç”¨æˆ·ï¼Œå³ä½¿ URL è¢«çªƒå–ï¼Œè®¿é—®ä¹Ÿä¼šåœ¨ä¸€æ®µæ—¶é—´åè¢«æ’¤é”€ã€‚è¿™å¸¦æ¥çš„å·¨å¤§å¥½å¤„æ˜¯ï¼ŒURL ç”Ÿæˆå‘ç”Ÿåœ¨æˆ‘ä»¬çš„ API æœåŠ¡å™¨ä¸Šï¼Œä½¿ç”¨ S3 å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼Œåœ¨ç”Ÿæˆæ–‡ä»¶ URL ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„é€»è¾‘æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é€šè¿‡èº«ä»½éªŒè¯ï¼Œå¹¶ä¸”æ˜¯å¦æœ‰æƒè®¿é—®ç‰¹å®šçš„æ–‡ä»¶ã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œé‡‡ç”¨çš„æ–¹æ³•ï¼Œå¹¶ä¸”æ­¤æ–¹æ³•ä¼šåœ¨ç‰¹å®šå­˜å‚¨æ¡¶ä¸­çš„ç‰¹å®šæ–‡ä»¶ä¸Šç”Ÿæˆé¢„ç­¾å URLï¼Œä¸”æœ‰æ•ˆæœŸä¸ºä¸€å®šæ—¶é—´ã€‚

å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬çš„ç±»åªæ˜¯ MinIO å®¢æˆ·ç«¯çš„ä¸€ä¸ªè–„åŒ…è£…ã€‚ç°åœ¨æˆ‘ä»¬è¦åšçš„å°±æ˜¯ç”¨å®ƒæ¥ä¸Šä¼ å›¾åƒå¹¶ä» API è·å–é¢„ç­¾å URLã€‚

### åœ¨å·¥ä½œè€…ä¸­ä½¿ç”¨å¯¹è±¡å­˜å‚¨åŠ©æ‰‹

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†ä»»åŠ¡å®ç°ä¸­çš„ä»¥ä¸‹å‡ è¡Œä»£ç ï¼š

worker.py

```py

Â Â Â Â storage = Storage()Â Â Â Â storage.upload_image(image_output, file_name, settings.storage_bucket)
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/worker.py)

ç°åœ¨æˆ‘ä»¬å·²ç»è°ˆåˆ°äº† `Storage` ç±»ï¼Œä½ åº”è¯¥èƒ½çŒœåˆ°æˆ‘ä»¬åœ¨è¿™é‡Œåšçš„äº‹æƒ…ï¼šæˆ‘ä»¬è·å–ç”Ÿæˆçš„å›¾åƒåŠå…¶éšæœºåç§°ï¼Œå¹¶å°†å…¶ä¸Šä¼ åˆ° `settings` ä¸­å®šä¹‰çš„å­˜å‚¨æ¡¶ã€‚å°±è¿™æ ·ï¼

### åœ¨æœåŠ¡å™¨ä¸Šç”Ÿæˆé¢„ç­¾å URL

åœ¨ API ç«¯ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªæ–°ç«¯ç‚¹ï¼Œè§’è‰²æ˜¯è¿”å›ç»™å®š `GeneratedImage` çš„é¢„ç­¾å URLï¼š

server.py

```py

@app.get("/generated-images/{id}/url")async def get_generated_image_url(
Â Â Â Â image: GeneratedImage = Depends(get_generated_image_or_404),
Â Â Â Â storage: Storage = Depends(get_storage),
)Â Â Â Â schemas.GeneratedImageURL:
Â Â Â Â if image.file_name is None:
Â Â Â Â Â Â Â Â raise HTTPException(
Â Â Â Â Â Â Â Â Â Â Â Â status_code=status.HTTP_400_BAD_REQUEST,
Â Â Â Â Â Â Â Â Â Â Â Â detail="Image is not available yet. Please try again later.",
Â Â Â Â Â Â Â Â )
Â Â Â Â url = storage.get_presigned_url(image.file_name, settings.storage_bucket)
Â Â Â Â return schemas.GeneratedImageURL(url=url)
```

[`github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/server.py`](https://github.com/PacktPublishing/Building-Data-Science-Applications-with-FastAPI-Second-Edition/tree/main/chapter14/complete/server.py)

åœ¨ç”Ÿæˆ URL ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆæ£€æŸ¥ `GeneratedImage` å¯¹è±¡ä¸Šæ˜¯å¦è®¾ç½®äº† `file_name` å±æ€§ã€‚å¦‚æœæ²¡æœ‰ï¼Œæ„å‘³ç€å·¥ä½œè€…ä»»åŠ¡å°šæœªå®Œæˆã€‚å¦‚æœæœ‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­è°ƒç”¨ `Storage` ç±»çš„ `get_presigned_url` æ–¹æ³•ã€‚

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å·²ç»å®šä¹‰äº†ä¾èµ–æ³¨å…¥æ¥è·å– `Storage` å®ä¾‹ã€‚æ­£å¦‚æœ¬ä¹¦ä¸­æ‰€å±•ç¤ºçš„é‚£æ ·ï¼Œåœ¨å¤„ç†å¤–éƒ¨æœåŠ¡æ—¶ï¼ŒFastAPI ä¸­ä½¿ç”¨ä¾èµ–æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„å®è·µã€‚

å¥½çš„ï¼Œçœ‹æ¥æˆ‘ä»¬ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼è®©æˆ‘ä»¬çœ‹çœ‹å®ƒå¦‚ä½•è¿è¡Œã€‚

### è¿è¡Œå›¾åƒç”Ÿæˆç³»ç»Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸ºé¡¹ç›®å¡«å……ç¯å¢ƒå˜é‡ï¼Œç‰¹åˆ«æ˜¯æ•°æ®åº“ URL å’Œ S3 å‡­æ®ã€‚ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ SQLite æ•°æ®åº“å’Œ MinIO çš„ç¤ºä¾‹å¹³å°ä½œä¸º S3 å­˜å‚¨ã€‚MinIO æ˜¯ä¸€ä¸ªå…è´¹çš„å¼€æºå¯¹è±¡å­˜å‚¨å¹³å°ï¼Œéå¸¸é€‚åˆç¤ºä¾‹å’Œç©å…·é¡¹ç›®ã€‚å½“è¿›å…¥ç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œä½ å¯ä»¥è½»æ¾åˆ‡æ¢åˆ°ä»»ä½•å…¼å®¹ S3 çš„æä¾›å•†ã€‚è®©æˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `.env` æ–‡ä»¶ï¼š

```py

DATABASE_URL=sqlite+aiosqlite:///chapter14.dbSTORAGE_ENDPOINT=play.min.io
STORAGE_ACCESS_KEY=Q3AM3UQ867SPQQA43P2F
STORAGE_SECRET_KEY=zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG
STORAGE_BUCKET=fastapi-book-text-to-image
```

å­˜å‚¨ç«¯ç‚¹ã€è®¿é—®å¯†é’¥å’Œç§˜é’¥æ˜¯ MinIO æ¼”ç¤ºç¯å¢ƒçš„å‚æ•°ã€‚ç¡®ä¿æŸ¥çœ‹å®ƒä»¬çš„å®˜æ–¹æ–‡æ¡£ï¼Œä»¥äº†è§£è‡ªæˆ‘ä»¬ç¼–å†™æœ¬ä¹¦ä»¥æ¥æ˜¯å¦æœ‰æ‰€æ›´æ”¹ï¼š[`min.io/docs/minio/linux/developers/python/minio-py.html#id5`](https://min.io/docs/minio/linux/developers/python/minio-py.html#id5)ã€‚

æˆ‘ä»¬çš„`Settings`ç±»å°†è‡ªåŠ¨åŠ è½½æ­¤æ–‡ä»¶ï¼Œä»¥å¡«å……æˆ‘ä»¬åœ¨ä»£ç ä¸­ä½¿ç”¨çš„è®¾ç½®ã€‚å¦‚æœä½ éœ€è¦å¤ä¹ è¿™ä¸€æ¦‚å¿µï¼Œç¡®ä¿æŸ¥çœ‹*ç¬¬åç« *ä¸­çš„*è®¾ç½®å’Œä½¿ç”¨ç¯å¢ƒå˜é‡*éƒ¨åˆ†ã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œç³»ç»Ÿäº†ã€‚ç¡®ä¿ä½ çš„ Redis æœåŠ¡å™¨ä»åœ¨è¿è¡Œï¼Œæ­£å¦‚åœ¨*æŠ€æœ¯è¦æ±‚*éƒ¨åˆ†æ‰€è§£é‡Šçš„é‚£æ ·ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬å¯åŠ¨ FastAPI æœåŠ¡å™¨ï¼š

```py

(venv) $ uvicorn chapter14.complete.api:app
```

ç„¶åï¼Œå¯åŠ¨å·¥ä½œè¿›ç¨‹ï¼š

```py

(venv) $ dramatiq -p 1 -t 1 chapter14.complete.worker
```

å †æ ˆç°åœ¨å·²å‡†å¤‡å¥½ç”Ÿæˆå›¾åƒã€‚è®©æˆ‘ä»¬ä½¿ç”¨ HTTPie å‘èµ·è¯·æ±‚ï¼Œå¼€å§‹ä¸€ä¸ªæ–°çš„ä»»åŠ¡ï¼š

```py

$ http POST http://localhost:8000/generated-images prompt="a sunset over a beach"HTTP/1.1 201 Created
content-length: 151
content-type: application/json
date: Mon, 13 Feb 2023 07:24:44 GMT
server: uvicorn
{
Â Â Â Â "created_at": "2023-02-13T08:24:45.954240",
Â Â Â Â "file_name": null,
Â Â Â Â "id": 1,
Â Â Â Â "negative_prompt": null,
Â Â Â Â "num_steps": 50,
Â Â Â Â "progress": 0,
Â Â Â Â "prompt": "a sunset over a beach"
}
```

ä¸€ä¸ªæ–°çš„`GeneratedImage`å·²åœ¨æ•°æ®åº“ä¸­åˆ›å»ºï¼Œåˆ†é…çš„ ID ä¸º`1`ã€‚è¿›åº¦ä¸º*0%*ï¼›å¤„ç†å°šæœªå¼€å§‹ã€‚è®©æˆ‘ä»¬å°è¯•é€šè¿‡ API æŸ¥è¯¢å®ƒï¼š

```py

http GET http://localhost:8000/generated-images/1HTTP/1.1 200 OK
content-length: 152
content-type: application/json
date: Mon, 13 Feb 2023 07:25:04 GMT
server: uvicorn
{
Â Â Â Â "created_at": "2023-02-13T08:24:45.954240",
Â Â Â Â "file_name": null,
Â Â Â Â "id": 1,
Â Â Â Â "negative_prompt": null,
Â Â Â Â "num_steps": 50,
Â Â Â Â "progress": 36,
Â Â Â Â "prompt": "a sunset over a beach"
}
```

API è¿”å›ç›¸åŒçš„å¯¹è±¡åŠå…¶æ‰€æœ‰å±æ€§ã€‚æ³¨æ„ï¼Œè¿›åº¦å·²æ›´æ–°ï¼Œç°åœ¨ä¸º*36%*ã€‚è¿‡ä¸€ä¼šå„¿ï¼Œæˆ‘ä»¬å¯ä»¥å†æ¬¡å°è¯•ç›¸åŒçš„è¯·æ±‚ï¼š

```py

$ http GET http://localhost:8000/generated-images/1HTTP/1.1 200 OK
content-length: 191
content-type: application/json
date: Mon, 13 Feb 2023 07:25:34 GMT
server: uvicorn
{
Â Â Â Â "created_at": "2023-02-13T08:24:45.954240",
Â Â Â Â "file_name": "affeec65-5d9b-480e-ac08-000c74e22dc9.png",
Â Â Â Â "id": 1,
Â Â Â Â "negative_prompt": null,
Â Â Â Â "num_steps": 50,
Â Â Â Â "progress": 100,
Â Â Â Â "prompt": "a sunset over a beach"
}
```

è¿™æ¬¡ï¼Œè¿›åº¦ä¸º*100%*ï¼Œæ–‡ä»¶åå·²ç»å¡«å†™ã€‚å›¾åƒå‡†å¤‡å¥½äº†ï¼ç°åœ¨æˆ‘ä»¬å¯ä»¥è¯·æ±‚ API ä¸ºè¯¥å›¾åƒç”Ÿæˆä¸€ä¸ªé¢„ç­¾å URLï¼š

```py

$ http GET http://localhost:8000/generated-images/1/urlHTTP/1.1 200 OK
content-length: 366
content-type: application/json
date: Mon, 13 Feb 2023 07:29:53 GMT
server: uvicorn
{
Â Â Â Â "url": "https://play.min.io/fastapi-book-text-to-image/affeec65-5d9b-480e-ac08-000c74e22dc9.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=Q3AM3UQ867SPQQA43P2F%2F20230213%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230213T072954Z&X-Amz-Expires=604800&X-Amz-SignedHeaders=host&X-Amz-Signature=6ffddb81702bed6aac50786578eb75af3c1f6a3db28e4990467c973cb3b457a9"
}
```

æˆ‘ä»¬åœ¨ MinIO æœåŠ¡å™¨ä¸Šå¾—åˆ°äº†ä¸€ä¸ªéå¸¸é•¿çš„ URLã€‚å¦‚æœä½ åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å®ƒï¼Œä½ ä¼šçœ‹åˆ°åˆšåˆšç”±æˆ‘ä»¬çš„ç³»ç»Ÿç”Ÿæˆçš„å›¾åƒï¼Œå¦‚*å›¾ 14.6*æ‰€ç¤ºã€‚

![å›¾ 14.6 â€“ ç”Ÿæˆçš„å›¾åƒæ‰˜ç®¡åœ¨å¯¹è±¡å­˜å‚¨ä¸­](img/Figure_14.6_B19528.jpg)

å›¾ 14.6 â€“ ç”Ÿæˆçš„å›¾åƒæ‰˜ç®¡åœ¨å¯¹è±¡å­˜å‚¨ä¸­

å¾ˆä¸é”™ï¼Œä¸æ˜¯å—ï¼Ÿæˆ‘ä»¬ç°åœ¨æ‹¥æœ‰ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„ç³»ç»Ÿï¼Œç”¨æˆ·èƒ½å¤Ÿæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

+   è¯·æ±‚æ ¹æ®ä»–ä»¬è‡ªå·±çš„æç¤ºå’Œå‚æ•°ç”Ÿæˆå›¾åƒ

+   è·å–è¯·æ±‚è¿›åº¦çš„ä¿¡æ¯

+   ä»å¯é å­˜å‚¨ä¸­è·å–ç”Ÿæˆçš„å›¾åƒ

æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°çš„æ¶æ„å·²ç»å¯ä»¥åœ¨å…·æœ‰å¤šå°æœºå™¨çš„äº‘ç¯å¢ƒä¸­éƒ¨ç½²ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæœ‰ä¸€å°æ ‡å‡†çš„ä¾¿å®œæœåŠ¡å™¨æ¥æä¾› API æœåŠ¡ï¼Œè€Œå¦ä¸€å°åˆ™æ˜¯æ›´æ˜‚è´µçš„æœåŠ¡å™¨ï¼Œé…æœ‰ä¸“ç”¨ GPU å’Œå……è¶³çš„ RAM æ¥è¿è¡Œå·¥ä½œè¿›ç¨‹ã€‚ä»£ç æ— éœ€æ›´æ”¹å°±å¯ä»¥å¤„ç†è¿™ç§éƒ¨ç½²ï¼Œå› ä¸ºè¿›ç¨‹é—´çš„é€šä¿¡æ˜¯ç”±ä¸­å¤®å…ƒç´ â€”â€”æ¶ˆæ¯ä»£ç†ã€æ•°æ®åº“å’Œå¯¹è±¡å­˜å‚¨æ¥å¤„ç†çš„ã€‚

# æ€»ç»“

å¤ªæ£’äº†ï¼ä½ å¯èƒ½è¿˜æ²¡æœ‰æ„è¯†åˆ°ï¼Œä½†åœ¨è¿™ä¸€ç« ä¸­ï¼Œä½ å·²ç»å­¦ä¹ äº†å¦‚ä½•æ¶æ„å’Œå®ç°ä¸€ä¸ªéå¸¸å¤æ‚çš„æœºå™¨å­¦ä¹ ç³»ç»Ÿï¼Œå®ƒèƒ½ä¸ä½ åœ¨å¤–é¢çœ‹åˆ°çš„ç°æœ‰å›¾åƒç”ŸæˆæœåŠ¡ç›¸åª²ç¾ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œå±•ç¤ºçš„æ¦‚å¿µæ˜¯è‡³å…³é‡è¦çš„ï¼Œä¸”æ˜¯æ‰€æœ‰ä½ èƒ½æƒ³è±¡çš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œæ— è®ºå®ƒä»¬æ˜¯è®¾è®¡ç”¨æ¥è¿è¡Œæœºå™¨å­¦ä¹ æ¨¡å‹ã€æå–ç®¡é“ï¼Œè¿˜æ˜¯æ•°å­¦è®¡ç®—ã€‚é€šè¿‡ä½¿ç”¨åƒ FastAPI å’Œ Dramatiq è¿™æ ·çš„ç°ä»£å·¥å…·ï¼Œä½ å°†èƒ½å¤Ÿåœ¨çŸ­æ—¶é—´å†…ç”¨æœ€å°‘çš„ä»£ç å®ç°è¿™ç§æ¶æ„ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªéå¸¸å¿«é€Ÿä¸”ç¨³å¥çš„ç»“æœã€‚

æˆ‘ä»¬çš„æ—…ç¨‹å³å°†ç»“æŸã€‚åœ¨è®©ä½ ç”¨ FastAPI å¼€å§‹è‡ªå·±çš„å†’é™©ä¹‹å‰ï¼Œæˆ‘ä»¬å°†ç ”ç©¶æ„å»ºæ•°æ®ç§‘å­¦åº”ç”¨ç¨‹åºæ—¶çš„æœ€åä¸€ä¸ªé‡è¦æ–¹é¢ï¼šæ—¥å¿—è®°å½•å’Œç›‘æ§ã€‚
