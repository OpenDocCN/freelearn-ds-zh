# 第二章. 深入 API

**应用程序编程接口**（**API**）定义了从网络服务中可用的操作、格式和数据结构。开发者使用 API 编写代码，告诉服务器完成任务。API 建立在现有编程语言之上，并使用语言的语法和功能使与计算机的通信更容易编码。

在某个时候，ESRI 有三个基于 Web 的 API 用于与 ArcGIS Server 通信：Flash、Silverlight 和 JavaScript。随着移动网络的兴起和浏览器性能的提升，ArcGIS JavaScript API 成为了浏览器首选。为了最好地利用 ArcGIS Server 地图功能，最好学习 JavaScript API 提供的功能。我们将通过 API 进行一次巡游，以便熟悉它所能提供的内容。

与本书中的其他章节不同，本章提供更多的是参考而不是编程练习。添加了简短的代码片段，以展示如何在 API 中使用模块。如果您没有从本章中吸收所有信息，请不要担心。只需回来重新阅读其中的部分内容作为参考即可。

在本章中，我们将学习以下主题：

+   如何在 ArcGIS JavaScript API 中创建和配置地图

+   如何通过瓦片、动态和图形层显示来自 ArcGIS Server 的地理数据

+   地图上图形的构建块

+   如何通过任务与 ArcGIS Server 服务进行通信

+   如何通过名为**dijits**的打包 UI 控件节省开发时间

### 注意

有关 ArcGIS JavaScript API 的更多信息，包括您可以构建的示例，请参阅 Eric Pimpler 的《Building Web and Mobile ArcGIS Server Applications with JavaScript》或 Rene Rubalcava 的《ArcGIS Web Development》。

# 查找 ArcGIS JavaScript API 文档

您可以通过访问[`developers.arcgis.com/javascript/jsapi/`](https://developers.arcgis.com/javascript/jsapi/)找到 ArcGIS API for JavaScript 的文档。在那里，您可以找到有关 API 最新版本的信息、自上一版本以来的更改列表以及帮助您创建应用程序的相关文档。组织结构合理，信息相对容易通过其布局找到。

## 文档布局

ArcGIS API 中每个元素的文档都按组织方式排列。API 组件的链接位于左侧。每个元素的文档默认为 AMD 风格，但提供链接到较旧的遗产开发风格。使用 AMD 风格时，页面顶部显示如何将模块加载到您的代码中。接下来是模块的描述、使用该模块的示例链接以及显示当前模块继承的模块的类层次结构图。

### 对象构造函数

如果模块需要构造 JavaScript 对象，文档将提供有关调用模块构造函数所需信息。文档提供了创建对象所需的参数的详细信息，包括参数名称、对象类型、它们是否可选以及它们的作用。

### CSS 类和数据-属性

在任何构造函数信息之后，文档提供了有关模块可能显示在地图上的任何内容的 CSS 类属性数据，以及模块可能使用的任何 HTML5 data-* 属性。CSS 类可以帮助您通过提供类钩子来修改模块中小部件和视觉元素的外观，以便使用您自定义的样式进行修改。data-* 属性使其他 JavaScript 脚本能够访问有关您的部件的信息，而无需将整个部件加载到内存中。例如，当使用另一个库点击地图图形时，您可以通过查看元素的数据-geometry-type 属性来访问几何类型。

### 属性

当使用构造函数创建 ArcGIS API 对象时，它将具有某些属性或分配给对象的变量参数。一些属性在对象创建时设置。其他属性在对象修改时设置，或运行某些方法时设置。API 文档列出了积极维护的对象属性，并且在没有足够的通知的情况下不会删除。

### 小贴士

如果您在浏览器中使用网络开发者工具，例如 Firefox 的 Firebug 或 Chrome 开发者工具，您可能会发现这些 ArcGIS API 对象具有比文档中列出的更多的属性。许多被认为是私有的属性在其名称前有一个或两个下划线 (`_`) 字符。如果属性和方法未在文档中列出，它们可能在 API 的下一个版本发布时不存在。不要依赖代码中的未记录属性和方法。

### 方法

除了某些属性外，使用 ArcGIS API 模块创建的对象可能还会包含方法，这些方法是分配给对象的 JavaScript 函数，通常使用它们分配到的对象的其他部分。文档将列出附加到对象上的公共方法，以及它们接受的参数、返回的值以及它们执行的任务或功能的描述。

### 事件

许多模块都有记录的事件，其中模块会发出通知表示发生了某些事情。这些类似于 HTML 按钮的 `onClick` 事件或浏览器的 `onLoad` 事件。在 API 的旧版本中，事件是通过 `dojo.connect` 监听的。但随着库的成熟，Dojo 正在淘汰 connect 函数，并用 **dojo/on** 库（[`dojotoolkit.org/reference-guide/1.10/dojo/on.html`](http://dojotoolkit.org/reference-guide/1.10/dojo/on.html)）来替换。实际上，`dojo/on` 模块提供了一个函数。

使用 dojo/on 函数，你可以通过以下参数调用它来附加事件：你想要监听的 HTML DOM 元素或 Dojo 小部件，事件名称作为字符串，以及当事件发生时将被调用的函数。如果你想停止事件，你需要一个变量来接受 dojo/on 调用的返回值，提前准备。当你准备好停止监听时，调用那个返回变量的 `remove()` 方法。一些模块包含它们自己的 `on()` 方法，该方法实现了用于事件处理的 `dojo/on` 模块。以下是一个使用 `dojo/on` 模块的示例代码片段：

```py
require(["dojo/on", "dojo/dom", "dojo/domReady!"], 
function (on, dom) {
  var soupMe = on(dom.byId("deliver-soup"), "click", function () {
      alert("Here's your soup. NEXT!");
  });
  on(dom.byId("no-more-soup"), "click", function () {
      alert("NO SOUP FOR YOU!");
      soupMe.remove();
  });
});
```

现在我们已经了解了阅读文档时可以期待的内容，让我们来看看 ArcGIS API for JavaScript 中可用的不同工具。由于 ArcGIS 应用程序与地理数据一起工作，我们将首先查看地图。

# 绘制地图

当使用 ArcGIS JavaScript API 进行工作时，你首先想要做的事情之一就是创建一个地图。地图将一个简单的 div 元素转换成一个交互式画布，你可以在其中显示、请求甚至编辑地理数据。地图是一个复杂的对象，因此我们将花费相当多的时间来关注它。让我们学习如何在我们的脚本中创建地图。

## 构造函数选项

当使用 ArcGIS JavaScript API 首次创建地图时，开发者有多个参数可以用来配置地图。我们在上一章创建我们的第一个地图应用程序时接触到了一些这些参数。让我们更详细地研究其中的一些。

### 自动调整大小

**自动调整大小**功能，默认情况下为开启状态，它告诉地图是否应该在浏览器大小或方向改变时自动调整其大小。如果你有一个全屏地图应用程序，并且你最大化或调整浏览器窗口大小时，地图将自动调整并填充分配给它的空间。地图将保持相同的缩放级别，但在调整浏览器窗口大小时，地图的边缘将更多或更少地可见。

### 提示

如果你的应用程序隐藏、移动或动画化你的地图在屏幕上或屏幕外的外观，自动调整大小功能可能会导致地图中出现一些奇怪的行为。例如，如果地图是从右侧滑入的，鼠标滚轮和一些缩放功能可能会缩放到地图的中心左点，而不是地图的中心。当地图动画在屏幕上或屏幕下时，最好将自动调整大小设置为关闭。

### 底图

**底图**是一个可选的字符串值，它提供了放置数据的背景图像。ESRI 根据您如何想要呈现数据提供各种背景图像。所有 ESRI 底图都是在 Web Mercator 投影（WKID 102100）中发布的瓦片图像。为了最佳性能，添加到 ESRI 底图之上的图层应使用相同的投影。否则，ArcGIS Server 将不得不重新投影动态地图服务，如果空间参考不匹配，瓦片地图服务可能不会显示。您可以在以下代码片段中看到前一章中突出显示的示例：

```py
var map = new Map("map", {
 basemap: "national-geographic",
  center: [-95, 45],
  zoom: 3
});
```

ESRI 提供的背景图像选项包括：

+   `street`：ESRI 街道地图

+   `satellite`：卫星/航空摄影

+   `hybrid`：街道地图和卫星的组合

+   `topo`：带有高程和等高线的地形图

+   `gray`：浅灰色/简约背景

+   `oceans`：海洋和海底背景

+   `national-geographic`：国家地理主题

+   `osm`：OpenStreetMap 主题

### 解释中心、范围、缩放和比例

**中心**、**范围**、**缩放**和**比例**参数可以用来覆盖其他地图图层设置并设置在地图上显示的区域。*中心*可以是包含中心点经度和纬度的两个数字数组，也可以是 ESRI 点。*范围*描述了地图坐标中应显示地图的哪些边缘：右、左、上或下。如果存在瓦片图层，*缩放*指示地图应显示的显示级别，从最远到最近。*比例*告诉地图有多少个测量单位与现实中一个单位相关（例如，比例值为 500 表示地图上的 1 英寸代表现实中的 500 英寸）。

### LODs

当地图加载图层时，**细节级别**（**LODs**）由地图中首先加载的瓦片图层定义。您可以在创建地图时通过传递包含级别（数字：0、1、2 等）、比例（数字：对于 1:500 的比例，您将使用 500）和相应分辨率（数字）的对象数组来覆盖这些 LODs。如果您想限制用户将地图缩放到视图之外的能力，或者如果您的一些瓦片数据具有比您的底图显示更精细的分辨率，这将很有帮助。

现在我们已经学会了如何调整地图对象的参数，让我们来看看它的不同部分。

## 属性

地图对象提供了一些属性，可以在映射应用程序中使用。其中一些是只读的，并告诉地图的状态。其他可以操作，并且更改可以显著影响地图。虽然属性有很多，但我们将查看其中的一些。

### loaded

在您创建地图对象后，直到地图至少有一个图层**加载**，您都不能对地图执行某些操作。当地图加载其第一个图层时，它将加载属性设置为 true。然后您可以操作地图，平移，搜索图层，并修改其行为。

常见的编程错误是在对地图进行操作之前，例如添加来自查询的搜索结果图形之前，没有测试地图是否已加载。如果你拥有极快的互联网连接，并且你的 ArcGIS 服务器就在你身边，地图可能在你添加图层后立即加载。但是，对于服务器室外的互联网用户来说，地图可能不会那么快加载。在继续之前最好检查加载属性，如下面的示例所示：

```py
if (map.loaded) {
  doSomethingwithMap(map);
} else {
  map.on("load", doSomethingwithMap);
}
```

### layerIds

地图对象保留了一个引用列表，指向添加到其中的图层。地图图层引用存储在一个名为 `layerIds` 的字符串数组中。列表中的第一个 `layerId` 指的是堆栈中最底层的图层，而列表中的最后一个字符串 `id` 指的是地图上可见的最顶层。如果你需要搜索列表中的特定图层，或者需要对所有加载到地图中的图层执行某些操作，这会很有用。

### spatialReference

地图的 `spatialReference` 属性指的是用于在平面上表示圆形地球的数学方程式的长列表。这个属性通常（但不总是）与地图以及包含在其中的图层和图形共享。我们将在 *几何空间参考* 部分深入研究空间参考。

## 方法

地图对象具有许多有用的方法，这些方法是绑定到地图对象的功能。这些方法可以帮助你向地图添加项目，移动，缩放，以及操纵地图行为。让我们看看其中的一些。

### 添加、删除和检索图层

根据需要可以向地图中添加和删除图层。如果你想一次添加一个地图图层，可以调用地图的 `addLayer()` 方法。要一次添加多个图层，你必须将这些图层放入一个数组中，并调用地图的 `addLayers()` 方法。可以使用 `removeLayer()` 方法删除地图图层。

检索图层就像调用地图的 `getLayer()` 方法一样简单。`getLayer()` 方法传递一个图层 id 字符串。有效的 id 列表可以在地图的 `layerIds` 数组中找到，或者在地图的 `GraphicsLayerId` 属性中。如果没有找到与 `getLayer()` 参数匹配的图层，该方法返回 null。

### 在地图上移动

地图包含用于导航地图的几个方法。有些影响地图上的位置，而有些影响用户缩放的程度。以下是用于操纵你在地图上位置的最常用方法的列表：

+   `setZoom()`: 这将设置地图的缩放级别，使地图进一步放大或缩小。

+   `setScale()`: 与 `setZoom()` 类似，但试图将地图的比例尺更改为传递的值。

+   `setLevel()`: 与 `setZoom()` 类似，但仅在具有瓦片服务的地图上工作。根据传递给函数的整数，地图将缩放到相应的缩放级别，如果地图有瓦片图层。

+   `setExtent()`：当传递一个边界框时，此消息将尝试将地图的边界设置为与边界框匹配。这会影响缩放级别和位置。

+   `centerAndZoom()`：接受一个中心点和缩放级别，然后将地图中心定位在该点上，并尝试缩放到该级别。这会影响位置和缩放级别。

+   `centerAt()`：当此函数接受一个点时，它尝试平移地图，使该点位于地图中心。

### 注意

请注意，对于 `setExtent()`、`centerAndZoom()` 和 `centerAt()` 方法，点和边界框需要与地图相同的坐标系。

### 更新设置

有许多地图导航操作可以通过地图方法启用或禁用。你可以控制用户点击、双击或 shift 双击地图时会发生什么。你可以启用或禁用使用鼠标进行平移，以及使用滚轮进行滚动。你甚至可以禁用或启用地图的导航事件。有时你可能想要禁用导航。例如，如果你的地图是通过点击链接进行导航的，你可能不希望用户在地图上走得太远。

记住，直到地图加载完成之前，这些设置都不能被修改。但如果地图尚未加载，我们该如何知道它何时加载呢？为了找到答案，我们将探讨大多数 JavaScript 库共有的一个特性——事件。

## 事件

在使用 JavaScript 的异步编程时，事件非常重要。地图对象在执行某些重要更改或完成某些任务之前、期间和之后会触发多个事件。这些事件可以通过地图的内置 `on()` 函数进行监听。让我们看看你将需要处理的一些更常见的事件：

+   `load`：在地图加载其第一层后触发的事件。

+   `click`：当用户点击地图时触发。在其它事件项中，它返回用户点击的点作为事件对象的 `mapPoint` 属性。

+   `extent-change`：当地图改变位置或缩放级别时触发。这两个因素都会影响地图范围的计算。

+   `layer-add`：当任何新的图层被添加到地图上时触发。

+   `layers-add-result`：在通过 `addLayers()` 方法加载多个图层后触发。

+   `mouse-over`：当鼠标移动到地图上时触发。

+   `update-start`：在加载图层之前触发此事件，无论是通过添加新图层，还是通过在地图上移动并触发地图下载更多地图数据。

+   `update-end`：在地图从其地图服务加载数据后触发此事件。

# 图层

没有数据来展示的地图是不完整的。数据通过图层添加到地图中。图层指的是包含地理、符号甚至表格数据的数据源。ArcGIS API for JavaScript 包含多个模块，用于解释不同类型的常见地理数据源。一些图层模块与 ArcGIS Server 提供的数据一起工作，而其他模块可以显示来自其他来源的数据，例如 KML、**Web 地图服务**（**WMS**）和 CSV 文件。

## 常见的 ArcGIS Server 层

ArcGIS Server 通过地图服务提供地图层数据。地图服务提供从 ArcMap 地图文档（`.mxd`）发布的数据。视觉地图数据、图例和底层数据表通过 ArcGIS Server 提供，并且当图层数据源被加载到地图中时，可以通过浏览器进行消费。不同的图层类型具有不同的功能。我们将在以下部分中回顾这些图层。

### ArcGISDynamicMapServiceLayer

`ArcGISDynamicMapServiceLayer`是通过 ArcGIS Server 发布的地图的默认类型。它是一个动态地图，这意味着其内容在地图刷新时更新。因为它具有动态性，数据也可以重新投影以适应不在同一空间参考系中的另一个地图层。

```py
require(["esri/map", "esri/layers/ArcGISDynamicMapServiceLayer"], 
  function (Map, ArcGISDynamicMapServiceLayer) {
  …
  var map = new Map("mapdiv", {…});
  var layer = new ArcGISDynamicMapServiceLayer ("http://serv.er/arcgis/rest/services/MyDynamicLayer/mapserver");
  map.addLayer(layer);
});
```

因为`ArcGISDynamicMapServiceLayer`中的数据是动态的，所以每当地图从不同的位置和缩放级别查看数据时，ArcGIS Server 都会重新绘制该层的外观。如果这个层包含大量的标签、注释、复杂的图形或栅格数据（例如航空影像），ArcGIS Server 将需要更多的系统资源来渲染地图层。这会导致性能明显变慢。对于那种类型的数据，建议使用其他服务，如瓦片地图服务。

### ArcGISTiledMapServiceLayer

ArcGIS Server 允许地图服务进行瓦片化。`ArcGISTiledMapServiceLayer`在其内容在地图服务发布时已经绘制成图像，这些图像以定义的缩放比例存储在硬盘上，以便快速检索。这些预先渲染的瓦片可以快速且无需服务器大量努力地提供服务。可以在同一台机器上运行更多的地图服务，而对性能的影响很小。以下代码片段提供了一个示例：

```py
require(["esri/map", "esri/layers/ArcGISTiledMapServiceLayer"], 
  function (Map, ArcGISTiledMapServiceLayer) {
  …
  var map = new Map("mapdiv", {…});
  var layer = new ArcGISTiledMapServiceLayer ("http://serv.er/arcgis/rest/services/MyTiledLayer/mapserver");
  map.addLayer(layer);
});
```

瓦片地图服务有一些缺点。首先，通过瓦片地图服务显示的数据在瓦片重建之前不会改变。如果数据中的公园边界发生变化，但瓦片没有重建，服务仍然会显示旧的边界。其次，瓦片地图服务将地图限制在特定的缩放比例上，没有简单的方法在缩放比例之间查看地图。第三，如果另一个瓦片地图堆叠在第一个瓦片之上，它不仅必须在相同的空间参考中，而且缩放比例必须在重叠的比例范围内完全重叠。这意味着使用 1:500 和 1:1000 比例构建的地图可以与使用 1:1000 和 1:2000 比例构建的地图一起加载，但比例 1:750、1:1500 和 1:3000 的瓦片层将不会被看到。

### 小贴士

您不能将动态地图服务层作为 `ArcGISTiledMapServiceLayer` 来加载，否则会抛出错误。然而，可以将瓦片地图服务层加载为 `ArcGISDynamicMapServiceLayer`。在缩放和平移时，您会失去性能，但它可以帮助您查看瓦片比例之间的比例。

我们已经看到了提供图像数据的 ArcGIS 层。让我们将注意力转向处理更多矢量数据的层。

## 图形层和特征层

有时候您不想与地图的代表性图像一起工作。有时候您想直接处理您数据的外形。这就是 `GraphicsLayers` 和 `FeatureLayers` 发挥作用的地方。这些层直接在您的浏览器中渲染矢量图形。您可以点击它们、修改它们，甚至可以通过它们将数据添加到 ArcGIS 服务中。让我们更仔细地看看它们。

### 图形层

`GraphicsLayers` 提供了一种简单的方法来将自定义矢量图形添加到您的地图中。您可以通过对那些图形调用 `add()` 和 `remove()` 方法来管理图形。您还可以通过搜索 `GraphicsLayer.graphics` 数组来搜索地图上的图形列表。

作为旁注，地图对象有一个内置的 `GraphicsLayer`。您可以通过 `map.graphics` 属性访问该 `GraphicsLayer`。

### 特征层

`FeatureLayers` 是基于 `GraphicsLayer` 构建的专用层，提供了更多的功能。它们具有 `GraphicsLayer` 的自定义矢量图形，并且还有一个 ArcGIS 服务器数据源来填充数据。您可以通过位置或属性查询数据，使用自定义图形将其添加到地图中，并控制弹出内容和外貌。您甚至可以在服务器上编辑数据。

与可以同时混合多个层的 ArcGIS Tiled 和动态层不同，每个 `FeatureLayer` 只能与一个地图服务层一起工作。`FeatureLayers` 可以与地图服务中的单个层一起工作，或者称为 **Feature Services** 的特殊可编辑地图服务。Feature Services 提供有关地图层的更多详细信息，包括查询结果的端点。如果 ArcGIS Server 配置为允许编辑特征，并且地图服务已发布以允许编辑，则使用这些服务的 `FeatureLayers` 将允许您修改形状和表格数据。

因为 `FeatureLayers` 从 ArcGIS Server 查询数据，它们返回的特征数量有限。通常，ArcGIS Server 会根据版本限制查询返回的结果数量为一千或两千。可以通过更改服务器设置来显示更多结果，但地图上更多的 `FeatureLayer` 图形意味着消耗更多的内存，应用程序可能会变慢且无响应。在使用 `FeatureLayer` 与您的数据时必须仔细考虑。

`FeatureLayer` 通过设置其模式来细化返回的特征数量。`FeatureLayer` 有三种主要的特征选择模式：

+   `MODE_ONDEMAND`：只有符合地图范围、时间范围和/或定义查询的特征才会被下载。这是与地图范围内可见特征交互的最常见方式。

+   `MODE_SELECTION`：只有通过交互地图（例如点击、触摸或查询）选定的特征才会被下载，并且它们的数据会在地图上显示。

+   `MODE_SNAPSHOT`：所有特征最初都会下载到内存中。这种方法适用于较小的数据集，并且需要较少的服务器调用。

+   `MODE_AUTO`：它会在 `MODE_ONDEMAND` 和 `MODE_SNAPSHOT` 之间自动选择，并且对于 ArcGIS API for JavaScript 来说是较新的功能，具体取决于数据的大小和内容。

当我们讨论编辑时，我们将在 第五章 *编辑地图数据* 中更详细地探讨 `FeatureLayers`。

## 其他图层类型

ArcGIS API for JavaScript 与通过 ArcGIS Server 发布的数据配合良好。但世界上并非所有地理数据都是通过 ArcGIS Server 发布的。API 有许多其他可以消费这些不同数据源的图层类型。以下是一些更常见的类型：

+   `KMLLayer`：使用 **Keyhole Markup Language** (**KML**) 编写的服务。KML 因 Google Earth 而闻名。该格式使用标记来存储和表示地理数据。许多服务发布 KML 数据，包括 **国家海洋和大气管理局** (**NOAA**)。

+   `CSVLayer`：这是一个相对较新的功能，它将逗号分隔的文本文件转换为地图上的点。为了在地图上显示数据，`CSVLayer` 预期一个纬度和经度列以显示十进制坐标。这个工具与 HTML5 的拖放 API 结合使用，可以使您将任何符合条件的数据映射到 `.csv` 文件中。

+   `WMSLayer` 和 `WMTSLayer`：使用 **Open Geospatial Consortium** （**OGC**）兼容标准发布的 Web 地图服务（**WMS**）和 Web 地图瓦片服务（**WMTS**）。

    ### 注意

    请注意，如果您仅使用 OGC Web 地图服务的 URL 加载图层，您需要使用代理（参见第一章，*您的第一个映射应用程序*）。这是因为模块首先在图层上请求 `GetCapabilities` 以从地图服务中获取元数据。此请求需要一个代理。然而，如果您使用带有可选 `resourceInfo` 参数的 `WMSLayer` 加载，它会自动为您描述服务，因此不需要代理。

+   `StreamLayer`：一个显示来自 ArcGIS GeoEvent Processor 扩展的实时流数据的图层。`StreamLayer` 利用 HTML5 WebSocket 的最新技术，从服务器向客户端提供实时更新。您可以看到对特定事件的 Twitter 响应，或带有跟踪设备的紧急响应车辆的实时位置。

### 注意

注意，大多数最新的现代浏览器支持 WebSocket 技术，但较旧的浏览器通常不支持。您可以通过访问 [`www.websocket.org/echo.html`](http://www.websocket.org/echo.html) 来查看您的浏览器是否支持 WebSocket。

# 图形

图形对象代表在 web 地图上绘制的单个点、线或多边形要素。图形对象有四个主要部分：其几何形状、符号、属性和 `infoTemplate`。它们在 API 的许多部分中使用。如果您在地图上绘制某个东西，您就创建了一个图形。如果您查询地图服务以获取某个东西，它将返回一个图形列表。一些模块甚至接受图形列表作为其他函数的参数。

图形对象可以使用最多四个可选参数来构建：

+   `geometry`：它描述了绘制在地图上的图形的形状

+   `symbol`：它描述了图形的颜色、粗细和影响图形外观的特征

+   `attribute`：一个包含与要素对应的表格数据的名称-值对的 JavaScript 对象

+   `infoTemplate`：它格式化地图的 `InfoWindow` 高亮显示图形属性时的外观

在接下来的几节中，我们将更详细地研究这些图形功能。

# 介绍几何对象

几何对象是一组坐标的集合，用于描述某物在世界中的位置。它们为我们寻找的数据赋予了形状。它们可以用于在地图上显示图形，或为查询提供空间数据，甚至用于地理处理服务。几何对象有五种基本类型：点、线、多边形、扩展范围和多点。任何形状都是基于这些基本类型构建的。让我们更深入地了解一下。

## 点

在 ArcGIS API for JavaScript 中，点是最简单的几何对象。它包含点的*x*和*y*坐标，以及点的空间参考。点可以用*x*和*y*坐标以及空间参考来构造。它也可以用经度和纬度来定义。

## 多段线

多段线几何体是由一个或多个点坐标数组组成的集合。每个点坐标数组被称为一条路径，当绘制出来时看起来像一条线。可以在同一几何体中存储多个路径，从而产生多条线的视觉效果。单个点坐标存储为*x*和*y*值的数组。

## 多边形

多边形由一个或多个点的数组组成，这些数组会自己闭合。每个点的数组被称为一个环，环中的第一个点和最后一个点必须具有相同的坐标。由多个环组成的多边形被称为多部分多边形。

在控制多边形形状的许多属性和方法中，有两个有用的方法：`.getCentroid()`和`.contains()`。`.getCentroid()`返回一个大致位于多边形中间的点。计算质心位置的公式可以在维基百科的质心页面找到：([`en.wikipedia.org/wiki/Centroid#Centroid_of_polygon`](http://en.wikipedia.org/wiki/Centroid#Centroid_of_polygon))。`.contains()`方法接受一个点作为输入，并根据该点是否在多边形内部返回一个`boolean`值。

## 扩展范围

扩展范围是一个矩形多边形，它只使用四个数字来描述其形状。扩展范围由其最小*x*值（`xmin`）、最大*x*值（`xmax`）、最小*y*值（`ymin`）和最大*y*值（`ymax`）描述。在地图上查看时，扩展范围通常看起来像一个框。

扩展范围被 API 的许多不同部分使用。除了点之外的所有其他几何对象都有一个`getExtent()`方法，用于收集几何体的边界框。你可以通过设置地图的扩展范围来放大地图上的特定位置。扩展范围也用于在地图上识别事物时定义感兴趣的区域。

## 多点

有时候你需要将一组点显示在地图上。为此，多点就是你的答案。你可以使用`addPoint()`和`removePoint()`方法添加和删除点。你也可以使用`getExtent()`方法获取点覆盖的一般区域。它们对于收集区域内的随机点以及在地图上选择未连接的特征非常有用。

## 几何空间参考

除了几何位置坐标外，几何对象还包含有关对象空间参考的信息。空间参考描述了用于描述映射区域内地球的数学模型。空间参考不是包含所有那些公式和常数，而是通过一个**已知 ID**（**WKID**）或一个**已知文本**（**WKT**）来存储对这些公式的引用。

空间参考在地图上显示数据时起着至关重要的作用。瓦片地图服务层必须与地图具有相同的空间参考才能显示。动态地图服务层必须重新投影，这会增加服务器的时间和负载。图形也需要与地图具有相同的空间参考才能在地图上的正确位置显示。

# 符号和渲染器

ArcGIS API 提供了一些基本的图形工具来定义地图上要素的外观。如果你正在创建自己的自定义图形或修改现有的图形，API 的这部分内容会告诉你如何定义它们的**符号**。API 还提供了自定义**渲染器**，这有助于你根据渲染器应用的规则定义使用的符号。

## 简单符号

ArcGIS API 使用符号来定义图形的颜色、厚度和其他视觉特征，而与其形状无关。实际上，如果没有分配符号，图形将不会显示。API 定义了三个简单的符号来突出显示点、线和多边形。让我们看看简单符号。

### SimpleLineSymbol

`SimpleLineSymbol` 定义了添加到地图上的线和折线图形的符号。从线符号开始可能看起来有些奇怪，但其他两个简单符号也使用了线符号。`SimpleLineSymbol` 的主要属性是其颜色、其宽度（以像素为单位）和其样式。样式包括实线、虚线、点线和这些的组合。

### SimpleMarkerSymbol

`SimpleMarkerSymbol` 定义了地图上点和多点图形的符号。符号可以生成不同的形状，这取决于设置的样式。虽然此符号默认为圆形，但 `SimpleMarkerSymbol` 可以生成正方形、菱形、交叉和十字。此符号内还可以操纵的其他属性包括像素大小、其轮廓作为 `SimpleLineSymbol`，以及其颜色。

### SimpleFillSymbol

`SimpeFillSymbols` 定义了地图上多边形图形的符号。`SimpleFillSymbol` 的样式反映了形状内部的显示方式。它可以填充（完全填充），为空（完全空），或者有水平、垂直、对角或交叉的线条。请注意，具有空样式符号的图形在中心不会响应用户点击。符号还可以通过 `SimpleLineSymbol` 轮廓进行修改，并且如果 `SimpleFillSymbol` 的样式是实心，其填充颜色也可以修改。

让我们进一步看看我们将用来定义这些符号的颜色。

## esri/Color

`esri/Color` 模块允许你自定义添加到地图中的图形的颜色。`esri/Color` 模块是 `dojo/_base/Color` 模块的扩展，并添加了一些独特的工具，以不同的方式混合、创建和计算颜色格式。库的旧版本使用 `dojo/_base/Color` 模块来设置颜色，并且在当前版本中仍然可用。

`esri/Color` 模块的构造函数可以接受各种值。你可以分配常见的颜色名称，如 "blue" 或 "red"。你可以使用十六进制字符串（例如 `#FF00FF` 表示紫色），就像你在 css 颜色中找到的那样。你还可以使用三个或四个数字数组创建颜色。数组中的前三个数字分配红色、绿色和蓝色值，范围从 0 到 255（[0, 0, 0] 是黑色，[255, 255, 255] 是白色）。数组中的第四个可选数字表示 alpha，或颜色的不透明度。这个范围内的值从 0.0 到 1.0，其中 1.0 是完全不透明，0.0 是完全透明。

`esri/Color` 模块在旧的 `dojo/_base/Color` 模块的基础上增加了一些有趣的增强功能。例如，你可以使用 `blendColors()` 方法混合两种现有的颜色。该方法接受两种颜色和一个介于 0.0 和 1.0 之间的十进制数，其中 0.5 是两种颜色的平均混合。这可能在投票地图上很有用，例如，绿色代表赞成，红色代表反对，投票区可以根据赞成或反对的百分比着色。

`esri/Color` 模块也有将颜色从一种格式转换为另一种格式的方法。例如，你可以点击一个要素，获取其图形颜色，并使用 `toHex()` 或 `toCss()` 获取颜色字符串。从那里，你可以将那种颜色应用到显示该图形属性的信息 `<div>` 的背景颜色上。

## 图片符号

如果图片对你来说比颜色更有吸引力，你可以在图形中使用图片符号。使用这些符号，你可以使用图片图标和自定义图形在你的图表上添加有趣且难忘的数据点。点和多边形可以使用图片符号进行符号化，分别使用 `esri/symbols/PictureMarkerSymbol` 和 `esri/symbols/PictureFillSymbol` 模块。

`PictureMarkerSymbol` 模块为地图上的点添加简单的图片图形。它通常使用三个参数构建，一个指向图像文件（如 `.jpg`、`.png` 或 `.gif`）的 URL，以及像素宽度和高度。

`PictureFillSymbol` 模块使用重复的图形填充多边形的内部内容。`PictureFillSymbol` 接受四个参数。第一个是一个指向图像文件的 URL 字符串。第二个输入是一个线符号，如 `esri/symbols/SimpleLineSymbol`。最后两个参数是图像的像素宽度和高度。

## 渲染器

有时候，你不想逐个分配图形符号。如果你知道你要添加的图形类型以及它们应该提前看起来如何，提前分配符号是有意义的。这就是渲染器发挥作用的地方。可以将渲染器分配给 `GraphicsLayers`，作为为其中所有图形分配共同样式的一种方式。渲染器依赖于一个图形层接受一种几何类型（例如，所有多边形）。

随着 ArcGIS API 的成熟，它已经向其库中添加了许多不同的渲染器。我们将探讨三个常见的：`SimpleRenderer`、`UniqueValueRenderer` 和 `ClassBreakRenderer`。每个都有其合适的用例。

### SimpleRenderer

`SimpleRenderer` 是渲染器中最简单的一种，因为它只分配一个符号。它接受一个默认符号，并假设你将只插入与该符号相同类型的图形。与其他渲染器一样，如果你将 `SimpleRenderer` 分配给 `GraphicsLayer`，你可以在不分配符号的情况下向 `GraphicsLayer` 添加图形对象。让我们看看一个代码片段，展示如何创建并应用 `SimpleRenderer` 到地图的图形层：

```py
require(["esri/map", "esri/renderers/SimpleRenderer",
  "esri/symbols/SimpleLineSymbol", "esri/Color", 
  "dojo/domReady!"],
function (Map, SimpleRenderer, LineSymbol, Color) {
  …
  Var map = new Map("map", {basemap: "OSM"});
  var symbol = new LineSymbol().setColor(new Color("#55aadd"));
  var renderer = new SimpleRenderer(symbol);
  …
  map.graphics.setRenderer(renderer);
});
```

自 API 的 3.7 版本以来，`SimpleRenderer` 已得到扩展。可以根据字段中预期值的一个范围以不同的方式修改符号。例如，你可以通过设置 `SimpleRenderer` 的 `colorInfo` 属性在两种颜色之间改变符号的颜色。你也可以通过设置其 `proportionSymbolInfo` 属性根据字段值改变点的大小。最后，你可以通过设置其 `rotationInfo` 属性根据字段值旋转符号。

### 唯一值渲染器

有时候，你希望根据图形的某个属性显示不同的符号。你可以使用唯一值渲染器来实现这一点。可以突出显示特定的唯一值，而列表外的值可以分配一个默认符号。

唯一值渲染器的构造函数接受一个默认符号，以及最多三个不同的字段来比较值。如果使用多个字段，则需要一个字段分隔符字符串。唯一值和相关的符号可以作为对象加载到渲染器的 info 参数中。该 info 对象需要以下内容：

+   唯一值（`value`）

+   与该值关联的符号（`symbol`）

+   符号标签（`label`）

+   唯一值的描述（`description`）

### 类别断点渲染器

有时候，你希望根据图形在特定值范围内的位置对它们进行分类，例如人口或**国内生产总值**（**GDP**）。类别断点渲染器可以帮助你以视觉方式组织图形。此渲染器查看图形中的特定字段值，并找出图形的字段值适合哪个类别断点范围。然后，它将该符号分配给该图形。

当构建类间隔渲染器时，您分配一个默认符号，以及将被评估以修改符号的字段。类间隔通过渲染器的信息属性分配。信息数组接受一个包含以下内容的 JavaScript 对象：

+   类间隔的最小值（`minValue`）

+   类间隔的最大值（`maxValue`）

+   符号（`symbol`）

+   描述间隔的标签（`label`）

+   类间隔的描述（`description`）

# InfoTemplates

`InfoTemplates`，正如我们在第一章*您的第一个映射应用程序*中提到的，描述了您希望在弹出窗口中显示数据的方式。`InfoTemplate`可以使用两个字符串构建，即标题和内容。标题和内容字符串代表 HTML 模板，您可以在模板中替换图形属性。对于图形的`infoTemplate`，如果您想显示图形的总属性，您可以在模板中插入值，使用`${total}`，这显示了插入到替换字符串`${}`括号内的字段名。

如果您想在弹出窗口中显示包含图形属性中所有名称/值对的弹出窗口，您可以在内容值中使用通配符`${*}`，如下所示：

```py
graphic.infoTemplate = new InfoTemplate("Attributes", "${*}");
```

对于内容，您可以在字符串中添加 HTML 内容，包括表格、列表、图像和链接。例如，您可能使用以下内容来描述海洋栖息地：

```py
graphic.infoTemplate = new InfoTemplate("Marine Habitat 
  (${name})", "<table><tbody><tr><th>Type: 
  </th><td>${type}</td></tr><tr><th>Ocean 
  zone:</th><td>${zone}</td></tr><tr><td colspan='2'><img 
  src='${imageSrc}' alt='${name}' /></td></tr></tbody></table>");
```

在前面的示例中，我们将图形的名称属性添加到标题中，并创建了一个两列的表格，显示图形的类型、图形所在的区域以及与地图图形连接的两列宽图像。

# 工具栏

ArcGIS API for JavaScript 使用工具栏来处理转换光标的控件。API 有三个不同的工具栏：一个用于地图导航，一个用于绘制图形，一个用于编辑这些图形。这些工具可以通过`activate()`方法打开，该方法包括描述您想要使用哪个工具的参数。可以使用`deactivate()`方法关闭工具；让我们更详细地看看这些工具。

## 导航工具栏

导航工具栏处理高级地图导航。默认情况下，地图提供缩放滑块和在地图上平移的能力。通过激活导航工具栏的缩放/缩小功能，用户可以绘制一个框定的范围，地图将在此范围内放大或缩小，与缩放框相对于地图当前范围的缩放比例相同。一旦激活，此缩放/缩小框始终存在，因此您必须开发某种关闭它的方法，或者让用户激活平移工具，这将禁用缩放/缩小。

导航控件还有三个可以激活的操作。当从导航工具栏调用`zoomToFullExtent()`函数时，会触发地图缩放到其原始地图范围。工具栏还记录了用户进行了多少次缩放、缩放和平移操作。通过激活`zoomToPreviousExtent()`函数，地图范围会回到之前的范围。如果地图回到之前的范围，地图也可以缩放到未来的位置。使用`zoomToNextExtent()`函数，用户可以撤销他们在查看之前范围时所做的缩放范围更改。

## 绘图工具栏

绘图工具栏允许用户在地图上绘制以提供输入。根据激活了哪个绘图工具，用户可以在地图上绘制一个形状，并且任何附加到`draw-end`事件的监听器都会被调用，运行一个接收用户绘制的形状的函数。如果需要，可以给事件监听器附加多个`draw-end`事件。常见的`draw-end`事件可能包括将绘图添加到地图、测量工具栏绘制的形状，或使用绘制的形状进行查询。这些工具还会修改地图的工具提示，提供有关如何使用它们的说明。

ArcGIS API 提供了在地图上绘制时使用的多种形状。可以通过简单的绘图工具常量（如点、折线和多边形）激活工具栏，这些常量通过在地图上点击每个点并双击来完成激活。折线和多边形有手绘版本，允许你点击并拖动鼠标来绘制连续的线条或形状，并释放鼠标以停止绘制。API 还包括用于绘制常见形状（如三角形、矩形、圆形、椭圆形和箭头）的绘图工具，仅举几例。

### 小贴士

不同的工具栏之间互不感知。如果你不小心，你可能会同时激活绘图和导航工具，并且它们的行为会同时发生。你可能会为工具绘制一个形状，并因为导航工具没有被要求停用而放大到该区域。提前计划好如何在启用另一个事件时禁用其中一个事件。

## 编辑工具栏

当你在地图上绘制某物并犯了一个错误时会发生什么？你如何纠正地图上的图形？编辑工具栏允许你更改地图图形的形状、大小和方向。它还适用于文本符号，允许你更改地图上文本图形的文本。

当在某个功能上激活编辑工具栏时，它允许你移动、旋转、缩放或更改该功能的顶点。移动功能让你可以抓取功能并将其放置到你想要的位置。旋转功能提供了一个点击并拖动以重新定位图形的点。缩放功能允许用户使图形变大或变小。对于编辑顶点，用户可以在地图上拖动点，右键点击“删除”点，并在“幽灵点”之间点击以在地图上添加新的顶点。

请注意，虽然编辑工具栏允许用户更改地图上的图形，但它没有内置的功能让用户保存他们的更改。当在可编辑要素层上的图形上使用编辑工具栏时，你仍然需要一种方法来告诉要素层保存更改。图形可以在当前会话中编辑，而无需保存更改。

# 任务

正如我在上一章中提到的，某些应用程序项目需要资源密集型的过程，这些过程最好留给服务器处理。ArcGIS API 将这些操作称为任务。任务种类繁多。一些任务需要服务器进行计算和/或返回数据，例如几何服务和`QueryTask`。其他任务使用服务器生成自定义文档，如打印任务。还有一些任务不仅执行上述所有操作，还需要自定义扩展，这些扩展最初并非 ArcGIS Server 的一部分。让我们看看什么才是一个好的任务。

## 任务、参数和结果

正如我们在上一章中讨论的，一个任务由三个部分组成：任务构造函数、任务参数和任务结果。通常，只需要使用 AMD 加载任务构造函数和任务参数。当结果从服务器返回时，任务结果会自动生成。结果格式在 API 文档中显示，以向您展示在成功接收结果时如何访问所需的内容。与任务相关的常见事件顺序如下：

1.  构建任务和任务参数。

1.  任务参数被填充所需的信息

1.  该任务通过任务参数执行服务器调用。

1.  当浏览器收到来自服务器的结果时，结果将通过`回调`函数或延迟值进行处理。

值得注意的是，当任务执行时，它们返回一个 Dojo 的**Deferred**对象。这些延迟结果可以被传递到另一个函数，以便在浏览器收到结果时异步运行。

## 常见任务

在任何 ArcGIS Server 安装中，都提供了许多常见的任务。许多任务依赖于已发布的地图服务或地理处理服务来执行。一些，如`GeometryService`，是 ArcGIS Server 内置的。让我们看看通过 API 可用的常见任务。

### 几何服务

`GeometryService`提供了多种操作几何数据的函数。通常，它作为 ArcGIS Server 的一部分发布。让我们看看可用的几何服务函数。

+   `面积和长度`: 查找多边形几何形状的面积和周长

+   `自动完成`: 通过填充它们之间的间隙来帮助创建与其他多边形相邻的多边形

+   `缓冲区`: 创建一个多边形，其边与源几何形状的距离或距离集

+   `凸包`: 创建包含所有输入几何形状所需的最小多边形形状

+   `裁剪`: 沿着辅助多段线将多段线或多边形分割

+   `差集`: 从一系列几何形状中减去与次要几何形状（可能是一个多边形）重叠的部分

+   `距离`: 查找几何形状之间的距离

+   `简化`: 绘制一个看起来相似但点数更少的形状

+   `相交`: 给定一系列几何形状和另一个几何形状，返回由第一个列表与第二个列表相交定义的几何形状

+   `标注点`: 在多边形内找到一个最佳位置放置标签的点

+   `长度`: 对于线和折线，找到从起点到终点的平面或大地距离

+   `偏移`: 给定一个几何形状和距离，如果距离为正，将在原始几何形状的右侧创建一个定义距离的几何形状，如果距离为负，则在几何形状的左侧创建

+   `项目`: 基于几何形状和新的空间参考，它返回在新空间参考中的原始几何形状

+   `关系`: 基于两组几何形状和指定的关系参数，返回一个配对列表，显示两个列表中的项目是如何相关的（例如：list2 中有多少在 list1 内）

+   `重塑`: 给定一条线或一个多边形，以及一个次要线，它根据第二个几何形状改变第一个几何形状的形状，向原始图形添加或丢弃一些部分

+   `简化`: 给定一个复杂的、边交叉的多边形或线，它返回更简单的多边形，其中交叉部分被取消

+   `TrimExtend`: 给定一系列折线和一个用于修剪或扩展的折线，它切割列表中与第二个折线交叉的线，并在未达到次要折线的其他折线上进行扩展

+   `并集`: 给定一系列多边形，创建一个统一的几何形状，其中所有多边形在重叠的边缘上被溶解，形成一个单一的多边形

### 查询任务

`QueryTask` 提供了一种从地图服务中的要素收集形状和属性数据的方法。您可以从地图服务的单个图层请求数据，通过几何形状定义您的搜索区域，并通过属性查询限制您的结果。`QueryTask` 是通过指向地图服务中单个图层的 URL 参数构建的。从成功查询返回的结果数量受 ArcGIS Server 限制，通常为 1,000 或 2,000 个结果。

由于 `QueryTask` 的结果可能受 ArcGIS Server 限制，`QueryTask` 对象已扩展了多个方法来收集其搜索结果上的数据。以下是 `QueryTask` 可通过的一些方法：

+   `execute()`: 接受 `QueryTask` 参数，并根据这些参数请求要素。

+   `executeForCount()`: 接受相同的参数，并返回与查询匹配的地图服务图层中的结果数量。

+   `executeForExtent()`: 根据传入的参数，返回包含所有搜索结果的地理范围。请注意，这仅在托管要素服务上[www.arcgis.com](http://www.arcgis.com)有效。

+   `executeForIds()`: 通过传入的参数，结果返回匹配搜索条件的要素的 `ObjectIds` 列表。与执行命令不同，在执行命令中结果数量受 ArcGIS Server 限制，而 `executeForIds()` 方法返回所有匹配搜索条件的 `ObjectIds`。这意味着，如果有 30,000 个匹配搜索结果，此方法将返回 30,000 个 `ObjectIds`，而不是服务器的 1,000 个限制。

可以使用 `Query` 模块（`esri/tasks/query`）创建 `QueryTask` 参数。如果你有 SQL 经验，你会看到 `Query` 参数与 SQL `Select` 语句之间的相似之处，同时也有一些 `Query` 参数更具体于 ArcGIS Server。以下是一些常见的参数：

+   `where` (字符串): 查询的合法 `where` 子句。

+   `geometry` (esri/geometry): 一个用于空间选择的形状。

+   `returnGeometry` (布尔值): 是否想要搜索结果要素的几何形状。将此设置为 `false` 仅返回属性数据。

+   `outFields` (字符串数组): 要检索搜索结果的字段列表。将 ["`*`"] 分配给 `outFields` 参数将返回所有字段，这相当于 SQL 语句 `SELECT * from`。

+   `outSpatialReference` (`esri/SpatialReference`): 你想要几何形状绘制的空间参考。通常，地图的空间参考被分配给此值。

+   `orderByFields` (字符串数组): 按照字段值排序结果的列表。如果想要返回降序排列的值，请在字符串中添加 `DESC`。

搜索结果以 `FeatureSet` 形式从 `QueryTask` 返回（`esri/tasks/FeatureSet`）。`FeatureSet` 包含关于返回结果的数据，包括结果的几何类型、空间参考、结果字段别名以及匹配搜索结果的要素图形列表。`featureSet` 甚至返回匹配查询的结果数量是否超过了 ArcGIS Server 能够提供的数据量。`featureSet` 中特征属性的特征数组可以符号化并直接添加到地图的图形层中以便查看和点击。

### IdentifyTask

`IdentifyTask` 提供了一种快速从地图服务中检索数据以用于弹出窗口的方法。与仅查询地图服务中一个层的 `QueryTask` 不同，`IdentifyTask` 可以搜索地图服务中的所有层。虽然 `QueryTask` 有许多方法可以检索搜索数据，但 `IdentifyTask` 更为简化，只有一个 `execute()` 命令来检索服务器结果。

传递给 `IdentifyTask` 的参数被称为 `IdentifyParameters`。因为 `IdentifyTasks` 可以搜索多层，所以 `IdentifyParameters` 专注于通过几何形状进行搜索。要使用 `where` 子句进行搜索，还必须在参数中添加一个 `layerDefinition` 参数。

`IdentifyTask` 的结果，称为 `IdentifyResults`，与 `FeatureSet` 有所不同。首先，`IdentifyResults` 以包含结果图形的特征参数的对象数组的形式返回，而 `FeatureSet` 是一个包含其特征参数中图形数组的单个对象。其次，`IdentifyResults` 不像 `FeatureSet` 那样包含字段名称和别名列表，因为 `IdentifyResult` 的特征属性是名称/值对，其中名称键是别名。最后，`IdentifyResults` 返回它们检索到的层的 ID 和名称。这些属性使得 `IdentifyTask` 适合快速在点击地图时填充地图的弹出窗口。

### FindTask

ArcGIS API 提供了另一个在地图上查找特征的工具，称为 `FindTask`。`FindTask` 接受一个文本字符串，并在包含该值的地图服务中搜索特征。在数据库方面，`FindTask` 会遍历地图服务中的每一层，在允许搜索的字段中搜索带有前后通配符的文本字符串。如果搜索字符串 "Doe"，则 `FindTask` 会返回具有 "John *Doe*"、"*Doe* Trail" 或 "`Fiddledee` *doe* Studios" 名称值的特征，但不会返回包含 "Do exit" 的特征，因为有空格。

### 定位器

定位器提供基于街道地址数据的地址的近似位置，称为 **地理编码**。定位器还可以执行 **反向地理编码**，根据相同的街道数据为地图上的点提供近似地址。ESRI 在国家和世界范围内提供地理编码服务，但如果你有更准确的街道信息，你可以在 ArcGIS Server 上发布自己的地理编码服务。

对于地址定位，定位器接受一个包含单行输入或包含街道、城市、州和区域（邮编）参数的对象。接受 `Locator.execute()` 结果的 `callback` 函数应接受一个名为 `AddressCandidates` 的对象列表。这些 `AddressCandidates` 包括可能匹配的街道地址、地址的点位置以及从 0 到 100 的分数，其中 100 是完美匹配。如果没有返回结果，则表示提供的地址没有匹配项。

## 需要服务器扩展的任务

虽然 ArcGIS Server 包含了很多功能，但 ESRI 还提供了服务器扩展，或可选软件，这些软件通过 ArcGIS Server 执行特定任务。这些软件可以执行许多独特任务，从提供驾驶方向到筛选你所在地区的推文。在尝试使用它们之前，你需要知道你的服务器是否有一个或多个这些扩展。我们将查看其中之一，即路由任务。

### 路由

路由任务可以提供驾驶方向，计算最有效的路线，并绕过已知的道路障碍。路由任务需要 ArcGIS Server 的网络分析师扩展。对于路由参数，你可以在停止参数中添加一个`FeatureSet`，并用定义各种必须停车点的图形填充它。你也可以以同样的方式提供障碍物，这些障碍物会阻断某些道路。当路由任务执行时，它根据提供给服务器的街道数据返回最佳路线。

# 数字

ArcGIS API for JavaScript 还提供了 Dojo 小部件，通常称为**小部件**。许多这些小部件提供**用户界面**（**UI**），其中现有的 API 模块在后台工作。使用这些小部件可以通过提供广泛使用和测试过的 UI 组件来缩短开发时间。小部件文档还显示了用于样式化小部件的 CSS 类，以便开发人员和设计师可以根据页面主题重新设计它们。让我们看看更常用的几个小部件。

## 测量

测量数字小部件提供了一个工具，可以用来测量地图上位置的距离、面积和周长。它还可以获取地图上点的经纬度。该小部件使用绘图工具栏在地图上绘制形状。从那里，它向`GeometryService`发送请求。一旦小部件检索到其结果，它要么显示一个点的经纬度，显示在地图上绘制的线的长度，要么显示在地图上绘制的多边形区域的面积和周长。

## 打印

打印小部件提供了一个下拉控制，允许用户从预定义的打印模板和参数列表中选择。开发者通过将小部件配置为链接到 ArcGIS Server 打印服务以及预定义的打印参数列表来配置小部件。当用户从下拉选项中选择时，打印小部件中内置的`printTask`会触发一个带有相应打印参数的`execute()`方法。当`printTask`从服务器收到成功响应时，小部件提供了一个可以点击的链接来下载打印输出。

如果你需要更多细粒度的打印控制，这个数字小部件不适合你。这个工具不是为了处理所有打印参数的组合。如果你需要支持从 Tabloid ANSI B Landscape `.pdf`文档到 Letter ANSI A Portrait `.gif`图像，以及所有介于两者之间的内容，你应该考虑开发自己的工具。

## 书签

Bookmarks dijit 允许用户在地图上保存自定义区域。您可以在配置文件中预先分配书签区域，用户可以点击并缩放到这些区域。他们还可以将区域添加到列表中，编辑名称，并删除他们想要缩放到地图上的自定义区域。Bookmarks dijit 不会保存地图状态，这意味着之前开启的图层不会自动切换，地图上选定的图形可能不存在。

## 底图

ArcGIS API 提供了一些 dijit 用于更改您的底图。当数据与当前背景混合或看起来不正确时，这可能很有用。API 提供的第一个工具是 `BasemapToggle`，它允许您在两个底图之间切换。第二个是 `BasemapGallery`，它提供了更多选择。两者都提供了缩略图照片和描述底图的标题。

`BasemapGallery` 可以自定义以显示您自己的底图，或显示来自 ArcGIS Online 的底图。当构建 `BasemapGallery` 时，可以通过将 `showArcGISBasemaps` 选项设置为 true 来修改是否包含 ArcGIS Online 底图的选择。然而，请记住关于瓦片地图服务的规则。ArcGIS Online 底图位于 Web Mercator 辅助球面（WKID 102100），这与 Google 和 Bing 地图的投影相同。如果您的数据不在相同的投影中，您可能会遇到精度和/或缺失瓦片层的问题。

## 弹出窗口和 InfoWindows

弹出窗口和 `InfoWindows` 提供了一个小窗口来查看地图上特征的数据。有四种 `infoWindows` 的变体可用：在版本 3.4 中被取代的旧版本，一个较小的旧 `infoWindow` 版本称为 `InfoWindowLite`，当前默认的弹出控制，以及当前弹出窗口的轻量级移动版本。

当前弹出窗口暴露了您可以对其进行操作以自定义用户体验的多个元素。弹出窗口可以选择多个特征，并保留所选项目的图形内容在一个特征数组中。它还有一个分页控件，允许用户点击查看其他已选特征。它还通过 `selectedIndex` 参数跟踪哪个特征被选中。

## 编辑

编辑 dijit 提供了 UI 组件和工具，您可以使用它们来编辑地图上的特征。这些工具与可编辑的 `FeatureLayers` 一起工作，允许用户编辑形状、在地图上添加特征、更改属性，并将所有这些更改保存到服务器。让我们看看构成编辑工具的一些组件。

### 属性检查器

`AttributeInspector` 允许用户从 HTML 表单中编辑图形属性数据。检查器连接到 `FeatureLayer` 并显示所选特征之一的数据。检查器还提供了一个上一页和下一页按钮，用于搜索所选特征。`AttributeInspector` 还提供了一个删除按钮，用于删除所选特征。

检查器随后根据特征的必要条件构建一个表单。日期将会有日历，而域绑定字段将显示一个带有域选择下拉列表的 HTML 选择元素。用户可以输入和编辑数据，并且数据可以在服务器端保存。

### 模板选择器

`TemplatePicker` 提供了一个选择器，用于选择你将编辑的特征类型和子类型。当一个 `featureLayer` 作为可编辑的发布时，它必须通过 REST 服务公开符号和预设样式。然后 `TemplatePicker` 读取公开的符号和特征设置数据，以创建一个有效的可编辑选择网格。用户点击模板就像点击按钮一样，符号传递给某种类型的绘图工具。

### 一站式编辑器

ArcGIS API 提供了一个一站式 **编辑器** dijit，以满足一些基本的编辑需求。该 dijit 集成了 `TemplatePicker` 以选择要绘制的特征类型和子类型。它还包含一个工具栏，包含各种工具，与地图上可编辑的特征相关。因此，当你选择一条绿色线时，工具将显示与线相关的绘图工具。

编辑器还在 `map.infoWindow` 中生成一个 `AttributeInspector`。你可以从弹出窗口中编辑字段值。如何实现保存更改取决于你。

编辑器还在工具栏中提供了撤销和重做按钮。如果你不小心删除了你想要保存的特征，你可以使用撤销按钮。如果你意识到你确实想要删除那个特征，你可以点击重做按钮。

现在你已经接触到了 ArcGIS API for JavaScript 的主要功能，你更有准备去使用这个 API 编写更多的代码。

# 摘要

在本章中，我们快速浏览了 ArcGIS API for JavaScript。我们熟悉了网站和 API 的组织结构。我们详细研究了地图对象，查看其所有部分。我们回顾了 API 的其他部分，包括图层、图形、工具栏、任务和 dijits。我们讨论了它们的实现方式以及一些用例。现在我们更了解 API 的各个部分，我们可以在下一章中使用这些组件来创建自定义应用程序和小部件。
