# 前言

人类一直在追寻预测未来的能力。从最早的文明开始，人们就尝试预测未来。萨满、神谕者和预言家们使用从占星术、手相学到数字学等各种方法，来满足人类对未来的探索需求。在过去的一个世纪里，随着信息技术的发展，预测未来的重担落到了数据分析师和数据科学家的肩上。那么，我们如何预测未来呢？不再是通过查看手上的线条或星星的位置，而是通过分析过去生成的数据。我们不再依赖预言，而是依靠预测。

时间，作为我们世界中的第四维，使得所有在世界上生成的数据都成为时间序列数据。所有在现实世界中生成的数据都与时间相关。无论时间因素是否与问题相关，是另外一个问题。然而，为了更加具体和直观，我们可以在许多行业中找到时间序列预测的应用场景，如零售、能源、医疗和金融。我们可能想知道某个特定产品将要运送到某个特定商店的数量，或者我们可能想知道需要生产多少电力才能满足需求。

在本书中，通过使用真实世界的数据集，你将学习如何使用`pandas`和`plotly`处理和可视化时间序列数据，如何使用`darts`生成基准预测，如何使用机器学习和深度学习进行预测，使用流行的 Python 库，如`scikit-learn`和`PyTorch`。本书最后几章介绍了一些很少触及的方面，如多步预测、预测指标和时间序列的交叉验证。

本书将帮助你掌握并应用现代机器学习和深度学习的概念，构建可以扩展到数百万个时间序列的真实世界时间序列预测系统。

# 本书适用对象

本书非常适合数据科学家、数据分析师、机器学习工程师和 Python 开发者，他们希望构建行业级的时间序列模型。由于本书从基础讲解大多数概念，掌握基本的 Python 技能即可。如果你有机器学习或预测方面的先验知识，将有助于加快学习进度。对于经验丰富的机器学习和预测领域从业者，本书在高级技术和最新时间序列预测研究前沿方面也有很多值得学习的内容。

# 本书内容概述

**第一部分——熟悉时间序列**

*第一章*，*时间序列简介*，完全是为你介绍时间序列的世界。我们给出时间序列的定义，并讨论它与**数据生成过程**（**DGP**）的关系。我们还将讨论预测的局限性，以及我们无法预测的内容，然后通过阐述一些术语，为你理解本书的其余部分做准备。

*第二章*，*获取与处理时间序列数据*，讲解了如何处理时间序列数据。你将了解不同形式的时间序列数据如何在表格中表示。你将学习`pandas`中的各种日期时间相关功能，并学习如何使用适合时间序列的技术填补缺失数据。最后，通过一个真实世界的数据集，你将跟随一步步学习如何使用`pandas`处理时间序列数据。

*第三章*，*分析与可视化时间序列数据*，进一步加深你对时间序列的理解，通过学习如何可视化和分析时间序列。你将了解时间序列数据中常用的不同可视化方法，接着通过分解时间序列成其组成部分，进一步深入理解。最后，你还将学习识别和处理时间序列数据中的异常值的方法。

*第四章*，*设定强基线预测*，直接进入时间序列预测的主题，我们使用经济计量学中经过验证的方法，如*ARIMA*和*指数平滑法*，来生成强基线。这些高效的预测方法将提供强有力的基线，帮助我们超越这些经典技术，学习现代技术，如机器学习。你还将了解另一个关键主题——使用*谱熵*和*变异系数*等技术评估预测能力。

**第二部分——时间序列的机器学习**

*第五章*，*将时间序列预测视为回归问题*，开启了我们使用机器学习进行预测的旅程。简短的机器学习介绍为接下来的章节奠定了基础。你还将从概念上理解如何将时间序列问题转化为回归问题，以便我们能应用机器学习来解决它。最后，我们会暗示全球预测模型的可能性。

*第六章*，*时间序列预测中的特征工程*，转向一个更具实践性的课程。通过使用一个真实世界的数据集，你将学习不同的特征工程技术，如*滞后特征*、*滚动特征*和*傅里叶项*，这些技术帮助我们将时间序列问题表述为回归问题。

*第七章*，*时间序列预测的目标变换*，继续探索不同的目标变换技术，以适应时间序列中的非平稳性。你将学习如*增广的 Dickey-Fuller 检验*和*Mann-Kendall 检验*等技术，以识别和处理非平稳性。

*第八章*，*使用机器学习模型进行时间序列预测*，从上一章结束的地方继续，开始在我们一直使用的数据集上训练机器学习模型。利用书中提供的标准代码框架，你将训练如*线性回归*、*随机森林*和*梯度提升决策树*等模型。

*第九章*，*集成与堆叠*，回顾并探索如何利用多个预测结果，并将其结合起来产生更好的预测。你将探索一些流行的技术，如*最优拟合*、不同版本的*爬山算法*、*模拟退火*和*堆叠*，将我们生成的不同预测结合起来，从而得到更优的结果。

*第十章*，*全球预测模型*，结束了你在机器学习预测中启蒙的旅程，进入了一个令人兴奋的新范式——全球预测模型。在这一章中，你将学习如何使用全球预测模型和行业验证的技术来提高其性能，最终让你能够为成千上万的时间序列开发可扩展且高效的机器学习预测系统。

**第三部分——时间序列的深度学习**

*第十一章*，*深度学习导论*，我们切换话题，开始讲解一种特定类型的机器学习——深度学习。在本章中，我们通过探讨*表示学习*、*线性变换*、*激活函数*和*梯度下降*等不同主题，为深度学习奠定基础。

*第十二章*，*时间序列深度学习的构建模块*，继续深入深度学习，并使其具体化为时间序列相关内容。考虑到深度学习系统的组合性，你将学习如何利用不同的构建模块来构建深度学习架构。本章首先建立了*编码器-解码器架构*，然后讲解了不同的模块，如*前馈网络*、*循环神经网络*和*卷积神经网络*。

*第十三章*，*时间序列常见建模模式*，通过展示一些具体且常见的模式，增强了上一章中你所见的编码器-解码器架构，帮助你将构建模块组合在一起生成预测。这是一个实践性较强的章节，你将使用基于深度学习的*表格回归*和不同的*序列到序列模型*来生成预测。

*第十四章*，*用于时间序列的注意力机制与 Transformer*，讨论了利用注意力机制来改进深度学习模型这一当代话题。本章首先介绍了一个通用的注意力模型，在此模型下你将学习不同类型的注意力机制，如*scaled dot product*和*additive*。你还将调整前一章中的序列到序列模型，加入注意力机制，并训练这些模型以生成预测。随后，本章讲解了*transformer*模型，这是一种完全依赖于注意力机制的深度学习架构，然后你将使用该模型生成预测。

*第十五章*，*全球深度学习预测模型的策略*，探讨了基于深度学习的预测的另一个重要方面。尽管本书早些时候讨论了全球预测模型，但在深度学习模型中的实现有所不同。在本章中，你将学习如何实现全球深度学习模型，并掌握使这些模型更优秀的技术。你还将看到它们在实践部分的应用，我们将使用一直在操作的真实世界数据集来生成预测。

*第十六章*，*用于预测的专业化深度学习架构*，通过介绍几种流行的、专门用于时间序列预测的深度学习架构，结束了你对基于深度学习的时间序列预测的学习旅程。利用你在前几章中学到的概念和构建模块，本章将带你走向研究的前沿，展示一些时间序列预测中的领先前沿模型，如*N-BEATS*、*N-HiTS*、*Informer*、*Autoformer*和*Temporal Fusion Transformer*。除了理解它们，你还将学习如何使用这些模型通过真实世界的数据集生成预测。

*第十七章*，*概率预测与更多*，带你进入概率预测的领域，介绍了如一致性预测、蒙特卡洛丢弃、分位函数和概率密度函数等技术，并使你能够使用流行的开源框架来实践这些技术。本章还讲解了时间序列预测中的少有人涉足的领域，如间歇性预测、可解释性、冷启动预测和层次预测，并以高层次的方式为你深入这些主题提供了一个起点。

**第四部分——预测的机制**

*第十八章*，*多步预测*，讨论了一个很少被提及但极为相关的主题——多步预测。你将学习如何为多个时间步预测未来的不同策略，如*递归*、*直接*、*DirRec*、*RecJoint*和*Rectify*。本书还讨论了每种策略的优缺点，并帮助你为自己的问题选择合适的策略。

*第十九章*，*评估预测误差——预测度量概述*，涉及另一个很少被讨论但充满争议的话题，各方观点不一。你将学习不同衡量预测准确性的方法，并通过实验揭示不同度量指标的优势和劣势。本章最后提出一些指导方针，帮助你选择适合解决问题的正确度量标准。

*第二十章*，*评估预测*——*验证策略*，通过讨论可以用于时间序列的不同验证策略来结束预测的评估和本书。你将学习不同的验证策略，如留出法、交叉验证及其变体。本章还涉及在设计全局设置的验证策略时需要考虑的方面。在本章的结尾，你将看到选择验证策略的几条指导方针以及回答类似“我们可以在时间序列中使用交叉验证吗？”的问题。

# 要从这本书中获得最大收益

这本书必须与 GitHub 上的笔记本和相关代码库捆绑使用，当两者结合使用时效果最佳。你可以通过这本书进行三个层次的学习。第一个层次仅通过书中的文本就能进行，它将带你通过理论，建立直觉，并通过基本代码快速实现某些内容。为了巩固学习，我们建议你迈出下一步，使用提供的笔记本并与其进行实验。在大多数笔记本中，我们展示了如何以特定方式完成某事。但是有许多可调节的杠杆，比如超参数，你可以调整并运行，以了解输出随这些变化而变化的方式。这种学习层次将使你理解代码，并对书中学到的概念有更深入的理解。

最后，我们将一些代码抽象到存储库的 `src` 文件夹中，这些代码在笔记本中使用。你的最后一个学习层次是仔细阅读和理解这些代码，这样你就会知道它是如何在幕后工作的。大多数代码都有很好的注释，因此你更容易理解你在笔记本中使用的函数和类的内部工作原理。这将使你的学习提升到一个水平，你可以自信地将这些技术应用到像老板一样的其他用例中。

你应该具备基本的 Python 编程知识，因为我们在实际操作部分使用的所有代码都是 Python 编写的。对 Python 中的主要库（如`pandas`和`scikit-learn`）有所了解并不是必须的（因为本书会覆盖一些基础知识），但会帮助你更快地完成本书。对`PyTorch`的了解也不是必需的，但会加速你的学习。本书的任何软件需求都不应该成为障碍，因为在当今的互联网时代，唯一挡在你和知识世界之间的就是你最喜欢的搜索引擎的搜索框。

## 设置环境

为本书设置一个环境（最好是单独的环境）是强烈推荐的。我们建议的两种主要创建环境的方法是：Anaconda/Mamba 或 Python 虚拟环境。

### 使用 Anaconda/Miniconda/Mamba

设置环境的最简单方法是使用`Anaconda`，它是一个用于科学计算的 Python 发行版。如果你不想安装 Anaconda 附带的预装包，你也可以使用`Miniconda`，它是一个最小化的 Conda 安装器。你还可以使用`Mamba`，它是`conda`包管理器在 C++ 中的重新实现。`Mamba`比`conda`更快，并且可以直接替代`conda`。推荐使用 Mamba，因为它可以大大减少在 Anaconda 中遇到*解析依赖…*屏幕卡住的几率。如果你使用的是 Anaconda 版本 23.10 或更高版本，那么你不必过于担心 Mamba，因为高效的包解析器已经默认包含在 Anaconda 中。

1.  **安装 Anaconda/Miniconda/Mamba/MicroMamba**：Anaconda 可以从[`www.anaconda.com/products/distribution`](https://www.anaconda.com/products/distribution)下载安装。根据你的操作系统，选择相应的文件并按照说明进行安装。你也可以从这里安装 Miniconda：[`docs.anaconda.com/miniconda/`](https://docs.anaconda.com/miniconda/)。你可以从这里安装 Mamba 和 MicroMamba：[`mamba.readthedocs.io/en/latest/`](https://mamba.readthedocs.io/en/latest/)。如果你使用的是 Mamba，下面的所有指令中，请将“`conda`”替换为“`mamba`”。

1.  **打开 conda 提示符**：打开 Anaconda Prompt（或在 Linux 或 macOS 上的终端），请按以下步骤操作：

    +   **Windows**：打开 Anaconda Prompt（**开始** | **Anaconda Prompt**）

    +   **macOS**：打开 Launchpad，然后打开终端。输入 `conda activate`。

    +   **Linux**：打开终端。输入 `conda activate`。

1.  **创建新环境**：使用以下命令创建你选择的新环境。例如，要创建一个名为`modern_ts_2E`的环境，并使用 Python 3.10（*建议使用 3.10 或更高版本*），使用以下命令：

    ```py
    conda create -n modern_ts_2E python=3.10 
    ```

1.  **激活环境**：使用以下命令激活环境：

    ```py
    conda activate modern_ts_2E 
    ```

1.  **从官方网站安装**`PyTorch`：最好从官方网站安装`PyTorch`。请访问[`pytorch.org/get-started/locally/`](https://pytorch.org/get-started/locally/)，并根据你的系统选择合适的选项。如果你想使用 Mamba 进行安装，可以将`conda`替换为`mamba`。

1.  **导航到下载的代码**：使用操作系统特定的命令导航到你下载代码的文件夹。例如，在 Windows 中，使用`cd`。

1.  **安装所需的库**：使用提供的`anaconda_env.yml`文件安装所有必需的库。使用以下命令：

    ```py
    conda env update --file anaconda_env.yml 
    ```

这将会在环境中安装所有必需的库。可能需要一些时间。

1.  **检查安装情况**：我们可以通过在下载的代码文件夹中执行一个脚本`python test_installation.py`来检查所有必需的库是否正确安装。如果 GPU 没有显示出来，请在环境中重新安装 PyTorch。

1.  **激活环境并运行笔记本**：每次想要运行笔记本时，首先使用`conda activate modern_ts_2E`命令激活环境，然后根据你的喜好使用 Jupyter Notebook（`jupyter notebook`）或 Jupyter Lab（`jupyter lab`）。

### 使用 Python 虚拟环境和 pip

如果你更倾向于使用原生 Python 进行环境管理，我们还提供了一个备用的`requirements.txt`，可以帮助你完成这项工作：

1.  **安装 Python**：你可以从[`www.python.org/downloads/`](https://www.python.org/downloads/)下载 Python。*推荐使用 3.10 或更高版本*。

1.  **创建虚拟环境**：使用以下命令创建名为`modern_ts_2E`的虚拟环境：

    ```py
    python -m venv modern_ts_2E 
    ```

1.  **激活环境**：使用以下命令激活环境：

    +   Windows: `modern_ts_2E\Scripts\activate`

    +   macOS/Linux: `source modern_ts_2E/bin/activate`

1.  **安装 PyTorch**：最好从官方网站安装`PyTorch`。请访问[`pytorch.org/get-started/locally/`](https://pytorch.org/get-started/locally/)，并根据你的系统选择合适的选项。

1.  **导航到下载的代码**：使用操作系统特定的命令导航到你下载代码的文件夹。例如，在 Windows 中，使用`cd`。

1.  **安装所需的库**：使用提供的`requirements.txt`文件安装所有必需的库。使用以下命令：

    ```py
    pip install -r requirements.txt 
    ```

这将会在环境中安装所有必需的库。可能需要一些时间。

1.  **检查安装情况**：我们可以通过在下载的代码文件夹中执行一个脚本来检查所有必需的库是否正确安装。

    ```py
    python test_installation.py 
    ```

1.  **激活环境并运行笔记本**：每次你想运行笔记本时，首先使用命令 `modern_ts_2E\Scripts\activate`（Windows）或 `source modern_ts_2E/bin/activate`（macOS/Linux）激活环境，然后根据你的偏好使用 Jupyter Notebook (`jupyter notebook`) 或 Jupyter Lab (`jupyter lab`)。

### 当环境创建时出现错误，该怎么办？

考虑到全球计算机的多样性以及不断变化的库依赖性，书中提供的环境设置（截至 2024 年 9 月已测试并能正常工作）很可能无法经受住时间的考验。在这种情况下，我们建议你打开 `requirements.txt` 文件，查看我们安装了哪些库，并尝试通过降级或升级版本来解决问题。

另一种解决方法是在使用某个笔记本时，只安装所需的包。通常，冲突发生在我们尝试在同一环境中安装不同的库时。例如，一个库需要 PyTorch < 1.0.0，而另一个库需要 PyTorch > 1.0.0。在这种情况下，将这两个库分到两个环境中，或者找到一个与其他库兼容的版本更为明智。

在这种情况下，你最好的朋友是谷歌搜索和随后的 GitHub 评论筛选，那些评论中提到相同的问题。作为最后的手段，你还可以在书籍的代码库中提一个问题，我们会尽力帮助你。

## 下载数据

你将在全书中使用一个数据集。本书使用的是来自 Kaggle 的 `London Smart Meters` 数据集。许多早期章节中的笔记本是后续章节的一些依赖项。因此，如果你想按顺序跳过某些章节运行笔记本，我们提供了一个 `data.zip` 文件，里面包含了所有所需的数据集，以去除这种依赖。

要进行设置，请按照以下步骤操作：

1.  从 AWS 下载数据：[`packt-modern-time-series-py.s3.eu-west-1.amazonaws.com/data.zip`](https://packt-modern-time-series-py.s3.eu-west-1.amazonaws.com/data.zip)。

1.  解压内容。

1.  将 `data` 文件夹复制到你从 GitHub 拉取的 `Modern-Time-Series-Forecasting-with-Python-2E` 文件夹中。

就是这样！你现在可以开始运行代码了。

**如果你使用的是本书的数字版本，我们建议你亲自输入代码或从本书的 GitHub 仓库获取代码。这样可以帮助你避免因复制粘贴代码而可能出现的错误。**

随书提供的代码并不是一个库，而是帮助你开始实验的指南。你从书籍和代码中能学到的内容，与你对代码的实验以及是否敢于走出舒适区的程度成正比。所以，尽管开始实验吧，将书中学到的技能付诸实践。

# 下载示例代码文件

您可以从 GitHub 下载本书的示例代码文件：[`github.com/PacktPublishing/Modern-Time-Series-Forecasting-with-Python-2E`](https://github.com/PacktPublishing/Modern-Time-Series-Forecasting-with-Python-2E)。如果代码有更新，它将在 GitHub 仓库中更新。

我们还提供了其他的代码包，来自我们丰富的书籍和视频目录，您可以在[`github.com/PacktPublishing/`](https://github.com/PacktPublishing/)查看。

# 下载彩色图像

我们还提供了一个包含本书中截图和图表的彩色图像 PDF 文件，您可以在此下载：[`packt.link/gbp/9781835883181`](https://packt.link/gbp/9781835883181)。

# 使用的约定

本书中使用了若干文本约定。

`代码文本中的内容`：表示文本中的代码、数据库表名、文件夹名称、文件名、文件扩展名、路径名、虚拟 URL、用户输入以及 Twitter 用户名。以下是一个示例：“`statsmodels.tsa.seasonal`中有一个名为`seasonal_decompose`的函数。”

一段代码的格式如下：

```py
#Does not support missing values, so using imputed ts instead
res = seasonal_decompose(ts, period=7*48, model="additive", extrapolate_trend="freq") 
```

任何命令行输入或输出格式如下：

```py
conda env create -f anaconda_env.yml 
```

**粗体**：表示新术语、重要单词或屏幕上显示的单词。例如，菜单或对话框中的单词会显示为**粗体**。例如：“但是，如果你查看**时间间隔**列，它会特别突出。”

重要提示 以这种形式出现。

小贴士 以这种形式出现。

# 与我们联系

我们始终欢迎读者的反馈。

**一般反馈**：如果您对本书的任何部分有疑问，请通过电子邮件联系我们：`customercare@packtpub.com`，并在邮件主题中注明书名。

**勘误**：尽管我们已经尽最大努力确保内容的准确性，但错误仍然可能发生。如果您在本书中发现错误，我们将非常感谢您向我们报告。请访问[www.packtpub.com/support/errata](https://www.packtpub.com/support/errata)并填写表格。

**盗版**：如果您在互联网上发现我们的作品以任何形式的非法复制，感谢您提供该内容的具体位置或网站名称。请通过`copyright@packt.com`与我们联系，并提供链接。

**如果您有兴趣成为作者**：如果您在某个领域具有专业知识，并且有兴趣编写或参与编写一本书，请访问[authors.packtpub.com](https://authors.packtpub.com)。

# 留下评论！

感谢您购买这本由 Packt Publishing 出版的书籍——我们希望您喜欢它！您的反馈对我们来说非常宝贵，帮助我们不断改进和成长。阅读完本书后，请抽空留下一个[Amazon 评论](https://packt.link/r/1835883192)；这只需一分钟，但对像您这样的读者而言，能带来巨大的不同。

扫描下面的二维码，获取您选择的免费电子书。

![A qr code with black squares Description automatically generated]

[`packt.link/NzOWQ`](https://packt.link/NzOWQ)

# 下载本书的免费 PDF 副本

感谢购买本书！

你喜欢随时随地阅读，但又无法随身携带纸质书籍吗？

你的电子书购买与所选设备不兼容吗？

别担心，现在每本 Packt 书籍，你都可以免费获得该书的无 DRM PDF 版本。

随时随地在任何设备上阅读。在你最喜欢的技术书籍中搜索、复制并将代码直接粘贴到你的应用程序中。

优惠不仅仅于此，你还可以独家获取折扣、新闻通讯，并且每天在邮箱中收到丰富的免费内容。

按照这些简单步骤获取福利：

1.  扫描二维码或访问下面的链接：

![](img/B22389_Free_PDF_QR.png)

[`packt.link/free-ebook/9781835883181`](https://packt.link/free-ebook/9781835883181)

1.  提交你的购买凭证。

1.  就是这样！我们会直接将免费的 PDF 和其他福利发送到你的邮箱。
