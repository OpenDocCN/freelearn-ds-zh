- en: 7\. Test Set Analysis, Financial Insights, and Delivery to the Client
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 7. 测试集分析、财务洞察和交付给客户
- en: Overview
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 概述
- en: This chapter presents several techniques for analyzing a model test set for
    deriving insights into likely model performance in the future. These techniques
    include the same model performance metrics we've already calculated, such as the
    ROC AUC, as well as new kinds of visualizations, such as the sloping of default
    risk by bins of predicted probability and the calibration of predicted probability.
    After reading this chapter, you will be able to bridge the gap between the theoretical
    metrics of machine learning and the financial metrics of the business world. You
    will be able to identify key insights while estimating the financial impact of
    a model and provide guidance to the client on how to realize this impact. We close
    with a discussion of the key elements to consider when delivering and deploying
    a model, such as the format of delivery and ways to monitor the model as it is
    being used.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章介绍了几种分析模型测试集的技术，用于推导未来可能的模型表现。这些技术包括我们已经计算过的相同模型性能指标，例如ROC AUC，以及一些新的可视化方法，如按预测概率分组的违约风险变化和预测概率的校准。阅读本章后，您将能够弥合机器学习的理论指标与商业世界财务指标之间的差距。您将能够识别关键洞察，并估算模型的财务影响，向客户提供如何实现这一影响的指导。最后，我们讨论了交付和部署模型时需要考虑的关键因素，如交付格式和监控模型使用情况的方法。
- en: Introduction
  id: totrans-3
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 引言
- en: In the previous chapter, we used XGBoost to push model performance even higher
    than all our previous efforts and learned how to explain model predictions using
    SHAP values. Now, we will consider model building to be complete and address the
    remaining issues that need attention before delivering the model to the client.
    The key elements of this chapter are analysis of the test set, including financial
    analysis, and things to consider when delivering a model to a client who wants
    to use it in the real world.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一章中，我们使用了XGBoost进一步提高了模型的性能，超越了我们之前的所有努力，并学会了如何通过SHAP值解释模型预测。现在，我们将认为模型构建已完成，并解决交付给客户之前需要关注的剩余问题。本章的关键内容是对测试集的分析，包括财务分析，以及交付模型给希望在现实世界中使用它的客户时需要考虑的事项。
- en: We look at the test set to get an idea of how well the model will perform in
    the future. By calculating metrics we already know, like the ROC AUC, but now
    on the test set, we can gain confidence that our model will be useful for new
    data. We'll also learn some intuitive ways to visualize the power of the model
    for grouping customers into different levels of risk of default, such as a decile
    chart.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 我们通过查看测试集来了解模型未来的表现。通过计算我们已知的指标，如ROC AUC，但这次是针对测试集的，我们可以增强对模型在新数据上有用性的信心。我们还将学习一些直观的方法来可视化模型将客户分为不同违约风险等级的能力，比如十分位图。
- en: Your client will likely appreciate the efforts you made in creating a more accurate
    model or one with a higher ROC AUC. However, they will definitely appreciate understanding
    how much money the model can help them earn or save and will probably be happy
    to receive specific guidance on how to maximize the model's potential for this.
    A financial analysis of the test set can simulate different scenarios of model-based
    strategies and help the client pick one that works for them.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 您的客户可能会欣赏您在创建更准确的模型或更高ROC AUC模型方面所做的努力。然而，他们一定会更重视了解模型能够帮助他们赚取或节省多少钱，并且可能会乐于接受关于如何最大化模型潜力的具体指导。对测试集的财务分析可以模拟基于模型的不同策略场景，帮助客户选择适合他们的策略。
- en: After completing the financial analysis, we will wrap up by discussing how to
    deliver a model for use by the client and how to monitor its performance over
    time.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 在完成财务分析后，我们将总结如何交付模型给客户使用，并讨论如何随着时间推移监控其表现。
- en: Review of Modeling Results
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 模型结果回顾
- en: In order to develop a binary classification model to meet the business requirements
    of our client, we have now tried several modeling techniques with varying degrees
    of success. In the end, we'd like to choose the model with the best performance
    to do further analyses on and present to our client. However, it is also good
    to communicate the other options we explored, demonstrating a thoroughly researched project.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 为了开发满足客户商业需求的二分类模型，我们已经尝试了几种建模技术，取得了不同程度的成功。最终，我们希望选择性能最好的模型进行进一步分析，并呈现给客户。然而，向客户传达我们探索的其他选项也是很重要的，这样可以展示我们进行了一项彻底的研究项目。
- en: 'Here, we review the different models that we tried for the case study problem,
    the hyperparameters that we needed to tune, and the results from cross-validation,
    or the validation set in the case of XGBoost. We only include the work we did
    using all possible features, not the earlier exploratory models where we used
    only one or two features:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们回顾了针对案例研究问题所尝试的不同模型、需要调整的超参数以及交叉验证结果，或者在 XGBoost 的情况下使用的验证集。我们仅包括使用所有可能特征所做的工作，而不包括早期只使用一两个特征的探索性模型：
- en: '![Figure 7.1: Summary of modeling activities with case study data'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.1：使用案例研究数据的建模活动总结'
- en: '](img/B16392_07_01.jpg)'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_07_01.jpg)'
- en: 'Figure 7.1: Summary of modeling activities with case study data'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.1：使用案例研究数据的建模活动总结
- en: 'When presenting results to the client, you should be prepared to interpret
    them for business partners at all levels of technical familiarity, including those
    with very little technical background. For example, business partners may not
    understand the derivation of the ROC AUC measure; however, this is an important
    concept since it''s the main performance metric we used to assess models. You
    may need to explain that it''s a metric that can vary between 0.5 and 1 and give
    intuitive explanations for these limits: 0.5 is no better than a coin flip and
    1 is perfection, which is essentially unattainable.'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 在向客户展示结果时，你应该准备好为各个技术背景层次的业务伙伴解释这些结果，包括那些技术背景很少的人。例如，业务伙伴可能不理解 ROC AUC 指标的推导过程；然而，这是一个重要的概念，因为它是我们用来评估模型的主要性能指标。你可能需要解释它是一个介于
    0.5 和 1 之间变化的指标，并给出这些界限的直观解释：0.5 就像是抛硬币一样，而 1 是完美的，实际上几乎是无法达到的。
- en: Our results are somewhere in between, getting close to 0.78 with the best model
    we developed. While the ROC AUC of a given model may not necessarily be meaningful
    by itself, *Figure 7.1* shows that we've tried several methods and have achieved
    improved performance above our initial attempts. In the end, for a business application
    like the case study, abstract model performance metrics like the ROC AUC should
    be accompanied by a financial analysis if possible. We will explore this later
    in this chapter.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的结果介于两者之间，最佳模型接近 0.78。虽然一个给定模型的 ROC AUC 可能单独来看没有太大意义，*图 7.1* 显示我们尝试了几种方法，并且在最初的尝试基础上取得了性能的提升。最终，对于像案例研究这样的商业应用，像
    ROC AUC 这样的抽象模型性能指标如果能配合财务分析，效果会更好。我们将在本章后面深入探讨这一点。
- en: 'Note: on Interpreting the ROC AUC'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 注：关于解释 ROC AUC
- en: An interesting interpretation of the ROC AUC score is the probability that for
    two samples, one with a positive outcome and one with a negative outcome, the
    positive sample will have a higher predicted probability than the negative sample.
    In other words, for all possible pairs of positive and negative samples in the
    dataset being assessed, the proportion of pairs where the positive sample has
    a higher model prediction than the negative sample is equivalent to the ROC AUC.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: ROC AUC 分数的一个有趣解释是，对于两个样本，其中一个是正面结果，另一个是负面结果，正面样本的预测概率会比负面样本高。换句话说，对于评估数据集中所有可能的正负样本对，正面样本的模型预测高于负面样本的比例等于
    ROC AUC。
- en: From *Figure 7.1*, we can see that for the case study, our efforts in creating
    more **complex models**, either by engineering new features to add to a simple
    logistic regression or by creating an ensemble of decision trees, yielded better
    model performance. In particular, the random forest and XGBoost models perform
    similarly, although these validation scores are technically not directly comparable
    since in the case of random forest we excluded missing values and used 4-fold
    cross-validation, while for XGBoost the missing values were included and there
    was just one validation set that was used for early stopping. However, *Figure
    7.1* provides an indication that either XGBoost or random forest would probably
    be the best choice. We'll move forward here with the XGBoost model.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 从*图 7.1*中，我们可以看到，对于案例研究，通过工程化新特征来增强简单的逻辑回归模型或创建决策树集成模型来构建更**复杂模型**的努力，取得了更好的模型性能。特别是随机森林和
    XGBoost 模型表现相似，尽管这些验证得分在技术上并不直接可比，因为在随机森林的情况下我们排除了缺失值，并且使用了 4 倍交叉验证，而在 XGBoost
    中，缺失值被包含在内，且只有一个验证集用于提前停止。然而，*图 7.1* 表明，XGBoost 或随机森林可能是最好的选择。我们将在这里继续使用 XGBoost
    模型。
- en: Now that we've decided which model we'll deliver, it's good to consider additional
    things we could have tried in the model development process. These concepts won't
    be explored in this book, but you may wish to experiment with them on your own.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经决定了要交付的模型，考虑一下在模型开发过程中我们可能尝试过的其他方法也是好的。这些概念本书中不会展开，但你可能希望自己进行实验。
- en: Feature Engineering
  id: totrans-20
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 特征工程
- en: 'Another way to increase model performance that we touched on briefly is `LIMIT_BAL`.
    The feature with the strongest interaction with this was the bill amount from
    two months ago. Although XGBoost can find interactions like this and model them
    to some extent, we could also engineer a new feature: the ratio of past monthly
    billed amounts to the credit limit, assuming the billed amount is the account''s
    balance. This measure of **credit utilization** may be a stronger feature, and
    result in better model performance when calculated in this way, than having the
    credit limit and monthly billed amounts available to the model separately.'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 提高模型性能的另一种方式，我们简要提到过的是`LIMIT_BAL`。与此特征最强交互的特征是两个月前的账单金额。尽管XGBoost可以找到类似的交互并在一定程度上对其进行建模，我们还可以构造一个新特征：过去每月账单金额与信用额度的比率，假设账单金额是账户的余额。这样计算得到的**信用利用率**可能是一个更强的特征，并且在这种方式下计算可能会比将信用额度和每月账单金额分别提供给模型的效果更好。
- en: Feature engineering may take the form of manipulating existing features to make
    new ones, as in the previous example, or it may involve bringing in entirely new
    data sources and creating features with them.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 特征工程可能表现为通过操作现有特征来创建新特征，如之前的示例，或者它可能涉及引入完全新的数据源并用它们来创建特征。
- en: 'The inspiration for new features may come from domain knowledge: it can be
    very helpful to have a conversation with your business partner about what they
    think good features might be, especially if they have more domain knowledge than
    you for the application you''re on. Examining the interactions of existing features
    can also be a way to hypothesize new features, such as how we saw an interaction
    that seems related to credit utilization in *Activity 6.01*, *Modeling the Case
    Study Data with XGBoost and Explaining the Model with SHAP*.'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 新特征的灵感可能来自领域知识：与业务伙伴讨论他们认为可能是良好特征的内容会非常有帮助，尤其是在你对所从事的应用领域了解不如他们时。检查现有特征的交互作用也是假设新特征的一种方式，就像我们在*活动6.01*中看到的与信用利用率相关的交互作用那样，*使用XGBoost建模案例数据并用SHAP解释模型*。
- en: Ensembling Multiple Models
  id: totrans-24
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 集成多个模型
- en: In choosing the final model to deliver for the case study project, it would
    probably be fine to deliver either random forest or XGBoost. Another commonly
    used approach in machine learning is to **ensemble** together multiple models.
    This means combining the predictions of different models, similar to how random
    forest and XGBoost combine many decision trees. But in this case, the way to combine
    model predictions is up to the data scientist. A simple way to create an ensemble
    of models is to take the average of their predictions.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 在选择最终交付的案例研究项目模型时，交付随机森林或XGBoost中的任何一个都可能是可以接受的。机器学习中另一种常用的方法是**集成**多个模型。这意味着将不同模型的预测结果结合起来，类似于随机森林和XGBoost将多个决策树结合的方式。但在这种情况下，如何结合模型预测由数据科学家决定。创建模型集成的一种简单方式是取它们预测结果的平均值。
- en: Ensembling is often done when there are multiple models, perhaps different kinds
    of models or models trained with different features that all have good performance.
    In our case, it may be that using the average prediction from the random forest
    and XGBoost would have better performance than either model on its own. To explore
    this, we could compare performance on a validation set, for example, the one used
    for early stopping in XGBoost.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 集成通常是在存在多个模型时进行的，可能是不同种类的模型或使用不同特征训练的模型，这些模型都具有良好的表现。在我们的案例中，可能使用随机森林和XGBoost的平均预测会比单独使用任何一个模型的表现更好。为了探索这一点，我们可以在验证集上比较表现，例如，用于XGBoost早停的验证集。
- en: Different Modeling Techniques
  id: totrans-27
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 不同的建模技术
- en: Depending on how much time you have for a project and your expertise in different
    modeling techniques, you will want to try as many methods as possible. More advanced
    methods, such as neural networks for classification, may yield improved performance
    on this problem. We encourage you to continue your studies and learn how to use
    these models. However, for tabular data such as what we have for the case study,
    XGBoost is a good de facto choice and will likely provide excellent performance,
    if not the best performance of all methods.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 根据你为项目分配的时间和在不同建模技术方面的专业知识，你可能希望尝试尽可能多的方法。更高级的方法，例如用于分类的神经网络，可能在这个问题上提供更好的表现。我们鼓励你继续学习并掌握如何使用这些模型。然而，对于像我们这个案例研究中使用的表格数据，XGBoost
    是一个非常好的默认选择，并且很可能提供优秀的表现，甚至可能是所有方法中最好的表现。
- en: Balancing Classes
  id: totrans-29
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 平衡类别
- en: Note that we did not address the class imbalance in the response variable. You
    are encouraged to try fitting models with the `class_weight='balanced'` option
    in scikit-learn or using the `scale_pos_weight` hyperparameter in XGBoost, to
    see the effect.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，我们并没有处理响应变量中的类别不平衡。我们鼓励你尝试使用 scikit-learn 中的 `class_weight='balanced'` 选项或在
    XGBoost 中使用 `scale_pos_weight` 超参数来拟合模型，以观察其效果。
- en: While these would be interesting avenues for further model development, for
    the purposes of this book, we are done with model building at this point. We'll
    move forward to examine XGBoost model performance on the test set.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管这些是进一步模型开发的有趣方向，但就本书而言，我们在此时已经完成了模型构建。我们将继续向前，检查 XGBoost 模型在测试集上的表现。
- en: Model Performance on the Test Set
  id: totrans-32
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 测试集上的模型表现
- en: We already have some idea of the out-of-sample performance of the XGBoost model,
    from the validation set. However, the validation set was used in model fitting,
    via early stopping. The most rigorous estimate of expected future performance
    we can make should be created with data that was not used at all for model fitting.
    This was the reason for reserving a test dataset from the model building process.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经通过验证集对 XGBoost 模型的外部样本表现有了一些了解。然而，验证集在模型拟合过程中通过提前停止被使用。因此，我们能够做出的最严格的预期未来表现估计应该使用完全没有用于模型拟合的数据。这也是我们从模型构建过程中预留一个测试数据集的原因。
- en: You may notice that we did examine the test set to some extent already, for
    example, in the first chapter when assessing data quality and doing data cleaning.
    The gold standard for predictive modeling is to set aside a test set at the very
    beginning of a project and not examine it at all until the model is finished.
    This is the easiest way to make sure that none of the knowledge from the test
    set has "leaked" into the training set during model development. When this happens,
    it opens up the possibility that the test set is no longer a realistic representation
    of future, unknown data. However, it is sometimes convenient to explore and clean
    all of the data together, as we've done. If the test data has the same quality
    issues as the rest of the data, then there would be no leakage. It is most important
    to make sure you're not looking at the test set when you decide which features
    to use, fit various models, and compare their performance.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会注意到，我们已经在一定程度上检查了测试集，例如，在第一章中评估数据质量和进行数据清理时。预测建模的金标准是在项目开始时预留出一个测试集，并且在模型完成之前不要对其进行任何检查。这是确保测试集中的任何知识没有在模型开发过程中“泄漏”到训练集中的最简单方法。当发生这种情况时，就有可能测试集不再能真实地代表未来的未知数据。然而，有时将所有数据一起探索和清理是很方便的，就像我们做的那样。如果测试数据与其余数据有相同的质量问题，那么就不会发生泄漏。最重要的是确保在决定使用哪些特征、拟合不同的模型并比较它们的表现时，不要查看测试集。
- en: 'We begin the test set examination by loading the trained model from *Activity
    6.01*, *Modeling the Case Study Data with XGBoost and Explaining the Model with
    SHAP* along with the training and test data and feature names, using Python''s
    `pickle`:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 我们通过加载来自 *活动 6.01*、*使用 XGBoost 构建案例研究数据模型并使用 SHAP 解释模型* 中训练好的模型，连同训练数据、测试数据和特征名称，使用
    Python 的 `pickle` 开始对测试集进行检查：
- en: '[PRE0]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'With these variables loaded in the notebook, we can make predictions for the
    test set and analyze them. First obtain the predicted probabilities for the test
    set:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 在将这些变量加载到笔记本后，我们可以对测试集进行预测并进行分析。首先，获取测试集的预测概率：
- en: '[PRE1]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Now import the ROC AUC calculation routine from scikit-learn, use it to calculate
    this metric for the test set, and display it:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，从 scikit-learn 导入 ROC AUC 计算函数，使用它来计算测试集的这一指标并显示出来：
- en: '[PRE2]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'The result should be as follows:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 结果应如下所示：
- en: '[PRE3]'
  id: totrans-42
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: The ROC AUC of 0.774 on the test set is a bit lower than the 0.779 we saw on
    the validation set for the XGBoost model; however, it is not very different. Since
    the model fitting process optimized the model for performance on the validation
    set, it's not totally surprising to see somewhat lower performance on new data.
    Overall, the testing performance is in line with expectations and we can consider
    this model successfully tested in terms of the ROC AUC metric.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 测试集上的 ROC AUC 为 0.774，略低于我们在验证集上看到的 XGBoost 模型的 0.779；然而，它们差异不大。由于模型拟合过程是针对验证集的性能进行了优化，因此在新数据上看到稍微低一点的表现并不完全令人意外。总体来说，测试性能符合预期，我们可以认为该模型在
    ROC AUC 指标上已经成功测试。
- en: While we won't do this here, a final step before delivering a trained model
    might be to fit it on all of the available data, including the unseen test set.
    This could be done by concatenating the training and testing data features (`X_train_all`,
    `X_test_all`) and labels (`y_train_all`, `y_test_all`), and using them to fit
    a new model, perhaps by defining a new validation set for early stopping or using
    the current test set for that purpose. This approach is motivated by the idea
    that machine learning models generally perform better when trained on more data.
    The downside is that since there would be no unseen test set in these circumstances,
    the final model could be considered to be untested.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然我们这里不会做这个，但在交付训练好的模型之前，最后一步可能是使用所有可用的数据，包括未见过的测试集，来拟合模型。这可以通过将训练数据和测试数据的特征（`X_train_all`，`X_test_all`）以及标签（`y_train_all`，`y_test_all`）进行拼接，使用它们来拟合一个新的模型，可能通过定义一个新的验证集来进行早停，或者使用当前的测试集来进行早停。这个方法的动机是机器学习模型通常在更多数据上训练时表现更好。缺点是，由于在这种情况下没有未见过的测试集，最终的模型可能被认为是未经测试的。
- en: 'Data scientists have varying opinions on which approach to use: only using
    the unseen test set for model assessment versus using as much data as possible,
    including the test set, to train the final model once all previous steps in the
    process are completed. One consideration is whether or not a model would benefit
    from being trained on more data. This could be determined by constructing a **learning
    curve**. Although we won''t illustrate this here, the concept behind a learning
    curve is to train a model on successively increasing amounts of data and calculating
    the validation score on the same validation set. For example, if you had 10,000
    training samples, you might set aside 500 as a validation set and then train a
    model on the first 1,000 samples, then the first 2,000 samples, and so on, up
    to all 9,500 samples that aren''t in the validation set. If training on more data
    consistently increases the validation score even up to the point of using all
    available data, this is a sign that training on more data than you have in the
    training set would be beneficial. However, if model performance starts to level
    off at some point and it doesn''t seem like additional data would create a more
    performant model, you may not need to do this. Learning curves can provide guidance
    on which approach to take with the test set, as well as whether more data is needed
    in a project generally.'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 数据科学家对于采用哪种方法有不同的看法：是仅使用未见过的测试集进行模型评估，还是在完成所有前期步骤后，利用尽可能多的数据（包括测试集）来训练最终模型。一个考虑因素是模型是否会从更多数据中受益。这可以通过构建**学习曲线**来确定。虽然我们在这里不做说明，但学习曲线的概念是训练一个模型，使用不断增加的数据量，并计算在同一验证集上的验证分数。例如，如果你有
    10,000 个训练样本，你可以留出 500 个作为验证集，然后先用前 1,000 个样本训练模型，再用前 2,000 个样本，依此类推，直到用完所有 9,500
    个不在验证集中的样本。如果在更多数据上训练时，验证分数持续提高，甚至在使用所有可用数据时仍然有效，这表明使用更多数据训练模型会带来好处。然而，如果模型性能在某个点开始趋于平稳，并且似乎额外的数据并不能提升模型表现，那么你可能不需要这么做。学习曲线可以为如何使用测试集以及项目中是否需要更多数据提供指导。
- en: For the purposes of the case study, we'll assume that we wouldn't realize any
    benefit from refitting the model using the test set. So, our main concerns now
    are presenting the model to the client, helping them design a strategy to use
    it to meet their business goals, and providing guidance on how the model's performance
    can be monitored as time goes on.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 就本案例研究而言，我们假设重新使用测试集来重新拟合模型不会带来任何益处。所以，现在我们主要关注的是向客户展示模型，帮助他们设计使用模型以实现业务目标的策略，并提供如何监控模型表现随时间变化的指导。
- en: Distribution of Predicted Probability and Decile Chart
  id: totrans-47
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 预测概率分布和十分位图
- en: 'The ROC AUC metric is helpful because it provides a single number that summarizes
    model performance on a dataset. However, it''s also insightful to look at model
    performance for different subsets of the population. One way to break up the population
    into subsets is to use the model predictions themselves. Using the test set, we
    can visualize the predicted probabilities with a histogram:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: ROC AUC 指标很有帮助，因为它提供了一个总结模型在数据集上表现的单一数值。然而，观察模型在不同子集上的表现也是很有洞察力的。将数据集划分为不同子集的一种方式是使用模型预测结果。使用测试集，我们可以通过直方图可视化预测的概率：
- en: '[PRE4]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'This code should produce the following plot:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 这段代码应当生成如下图：
- en: '![Figure 7.2: Distribution of predicted probabilities for the test set'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.2：测试集的预测概率分布'
- en: '](img/B16392_07_02.jpg)'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_07_02.jpg)'
- en: 'Figure 7.2: Distribution of predicted probabilities for the test set'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.2：测试集的预测概率分布
- en: The histogram of predicted probabilities for the test set shows that most predictions
    are clustered in the range `[0, 0.2]`. In other words, most borrowers have between
    a 0 and 20% chance of default, according to the model. However, there appears
    to be a small cluster of borrowers with a higher risk, centered near 0.7.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 测试集预测概率的直方图显示大多数预测集中在 `[0, 0.2]` 范围内。换句话说，根据模型，大多数借款人违约的概率在 0 到 20% 之间。然而，似乎有一小部分借款人存在更高的风险，集中在
    0.7 附近。
- en: A visually intuitive way to examine model performance for different regions
    of predicted default risk is to create a decile chart, which groups borrowers
    together based on the decile of predicted probability. Within each decile, we
    can compute the true default rate. We would expect to see a steady increase in
    the default rate from the lowest prediction deciles to the highest.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 检查模型在不同预测违约风险区域表现的直观方式是创建一个十分位图表，该图表根据预测概率的十分位将借款人分组。在每个十分位中，我们可以计算真实的违约率。我们预计会看到从最低预测十分位到最高预测十分位违约率的稳步上升。
- en: 'We can compute deciles like we did in *Exercise 6.01*, *Randomized Grid Search
    for Tuning XGBoost Hyperparameters*, using pandas'' `qcut`:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以像在 *练习 6.01* 中那样，使用 pandas 的 `qcut` 计算十分位数，*随机网格搜索调优 XGBoost 超参数*：
- en: '[PRE5]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Here we are splitting the predicted probabilities for the test set, supplied
    with the `x` keyword argument. We want to split them into 10 equal-sized bins,
    with the bottom 10% of predicted probabilities in the first bin, and so on, so
    we indicate we want `q=10` quantiles. However, you can split into any number of
    bins you want, such as 20 (ventiles) or 5 (quintiles). Since we indicate `retbins=True`,
    the bin edges are returned in the `decile_bin_edges` variable, while the series
    of decile labels is in `deciles`. We can examine the 11 bin edges needed to create
    10 bins:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，我们正在拆分测试集的预测概率，这些预测概率通过 `x` 关键字参数提供。我们希望将它们分成 10 个大小相等的区间，预测概率最低的 10% 在第一个区间，以此类推，因此我们设置
    `q=10` 分位数。然而，你可以将其分成任何数量的区间，比如 20（百分位）或 5（五分位）。由于我们设置了 `retbins=True`，区间的边界会保存在
    `decile_bin_edges` 变量中，而十分位标签的序列则保存在 `deciles` 中。我们可以查看创建 10 个区间所需的 11 个区间边界：
- en: '[PRE6]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'That should produce this:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 这应当产生如下图所示：
- en: '[PRE7]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'In order to make use of the `decile` series, we can combine it with the true
    labels for the test set, and the predicted probabilities, into a DataFrame:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 为了使用 `decile` 序列，我们可以将其与测试集的真实标签和预测概率合并成一个 DataFrame：
- en: '[PRE8]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'The first few rows of the DataFrame should look like this:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: DataFrame 的前几行应如下所示：
- en: '![Figure 7.3: DataFrame with predicted probabilities and deciles'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.3：包含预测概率和十分位数的 DataFrame'
- en: '](img/B16392_07_03.jpg)'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_07_03.jpg)'
- en: 'Figure 7.3: DataFrame with predicted probabilities and deciles'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.3：包含预测概率和十分位数的 DataFrame
- en: 'In the DataFrame, we can see that each sample is labeled with a decile bin,
    indicated using the edges of the bin that contains the predicted probability.
    The outcome shows the true label. What we want to show in our decile chart is
    the true default rate within the decile bins. For this, we can use pandas'' `groupby`
    capabilities. First, we create a `groupby` object, by grouping our DataFrame on
    the `decile` column:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 在 DataFrame 中，我们可以看到每个样本都被标注上了一个十分位区间，这个区间通过包含预测概率的区间边界来指示。结果显示了真实标签。我们希望在十分位图表中展示的是真实的违约率。为此，我们可以使用
    pandas 的 `groupby` 功能。首先，我们通过对 `decile` 列进行分组来创建一个 `groupby` 对象：
- en: '[PRE9]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'The `groupby` object can be aggregated by other columns. In particular, here
    we''re interested in the default rate within decile bins, which is the mean of
    the `outcome` variable. We also calculate a count of the data in each bin. Since
    quantiles, such as deciles, group the population into equal-sized bins, we expect
    the counts to be the same or similar:'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: '`groupby`对象可以通过其他列进行聚合。特别是在这里，我们关注的是每个十分位箱中的违约率，它是`outcome`变量的平均值。我们还计算了每个箱中数据的计数。由于分位数（如十分位）将总体分成相等大小的箱，因此我们预期计数应该相同或相似：'
- en: '[PRE10]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Examine our grouped DataFrame, `gr_df`:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 查看我们的分组DataFrame，`gr_df`：
- en: '![Figure 7.4: Default rate in deciles of predicted probability on the test
    set'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: '![图7.4：测试集上预测概率的十个分位中的违约率'
- en: '](img/B16392_07_04.jpg)'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_07_04.jpg)'
- en: 'Figure 7.4: Default rate in deciles of predicted probability on the test set'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 图7.4：测试集上预测概率的十个分位中的违约率
- en: 'In *Figure 7.4*, we can see that indeed the counts are nearly equal in all
    bins. We also can tell that the true default rate increases with the decile, as
    we hope and expect since we know our model has good performance. Before visualizing
    the data, it''s worth noting that this DataFrame has a special kind of column
    index called a `Outcome` and a second-level index with the labels `count` and
    `mean`. Accessing data in DataFrames that have a multiindex is a little more complicated
    than for the DataFrames we''ve worked with previously. We can display the column
    index as follows:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 在*图7.4*中，我们可以看到所有箱中的计数几乎相等。我们还可以看出，真实的违约率随着十分位的增加而增加，这是我们所期望的，因为我们知道我们的模型表现良好。在可视化数据之前，值得注意的是，这个DataFrame有一种特殊的列索引，叫做`Outcome`，以及第二级索引，标签分别为`count`和`mean`。访问具有多重索引的DataFrame的数据比我们之前使用的DataFrame要稍微复杂一些。我们可以通过以下方式显示列索引：
- en: '[PRE11]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'That should produce the following result:'
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 这将生成以下结果：
- en: '[PRE12]'
  id: totrans-79
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Here we can see that to access a column from a multiindex, we need to use tuples
    that specify each level of the index, for example, `gr_df[('Outcome','count')]`.
    While here the MultiIndex isn't really necessary since we've only done an aggregation
    of one column (`Outcome`), it can come in handy when there are aggregations on
    multiple columns.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里我们可以看到，要访问多重索引中的某一列，我们需要使用元组来指定索引的每一层级，例如，`gr_df[('Outcome','count')]`。虽然在这里MultiIndex并不是必需的，因为我们只对一列（`Outcome`）进行了聚合，但在对多个列进行聚合时，它会变得非常有用。
- en: 'Now we''d like to create a visualization, showing how the model predictions
    do a good job of binning borrowers into groups with consistently increasing default
    risk. We''re going to show the counts in each bin, as well as the default risk
    in each bin. Because these columns are on different scales, with counts in the
    hundreds and risk between 0 and 1, we should use a dual *y*-axis plot. In order
    to have more control over plot appearance, we''ll create this plot using Matplotlib
    functions instead of doing it through pandas. First, we create the plot of sample
    size in each bin, labeling the *y*-axis ticks with the same color as the plot
    for clarity. Please see the notebook on GitHub if you''re reading in black and
    white, as color is important for this plot. This code snippet should be run in
    the same cell as the next one. Here we create a set of axes, then add a plot to
    it along with some formatting and annotation:'
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们想要创建一个可视化图表，展示模型的预测如何将借款人准确地分组，并且这些组的违约风险不断上升。我们将展示每个箱中的计数，以及每个箱中的违约风险。由于这些列的量级不同，计数在数百之间，风险在0到1之间，因此我们应该使用双*y*轴图。为了对图表外观有更多的控制，我们将使用Matplotlib函数来创建这个图，而不是通过pandas来做。首先，我们绘制每个箱中样本数量的图，并用与图表相同的颜色标注*y*轴刻度，确保清晰。请参阅GitHub上的笔记本，如果你是以黑白阅读的，因为颜色对该图很重要。这段代码应该与接下来的代码段在同一个单元格中运行。这里我们创建了一组坐标轴，然后添加了图表并进行了格式化和标注：
- en: '[PRE13]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Notice that we''re creating a `bar` plot for the sample sizes. We''d like to
    add a line plot to this, showing the default rate in each bin on a right-hand
    *y*-axis but the same *x*-axis as the existing plot. Matplotlib makes a method
    called `twinx` available for this purpose, which can be called on an `axes` object
    to return a new axes object sharing the same *x*-axis. We take similar steps to
    then plot the default rate and annotate:'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，我们正在为样本大小创建一个`bar`图。我们希望在此基础上添加一条线形图，显示每个箱中的违约率，且该线图使用右侧的*y*轴，但与现有图表共享相同的*x*轴。Matplotlib为此目的提供了一个叫做`twinx`的方法，该方法可以在`axes`对象上调用，返回一个共享相同*x*轴的新坐标轴对象。我们采取类似的步骤，然后绘制违约率并进行标注：
- en: '[PRE14]'
  id: totrans-84
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'After running the preceding two snippets in a code cell, the following plot
    should appear:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 在运行前两个代码片段后，应该会出现以下图形：
- en: '![Figure 7.5: Default rate according to model prediction decile'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.5：根据模型预测十分位数的违约率'
- en: '](img/B16392_07_05.jpg)'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_07_05.jpg)'
- en: 'Figure 7.5: Default rate according to model prediction decile'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.5：根据模型预测十分位数的违约率
- en: '*Figure 7.5* contains the same information as displayed in the DataFrame in
    *Figure 7.4*, but in a nicer presentation. It''s clear that default risk increases
    with each decile, where the riskiest 10% of borrowers have a default rate close
    to 70%, but the least risky are below 10%. When a model is able to effectively
    distinguish groups of borrowers with consistently increasing default risk, the
    model is said to **slope** the population being examined. Notice also that the
    default rate is relatively flat across the lowest 5 to 7 deciles, likely because
    these observations are mostly clustered in the range [0, 0.2] of predicted risk,
    as seen in the histogram in *Figure 7.2*.'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: '*图 7.5* 包含与 *图 7.4* 中显示的数据框相同的信息，但呈现方式更为美观。很明显，违约风险随着每个十分位数的增加而增加，风险最大的10%借款人的违约率接近70%，而风险最小的借款人违约率低于10%。当一个模型能够有效地区分出违约风险持续增加的借款人群体时，称该模型**倾斜**了所研究的总体。还要注意，违约率在最低的5到7个十分位数之间相对平坦，这可能是因为这些观察值大多集中在预测风险范围[0,
    0.2]中，如*图 7.2*中的直方图所示。'
- en: Splitting the test set into equal-population deciles is one way to examine model
    performance, in terms of sloping default risk. However, a client may be interested
    in looking at default rate by different groups, such as equal interval bins (for
    example, binning together all observations in the prediction ranges [0, 0.2),
    [0.2, 0.4), and so on, regardless of sample size in each bin), or some other way.
    You'll explore how to easily do this in pandas in the following exercise.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 将测试集分成等人口十分位数是评估模型性能的一种方式，特别是在违约风险倾斜方面。然而，客户可能希望查看按不同群体划分的违约率，例如按等间隔箱（例如，将所有预测范围为[0,
    0.2)、[0.2, 0.4)等的观察值放在一起，而不管每个箱中的样本大小），或以其他方式。你将在接下来的练习中探索如何在 pandas 中轻松实现这一点。
- en: In the following exercise, we'll make use of a couple of statistical concepts
    to help create error bars, including the **standard error of the mean**, which
    we learned about previously, and the **normal approximation to the binomial distribution**.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 在接下来的练习中，我们将使用一些统计学概念来帮助创建误差条，包括我们之前学到的**均值的标准误差**和**二项分布的正态近似**。
- en: 'We know from *Chapter 5*, *Decision Trees and Random Forests* that we can estimate
    the variance of the sample mean as ![1](img/B16925_06_Equation1.png), where *n*
    is the sample size and ![2](img/B16925_06_Equation2.png) is the unobserved variance
    of a theoretical larger population. While we don''t know ![3](img/B16925_06_Equation3.png),
    it can be estimated by the variance of the sample we observed. For binary variables,
    the sample variance can be calculated as *p(1-p)*, where *p* is the proportion
    of successes, or defaults for the case study. Given the formula for the variance
    of the sample mean above, we can plug in the observed variance, then take the
    square root to get the standard error of the mean: ![4](img/B16925_06_Equation4.png).
    This formula is also known as the normal approximation to the binomial distribution
    in some contexts. We''ll use it below to create error bars on an equal-interval
    chart of default rates for different model prediction bins. For more details on
    these concepts, you are encouraged to consult a statistics textbook.'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 我们从*第5章*，*决策树和随机森林*中知道，我们可以估计样本均值的方差为 ![1](img/B16925_06_Equation1.png)，其中 *n*
    是样本大小，![2](img/B16925_06_Equation2.png) 是一个理论上更大总体的未观察到的方差。虽然我们不知道 ![3](img/B16925_06_Equation3.png)，但可以通过我们观察到的样本方差来估计。对于二元变量，样本方差可以计算为
    *p(1-p)*，其中 *p* 是成功的比例，或者说是案例研究中的违约比例。根据上面的样本均值方差公式，我们可以代入观察到的方差，然后取平方根得到均值的标准误差：![4](img/B16925_06_Equation4.png)。在某些情况下，这个公式也被称为二项分布的正态近似。我们将在下面使用它来为不同模型预测区间的违约率的等间隔图表创建误差条。有关这些概念的更多细节，建议查阅统计学教材。
- en: 'Exercise 7.01: Equal-Interval Chart'
  id: totrans-93
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 练习 7.01：等间隔图表
- en: 'In this exercise, you will make a similar chart to that shown in *Figure 7.5*;
    however, instead of splitting the test set into equal-population deciles of predicted
    probability, you''ll use equal intervals of predicted probability. Specifying
    the intervals could be helpful if a business partner wants to think about potential
    model-based strategies using certain score ranges. You can use pandas `cut` to
    create equal-interval binnings, or custom binnings using an array of bin edges,
    similar to how you used `qcut` to create quantile labels:'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个练习中，你将制作一个类似于*图 7.5*所示的图表；然而，与你将测试集拆分为预测概率的等人口十分位不同，你将使用预测概率的等间隔区间。如果业务伙伴希望使用某些得分范围来思考潜在的基于模型的策略，指定这些区间可能会有帮助。你可以使用
    pandas 的 `cut` 来创建等间隔区间，或者使用一个区间边界数组创建自定义区间，这类似于你使用 `qcut` 来创建分位标签的方式：
- en: Note
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: You can find the Jupyter notebook for this exercise at [https://packt.link/4Ev3n](https://packt.link/4Ev3n).
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在 [https://packt.link/4Ev3n](https://packt.link/4Ev3n) 找到这个练习的 Jupyter notebook。
- en: 'Create the series of equal-interval labels, for 5 bins, using the following
    code:'
  id: totrans-97
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下代码创建等间隔标签系列，针对5个区间：
- en: '[PRE15]'
  id: totrans-98
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Notice that this is similar to the call to `qcut`, except here with `cut` we
    can say how many equal-interval bins we want by supplying an integer to the `bins`
    argument. You could also supply an array for this argument to specify the bin
    edges, for custom bins.
  id: totrans-99
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 请注意，这与调用 `qcut` 类似，不同的是在这里使用 `cut` 时，我们可以通过向 `bins` 参数传递一个整数来指定我们想要的等间隔区间数。你也可以为此参数提供一个数组来指定自定义的区间边界。
- en: 'Examine the equal-interval bin edges with this code:'
  id: totrans-100
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下代码检查等间隔区间边界：
- en: '[PRE16]'
  id: totrans-101
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'The result should be as follows:'
  id: totrans-102
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 结果应如下所示：
- en: '[PRE17]'
  id: totrans-103
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE17]'
- en: You can confirm that these bin edges have equal intervals between them by subtracting
    the subarray going from the first to the next-to-last item, from the subarray
    starting with the second, and going to the end.
  id: totrans-104
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 你可以通过从第一个元素到倒数第二个元素的子数组与从第二个元素开始到最后一个元素的子数组相减，来确认这些区间边界之间是等间隔的。
- en: 'Check the intervals between bin edges like this:'
  id: totrans-105
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下代码检查区间边界之间的间隔：
- en: '[PRE18]'
  id: totrans-106
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'The result should be this:'
  id: totrans-107
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 结果应如下所示：
- en: '[PRE19]'
  id: totrans-108
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE19]'
- en: You can see that the distance between the bin edges is roughly equal. The first
    bin edge is a bit smaller than the minimum predicted probability, as you can confirm
    for yourself.
  id: totrans-109
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 你可以看到区间边界之间的距离大致相等。第一个区间边界比最小的预测概率稍小，你可以自行确认这一点。
- en: In order to create a similar plot to *Figure 7.5*, first we need to put the
    bin labels together with the response variable in a DataFrame, as we did previously
    with decile labels. We also put the predicted probabilities in the DataFrame for reference.
  id: totrans-110
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 为了创建一个类似于*图 7.5*的图表，首先我们需要将区间标签与响应变量放入一个 DataFrame，就像我们之前使用十分位标签时做的那样。我们还将预测概率放入
    DataFrame 以供参考。
- en: 'Make a DataFrame of predicted probabilities, bin labels, and the response variable
    for the test set like this:'
  id: totrans-111
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个包含预测概率、区间标签和测试集响应变量的 DataFrame，如下所示：
- en: '[PRE20]'
  id: totrans-112
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'The result should look as follows:'
  id: totrans-113
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 结果应如下所示：
- en: '![Figure 7.6: DataFrame with equal-interval bins'
  id: totrans-114
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 7.6：包含等间隔区间的 DataFrame'
- en: '](img/B16392_07_06.jpg)'
  id: totrans-115
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B16392_07_06.jpg)'
- en: 'Figure 7.6: DataFrame with equal-interval bins'
  id: totrans-116
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 7.6：包含等间隔区间的 DataFrame
- en: 'We can use this DataFrame to group by the bin labels, then get the metrics
    we are interested in: aggregations that represent the default rate and the number
    of samples in each bin.'
  id: totrans-117
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 我们可以使用这个 DataFrame 按照区间标签进行分组，然后获取我们感兴趣的指标：表示默认率和每个区间内样本数量的聚合数据。
- en: 'Group by the bin label and calculate the default rate and sample count within
    bins with this code:'
  id: totrans-118
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下代码按区间标签分组并计算各区间内的默认率和样本数：
- en: '[PRE21]'
  id: totrans-119
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'The resulting DataFrame should appear like this:'
  id: totrans-120
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 结果的 DataFrame 应该如下所示：
- en: '![Figure 7.7: Grouped data for five equal-interval bins'
  id: totrans-121
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 7.7：五个等间隔区间的分组数据'
- en: '](img/B16392_07_07.jpg)'
  id: totrans-122
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B16392_07_07.jpg)'
- en: 'Figure 7.7: Grouped data for five equal-interval bins'
  id: totrans-123
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 7.7：五个等间隔区间的分组数据
- en: Notice that here, unlike with quantiles, there are a different number of samples
    in each bin. The default rate appears to increase across bins in a consistent
    manner. Let's plot this DataFrame to create a similar visualization to *Figure
    7.5*.
  id: totrans-124
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 请注意，与分位数不同，这里每个区间内的样本数是不同的。默认率在各区间之间呈现一致的增长趋势。让我们绘制这个 DataFrame，创建一个类似于*图 7.5*的可视化。
- en: Before creating this visualization, in order to consider that the estimates
    of default rate may be less robust for higher predicted probabilities, due to
    decreased sample size in these ranges, we'll calculate the standard error of the
    default rates.
  id: totrans-125
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在创建此可视化之前，为了考虑到由于这些范围内的样本量减少，高预测概率的违约率估计可能不够稳健，我们将计算违约率的标准误差。
- en: 'Calculate the standard errors of the default rates within bins using this code:'
  id: totrans-126
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下代码计算箱体内违约率的标准误差：
- en: '[PRE22]'
  id: totrans-127
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'The result should appear as follows:'
  id: totrans-128
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 结果应该如下所示：
- en: '[PRE23]'
  id: totrans-129
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE23]'
- en: Notice that for the bins with higher score ranges and fewer samples, the standard
    error is larger. It will be helpful to visualize these standard errors with the
    default rates.
  id: totrans-130
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 注意，对于那些高分范围且样本较少的箱体，标准误差较大。将这些标准误差与违约率一起可视化会非常有帮助。
- en: 'Use this code to create an equal-interval plot of default rate and sample size.
    The code is very similar to that needed for *Figure 7.5*, except here we include
    error bars on the default rate plot using the `yerr` keyword and the results from
    the previous step:'
  id: totrans-131
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下代码创建一个违约率与样本大小的等间隔图。该代码与 *图 7.5* 所需的代码非常相似，不同之处在于这里我们使用 `yerr` 关键字和上一阶段的结果，在违约率图上加入了误差条：
- en: '[PRE24]'
  id: totrans-132
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'The result should appear like this:'
  id: totrans-133
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 结果应该如下所示：
- en: '![Figure 7.8: Plot of default rate and sample count for equal-interval bins'
  id: totrans-134
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 7.8：等间隔箱体中的违约率与样本数量的图'
- en: '](img/B16392_07_08.jpg)'
  id: totrans-135
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B16392_07_08.jpg)'
- en: 'Figure 7.8: Plot of default rate and sample count for equal-interval bins'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.8：等间隔箱体中的违约率与样本数量的图
- en: We can see in *Figure 7.8* that the number of samples is pretty different among
    the different bins, in contrast to the quantile approach. While there are relatively
    few samples in the higher score bins, leading to a larger standard error, the
    error bars on the plot of default rate are still small compared to the overall
    trend of an increasing default rate from lower to higher score bins, so we can
    be confident in this trend.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以在 *图 7.8* 中看到，不同箱体中的样本数量差异较大，与分位数方法形成对比。尽管高分数箱体中的样本相对较少，导致较大的标准误差，但违约率图上的误差条仍然较小，相比于从低分到高分箱体的总体趋势，我们可以对这一趋势有信心。
- en: Calibration of Predicted Probabilities
  id: totrans-138
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 预测概率的校准
- en: One interesting feature of *Figure 7.8* is that the line plot of default rates
    increases by roughly the same amount from bin to bin. Contrast this to the decile
    plot in *Figure 7.5*, where the default rate increases slowly at first and then
    more rapidly. Notice also that the default rate appears to be roughly the midpoint
    of the edges of predicted probability for each bin. This implies that the default
    rate is similar to the average model prediction in each bin. In other words, not
    only does our model appear to effectively rank borrowers from low to high risk
    of default, as quantified by the ROC AUC, but it also appears to accurately predict
    the probability of default.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: '*图 7.8* 的一个有趣特点是，违约率的折线图从一个箱体到下一个箱体大致增加相同的量。与 *图 7.5* 中的十分位图对比，违约率最初增加缓慢，然后迅速增加。还要注意，违约率大致是每个箱体内预测概率边缘的中点。这意味着违约率与每个箱体的平均模型预测相似。换句话说，我们的模型不仅能有效地按照从低到高的违约风险对借款人进行排序（通过
    ROC AUC 量化），而且还似乎能够准确预测违约概率。'
- en: Measuring how closely predicted probabilities match actual probabilities is
    the goal of **calibrating** **probabilities**. A standard measure for probability
    calibration follows from the concepts discussed above and is called **expected
    calibration error** (**ECE**), defined as
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 衡量预测概率与实际概率的匹配程度是**校准****概率**的目标。概率校准的标准度量遵循上述讨论的概念，称为**期望校准误差**（**ECE**），定义为：
- en: '![Figure 7.9: Expected Calibration Error'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.9：期望校准误差'
- en: '](img/B16392_07_09.jpg)'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_07_09.jpg)'
- en: 'Figure 7.9: Expected Calibration Error'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.9：期望校准误差
- en: where the index *i* ranges from 1 to the number of bins (*N*), *F*i is the fraction
    of all samples falling in bin *i*, *o*iis the fraction of samples in bin *i* that
    are positive (that is, for the case study, defaulters), and *e*i is the average
    of predicted probabilities within bin *i*.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 其中，索引 *i* 从 1 到箱体数目（*N*）范围，*F*i 是所有样本中落入箱体 *i* 的比例，*o*i 是箱体 *i* 中为正样本（即在案例研究中为违约者）的比例，*e*i
    是箱体 *i* 内预测概率的平均值。
- en: 'We can calculate the ECE for the predicted probabilities within decile bins
    of the test set using a DataFrame very similar to that shown in *Figure 7.4*,
    needed to create the decile chart. The only addition we need is the mean predicted
    probability in each bin. Create such a DataFrame as follows:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以使用一个与*图 7.4*中非常相似的DataFrame来计算测试集中分位区间内预测概率的ECE，这个DataFrame用于创建分位图。我们唯一需要添加的是每个区间内的平均预测概率。按如下方式创建这样的DataFrame：
- en: '[PRE25]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'The output DataFrame should look like this:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 输出的DataFrame应如下所示：
- en: '![Figure 7.10: DataFrame for calculating the ECE metric'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.10：计算ECE指标的DataFrame'
- en: '](img/B16392_07_10.jpg)'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_07_10.jpg)'
- en: 'Figure 7.10: DataFrame for calculating the ECE metric'
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.10：计算ECE指标的DataFrame
- en: 'For convenience, let''s define a variable for `F`, which is the fraction of
    samples in each bin. This is the counts in each bin from the above DataFrame divided
    by the total number of samples, taken from the shape of the response variable
    for the test set:'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 为了方便起见，我们定义一个变量`F`，表示每个区间中样本的比例。这是从上面的DataFrame中每个区间的计数除以样本总数，后者是从测试集响应变量的形状中获得的：
- en: '[PRE26]'
  id: totrans-152
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'The output should be this:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 输出应为：
- en: '[PRE27]'
  id: totrans-154
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'So, each bin has about 10% of the samples. This is expected, of course, since
    the bins were created using a quantile approach. However, for other binnings,
    the sample sizes in the bins may not be equal. Now let''s implement the formula
    for ECE in code to calculate this metric:'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，每个区间大约包含10%的样本。这是预期的，当然，因为区间是使用分位数方法创建的。然而，对于其他分箱方法，区间中的样本数量可能不相等。现在让我们在代码中实现ECE的公式来计算这个指标：
- en: '[PRE28]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'The output should be this:'
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 输出应为：
- en: '[PRE29]'
  id: totrans-158
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: This number represents the ECE for our final model, on the test set. By itself,
    the number isn't all that meaningful. However, metrics like this can be monitored
    over time, after the model has been put in production and is being used in the
    real world. If the ECE starts to increase, this is a sign that the model is becoming
    less calibrated and may need to be retrained, for example, or have a calibration
    procedure applied to the outputs.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 这个数字代表我们最终模型在测试集上的ECE。单独来看，这个数字并没有太多意义。然而，像这样的指标可以在时间上进行监控，在模型投入生产并在实际应用中使用之后。如果ECE开始增加，这表示模型的校准性变差，可能需要重新训练，或者对输出应用校准过程。
- en: 'A more intuitive way to examine the calibration of our predicted probabilities
    for the test set is to plot the ingredients needed for ECE, in particular the
    true default rate of the response variable, against the average of model predictions
    in each bin. To this we add a 1-1 line, which represents perfect calibration,
    as a point of reference:'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 检查我们预测概率的校准的一个更直观方法是绘制ECE所需的各个成分，特别是响应变量的真实违约率，与每个区间内模型预测的平均值进行对比。在此基础上，我们加上一条1-1线，表示完美校准，作为参考点：
- en: '[PRE30]'
  id: totrans-161
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'The resulting plot should look like this:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 结果图应如下所示：
- en: '![Figure 7.11: Calibration plot for predicted probabilities'
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.11：预测概率的校准图'
- en: '](img/B16392_07_11.jpg)'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_07_11.jpg)'
- en: 'Figure 7.11: Calibration plot for predicted probabilities'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.11：预测概率的校准图
- en: '*Figure 7.11* shows that model-predicted probabilities are very close to the
    true default rates, so the model appears to be well calibrated. For additional
    insight, you can try adding error bars to this plot yourself as an exercise. Also
    note that scikit-learn makes a function available to calculate the information
    needed to create *Figure 7.11*: `sklearn.calibration.calibration_curve`. However,
    this function does not return the sample size in each bin.'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: '*图 7.11*显示了模型预测的概率与真实的违约率非常接近，因此模型似乎被良好校准。为了获得更多见解，你可以尝试自己向这个图添加误差条作为练习。还要注意，scikit-learn提供了一个函数来计算创建*图
    7.11*所需的信息：`sklearn.calibration.calibration_curve`。然而，这个函数并不会返回每个区间的样本大小。'
- en: One additional point to be aware of for probability calibration is that some
    methods for dealing with class imbalance, such as oversampling or undersampling,
    change the class fraction in the training dataset, which will affect the predicted
    probabilities and likely make them less accurate. This may not be that important
    though, compared to the ability of the model to rank borrowers on their risk of
    default, as measured by the ROC AUC, depending on the needs of the client.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 对于概率校准，另一个需要注意的点是，一些处理类别不平衡的方法，如过采样或欠采样，会改变训练数据集中类别的比例，这会影响预测的概率，并可能使其不那么准确。不过，这一点可能不那么重要，特别是与模型根据借款人违约风险进行排名的能力（通过ROC
    AUC衡量）相比，这取决于客户的需求。
- en: Financial Analysis
  id: totrans-168
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 财务分析
- en: 'The model performance metrics we have calculated so far were based on abstract
    measures that could be applied to analyze any classification model: how accurate
    a model is, how skillful a model is at identifying true positives relative to
    false positives at different thresholds (ROC AUC), the correctness of positive
    predictions (precision), or intuitive measures such as sloping risk. These metrics
    are important for understanding the basic workings of a model and are widely used
    within the machine learning community, so it''s important to understand them.
    However, for the application of a model to business use cases, we can''t always
    directly use such performance metrics to create a strategy for how to use the
    model to guide business decisions or figure out how much value a model is expected
    to create. To go the extra mile and connect the mathematical world of predicted
    probabilities and thresholds to the business world of costs and benefits, a financial
    analysis of some kind is usually needed.'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 我们目前计算的模型性能指标基于一些抽象的度量，可以应用于分析任何分类模型：模型的准确度、模型在不同阈值下识别真阳性与假阳性能力的准确性（ROC AUC）、正向预测的正确性（精确度），或诸如斜坡风险等直观的度量。这些指标对于理解模型的基本工作原理非常重要，并且在机器学习领域广泛使用，因此理解它们非常关键。然而，在将模型应用于商业案例时，我们并不能总是直接使用这些性能指标来制定如何使用模型来指导商业决策或评估模型可能创造的价值的策略。为了更进一步地将预测概率和阈值的数学世界与成本和收益的商业世界联系起来，通常需要进行某种财务分析。
- en: In order to help the client with this analysis, the data scientist needs to
    understand what kinds of decisions and actions might be taken, based on predictions
    made by the model. This should be the topic of a conversation with the client,
    preferably early on in the project life cycle. We have left it until the end of
    the book so that we could establish a baseline understanding of what predictive
    modeling is and how it works. However, learning the business context around model
    usage at the beginning of a project allows you to set goals for model performance
    in terms of the creation of value, which you can track throughout a project as
    we tracked the ROC AUC of the different models we built. Translating model performance
    metrics into financial terms is the topic of this section.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 为了帮助客户进行此分析，数据科学家需要了解根据模型预测可能采取的决策和行动。这应该是与客户的对话内容，最好在项目生命周期的早期进行。我们将其留到本书的最后，以便建立对预测建模是什么以及如何工作的基础理解。然而，在项目开始时了解模型使用的商业背景，可以让你为模型性能设定目标，并在整个项目过程中追踪这些目标，就像我们追踪不同模型的ROC
    AUC一样。将模型性能指标转化为财务术语是本节的主题。
- en: 'For a binary classification model such as that of the case study, here are
    a few questions that the data scientist needs to know the answers to, in order
    to help the client figure out how to use the model:'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 对于像案例研究中的二分类模型，数据科学家需要了解以下几个问题的答案，以帮助客户弄清楚如何使用该模型：
- en: What kinds of decisions does the client want to use the model to help them make?
  id: totrans-172
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 客户希望通过模型帮助做出哪些决策？
- en: How can the predicted probabilities of a binary classification model be used
    to help make these decisions?
  id: totrans-173
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如何利用二分类模型的预测概率来帮助做出这些决策？
- en: Are they yes/no decisions? If so, then choosing a single threshold of predicted
    probability will be sufficient.
  id: totrans-174
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 它们是是/否决策吗？如果是，那么选择一个单一的预测概率阈值就足够了。
- en: Are there more than two levels of activity that will be decided on, based on
    model results? If so, then choosing two or more thresholds, to sort predictions
    into low, medium, and high risk, for example, may be the solution. For instance,
    predicted probabilities below 0.5 may be considered low risk, those between 0.5
    and 0.75 medium risk, and those above 0.75 high risk.
  id: totrans-175
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 是否会根据模型结果做出超过两级的活动决策？如果是，那么选择两个或更多的阈值，例如将预测结果分为低、中、高风险，可能是解决方案。例如，预测概率低于0.5可以视为低风险，0.5到0.75之间为中风险，0.75以上为高风险。
- en: What are the costs of taking all the different courses of action that are available,
    based on model guidance?
  id: totrans-176
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 根据模型指导，采取不同行动方案的成本是什么？
- en: What are the potential benefits to be gained from successful actions taken as
    a result of model guidance?
  id: totrans-177
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从模型指导下采取成功行动可能获得的潜在好处是什么？
- en: Financial Conversation with the Client
  id: totrans-178
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 与客户的财务对话
- en: 'We ask the case study client about the points outlined above and learn the
    following: for credit accounts that are at a high risk of default, the client
    is designing a new program to provide individualized counseling for the account
    holder, to encourage them to pay their bill on time or provide alternative payment
    options if that will not be possible. Credit counseling is performed by trained
    customer service representatives who work in a call center. The cost per counseling
    session is NT$7,500 and the expected success rate of a session is 70%, meaning
    that on average 70% of the recipients of phone calls offering counseling will
    pay their bill on time, or make alternative arrangements that are acceptable to
    the creditor. The potential benefits of successful counseling are that the amount
    of an account''s monthly bill will be realized as savings, if it was going to
    default but instead didn''t, as a result of the counseling. Currently, the monthly
    bills for accounts that default are reported as losses.'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 我们向案例研究客户询问了上述要点，得知以下信息：对于那些高风险违约的信贷账户，客户正在设计一个新项目，为账户持有人提供个性化的咨询，鼓励他们按时支付账单，或在无法按时支付的情况下提供替代付款选项。信贷咨询由经过培训的客户服务代表在呼叫中心进行。每次咨询的费用为新台币
    7,500 元，每次咨询的预期成功率为 70%，意味着平均来说，70% 接到提供咨询电话的客户会按时支付账单，或者采取对债权人可接受的替代安排。成功咨询的潜在收益在于，如果账户本应违约但在咨询后未违约，则账户的每月账单金额将视为节省。目前，违约账户的每月账单会被报告为损失。
- en: After having the preceding conversation with the client, we have the materials
    we need to make a financial analysis. The client would like us to help them decide
    which members to contact and offer credit counseling to. If we can help them narrow
    down the list of people who will be contacted for counseling, we can help save
    them money by avoiding unnecessary and expensive contacts. The clients' limited
    resources for counseling will be more appropriately spent on accounts that are
    at higher risk of default. This should create greater savings due to prevented
    defaults. Additionally, the client lets us know that our analysis can help them
    request a budget for the counseling program, if we can give them an idea of how
    many counseling sessions it would be worthwhile to offer.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 在与客户进行前述对话后，我们已经获得了进行财务分析所需的材料。客户希望我们帮助他们决定应该联系哪些成员并提供信贷咨询。如果我们能帮助他们缩小需要联系进行咨询的人员名单，就能通过避免不必要和昂贵的联系方式为他们节省费用。客户在信贷咨询上的有限资源将更合适地用于高风险违约账户。这应该能够通过预防违约带来更大的节省。此外，客户告诉我们，如果我们能给他们一个关于值得提供多少次咨询的概念，我们的分析可以帮助他们申请咨询项目的预算。
- en: 'As we proceed to the financial analysis, we see that the decision that the
    model will help the client make, on an account by account basis, is a yes/no decision:
    whether to offer counseling to the holder of a given account. Therefore, our analysis
    should focus on finding an appropriate threshold of predicted probability, by
    which we may divide our accounts into two groups: higher-risk accounts that will
    receive counseling and lower-risk ones that won''t.'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 在进行财务分析时，我们看到模型将帮助客户做出的决策是逐个账户进行的“是/否”决策：是否为给定账户的持有人提供咨询。因此，我们的分析应该专注于找到一个合适的预测概率阈值，通过该阈值我们可以将账户分为两组：高风险账户将接受咨询，低风险账户则不接受。
- en: 'Exercise 7.02: Characterizing Costs and Savings'
  id: totrans-182
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '练习 7.02: 成本与节省的描述'
- en: 'The connection between model output and business decisions the client will
    make comes down to selecting a threshold for the predicted probabilities. Therefore,
    in this exercise, we will characterize the expected costs of the counseling program,
    in terms of costs of offering individual counseling sessions, as well as the expected
    savings, in terms of prevented defaults, at a range of thresholds. There will
    be different costs and savings at each threshold, because each threshold is expected
    to result in a different number of positive predictions, as well as a different
    number of true positives within these. The first step is to create an array of
    potential thresholds. We will use 0 through 1, going by an increment of 0.01\.
    Perform the following steps to complete the exercise:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 模型输出与客户将做出的业务决策之间的联系，归结为为预测概率选择一个阈值。因此，在本次练习中，我们将描述咨询程序的预期成本（以提供单独咨询会议的成本表示）以及预期节省（以预防违约的节省表示），这些将在一系列阈值下进行计算。每个阈值下会有不同的成本和节省，因为每个阈值预计会导致不同数量的正预测结果，并且在这些结果中会有不同数量的真正正例。第一步是创建一个潜在阈值的数组。我们将使用从0到1，步长为0.01的值。执行以下步骤以完成本次练习：
- en: Note
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'The Jupyter notebook for this exercise can be found here: [https://packt.link/yiMEr](https://packt.link/yiMEr).
    Additional steps to prepare data for this exercise, based on previous results
    in this chapter, have been added to the notebook. Please make sure you execute
    the prerequisite steps as presented in the notebook before you perform this exercise.'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 本次练习的Jupyter notebook可以在这里找到：[https://packt.link/yiMEr](https://packt.link/yiMEr)。基于本章前面的结果，已在notebook中添加了准备数据的额外步骤。请确保在进行本次练习前，先执行notebook中展示的前提步骤。
- en: 'Create a range of thresholds to calculate expected costs and benefits of counseling
    with this code:'
  id: totrans-186
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下代码创建一个阈值范围，以计算咨询的预期成本和收益：
- en: '[PRE31]'
  id: totrans-187
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE31]'
- en: This creates 101 linearly spaced points between 0 and 1, inclusive.
  id: totrans-188
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这会在0到1之间（包括0和1）创建101个等间距的点。
- en: Now, we need to know the potential savings of a prevented default. To calculate
    this precisely, we would need to know the next month's monthly bill. However,
    the client has informed us that this will not be available at the time they need
    to create the list of account holders to be contacted. Therefore, in order to
    estimate the potential savings, we will use the most recent monthly bill.
  id: totrans-189
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 现在，我们需要了解预防违约的潜在节省。为了精确计算这一点，我们需要知道下个月的月度账单。然而，客户已经告知我们，在他们需要创建待联系账户持有者名单时，这些数据将无法提供。因此，为了估算潜在节省，我们将使用最近的月度账单。
- en: 'We will use the testing data to create this analysis, as this provides a simulation
    of how the model will be used after we deliver it to the client: on new accounts
    that weren''t used for model training.'
  id: totrans-190
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 我们将使用测试数据来创建此分析，因为它提供了模型交付给客户后使用的模拟：在未用于模型训练的新账户上。
- en: 'Confirm the index of the testing data features array that corresponds to the
    most recent month''s bill:'
  id: totrans-191
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确认测试数据特征数组中对应最近一个月账单的索引：
- en: '[PRE32]'
  id: totrans-192
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'The output should be this:'
  id: totrans-193
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 输出应为：
- en: '[PRE33]'
  id: totrans-194
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE33]'
- en: The index 5 is for the most recent months' bill, which we'll use later.
  id: totrans-195
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 索引5对应的是最近几个月的账单，我们稍后会用到。
- en: 'Store the cost of counseling in a variable to use for analysis:'
  id: totrans-196
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将咨询成本存储在一个变量中，以便用于分析：
- en: '[PRE34]'
  id: totrans-197
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE34]'
- en: We also know from the client that the counseling program isn't 100% effective.
    We should take this into account in our analysis.
  id: totrans-198
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 我们还知道，客户告知我们，咨询程序的效果并不是100%的。我们应该在分析中考虑这一点。
- en: 'Store the effectiveness rate the client gave us for use in analysis:'
  id: totrans-199
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 存储客户提供的有效性率，以便用于分析：
- en: '[PRE35]'
  id: totrans-200
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE35]'
- en: Now, we will calculate costs and savings for each of the thresholds. We'll step
    through each calculation and explain it, but for now, we need to create empty
    arrays to hold the results for each threshold.
  id: totrans-201
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 现在，我们将计算每个阈值的成本和节省。我们会逐步讲解每个计算过程，但目前我们需要创建空数组来存储每个阈值的结果。
- en: 'Create empty arrays to store analysis results. We''ll explain what each one
    will hold in the following steps:'
  id: totrans-202
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建空数组来存储分析结果。我们将在后续步骤中解释每个数组的作用：
- en: '[PRE36]'
  id: totrans-203
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE36]'
- en: These create empty arrays with the same number of elements as there are thresholds
    in our analysis. We will loop through each threshold value to fill these arrays.
  id: totrans-204
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这些创建了与我们分析中的阈值数量相同的空数组。我们将遍历每个阈值值来填充这些数组。
- en: 'Make a `counter` variable and open a `for` loop to go through thresholds:'
  id: totrans-205
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个`counter`变量并打开一个`for`循环来遍历各个阈值：
- en: '[PRE37]'
  id: totrans-206
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE37]'
- en: For each threshold, there will a different number of positive predictions, according
    to how many predicted probabilities are above that threshold. These correspond
    to accounts that are predicted to default. Each account that is predicted to default
    will receive a counseling phone call, which has a cost associated with it. So,
    this is the first part of the cost calculation.
  id: totrans-207
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 对于每个阈值，根据预测概率高于该阈值的数量，会有不同数量的正向预测。这些预测对应的是被认为会违约的账户。每个被预测为违约的账户都会接到一次咨询电话，这会产生相应的费用。因此，这是成本计算的第一部分。
- en: 'Determine which accounts get positive predictions at this threshold:'
  id: totrans-208
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确定在该阈值下哪些账户获得了正向预测：
- en: '[PRE38]'
  id: totrans-209
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE38]'
- en: '`pos_pred` is a Boolean array. The sum of `pos_pred` indicates the number of
    predicted defaults at this threshold.'
  id: totrans-210
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '`pos_pred` 是一个布尔数组。`pos_pred` 的总和表示在该阈值下预测的违约数量。'
- en: 'Calculate the number of positive predictions for the given threshold:'
  id: totrans-211
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 计算给定阈值下的正向预测数量：
- en: '[PRE39]'
  id: totrans-212
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE39]'
- en: 'Calculate the total cost of counseling for the given threshold:'
  id: totrans-213
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 计算给定阈值下的咨询总成本：
- en: '[PRE40]'
  id: totrans-214
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE40]'
- en: 'Now that we have characterized the possible costs of the counseling program,
    at each threshold, we need to see what the projected savings are. Savings are
    obtained when counseling is offered to the right account holders: those who would
    otherwise default. In terms of the classification problem, these are positive
    predictions, where the true value of the response variable is also positive –
    in other words, true positives.'
  id: totrans-215
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 现在，我们已经了解了咨询项目在每个阈值下的可能成本，我们需要查看预期的节省。在提供咨询服务给正确的账户持有人时，会获得节省：即那些本来会违约的账户。从分类问题的角度来看，这些是正向预测，其响应变量的真实值也是正向的——换句话说，是真正的正向预测。
- en: 'Determine which accounts are true positives, based on the array of positive
    predictions and the response variable:'
  id: totrans-216
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 基于正向预测数组和响应变量，确定哪些账户是真正的正向预测：
- en: '[PRE41]'
  id: totrans-217
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE41]'
- en: 'Calculate the number of true positives as the sum of the true positive array:'
  id: totrans-218
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过对真正的正向预测数组求和来计算真正的正向预测数量：
- en: '[PRE42]'
  id: totrans-219
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE42]'
- en: The savings we can get from successfully counseling account holders who would
    otherwise default depends on the savings per prevented default, as well as the
    effectiveness rate of counseling. We won't be able to prevent every default.
  id: totrans-220
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 我们从成功为原本会违约的账户持有人提供咨询所能获得的节省，取决于每个预防违约的节省金额以及咨询的有效性率。我们无法预防每一个违约。
- en: 'Calculate the anticipated savings at each threshold using the number of true
    positives, the savings due to prevented default (estimated using last month''s
    bill), and the effectiveness rate of counseling:'
  id: totrans-221
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用真正的正向预测数量、预防违约的节省（通过上个月的账单估算）和咨询的有效性率来计算每个阈值下的预期节省：
- en: '[PRE43]'
  id: totrans-222
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE43]'
- en: 'Increment the counter:'
  id: totrans-223
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 增加计数器：
- en: '[PRE44]'
  id: totrans-224
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE44]'
- en: '*Steps 5* through *13* should be run as a `for` loop in one cell in the Jupyter
    Notebook. Afterward, the net savings for each threshold can be calculated as the
    savings minus the cost.'
  id: totrans-225
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '*步骤 5* 到 *13* 应该作为 `for` 循环在 Jupyter Notebook 的一个单元格中运行。之后，可以通过将节省减去成本来计算每个阈值的净节省。'
- en: 'Calculate the net savings for all the thresholds by subtracting the savings
    and cost arrays:'
  id: totrans-226
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过将节省和成本数组相减，计算所有阈值的净节省：
- en: '[PRE45]'
  id: totrans-227
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE45]'
- en: Now, we're in a position to visualize how much money we might help our client
    save by providing counseling to the appropriate account holders. Let's visualize this.
  id: totrans-228
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 现在，我们可以可视化通过为合适的账户持有人提供咨询服务，我们可能帮助客户节省多少钱。让我们来可视化一下。
- en: 'Plot the net savings against the thresholds as follows:'
  id: totrans-229
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按照如下方式绘制净节省与阈值的关系：
- en: '[PRE46]'
  id: totrans-230
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE46]'
- en: 'The resulting plot should look like this:'
  id: totrans-231
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 结果图应如下所示：
- en: '![Figure 7.12: Plot of net savings versus thresholds'
  id: totrans-232
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 7.12：净节省与阈值的关系图'
- en: '](img/B16392_07_12.jpg)'
  id: totrans-233
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B16392_07_12.jpg)'
- en: 'Figure 7.12: Plot of net savings versus thresholds'
  id: totrans-234
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 7.12：净节省与阈值的关系图
- en: The plot indicates that the choice of threshold is important. While it will
    be possible to create net savings at many different values of the threshold, it
    looks like the highest net savings will be generated by setting the threshold
    somewhere in the range of about 0.25 to 0.5.
  id: totrans-235
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图表显示，阈值的选择非常重要。虽然在许多不同的阈值下都能实现净节省，但看起来通过将阈值设置在大约 0.25 到 0.5 之间的某个范围内，可以获得最大的净节省。
- en: Let's confirm the optimal threshold for creating the greatest savings and see
    how much the savings are.
  id: totrans-236
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 让我们确认产生最大节省的最佳阈值，并查看节省的具体数额。
- en: 'Find the index of the largest element of the net savings array using NumPy''s `argmax`:'
  id: totrans-237
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 NumPy 的`argmax`查找净节省数组中最大元素的索引：
- en: '[PRE47]'
  id: totrans-238
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE47]'
- en: 'Display the threshold that results in the greatest net savings:'
  id: totrans-239
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 显示产生最大净节省的阈值：
- en: '[PRE48]'
  id: totrans-240
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'The output should be as follows:'
  id: totrans-241
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 输出应如下所示：
- en: '[PRE49]'
  id: totrans-242
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'Display the greatest possible net savings:'
  id: totrans-243
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 显示最大的净节省：
- en: '[PRE50]'
  id: totrans-244
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE50]'
- en: 'The output should be as follows:'
  id: totrans-245
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 输出应如下所示：
- en: '[PRE51]'
  id: totrans-246
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE51]'
- en: We see that the greatest net savings occurs at a threshold of 0.36\. The amount
    of net savings realized at this threshold is over NT$13 million, for this testing
    dataset of accounts. These savings would need to be scaled by the number of accounts
    served by the client, to estimate the total possible savings, assuming the data
    we are working with is representative of all these accounts.
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 我们发现，最大净节省发生在 0.36 的阈值下。在这个阈值下，所实现的净节省金额超过 1300 万新台币，针对这个测试数据集中的账户。这些节省需要根据客户所服务的账户数量进行规模化估算，以推算出总的可能节省金额，前提是我们所使用的数据能够代表所有这些账户。
- en: Note, however, that the savings are about the same up to a threshold of about
    0.5, as seen in *Figure 7.12*.
  id: totrans-248
  prefs: []
  type: TYPE_NORMAL
  zh: 然而需要注意的是，节省金额在约 0.5 的阈值之前大致相同，如*图 7.12*所示。
- en: As the threshold increases, we are "raising the bar" for how risky a client
    must be, in order for us to contact them and offer counseling. Increasing the
    threshold from 0.36 to 0.5 means we would be only contacting riskier clients whose
    probability is > 0.5\. This means contacting fewer clients, reducing the upfront
    cost of the program. *Figure 7.12* indicates that we may be still able to create
    roughly the same amount of net savings, by contacting fewer people. While the
    net effect is the same, the initial expenditure on counseling will be smaller.
    This may be desirable to the client. We explore this concept further in the following
    activity.
  id: totrans-249
  prefs: []
  type: TYPE_NORMAL
  zh: 随着阈值的增加，我们在“提高标准”，即要求客户的风险更高，才能与他们联系并提供咨询服务。从 0.36 提高到 0.5 意味着我们只会联系那些风险较高、概率大于
    0.5 的客户。这意味着联系的客户较少，从而减少了项目的前期成本。*图 7.12* 表明，即使我们联系较少的客户，可能仍然能够创造大致相同的净节省。虽然净效应相同，但咨询的初始支出较小。这对客户来说可能是更可取的。我们将在接下来的活动中进一步探讨这个概念。
- en: 'Activity 7.01: Deriving Financial Insights'
  id: totrans-250
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 活动 7.01：得出财务见解
- en: The raw materials of the financial analysis are completed. However, in this
    activity, your aim is to generate some additional insights from these results,
    to provide the client with more context around how the predictive model we built
    can generate value for them. In particular, we have looked at results for the
    testing set we reserved from model building. The client may have more accounts
    than those they supplied to us, that are representative of their business. You
    should report to them results that could be easily scaled to however big their
    business is, in terms of the number of accounts.
  id: totrans-251
  prefs: []
  type: TYPE_NORMAL
  zh: 财务分析的原始数据已完成。然而，在本活动中，你的目标是从这些结果中生成一些额外的见解，为客户提供更多的背景信息，帮助他们理解我们构建的预测模型如何为他们创造价值。特别地，我们已经查看了模型构建中保留的测试集结果。客户可能拥有比他们提供给我们的更多的账户，这些账户能代表他们的业务。你应该向他们报告可以轻松扩展到他们业务规模的结果，具体来说，是以账户数量为基础。
- en: We can also help them understand how much this program will cost; while the
    net savings are an important number to consider, the client will have to fund
    the counseling program before any of these savings will be realized. Finally,
    we will link the financial analysis back to standard machine learning model performance
    metrics.
  id: totrans-252
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还可以帮助客户了解这个项目的成本；虽然净节省是需要考虑的一个重要数字，但客户必须在实现这些节省之前为咨询项目提供资金。最后，我们将把财务分析与标准的机器学习模型性能指标关联起来。
- en: 'Once you complete the activity, you should be able to communicate the initial
    cost of the counseling program to the client, as well as obtain plots of precision
    and recall such as this:'
  id: totrans-253
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦完成活动，你应该能够向客户传达咨询项目的初步成本，并获得诸如下图所示的精确率和召回率的图表：
- en: '![Figure 7.13: Expected precision-recall curve'
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 7.13：预期的精确率-召回率曲线'
- en: '](img/B16392_07_13.jpg)'
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: '](img/B16392_07_13.jpg)'
- en: 'Figure 7.13: Expected precision-recall curve'
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: 图 7.13：预期的精确率-召回率曲线
- en: This curve will be useful in interpreting the value created by the model at
    different thresholds.
  id: totrans-257
  prefs: []
  type: TYPE_NORMAL
  zh: 这个曲线在解释模型在不同阈值下创造的价值时非常有用。
- en: 'Perform the following steps to complete the activity:'
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 执行以下步骤以完成活动：
- en: Note
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: 'The Jupyter notebook containing the code for this activity can be found here:
    [https://packt.link/2kTVB](https://packt.link/2kTVB). Additional steps to prepare
    data for this activity, based on previous results in this chapter, have been added
    to the notebook. Please execute the perquisite steps as presented in the notebook
    before you attempt this activity.'
  id: totrans-260
  prefs: []
  type: TYPE_NORMAL
  zh: 包含此活动代码的Jupyter笔记本可以在此处找到：[https://packt.link/2kTVB](https://packt.link/2kTVB)。根据本章先前的结果，已向笔记本添加了为此活动准备数据的额外步骤。请按照笔记本中呈现的先决步骤执行这些步骤。
- en: Using the testing set, calculate the cost of all defaults if there were no counseling program.
  id: totrans-261
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用测试集，计算如果没有辅导计划，所有违约的成本。
- en: Calculate by what percent the cost of defaults can be decreased by the counseling
    program.
  id: totrans-262
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 计算辅导计划可以减少违约成本的百分比。
- en: Calculate the net savings per account at the optimal threshold, considering
    all accounts it might be possible to counsel, in other words relative to the whole
    test set.
  id: totrans-263
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 计算在最优阈值下每个帐户的净储蓄，考虑可能能够辅导的所有帐户，换句话说，相对于整个测试集。
- en: Plot the net savings per account against the cost of counseling per account
    for each threshold.
  id: totrans-264
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 绘制每个阈值下每个帐户的净储蓄与每个帐户的辅导成本。
- en: Plot the fraction of accounts predicted as positive (this is called the "flag
    rate") at each threshold.
  id: totrans-265
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 绘制在每个阈值下预测为正的帐户的比例（这称为“标志率”）。
- en: Plot a precision-recall curve for the testing data.
  id: totrans-266
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 绘制测试数据的精确率-召回率曲线。
- en: Plot precision and recall separately on the *y*-axis against threshold on the
    *x*-axis.
  id: totrans-267
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在*y*-轴上分别绘制精确率和召回率，对应*x*-轴上的阈值。
- en: Note
  id: totrans-268
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 注意
- en: The solution to this activity can be found via [this link](B16925_Solution_ePub.xhtml#_idTextAnchor161).
  id: totrans-269
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 通过[此链接](B16925_Solution_ePub.xhtml#_idTextAnchor161)可找到此活动的解决方案。
- en: Final Thoughts on Delivering a Predictive Model to the Client
  id: totrans-270
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 关于向客户交付预测模型的最终思考
- en: We have now completed the modeling activities and also created a financial analysis
    to indicate to the client how they can use the model. While we have completed
    the essential intellectual contributions that are the data scientist's responsibility,
    it is necessary to agree with the client on the form in which all these contributions
    will be delivered.
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在已经完成了建模活动，并创建了财务分析，以指示客户如何使用模型。虽然我们已完成了数据科学家的基本智力贡献，但需要与客户达成一致意见，以确定所有这些贡献的交付形式。
- en: A key contribution is the predictive capability embodied in the trained model.
    Assuming the client can work with the trained model object we created with XGBoost,
    this model could be saved to disk as we've done and sent to the client. Then,
    the client would be able to use it within their workflow. This pathway to model
    delivery may require the data scientist to work with engineers in the client's
    organization, to deploy the model within the client's infrastructure.
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 关键贡献是训练模型中体现的预测能力。假设客户可以使用我们用XGBoost创建的训练模型对象，此模型可以像我们所做的那样保存到磁盘并发送给客户。然后，客户可以在其工作流程中使用它。这种模型交付路径可能需要数据科学家与客户组织的工程师合作，以在客户基础设施中部署模型。
- en: Alternatively, it may be necessary to express the model as a mathematical equation
    (for example, using logistic regression coefficients) or a set of if-then statements
    (as in decision trees or random forest) that the client could use to implement
    the predictive capability in SQL. While expressing random forests in SQL code
    is cumbersome due to the possibility of having many trees with many levels, there
    are software packages that will create this representation for you from a trained
    scikit-learn model (for example, [https://pypi.org/project/SKompiler/](https://pypi.org/project/SKompiler/)).
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，可能需要将模型表达为数学方程（例如，使用逻辑回归系数）或一组if-then语句（如决策树或随机森林），客户可以使用SQL实现预测能力。虽然由于可能存在许多树和许多级别，将随机森林表达为SQL代码是很繁琐的，但有软件包可以根据训练好的scikit-learn模型为您创建此表示（例如，[https://pypi.org/project/SKompiler/](https://pypi.org/project/SKompiler/)）。
- en: 'Note: Cloud Platforms for Model Development and Deployment'
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：云平台用于模型开发和部署
- en: In this book, we used scikit-learn and the XGBoost package to build predictive
    models locally on our computers. Recently, cloud platforms such as **Amazon Web
    Services** (**AWS**) have made machine learning capabilities available through
    offerings such as Amazon SageMaker. SageMaker includes a version of XGBoost, which
    you can use to train models with similar syntax to what we've done here. Subtle
    differences may exist in the implementation of model training between the methods
    shown in this book and the Amazon distribution of SageMaker, and you are encouraged
    to check your work every step of the way to make sure your results are as intended.
    For example, fitting an XGBoost model using early stopping may require additional
    steps in SageMaker to ensure the trained model uses the best iteration for predictions,
    as opposed to the last iteration when training stopped.
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 在本书中，我们使用scikit-learn和XGBoost包在本地计算机上构建预测模型。最近，云平台如**亚马逊网络服务**（**AWS**）通过Amazon
    SageMaker等服务提供了机器学习能力。SageMaker包含了一个XGBoost的版本，您可以使用类似于我们在这里所做的语法来训练模型。在本书中展示的方法和亚马逊SageMaker的模型训练实现之间可能存在细微差异，建议您在每一步检查您的工作，以确保结果符合预期。例如，在SageMaker中使用早停止来拟合XGBoost模型可能需要额外的步骤，以确保训练的模型使用最佳迭代进行预测，而不是在训练停止时的最后迭代。
- en: Cloud platforms such as AWS are attractive because they may greatly simplify
    the process of integrating a trained machine learning model into a client's technical
    stack, which in many cases may already be built on a cloud platform.
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 云平台如AWS很有吸引力，因为它们可能极大地简化将训练好的机器学习模型集成到客户的技术堆栈中的过程，而这在许多情况下可能已经建立在云平台上。
- en: Before using the model to make predictions, the client would need to *ensure
    that the data was prepared in the same way it was for the model building we have
    done*. For example, the removal of samples with values of `0` for all the features
    and the cleaning of the `EDUCATION` and `MARRIAGE` features would have to be done
    in the same way we demonstrated earlier in this chapter. Alternatively, there
    are other possible ways to deliver model predictions, such as an arrangement where
    the client delivers features to the data scientist and receives the predictions
    back.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 在使用模型进行预测之前，客户需要*确保数据的准备方式与我们之前构建模型时相同*。例如，删除所有特征值为`0`的样本以及清理`EDUCATION`和`MARRIAGE`特征的操作必须与我们在本章前面演示的方式相同。另外，还有其他可能的交付模型预测的方式，比如客户将特征提供给数据科学家，然后接收预测结果。
- en: 'Another important consideration for the discussion of deliverables is: *what
    format should the predictions be delivered in?* A typical delivery format for
    predictions from a binary classification model, such as that we''ve created for
    the case study, is to rank accounts by their predicted probability of default.
    The predicted probability should be supplied along with the account ID and whatever
    other columns the client would like. This way, when the call center is working
    their way through the list of account holders to offer counseling to, they can
    contact those at highest risk for default first and proceed to lower-priority
    account holders as time and resources allow. The client should be informed of
    which threshold to use for predicted probabilities, to result in the highest net
    savings. This threshold would represent the stopping point on the list of account
    holders to contact if it is ranked on the predicted probability of default.'
  id: totrans-278
  prefs: []
  type: TYPE_NORMAL
  zh: 讨论交付内容的另一个重要考虑因素是：*预测结果应该以什么格式交付？* 二元分类模型的典型交付格式，例如我们为案例研究创建的模型，是按照预测违约概率对账户进行排名。预测的概率应该与账户ID以及客户希望的其他列一起提供。这样，当呼叫中心逐个联系账户持有人以提供咨询时，他们可以首先联系那些违约风险最高的人，然后根据时间和资源的允许继续联系优先级较低的账户持有人。客户应该被告知使用哪个预测概率阈值，以获得最高的净节省。这个阈值将代表按照违约概率排名的账户持有人联系的终止点。
- en: Model Monitoring
  id: totrans-279
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 模型监控
- en: Depending on how long the client has engaged the data scientist for, it is always
    beneficial to monitor the performance of the model over time, as it is being used.
    Does predictive capability remain the same or degrade over time? When assessing
    this for the case study, it would be important to keep in mind that if account
    holders are receiving counseling, their probability of default would be expected
    to be lower than the predicted probability indicates, due to the intended effects
    of the new counseling program. For this reason, and to test the effectiveness
    of the counseling program, it is good practice to reserve a randomly chosen portion
    of account holders who will not receive any counseling, regardless of credit default
    risk. This group would be known as the **control group** and should be small compared
    to the rest of the population who receives counseling, but large enough to draw
    statistically significant inferences from.
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: 根据客户与数据科学家的合作时间，持续监控模型性能随时间的变化始终是有益的，因为它在使用过程中是否保持稳定或逐渐下降？在评估此案例时，需要牢记，如果账户持有人正在接受辅导，他们的违约概率可能会低于预测的概率，因为新辅导计划的预期效果。因此，为了测试辅导计划的有效性，最好将一部分随机选择的账户持有人保留下来，这部分人将不会接受任何辅导，无论他们的违约风险如何。这部分人被称为**对照组**，它应该相对于接受辅导的账户群体较小，但足够大以便得出统计学上显著的推论。
- en: While it's beyond the scope of this book to go into details about how to design
    and use a control group, suffice to say here that model predictive capability
    could be assessed on the control group since they have received no counseling,
    similar to the population of accounts the model was trained on. Another benefit
    of a control group is that the rate of default, and financial loss due to defaults,
    can be compared to those accounts that received the model-guided counseling program.
    If the program is working as intended, the accounts receiving counseling should
    have a lower rate of default and a smaller financial loss due to default. The
    control group can provide evidence that the program is, in fact, working.
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管本书的范围并不包括如何设计和使用对照组的细节，但在这里可以简要说明，模型的预测能力可以通过对照组进行评估，因为他们没有接受任何辅导，类似于模型训练时使用的账户群体。对照组的另一个好处是，可以将违约率及因违约而产生的财务损失与那些接受了模型引导辅导计划的账户进行比较。如果该计划按预期运行，接受辅导的账户应具有较低的违约率和较小的违约财务损失。对照组可以提供证据，证明该计划实际上是有效的。
- en: 'Note: Advanced Modeling Technique for Selective Treatments—Uplift Modeling'
  id: totrans-282
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：选择性治疗的高级建模技术——提升建模
- en: When a business is considering selectively offering a costly treatment to its
    customers, such as the counseling program of the case study, a technique known
    as uplift modeling should be considered. Uplift modeling seeks to determine, on
    an individual basis, how effective treatments are. We made a blanket assumption
    that phone counseling treatment is 70% effective across customers on average.
    However, it may be that the effectiveness varies by customer; some customers are
    more receptive and others less so. For more information on uplift modeling, see
    [https://www.steveklosterman.com/uplift-modeling/](https://www.steveklosterman.com/uplift-modeling/).
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 当一家企业考虑是否有选择地为其客户提供昂贵的治疗方案（如案例研究中的辅导计划）时，应考虑使用一种被称为提升建模的技术。提升建模旨在基于个体来确定治疗的有效性。我们假设电话辅导对客户的有效性平均为70%。然而，效果可能因客户而异；一些客户更容易接受，另一些则不太容易。有关提升建模的更多信息，请参见[https://www.steveklosterman.com/uplift-modeling/](https://www.steveklosterman.com/uplift-modeling/)。
- en: A relatively simple way to monitor a model implementation is to see if the distribution
    of model predictions is changing over time, as compared to the population used
    for model training. We plotted the histogram of predicted probabilities for the
    test set in *Figure 7.2*. If the shape of the histogram of predicted probabilities
    changes substantially, it may be a sign that the features have changed, or that
    the relationship between the features and response has changed and the model may
    need to be re-trained or rebuilt. To quantify changes in distributions, the interested
    reader is encouraged to consult a statistics resource to learn about the chi-squared
    goodness-of-fit test or the Kolmogorov-Smirnov test. Changing distributions of
    model predictions may also become evident if the proportion of accounts predicted
    to default, according to a chosen threshold, changes in a noticeable way.
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: 一种相对简单的监控模型实施方法是查看模型预测的分布是否随着时间变化，与用于模型训练的人群相比有所变化。我们在*图7.2*中绘制了测试集的预测概率直方图。如果预测概率的直方图形状发生了显著变化，这可能表明特征发生了变化，或者特征与响应之间的关系发生了变化，模型可能需要重新训练或重建。为了量化分布的变化，感兴趣的读者可以查阅统计资源，学习卡方拟合优度检验或Kolmogorov-Smirnov检验。如果模型预测的分布发生变化，或者根据所选择的阈值，预测违约账户的比例发生明显变化，也可能会显现出来。
- en: 'All the other model assessment metrics presented in this chapter and throughout
    the book can also be good ways to monitor model performance in production: decile
    and equal-interval charts, calibration, ROC AUC, and others.'
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 本章及全书中呈现的所有其他模型评估指标也可以是监控模型在生产环境中表现的好方法：十分位数图和等间距图、校准、ROC AUC等。
- en: Ethics in Predictive Modeling
  id: totrans-286
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 预测建模中的伦理问题
- en: The question of whether a model makes fair predictions has received increased
    attention as machine learning has expanded in scope to touch most modern businesses.
    Fairness may be assessed on the basis of whether a model is equally skillful at
    making predictions for members of different protected classes, for example, different
    gender groups.
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 随着机器学习的应用扩展到大多数现代企业，模型是否做出公平预测的问题受到了更多关注。公平性可以通过模型是否同样擅长为不同受保护类群体的成员做出预测来评估，例如，不同性别群体。
- en: In this book, we took the approach of removing gender from being considered
    as a feature for the model. However, it may be that other features can effectively
    serve as a proxy for gender, so that a model may wind up producing biased results
    for different gender groups, even though gender was not used as a feature. One
    simple way to screen for the possibility of such bias is to check if any of the
    features used in the model have a particularly high association with a protected
    class, for example, by using a t-test. If so, it may be better to remove these
    features from the model.
  id: totrans-288
  prefs: []
  type: TYPE_NORMAL
  zh: 在本书中，我们采用了将性别从模型特征中移除的方法。然而，其他特征可能有效地充当性别的代理，因此即使性别没有作为特征使用，模型也可能对不同性别群体产生偏见的结果。筛查这种偏见可能性的一个简单方法是检查模型中使用的特征是否与受保护类群体有特别高的关联性，例如，可以通过使用t检验来进行检查。如果是这样，最好将这些特征从模型中移除。
- en: How to determine whether a model is fair, and if not, what to do about it, is
    the subject of active research. You are encouraged to become familiar with efforts
    such as AI Fairness 360 ([https://aif360.mybluemix.net/](https://aif360.mybluemix.net/))
    that are making tools available to improve fairness in machine learning. Before
    embarking on work related to fairness, it's important to understand from the client
    what the definition of fairness is, as this may vary by geographic region due
    to different laws in different countries, as well as the specific policies of
    the client's organization.
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
  zh: 如何判断模型是否公平，以及如果不公平，应该如何处理，这个问题是当前研究的热点。我们鼓励你熟悉像AI Fairness 360（[https://aif360.mybluemix.net/](https://aif360.mybluemix.net/)）这样的努力，这些努力正在提供工具，以提高机器学习中的公平性。在开始与公平性相关的工作之前，理解客户对于公平的定义至关重要，因为不同国家的法律和客户组织的具体政策可能会导致公平的定义因地区而异。
- en: Summary
  id: totrans-290
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, you learned several analysis techniques to provide insight
    into model performance, such as decile and equal-interval charts of default rate
    by model prediction bin, as well as how to investigate the quality of model calibration.
    It's good to derive these insights, as well as calculate metrics such as the ROC
    AUC, using the model test set, since this is intended to represent how the model
    might perform in the real world on new data.
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你学习了几种分析技术，以提供对模型性能的洞察，例如按模型预测区间划分的违约率的十分位和等距图表，以及如何调查模型校准的质量。通过使用模型测试集得出这些洞察并计算诸如ROC
    AUC等指标是很好的，因为这旨在代表模型在真实世界中新数据上的表现。
- en: We also saw how to go about conducting a financial analysis of model performance.
    While we left this to the end of the book, an understanding of the costs and savings
    going along with the decisions to be guided by the model should be understood
    from the beginning of a typical project. These allow the data scientist to work
    toward a tangible goal in terms of increased profit or savings. A key step in
    this process, for binary classification models, is to choose a threshold of predicted
    probability at which to declare a positive prediction, so that the profits or
    savings due to model-guided decision making are maximized.
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还看到如何进行模型性能的财务分析。虽然我们将此部分留到了书的最后，但对与模型决策相关的成本和节省的理解应该从典型项目开始时就有所了解。这些使数据科学家能够朝着通过增加利润或节省成本的具体目标努力。对于二分类模型，这一过程的关键步骤是选择一个预测概率阈值，以此来宣布一个正向预测，从而最大化由模型指导决策所带来的利润或节省。
- en: Finally, we considered tasks related to delivering and monitoring the model,
    including the idea of establishing a control group to monitor model performance
    and test the effectiveness of any programs guided by model output. The structure
    of control groups and model monitoring strategies will be different from project
    to project, so you will need to determine the appropriate course of action in
    each new case. To further your knowledge of using models in the real world, you
    are encouraged to continue studying topics such as experimental design, cloud
    platforms such as AWS that can be used to train and deploy models, and issues
    with fairness in predictive modeling.
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们考虑了与交付和监控模型相关的任务，包括建立对照组以监控模型性能并测试任何由模型输出指导的程序有效性的想法。对照组的结构和模型监控策略会因项目而异，因此你需要在每个新案例中确定合适的行动方案。为了进一步了解在现实世界中使用模型，你应继续研究如实验设计、可以用于训练和部署模型的云平台（例如AWS）以及预测建模中的公平性问题等主题。
- en: You have now completed the project and are ready to deliver your findings to
    the client. Along with trained models saved to disk, or other data products or
    services you may provide to the client, you will probably also want to create
    a presentation, typically a slide show, detailing your progress. Contents of such
    presentations usually include a problem statement, results of data exploration
    and cleaning, a comparison of the performance of different models you built, model
    explanations such as SHAP values, and the financial analysis which shows how valuable
    your work is. As you craft presentations of your work, it's usually better to
    *tell your story with pictures as opposed to a lot of text*. We've demonstrated
    many visualization techniques throughout the book that you can use to do this,
    and you should continue to explore ways to depict data and modeling results.
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: 你现在已经完成了项目，并准备向客户交付你的研究成果。除了将训练好的模型保存到磁盘或你可能提供给客户的其他数据产品或服务外，你还可能希望创建一个演示文稿，通常是一个幻灯片展示，详细说明你的进展。此类演示文稿的内容通常包括问题陈述、数据探索和清理结果、你构建的不同模型的性能比较、模型解释（如SHAP值），以及展示你的工作价值的财务分析。在制作你的工作演示文稿时，通常更好的是*通过图片讲述故事，而不是大量的文字*。在整本书中，我们展示了许多可用于此目的的可视化技术，你应继续探索描绘数据和建模结果的方式。
- en: Always be sure to ask the client which specific things they may want to have
    in a presentation and be sure to answer all their questions. When a client sees
    that you can create value for them in an understandable way, you have succeeded.
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: 始终确保询问客户他们可能希望在演示文稿中看到的具体内容，并确保回答他们所有的问题。当客户看到你能够以易于理解的方式为他们创造价值时，你就成功了。
