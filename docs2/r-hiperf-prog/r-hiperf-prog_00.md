# 前言

在数据变得越来越重要的世界里，商人和科学家需要工具来高效地分析和处理大量数据。R 是近年来在数据处理、统计分析和数据科学中越来越受欢迎的工具之一。虽然 R 的根源在学术界，但现在它被广泛应用于各个行业和地理区域的组织中。

但 R 的设计对它能够高效管理的数据大小和计算复杂度施加了一些固有的限制。这对需要处理组织中不断增长的数据量的 R 用户来说可能是一个巨大的障碍。

本书，《R 高性能编程》，将帮助你理解在 R 中经常导致性能困难的情况，例如内存和计算限制。它还将展示一系列克服这些性能限制的技术。你可以选择单独使用这些技术，或者根据你的需求和计算环境选择最佳组合。

本书旨在成为一本实用的指南，介绍如何提高 R 程序的性能，同时提供足够的解释来说明为什么，以便你理解每个解决方案背后的推理。因此，我们将为本书中涵盖的每个技术提供代码示例，以及我们在自己的机器上生成的性能分析结果，以展示性能提升。我们鼓励你通过在自己的环境中输入和运行代码来跟随，以亲自看到性能提升。

如果你想要了解 R 的设计以及为什么它有性能限制，R 内部文档([`cran.r-project.org/doc/manuals/r-release/R-ints.html`](http://cran.r-project.org/doc/manuals/r-release/R-ints.html))将提供有用的线索。

本书基于开源 R 编写，因为它是最广泛使用的 R 版本，并且对任何人都是免费可用的。如果你使用的是商业版本的 R，请咨询你的软件供应商，看看他们可能为你提供了哪些性能改进。

R 社区已经创建了众多新包来提升 R 的性能，这些包可以在综合 R 存档网络（CRAN）([`cran.r-project.org/`](http://cran.r-project.org/))上找到。我们无法分析 CRAN 上的每一个包——它们有成千上万个——以查看它们是否为特定操作提供了性能提升。相反，本书专注于 R 程序员最常见的工作任务，并介绍你可以用于任何 R 项目的技巧。

# 本书涵盖的内容

第一章, *理解 R 的性能 – 为什么 R 程序有时会慢？*，通过一瞥 R 的内部结构来开启我们的旅程，探索 R 程序可能遇到性能限制的各种方式。我们将探讨 R 的设计如何在计算（CPU）、内存（RAM）和磁盘输入/输出（I/O）方面在 R 程序中创建性能瓶颈。

第二章, *性能分析 – 测量代码的性能*，介绍了我们将在整本书中使用的几种技术来测量 R 代码的性能，以便我们能够理解我们的性能问题的本质。

第三章, *简单调整以使 R 运行更快*，描述了如何提高 R 代码的计算速度。这些是您可以在任何 R 程序中使用的基技术。

第四章, *使用编译代码以获得更高的速度*，探讨了在另一种编程语言（如 C）中使用编译代码来最大化我们计算的性能。我们将看到编译代码如何比 R 运行得更快，并探讨如何将编译代码集成到我们的 R 程序中。

第五章, *使用 GPU 使 R 运行更快*，通过利用图形处理单元（GPU）来以高速运行复杂计算，将我们带入现代加速器的领域。

第六章, *简单调整以减少使用 RAM*，描述了管理并优化 R 程序 RAM 利用的基本技术，以便您能够处理更大的数据集。

第七章, *使用有限 RAM 处理大型数据集*，解释了如何使用内存高效的数据结构和磁盘驻留数据格式来处理比可用 RAM 更大的数据集。

第八章, *使用并行计算提高性能*，介绍了 R 中的并行性。我们将探索如何在单台机器和多台机器上并行运行 R 代码。我们还将探讨在设计我们的并行代码时需要考虑的因素。

第九章, *将数据处理任务卸载到数据库系统中*，描述了某些计算可以卸载到外部数据库系统。这有助于最小化大数据在数据库中的进出移动，尤其是在您已经可以访问一个具有计算能力和速度的强大数据库系统时。

第十章, *R 和大数据*，通过探索使用大数据技术将 R 的性能提升到极限来结束本书。

如果你急于阅读，我们建议你首先阅读以下章节，然后根据你的情况补充阅读其他相关章节：

+   第一章, *理解 R 的性能 – 为什么 R 程序有时运行缓慢？*

+   第二章, *性能分析 – 测量代码的性能*

+   第三章, *简单调整以使 R 运行更快*

+   第六章, *简单调整以使用更少的 RAM*

# 你需要为这本书准备

本书中的所有代码都是在 Mac OS X 10.9 上的 R 3.1.1 64 位下开发的。 wherever possible，它们也已在 Ubuntu 桌面 14.04 LTS 和 Windows 8.1 上进行了测试。所有代码示例都可以从 [`github.com/r-high-performance-programming/rhpp-2015`](https://github.com/r-high-performance-programming/rhpp-2015) 下载。

要跟随代码示例，我们建议你在你的环境中安装 R 3.1.1 64 位或更高版本。

我们还建议你在 Unix 环境中运行 R（这包括 Linux 和 Mac OS X）。虽然 R 也可以在 Windows 上运行，但我们将要使用的某些包，例如 "bigmemory"，只能在 Unix 环境中运行。在我们的代码示例中，如果 Unix 和 Windows 之间存在差异，我们将指出它们。

你需要 R 的 64 位版本，因为某些操作（例如，创建包含 2³¹ 或更多元素的向量）在 32 位版本中是不可能的。此外，R 的 64 位版本可以利用系统上可用的所有内存，而 32 位版本的限制为不超过 4 GB 的内存（在某些操作系统中，限制可能低至 2 GB）。

你还需要在你的 R 环境中安装包，因为几章中的示例将依赖于额外的包。

一些章节中的示例需要其他软件或包才能运行。这些将在各自的章节中列出，包括安装说明。

如果你无法访问示例中所需的一些软件和工具，你可以在亚马逊网络服务（AWS）上运行它们。特别是，第五章中的示例，*使用 GPU 使 R 运行更快*，需要一个具有 CUDA 功能的 NVIDIA GPU 的计算机；第九章中的示例，*将数据处理卸载到数据库系统*，需要各种数据库系统；第十章中的示例，*R 和大数据*，需要 Hadoop。

要使用 AWS，请使用您的亚马逊账户登录到[`aws.amazon.com/`](http://aws.amazon.com/)。如果您还没有账户，请创建一个。创建账户是免费的，但使用服务器、存储和其他资源会产生费用。请咨询 AWS 网站了解您首选区域的最新价格。

AWS 服务在全球的不同区域提供。在撰写本书时，有八个区域——美国有三个，欧洲有一个，亚太地区有三个，南美洲有一个。选择您喜欢的任何区域，例如您所在位置附近或价格最低的区域。要选择区域，请转到 AWS 控制台([`console.aws.amazon.com`](http://console.aws.amazon.com))并选择右上角的位置。一旦选择了区域，请为本书中所有示例所需的 AWS 资源使用相同的区域。

在设置任何计算资源（如服务器或 Hadoop 集群）之前，您需要一个密钥对来登录服务器。如果您还没有 AWS 弹性计算云（EC2）密钥对，请按照以下步骤生成一个：

1.  前往 AWS 控制台并点击 EC2。

1.  点击左侧菜单中的密钥对。

1.  点击创建密钥对。

1.  为新的密钥对输入一个名称（例如，mykey）。

1.  一旦点击创建，私钥（例如，mykey.pem）将下载到您的计算机上。

在 Linux 和 Mac OS X 上，使用 chmod 400 mykey.pem 在终端窗口中更改私钥文件的权限，以允许所有者仅读取访问。

# 本书面向的对象

如果您已经是 R 程序员并想找到提高代码效率的方法，那么这本书适合您。虽然您需要熟悉并舒适地使用 R，但您不需要对该语言有深入的专业知识。您需要从本书中受益的技能包括：

+   在您的计算机上安装、升级和运行 R

+   在您的 R 环境中安装和升级 CRAN 软件包

+   创建和操作基本数据结构，如向量、矩阵、列表和数据框

+   使用和在不同 R 数据类型之间转换

+   执行算术、逻辑和其他基本 R 操作

+   使用 R 控制语句，如 if、for、while 和 repeat

+   编写 R 函数

+   使用 R Graphics 绘制图表

如果你是 R 语言的新手，想学习如何编写 R 程序，有许多书籍、在线课程、教程和其他资源可供选择。只需使用您喜欢的搜索引擎搜索即可。

# 习惯用法

在本书中，您将找到多种文本样式，用于区分不同类型的信息。以下是一些这些样式的示例及其含义的解释。

文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 处理方式如下：“为了编译函数，我们将使用编译器包中的 `cmpfun()` 函数。”

代码块设置如下：

```py
fibonacci_rec <- function(n) {
    if (n <= 1) {
        return(n)
    }
    return(fibonacci_rec(n - 1) + fibonacci_rec(n - 2))
}
```

**新术语**和**重要词汇**以粗体显示。屏幕上显示的词汇，例如在菜单或对话框中，将以如下方式显示：“请确保在安装向导中选择**包作者安装**和**编辑系统 PATH**选项。”

### 注意

警告或重要注意事项以如下方式显示在框中。

### 小贴士

小技巧和窍门看起来像这样。

# 读者反馈

我们始终欢迎读者的反馈。让我们知道您对这本书的看法——您喜欢什么或可能不喜欢什么。读者反馈对我们开发您真正从中获得最大收益的标题非常重要。

要发送一般反馈，只需发送电子邮件到 `<feedback@packtpub.com>`，并在邮件主题中提及书籍标题。

如果您在某个主题上具有专业知识，并且您对撰写或为书籍做出贡献感兴趣，请参阅我们的作者指南[www.packtpub.com/authors](http://www.packtpub.com/authors)。

# 客户支持

现在您是 Packt 书籍的骄傲拥有者，我们有一些事情可以帮助您从购买中获得最大收益。

## 下载示例代码

您可以从[`www.packtpub.com`](http://www.packtpub.com)的账户下载您购买的所有 Packt 书籍的示例代码文件。如果您在其他地方购买了这本书，您可以访问[`www.packtpub.com/support`](http://www.packtpub.com/support)并注册，以便将文件直接通过电子邮件发送给您。

## 错误列表

尽管我们已经尽一切努力确保内容的准确性，但错误仍然可能发生。如果您在我们的书中发现错误——可能是文本或代码中的错误——如果您能向我们报告这一点，我们将不胜感激。通过这样做，您可以节省其他读者的挫败感，并帮助我们改进本书的后续版本。如果您发现任何错误，请通过访问[`www.packtpub.com/submit-errata`](http://www.packtpub.com/submit-errata)，选择您的书籍，点击**错误提交**表单链接，并输入您的错误详情。一旦您的错误得到验证，您的提交将被接受，错误将被上传到我们的网站，或添加到该标题的错误列表中。任何现有的错误都可以通过从[`www.packtpub.com/support`](http://www.packtpub.com/support)选择您的标题来查看。

## 侵权

互联网上版权材料的侵权是一个持续存在的问题，所有媒体都存在。在 Packt，我们非常重视我们版权和许可证的保护。如果您在互联网上发现我们作品的任何非法副本，无论形式如何，请立即提供位置地址或网站名称，以便我们可以寻求补救措施。

请通过 `<copyright@packtpub.com>` 联系我们，并提供涉嫌侵权材料的链接。

我们感谢您在保护我们作者以及为我们提供有价值内容方面的帮助。

## 问题

如果你在本书的任何方面遇到问题，可以通过 `<questions@packtpub.com>` 联系我们，我们将尽力解决。
